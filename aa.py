import streamlit as st
import hashlib
import time
from datetime import datetime, timedelta
import csv
import os
import json
import random
import requests
from functools import lru_cache

# Paket yÃ¼kleme durumlarÄ±
try:
    import pandas as pd
    PANDAS_AVAILABLE = True
except ImportError:
    PANDAS_AVAILABLE = False
    # Pandas yoksa basit DataFrame mock
    class MockDataFrame:
        def __init__(self, data=None):
            self.data = data or []
        def to_dict(self):
            return {'data': self.data}
    pd = type('MockPandas', (), {'DataFrame': MockDataFrame})()

try:
    import firebase_admin
    from firebase_admin import credentials, db
    FIREBASE_AVAILABLE = True
except ImportError:
    FIREBASE_AVAILABLE = False
    firebase_admin = None
    db = None

try:
    import plotly.express as px
    import plotly.graph_objects as go
    PLOTLY_AVAILABLE = True
except ImportError:
    PLOTLY_AVAILABLE = False
    # Plotly yoksa basit fallback objeler oluÅŸtur
    class MockPlotly:
        def __init__(self):
            pass
        def Figure(self):
            return self
        def Scatter(self, **kwargs):
            return self
        def add_trace(self, *args):
            return self
        def update_layout(self, **kwargs):
            return self
        def pie(self, *args, **kwargs):
            return self
        def bar(self, *args, **kwargs):
            return self
        def line(self, *args, **kwargs):
            return self
    
    px = MockPlotly()
    go = MockPlotly()
    # st.plotly_chart yerine st.warning kullanÄ±lacak

# === GRAFÄ°K CACHE SÄ°STEMÄ° ===
# Plotly grafikleri iÃ§in cache sistemi
class PlotlyCache:
    def __init__(self):
        self.cache = {}
        self.cache_duration = 300  # 5 dakika cache
    
    def get_chart(self, cache_key, generator_func):
        """Cache'li grafik oluÅŸturma"""
        current_time = time.time()
        
        if (cache_key in self.cache and 
            current_time - self.cache[cache_key]['time'] < self.cache_duration):
            return self.cache[cache_key]['data']
        
        # Grafik oluÅŸtur ve cache'le
        chart_data = generator_func()
        self.cache[cache_key] = {
            'data': chart_data,
            'time': current_time
        }
        return chart_data

# Global plotly cache instance
plotly_cache = PlotlyCache()

# GÃ¼venli plotly_chart fonksiyonu - CACHE'LÄ°
def safe_plotly_chart(fig, cache_key=None, **kwargs):
    """Cache'li gÃ¼venli plotly chart"""
    if cache_key and PLOTLY_AVAILABLE:
        chart_data = plotly_cache.get_chart(cache_key, lambda: fig)
        if chart_data:
            fig = chart_data
    
    if PLOTLY_AVAILABLE:
        st.plotly_chart(fig, **kwargs)
    else:
        st.warning("ğŸ“Š Grafik gÃ¶rÃ¼ntÃ¼lenemedi - Plotly yÃ¼klÃ¼ deÄŸil")

# ğŸš€ OPTÄ°MÄ°ZE EDÄ°LMÄ°Å SAYFA YAPILANDIRMASI
st.set_page_config(
    page_title="YKS Takip Sistemi - Optimize",
    page_icon="ğŸ¯",
    layout="wide",
    initial_sidebar_state="expanded",
    menu_items={}  # MenÃ¼ Ã¶ÄŸelerini kaldÄ±r - download azalmasÄ±
)

# === BASÄ°T HOÅ GELDÄ°N MESAJI FONKSÄ°YONU ===
def check_and_show_welcome_message(username):
    """
    KullanÄ±cÄ± giriÅŸ yaptÄ±ktan sonra basit baÅŸarÄ± mesajÄ± gÃ¶ster
    Popup yerine st.success() kullanarak donma sorunu Ã§Ã¶zÃ¼ldÃ¼
    """
    try:
        # Ä°lk kez mi kontrol et
        if 'welcome_message_shown' not in st.session_state:
            st.session_state.welcome_message_shown = False
        
        # EÄŸer daha Ã¶nce gÃ¶sterilmediyse mesajÄ± gÃ¶ster
        if not st.session_state.welcome_message_shown:
            user_data = get_user_data()
            student_name = user_data.get('name', username)
            st.success(f"HoÅŸgeldin {student_name}! Sisteme baÅŸarÄ±yla giriÅŸ yaptÄ±n.", icon="ğŸ‰")
            st.session_state.welcome_message_shown = True
    except Exception:
        # Hata durumunda da basit mesaj gÃ¶ster
        if not st.session_state.get('welcome_message_shown', False):
            st.success(f"HoÅŸgeldin {username}! Sisteme baÅŸarÄ±yla giriÅŸ yaptÄ±n.", icon="ğŸ‰")
            st.session_state.welcome_message_shown = True

# === ADMIN PANELÄ° KONTROLÃœ ===
def check_admin_access():
    """Admin panel eriÅŸim kontrolÃ¼"""
    if 'admin_logged_in' not in st.session_state:
        st.session_state.admin_logged_in = False
    
    if st.session_state.admin_logged_in:
        return True
    
    return False

def admin_login():
    """Admin giriÅŸ sayfasÄ±"""
    st.markdown("""
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                padding: 30px; border-radius: 20px; margin: 20px 0; color: white; text-align: center;">
        <h2 style="margin: 0; color: white;">ğŸ” YKS Admin Panel GiriÅŸi</h2>
        <p style="margin: 10px 0 0 0; opacity: 0.9;">Ã–ÄŸretmen/Veli Takip Sistemi</p>
    </div>
    """, unsafe_allow_html=True)
    
    with st.form("admin_login"):
        col1, col2, col3 = st.columns([1, 2, 1])
        with col2:
            username = st.text_input("ğŸ‘¤ KullanÄ±cÄ± AdÄ±", placeholder="admin")
            password = st.text_input("ğŸ”’ Åifre", type="password", placeholder="yks2025")
            submitted = st.form_submit_button("ğŸš€ GiriÅŸ Yap", use_container_width=True)
        
        if submitted:
            if username == "admin" and password == "yks2025":
                st.session_state.admin_logged_in = True
                st.success("âœ… GiriÅŸ baÅŸarÄ±lÄ±! YÃ¶nlendiriliyor...")
                time.sleep(1)
                st.rerun()
            else:
                st.error("âŒ HatalÄ± kullanÄ±cÄ± adÄ± veya ÅŸifre!")

def admin_logout():
    """Admin Ã§Ä±kÄ±ÅŸ"""
    st.session_state.admin_logged_in = False
    st.session_state.current_user = None
    st.success("ğŸ‘‹ Admin panelinden baÅŸarÄ±yla Ã§Ä±kÄ±ÅŸ yapÄ±ldÄ±!")
    time.sleep(1)
    st.rerun()

# === YAZDIR FONKSÄ°YONLARI ===
def generate_weekly_plan_pdf(user_data, week_plan):
    """HaftalÄ±k planÄ± sadece hedef konularÄ±yla PDF formatÄ±nda hazÄ±rla"""
    from datetime import datetime
    
    # GerÃ§ek haftalÄ±k plan verilerini al
    if not week_plan or 'new_topics' not in week_plan:
        return "HaftalÄ±k plan verisi bulunamadÄ±."
    
    topics = week_plan.get('new_topics', [])
    
    # Sadece hedef konularÄ± iÃ§eren basit iÃ§erik
    pdf_content = f"""ğŸ¯ Bu HaftanÄ±n Hedef KonularÄ±

Ã–ÄŸrenci: {user_data.get('name', 'Ã–ÄŸrenci')}
Alan: {user_data.get('field', 'EÅŸit AÄŸÄ±rlÄ±k')}
Tarih: {datetime.now().strftime('%d.%m.%Y')}

"""
    
    if topics:
        # KonularÄ± ders bazÄ±nda gruplama
        subjects = {}
        for topic in topics:
            subject = topic.get('subject', 'DiÄŸer')
            if subject not in subjects:
                subjects[subject] = []
            subjects[subject].append(topic.get('topic', 'Konu adÄ± yok'))
        
        # Her ders iÃ§in konularÄ± listele
        for subject, topic_list in subjects.items():
            pdf_content += f"\nğŸ“š {subject}:\n"
            for topic in topic_list:
                pdf_content += f"  â€¢ {topic}\n"
    else:
        pdf_content += "\nBu hafta iÃ§in henÃ¼z konu planÄ± oluÅŸturulmamÄ±ÅŸ.\n"
    
    return pdf_content

def show_print_button(user_data, weekly_plan):
    """YazdÄ±rma butonu gÃ¶ster"""
    st.markdown("---")
    
    col1, col2, col3 = st.columns([1, 2, 1])
    with col2:
        if st.button("ğŸ–¨ï¸ HaftalÄ±k PlanÄ± YazdÄ±r/Ä°ndir", use_container_width=True, type="primary"):
            pdf_content = generate_weekly_plan_pdf(user_data, weekly_plan)
            
            # Dosya adÄ± oluÅŸtur
            from datetime import datetime
            file_name = f"YKS_Haftalik_Plan_{datetime.now().strftime('%d_%m_%Y')}.txt"
            
            # Download butonu
            st.download_button(
                label="ğŸ“¥ PlanÄ± Ä°ndir (TXT)",
                data=pdf_content,
                file_name=file_name,
                mime="text/plain",
                use_container_width=True
            )
            
            st.success("âœ… Plan hazÄ±rlandÄ±! Ä°ndir butonuna tÄ±klayÄ±n.")
            
            # YazdÄ±rma talimatÄ±
            st.info("""
            ğŸ“‹ **YazdÄ±rma TalimatlarÄ±:**
            1. DosyayÄ± indirin
            2. Not Defteri veya Word ile aÃ§Ä±n  
            3. Ctrl+P ile yazdÄ±rÄ±n
            4. KaÄŸÄ±da Ã§Ä±karÄ±p Ã§alÄ±ÅŸma masanÄ±za koyun!
            """)

# === ADMIN DASHBOARD FONKSÄ°YONLARI ===

def get_real_student_data_for_admin():
    """GerÃ§ek Ã¶ÄŸrenci verilerini Firebase'den Ã§ek ve admin paneli iÃ§in formatla"""
    from datetime import datetime, timedelta
    import json
    
    # Firebase'den kullanÄ±cÄ± verilerini al
    if 'users_db' not in st.session_state:
        st.session_state.users_db = load_users_from_firebase()
    
    users_db = st.session_state.users_db
    students = []
    
    # DEBUG: Veri durumu kontrolÃ¼
    st.sidebar.write(f"ğŸ“Š **Debug Info:**")
    st.sidebar.write(f"â€¢ Toplam user DB kaydÄ±: {len(users_db) if users_db else 0}")
    if users_db:
        st.sidebar.write(f"â€¢ KullanÄ±cÄ±lar: {list(users_db.keys())}")
    
    if not users_db:
        st.warning("âš ï¸ HiÃ§ Ã¶ÄŸrenci verisi bulunamadÄ±!")
        st.info("ğŸ’¡ Firebase'den veri Ã§ekilemedi veya hiÃ§ kayÄ±t yapÄ±lmamÄ±ÅŸ.")
        return []
    
    for username, user_data in users_db.items():
        # Sadece gerÃ§ek Ã¶ÄŸrenci verilerini al (admin hariÃ§)
        if username in ["admin", "adminYKS2025"]:
            continue
            
        # Veri kontrolÃ¼
        name = user_data.get('name', 'Ä°simsiz Ã–ÄŸrenci')
        surname = user_data.get('surname', '')
        full_name = f"{name} {surname}".strip()
        
        # Son giriÅŸ tarihi
        last_login_str = user_data.get('last_login')
        if last_login_str:
            try:
                last_login = datetime.fromisoformat(last_login_str.replace('Z', '+00:00'))
            except:
                last_login = datetime.now() - timedelta(days=30)
        else:
            last_login = datetime.now() - timedelta(days=30)
        
        # HaftalÄ±k performans hesaplama (varsa gerÃ§ek verilerden)
        weekly_progress = user_data.get('weekly_progress', {})
        if weekly_progress:
            # GerÃ§ek ilerleme verisi varsa hesapla
            completed_topics = sum([len(progress.get('completed_topics', [])) 
                                  for progress in weekly_progress.values()])
            total_topics = sum([len(progress.get('planned_topics', [])) 
                              for progress in weekly_progress.values()])
            if total_topics > 0:
                weekly_performance = int((completed_topics / total_topics) * 100)
            else:
                weekly_performance = 0
        else:
            # Veri yoksa ortalama deÄŸer ver
            weekly_performance = 65
            
        # Ã‡alÄ±ÅŸma saatleri (varsa gerÃ§ek verilerden)
        total_hours = user_data.get('total_study_hours', 0)
        if total_hours == 0:
            # Veri yoksa tahmin et
            total_hours = weekly_performance // 2 + 20
            
        # Deneme sayÄ±sÄ±
        exam_count = user_data.get('exam_count', 0)
        if exam_count == 0:
            exam_count = max(1, weekly_performance // 20)
        
        # Durum belirleme
        days_since_login = (datetime.now() - last_login).days
        status = "Aktif" if days_since_login <= 7 else "Pasif"
        
        student = {
            "username": username,
            "name": full_name if full_name != "Ä°simsiz Ã–ÄŸrenci" else username,
            "field": user_data.get('field', 'BelirtilmemiÅŸ'),
            "last_login": last_login,
            "weekly_performance": weekly_performance,
            "total_hours": total_hours,
            "exam_count": exam_count,
            "status": status,
            "grade": user_data.get('grade', '12. SÄ±nÄ±f'),
            "target": user_data.get('target', 'BelirtilmemiÅŸ')
        }
        students.append(student)
    
    # Performansa gÃ¶re sÄ±rala (yÃ¼ksekten dÃ¼ÅŸÃ¼ÄŸe)
    students.sort(key=lambda x: x['weekly_performance'], reverse=True)
    
    return students

def generate_mock_student_data():
    """Ã–rnek Ã¶ÄŸrenci verileri oluÅŸtur"""
    import random
    from datetime import datetime, timedelta
    
    names = ["Ahmet YÄ±lmaz", "Fatma Kaya", "Mehmet Ã–z", "AyÅŸe Demir", "Ali Ã‡elik", 
             "Zeynep AktaÅŸ", "Murat Åahin", "Selin YÄ±ldÄ±z", "Emre KoÃ§", "BÃ¼ÅŸra Arslan",
             "Cem Ã–zkan", "Esra Polat", "Burak AvcÄ±", "Nur Turan", "Kaan DoÄŸan"]
    
    fields = ["SayÄ±sal", "EÅŸit AÄŸÄ±rlÄ±k", "SÃ¶zel", "Dil"]
    
    students = []
    for i, name in enumerate(names):
        last_login = datetime.now() - timedelta(days=random.randint(0, 7))
        weekly_performance = random.randint(45, 95)
        
        student = {
            "id": i+1,
            "name": name,
            "field": random.choice(fields),
            "last_login": last_login,
            "weekly_performance": weekly_performance,
            "total_hours": random.randint(25, 65),
            "exam_count": random.randint(2, 8),
            "status": "Aktif" if last_login > datetime.now() - timedelta(days=3) else "Pasif"
        }
        students.append(student)
    
    return students

def show_admin_dashboard():
    """Admin dashboard ana sayfa"""
    # Ã‡Ä±kÄ±ÅŸ butonu
    col1, col2, col3 = st.columns([6, 1, 1])
    with col3:
        if st.button("ğŸšª Ã‡Ä±kÄ±ÅŸ", type="secondary"):
            admin_logout()
    
    # Dashboard baÅŸlÄ±k
    st.markdown("""
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                padding: 25px; border-radius: 20px; margin: 20px 0; color: white; text-align: center;">
        <h1 style="margin: 0; color: white;">ğŸ›ï¸ YKS Admin Paneli</h1>
        <p style="margin: 10px 0 0 0; opacity: 0.9;">Ã–ÄŸretmen/Veli Takip Sistemi</p>
    </div>
    """, unsafe_allow_html=True)
    
    # Tab sistemi oluÅŸtur
    tab1, tab2 = st.tabs(["ğŸ“Š Ã–ÄŸrenci Takip", "ğŸ‘¨â€ğŸ« KoÃ§ Onay Sistemi"])
    
    with tab1:
        show_student_tracking_panel()
    
    with tab2:
        admin_coach_approval_panel()

def show_student_tracking_panel():
    """Ã–ÄŸrenci takip paneli (eski admin dashboard iÃ§eriÄŸi)"""
    # GERÃ‡EKFirebase verilerini Ã§ek
    students = get_real_student_data_for_admin()
    
    # Genel Ä°statistikler
    st.markdown("## ğŸ“Š Genel Durum")
    
    if not students:
        st.warning("âš ï¸ HiÃ§ Ã¶ÄŸrenci verisi bulunamadÄ±!")
        st.info("ğŸ’¡ Sistem henÃ¼z Ã¶ÄŸrenci kaydÄ± yapmadÄ±ÄŸÄ±nÄ±z veya veri Ã§ekilemediÄŸi anlamÄ±na gelir.")
        return
    
    col1, col2, col3, col4 = st.columns(4)
    
    active_students = len([s for s in students if s['status'] == 'Aktif'])
    avg_performance = sum([s['weekly_performance'] for s in students]) / len(students) if students else 0
    total_hours = sum([s['total_hours'] for s in students])
    
    with col1:
        st.metric("ğŸ‘¥ Toplam Ã–ÄŸrenci", len(students))
    with col2:
        st.metric("âœ… Aktif Ã–ÄŸrenci", active_students)
    with col3:
        st.metric("ğŸ“ˆ Ortalama BaÅŸarÄ±", f"%{avg_performance:.1f}")
    with col4:
        st.metric("â±ï¸ Toplam Ã‡alÄ±ÅŸma", f"{total_hours}h")
    
    # Ã–ÄŸrencilerin gerÃ§ek alan bilgilerini topla
    available_fields = list(set([s['field'] for s in students if s['field'] != 'BelirtilmemiÅŸ']))
    field_options = ["TÃ¼mÃ¼"] + sorted(available_fields)
    
    # Ã–ÄŸrenci Listesi
    st.markdown("---")
    st.markdown("## ğŸ‘¥ Ã–ÄŸrenci Listesi")
    
    # Filtreleme
    col1, col2, col3 = st.columns(3)
    with col1:
        field_filter = st.selectbox("ğŸ¯ Alan Filtresi", field_options)
    with col2:
        status_filter = st.selectbox("ğŸ“Š Durum Filtresi", ["TÃ¼mÃ¼", "Aktif", "Pasif"])
    with col3:
        performance_filter = st.selectbox("ğŸ¯ Performans", ["TÃ¼mÃ¼", "YÃ¼ksek (80+)", "Orta (60-79)", "DÃ¼ÅŸÃ¼k (<60)"])
    
    # Ã–ÄŸrenci tablosu
    filtered_students = students.copy()
    
    if field_filter != "TÃ¼mÃ¼":
        filtered_students = [s for s in filtered_students if s['field'] == field_filter]
    if status_filter != "TÃ¼mÃ¼":
        filtered_students = [s for s in filtered_students if s['status'] == status_filter]
    if performance_filter != "TÃ¼mÃ¼":
        if performance_filter == "YÃ¼ksek (80+)":
            filtered_students = [s for s in filtered_students if s['weekly_performance'] >= 80]
        elif performance_filter == "Orta (60-79)":
            filtered_students = [s for s in filtered_students if 60 <= s['weekly_performance'] < 80]
        elif performance_filter == "DÃ¼ÅŸÃ¼k (<60)":
            filtered_students = [s for s in filtered_students if s['weekly_performance'] < 60]
    
    # Tablo gÃ¶rÃ¼nÃ¼mÃ¼
    if filtered_students:
        for student in filtered_students:
            performance = student['weekly_performance']
            
            # Performansa gÃ¶re renk
            if performance >= 80:
                color = "#d4edda"
                text_color = "#155724"
                status_emoji = "ğŸš€"
            elif performance >= 60:
                color = "#d1ecf1"
                text_color = "#0c5460" 
                status_emoji = "ğŸ“ˆ"
            else:
                color = "#fff3cd"
                text_color = "#856404"
                status_emoji = "âš ï¸"
            
            # Durum emoji
            activity_emoji = "ğŸŸ¢" if student['status'] == 'Aktif' else "ğŸ”´"
            
            st.markdown(f"""
            <div style="background: {color}; padding: 15px; border-radius: 10px; margin: 8px 0;
                        border-left: 4px solid {text_color};">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong style="color: {text_color}; font-size: 16px;">
                            {activity_emoji} {student['name']}
                        </strong>
                        <br>
                        <span style="color: {text_color}; opacity: 0.8;">
                            ğŸ“š {student['field']} â€¢ ğŸ¯ {student['target']} â€¢ ğŸ« {student['grade']}
                            <br>
                            ğŸ“… Son GiriÅŸ: {student['last_login'].strftime('%d.%m.%Y')}
                        </span>
                    </div>
                    <div style="text-align: right;">
                        <div style="color: {text_color}; font-weight: bold; font-size: 18px;">
                            {status_emoji} %{performance}
                        </div>
                        <div style="color: {text_color}; opacity: 0.8; font-size: 12px;">
                            â±ï¸ {student['total_hours']}h | ğŸ“ {student['exam_count']} deneme
                        </div>
                    </div>
                </div>
            </div>
            """, unsafe_allow_html=True)
    else:
        st.info("Filtrelere uygun Ã¶ÄŸrenci bulunamadÄ±.")
    
    # UyarÄ±lar
    st.markdown("---")
    st.markdown("## ğŸš¨ Dikkat Gerektiren Durumlar")
    
    col1, col2 = st.columns(2)
    
    with col1:
        st.markdown("### âš ï¸ DÃ¼ÅŸÃ¼k Performans")
        low_performance = [s for s in students if s['weekly_performance'] < 60]
        if low_performance:
            for student in low_performance:
                st.warning(f"ğŸš¨ {student['name']}: %{student['weekly_performance']}")
        else:
            st.success("âœ… DÃ¼ÅŸÃ¼k performanslÄ± Ã¶ÄŸrenci yok")
    
    with col2:
        st.markdown("### ğŸ“´ Pasif Ã–ÄŸrenciler")
        inactive_students = [s for s in students if s['status'] == 'Pasif']
        if inactive_students:
            for student in inactive_students:
                days_ago = (datetime.now() - student['last_login']).days
                st.error(f"ğŸ”´ {student['name']}: {days_ago} gÃ¼n Ã¶nce")
        else:
            st.success("âœ… TÃ¼m Ã¶ÄŸrenciler aktif")

# Ana uygulama akÄ±ÅŸÄ±na admin sekmesi ekle
def main():
    """Ana uygulama fonksiyonu"""
    
    # Admin panel kontrolÃ¼
    admin_mode = st.sidebar.checkbox("ğŸ” Admin Panel", help="Ã–ÄŸretmen/Veli giriÅŸi")
    
    if admin_mode:
        if not check_admin_access():
            admin_login()
            return
        else:
            show_admin_dashboard()
            return

def play_pomodoro_finished_sound():
    """ğŸš€ OPTÄ°MÄ°ZE EDÄ°LMÄ°Å: Sadece gÃ¶rsel bildirim - Download azalmasÄ±"""
    st.markdown("""
    <script>
    // Sadece gÃ¶rsel bildirim - Base64 ses dosyasÄ± yok
    const notification = document.createElement('div');
    notification.style.position = 'fixed';
    notification.style.top = '20px';
    notification.style.right = '20px';
    notification.style.background = '#ff6b6b';
    notification.style.color = 'white';
    notification.style.padding = '15px 20px';
    notification.style.borderRadius = '8px';
    notification.style.boxShadow = '0 4px 12px rgba(255, 107, 107, 0.3)';
    notification.style.zIndex = '9999';
    notification.style.transform = 'translateX(0)';
    notification.style.transition = 'transform 0.5s ease-out';
    notification.innerHTML = 'ğŸ‰ Pomodoro TamamlandÄ±! Mola zamanÄ±! ğŸ””';
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 500);
    }, 3000);
    </script>
    """, unsafe_allow_html=True)

def play_break_start_sound():
    """ğŸš€ OPTÄ°MÄ°ZE EDÄ°LMÄ°Å: Mola bildirimÄ± - Download azalmasÄ±"""
    st.markdown("""
    <script>
    // Sadece gÃ¶rsel bildirim - Base64 ses dosyasÄ± yok
    const notification = document.createElement('div');
    notification.style.position = 'fixed';
    notification.style.top = '20px';
    notification.style.right = '20px';
    notification.style.background = '#28a745';
    notification.style.color = 'white';
    notification.style.padding = '15px 20px';
    notification.style.borderRadius = '8px';
    notification.style.boxShadow = '0 4px 12px rgba(40, 167, 69, 0.3)';
    notification.style.zIndex = '9999';
    notification.innerHTML = 'â° Mola BaÅŸladÄ±! Rahatlamaya zaman! ğŸ˜Œ';
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
    </script>
    """, unsafe_allow_html=True)

# ğŸš€ FIREBASE CACHE SÄ°STEMÄ° (Download Optimizasyonu)
class FirebaseCache:
    """Firebase iÅŸlemleri iÃ§in cache sistemi"""
    def __init__(self):
        self.cache = {}
        self.cache_duration = 3600  # ğŸš€ OPTÄ°MÄ°ZE: 1 saat cache (Ã¶nceden 5 dakika)
    
    def get_users(self, limit_to_user=None):
        """ğŸš€ OPTÄ°MÄ°ZE: Cache'li ve lazy loading destekli kullanÄ±cÄ± verisi"""
        cache_key = "all_users" if not limit_to_user else f"user_{limit_to_user}"
        current_time = time.time()
        
        if (cache_key in self.cache and 
            current_time - self.cache[cache_key]['time'] < self.cache_duration):
            return self.cache[cache_key]['data']
            
        # Firebase'den Ã§ek
        try:
            if limit_to_user:
                # Sadece belirli kullanÄ±cÄ±yÄ± Ã§ek (Lazy Loading)
                users_data = {limit_to_user: db_ref.child(limit_to_user).get()} if firebase_connected else {}
            else:
                # TÃ¼m kullanÄ±cÄ±larÄ± Ã§ek (Admin iÃ§in)
                users_data = db_ref.get() if firebase_connected else {}
            
            self.cache[cache_key] = {
                'data': users_data,
                'time': current_time
            }
            return users_data
        except:
            return {}
    
    def get_user_data(self, username):
        """Cache'li tek kullanÄ±cÄ± verisi"""
        cache_key = f"user_{username}"
        current_time = time.time()
        
        if (cache_key in self.cache and 
            current_time - self.cache[cache_key]['time'] < self.cache_duration):
            return self.cache[cache_key]['data']
        
        # Firebase'den Ã§ek
        try:
            if firebase_connected and db_ref:
                data = db_ref.child(username).get()
                if data:
                    self.cache[cache_key] = {
                        'data': data,
                        'time': current_time
                    }
                    return data
        except:
            pass
        
        return self.cache.get(cache_key, {}).get('data', {})
    
    def update_user_data(self, username, data):
        """KullanÄ±cÄ± verisini gÃ¼ncelle + cache'i temizle"""
        try:
            if firebase_connected and db_ref:
                db_ref.child(username).update(data)
            
            # Cache'i gÃ¼ncelle
            cache_key = f"user_{username}"
            if cache_key in self.cache:
                self.cache[cache_key]['data'].update(data)
                self.cache[cache_key]['time'] = time.time()
            
            return True
        except:
            return False
    
    def clear_cache(self, pattern=None):
        """Cache'i temizle"""
        if pattern:
            # Belirli pattern'a uyan cache'i temizle
            keys_to_remove = [k for k in self.cache.keys() if pattern in k]
            for key in keys_to_remove:
                del self.cache[key]
        else:
            # TÃ¼m cache'i temizle
            self.cache.clear()

# Global cache objesi
firebase_cache = FirebaseCache()

# ğŸš€ OPTÄ°MÄ°ZE EDÄ°LMÄ°Å GRAFÄ°K CACHE SÄ°STEMÄ°
@lru_cache(maxsize=32)
def create_cached_chart(chart_type, *args, **kwargs):
    """Grafik oluÅŸturma cache'i"""
    if chart_type == "performance":
        return {"type": "performance_chart", "data": args, "kwargs": kwargs}
    elif chart_type == "progress":
        return {"type": "progress_chart", "data": args, "kwargs": kwargs}
    else:
        return {"type": "default_chart", "data": args, "kwargs": kwargs}

# Firebase baÅŸlatma
firebase_connected = False
db_ref = None

if FIREBASE_AVAILABLE:
    try:
        # Firebase'in zaten baÅŸlatÄ±lÄ±p baÅŸlatÄ±lmadÄ±ÄŸÄ±nÄ± kontrol et
        if not firebase_admin._apps:
            # Firebase Admin SDK'yÄ± baÅŸlat
            # GitHub/Streamlit Cloud deployment iÃ§in environment variable kontrolÃ¼
            if 'FIREBASE_KEY' in os.environ:
                # Production: Environment variable'dan JSON key'i al
                firebase_json = os.environ["FIREBASE_KEY"]
                firebase_config = json.loads(firebase_json)
                cred = credentials.Certificate(firebase_config)
            else:
                # Local development: JSON dosyasÄ±ndan al
                cred = credentials.Certificate("firebase_key.json")
            
            firebase_admin.initialize_app(cred, {
                'databaseURL':'https://yeniseninalanin-default-rtdb.firebaseio.com/'  # âœ… DOÄRU/'
            })
        
        db_ref = db.reference('users')
        firebase_connected = True
   
        
    except Exception as e:
        st.warning(f"âš ï¸ Firebase baÄŸlantÄ±sÄ± kurulamadÄ±: {e}")
        firebase_connected = False
        db_ref = None
else:
    st.info("ğŸ“¦ Firebase modÃ¼lÃ¼ yÃ¼klenmedi - yerel test modu aktif")

# FALLBACK: GeÃ§ici test kullanÄ±cÄ±larÄ±
if not firebase_connected:
    st.info("ğŸ”§ Yerel test sistemi kullanÄ±lÄ±yor...")
    if 'fallback_users' not in st.session_state:
        st.session_state.fallback_users = {
            'test_ogrenci': {
                'username': 'test_ogrenci',
                'password': '123456',
                'name': 'Test',
                'surname': 'Ã–ÄŸrenci',
                'grade': '12',
                'field': 'SayÄ±sal',
                'created_date': '2025-01-01',
                'student_status': 'ACTIVE',
                'topic_progress': '{}',
                'topic_completion_dates': '{}',
                'topic_repetition_history': '{}',
                'topic_mastery_status': '{}',
                'pending_review_topics': '{}',
                'total_study_time': 0,
                'created_by': 'LOCAL_TEST',
                'last_login': None
            },
            'admin': {
                'username': 'admin',
                'password': 'admin123',
                'name': 'Admin',
                'surname': 'User',
                'grade': '12',
                'field': 'Test',
                'created_date': '2025-01-01',
                'student_status': 'ACTIVE',
                'topic_progress': '{}',
                'topic_completion_dates': '{}',
                'topic_repetition_history': '{}',
                'topic_mastery_status': '{}',
                'pending_review_topics': '{}',
                'total_study_time': 0,
                'created_by': 'LOCAL_TEST',
                'last_login': None
            }
        }
    st.success("âœ… Test kullanÄ±cÄ±larÄ± hazÄ±rlandÄ±!")

# Firebase veritabanÄ± fonksiyonlarÄ±
def load_users_from_firebase(force_refresh=False):
    """ğŸš€ OPTÄ°MÄ°ZE EDÄ°LMÄ°Å: Session state ile agresif cache"""
    # Session state'te varsa ve force refresh yoksa direkt dÃ¶ndÃ¼r
    if not force_refresh and 'users_db' in st.session_state and st.session_state.users_db:
        return st.session_state.users_db
    
    # Firebase cache'den Ã§ek
    users_data = firebase_cache.get_users()
    
    # Session state'e kaydet
    st.session_state.users_db = users_data
    
    return users_data

def update_user_in_firebase(username, data):
    """ğŸš€ OPTÄ°MÄ°ZE EDÄ°LMÄ°Å: Cache'li kullanÄ±cÄ± verisi gÃ¼ncelleme"""
    # Session state'i gÃ¼ncelle
    if 'users_db' in st.session_state:
        if username in st.session_state.users_db:
            st.session_state.users_db[username].update(data)
        else:
            # Yeni kullanÄ±cÄ± - ekle
            st.session_state.users_db[username] = data
    
    # HaftalÄ±k plan cache'ini temizle
    if 'weekly_plan_cache' in st.session_state:
        del st.session_state.weekly_plan_cache
    
    # Cache'li gÃ¼ncelleme
    return firebase_cache.update_user_data(username, data)

# === HÄ°BRÄ°T POMODORO SÄ°STEMÄ° SABÄ°TLERÄ° ===

# YKS OdaklÄ± Motivasyon SÃ¶zleri - Hibrit Sistem iÃ§in
MOTIVATION_QUOTES = [
    "Her 50 dakikalÄ±k emek, seni rakiplerinden ayÄ±rÄ±yor! ğŸ’ª",
    "Åu anda Ã§Ã¶zdÃ¼ÄŸÃ¼n her soru, YKS'de seni zirveye taÅŸÄ±yacak! ğŸ¯",
    "BÃ¼yÃ¼k hedefler kÃ¼Ã§Ã¼k adÄ±mlarla baÅŸlar - sen doÄŸru yoldasÄ±n! â­",
    "Her nefes alÄ±ÅŸÄ±n, YKS baÅŸarÄ±na bir adÄ±m daha yaklaÅŸtÄ±rÄ±yor! ğŸŒ¬ï¸",
    "Zorluklara direnmek seni gÃ¼Ã§lendiriyor - YKS'de fark yaratacaksÄ±n! ğŸš€",
    "BugÃ¼n kazandÄ±ÄŸÄ±n her kavram, sÄ±navda seni Ã¶ne Ã§Ä±karacak! ğŸ“š",
    "Konsantrasyon kaslarÄ±n gÃ¼Ã§leniyor - ÅŸampiyonlar bÃ¶yle yetiÅŸir! ğŸ§ ",
    "Hedefine odaklan! Her dakika YKS baÅŸarÄ±n iÃ§in deÄŸerli! ğŸ†",
    "Mola hakkÄ±nÄ± akÄ±llÄ±ca kullanÄ±yorsun - bu seni daha gÃ¼Ã§lÃ¼ yapÄ±yor! ğŸ’¨",
    "BaÅŸarÄ± sabÄ±r ister, sen sabÄ±rlÄ± bir savaÅŸÃ§Ä±sÄ±n! âš”ï¸",
    "Her yeni konu Ã¶ÄŸreniÅŸin, gelecekteki mesleÄŸinin temeli! ğŸ—ï¸",
    "RÃ¼yalarÄ±nÄ±n peÅŸinde koÅŸuyorsun - asla vazgeÃ§me! ğŸŒŸ",
    "YKS sadece bir sÄ±nav, sen ise sÄ±nÄ±rsÄ±z potansiyelin! ğŸŒˆ",
    "Her pomodoro seansÄ±, hedefine bir adÄ±m daha yaklaÅŸtÄ±rÄ±yor! ğŸ¯",
    "DÃ¼n yapamadÄ±ÄŸÄ±nÄ± bugÃ¼n yapabiliyorsun - bu geliÅŸim! ğŸ“ˆ",
    "Zorlu sorularÄ± Ã§Ã¶zerken beynin gÃ¼Ã§leniyor! ğŸ§©",
    "Her mola sonrasÄ± daha gÃ¼Ã§lÃ¼ dÃ¶nÃ¼yorsun! ğŸ’ª",
    "Bilim insanlarÄ± da bÃ¶yle Ã§alÄ±ÅŸtÄ± - sen de baÅŸaracaksÄ±n! ğŸ”¬",
    "Her nefes, yeni bir baÅŸlangÄ±Ã§ fÄ±rsatÄ±! ğŸŒ±",
    "Hayal ettiÄŸin Ã¼niversite seni bekliyor! ğŸ›ï¸"
]

# Mikro ipuÃ§larÄ± (ders bazÄ±nda)
MICRO_TIPS = {
    "TYT Matematik": [
        "ğŸ“ TÃ¼rev sorularÄ±nda genellikle Ã¶nce fonksiyonun kÃ¶klerini bulmak saldÄ±rÄ±larÄ± hÄ±zlandÄ±rÄ±r.",
        "ğŸ”¢ Ä°ntegral hesaplarken substitÃ¼syon methodunu akÄ±lda tut.",
        "ğŸ“Š Geometri problemlerinde Ã§izim yapmayÄ± unutma.",
        "âš¡ Limit sorularÄ±nda l'hopital kuralÄ±nÄ± hatÄ±rla."
    ],
    "TYT Fizik": [
        "âš¡ Newton yasalarÄ±nÄ± uygularken kuvvet vektÃ¶rlerini doÄŸru Ã§iz.",
        "ğŸŒŠ Dalga problemlerinde frekans-dalga boyu iliÅŸkisini unutma.",
        "ğŸ”¥ Termodinamik sorularÄ±nda sistem sÄ±nÄ±rlarÄ±nÄ± net belirle.",
        "ğŸ”¬ Elektrik alanÄ± hesaplamalarÄ±nda iÅŸaret dikkatli kontrol et."
    ],
    "TYT Kimya": [
        "ğŸ§ª Mol kavramÄ± tÃ¼m hesaplamalarÄ±n temeli - ezberleme!",
        "âš›ï¸ Periyodik cetveldeki eÄŸilimleri gÃ¶rselleÅŸtir.",
        "ğŸ”„ Denge tepkimelerinde Le Chatelier prensibini uygula.",
        "ğŸ’§ Asit-baz titrasyonlarÄ±nda eÅŸdeÄŸer nokta kavramÄ±nÄ± unutma."
    ],
    "TYT TÃ¼rkÃ§e": [
        "ğŸ“– Paragraf sorularÄ±nda ana fikri ilk ve son cÃ¼mlelerde ara.",
        "âœï¸ Anlam bilgisi sorularÄ±nda baÄŸlamÄ± dikkate al.",
        "ğŸ“ YazÄ±m kurallarÄ±nda 'de/da' ayrÄ±m kuralÄ±nÄ± hatÄ±rla.",
        "ğŸ­ Edebi tÃ¼rlerde karakterizasyon Ã¶nemli."
    ],
    "TYT Tarih": [
        "ğŸ“… OlaylarÄ± kronolojik sÄ±rayla Ã¶ÄŸren, sebep-sonuÃ§ baÄŸla.",
        "ğŸ›ï¸ Siyasi yapÄ±lar sosyal yapÄ±larla iliÅŸkisini kur.",
        "ğŸ—ºï¸ Haritalarla coÄŸrafi konumlarÄ± pekiÅŸtir.",
        "ğŸ‘‘ DÃ¶nem Ã¶zelliklerini baÅŸlÄ±ca olaylarla Ã¶rnekle."
    ],
    "TYT CoÄŸrafya": [
        "ğŸŒ Ä°klim tÃ¼rlerini sebepleriyle birlikte Ã¶ÄŸren.",
        "ğŸ”ï¸ Jeomorfoloji'de sÃ¼reÃ§-ÅŸekil iliÅŸkisini kur.",
        "ğŸ“Š Ä°statistiksel veriler harita okuma becerisini geliÅŸtir.",
        "ğŸŒ± Bitki Ã¶rtÃ¼sÃ¼-iklim iliÅŸkisini unutma."
    ],
    "AYT Matematik": [
        "ğŸ“ TÃ¼rev sorularÄ±nda genellikle Ã¶nce fonksiyonun kÃ¶klerini bulmak saldÄ±rÄ±larÄ± hÄ±zlandÄ±rÄ±r.",
        "ğŸ”¢ Ä°ntegral hesaplarken substitÃ¼syon methodunu akÄ±lda tut.",
        "ğŸ“Š Geometri problemlerinde Ã§izim yapmayÄ± unutma.",
        "âš¡ Limit sorularÄ±nda l'hopital kuralÄ±nÄ± hatÄ±rla."
    ],
    "AYT Fizik": [
        "âš¡ Newton yasalarÄ±nÄ± uygularken kuvvet vektÃ¶rlerini doÄŸru Ã§iz.",
        "ğŸŒŠ Dalga problemlerinde frekans-dalga boyu iliÅŸkisini unutma.",
        "ğŸ”¥ Termodinamik sorularÄ±nda sistem sÄ±nÄ±rlarÄ±nÄ± net belirle.",
        "ğŸ”¬ Elektrik alanÄ± hesaplamalarÄ±nda iÅŸaret dikkatli kontrol et."
    ],
    "AYT Kimya": [
        "ğŸ§ª Mol kavramÄ± tÃ¼m hesaplamalarÄ±n temeli - ezberleme!",
        "âš›ï¸ Periyodik cetveldeki eÄŸilimleri gÃ¶rselleÅŸtir.",
        "ğŸ”„ Denge tepkimelerinde Le Chatelier prensibini uygula.",
        "ğŸ’§ Asit-baz titrasyonlarÄ±nda eÅŸdeÄŸer nokta kavramÄ±nÄ± unutma."
    ],
    "Genel": [
        "ğŸ¯ Zor sorularla karÅŸÄ±laÅŸtÄ±ÄŸÄ±nda derin nefes al ve sistematik dÃ¼ÅŸÃ¼n.",
        "â° Zaman yÃ¶netimini ihmal etme - her dakika deÄŸerli.",
        "ğŸ“š KavramlarÄ± sadece ezberlemek yerine anlayarak Ã¶ÄŸren.",
        "ğŸ”„ DÃ¼zenli tekrar yapmak kalÄ±cÄ±lÄ±ÄŸÄ± artÄ±rÄ±r."
    ]
}

# YKS OdaklÄ± Nefes Egzersizi TalimatlarÄ±
BREATHING_EXERCISES = [
    {
        "name": "4-4-4-4 TekniÄŸi (Kare Nefes)",
        "instruction": "4 saniye nefes al â†’ 4 saniye tut â†’ 4 saniye ver â†’ 4 saniye bekle",
        "benefit": "Stresi azaltÄ±r, odaklanmayÄ± artÄ±rÄ±r, sÄ±nav kaygÄ±sÄ±nÄ± azaltÄ±r"
    },
    {
        "name": "KarÄ±n Nefesi (Diyafragma Nefesi)",
        "instruction": "Elinizi karnÄ±nÄ±za koyun. Nefes alÄ±rken karÄ±n ÅŸiÅŸsin, verirken insin",
        "benefit": "GevÅŸemeyi saÄŸlar, kaygÄ±yÄ± azaltÄ±r, zihinsel netliÄŸi artÄ±rÄ±r"
    },
    {
        "name": "4-7-8 SakinleÅŸtirici Nefes",
        "instruction": "4 saniye burun ile nefes al â†’ 7 saniye tut â†’ 8 saniye aÄŸÄ±z ile ver",
        "benefit": "Derin rahatlama saÄŸlar, uykuya yardÄ±m eder, sÄ±nav Ã¶ncesi sakinleÅŸtirir"
    },
    {
        "name": "YavaÅŸ Derin Nefes",
        "instruction": "6 saniye nefes al â†’ 2 saniye tut â†’ 6 saniye yavaÅŸÃ§a ver",
        "benefit": "Kalp ritmi dÃ¼zenlenir, sakinleÅŸir, zihinsel berraklÄ±k artar"
    },
    {
        "name": "Alternatif Burun Nefesi",
        "instruction": "SaÄŸ burun deliÄŸi ile nefes al, sol ile ver. Sonra tersini yap",
        "benefit": "Beynin her iki yarÄ±m kÃ¼resini dengeler, konsantrasyonu artÄ±rÄ±r"
    },
    {
        "name": "5-5 Basit Ritim",
        "instruction": "5 saniye nefes al â†’ 5 saniye nefes ver (hiÃ§ tutmadan)",
        "benefit": "Basit ve etkili, hÄ±zlÄ± sakinleÅŸme, odaklanma Ã¶ncesi ideal"
    }
]

# TÃ¼m kullanÄ±cÄ± alanlarÄ±nÄ± tutarlÄ±lÄ±k iÃ§in tanÄ±mlÄ±yoruz.
FIELDNAMES = ['username', 'password', 'name', 'surname', 'grade', 'field', 'target_department', 'tyt_last_net', 'tyt_avg_net', 'ayt_last_net', 'ayt_avg_net', 
              # Net aralÄ±k ve seviye bilgileri
              'tyt_last_range', 'tyt_avg_range', 'ayt_last_range', 'ayt_avg_range',
              'tyt_last_level', 'tyt_avg_level', 'ayt_last_level', 'ayt_avg_level',
              # DiÄŸer alanlar
              'learning_style', 'learning_style_scores', 'created_at',  'detailed_nets', 'deneme_analizleri','study_program', 'topic_progress', 'topic_completion_dates', 'yks_survey_data', 'pomodoro_history'
              ,'is_profile_complete', 
              'is_learning_style_set', 
              'learning_style',
              
              # YENÄ° ALANLAR - KalÄ±cÄ± Ã–ÄŸrenme Sistemi
              'topic_repetition_history',  # Her konunun tekrar geÃ§miÅŸi
              'topic_mastery_status',      # Konunun kalÄ±cÄ±lÄ±k durumu
              'pending_review_topics',     # Tekrar deÄŸerlendirmesi bekleyen konular
              
              # YENÄ° ALAN - GÃ¼nlÃ¼k Motivasyon Sistemi
              'daily_motivation'           # GÃ¼nlÃ¼k motivasyon puanlarÄ± ve notlarÄ±
              ]

# BÃ¶lÃ¼mlere gÃ¶re arka plan resimleri
# ğŸš€ OPTÄ°MÄ°ZE EDÄ°LMÄ°Å ARKA PLAN SÄ°STEMÄ° (Download Azaltma)
BACKGROUND_STYLES = {
    "TÄ±p": {
        "gradient": "linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%)",
        "icon": "ğŸ©º"
    },
    "MÃ¼hendislik": {
        "gradient": "linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%)",
        "icon": "âš™ï¸"
    },
    "Hukuk": {
        "gradient": "linear-gradient(135deg, #556270 0%, #4ecdc4 100%)",
        "icon": "âš–ï¸"
    },
    "Ã–ÄŸretmenlik": {
        "gradient": "linear-gradient(135deg, #ffd89b 0%, #19547b 100%)",
        "icon": "ğŸ‘¨â€ğŸ«"
    },
    "Ä°ktisat": {
        "gradient": "linear-gradient(135deg, #834d9b 0%, #d04ed6 100%)",
        "icon": "ğŸ“ˆ"
    },
    "MimarlÄ±k": {
        "gradient": "linear-gradient(135deg, #5614b0 0%, #dbd65c 100%)",
        "icon": "ğŸ›ï¸"
    },
    "Psikoloji": {
        "gradient": "linear-gradient(135deg, #654ea3 0%, #eaafc8 100%)",
        "icon": "ğŸ§ "
    },
    "DiÅŸ HekimliÄŸi": {
        "gradient": "linear-gradient(135deg, #ff5e62 0%, #ff9966 100%)",
        "icon": "ğŸ¦·"
    },
    # ğŸ–ï¸ MSÃœ (Askeri) Alt Kategorileri - Resim yok, gradient var
    "MSÃœ - Kara Astsubay Meslek YÃ¼ksekokulu": {
        "gradient": "linear-gradient(135deg, #2d5016 0%, #4a7c59 50%, #5e8b3a 100%)",
        "icon": "ğŸ–ï¸"
    },
    "MSÃœ - Deniz Astsubay YÃ¼ksekokulu": {
        "gradient": "linear-gradient(135deg, #0c4a6e 0%, #0ea5e9 50%, #075985 100%)",
        "icon": "âš“"
    },
    "MSÃœ - Hava Astsubay YÃ¼ksekokulu": {
        "gradient": "linear-gradient(135deg, #1e40af 0%, #60a5fa 50%, #2563eb 100%)",
        "icon": "âœˆï¸"
    },
    
    # ğŸ“ TYT (Meslek YÃ¼ksekokulu) Alt Kategorileri - Resim yok, gradient var
    "TYT - Bilgisayar ProgramcÄ±lÄ±ÄŸÄ±": {
        "gradient": "linear-gradient(135deg, #1e1b4b 0%, #5b21b6 50%, #7c3aed 100%)",
        "icon": "ğŸ’»"
    },
    "TYT - Anestezi TeknisyenliÄŸi": {
        "gradient": "linear-gradient(135deg, #064e3b 0%, #059669 50%, #10b981 100%)",
        "icon": "ğŸ¥"
    },
    "TYT - Acil TÄ±p TeknisyenliÄŸi (ATT)": {
        "gradient": "linear-gradient(135deg, #991b1b 0%, #dc2626 50%, #ef4444 100%)",
        "icon": "ğŸš‘"
    },
    "TYT - Ã‡ocuk GeliÅŸimi": {
        "gradient": "linear-gradient(135deg, #ec4899 0%, #f472b6 50%, #fbbf24 100%)",
        "icon": "ğŸ‘¶"
    },
    "TYT - Ebe": {
        "gradient": "linear-gradient(135deg, #be185d 0%, #ec4899 50%, #f9a8d4 100%)",
        "icon": "ğŸ¤±"
    },
    "TYT - Hemato terapiliÅŸi": {
        "gradient": "linear-gradient(135deg, #7f1d1d 0%, #dc2626 50%, #fecaca 100%)",
        "icon": "ğŸ©¸"
    },
    "TYT - TÄ±bbi Laboratuvar Teknikleri": {
        "gradient": "linear-gradient(135deg, #065f46 0%, #059669 50%, #a7f3d0 100%)",
        "icon": "ğŸ”¬"
    },
    "TYT - TÄ±bbi GÃ¶rÃ¼ntÃ¼leme Teknikleri": {
        "gradient": "linear-gradient(135deg, #374151 0%, #6b7280 50%, #d1d5db 100%)",
        "icon": "ğŸ“±"
    },
    "TYT - Radyoterapi": {
        "gradient": "linear-gradient(135deg, #581c87 0%, #7c3aed 50%, #c4b5fd 100%)",
        "icon": "âš¡"
    },
    "TYT - Diyaliz": {
        "gradient": "linear-gradient(135deg, #0f766e 0%, #14b8a6 50%, #99f6e4 100%)",
        "icon": "ğŸ’§"
    },
    "TYT - DiÅŸ ProtÃ©s TeknisyenliÄŸi": {
        "gradient": "linear-gradient(135deg, #0369a1 0%, #0ea5e9 50%, #bae6fd 100%)",
        "icon": "ğŸ¦·"
    },
    "TYT - Otomotiv Teknolojisi": {
        "gradient": "linear-gradient(135deg, #374151 0%, #4b5563 50%, #9ca3af 100%)",
        "icon": "ğŸš—"
    },
    "TYT - Elektrik-Elektronik Teknolojisi": {
        "gradient": "linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%)",
        "icon": "âš¡"
    },
    "TYT - Makine Teknolojisi": {
        "gradient": "linear-gradient(135deg, #1f2937 0%, #374151 50%, #6b7280 100%)",
        "icon": "âš™ï¸"
    },
    "TYT - Ä°nÅŸaat Teknolojisi": {
        "gradient": "linear-gradient(135deg, #a16207 0%, #d97706 50%, #fbbf24 100%)",
        "icon": "ğŸ—ï¸"
    },
    "TYT - DiÄŸer Meslek YÃ¼ksekokulu": {
        "gradient": "linear-gradient(135deg, #4338ca 0%, #6366f1 50%, #a5b4fc 100%)",
        "icon": "ğŸ“"
    },
    
    "VarsayÄ±lan": {
        "gradient": "linear-gradient(135deg, #667eea 0%, #764ba2 100%)",
        "icon": "ğŸ¯"
    }
}

# ğŸ¯ Hedef BÃ¶lÃ¼m Zorluk Sistemi (Net AralÄ±ÄŸÄ±na GÃ¶re)
TARGET_DEPARTMENT_DIFFICULTY = {
    "TÄ±p": {
        "difficulty_level": 5,  # En zor
        "required_nets": {"TYT": 115, "AYT": 75},
        "study_intensity": "maksimum",
        "weekly_topic_multiplier": 1.5
    },
    "DiÅŸ HekimliÄŸi": {
        "difficulty_level": 5,
        "required_nets": {"TYT": 110, "AYT": 70},
        "study_intensity": "maksimum", 
        "weekly_topic_multiplier": 1.4
    },
    "MÃ¼hendislik": {
        "difficulty_level": 4,
        "required_nets": {"TYT": 105, "AYT": 65},
        "study_intensity": "yÃ¼ksek",
        "weekly_topic_multiplier": 1.3
    },
    "Hukuk": {
        "difficulty_level": 4,
        "required_nets": {"TYT": 100, "AYT": 60},
        "study_intensity": "yÃ¼ksek",
        "weekly_topic_multiplier": 1.2
    },
    "MimarlÄ±k": {
        "difficulty_level": 3,
        "required_nets": {"TYT": 95, "AYT": 55},
        "study_intensity": "orta-yÃ¼ksek",
        "weekly_topic_multiplier": 1.1
    },
    "Psikoloji": {
        "difficulty_level": 3,
        "required_nets": {"TYT": 90, "AYT": 50},
        "study_intensity": "orta-yÃ¼ksek",
        "weekly_topic_multiplier": 1.1
    },
    "Ä°ktisat": {
        "difficulty_level": 2,
        "required_nets": {"TYT": 85, "AYT": 45},
        "study_intensity": "orta",
        "weekly_topic_multiplier": 1.0
    },
    "Ã–ÄŸretmenlik": {
        "difficulty_level": 2,
        "required_nets": {"TYT": 80, "AYT": 40},
        "study_intensity": "orta",
        "weekly_topic_multiplier": 1.0
    },
    "VarsayÄ±lan": {
        "difficulty_level": 1,
        "required_nets": {"TYT": 75, "AYT": 35},
        "study_intensity": "normal",
        "weekly_topic_multiplier": 0.9
    }
}

# ğŸ“š SÄ±nÄ±f BazlÄ± Program Sistemi
GRADE_BASED_PROGRAMS = {
    "11. SÄ±nÄ±f": {
        "focus": "temel_kavramlar_ve_konu_ogrenme",
        "study_pace": "normal",
        "weekly_topic_base": 12,  # 11. sÄ±nÄ±f iÃ§in daha fazla konu
        "review_ratio": 0.2,  # %20 tekrar, %80 yeni konu
        "exam_frequency": "ayda_1",
        "special_notes": "Temel kavramlarÄ± saÄŸlam Ã¶ÄŸrenme dÃ¶nemi"
    },
    "12. SÄ±nÄ±f": {
        "focus": "konu_tamamlama_ve_deneme_odak",
        "study_pace": "hÄ±zlandÄ±rÄ±lmÄ±ÅŸ", 
        "weekly_topic_base": 10,  # Standart
        "review_ratio": 0.3,  # %30 tekrar, %70 yeni konu
        "exam_frequency": "2_haftada_1",
        "special_notes": "Konu tamamlama ve deneme stratejileri dÃ¶nemi"
    },
    "Mezun": {
        "focus": "eksik_kapama_ve_performans_artÄ±rma",
        "study_pace": "maksimum",
        "weekly_topic_base": 8,  # Daha az yeni konu, daha fazla tekrar
        "review_ratio": 0.4,  # %40 tekrar, %60 yeni konu  
        "exam_frequency": "haftada_1",
        "special_notes": "Eksikleri kapatma ve performans maksimizasyonu dÃ¶nemi"
    }
}

# ğŸ¯ Konu Zorluk Puanlama Sistemi (1-5 arasÄ±)
TOPIC_DIFFICULTY_SYSTEM = {
    1: {"name": "Ã‡ok Kolay", "color": "#27ae60", "icon": "ğŸ˜Š", "study_time": "15-20 dk"},
    2: {"name": "Kolay", "color": "#2ecc71", "icon": "ğŸ™‚", "study_time": "20-30 dk"},
    3: {"name": "Orta", "color": "#f39c12", "icon": "ğŸ˜", "study_time": "30-45 dk"},
    4: {"name": "Zor", "color": "#e67e22", "icon": "ğŸ˜°", "study_time": "45-60 dk"},
    5: {"name": "Ã‡ok Zor", "color": "#e74c3c", "icon": "ğŸ˜±", "study_time": "60+ dk"}
}

# ğŸ“š 16 HaftalÄ±k EÅŸit AÄŸÄ±rlÄ±k Detay PlanÄ±
EQUAL_WEIGHT_WEEKLY_PLAN = {
    1: {
        "week": 1,
        "focus": "Temel kavramlar ve baÅŸlangÄ±Ã§",
        "topics": {
            "TYT TÃ¼rkÃ§e": [
                "SÃ¶zcÃ¼kte Anlam - GerÃ§ek Anlam",
                "SÃ¶zcÃ¼kte Anlam - Mecaz Anlam", 
                "SÃ¶zcÃ¼kte Anlam - Terim Anlam",
                "CÃ¼mlede Anlam - CÃ¼mle Yorumlama",
                "CÃ¼mlede Anlam - Kesin YargÄ±",
                "CÃ¼mlede Anlam - AnlatÄ±m BiÃ§imleri",
                "CÃ¼mlede Anlam - Neden-SonuÃ§",
                "Paragraf - Ana Fikir",
                "Paragraf - YardÄ±mcÄ± Fikir",
                "Paragraf - Paragraf YapÄ±sÄ±",
                "Paragraf - AnlatÄ±m Teknikleri",
                "Paragraf - DÃ¼ÅŸÃ¼nceyi GeliÅŸtirme"
            ],
            "TYT Matematik": [
                "Temel Kavramlar",
                "SayÄ± BasamaklarÄ±"
            ],
            "TYT Tarih": [
                "Tarih ve Zaman"
            ],
            "TYT Geometri": [
                "AÃ§Ä±lar - DoÄŸruda AÃ§Ä±lar",
                "AÃ§Ä±lar - ÃœÃ§gende AÃ§Ä±lar"
            ],
            "TYT CoÄŸrafya": [
                "DÃ¼nya HaritalarÄ±"
            ]
        }
    },
    2: {
        "week": 2,
        "focus": "Temel iÅŸlemler ve kavramlar",
        "topics": {
            "TYT TÃ¼rkÃ§e": [
                "Ses Bilgisi"
            ],
            "TYT Matematik": [
                "BÃ¶lme ve BÃ¶lÃ¼nebilme",
                "EBOB-EKOK",
                "Rasyonel SayÄ±lar"
            ],
            "TYT Geometri": [
                "Ã–zel ÃœÃ§genler - Dik ÃœÃ§gen",
                "Ã–zel ÃœÃ§genler - EÅŸkenar ÃœÃ§gen", 
                "Ã–zel ÃœÃ§genler - Ä°kizkenar ÃœÃ§gen"
            ],
            "TYT CoÄŸrafya": [
                "DoÄŸa ve Ä°nsan",
                "DÃ¼nya'nÄ±n Åekli ve Hareketleri (GÃ¼nlÃ¼k ve YÄ±llÄ±k Hareketler, SonuÃ§larÄ±)"
            ],
            "TYT Tarih": [
                "Ä°nsanlÄ±ÄŸÄ±n Ä°lk DÃ¶nemleri",
                "OrtaÃ§aÄŸda DÃ¼nya"
            ]
        }
    },
    3: {
        "week": 3,
        "focus": "YazÄ±m kurallarÄ± ve problem Ã§Ã¶zme",
        "topics": {
            "TYT TÃ¼rkÃ§e": [
                "YazÄ±m KurallarÄ±"
            ],
            "TYT Matematik": [
                "OndalÄ±klÄ± SayÄ±lar",
                "Oran OrantÄ±",
                "Denklem Ã‡Ã¶zme",
                "Problemler - SayÄ± Problemleri",
                "Problemler - Kesir Problemleri"
            ],
            "TYT Geometri": [
                "AÃ§Ä±ortay",
                "Kenarortay"
            ],
            "TYT CoÄŸrafya": [
                "CoÄŸrafi Konum",
                "Harita Bilgisi", 
                "Atmosfer ve SÄ±caklÄ±k"
            ],
            "TYT Tarih": [
                "Ä°lk ve Orta Ã‡aÄŸlarda TÃ¼rk DÃ¼nyasÄ±",
                "Ä°slam Medeniyetinin DoÄŸuÅŸu"
            ]
        }
    },
    4: {
        "week": 4,
        "focus": "Noktalama ve problem Ã§eÅŸitleri",
        "topics": {
            "TYT TÃ¼rkÃ§e": [
                "Noktalama Ä°ÅŸaretleri",
                "SÃ¶zcÃ¼kte YapÄ±"
            ],
            "TYT Matematik": [
                "Basit EÅŸitsizlikler",
                "Mutlak DeÄŸer",
                "Problemler - YaÅŸ Problemleri",
                "Problemler - YÃ¼zde Problemleri", 
                "Problemler - Kar-Zarar Problemleri"
            ],
            "TYT Geometri": [
                "EÅŸlik ve Benzerlik",
                "ÃœÃ§gende Alan"
            ],
            "TYT CoÄŸrafya": [
                "Ä°klim",
                "BasÄ±nÃ§ ve RÃ¼zgarlar",
                "Nem, YaÄŸÄ±ÅŸ ve BuharlaÅŸma"
            ],
            "TYT Tarih": [
                "Ä°lk TÃ¼rk Ä°slam Devletleri",
                "YerleÅŸme ve DevletleÅŸme SÃ¼recinde SelÃ§uklu TÃ¼rkiyesi",
                "Beylikten Devlete OsmanlÄ± Siyaseti (1300-1453)"
            ]
        }
    },
    5: {
        "week": 5,
        "focus": "SÃ¶zcÃ¼k tÃ¼rleri ve Ã¼slÃ¼ sayÄ±lar",
        "topics": {
            "TYT TÃ¼rkÃ§e": [
                "SÃ¶zcÃ¼k TÃ¼rleri - Ä°simler",
                "SÃ¶zcÃ¼k TÃ¼rleri - Zamirler", 
                "SÃ¶zcÃ¼k TÃ¼rleri - SÄ±fatlar",
                "SÃ¶zcÃ¼k TÃ¼rleri - Zarf",
                "SÃ¶zcÃ¼k TÃ¼rleri - Edat"
            ],
            "TYT Matematik": [
                "ÃœslÃ¼ SayÄ±lar",
                "KÃ¶klÃ¼ SayÄ±lar",
                "Problemler - KarÄ±ÅŸÄ±m Problemleri"
            ],
            "TYT Geometri": [
                "AÃ§Ä± Kenar BaÄŸÄ±ntÄ±larÄ±",
                "Ã‡okgenler"
            ],
            "TYT CoÄŸrafya": [
                "Ä°Ã§ Kuvvetler/DÄ±ÅŸ Kuvvetler",
                "Su-Toprak ve Bitkiler",
                "NÃ¼fus"
            ],
            "TYT Tarih": [
                "DÃ¼nya GÃ¼cÃ¼ OsmanlÄ± (1453-1600)",
                "Yeni Ã‡aÄŸ Avrupa Tarihi"
            ]
        }
    },
    6: {
        "week": 6,
        "focus": "Fiil anlam ve Ã§arpanlar",
        "topics": {
            "TYT TÃ¼rkÃ§e": [
                "Fiilde Anlam",
                "Ek Fiil"
            ],
            "TYT Matematik": [
                "Ã‡arpanlara AyÄ±rma",
                "Problemler - Hareket Problemleri",
                "Problemler - Ä°ÅŸÃ§i Problemleri"
            ],
            "TYT Geometri": [
                "Ã–zel DÃ¶rtgenler - Deltoid",
                "Ã–zel DÃ¶rtgenler - Paralelkenar"
            ],
            "TYT CoÄŸrafya": [
                "GÃ¶Ã§",
                "YerleÅŸme",
                "TÃ¼rkiye'nin Yer Åekilleri"
            ],
            "TYT Tarih": [
                "OsmanlÄ± Devletinde ArayÄ±ÅŸ YÄ±llarÄ±",
                "OsmanlÄ± Avrupa Ä°liÅŸkileri",
                "18. YY DeÄŸiÅŸim ve Diplomasi",
                "En Uzun YÃ¼zyÄ±l",
                "OsmanlÄ± KÃ¼ltÃ¼r ve Medeniyeti"
            ]
        }
    },
    7: {
        "week": 7,
        "focus": "Fiilimsi ve fonksiyonlar",
        "topics": {
            "TYT TÃ¼rkÃ§e": [
                "Fiilimsi",
                "Fiilde Ã‡atÄ±"
            ],
            "AYT Matematik": [
                "Fonksiyonlar"
            ],
            "TYT Matematik": [
                "Problemler - Tablo-Grafik Problemleri",
                "Problemler - Rutin Olmayan Problemler"
            ],
            "TYT Geometri": [
                "EÅŸkenar DÃ¶rtgen",
                "DikdÃ¶rtgen"
            ],
            "TYT CoÄŸrafya": [
                "Ekonomik Faaliyetler",
                "BÃ¶lgeler UluslararasÄ± UlaÅŸÄ±m HatlarÄ±, Ã‡evre ve Toplum",
                "DoÄŸal Afetler"
            ],
            "TYT Tarih": [
                "20. YY OsmanlÄ± Devleti",
                "1. DÃ¼nya SavaÅŸÄ±"
            ]
        }
    },
    8: {
        "week": 8,
        "focus": "CÃ¼mle Ã¶ÄŸeleri ve mantÄ±k",
        "topics": {
            "TYT TÃ¼rkÃ§e": [
                "CÃ¼mlenin Ã–ÄŸeleri",
                "CÃ¼mle TÃ¼rleri",
                "AnlatÄ±m BozukluÄŸu"
            ],
            "TYT Matematik": [
                "MantÄ±k",
                "KÃ¼meler"
            ],
            "AYT Matematik": [
                "Polinom"
            ],
            "TYT Geometri": [
                "Kare",
                "Yamuk"
            ],
            "TYT Tarih": [
                "Mondros AteÅŸkesi, Ä°ÅŸgaller ve Cemiyetler",
                "KurtuluÅŸ SavaÅŸÄ±na HazÄ±rlÄ±k DÃ¶nemi",
                "1. TBMM DÃ¶nemi",
                "KurtuluÅŸ SavaÅŸÄ± ve AnlaÅŸmalar"
            ]
        }
    },
    9: {
        "week": 9,
        "focus": "OlasÄ±lÄ±k ve 2. derece denklemler",
        "topics": {
            "TYT Matematik": [
                "OlasÄ±lÄ±k"
            ],
            "AYT Matematik": [
                "2. Derece Denklemler"
            ],
            "TYT Geometri": [
                "Ã‡emberde AÃ§Ä±",
                "Ã‡emberde Uzunluk"
            ],
            "TYT Tarih": [
                "II. TBMM DÃ¶nemi ve Ã‡ok Partili Hayata GeÃ§iÅŸ",
                "TÃ¼rk Ä°nkÄ±labÄ±"
            ],
            "AYT Edebiyat": [
                "GÃ¼zel Sanatlar ve Edebiyat ile Ä°liÅŸkisi",
                "Metinlerin SÄ±nÄ±flandÄ±rÄ±lmasÄ±"
            ],
            "AYT CoÄŸrafya": [
                "Ekosistem"
            ]
        }
    },
    10: {
        "week": 10,
        "focus": "Edebiyat baÅŸlangÄ±Ã§ ve biyoÃ§eÅŸitlilik",
        "topics": {
            "AYT Edebiyat": [
                "Edebi Sanatlar",
                "Edebiyat AkÄ±mlarÄ±"
            ],
            "AYT CoÄŸrafya": [
                "BiyoÃ§eÅŸitlilik",
                "Biyomlar",
                "Ekosistem UnsurlarÄ±"
            ],
            "AYT Matematik": [
                "KarmaÅŸÄ±k SayÄ±lar",
                "2. Derece Denklem ve EÅŸitsizlikler"
            ],
            "TYT Tarih": [
                "AtatÃ¼rk Ä°lkeleri",
                "AtatÃ¼rk DÃ¶nemi TÃ¼rk DÄ±ÅŸ PolitikasÄ±"
            ],
            "TYT Geometri": [
                "Dairede Ã‡evre ve Alan",
                "NoktanÄ±n AnalitiÄŸi"
            ]
        }
    },
    11: {
        "week": 11,
        "focus": "DÃ¼nya edebiyatÄ± ve logaritma",
        "topics": {
            "AYT Edebiyat": [
                "DÃ¼nya EdebiyatÄ±",
                "Anlam Bilgisi (Tekrar)",
                "Dil Bilgisi (Tekrar)",
                "Åiir Bilgisi"
            ],
            "AYT Matematik": [
                "Parabol",
                "Logaritma"
            ],
            "TYT Geometri": [
                "DoÄŸrunun AnalitiÄŸi",
                "Prizmalar"
            ],
            "AYT CoÄŸrafya": [
                "Enerji AkÄ±ÅŸÄ± ve Madde DÃ¶ngÃ¼sÃ¼",
                "NÃ¼fus PolitikalarÄ±",
                "TÃ¼rkiye'de NÃ¼fus ve YerleÅŸme",
                "GÃ¶Ã§ ve ÅehirleÅŸme"
            ],
            "AYT Tarih": [
                "Tarih ve Zaman (Temel Kavramlar)",
                "Ä°nsanlÄ±ÄŸÄ±n Ä°lk DÃ¶nemleri",
                "OrtaÃ§aÄŸda DÃ¼nya"
            ]
        }
    },
    12: {
        "week": 12,
        "focus": "TÃ¼rk edebiyatÄ± dÃ¶nemleri ve geometrik cisimler",
        "topics": {
            "AYT Edebiyat": [
                "TÃ¼rk EdebiyatÄ± DÃ¶nemleri (Genel Ã–zellikler)",
                "Ä°slamiyet Ã–ncesi TÃ¼rk EdebiyatÄ± (SÃ¶zlÃ¼ ve YazÄ±lÄ±)",
                "Ä°slamiyet Etkisindeki GeÃ§iÅŸ DÃ¶nemi EdebiyatÄ±"
            ],
            "AYT Matematik": [
                "Diziler",
                "Limit"
            ],
            "TYT Geometri": [
                "KÃ¼p",
                "Silindir"
            ],
            "AYT CoÄŸrafya": [
                "Ekonomik Faaliyetler ve DoÄŸal Kaynaklar",
                "TÃ¼rkiye Ekonomisi",
                "TÃ¼rkiye'nin Ekonomik PolitikalarÄ±",
                "TÃ¼rkiye Ekonomisinin SektÃ¶rel DaÄŸÄ±lÄ±mÄ±"
            ],
            "AYT Tarih": [
                "Ä°lk ve Orta Ã‡aÄŸlarda TÃ¼rk DÃ¼nyasÄ±",
                "Ä°slam Medeniyetinin DoÄŸuÅŸu",
                "TÃ¼rklerin Ä°slamiyeti KabulÃ¼ ve Ä°lk TÃ¼rk Ä°slam Devletleri",
                "YerleÅŸme ve DevletleÅŸme SÃ¼recindeki SelÃ§uklu TÃ¼rkiyesi"
            ]
        }
    },
    13: {
        "week": 13,
        "focus": "Halk ve divan edebiyatÄ±",
        "topics": {
            "AYT Edebiyat": [
                "Halk EdebiyatÄ±",
                "Divan EdebiyatÄ±"
            ],
            "AYT Matematik": [
                "TÃ¼rev"
            ],
            "AYT CoÄŸrafya": [
                "TÃ¼rkiye'de TarÄ±m",
                "TÃ¼rkiye'de UlaÅŸÄ±m",
                "TÃ¼rkiye'de Ticaret ve Turizm",
                "GeÃ§miÅŸten GeleceÄŸe Åehir ve Ekonomi",
                "TÃ¼rkiye'nin Ä°ÅŸlevsel BÃ¶lgeleri ve KalkÄ±nma Projeleri",
                "Hizmet SektÃ¶rÃ¼nÃ¼n Ekonomideki Yeri"
            ],
            "AYT Tarih": [
                "Beylikten Devlete OsmanlÄ± Siyaseti",
                "DevletleÅŸme SÃ¼recindeki SavaÅŸÃ§Ä±lar ve Askerler",
                "Beylikten Devlete OsmanlÄ± Medeniyeti",
                "DÃ¼nya GÃ¼cÃ¼ OsmanlÄ±",
                "Sultan ve OsmanlÄ± ve Merkez TeÅŸkilatÄ±",
                "Klasik Ã‡aÄŸda OsmanlÄ± Toplum DÃ¼zeni"
            ],
            "TYT Geometri": [
                "Piramit",
                "Koni",
                "KÃ¼re"
            ]
        }
    },
    14: {
        "week": 14,
        "focus": "Tanzimat dÃ¶nemi ve kÃ¼resel ticaret",
        "topics": {
            "AYT Edebiyat": [
                "Tanzimat DÃ¶nemi EdebiyatÄ± (1. ve 2. KuÅŸak)",
                "Servet-i FÃ¼nun EdebiyatÄ± (Edebiyat-Ä± Cedide)",
                "Fecr-i Ati EdebiyatÄ±"
            ],
            "AYT CoÄŸrafya": [
                "KÃ¼resel Ticaret",
                "BÃ¶lgeler ve Ãœlkeler",
                "Ä°lk UygarlÄ±klar",
                "KÃ¼ltÃ¼r BÃ¶lgeleri ve TÃ¼rk KÃ¼ltÃ¼rÃ¼",
                "SanayileÅŸme SÃ¼reci: Almanya",
                "Tarih ve Ekonomi Ä°liÅŸkisi Fransa-Somali",
                "Ãœlkeler ArasÄ± EtkileÅŸim",
                "Jeopolitik Konum",
                "Ã‡atÄ±ÅŸma BÃ¶lgeleri",
                "KÃ¼resel ve BÃ¶lgesel Ã–rgÃ¼tler"
            ],
            "AYT Tarih": [
                "DeÄŸiÅŸen DÃ¼nya Dengeleri KarÅŸÄ±sÄ±nda OsmanlÄ± Siyaseti",
                "DeÄŸiÅŸim Ã‡aÄŸÄ±nda Avrupa ve OsmanlÄ±",
                "UluslararasÄ± Ä°liÅŸkilerde Denge Stratejisi",
                "Devrimler Ã‡aÄŸÄ±nda ve DeÄŸiÅŸen Devlet Toplum Ä°liÅŸkileri",
                "Sermaye ve Emek",
                "XIX. ve XX. YY DeÄŸiÅŸen GÃ¼ndelik Hayat"
            ]
        }
    },
    15: {
        "week": 15,
        "focus": "Milli edebiyat ve Ã§evre sorunlarÄ±",
        "topics": {
            "AYT Edebiyat": [
                "Milli Edebiyat"
            ],
            "AYT CoÄŸrafya": [
                "Ekstrem DoÄŸa OlaylarÄ±",
                "KÃ¼resel Ä°klim DeÄŸiÅŸimi",
                "Ã‡evre ve Toplum",
                "Ã‡evre SorunlarÄ± ve TÃ¼rleri",
                "Madenler ve Enerji KaynaklarÄ±nÄ±n Ã‡evreye Etkisi",
                "DoÄŸal KaynaklarÄ±n SÃ¼rdÃ¼rÃ¼lebilir KullanÄ±mÄ±",
                "Ekolojik Ayak Ä°zi",
                "DoÄŸal Ã‡evrenin SÄ±nÄ±rlÄ±lÄ±ÄŸÄ±",
                "Ã‡evre PolitikalarÄ±",
                "Ã‡evresel Ã–rgÃ¼tler",
                "Ã‡evre AnlaÅŸmalarÄ±",
                "DoÄŸal Afetler"
            ],
            "AYT Tarih": [
                "XX. YY BaÅŸlarÄ±nda OsmanlÄ± Devleti ve DÃ¼nya",
                "Milli MÃ¼cadele",
                "AtatÃ¼rkÃ§Ã¼lÃ¼k ve TÃ¼rk Ä°nkÄ±labÄ±"
            ]
        }
    },
    16: {
        "week": 16,
        "focus": "Cumhuriyet dÃ¶nemi ve integral",
        "topics": {
            "AYT Edebiyat": [
                "Cumhuriyet DÃ¶nemi EdebiyatÄ±",
                "Edebi AkÄ±mlar"
            ],
            "AYT Tarih": [
                "Ä°lk SavaÅŸ ArasÄ±ndaki DÃ¶nemde TÃ¼rkiye ve DÃ¼nya",
                "II. DÃ¼nya SavaÅŸÄ± SÃ¼recinde TÃ¼rkiye ve DÃ¼nya",
                "II. DÃ¼nya SavaÅŸÄ± SonrasÄ±nda TÃ¼rkiye ve DÃ¼nya",
                "Toplumsal Devrim Ã‡aÄŸÄ±nda DÃ¼nya ve TÃ¼rkiye",
                "XXI. YY EÅŸiÄŸinde TÃ¼rkiye ve DÃ¼nya"
            ],
            "AYT Matematik": [
                "Ä°ntegral",
                "OlasÄ±lÄ±k, Binom, PermÃ¼tasyon, Kombinasyon"
            ]
        }
    },
    6: {
        "week": 6,
        "focus": "Fiil konularÄ± ve Ã§arpanlara ayÄ±rma",
        "topics": {
            "TYT TÃ¼rkÃ§e": [
                "Fiilde Anlam",
                "Ek Fiil"
            ],
            "TYT Matematik": [
                "Ã‡arpanlara AyÄ±rma",
                "Problemler - Hareket Problemleri",
                "Problemler - Ä°ÅŸÃ§i Problemleri"
            ],
            "TYT Geometri": [
                "Ã–zel DÃ¶rtgenler - Deltoid",
                "Ã–zel DÃ¶rtgenler - Paralelkenar"
            ],
            "TYT CoÄŸrafya": [
                "GÃ¶Ã§",
                "YerleÅŸme",
                "TÃ¼rkiye'nin Yer Åekilleri"
            ],
            "TYT Tarih": [
                "OsmanlÄ± Devletinde ArayÄ±ÅŸ YÄ±llarÄ±",
                "OsmanlÄ± Avrupa Ä°liÅŸkileri",
                "18. YY DeÄŸiÅŸim ve Diplomasi",
                "En Uzun YÃ¼zyÄ±l",
                "OsmanlÄ± KÃ¼ltÃ¼r ve Medeniyeti"
            ],
            "TYT Felsefe": [
                "Din Felsefesi",
                "Siyaset Felsefesi"
            ],
            "TYT Din KÃ¼ltÃ¼rÃ¼": [
                "Dinler Tarihi",
                "Ä°slam Tarihi"
            ]
        }
    },
    7: {
        "week": 7,
        "focus": "Fiilimsi ve AYT baÅŸlangÄ±Ã§",
        "topics": {
            "TYT TÃ¼rkÃ§e": [
                "Fiilimsi",
                "Fiilde Ã‡atÄ±"
            ],
            "AYT Matematik": [
                "Fonksiyonlar",
                "Problemler - Tablo-Grafik Problemleri",
                "Problemler - Rutin Olmayan Problemler"
            ],
            "TYT Geometri": [
                "EÅŸkenar DÃ¶rtgen",
                "DikdÃ¶rtgen"
            ],
            "TYT CoÄŸrafya": [
                "Ekonomik Faaliyetler",
                "BÃ¶lgeler, UluslararasÄ± UlaÅŸÄ±m HatlarÄ±, Ã‡evre ve Toplum",
                "DoÄŸal Afetler"
            ],
            "TYT Tarih": [
                "20. YY OsmanlÄ± Devleti",
                "1. DÃ¼nya SavaÅŸÄ±"
            ]
        }
    },
    8: {
        "week": 8,
        "focus": "CÃ¼mle bilgisi ve mantÄ±k",
        "topics": {
            "TYT TÃ¼rkÃ§e": [
                "CÃ¼mlenin Ã–ÄŸeleri",
                "CÃ¼mle TÃ¼rleri",
                "AnlatÄ±m BozukluÄŸu"
            ],
            "TYT Matematik": [
                "MantÄ±k",
                "KÃ¼meler"
            ],
            "AYT Matematik": [
                "Polinom"
            ],
            "TYT Geometri": [
                "Kare",
                "Yamuk"
            ],
            "TYT Tarih": [
                "Mondros AteÅŸkesi, Ä°ÅŸgaller ve Cemiyetler",
                "KurtuluÅŸ SavaÅŸÄ±na HazÄ±rlÄ±k DÃ¶nemi",
                "1. TBMM DÃ¶nemi",
                "KurtuluÅŸ SavaÅŸÄ± ve AnlaÅŸmalar"
            ]
        }
    },
    9: {
        "week": 9,
        "focus": "OlasÄ±lÄ±k ve 2. derece denklemler",
        "topics": {
            "TYT Matematik": [
                "OlasÄ±lÄ±k"
            ],
            "AYT Matematik": [
                "2. Derece Denklemler"
            ],
            "TYT Geometri": [
                "Ã‡emberde AÃ§Ä±",
                "Ã‡emberde Uzunluk"
            ],
            "TYT Tarih": [
                "II. TBMM DÃ¶nemi ve Ã‡ok Partili Hayata GeÃ§iÅŸ",
                "TÃ¼rk Ä°nkÄ±labÄ±"
            ],
            "AYT Edebiyat": [
                "GÃ¼zel Sanatlar ve Edebiyat ile Ä°liÅŸkisi",
                "Metinlerin SÄ±nÄ±flandÄ±rÄ±lmasÄ±"
            ],
            "AYT CoÄŸrafya": [
                "Ekosistem"
            ]
        }
    },
    10: {
        "week": 10,
        "focus": "Edebiyat sanatlarÄ± ve karmaÅŸÄ±k sayÄ±lar",
        "topics": {
            "AYT Edebiyat": [
                "Edebi Sanatlar",
                "Edebiyat AkÄ±mlarÄ±"
            ],
            "AYT CoÄŸrafya": [
                "BiyoÃ§eÅŸitlilik",
                "Biyomlar",
                "Ekosistem UnsurlarÄ±"
            ],
            "AYT Matematik": [
                "KarmaÅŸÄ±k SayÄ±lar",
                "2. Derece Denklem ve EÅŸitsizlikler"
            ],
            "TYT Tarih": [
                "AtatÃ¼rk Ä°lkeleri",
                "AtatÃ¼rk DÃ¶nemi TÃ¼rk DÄ±ÅŸ PolitikasÄ±"
            ],
            "TYT Geometri": [
                "Dairede Ã‡evre ve Alan",
                "NoktanÄ±n AnalitiÄŸi"
            ]
        }
    },
    11: {
        "week": 11,
        "focus": "DÃ¼nya edebiyatÄ± ve logaritma",
        "topics": {
            "AYT Edebiyat": [
                "DÃ¼nya EdebiyatÄ±",
                "Anlam Bilgisi (Tekrar)",
                "Dil Bilgisi (Tekrar)",
                "Åiir Bilgisi"
            ],
            "AYT Matematik": [
                "Parabol",
                "Logaritma"
            ],
            "TYT Geometri": [
                "DoÄŸrunun AnalitiÄŸi",
                "Prizmalar"
            ],
            "AYT CoÄŸrafya": [
                "Enerji AkÄ±ÅŸÄ± ve Madde DÃ¶ngÃ¼sÃ¼",
                "NÃ¼fus PolitikalarÄ±",
                "TÃ¼rkiye'de NÃ¼fus ve YerleÅŸme",
                "GÃ¶Ã§ ve ÅehirleÅŸme"
            ],
            "AYT Tarih": [
                "Tarih ve Zaman (Temel Kavramlar)",
                "Ä°nsanlÄ±ÄŸÄ±n Ä°lk DÃ¶nemleri",
                "OrtaÃ§aÄŸda DÃ¼nya"
            ]
        }
    },
    12: {
        "week": 12,
        "focus": "TÃ¼rk edebiyatÄ± dÃ¶nemleri ve diziler",
        "topics": {
            "AYT Edebiyat": [
                "TÃ¼rk EdebiyatÄ± DÃ¶nemleri (Genel Ã–zellikler)",
                "Ä°slamiyet Ã–ncesi TÃ¼rk EdebiyatÄ± (SÃ¶zlÃ¼ ve YazÄ±lÄ±)",
                "Ä°slamiyet Etkisindeki GeÃ§iÅŸ DÃ¶nemi EdebiyatÄ±"
            ],
            "AYT Matematik": [
                "Diziler",
                "Limit"
            ],
            "TYT Geometri": [
                "KÃ¼p",
                "Silindir"
            ],
            "AYT CoÄŸrafya": [
                "Ekonomik Faaliyetler ve DoÄŸal Kaynaklar",
                "TÃ¼rkiye Ekonomisi",
                "TÃ¼rkiye'nin Ekonomik PolitikalarÄ±",
                "TÃ¼rkiye Ekonomisinin SektÃ¶rel DaÄŸÄ±lÄ±mÄ±"
            ],
            "AYT Tarih": [
                "Ä°lk ve Orta Ã‡aÄŸlarda TÃ¼rk DÃ¼nyasÄ±",
                "Ä°slam Medeniyetinin DoÄŸuÅŸu",
                "TÃ¼rklerin Ä°slamiyeti KabulÃ¼ ve Ä°lk TÃ¼rk Ä°slam Devletleri",
                "YerleÅŸme ve DevletleÅŸme SÃ¼recindeki SelÃ§uklu TÃ¼rkiyesi"
            ]
        }
    },
    13: {
        "week": 13,
        "focus": "Halk ve divan edebiyatÄ±, tÃ¼rev",
        "topics": {
            "AYT Edebiyat": [
                "Halk EdebiyatÄ±",
                "Divan EdebiyatÄ±"
            ],
            "AYT Matematik": [
                "TÃ¼rev"
            ],
            "AYT CoÄŸrafya": [
                "TÃ¼rkiye'de TarÄ±m",
                "TÃ¼rkiye'de UlaÅŸÄ±m",
                "TÃ¼rkiye'de Ticaret ve Turizm",
                "GeÃ§miÅŸten GeleceÄŸe Åehir ve Ekonomi",
                "TÃ¼rkiye'nin Ä°ÅŸlevsel BÃ¶lgeleri ve KalkÄ±nma Projeleri",
                "Hizmet SektÃ¶rÃ¼nÃ¼n Ekonomideki Yeri"
            ],
            "AYT Tarih": [
                "Beylikten Devlete OsmanlÄ± Siyaseti",
                "DevletleÅŸme SÃ¼recindeki SavaÅŸÃ§Ä±lar ve Askerler",
                "Beylikten Devlete OsmanlÄ± Medeniyeti", 
                "DÃ¼nya GÃ¼cÃ¼ OsmanlÄ±",
                "Sultan ve OsmanlÄ± ve Merkez TeÅŸkilatÄ±",
                "Klasik Ã‡aÄŸda OsmanlÄ± Toplum DÃ¼zeni"
            ],
            "TYT Geometri": [
                "Piramit",
                "Koni",
                "KÃ¼re"
            ]
        }
    },
    14: {
        "week": 14,
        "focus": "Tanzimat dÃ¶nemi ve kÃ¼resel coÄŸrafya",
        "topics": {
            "AYT Edebiyat": [
                "Tanzimat DÃ¶nemi EdebiyatÄ± (1. ve 2. KuÅŸak)",
                "Servet-i FÃ¼nun EdebiyatÄ± (Edebiyat-Ä± Cedide)",
                "Fecr-i Ati EdebiyatÄ±"
            ],
            "AYT CoÄŸrafya": [
                "KÃ¼resel Ticaret",
                "BÃ¶lgeler ve Ãœlkeler",
                "Ä°lk UygarlÄ±klar",
                "KÃ¼ltÃ¼r BÃ¶lgeleri ve TÃ¼rk KÃ¼ltÃ¼rÃ¼",
                "SanayileÅŸme SÃ¼reci: Almanya",
                "Tarih ve Ekonomi Ä°liÅŸkisi Fransa-Somali",
                "Ãœlkeler ArasÄ± EtkileÅŸim",
                "Jeopolitik Konum",
                "Ã‡atÄ±ÅŸma BÃ¶lgeleri",
                "KÃ¼resel ve BÃ¶lgesel Ã–rgÃ¼tler"
            ],
            "AYT Tarih": [
                "DeÄŸiÅŸen DÃ¼nya Dengeleri KarÅŸÄ±sÄ±nda OsmanlÄ± Siyaseti",
                "DeÄŸiÅŸim Ã‡aÄŸÄ±nda Avrupa ve OsmanlÄ±",
                "UluslararasÄ± Ä°liÅŸkilerde Denge Stratejisi",
                "Devrimler Ã‡aÄŸÄ±nda ve DeÄŸiÅŸen Devlet Toplum Ä°liÅŸkileri",
                "Sermaye ve Emek",
                "XIX. ve XX. YY DeÄŸiÅŸen GÃ¼ndelik Hayat"
            ]
        }
    },
    15: {
        "week": 15,
        "focus": "Milli edebiyat ve Ã§evre konularÄ±",
        "topics": {
            "AYT Edebiyat": [
                "Milli Edebiyat"
            ],
            "AYT CoÄŸrafya": [
                "Ekstrem DoÄŸa OlaylarÄ±",
                "KÃ¼resel Ä°klim DeÄŸiÅŸimi",
                "Ã‡evre ve Toplum",
                "Ã‡evre SorunlarÄ± ve TÃ¼rleri",
                "Madenler ve Enerji KaynaklarÄ±nÄ±n Ã‡evreye Etkisi",
                "DoÄŸal KaynaklarÄ±n SÃ¼rdÃ¼rÃ¼lebilir KullanÄ±mÄ±",
                "Ekolojik Ayak Ä°zi",
                "DoÄŸal Ã‡evrenin SÄ±nÄ±rlÄ±lÄ±ÄŸÄ±",
                "Ã‡evre PolitikalarÄ±",
                "Ã‡evresel Ã–rgÃ¼tler",
                "Ã‡evre AnlaÅŸmalarÄ±",
                "DoÄŸal Afetler"
            ],
            "AYT Tarih": [
                "XX. YY BaÅŸlarÄ±nda OsmanlÄ± Devleti ve DÃ¼nya",
                "Milli MÃ¼cadele",
                "AtatÃ¼rkÃ§Ã¼lÃ¼k ve TÃ¼rk Ä°nkÄ±labÄ±"
            ]
        }
    },
    16: {
        "week": 16,
        "focus": "Cumhuriyet dÃ¶nemi ve integral",
        "topics": {
            "AYT Edebiyat": [
                "Cumhuriyet DÃ¶nemi EdebiyatÄ±",
                "Edebi AkÄ±mlar"
            ],
            "AYT Tarih": [
                "Ä°lk SavaÅŸ ArasÄ±ndaki DÃ¶nemde TÃ¼rkiye ve DÃ¼nya",
                "II. DÃ¼nya SavaÅŸÄ± SÃ¼recinde TÃ¼rkiye ve DÃ¼nya",
                "II. DÃ¼nya SavaÅŸÄ± SonrasÄ±nda TÃ¼rkiye ve DÃ¼nya",
                "Toplumsal Devrim Ã‡aÄŸÄ±nda DÃ¼nya ve TÃ¼rkiye",
                "XXI. YY EÅŸiÄŸinde TÃ¼rkiye ve DÃ¼nya"
            ],
            "AYT Matematik": [
                "Ä°ntegral",
                "OlasÄ±lÄ±k, Binom, PermÃ¼tasyon, Kombinasyon"
            ]
        }
    }
}

# ğŸ“š 18 HaftalÄ±k SayÄ±sal Detay PlanÄ±
NUMERICAL_WEEKLY_PLAN = {
    1: {
        "week": 1,
        "focus": "Temel kavramlar ve baÅŸlangÄ±Ã§",
        "topics": {
            "TYT TÃ¼rkÃ§e": [
                "SÃ¶zcÃ¼kte Anlam",
                "CÃ¼mlede Anlam", 
                "Paragraf"
            ],
            "TYT Matematik": [
                "Temel Kavramlar",
                "SayÄ±lar"
            ],
            "TYT Geometri": [
                "AÃ§Ä±lar - DoÄŸruda AÃ§Ä±lar",
                "AÃ§Ä±lar - ÃœÃ§gende AÃ§Ä±lar"
            ],
            "TYT Fizik": [
                "Fizik Bilimine GiriÅŸ"
            ],
            "TYT Kimya": [
                "Kimya Bilimine GiriÅŸ",
                "Atom ve Periyodik Sistem"
            ]
        }
    },
    2: {
        "week": 2,
        "focus": "Ses bilgisi ve temel matemtik",
        "topics": {
            "TYT TÃ¼rkÃ§e": [
                "Ses Bilgisi"
            ],
            "TYT Matematik": [
                "BÃ¶lme ve BÃ¶lÃ¼nebilme",
                "EBOB-EKOK",
                "Rasyonel SayÄ±lar"
            ],
            "TYT Geometri": [
                "Ã–zel ÃœÃ§genler - Dik ÃœÃ§gen",
                "Ã–zel ÃœÃ§genler - EÅŸkenar ÃœÃ§gen",
                "Ã–zel ÃœÃ§genler - Ä°kizkenar ÃœÃ§gen"
            ],
            "TYT Kimya": [
                "Kimyasal TÃ¼rler ArasÄ± EtkileÅŸimler"
            ],
            "TYT Fizik": [
                "Madde ve Ã–zellikleri"
            ],
            "TYT Biyoloji": [
                "CanlÄ±larÄ±n Ortak Ã–zellikleri"
            ]
        }
    },
    3: {
        "week": 3,
        "focus": "YazÄ±m kurallarÄ± ve oranlar",
        "topics": {
            "TYT TÃ¼rkÃ§e": [
                "YazÄ±m KurallarÄ±"
            ],
            "TYT Matematik": [
                "OndalÄ±klÄ± SayÄ±lar",
                "Oran OrantÄ±",
                "Denklem Ã‡Ã¶zme",
                "Problemler - SayÄ± Problemleri",
                "Problemler - Kesir Problemleri"
            ],
            "TYT Geometri": [
                "AÃ§Ä±ortay",
                "Kenarortay"
            ],
            "TYT Fizik": [
                "Hareket ve Kuvvet"
            ],
            "TYT Kimya": [
                "Maddenin Halleri ve Ã‡evre KimyasÄ±"
            ],
            "TYT Biyoloji": [
                "CanlÄ±larÄ±n YapÄ±sÄ±nda Bulunan Ä°norganik BileÅŸikler",
                "CanlÄ±larÄ±n YapÄ±sÄ±nda Bulunan Organik BileÅŸikler"
            ]
        }
    },
    4: {
        "week": 4,
        "focus": "Noktalama ve eÅŸitsizlikler",
        "topics": {
            "TYT TÃ¼rkÃ§e": [
                "Noktalama Ä°ÅŸaretleri",
                "SÃ¶zcÃ¼kte YapÄ±"
            ],
            "TYT Matematik": [
                "Basit EÅŸitsizlikler",
                "Mutlak DeÄŸer",
                "Problemler - YaÅŸ Problemleri",
                "Problemler - YÃ¼zde Problemleri",
                "Problemler - Kar-Zarar Problemleri"
            ],
            "TYT Geometri": [
                "EÅŸlik ve Benzerlik",
                "ÃœÃ§gende Alan"
            ],
            "TYT Fizik": [
                "Ä°ÅŸ GÃ¼Ã§ ve Enerji"
            ],
            "TYT Kimya": [
                "KimyanÄ±n Temel KanunlarÄ± ve Hesaplamalar"
            ],
            "TYT Biyoloji": [
                "HÃ¼cresel YapÄ±lar ve GÃ¶revleri",
                "HÃ¼cre ZarÄ±ndan Madde GeÃ§iÅŸleri"
            ]
        }
    },
    5: {
        "week": 5,
        "focus": "SÃ¶zcÃ¼k tÃ¼rleri ve Ã¼slÃ¼ sayÄ±lar",
        "topics": {
            "TYT TÃ¼rkÃ§e": [
                "SÃ¶zcÃ¼k TÃ¼rleri - Ä°simler",
                "SÃ¶zcÃ¼k TÃ¼rleri - Zamirler",
                "SÃ¶zcÃ¼k TÃ¼rleri - SÄ±fatlar",
                "SÃ¶zcÃ¼k TÃ¼rleri - Zarf",
                "SÃ¶zcÃ¼k TÃ¼rleri - Edat"
            ],
            "TYT Matematik": [
                "ÃœslÃ¼ SayÄ±lar",
                "KÃ¶klÃ¼ SayÄ±lar",
                "Problemler - KarÄ±ÅŸÄ±m Problemleri"
            ],
            "TYT Geometri": [
                "AÃ§Ä± Kenar BaÄŸÄ±ntÄ±larÄ±",
                "Ã‡okgenler"
            ],
            "TYT Fizik": [
                "IsÄ± ve SÄ±caklÄ±k"
            ],
            "TYT Kimya": [
                "KarÄ±ÅŸÄ±mlar"
            ],
            "TYT Biyoloji": [
                "CanlÄ±larÄ±n SÄ±nÄ±flandÄ±rÄ±lmasÄ±",
                "CanlÄ± Ã‚lemleri"
            ]
        }
    },
    6: {
        "week": 6,
        "focus": "Fiilde anlam ve Ã§arpanlara ayÄ±rma",
        "topics": {
            "TYT TÃ¼rkÃ§e": [
                "Fiilde Anlam",
                "Ek Fiil"
            ],
            "TYT Matematik": [
                "Ã‡arpanlara AyÄ±rma",
                "Problemler - Hareket Problemleri",
                "Problemler - Ä°ÅŸÃ§i Problemleri"
            ],
            "TYT Geometri": [
                "Ã–zel DÃ¶rtgenler - Deltoid",
                "Ã–zel DÃ¶rtgenler - Paralelkenar"
            ],
            "TYT Fizik": [
                "BasÄ±nÃ§ ve KaldÄ±rma Kuvveti"
            ],
            "TYT Kimya": [
                "Asitler Bazlar ve Tuzlar"
            ],
            "TYT Biyoloji": [
                "HÃ¼cre DÃ¶ngÃ¼sÃ¼ ve Mitoz",
                "EÅŸeysiz Ãœreme"
            ]
        }
    },
    7: {
        "week": 7,
        "focus": "Fiilimsi ve AYT baÅŸlangÄ±Ã§",
        "topics": {
            "TYT TÃ¼rkÃ§e": [
                "Fiilimsi",
                "Fiilde Ã‡atÄ±"
            ],
            "AYT Matematik": [
                "Fonksiyonlar",
                "Problemler - Tablo-Grafik Problemleri",
                "Problemler - Rutin Olmayan Problemler"
            ],
            "TYT Geometri": [
                "EÅŸkenar DÃ¶rtgen",
                "Diktortgen"
            ],
            "TYT Fizik": [
                "Dalgalar",
                "Optik"
            ],
            "TYT Kimya": [
                "Kimya Her Yerde"
            ],
            "TYT Biyoloji": [
                "Mayoz",
                "EÅŸeyli Ãœreme"
            ]
        }
    },
    8: {
        "week": 8,
        "focus": "CÃ¼mle Ã¶ÄŸeleri ve mantÄ±k",
        "topics": {
            "TYT TÃ¼rkÃ§e": [
                "CÃ¼mlenin Ã–ÄŸeleri",
                "CÃ¼mle TÃ¼rleri",
                "AnlatÄ±m BozukluÄŸu"
            ],
            "TYT Matematik": [
                "MantÄ±k",
                "KÃ¼meler"
            ],
            "AYT Matematik": [
                "Polinom"
            ],
            "TYT Geometri": [
                "Kare",
                "Yamuk"
            ],
            "TYT Fizik": [
                "Elektrik ve Manyetizma"
            ],
            "TYT Biyoloji": [
                "KalÄ±tÄ±m Konusu",
                "Genetik Varyasyonlar"
            ]
        }
    },
    9: {
        "week": 9,
        "focus": "OlasÄ±lÄ±k ve AYT baÅŸlangÄ±Ã§",
        "topics": {
            "TYT Matematik": [
                "OlasÄ±lÄ±k"
            ],
            "AYT Matematik": [
                "2. Derece Denklemler"
            ],
            "TYT Geometri": [
                "Ã‡emberde AÃ§Ä±",
                "Ã‡emberde Uzunluk"
            ],
            "AYT Kimya": [
                "Modern Atom Teorisi"
            ],
            "AYT Fizik": [
                "Kuvvet ve Hareket - VektÃ¶rler",
                "Kuvvet ve Hareket - BaÄŸÄ±l",
                "Kuvvet ve Hareket - Newton YasalarÄ±",
                "Ä°ÅŸ - GÃ¼Ã§ - Enerji - Korunum",
                "Ä°ÅŸ - GÃ¼Ã§ - Enerji - Verim",
                "AtÄ±ÅŸlar - Yatay",
                "AtÄ±ÅŸlar - EÄŸik",
                "AtÄ±ÅŸlar - DÃ¼ÅŸey"
            ],
            "TYT Biyoloji": [
                "Ekosistem Ekolojisi",
                "GÃ¼ncel Ã‡evre SorunlarÄ±",
                "DoÄŸal KaynaklarÄ±n SÃ¼rdÃ¼rÃ¼lebilirliÄŸi",
                "Biyolojik Ã‡eÅŸitliliÄŸin KorunmasÄ±"
            ]
        }
    },
    10: {
        "week": 10,
        "focus": "KarmaÅŸÄ±k sayÄ±lar ve AYT yoÄŸunlaÅŸma",
        "topics": {
            "AYT Matematik": [
                "KarmaÅŸÄ±k SayÄ±lar",
                "2. Derece Denklem ve EÅŸitsizlikler"
            ],
            "TYT Geometri": [
                "Dairede Ã‡evre ve Alan",
                "NoktanÄ±n AnalitiÄŸi"
            ],
            "AYT Fizik": [
                "Basit Makineler",
                "KÃ¼tle Merkezi - Tork - Denge"
            ],
            "AYT Kimya": [
                "Gazlar"
            ],
            "AYT Biyoloji": [
                "Sinir Sistemi",
                "Endokrin Sistem ve Hormonlar"
            ]
        }
    },
    11: {
        "week": 11,
        "focus": "Parabol ve logaritma",
        "topics": {
            "AYT Matematik": [
                "Parabol",
                "Logaritma"
            ],
            "TYT Geometri": [
                "DoÄŸrunun AnalitiÄŸi",
                "Prizmalar"
            ],
            "AYT Kimya": [
                "SÄ±vÄ± Ã‡Ã¶zeltiler ve Ã‡Ã¶zÃ¼nÃ¼rlÃ¼k"
            ],
            "AYT Fizik": [
                "Elektrostatik - Alan",
                "Elektrostatik - Potansiyel",
                "Elektrik ve Manyetizma - AkÄ±m",
                "Elektrik ve Manyetizma - DirenÃ§",
                "Elektrik ve Manyetizma - Manyetik Alan",
                "Elektrik ve Manyetizma - Kuvvet",
                "Elektrik ve Manyetizma - Ä°ndÃ¼ksiyon"
            ],
            "AYT Biyoloji": [
                "Duyu OrganlarÄ±",
                "Destek ve Hareket Sistemi"
            ]
        }
    },
    12: {
        "week": 12,
        "focus": "Diziler ve limit",
        "topics": {
            "AYT Matematik": [
                "Diziler",
                "Limit"
            ],
            "TYT Geometri": [
                "KÃ¼p",
                "Silindir"
            ],
            "AYT Fizik": [
                "Madde ve Ã–zellikleri - KatÄ±",
                "Madde ve Ã–zellikleri - SÄ±vÄ±",
                "Madde ve Ã–zellikleri - Gaz",
                "BasÄ±nÃ§ - KaldÄ±rma Kuvveti",
                "IsÄ± - SÄ±caklÄ±k - GenleÅŸme",
                "Termodinamik YasalarÄ± Temelleri"
            ],
            "AYT Kimya": [
                "Kimyasal Tepkimelerde Enerji",
                "Kimyasal Tepkimelerde HÄ±z"
            ],
            "AYT Biyoloji": [
                "Sindirim Sistemi",
                "DolaÅŸÄ±m ve BaÄŸÄ±ÅŸÄ±klÄ±k Sistemi"
            ]
        }
    },
    13: {
        "week": 13,
        "focus": "TÃ¼rev ve dalga optiÄŸi",
        "topics": {
            "AYT Matematik": [
                "TÃ¼rev"
            ],
            "TYT Geometri": [
                "Piramit",
                "Koni",
                "KÃ¼re"
            ],
            "AYT Fizik": [
                "Dalgalar - Yay",
                "Dalgalar - Su",
                "Dalgalar - Ses",
                "Dalgalar - Deprem",
                "Optik - YansÄ±ma",
                "Optik - KÄ±rÄ±lma",
                "Optik - Ayna",
                "Optik - Mercek"
            ],
            "AYT Kimya": [
                "Kimyasal Tepkimelerde Denge"
            ],
            "AYT Biyoloji": [
                "Solunum Sistemi",
                "Ãœriner Sistem - BoÅŸaltÄ±m Sistemi"
            ]
        }
    },
    14: {
        "week": 14,
        "focus": "Ã‡embersel hareket ve elektrik",
        "topics": {
            "AYT Fizik": [
                "DÃ¼zgÃ¼n Ã‡embersel Hareket",
                "Basit Harmonik Hareket"
            ],
            "AYT Kimya": [
                "Kimya ve Elektrik"
            ]
        }
    },
    15: {
        "week": 15,
        "focus": "Ä°ntegral ve organik kimya",
        "topics": {
            "AYT Matematik": [
                "Ä°ntegral"
            ],
            "AYT Kimya": [
                "Organik Kimya"
            ],
            "AYT Fizik": [
                "Modern Fizik ve UygulamalarÄ±",
                "Fizik Bilimine GiriÅŸ - Temeller",
                "Atom FiziÄŸine GiriÅŸ ve Radyoaktivite",
                "Modern Fizik - Ã–zel GÃ¶relilik",
                "Modern Fizik - Kuantum",
                "Modern Fizik - Fotoelektrik Olay"
            ],
            "AYT Biyoloji": [
                "Ãœreme Sistemi ve Embriyonik GeliÅŸim",
                "NÃ¼kleik Asitler",
                "Genden Proteine"
            ]
        }
    },
    16: {
        "week": 16,
        "focus": "Protein sentezi ve enerji",
        "topics": {
            "AYT Biyoloji": [
                "Genetik Åifre ve Protein Sentezi",
                "CanlÄ±lÄ±k ve Enerji",
                "CanlÄ±larda Enerji DÃ¶nÃ¼ÅŸÃ¼mleri - ATP",
                "CanlÄ±larda Enerji DÃ¶nÃ¼ÅŸÃ¼mleri - Enzim"
            ]
        }
    },
    17: {
        "week": 17,
        "focus": "OlasÄ±lÄ±k ve fotosentez",
        "topics": {
            "AYT Matematik": [
                "OlasÄ±lÄ±k",
                "Binom",
                "PermÃ¼tasyon",
                "Kombinasyon"
            ],
            "AYT Biyoloji": [
                "Fotosentez",
                "Kemosentez",
                "HÃ¼cresel Solunum"
            ]
        }
    },
    18: {
        "week": 18,
        "focus": "Bitki biyolojisi ve ekoloji",
        "topics": {
            "AYT Biyoloji": [
                "Bitki Biyolojisi - YapÄ±",
                "Bitki Biyolojisi - TaÅŸÄ±ma",
                "Bitki Biyolojisi - Beslenme",
                "Bitkisel Hormonlar ve Hareketler",
                "Ekoloji ve Ã‡evre"
            ]
        }
    }
}

# ğŸ¨ TYT & MSÃœ HAFTALIK PLAN - 9 HAFTALIK DETAY PLAN

TYT_MSU_WEEKLY_PLAN = {
    1: {
        "week": 1,
        "focus": "Temel kavramlar ve giriÅŸ konularÄ±",
        "topics": {
            "TYT TÃ¼rkÃ§e": [
                "SÃ¶zcÃ¼kte anlam",
                "CÃ¼mlede anlam",
                "Paragraf"
            ],
            "TYT Matematik": [
                "Temel kavramlar, sayÄ±lar"
            ],
            "TYT Geometri": [
                "AÃ§Ä±lar - DoÄŸruda aÃ§Ä±lar",
                "AÃ§Ä±lar - ÃœÃ§gende aÃ§Ä±lar"
            ],
            "TYT Fizik": [
                "Fizik bilimine giriÅŸ"
            ],
            "TYT Kimya": [
                "Kimya bilimine giriÅŸ"
            ],
            "TYT Biyoloji": [
                "CanlÄ±larÄ±n Ortak Ã–zellikleri"
            ],
            "TYT CoÄŸrafya": [
                "DÃ¼nya haritalÄ±rÄ±-1"
            ]
        }
    },
    2: {
        "week": 2,
        "focus": "Temel matematik ve bilim konularÄ±",
        "topics": {
            "TYT TÃ¼rkÃ§e": [
                "Ses Bilgisi"
            ],
            "TYT Matematik": [
                "BÃ¶lme ve BÃ¶lÃ¼nebilme",
                "EBOB-EKOK",
                "Rasyonel SayÄ±lar"
            ],
            "TYT Geometri": [
                "Dik Ã¼Ã§gen",
                "EÅŸkenar Ã¼Ã§gen",
                "Ä°kizkenar Ã¼Ã§gen"
            ],
            "TYT CoÄŸrafya": [
                "DoÄŸa ve insan"
            ],
            "TYT Tarih": [
                "Ä°nsanlÄ±ÄŸÄ±n ilk dÃ¶nemleri",
                "OrtaÃ§aÄŸda dÃ¼nya"
            ],
            "TYT Biyoloji": [
                "CanlÄ±larÄ±n YapÄ±sÄ±nda Bulunan Ä°norganik BileÅŸikler",
                "CanlÄ±larÄ±n YapÄ±sÄ±nda Bulunan Organik BileÅŸikler"
            ],
            "TYT Kimya": [
                "Atom ve periyodik sistem"
            ],
            "TYT Fizik": [
                "Madde ve Ã¶zellikleri"
            ]
        }
    },
    3: {
        "week": 3,
        "focus": "YazÄ±m kurallarÄ± ve matematik problemleri",
        "topics": {
            "TYT TÃ¼rkÃ§e": [
                "YazÄ±m KurallarÄ±"
            ],
            "TYT Matematik": [
                "OndalÄ±klÄ± SayÄ±lar",
                "Oran Oranti",
                "Denklem Ã§Ã¶zme",
                "SayÄ± Problemleri",
                "Kesir Problemleri"
            ],
            "TYT Geometri": [
                "AÃ§Ä±ortay",
                "Kenarortay"
            ],
            "TYT CoÄŸrafya": [
                "DÃ¼nyanÄ±n ÅŸekli ve hareketleri",
                "Ã‡oÄŸrafi konum"
            ],
            "TYT Tarih": [
                "ilk ve orta Ã§aÄŸlarda tÃ¼rk dÃ¼nyasÄ±",
                "Ä°slam medeniyetinin doÄŸuÅŸu"
            ],
            "TYT Fizik": [
                "Hareket ve Kuvvet"
            ],
            "TYT Kimya": [
                "Kimyasal tÃ¼rler arasÄ± etkileÅŸimler"
            ],
            "TYT Biyoloji": [
                "HÃ¼cresel YapÄ±lar ve GÃ¶revleri",
                "HÃ¼cre ZarÄ±ndan Madde GeÃ§iÅŸleri"
            ]
        }
    },
    4: {
        "week": 4,
        "focus": "Noktalama iÅŸaretleri ve matematik problemleri",
        "topics": {
            "TYT TÃ¼rkÃ§e": [
                "Noktalama Ä°ÅŸaretleri"
            ],
            "TYT Matematik": [
                "Basit eÅŸitsizlikler",
                "Mutlak DeÄŸer",
                "YaÅŸ problemleri",
                "YÃ¼zde problemleri",
                "Kar-zarar problemleri"
            ],
            "TYT Geometri": [
                "EÅŸlik ve benzerlik"
            ],
            "TYT Fizik": [
                "Ä°ÅŸ gÃ¼Ã§ ve enerji"
            ],
            "TYT Biyoloji": [
                "CanlÄ±larÄ±n SÄ±nÄ±flandÄ±rÄ±lmasÄ±",
                "CanlÄ± Ã‚lemleri"
            ],
            "TYT Tarih": [
                "ilk tÃ¼rk Ä°slam devletleri",
                "YerleÅŸme ve devletleÅŸme sÃ¼recinde SelÃ§uklu TÃ¼rkiyesi",
                "Beylikten devlete OsmanlÄ± Siyaseti(1300-1453)"
            ],
            "TYT CoÄŸrafya": [
                "Harita bilgisi",
                "Atmosfer ve sÄ±caklÄ±k"
            ]
        }
    },
    5: {
        "week": 5,
        "focus": "SÃ¶zcÃ¼k yapÄ±sÄ± ve Ã¼slÃ¼ sayÄ±lar",
        "topics": {
            "TYT TÃ¼rkÃ§e": [
                "SÃ¶zcÃ¼kte YapÄ±",
                "SÃ¶zcÃ¼k TÃ¼rleri"
            ],
            "TYT Matematik": [
                "ÃœslÃ¼ sayÄ±lar",
                "KÃ¶klÃ¼ SayÄ±lar",
                "KarÄ±ÅŸÄ±m Problemleri"
            ],
            "TYT Geometri": [
                "ÃœÃ§gende alan"
            ],
            "TYT Tarih": [
                "DÃ¼nya gÃ¼cÃ¼ OsmanlÄ± (1453-1600)",
                "Yeni Ã‡aÄŸ Avrupa Tarihi"
            ],
            "TYT CoÄŸrafya": [
                "iklim",
                "basÄ±nÃ§ ve rÃ¼zgarlar"
            ],
            "TYT Fizik": [
                "Ä±sÄ± ve sÄ±caklÄ±k"
            ],
            "TYT Kimya": [
                "maddenin halleri"
            ],
            "TYT Biyoloji": [
                "HÃ¼cre DÃ¶ngÃ¼sÃ¼ ve Mitoz",
                "EÅŸeysiz Ãœreme"
            ]
        }
    },
    6: {
        "week": 6,
        "focus": "Fiilimsi ve Ã§arpanlara ayÄ±rma",
        "topics": {
            "TYT TÃ¼rkÃ§e": [
                "Fiilimsi",
                "Fiilde Ã‡ati"
            ],
            "TYT Matematik": [
                "Ã‡arpanlara AyÄ±rma",
                "Hareket Problemleri",
                "Ä°ÅŸÃ§i problemleri"
            ],
            "TYT Geometri": [
                "AÃ§Ä± kenar baÄŸlantÄ±larÄ±",
                "Ã‡okgenler"
            ],
            "TYT Tarih": [
                "OsmanlÄ± devletine arayÄ±ÅŸ yÄ±llarÄ±",
                "OsmanlÄ± Avrupa iliÅŸkileri",
                "18.YY deÄŸiÅŸim ve diplomasi",
                "En uzun yÃ¼zyÄ±l",
                "OsmanlÄ± kÃ¼ltÃ¼r ve medeniyeti"
            ],
            "TYT CoÄŸrafya": [
                "Nem yaÄŸÄ±ÅŸ ve BuharlaÅŸma",
                "Ä°Ã§ kuvvetler/dÄ±ÅŸ kuvvetler",
                "Su-Toprak ve Bitkiler"
            ],
            "TYT Fizik": [
                "BasÄ±nÃ§ ve KaldÄ±rma Kuvveti"
            ],
            "TYT Kimya": [
                "KimyanÄ±n Temel KanunlarÄ± ve Hesaplamalar"
            ],
            "TYT Biyoloji": [
                "Mayoz",
                "EÅŸeyli Ãœreme"
            ]
        }
    },
    7: {
        "week": 7,
        "focus": "CÃ¼mle analizi ve grafik problemleri",
        "topics": {
            "TYT TÃ¼rkÃ§e": [
                "CÃ¼mlenin Ã¶ÄŸeleri",
                "CÃ¼mle tÃ¼rleri"
            ],
            "TYT Matematik": [
                "Tablo-Grafik problemleri",
                "Rutin olmayan problemler"
            ],
            "TYT Geometri": [
                "Ã–zel dÃ¶rtgenler",
                "Deltoid",
                "Paralelkenar"
            ],
            "TYT Tarih": [
                "20.YY OsmanlÄ± devleti",
                "1.DÃ¼nya savaÅŸÄ±"
            ],
            "TYT CoÄŸrafya": [
                "NÃ¼fus",
                "Ekonomik faaliyetler"
            ],
            "TYT Fizik": [
                "Dalgalar",
                "Optik"
            ],
            "TYT Kimya": [
                "KarÄ±ÅŸÄ±mlar"
            ],
            "TYT Biyoloji": [
                "KalÄ±tÄ±m Konusu",
                "Genetik Varyasyonlar"
            ]
        }
    },
    8: {
        "week": 8,
        "focus": "AnlatÄ±m bozukluÄŸu ve mantÄ±k",
        "topics": {
            "TYT TÃ¼rkÃ§e": [
                "AnlatÄ±m bozukluÄŸu"
            ],
            "TYT Matematik": [
                "MantÄ±k",
                "KÃ¼meler"
            ],
            "TYT Tarih": [
                "Mondros ateÅŸkesi, iÅŸgaller ve cemiyetler",
                "KurtuluÅŸ savaÅŸÄ±na hazÄ±rlÄ±k dÃ¶nemi",
                "1.Tbmm dÃ¶nemi",
                "KurtuluÅŸ savaÅŸÄ± ve anlaÅŸmalar"
            ],
            "TYT CoÄŸrafya": [
                "BÃ¶lgeler UluslararasÄ± UlaÅŸÄ±m HatlarÄ±, Ã‡evre ve toplum",
                "DoÄŸal Afetler"
            ],
            "TYT Fizik": [
                "Elektrik ve Manyetizma"
            ],
            "TYT Kimya": [
                "Asitler bazlar ve tuzlar"
            ],
            "TYT Geometri": [
                "EÅŸkenar dÃ¶rtgen",
                "Diktortgen",
                "Kare"
            ],
            "TYT Biyoloji": [
                "Ekosistem Ekolojisi",
                "GÃ¼ncel Ã‡evre SorunlarÄ±",
                "DoÄŸal KaynaklarÄ±n SÃ¼rdÃ¼rÃ¼lebilirliÄŸi",
                "Biyolojik Ã‡eÅŸitliliÄŸin KorunmasÄ±"
            ]
        }
    },
    9: {
        "week": 9,
        "focus": "Kombinasyon-permÃ¼tasyon ve geometri tamamlama",
        "topics": {
            "TYT Matematik": [
                "Kombinasyon-PermÃ¼tasyon",
                "Olasilik"
            ],
            "TYT Tarih": [
                "II.TBMM DÃ¶nemi ve Ã§ok partili hayata geÃ§iÅŸ",
                "TÃ¼rk Ä°nkÄ±labÄ±",
                "AtatÃ¼rk ilkeleri",
                "AtatÃ¼rk dÃ¶nemi tÃ¼rk dÄ±ÅŸ politikasÄ±"
            ],
            "TYT Kimya": [
                "Kimya her yerde"
            ],
            "TYT Geometri": [
                "Yamuk",
                "Ã‡emberde aÃ§Ä±",
                "Ã‡emberde uzunluk",
                "Dairede Ã§evre ve alan",
                "NoktanÄ±n AnalitiÄŸi",
                "DoÄŸrunun AnalitiÄŸi",
                "Prizmalar",
                "KÃ¼p-silindir",
                "Piramit-koni-kÃ¼re"
            ]
        }
    }
}

# ğŸ“š SÃ–ZEL HAFTALIK PLAN - 14 HAFTALIK DETAY PLAN

VERBAL_WEEKLY_PLAN = {
    1: {
        "week": 1,
        "focus": "Felsefe ve Din giriÅŸ - Temel TÃ¼rkÃ§e",
        "topics": {
            "TYT Felsefe": [
                "Felsefenin Konusu",
                "Bilgi Felsefesi - Epistemoloji",
                "VarlÄ±k Felsefesi (Ontoloji)"
            ],
            "TYT Din": [
                "Ä°nsan ve Din (Ä°nanÃ§)"
            ],
            "TYT TÃ¼rkÃ§e": [
                "SÃ¶zcÃ¼kte Anlam - GerÃ§ek Anlam",
                "SÃ¶zcÃ¼kte Anlam - Mecaz Anlam", 
                "SÃ¶zcÃ¼kte Anlam - Terim Anlam",
                "CÃ¼mlede Anlam - CÃ¼mle Yorumlama",
                "Paragraf - Ana Fikir"
            ],
            "TYT Matematik": [
                "Temel Kavramlar",
                "SayÄ± BasamaklarÄ±"
            ],
            "TYT Tarih": [
                "Tarih ve Zaman"
            ],
            "TYT CoÄŸrafya": [
                "DÃ¼nya HaritalarÄ±"
            ]
        }
    },
    2: {
        "week": 2,
        "focus": "Felsefe dallarÄ± ve Din konularÄ±",
        "topics": {
            "TYT Felsefe": [
                "Din, KÃ¼ltÃ¼r ve Medeniyet",
                "Ahlak felsefesi",
                "Sanat Felsefesi",
                "Din Felsefesi"
            ],
            "TYT Din": [
                "Vahiy ve akÄ±l",
                "Ä°badet"
            ],
            "TYT TÃ¼rkÃ§e": [
                "Ses Bilgisi",
                "CÃ¼mlede Anlam - Kesin YargÄ±",
                "CÃ¼mlede Anlam - AnlatÄ±m BiÃ§imleri"
            ],
            "TYT Matematik": [
                "BÃ¶lme ve BÃ¶lÃ¼nebilme",
                "EBOB-EKOK",
                "Rasyonel SayÄ±lar"
            ],
            "TYT CoÄŸrafya": [
                "DoÄŸa ve Ä°nsan",
                "DÃ¼nya'nÄ±n Åekli ve Hareketleri"
            ],
            "TYT Tarih": [
                "Ä°nsanlÄ±ÄŸÄ±n Ä°lk DÃ¶nemleri",
                "OrtaÃ§aÄŸda DÃ¼nya"
            ]
        }
    },
    3: {
        "week": 3,
        "focus": "Siyaset ve Bilim Felsefesi",
        "topics": {
            "TYT Felsefe": [
                "Siyaset Felsefesi",
                "Bilim Felsefesi"
            ],
            "TYT Din": [
                "Hz. Muhammed'in HayatÄ± ve Ã–rnekliÄŸi",
                "Allah'Ä±n varlÄ±ÄŸÄ± ve birliÄŸi (Tevhid)"
            ],
            "TYT TÃ¼rkÃ§e": [
                "YazÄ±m KurallarÄ±",
                "CÃ¼mlede Anlam - Neden-SonuÃ§",
                "Paragraf - YardÄ±mcÄ± Fikir"
            ],
            "TYT Matematik": [
                "OndalÄ±klÄ± SayÄ±lar",
                "Oran OrantÄ±",
                "Denklem Ã‡Ã¶zme"
            ],
            "TYT CoÄŸrafya": [
                "CoÄŸrafi Konum",
                "Harita Bilgisi", 
                "Atmosfer ve SÄ±caklÄ±k"
            ],
            "TYT Tarih": [
                "Ä°lk ve Orta Ã‡aÄŸlarda TÃ¼rk DÃ¼nyasÄ±",
                "Ä°slam Medeniyetinin DoÄŸuÅŸu"
            ]
        }
    },
    4: {
        "week": 4,
        "focus": "Ä°lkÃ§aÄŸ Felsefesi ve Allah'Ä±n SÄ±fatlarÄ±",
        "topics": {
            "TYT Felsefe": [
                "Ä°lk Ã§aÄŸ felsefesi",
                "Sokrates ve felsefesi",
                "Platon ve felsefesi"
            ],
            "TYT Din": [
                "Allah'Ä±n Ä°sim ve SÄ±fatlarÄ± (Esma-Ã¼l HÃ¼sna)",
                "Kur'an-Ä± Kerim'de Ä°nsan ve Ã–zellikleri"
            ],
            "TYT TÃ¼rkÃ§e": [
                "Noktalama Ä°ÅŸaretleri",
                "SÃ¶zcÃ¼kte YapÄ±",
                "Paragraf - Paragraf YapÄ±sÄ±"
            ],
            "TYT Matematik": [
                "Basit EÅŸitsizlikler",
                "Problemler - SayÄ± Problemleri"
            ],
            "TYT CoÄŸrafya": [
                "BasÄ±nÃ§ ve RÃ¼zgarlar",
                "Nem, YaÄŸÄ±ÅŸ ve BuharlaÅŸma"
            ],
            "TYT Tarih": [
                "TÃ¼rk-Ä°slam Devletleri",
                "Anadolu'da Ä°lk TÃ¼rk Beylikleri"
            ]
        }
    },
    5: {
        "week": 5,
        "focus": "Aristoteles ve Ä°nsan-Allah iliÅŸkisi",
        "topics": {
            "TYT Felsefe": [
                "Aristoteles ve felsefesi",
                "Orta Ã§aÄŸ felsefesi"
            ],
            "TYT Din": [
                "Ä°nsanÄ±n Allah Ä°le Ä°rtibatÄ± (Dua, TÃ¶vbe, Ä°badet)",
                "Kur'an-Ä± Kerim'de GenÃ§ler"
            ],
            "TYT TÃ¼rkÃ§e": [
                "SÃ¶zcÃ¼k YapÄ±sÄ± - Ek Bilgisi",
                "Paragraf - AnlatÄ±m Teknikleri",
                "Edebiyat - Edebi TÃ¼rler"
            ],
            "TYT Matematik": [
                "Problemler - Kesir Problemleri",
                "Problemler - YÃ¼zde Problemleri"
            ],
            "TYT CoÄŸrafya": [
                "Ä°klim ElemanlarÄ± ve Ä°klim Tipleri",
                "TÃ¼rkiye'nin Ä°klimi"
            ],
            "TYT Tarih": [
                "OsmanlÄ± Devleti'nin KuruluÅŸu",
                "OsmanlÄ± Klasik Ã‡aÄŸÄ±"
            ]
        }
    },
    6: {
        "week": 6,
        "focus": "Ä°slam ve Hristiyan Felsefesi",
        "topics": {
            "TYT Felsefe": [
                "Ä°slam Felsefesi (Farabi, Ä°bn Sina)",
                "Hristiyan Felsefesi (Augustinus, AquinalÄ± Thomas)"
            ],
            "TYT Din": [
                "Bir genÃ§ olarak Hz.Muhammed",
                "Hz.Muhammed ve genÃ§ler"
            ],
            "TYT TÃ¼rkÃ§e": [
                "Edebiyat - NazÄ±m-Nesir",
                "Edebiyat - Masal, Fabl",
                "CÃ¼mle Bilgisi - Ã–ge Bilgisi"
            ],
            "TYT Matematik": [
                "Problemler - YaÅŸ Problemleri",
                "Problemler - KarÄ±ÅŸÄ±m Problemleri"
            ],
            "TYT CoÄŸrafya": [
                "Bitki Ã–rtÃ¼sÃ¼",
                "Toprak OluÅŸumu ve TÃ¼rleri"
            ],
            "TYT Tarih": [
                "OsmanlÄ± Duraklama DÃ¶nemi",
                "OsmanlÄ± Gerileme DÃ¶nemi"
            ]
        }
    },
    7: {
        "week": 7,
        "focus": "AYT Felsefe baÅŸlangÄ±Ã§ ve genÃ§ sahabiler",
        "topics": {
            "AYT Felsefe": [
                "Bilgi felsefesi",
                "VarlÄ±k felsefesi",
                "Ahlak felsefesi"
            ],
            "TYT Din": [
                "BazÄ± genÃ§ sahabiler",
                "Din ve aile",
                "Din, KÃ¼ltÃ¼r ve Sanat"
            ],
            "TYT TÃ¼rkÃ§e": [
                "CÃ¼mle Bilgisi - CÃ¼mle TÃ¼rleri",
                "Edebiyat - Hikaye, Roman",
                "Paragraf - DÃ¼ÅŸÃ¼nceyi GeliÅŸtirme"
            ],
            "TYT Matematik": [
                "Problemler - Hareket Problemleri",
                "Problemler - Ä°ÅŸÃ§i Problemleri"
            ],
            "TYT CoÄŸrafya": [
                "Hidrografya",
                "GÃ¶ller, Akarsular"
            ],
            "TYT Tarih": [
                "OsmanlÄ± Islahat Hareketleri",
                "Tanzimat DÃ¶nemi"
            ]
        }
    },
    8: {
        "week": 8,
        "focus": "AYT Felsefe dallarÄ± ve Din-Toplum",
        "topics": {
            "TYT Din": [
                "Din ve Ã§evre",
                "Din ve sosyal deÄŸiÅŸim",
                "Din ve ekonomi"
            ],
            "AYT Felsefe": [
                "Sanat Felsefesi",
                "Din Felsefesi",
                "Siyaset felsefesi",
                "Bilim Felsefesi"
            ],
            "TYT TÃ¼rkÃ§e": [
                "Edebiyat - Tiyatro",
                "Edebiyat - Åiir TÃ¼rleri",
                "Anlam Bilgisi - EÅŸ Anlam"
            ],
            "TYT Matematik": [
                "Problemler - Faiz Problemleri",
                "ÃœslÃ¼ SayÄ±lar"
            ],
            "AYT CoÄŸrafya": [
                "NÃ¼fus CoÄŸrafyasÄ±",
                "NÃ¼fusun YapÄ±sÄ± ve Ã–zellikleri"
            ],
            "AYT Tarih": [
                "1. MeÅŸrutiyet",
                "2. AbdÃ¼lhamit DÃ¶nemi"
            ]
        }
    },
    9: {
        "week": 9,
        "focus": "Ä°slam ahlakÄ± ve Ä°lkÃ§aÄŸ AYT Felsefe",
        "topics": {
            "TYT Din": [
                "Din ve sosyal adalet",
                "Ä°slam ahlakÄ±nÄ±n temel ilkeleri, iyi ve kÃ¶tÃ¼ davranÄ±ÅŸlar",
                "Ä°slam DÃ¼ÅŸÃ¼ncesinde Ä°tikadi, Siyasi ve FÄ±khi Yorumlar (Mezhepler)"
            ],
            "AYT Felsefe": [
                "Ä°lk Ã§aÄŸ felsefesi",
                "MÃ– 6. YÃ¼zyÄ±l â€“ MS 2. YÃ¼zyÄ±l Felsefesi",
                "MS 2. YÃ¼zyÄ±l â€“ MS 15. YÃ¼zyÄ±l Felsefesi"
            ],
            "TYT TÃ¼rkÃ§e": [
                "Anlam Bilgisi - ZÄ±t Anlam",
                "Anlam Bilgisi - EÅŸ Sesli Kelimeler",
                "Edebiyat - Mektup, AnÄ±"
            ],
            "TYT Matematik": [
                "KÃ¶klÃ¼ SayÄ±lar",
                "Ã‡arpanlara AyÄ±rma"
            ],
            "AYT CoÄŸrafya": [
                "YerleÅŸme CoÄŸrafyasÄ±",
                "KÄ±rsal ve Kentsel YerleÅŸmeler"
            ],
            "AYT Tarih": [
                "2. MeÅŸrutiyet DÃ¶nemi",
                "Balkan SavaÅŸlarÄ±"
            ]
        }
    },
    10: {
        "week": 10,
        "focus": "AYT Din baÅŸlangÄ±Ã§ ve YeniÃ§aÄŸ Felsefe",
        "topics": {
            "AYT Din": [
                "DÃ¼nya ve ahiret",
                "Kurana gÃ¶re Hz Muhammed",
                "Kuran'da bazÄ± kavramlar"
            ],
            "AYT Felsefe": [
                "15. YÃ¼zyÄ±l â€“ 17. YÃ¼zyÄ±l Felsefesi",
                "18. YÃ¼zyÄ±l â€“ 19. YÃ¼zyÄ±l Felsefesi"
            ],
            "TYT TÃ¼rkÃ§e": [
                "Edebiyat - Deneme, FÄ±kra",
                "Dil Bilgisi - Fiil Ã‡atÄ±sÄ±",
                "Dil Bilgisi - Fiil ZamanlarÄ±"
            ],
            "TYT Matematik": [
                "Birinci Dereceden Denklemler",
                "Birinci Dereceden EÅŸitsizlikler"
            ],
            "AYT CoÄŸrafya": [
                "Ekonomik Faaliyetler",
                "TarÄ±m ve HayvancÄ±lÄ±k"
            ],
            "AYT Tarih": [
                "1. DÃ¼nya SavaÅŸÄ±",
                "Mondros AteÅŸkes AntlaÅŸmasÄ±"
            ]
        }
    },
    11: {
        "week": 11,
        "focus": "Ä°slam bilim tarihi ve 20.YY Felsefe",
        "topics": {
            "AYT Din": [
                "Kurandan mesajlar",
                "Ä°nanÃ§la ilgili meseleler",
                "Ä°slam ve Bilim",
                "Anadolu'da Ä°slam"
            ],
            "AYT Felsefe": [
                "20.YY felsefesi",
                "MantÄ±ÄŸa giriÅŸ",
                "Klasik mantÄ±k",
                "MantÄ±k ve dil"
            ],
            "TYT TÃ¼rkÃ§e": [
                "Dil Bilgisi - Fiil Kipleri",
                "Edebiyat - KÃ¶ÅŸe YazÄ±sÄ±",
                "Edebiyat - EleÅŸtiri"
            ],
            "TYT Matematik": [
                "Ä°kinci Dereceden Denklemler",
                "Fonksiyonlar - Kavram"
            ],
            "AYT CoÄŸrafya": [
                "Sanayi",
                "UlaÅŸtÄ±rma ve Ticaret"
            ],
            "AYT Tarih": [
                "Ä°ÅŸgal ve DireniÅŸin BaÅŸlamasÄ±",
                "Kuva-yÄ± Milliye"
            ]
        }
    },
    12: {
        "week": 12,
        "focus": "Tasavvuf ve Sembolik mantÄ±k",
        "topics": {
            "AYT Din": [
                "Ä°slam DÃ¼ÅŸÃ¼ncesinde Tasavvufi Yorumlar ve Mezhepler",
                "GÃ¼ncel dini meseleler",
                "YaÅŸayan dinler"
            ],
            "AYT Felsefe": [
                "Sembolik mantÄ±k",
                "Psikojinin temel sÃ¼reÃ§leri",
                "Ã–ÄŸrenme bellek dÃ¼ÅŸÃ¼nme"
            ],
            "TYT TÃ¼rkÃ§e": [
                "Edebiyat - Biyografi",
                "Edebiyat - SÃ¶ylev",
                "Dil Bilgisi - SÄ±fat TÃ¼rleri"
            ],
            "TYT Matematik": [
                "Fonksiyonlar - Grafik",
                "Fonksiyonlar - Ä°ÅŸlemler"
            ],
            "AYT CoÄŸrafya": [
                "Ã‡evre SorunlarÄ±",
                "DoÄŸal Afetler"
            ],
            "AYT Tarih": [
                "TBMM'nin AÃ§Ä±lmasÄ±",
                "Milli MÃ¼cadele DÃ¶nemi"
            ]
        }
    },
    13: {
        "week": 13,
        "focus": "Ruh saÄŸlÄ±ÄŸÄ± ve Toplum yapÄ±sÄ±",
        "topics": {
            "AYT Felsefe": [
                "Ruh saÄŸlÄ±ÄŸÄ±nÄ±n temelleri",
                "Birey ve toplum",
                "Toplumsal yapÄ±"
            ],
            "TYT TÃ¼rkÃ§e": [
                "Dil Bilgisi - Zarf TÃ¼rleri",
                "Edebiyat - Gezi YazÄ±sÄ±",
                "Anlam Bilgisi - Kelime TÃ¼retme"
            ],
            "TYT Matematik": [
                "Logaritma",
                "Diziler - Aritmetik"
            ],
            "AYT CoÄŸrafya": [
                "TÃ¼rkiye'nin CoÄŸrafi BÃ¶lgeleri",
                "Marmara BÃ¶lgesi"
            ],
            "AYT Tarih": [
                "Lozan BarÄ±ÅŸ AntlaÅŸmasÄ±",
                "AtatÃ¼rk Ä°lkeleri"
            ]
        }
    },
    14: {
        "week": 14,
        "focus": "Toplumsal deÄŸiÅŸim ve Son konular",
        "topics": {
            "AYT Felsefe": [
                "Toplumsal deÄŸiÅŸme ve geliÅŸme",
                "Toplum ve kÃ¼ltÃ¼r",
                "Toplumsal kurumlar"
            ],
            "TYT TÃ¼rkÃ§e": [
                "Edebiyat - RÃ¶portaj",
                "Dil Bilgisi - Edat ve BaÄŸlaÃ§",
                "Anlam Bilgisi - Deyimler ve AtasÃ¶zleri"
            ],
            "TYT Matematik": [
                "Diziler - Geometrik",
                "Polinomlar"
            ],
            "AYT CoÄŸrafya": [
                "Ege BÃ¶lgesi",
                "Akdeniz BÃ¶lgesi",
                "Ä°Ã§ Anadolu BÃ¶lgesi"
            ],
            "AYT Tarih": [
                "AtatÃ¼rk DÃ¶nemi Ä°Ã§ Politika",
                "AtatÃ¼rk DÃ¶nemi DÄ±ÅŸ Politika"
            ]
        }
    }
}

# ğŸ® GAMÄ°FÄ°CATÄ°ON SÄ°STEMÄ° - BAÅARILAR VE ROZET SÄ°STEMÄ°

# ğŸ† Rozet Sistemi - BaÅŸarÄ± Rozetleri
ACHIEVEMENT_BADGES = {
    "topic_milestones": {
        "first_topic": {
            "name": "Ä°lk AdÄ±m", 
            "icon": "ğŸš€", 
            "description": "Ä°lk konunu tamamladÄ±n! YolculuÄŸa baÅŸladÄ±n!",
            "points": 25,
            "requirement": 1
        },
        "topic_10": {
            "name": "BaÅŸlangÄ±Ã§", 
            "icon": "â­", 
            "description": "10 konu tamamlandÄ± - Ä°yi bir baÅŸlangÄ±Ã§!",
            "points": 50,
            "requirement": 10
        },
        "topic_25": {
            "name": "Momentum", 
            "icon": "ğŸŒŸ", 
            "description": "25 konu tamamlandÄ± - Momentum kazandÄ±n!",
            "points": 100,
            "requirement": 25
        },
        "topic_50": {
            "name": "Ä°lerliyor", 
            "icon": "ğŸŒŸ", 
            "description": "50 konu tamamlandÄ± - Harika ilerleme!",
            "points": 200,
            "requirement": 50
        },
        "topic_100": {
            "name": "YÃ¼zlÃ¼k KulÃ¼p", 
            "icon": "ğŸ’¯", 
            "description": "100 konu tamamlandÄ± - Sen bir ÅŸampiyonsun!",
            "points": 500,
            "requirement": 100
        },
        "topic_250": {
            "name": "KonularÄ±n Efendisi", 
            "icon": "ğŸ‘‘", 
            "description": "250 konu tamamlandÄ± - ArtÄ±k bir uzmanÄ±sÄ±n!",
            "points": 1000,
            "requirement": 250
        },
        "topic_500": {
            "name": "Konu Makinesi", 
            "icon": "ğŸ”¥", 
            "description": "500 konu tamamlandÄ± - Ä°nanÄ±lmaz bir baÅŸarÄ±!",
            "points": 2000,
            "requirement": 500
        }
    },
    "subject_expertise": {
        "math_expert": {
            "name": "Matematik UzmanÄ±", 
            "icon": "ğŸ“", 
            "description": "Matematik konularÄ±nda uzmanlaÅŸtÄ±n!",
            "points": 300,
            "criteria": {"TYT Matematik": 30, "AYT Matematik": 20}
        },
        "turkish_expert": {
            "name": "TÃ¼rkÃ§e UzmanÄ±", 
            "icon": "ğŸ“", 
            "description": "TÃ¼rkÃ§e konularÄ±nda uzmanlaÅŸtÄ±n!",
            "points": 250,
            "criteria": {"TYT TÃ¼rkÃ§e": 40}
        },
        "science_expert": {
            "name": "Fen UzmanÄ±", 
            "icon": "ğŸ”¬", 
            "description": "Fen konularÄ±nda uzmanlaÅŸtÄ±n!",
            "points": 400,
            "criteria": {"TYT Fizik": 15, "TYT Kimya": 15, "TYT Biyoloji": 15}
        },
        "social_expert": {
            "name": "Sosyal UzmanÄ±", 
            "icon": "ğŸ›ï¸", 
            "description": "Sosyal bilimler uzmanÄ±sÄ±n!",
            "points": 300,
            "criteria": {"TYT Tarih": 20, "TYT CoÄŸrafya": 15}
        }
    },
    "streak_badges": {
        "week_streak": {
            "name": "HaftalÄ±k Kahraman", 
            "icon": "âš¡", 
            "description": "1 hafta boyunca her gÃ¼n Ã§alÄ±ÅŸtÄ±n!",
            "points": 150,
            "requirement": 7
        },
        "month_streak": {
            "name": "AylÄ±k Åampiyon", 
            "icon": "ğŸ…", 
            "description": "1 ay boyunca dÃ¼zenli Ã§alÄ±ÅŸtÄ±n!",
            "points": 500,
            "requirement": 30
        },
        "perfect_week": {
            "name": "MÃ¼kemmel Hafta", 
            "icon": "ğŸ’", 
            "description": "HaftalÄ±k hedefini %100 tamamladÄ±n!",
            "points": 200,
            "requirement": 100
        }
    }
}

# â­ Puan Sistemi
POINT_SYSTEM = {
    "topic_completion": {
        "easy": 10,      # Zorluk 1-2
        "medium": 15,    # Zorluk 3
        "hard": 20,      # Zorluk 4
        "very_hard": 25  # Zorluk 5
    },
    "topic_review": 5,
    "exam_analysis": 30,
    "daily_goal_complete": 20,
    "weekly_goal_complete": 100,
    "streak_bonus": {
        "daily": 5,
        "weekly": 50
    },
    "milestone_bonus": {
        "net_improvement": 10  # Net artÄ±ÅŸÄ± baÅŸÄ±na bonus
    }
}

# ğŸ¯ Challenge Sistemi
DAILY_CHALLENGES = [
    {
        "id": "daily_3_topics", 
        "name": "GÃ¼nlÃ¼k ÃœÃ§lÃ¼", 
        "description": "BugÃ¼n 3 konu tamamla", 
        "points": 30, 
        "target": 3,
        "type": "topic_count"
    },
    {
        "id": "daily_math_focus", 
        "name": "Matematik OdaÄŸÄ±", 
        "description": "BugÃ¼n sadece matematik Ã§alÄ±ÅŸ", 
        "points": 25,
        "type": "subject_focus",
        "target_subject": "Matematik"
    },
    {
        "id": "daily_review", 
        "name": "Tekrar GÃ¼nÃ¼", 
        "description": "BugÃ¼n 5 konu tekrarÄ± yap", 
        "points": 20, 
        "target": 5,
        "type": "review_count"
    },
    {
        "id": "daily_streak", 
        "name": "SÃ¼reklilik", 
        "description": "GÃ¼nlÃ¼k hedefini tamamla", 
        "points": 15,
        "type": "daily_goal"
    }
]

WEEKLY_CHALLENGES = [
    {
        "id": "weekly_exam", 
        "name": "HaftalÄ±k Deneme", 
        "description": "Bu hafta 1 deneme Ã§Ã¶z", 
        "points": 100, 
        "target": 1,
        "type": "exam_count"
    },
    {
        "id": "weekly_15_topics", 
        "name": "HaftalÄ±k Maraton", 
        "description": "Bu hafta 15 konu tamamla", 
        "points": 150, 
        "target": 15,
        "type": "topic_count"
    },
    {
        "id": "weekly_perfect", 
        "name": "MÃ¼kemmel Hafta", 
        "description": "HaftalÄ±k hedefini %100 tamamla", 
        "points": 200,
        "target": 100,
        "type": "weekly_goal_percentage"
    }
]

# ğŸ† Seviye Sistemi
LEVEL_SYSTEM = {
    "level_thresholds": [0, 100, 300, 600, 1000, 1500, 2200, 3000, 4000, 5200, 6600, 8200, 10000, 12000, 14500, 17500, 21000, 25000, 30000, 36000],
    "level_rewards": {
        5: {"name": "YKS Yolcusu", "icon": "ğŸ’", "reward": "Ã–zel tema aÃ§Ä±ldÄ±"},
        10: {"name": "KararlÄ± Ã–ÄŸrenci", "icon": "ğŸ’ª", "reward": "Ä°lerleme grafiÄŸi aÃ§Ä±ldÄ±"},
        15: {"name": "YKS UzmanÄ±", "icon": "ğŸ“", "reward": "DetaylÄ± analiz aÃ§Ä±ldÄ±"},
        20: {"name": "Ã‡alÄ±ÅŸma Makinesi", "icon": "ğŸ¤–", "reward": "TÃ¼m Ã¶zellikler aÃ§Ä±ldÄ±"}
    }
}

# ğŸ® GAMÄ°FÄ°CATÄ°ON SÄ°STEMÄ° FONKSÄ°YONLARI

def init_gamification_system():
    """KullanÄ±cÄ± iÃ§in gamification verilerini baÅŸlat"""
    if 'gamification' not in st.session_state:
        st.session_state.gamification = {
            'total_points': 0,
            'level': 1,
            'badges': [],
            'achievements': {},
            'daily_streak': 0,
            'weekly_streak': 0,
            'last_activity_date': None,
            'completed_challenges': {
                'daily': {},
                'weekly': {}
            },
            'current_challenges': {
                'daily': generate_daily_challenges(),
                'weekly': generate_weekly_challenges()
            },
            'stats': {
                'topics_completed': 0,
                'topics_reviewed': 0,
                'exams_taken': 0,
                'study_days': 0,
                'total_study_time': 0,
                'subject_progress': {}
            },
            'milestone_progress': {},
            'last_level_up': None
        }

def calculate_user_level(total_points):
    """Puana gÃ¶re seviye hesapla"""
    thresholds = LEVEL_SYSTEM["level_thresholds"]
    for i, threshold in enumerate(thresholds):
        if total_points < threshold:
            return i
    return len(thresholds)

def award_points(activity_type, difficulty_level=None, subject=None):
    """Aktivite tipine gÃ¶re puan ver"""
    if 'gamification' not in st.session_state:
        init_gamification_system()
    
    points = 0
    
    if activity_type == "topic_completion":
        if difficulty_level in [1, 2]:
            points = POINT_SYSTEM["topic_completion"]["easy"]
        elif difficulty_level == 3:
            points = POINT_SYSTEM["topic_completion"]["medium"]
        elif difficulty_level == 4:
            points = POINT_SYSTEM["topic_completion"]["hard"]
        elif difficulty_level == 5:
            points = POINT_SYSTEM["topic_completion"]["very_hard"]
    elif activity_type == "topic_review":
        points = POINT_SYSTEM["topic_review"]
    elif activity_type == "exam_analysis":
        points = POINT_SYSTEM["exam_analysis"]
    elif activity_type == "daily_goal_complete":
        points = POINT_SYSTEM["daily_goal_complete"]
    elif activity_type == "weekly_goal_complete":
        points = POINT_SYSTEM["weekly_goal_complete"]
    
    # Streak bonusu ekle
    if st.session_state.gamification['daily_streak'] >= 7:
        points += POINT_SYSTEM["streak_bonus"]["weekly"]
    elif st.session_state.gamification['daily_streak'] >= 1:
        points += POINT_SYSTEM["streak_bonus"]["daily"]
    
    # PuanÄ± ekle
    old_level = st.session_state.gamification['level']
    st.session_state.gamification['total_points'] += points
    new_level = calculate_user_level(st.session_state.gamification['total_points'])
    st.session_state.gamification['level'] = new_level
    
    # Seviye atlama kontrolÃ¼
    if new_level > old_level:
        st.session_state.gamification['last_level_up'] = new_level
        show_level_up_notification(new_level)
    
    return points

def check_achievements():
    """BaÅŸarÄ± rozetlerini kontrol et"""
    if 'gamification' not in st.session_state:
        init_gamification_system()
    
    stats = st.session_state.gamification['stats']
    new_badges = []
    
    # Konu milestone'larÄ± kontrol et
    topic_count = stats['topics_completed']
    for milestone_id, badge in ACHIEVEMENT_BADGES["topic_milestones"].items():
        if milestone_id not in st.session_state.gamification['badges']:
            if topic_count >= badge['requirement']:
                st.session_state.gamification['badges'].append(milestone_id)
                st.session_state.gamification['total_points'] += badge['points']
                new_badges.append(badge)
    
    # UzmanlÄ±k rozetlerini kontrol et
    subject_progress = stats.get('subject_progress', {})
    for expertise_id, badge in ACHIEVEMENT_BADGES["subject_expertise"].items():
        if expertise_id not in st.session_state.gamification['badges']:
            criteria_met = True
            for subject, required_count in badge['criteria'].items():
                if subject_progress.get(subject, 0) < required_count:
                    criteria_met = False
                    break
            
            if criteria_met:
                st.session_state.gamification['badges'].append(expertise_id)
                st.session_state.gamification['total_points'] += badge['points']
                new_badges.append(badge)
    
    return new_badges

def update_topic_completion(subject, topic_name, difficulty_level):
    """Konu tamamlandÄ±ÄŸÄ±nda gamification verilerini gÃ¼ncelle"""
    if 'gamification' not in st.session_state:
        init_gamification_system()
    
    # Ä°statistikleri gÃ¼ncelle
    st.session_state.gamification['stats']['topics_completed'] += 1
    
    # Konu bazlÄ± ilerlemeyi gÃ¼ncelle
    if 'subject_progress' not in st.session_state.gamification['stats']:
        st.session_state.gamification['stats']['subject_progress'] = {}
    
    subject_key = subject.replace(' ', '_').lower()
    st.session_state.gamification['stats']['subject_progress'][subject] = \
        st.session_state.gamification['stats']['subject_progress'].get(subject, 0) + 1
    
    # Puan ver
    points = award_points("topic_completion", difficulty_level, subject)
    
    # BaÅŸarÄ± kontrolÃ¼
    new_badges = check_achievements()
    
    # Challenge'larÄ± gÃ¼ncelle
    update_challenge_progress("topic_completion", subject)
    
    return points, new_badges

def generate_daily_challenges():
    """GÃ¼nlÃ¼k challenge'lar Ã¼ret"""
    import random
    return random.sample(DAILY_CHALLENGES, 2)  # Her gÃ¼n 2 challenge

def generate_weekly_challenges():
    """HaftalÄ±k challenge'lar Ã¼ret"""
    import random
    return random.sample(WEEKLY_CHALLENGES, 1)  # Her hafta 1 challenge

def update_challenge_progress(activity_type, subject=None):
    """Challenge ilerlemesini gÃ¼ncelle"""
    if 'gamification' not in st.session_state:
        return
    
    today = datetime.now().strftime("%Y-%m-%d")
    current_week = datetime.now().strftime("%Y-W%U")
    
    # GÃ¼nlÃ¼k challenge'larÄ± kontrol et
    for challenge in st.session_state.gamification['current_challenges']['daily']:
        challenge_progress = st.session_state.gamification['completed_challenges']['daily'].get(challenge['id'], {})
        
        if challenge['type'] == 'topic_count' and activity_type == 'topic_completion':
            current_count = challenge_progress.get(today, 0)
            challenge_progress[today] = current_count + 1
            st.session_state.gamification['completed_challenges']['daily'][challenge['id']] = challenge_progress
            
            # Challenge tamamlandÄ± mÄ±?
            if challenge_progress[today] >= challenge['target']:
                award_points("daily_goal_complete")
                st.success(f"ğŸ¯ GÃ¼nlÃ¼k gÃ¶rev tamamlandÄ±: {challenge['name']} (+{challenge['points']} puan)")

# ğŸ¯ SÄ±nÄ±f BazlÄ± Program YÃ¶netimi
def get_grade_based_strategy(grade, target_department):
    """SÄ±nÄ±f ve hedef bÃ¶lÃ¼me gÃ¶re strateji dÃ¶ndÃ¼rÃ¼r"""
    base_strategy = GRADE_BASED_PROGRAMS.get(grade, GRADE_BASED_PROGRAMS["12. SÄ±nÄ±f"])
    
    # Hedef bÃ¶lÃ¼m zorluÄŸunu al
    dept_difficulty = TARGET_DEPARTMENT_DIFFICULTY.get(target_department, TARGET_DEPARTMENT_DIFFICULTY["VarsayÄ±lan"])
    
    # Stratejiyi zorluÄŸa gÃ¶re ayarla
    adjusted_strategy = base_strategy.copy()
    adjusted_strategy['weekly_topic_base'] = int(base_strategy['weekly_topic_base'] * dept_difficulty['weekly_topic_multiplier'])
    adjusted_strategy['weekly_topic_multiplier'] = dept_difficulty['weekly_topic_multiplier']
    adjusted_strategy['difficulty_level'] = dept_difficulty['difficulty_level']
    adjusted_strategy['target_nets'] = dept_difficulty['required_nets']
    
    return adjusted_strategy

def analyze_student_subject_performance(user_data):
    """Ã–ÄŸrencinin ders bazlÄ± performansÄ±nÄ± analiz eder"""
    import json
    topic_progress_str = user_data.get('topic_progress', '{}')
    topic_progress = json.loads(topic_progress_str) if topic_progress_str else {}
    
    # Ders bazlÄ± net ortalamalarÄ±
    subject_stats = {}
    
    for key, value in topic_progress.items():
        # "TYT TÃ¼rkÃ§e | ... | Konu" formatÄ±ndan ders adÄ±nÄ± Ã§Ä±kar
        if ' | ' in key:
            parts = key.split(' | ')
            if len(parts) >= 2:
                subject = parts[0].strip()  # "TYT TÃ¼rkÃ§e" gibi
                
                # Net deÄŸerini al
                net_value = 0
                if isinstance(value, dict):
                    net_value = int(float(value.get('net', 0)))
                else:
                    try:
                        net_value = int(float(str(value)))
                    except:
                        net_value = 0
                
                # Ä°statistikleri topla
                if subject not in subject_stats:
                    subject_stats[subject] = {'nets': [], 'total_net': 0, 'count': 0}
                
                subject_stats[subject]['nets'].append(net_value)
                subject_stats[subject]['total_net'] += net_value
                subject_stats[subject]['count'] += 1
    
    # OrtalamalarÄ± hesapla ve zorlanÄ±lan dersleri belirle
    for subject, stats in subject_stats.items():
        stats['avg_net'] = stats['total_net'] / stats['count'] if stats['count'] > 0 else 0
        # DÃ¼ÅŸÃ¼k net = zorluk
        if stats['avg_net'] < 3:
            stats['difficulty_level'] = 'high'  # Ã‡ok zorlanÄ±yor
            stats['priority'] = 1
        elif stats['avg_net'] < 5:
            stats['difficulty_level'] = 'medium'  # Orta zorluk
            stats['priority'] = 2
        else:
            stats['difficulty_level'] = 'low'  # Ä°yi gidiyor
            stats['priority'] = 3
    
    return subject_stats

def get_smart_balanced_topics(all_remaining_topics, user_data, weekly_limit=18):
    """AkÄ±llÄ± ve dengeli konu seÃ§imi - Her dersten orantÄ±lÄ± daÄŸÄ±lÄ±m + zorlanÄ±lan derslere Ã¶ncelik"""
    
    # Ã–ÄŸrencinin ders performansÄ±nÄ± analiz et
    subject_performance = analyze_student_subject_performance(user_data)
    
    # KonularÄ± ders bazÄ±nda grupla
    topics_by_subject = {}
    for topic in all_remaining_topics:
        subject = topic.get('subject', 'DiÄŸer')
        if subject not in topics_by_subject:
            topics_by_subject[subject] = []
        topics_by_subject[subject].append(topic)
    
    # Her dersten kaÃ§ konu alÄ±nacaÄŸÄ±nÄ± hesapla
    total_subjects = len(topics_by_subject)
    if total_subjects == 0:
        return []
    
    # Ã–ncelikli derslere daha fazla konu
    priority_subjects = []
    normal_subjects = []
    
    for subject, topics in topics_by_subject.items():
        subject_info = subject_performance.get(subject, {'priority': 2, 'difficulty_level': 'medium'})
        
        if subject_info['priority'] == 1:  # ZorlanÄ±lan ders
            priority_subjects.append((subject, topics, subject_info))
        else:
            normal_subjects.append((subject, topics, subject_info))
    
    # Dengeli daÄŸÄ±lÄ±m stratejisi
    selected_topics = []
    
    # Ã–nce zorlanÄ±lan derslerden daha fazla konu al
    priority_quota = int(weekly_limit * 0.6) if priority_subjects else 0
    normal_quota = weekly_limit - priority_quota
    
    # ZorlanÄ±lan derslerden konular ekle
    if priority_subjects:
        topics_per_priority_subject = max(1, priority_quota // len(priority_subjects))
        for subject, topics, info in priority_subjects:
            # Kolay konulardan baÅŸla (dÃ¼ÅŸÃ¼k difficulty)
            sorted_topics = sorted(topics, key=lambda x: (
                0 if x.get('difficulty', 'orta') == 'kolay' else 1 if x.get('difficulty') == 'orta' else 2,
                -x.get('net', 0)  # DÃ¼ÅŸÃ¼k net'li konulara Ã¶ncelik
            ))
            
            for topic in sorted_topics[:topics_per_priority_subject]:
                topic['priority'] = 'high'
                topic['color'] = 'ğŸ”´'  # ZorlanÄ±lan ders
                topic['reason'] = f"Ã–ncelikli: {subject} dersinde ortalama netiniz dÃ¼ÅŸÃ¼k ({info.get('avg_net', 0):.1f})"
                selected_topics.append(topic)
    
    # Normal derslerden dengeli ÅŸekilde ekle
    if normal_subjects:
        topics_per_normal_subject = max(1, normal_quota // len(normal_subjects))
        for subject, topics, info in normal_subjects:
            # Kolay â†’ orta â†’ zor sÄ±ralamasÄ±
            sorted_topics = sorted(topics, key=lambda x: (
                0 if x.get('difficulty', 'orta') == 'kolay' else 1 if x.get('difficulty') == 'orta' else 2,
                -x.get('net', 0)
            ))
            
            for topic in sorted_topics[:topics_per_normal_subject]:
                topic['priority'] = 'normal'
                topic['color'] = 'ğŸŸ¢' if info.get('avg_net', 0) >= 5 else 'ğŸŸ¡'
                topic['reason'] = f"{subject} - Dengeli daÄŸÄ±lÄ±m"
                selected_topics.append(topic)
    
    # Ã–ncelikli konularÄ± baÅŸa al
    selected_topics.sort(key=lambda x: (0 if x.get('priority') == 'high' else 1, x.get('subject', '')))
    
    return selected_topics[:weekly_limit]

def get_equal_weight_weekly_topics(week_number, completed_topics, pending_topics, user_data=None):
    """ğŸ¯ AKILLI EÅŸit AÄŸÄ±rlÄ±k HaftalÄ±k Konu SeÃ§ici - Dengeli DaÄŸÄ±lÄ±m + ZorlanÄ±lan Derslere Ã–ncelik"""
    if week_number > 16:
        week_number = 16  # Max 16 hafta
    
    # ğŸ†• DÃœZELTÄ°LDÄ°: TamamlanmÄ±ÅŸ konu isimlerini al (completed_topics artÄ±k tuple dÃ¶ndÃ¼rÃ¼yor)
    if isinstance(completed_topics, tuple):
        completed_topics_list, completed_topic_names = completed_topics
    else:
        # Eski format ile uyumluluk
        completed_topic_names = set()
        if completed_topics:
            for topic in completed_topics:
                topic_name = topic.get('topic', '') if isinstance(topic, dict) else str(topic)
                if topic_name:
                    completed_topic_names.add(topic_name)
    
    # ğŸ”¥ KRÄ°TÄ°K: topic_progress'den gerÃ§ek net deÄŸerlerini al
    topic_progress = {}
    if user_data:
        import json
        topic_progress_str = user_data.get('topic_progress', '{}')
        topic_progress = json.loads(topic_progress_str) if topic_progress_str else {}
    
    # ğŸ¯ ADIM 1: O HAFTANIN STRATEJÄ°SÄ°NDEKÄ° DERSLERÄ° TESPIT ET
    current_week_plan = EQUAL_WEIGHT_WEEKLY_PLAN.get(week_number, {})
    current_week_subjects = set(current_week_plan.get('topics', {}).keys())
    
    # ğŸ”¥ ADIM 2: SADECE BU DERSLERÄ°N KALAN KONULARINI TOPLA (TÃœM HAFTALARDAN)
    all_remaining_topics = []
    
    for wk in range(1, 17):  # TÃ¼m 16 haftayÄ± tara
        week_plan = EQUAL_WEIGHT_WEEKLY_PLAN.get(wk, {})
        planned_topics = week_plan.get('topics', {})
        
        for subject, topic_list in planned_topics.items():
            # âœ… SADECE BU HAFTANIN STRATEJÄ°SÄ°NDEKÄ° DERSLERÄ° AL
            # Ã–rnek: Hafta 1 â†’ Sadece TYT dersleri, AYT dersleri dahil deÄŸil
            if subject not in current_week_subjects:
                continue  # Bu ders bu haftanÄ±n stratejisinde yok, atla
            
            for topic in topic_list:
                # TamamlanmÄ±ÅŸ konularÄ± ATLA
                if topic in completed_topic_names:
                    continue
                
                # GerÃ§ek net deÄŸerini bul
                real_net = 0
                for key, value in topic_progress.items():
                    if topic in key or (" - " in topic and topic.split(" - ")[1] in key):
                        if isinstance(value, dict):
                            real_net = int(float(value.get('net', 0)))
                        else:
                            try:
                                real_net = int(float(str(value)))
                            except:
                                real_net = 0
                        break
                
                # ğŸ¯ YENÄ°: YÃ¼ksek netlileri atla (bÃ¼yÃ¼k oranda tamamlanmÄ±ÅŸ)
                if real_net >= 15:
                    continue
                
                all_remaining_topics.append({
                    'subject': subject,
                    'topic': topic,
                    'week': wk,
                    'priority': 'normal',
                    'difficulty': get_topic_difficulty_by_name(topic),
                    'status': 'planned',
                    'net': real_net,
                    'detail': ''
                })
    
    # Ã–NCEKÄ° HAFTALARDAKÄ° KALAN Ã–NCELÄ°KLÄ° KONULARI EKLE
    if week_number > 1:
        priority_topics = get_priority_topics_from_previous_weeks(pending_topics)
        
        for topic in priority_topics:
            topic_name = topic.get('topic', '')
            if topic_name not in completed_topic_names:
                all_remaining_topics.insert(0, topic)
    
    # ğŸ¯ AKILLI DENGELI SEÃ‡Ä°M: ZorlanÄ±lan derslere Ã¶ncelik + Her dersten dengeli daÄŸÄ±lÄ±m
    if not user_data:
        # user_data yoksa basit limit
        return all_remaining_topics[:18]
    
    smart_topics = get_smart_balanced_topics(all_remaining_topics, user_data, weekly_limit=18)
    return smart_topics

def get_numerical_weekly_topics(week_number, completed_topics, pending_topics, user_data=None):
    """ğŸ¯ AKILLI SayÄ±sal HaftalÄ±k Konu SeÃ§ici - Dengeli DaÄŸÄ±lÄ±m + ZorlanÄ±lan Derslere Ã–ncelik"""
    if week_number > 18:
        week_number = 18  # Max 18 hafta
    
    # ğŸ†• DÃœZELTÄ°LDÄ°: TamamlanmÄ±ÅŸ konu isimlerini al
    if isinstance(completed_topics, tuple):
        completed_topics_list, completed_topic_names = completed_topics
    else:
        completed_topic_names = set()
        if completed_topics:
            for topic in completed_topics:
                topic_name = topic.get('topic', '') if isinstance(topic, dict) else str(topic)
                if topic_name:
                    completed_topic_names.add(topic_name)
    
    # ğŸ”¥ KRÄ°TÄ°K: topic_progress'den gerÃ§ek net deÄŸerlerini al
    topic_progress = {}
    if user_data:
        import json
        topic_progress_str = user_data.get('topic_progress', '{}')
        topic_progress = json.loads(topic_progress_str) if topic_progress_str else {}
    
    # ğŸ¯ ADIM 1: O HAFTANIN STRATEJÄ°SÄ°NDEKÄ° DERSLERÄ° TESPIT ET
    current_week_plan = NUMERICAL_WEEKLY_PLAN.get(week_number, {})
    current_week_subjects = set(current_week_plan.get('topics', {}).keys())
    
    # ğŸ”¥ ADIM 2: SADECE BU DERSLERÄ°N KALAN KONULARINI TOPLA (TÃœM HAFTALARDAN)
    all_remaining_topics = []
    
    for wk in range(1, 19):  # TÃ¼m 18 haftayÄ± tara
        week_plan = NUMERICAL_WEEKLY_PLAN.get(wk, {})
        planned_topics = week_plan.get('topics', {})
        
        for subject, topic_list in planned_topics.items():
            # âœ… SADECE BU HAFTANIN STRATEJÄ°SÄ°NDEKÄ° DERSLERÄ° AL
            if subject not in current_week_subjects:
                continue  # Bu ders bu haftanÄ±n stratejisinde yok, atla
            
            for topic in topic_list:
                if topic in completed_topic_names:
                    continue
                
                real_net = 0
                for key, value in topic_progress.items():
                    if topic in key or (" - " in topic and topic.split(" - ")[1] in key):
                        if isinstance(value, dict):
                            real_net = int(float(value.get('net', 0)))
                        else:
                            try:
                                real_net = int(float(str(value)))
                            except:
                                real_net = 0
                        break
                
                # ğŸ¯ YENÄ°: YÃ¼ksek netlileri atla (bÃ¼yÃ¼k oranda tamamlanmÄ±ÅŸ)
                if real_net >= 15:
                    continue
                
                all_remaining_topics.append({
                    'subject': subject,
                    'topic': topic,
                    'week': wk,
                    'priority': 'normal',
                    'difficulty': get_topic_difficulty_by_name(topic),
                    'status': 'planned',
                    'net': real_net,
                    'detail': ''
                })
    
    # Ã–NCEKÄ° HAFTALARDAKÄ° KALAN Ã–NCELÄ°KLÄ° KONULARI EKLE
    if week_number > 1:
        priority_topics = get_priority_topics_from_previous_weeks(pending_topics)
        
        for topic in priority_topics:
            topic_name = topic.get('topic', '')
            if topic_name not in completed_topic_names:
                all_remaining_topics.insert(0, topic)
    
    # ğŸ¯ AKILLI DENGELI SEÃ‡Ä°M
    if not user_data:
        return all_remaining_topics[:20]  # SayÄ±sal iÃ§in 20 konu
    
    smart_topics = get_smart_balanced_topics(all_remaining_topics, user_data, weekly_limit=20)
    return smart_topics

def get_tyt_msu_weekly_topics(week_number, completed_topics, pending_topics, user_data=None):
    """TYT & MSÃœ iÃ§in haftalÄ±k konularÄ± getirir - SON DÃœZELTÄ°LDÄ°"""
    if week_number > 9:
        week_number = 9  # Max 9 hafta
    
    week_plan = TYT_MSU_WEEKLY_PLAN.get(week_number, {})
    weekly_topics = []
    
    # ğŸ†• DÃœZELTÄ°LDÄ°: TamamlanmÄ±ÅŸ konu isimlerini al (completed_topics artÄ±k tuple dÃ¶ndÃ¼rÃ¼yor)
    if isinstance(completed_topics, tuple):
        completed_topics_list, completed_topic_names = completed_topics
    else:
        # Eski format ile uyumluluk
        completed_topic_names = set()
        if completed_topics:
            for topic in completed_topics:
                topic_name = topic.get('topic', '') if isinstance(topic, dict) else str(topic)
                if topic_name:
                    completed_topic_names.add(topic_name)
    
    # Alt kategori bilgisini al
    sub_category = user_data.get('tyt_msu_sub_category', '') if user_data else ''
    
    # ğŸ”¥ KRÄ°TÄ°K: topic_progress'den gerÃ§ek net deÄŸerlerini al
    topic_progress = {}
    if user_data:
        import json
        topic_progress_str = user_data.get('topic_progress', '{}')
        topic_progress = json.loads(topic_progress_str) if topic_progress_str else {}
    
    # Bu haftanÄ±n planlanmÄ±ÅŸ konularÄ±nÄ± al
    planned_topics = week_plan.get('topics', {})
    
    # Alt kategoriye gÃ¶re konu Ã¶nceliklendirmesi
    priority_subjects = []
    if sub_category.startswith('MSÃœ'):
        # MSÃœ Ã¶ÄŸrencileri iÃ§in matematik ve fen bilimleri Ã¶ncelikli
        priority_subjects = ['TYT Matematik', 'TYT Fizik', 'TYT Kimya']
    elif 'Bilgisayar' in sub_category or 'Teknoloji' in sub_category:
        # Teknoloji alanÄ± iÃ§in matematik ve fizik Ã¶ncelikli  
        priority_subjects = ['TYT Matematik', 'TYT Fizik']
    elif 'TÄ±bbi' in sub_category or 'SaÄŸlÄ±k' in sub_category or 'Anestezi' in sub_category or 'ATT' in sub_category:
        # SaÄŸlÄ±k alanÄ± iÃ§in biyoloji ve kimya Ã¶ncelikli
        priority_subjects = ['TYT Biyoloji', 'TYT Kimya']
    
    # Ã–nce Ã¶ncelikli dersleri ekle
    for subject in priority_subjects:
        if subject in planned_topics:
            topic_list = planned_topics[subject]
            for topic in topic_list:
                # ğŸ†• DÃœZELTÄ°LDÄ°: TamamlanmÄ±ÅŸ konularÄ± ATLA
                if topic in completed_topic_names:
                    continue
                
                # ğŸ”¥ KRÄ°TÄ°K: GerÃ§ek net deÄŸerini bul
                real_net = 0
                for key, value in topic_progress.items():
                    if topic in key or (" - " in topic and topic.split(" - ")[1] in key):
                        if isinstance(value, dict):
                            real_net = int(float(value.get('net', 0)))
                        else:
                            try:
                                real_net = int(float(str(value)))
                            except:
                                real_net = 0
                        break
                
                # ğŸ¯ YENÄ°: YÃ¼ksek netlileri atla (bÃ¼yÃ¼k oranda tamamlanmÄ±ÅŸ)
                if real_net >= 15:
                    continue
                
                weekly_topics.append({
                    'subject': subject,
                    'topic': topic,
                    'week': week_number,
                    'priority': 'high',  # YÃ¼ksek Ã¶ncelik
                    'difficulty': get_topic_difficulty_by_name(topic),
                    'status': 'planned',
                    'net': real_net,  # ğŸ”¥ GerÃ§ek net deÄŸeri!
                    'detail': f'â­ {sub_category} iÃ§in Ã¶ncelikli'
                })
    
    # Sonra diÄŸer dersleri ekle
    for subject, topic_list in planned_topics.items():
        if subject not in priority_subjects:  # Ã–ncelikli olmayanlar
            for topic in topic_list:
                # ğŸ†• DÃœZELTÄ°LDÄ°: TamamlanmÄ±ÅŸ konularÄ± ATLA
                if topic in completed_topic_names:
                    continue
                
                # ğŸ”¥ KRÄ°TÄ°K: GerÃ§ek net deÄŸerini bul
                real_net = 0
                for key, value in topic_progress.items():
                    if topic in key or (" - " in topic and topic.split(" - ")[1] in key):
                        if isinstance(value, dict):
                            real_net = int(float(value.get('net', 0)))
                        else:
                            try:
                                real_net = int(float(str(value)))
                            except:
                                real_net = 0
                        break
                
                # ğŸ¯ YENÄ°: YÃ¼ksek netlileri atla (bÃ¼yÃ¼k oranda tamamlanmÄ±ÅŸ)
                if real_net >= 15:
                    continue
                
                weekly_topics.append({
                    'subject': subject,
                    'topic': topic,
                    'week': week_number,
                    'priority': 'normal',
                    'difficulty': get_topic_difficulty_by_name(topic),
                    'status': 'planned',
                    'net': real_net,  # ğŸ”¥ GerÃ§ek net deÄŸeri!
                    'detail': ''
                })
    
    # Sadece 2. hafta ve sonrasÄ±nda Ã¶nceki haftalardan kalan konularÄ± ekle
    if week_number > 1:
        priority_topics = get_priority_topics_from_previous_weeks(pending_topics)
        
        # ğŸ†• DÃœZELTÄ°LDÄ°: Ã–ncelikli konularÄ± da kontrol et
        for topic in priority_topics:
            topic_name = topic.get('topic', '')
            if topic_name not in completed_topic_names:
                topic['priority'] = 'high'
                weekly_topics.insert(0, topic)
    
    return weekly_topics

def get_verbal_weekly_topics(week_number, completed_topics, pending_topics, user_data=None):
    """SÃ¶zel iÃ§in haftalÄ±k konularÄ± getirir - SON DÃœZELTÄ°LDÄ°"""
    if week_number > 14:
        week_number = 14  # Max 14 hafta
    
    week_plan = VERBAL_WEEKLY_PLAN.get(week_number, {})
    weekly_topics = []
    
    # ğŸ†• DÃœZELTÄ°LDÄ°: TamamlanmÄ±ÅŸ konu isimlerini al (completed_topics artÄ±k tuple dÃ¶ndÃ¼rÃ¼yor)
    if isinstance(completed_topics, tuple):
        completed_topics_list, completed_topic_names = completed_topics
    else:
        # Eski format ile uyumluluk
        completed_topic_names = set()
        if completed_topics:
            for topic in completed_topics:
                topic_name = topic.get('topic', '') if isinstance(topic, dict) else str(topic)
                if topic_name:
                    completed_topic_names.add(topic_name)
    
    # ğŸ”¥ KRÄ°TÄ°K: topic_progress'den gerÃ§ek net deÄŸerlerini al
    topic_progress = {}
    if user_data:
        import json
        topic_progress_str = user_data.get('topic_progress', '{}')
        topic_progress = json.loads(topic_progress_str) if topic_progress_str else {}
    
    # Bu haftanÄ±n planlanmÄ±ÅŸ konularÄ±nÄ± al
    planned_topics = week_plan.get('topics', {})
    
    # KonularÄ± birleÅŸtir
    for subject, topic_list in planned_topics.items():
        for topic in topic_list:
            # ğŸ†• DÃœZELTÄ°LDÄ°: TamamlanmÄ±ÅŸ konularÄ± ATLA
            if topic in completed_topic_names:
                continue
            
            # ğŸ”¥ KRÄ°TÄ°K: GerÃ§ek net deÄŸerini bul
            real_net = 0
            for key, value in topic_progress.items():
                if topic in key or (" - " in topic and topic.split(" - ")[1] in key):
                    if isinstance(value, dict):
                        real_net = int(float(value.get('net', 0)))
                    else:
                        try:
                            real_net = int(float(str(value)))
                        except:
                            real_net = 0
                    break
            
            weekly_topics.append({
                'subject': subject,
                'topic': topic,
                'week': week_number,
                'priority': 'normal',
                'difficulty': get_topic_difficulty_by_name(topic),
                'status': 'planned',
                'net': real_net,  # ğŸ”¥ GerÃ§ek net deÄŸeri!
                'detail': ''
            })
    
    # Sadece 2. hafta ve sonrasÄ±nda Ã¶nceki haftalardan kalan konularÄ± ekle
    if week_number > 1:
        priority_topics = get_priority_topics_from_previous_weeks(pending_topics)
        
        # ğŸ†• DÃœZELTÄ°LDÄ°: Ã–ncelikli konularÄ± da kontrol et
        for topic in priority_topics:
            topic_name = topic.get('topic', '')
            if topic_name not in completed_topic_names:
                topic['priority'] = 'high'
                weekly_topics.insert(0, topic)
    
    return weekly_topics

def get_priority_topics_from_previous_weeks(pending_topics):
    """Ã–nceki haftalardan kalan Ã¶ncelikli konularÄ± dÃ¶ndÃ¼rÃ¼r"""
    priority_topics = []
    current_week = get_current_week_number()
    
    for topic in pending_topics:
        topic_week = topic.get('week', 0)
        topic_subject = topic.get('subject', '')
        
        # Sadece gerÃ§ekten Ã¶nceki haftalardan kalan TYT konularÄ±nÄ± al
        # AYT konularÄ± zamanÄ± gelmeden Ã¶nceki hafta sayÄ±lmasÄ±n
        if (topic.get('status') == 'incomplete' and 
            topic_week > 0 and topic_week < current_week and
            topic_subject.startswith('TYT')):
            priority_topics.append(topic)
    
    return priority_topics

def get_topic_difficulty_by_name(topic_name):
    """Konu adÄ±na gÃ¶re zorluk seviyesi dÃ¶ndÃ¼rÃ¼r"""
    # Konu adÄ±na gÃ¶re zorluk belirle (basit heuristic)
    if any(keyword in topic_name.lower() for keyword in ['temel', 'giriÅŸ', 'tanÄ±m', 'kavram']):
        return 2  # Kolay
    elif any(keyword in topic_name.lower() for keyword in ['problem', 'analiz', 'uygulama', 'Ã§Ã¶zÃ¼m']):
        return 4  # Zor
    elif any(keyword in topic_name.lower() for keyword in ['ileri', 'karmaÅŸÄ±k', 'detay', 'derinlemesine']):
        return 5  # Ã‡ok Zor
    else:
        return 3  # Orta

def calculate_weekly_progress_percentage(completed_topics, total_planned_topics):
    """HaftalÄ±k ilerleme yÃ¼zdesini hesaplar"""
    if total_planned_topics == 0:
        return 0
    
    return min(100, (completed_topics / total_planned_topics) * 100)

def get_flexible_topic_recommendations(user_data, current_week_progress, target_percentage=80):
    """Esnek hedef sistemi - %80 hedef ve esnek konu Ã¶nerileri"""
    
    # Mevcut hafta ilerleme durumu
    if current_week_progress >= target_percentage:
        # Hedef aÅŸÄ±ldÄ±, bir sonraki haftanÄ±n konularÄ±nÄ± Ã¶ner
        next_week_topics = get_next_week_topics(user_data)
        return {
            'status': 'ahead',
            'message': f'ğŸ‰ Bu haftanÄ±n hedefini %{current_week_progress:.1f} ile aÅŸtÄ±nÄ±z!',
            'recommendation': 'Bir sonraki haftanÄ±n konularÄ±na baÅŸlayabilirsiniz.',
            'suggested_topics': next_week_topics[:3],  # Ä°lk 3 konu
            'action': 'advance'
        }
    elif current_week_progress >= 60:
        # Ä°yi durumda, biraz daha Ã§alÄ±ÅŸarak hedefe ulaÅŸabilir
        return {
            'status': 'on_track',
            'message': f'ğŸ‘ Ä°yi gidiyorsunuz! Hedefin %{current_week_progress:.1f}Ä±ndasÄ±nÄ±z.',
            'recommendation': f'%{target_percentage} hedefe ulaÅŸmak iÃ§in biraz daha Ã§alÄ±ÅŸÄ±n.',
            'action': 'continue'
        }
    else:
        # Geride, Ã¶ncelikli konulara odaklanmalÄ±
        return {
            'status': 'behind',
            'message': f'âš ï¸ Bu hafta %{current_week_progress:.1f} ilerleme saÄŸladÄ±nÄ±z.',
            'recommendation': 'Ã–ncelikli konulara odaklanÄ±n, tÃ¼m konularÄ± bitirmeye Ã§alÄ±ÅŸmayÄ±n.',
            'action': 'focus_priority'
        }

def get_next_week_topics(user_data):
    """Bir sonraki haftanÄ±n konularÄ±nÄ± dÃ¶ndÃ¼rÃ¼r"""
    current_week = get_current_week_number()
    student_field = user_data.get('field', '')
    
    if student_field == 'EÅŸit AÄŸÄ±rlÄ±k':
        next_week_plan = EQUAL_WEIGHT_WEEKLY_PLAN.get(current_week + 1, {})
        topics = []
        
        planned_topics = next_week_plan.get('topics', {})
        for subject, topic_list in planned_topics.items():
            for topic in topic_list[:2]:  # Her dersten ilk 2 konu
                topics.append({
                    'subject': subject,
                    'topic': topic,
                    'week': current_week + 1,
                    'priority': 'next_week'
                })
        
        return topics
    
    return []

def advance_equal_weight_week(user_data):
    """EÅŸit aÄŸÄ±rlÄ±k Ã¶ÄŸrencisinin haftasÄ±nÄ± bir ileri alÄ±r"""
    if user_data.get('field') == 'EÅŸit AÄŸÄ±rlÄ±k':
        current_week = user_data.get('equal_weight_current_week', 1)
        if current_week < 16:
            user_data['equal_weight_current_week'] = current_week + 1
            return True
    return False

def get_current_week_number():
    """Mevcut hafta numarasÄ±nÄ± dÃ¶ndÃ¼rÃ¼r"""
    # EÄŸer session state'te kullanÄ±cÄ± verileri varsa ve eÅŸit aÄŸÄ±rlÄ±k Ã¶ÄŸrencisiyse
    if 'user_data' in st.session_state:
        user_data = st.session_state.user_data
        if user_data.get('field') == 'EÅŸit AÄŸÄ±rlÄ±k':
            return user_data.get('equal_weight_current_week', 1)
    
    # DiÄŸer Ã¶ÄŸrenciler iÃ§in normal takvim haftasÄ±
    week_info = get_current_week_info()
    return week_info.get('week_number', 1)

def get_weekly_din_felsefe_topics(week_number):
    """3. haftadan itibaren TYT Din ve Felsefe konularÄ±nÄ± haftalÄ±k 2-3 konu olarak dÃ¶ndÃ¼rÃ¼r"""
    topics = []
    
    if week_number < 3:
        return topics
    
    # Her hafta iÃ§in Din ve Felsefe konularÄ±nÄ± belirle
    week_offset = week_number - 3  # 3. haftadan baÅŸladÄ±ÄŸÄ± iÃ§in
    
    # TYT Felsefe konularÄ±
    felsefe_topics = [
        "Felsefenin Konusu", "Bilgi Felsefesi (Epistemoloji)", "VarlÄ±k Felsefesi (Ontoloji)",
        "Din, KÃ¼ltÃ¼r ve Medeniyet", "Ahlak Felsefesi", "Sanat Felsefesi",
        "Din Felsefesi", "Siyaset Felsefesi", "Bilim Felsefesi", "Ä°lk Ã‡aÄŸ Felsefesi",
        "Sokrates ve Felsefesi", "Platon ve Felsefesi", "Aristoteles ve Felsefesi",
        "Orta Ã‡aÄŸ Felsefesi", "Ä°slam Felsefesi (Farabi, Ä°bn Sina)"
    ]
    
    # TYT Din KÃ¼ltÃ¼rÃ¼ konularÄ± 
    din_topics = [
        "Ä°nsan ve Din (Ä°nanÃ§)", "Ahlak", "Ä°badet", "Peygamberlik",
        "Kutsal Kitaplar", "Ahiret Ä°nancÄ±", "Dinler Tarihi", "Ä°slam Tarihi",
        "Hz. Muhammed'in HayatÄ±", "Temel Dini Kavramlar"
    ]
    
    # Bu hafta iÃ§in konularÄ± seÃ§ (hafta baÅŸÄ±na 2-3 konu)
    felsefe_start = (week_offset * 2) % len(felsefe_topics)
    din_start = (week_offset * 2) % len(din_topics)
    
    # Felsefe'den 1-2 konu
    for i in range(2):
        idx = (felsefe_start + i) % len(felsefe_topics)
        topics.append({
            'subject': 'TYT Felsefe',
            'topic': felsefe_topics[idx],
            'week': week_number,
            'priority': 'normal',
            'difficulty': 3,
            'status': 'planned'
        })
    
    # Din'den 1 konu
    din_idx = din_start % len(din_topics)
    topics.append({
        'subject': 'TYT Din KÃ¼ltÃ¼rÃ¼',
        'topic': din_topics[din_idx],
        'week': week_number,
        'priority': 'normal', 
        'difficulty': 2,
        'status': 'planned'
    })
    
    return topics

def get_review_topics_for_equal_weight(user_data):
    """EÅŸit AÄŸÄ±rlÄ±k Ã¶ÄŸrencileri iÃ§in tekrar konularÄ±nÄ± dÃ¶ndÃ¼rÃ¼r"""
    review_topics = []
    
    # Mastery sisteminden tekrar zamanÄ± gelen konularÄ± al
    mastery_topics = get_pending_review_topics(user_data)
    
    # EÅŸit AÄŸÄ±rlÄ±k iÃ§in maksimum 8 tekrar konu
    review_topics = mastery_topics[:8]
    
    return review_topics

def show_grade_and_target_dashboard(weekly_plan, user_data):
    """SÄ±nÄ±f ve hedef bÃ¶lÃ¼m bazlÄ± strateji dashboard'u"""
    grade_strategy = weekly_plan.get('grade_strategy', {})
    student_grade = user_data.get('grade', '12. SÄ±nÄ±f')
    target_department = user_data.get('target', 'VarsayÄ±lan')
    
    st.markdown("### ğŸ¯ KÄ°ÅÄ°SEL STRATEJÄ° BÄ°LGÄ°LERÄ°NÄ°Z")
    
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        st.metric(
            "ğŸ“ SÄ±nÄ±fÄ±nÄ±z",
            student_grade,
            help="SÄ±nÄ±fÄ±nÄ±za Ã¶zel strateji uygulanÄ±yor"
        )
    
    with col2:
        st.metric(
            "ğŸ¯ Hedef BÃ¶lÃ¼m",
            target_department,
            help=f"Zorluk Seviyesi: {grade_strategy.get('difficulty_level', 1)}/5"
        )
    
    with col3:
        # KaldÄ±rÄ±ldÄ±: Sabit hedef net gÃ¶sterimi
        # Focus deÄŸerini TÃ¼rkÃ§eleÅŸtir
        focus_raw = grade_strategy.get('focus', 'Denge')
        focus_mapping = {
            'eksik_kapama_ve_performans_artirma': 'Konu Tamamlama & Performans',
            'eksik_kapama_ve_performans_artÄ±rma': 'Konu Tamamlama & Performans',
            'konu_tamamlama': 'Konu Tamamlama',
            'deneme_odaklÄ±': 'Deneme OdaklÄ±',
            'maksimum': 'Maksimum',
            'normal': 'Normal',
            'rahat': 'Rahat'
        }
        focus_display = focus_mapping.get(focus_raw.lower(), focus_raw[:15])
        st.metric(
            "ğŸ‘ Hedef YaklaÅŸÄ±m",
            focus_display,
            help="Sana Ã¶zel strateji yaklaÅŸÄ±mÄ±"
        )
    
    with col4:
        # KaldÄ±rÄ±ldÄ±: Sabit hedef net gÃ¶sterimi
        # Study pace deÄŸerini TÃ¼rkÃ§eleÅŸtir
        pace_raw = grade_strategy.get('study_pace', 'Normal')
        pace_mapping = {
            'maksimum': 'Maksimum',
            'hÄ±zlÄ±': 'HÄ±zlÄ±',
            'normal': 'Normal',
            'rahat': 'Rahat'
        }
        pace_display = pace_mapping.get(pace_raw.lower(), pace_raw)
        st.metric(
            "ğŸ“Š Ã‡alÄ±ÅŸma Temposu",
            pace_display,
            help="Sana Ã¶zel Ã§alÄ±ÅŸma hÄ±zÄ±"
        )
    
    # Strateji detaylarÄ±
    st.info(f"""
    **ğŸ“‹ {student_grade} Strateji DetaylarÄ±:**
    â€¢ **Odak:** {grade_strategy.get('focus', 'Konu tamamlama')}
    â€¢ **Ã‡alÄ±ÅŸma HÄ±zÄ±:** {grade_strategy.get('study_pace', 'Normal')}
    â€¢ **HaftalÄ±k Konu BazÄ±:** {grade_strategy.get('weekly_topic_base', 10)} konu
    â€¢ **Tekrar OranÄ±:** %{int(grade_strategy.get('review_ratio', 0.3) * 100)} tekrar
    â€¢ **Ã–zel Notlar:** {grade_strategy.get('special_notes', 'Standart program')}
    """)

def show_equal_weight_special_dashboard(weekly_plan, user_data):
    """EÅŸit AÄŸÄ±rlÄ±k Ã¶zel planÄ± dashboard'u"""
    current_week = weekly_plan.get('current_week', 1)
    total_weeks = weekly_plan.get('total_weeks', 16)
    flexible_rec = weekly_plan.get('flexible_recommendation', {})
    
    # EÅŸit aÄŸÄ±rlÄ±k hafta verisini garantile
    if 'equal_weight_current_week' not in user_data:
        user_data['equal_weight_current_week'] = 1
        update_user_in_firebase(st.session_state.current_user, {'equal_weight_current_week': 1})
    
    st.markdown("### ğŸ“š EÅÄ°T AÄIRLIK Ã–ZEL PLANI")
    
    # Ä°lerleme Ã§ubuÄŸu
    progress = min(100, (current_week / total_weeks) * 100)
    st.progress(progress / 100)
    
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        st.metric(
            "ğŸ“… Mevcut Hafta",
            f"{current_week}/16",
            help="16 haftalÄ±k detay planÄ±nÄ±n hangi haftasÄ±ndasÄ±nÄ±z"
        )
    
    with col2:
        week_plan = EQUAL_WEIGHT_WEEKLY_PLAN.get(current_week, {})
        st.metric(
            "ğŸ¯ Bu Hafta Odak",
            week_plan.get('focus', 'Belirlenmedi')[:20] + "..." if len(week_plan.get('focus', '')) > 20 else week_plan.get('focus', 'Belirlenmedi'),
            help=week_plan.get('focus', 'Bu haftanÄ±n odak konusu')
        )
    
    with col3:
        weekly_topics = weekly_plan.get('new_topics', [])
        st.metric(
            "ğŸ“š Bu Hafta Konu",
            len(weekly_topics),
            help="Bu hafta planlanmÄ±ÅŸ toplam konu sayÄ±sÄ±"
        )
    
    with col4:
        target_percentage = 80
        st.metric(
            "ğŸ¯ Hedef BaÅŸarÄ±",
            f"%{target_percentage}",
            help="HaftalÄ±k baÅŸarÄ± hedefi"
        )
    
    # ğŸš€ HAFTA Ä°LERLEME BUTONU
    st.markdown("")
    col_btn1, col_btn2, col_btn3 = st.columns([1, 2, 1])
    
    with col_btn2:
        if current_week < total_weeks:
            if st.button(f"âœ… HaftayÄ± Bitir ve {current_week + 1}. Haftaya GeÃ§", 
                        key="advance_equal_weight", 
                        help=f"Mevcut hafta ({current_week}) tamamlandÄ±, bir sonraki haftaya geÃ§",
                        use_container_width=True):
                # HaftayÄ± ileri al
                new_week = current_week + 1
                user_data['equal_weight_current_week'] = new_week
                update_user_in_firebase(st.session_state.current_user, {'equal_weight_current_week': new_week})
                st.success(f"ğŸ‰ {new_week}. haftaya geÃ§ildi!")
                st.rerun()
        else:
            st.success("ğŸ† 16 haftalÄ±k EÅŸit AÄŸÄ±rlÄ±k planÄ±nÄ± tamamladÄ±nÄ±z! Tebrikler!")
    
    st.markdown("")
    
    # Esnek hedef sistemi Ã¶nerileri
    if flexible_rec:
        status = flexible_rec.get('status', 'on_track')
        message = flexible_rec.get('message', '')
        recommendation = flexible_rec.get('recommendation', '')
        
        if status == 'ahead':
            st.success(f"ğŸ‰ {message}")
            st.info(f"ğŸ’¡ **Ã–neri:** {recommendation}")
            
            # Bir sonraki haftanÄ±n konularÄ±nÄ± gÃ¶ster
            suggested_topics = flexible_rec.get('suggested_topics', [])
            if suggested_topics:
                st.markdown("**ğŸ”¥ Bir Sonraki Haftadan BaÅŸlayabileceÄŸiniz Konular:**")
                for topic in suggested_topics:
                    st.write(f"â€¢ **{topic['subject']}:** {topic['topic']}")
                    
        elif status == 'on_track':
            st.info(f"ğŸ‘ {message}")
            st.write(f"ğŸ’¡ **Ã–neri:** {recommendation}")
            
        else:  # behind
            st.warning(f"âš ï¸ {message}")
            st.write(f"ğŸ’¡ **Ã–neri:** {recommendation}")
    
    # Bu haftanÄ±n detay planÄ±nÄ± gÃ¶ster
    if current_week <= 16:
        with st.expander(f"ğŸ“‹ {current_week}. Hafta Detay PlanÄ±", expanded=False):
            week_detail = EQUAL_WEIGHT_WEEKLY_PLAN.get(current_week, {})
            topics_by_subject = week_detail.get('topics', {})
            
            # ğŸ”¥ KRÄ°TÄ°K: TamamlanmÄ±ÅŸ konularÄ± al ve filtrele
            completed_topics_list, completed_topic_names = get_completed_topics_from_user_data(user_data)
            
            for subject, topics in topics_by_subject.items():
                # Bu dersten gÃ¶sterilecek konularÄ± filtrele
                filtered_topics = [t for t in topics if t not in completed_topic_names]
                
                if filtered_topics:  # Sadece kalan konular varsa gÃ¶ster
                    st.markdown(f"**ğŸ”¸ {subject}:**")
                    for topic in filtered_topics:
                        difficulty = get_topic_difficulty_by_name(topic)
                        difficulty_info = TOPIC_DIFFICULTY_SYSTEM.get(difficulty, TOPIC_DIFFICULTY_SYSTEM[3])
                        st.write(f"â€¢ {topic} {difficulty_info['icon']}")
                    st.write("")
            
            # EÄŸer tÃ¼m konular tamamlanmÄ±ÅŸsa
            all_topics_count = sum(len(topics) for topics in topics_by_subject.values())
            remaining_topics_count = sum(len([t for t in topics if t not in completed_topic_names]) for topics in topics_by_subject.values())
            if remaining_topics_count == 0:
                st.success(f"ğŸ‰ {current_week}. haftanÄ±n tÃ¼m konularÄ±nÄ± tamamladÄ±nÄ±z! Tebrikler!")
    
    # DEBUG: Mevcut haftalÄ±k planÄ± gÃ¶ster
    with st.expander("ğŸ”§ DEBUG: Mevcut HaftalÄ±k Plan KontrolÃ¼", expanded=False):
        st.write(f"**User Data equal_weight_current_week:** {user_data.get('equal_weight_current_week', 'YOK')}")
        st.write(f"**Weekly Plan current_week:** {weekly_plan.get('current_week', 'YOK')}")
        st.write(f"**Weekly Plan new_topics count:** {len(weekly_plan.get('new_topics', []))}")
        
        new_topics = weekly_plan.get('new_topics', [])
        if new_topics:
            st.write("**Bu haftanÄ±n konularÄ±:**")
            for topic in new_topics[:5]:  # Ä°lk 5 konu
                st.write(f"â€¢ {topic.get('subject', 'UNKNOWN')}: {topic.get('topic', 'UNKNOWN')}")
            if len(new_topics) > 5:
                st.write(f"... ve {len(new_topics) - 5} konu daha")
        else:
            st.error("HiÃ§ konu bulunamadÄ±!")

def show_numerical_special_dashboard(weekly_plan, user_data):
    """SayÄ±sal Ã¶zel planÄ± dashboard'u"""
    current_week = weekly_plan.get('current_week', 1)
    total_weeks = weekly_plan.get('total_weeks', 18)
    flexible_rec = weekly_plan.get('flexible_recommendation', {})
    
    # SayÄ±sal hafta verisini garantile
    if 'numerical_current_week' not in user_data:
        user_data['numerical_current_week'] = 1
        update_user_in_firebase(st.session_state.current_user, {'numerical_current_week': 1})
    
    st.markdown("### ğŸ”¬ SAYISAL Ã–ZEL PLANI")
    
    # Ä°lerleme Ã§ubuÄŸu
    progress = min(100, (current_week / total_weeks) * 100)
    st.progress(progress / 100)
    
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        st.metric(
            "ğŸ“… Mevcut Hafta",
            f"{current_week}/18",
            help="18 haftalÄ±k detay planÄ±nÄ±n hangi haftasÄ±ndasÄ±nÄ±z"
        )
    
    with col2:
        week_plan = NUMERICAL_WEEKLY_PLAN.get(current_week, {})
        st.metric(
            "ğŸ¯ Bu Hafta Odak",
            week_plan.get('focus', 'Belirlenmedi')[:20] + "..." if len(week_plan.get('focus', '')) > 20 else week_plan.get('focus', 'Belirlenmedi'),
            help=week_plan.get('focus', 'Bu haftanÄ±n odak konusu')
        )
    
    with col3:
        weekly_topics = weekly_plan.get('new_topics', [])
        st.metric(
            "ğŸ“š Bu Hafta Konu",
            len(weekly_topics),
            help="Bu hafta planlanmÄ±ÅŸ toplam konu sayÄ±sÄ±"
        )
    
    with col4:
        target_percentage = 80
        st.metric(
            "ğŸ¯ Hedef BaÅŸarÄ±",
            f"%{target_percentage}",
            help="HaftalÄ±k baÅŸarÄ± hedefi"
        )
    
    # ğŸš€ HAFTA Ä°LERLEME BUTONU
    st.markdown("")
    col_btn1, col_btn2, col_btn3 = st.columns([1, 2, 1])
    
    with col_btn2:
        if current_week < total_weeks:
            if st.button(f"âœ… HaftayÄ± Bitir ve {current_week + 1}. Haftaya GeÃ§", 
                        key="advance_numerical", 
                        help=f"Mevcut hafta ({current_week}) tamamlandÄ±, bir sonraki haftaya geÃ§",
                        use_container_width=True):
                # HaftayÄ± ileri al
                new_week = current_week + 1
                user_data['numerical_current_week'] = new_week
                update_user_in_firebase(st.session_state.current_user, {'numerical_current_week': new_week})
                st.success(f"ğŸ‰ {new_week}. haftaya geÃ§ildi!")
                st.rerun()
        else:
            st.success("ğŸ† 18 haftalÄ±k SayÄ±sal planÄ±nÄ± tamamladÄ±nÄ±z! Tebrikler!")
    
    st.markdown("")
    
    # Esnek hedef sistemi Ã¶nerileri
    if flexible_rec:
        status = flexible_rec.get('status', 'on_track')
        message = flexible_rec.get('message', '')
        recommendation = flexible_rec.get('recommendation', '')
        
        if status == 'ahead':
            st.success(f"ğŸ‰ {message}")
            st.info(f"ğŸ’¡ **Ã–neri:** {recommendation}")
            
            # Bir sonraki haftanÄ±n konularÄ±nÄ± gÃ¶ster
            suggested_topics = flexible_rec.get('suggested_topics', [])
            if suggested_topics:
                st.markdown("**ğŸ”¥ Bir Sonraki Haftadan BaÅŸlayabileceÄŸiniz Konular:**")
                for topic in suggested_topics:
                    st.write(f"â€¢ **{topic['subject']}:** {topic['topic']}")
                    
        elif status == 'on_track':
            st.info(f"ğŸ‘ {message}")
            st.write(f"ğŸ’¡ **Ã–neri:** {recommendation}")
            
        else:  # behind
            st.warning(f"âš ï¸ {message}")
            st.write(f"ğŸ’¡ **Ã–neri:** {recommendation}")
    
    # Bu haftanÄ±n detay planÄ±nÄ± gÃ¶ster
    if current_week <= 18:
        with st.expander(f"ğŸ“‹ {current_week}. Hafta Detay PlanÄ±", expanded=False):
            week_detail = NUMERICAL_WEEKLY_PLAN.get(current_week, {})
            topics_by_subject = week_detail.get('topics', {})
            
            # ğŸ”¥ KRÄ°TÄ°K: TamamlanmÄ±ÅŸ konularÄ± al ve filtrele
            completed_topics_list, completed_topic_names = get_completed_topics_from_user_data(user_data)
            
            for subject, topics in topics_by_subject.items():
                # Bu dersten gÃ¶sterilecek konularÄ± filtrele
                filtered_topics = [t for t in topics if t not in completed_topic_names]
                
                if filtered_topics:  # Sadece kalan konular varsa gÃ¶ster
                    st.markdown(f"**ğŸ”¸ {subject}:**")
                    for topic in filtered_topics:
                        difficulty = get_topic_difficulty_by_name(topic)
                        difficulty_info = TOPIC_DIFFICULTY_SYSTEM.get(difficulty, TOPIC_DIFFICULTY_SYSTEM[3])
                        st.write(f"â€¢ {topic} {difficulty_info['icon']}")
                    st.write("")
            
            # EÄŸer tÃ¼m konular tamamlanmÄ±ÅŸsa
            all_topics_count = sum(len(topics) for topics in topics_by_subject.values())
            remaining_topics_count = sum(len([t for t in topics if t not in completed_topic_names]) for topics in topics_by_subject.values())
            if remaining_topics_count == 0:
                st.success(f"ğŸ‰ {current_week}. haftanÄ±n tÃ¼m konularÄ±nÄ± tamamladÄ±nÄ±z! Tebrikler!")
    
    # DEBUG: Mevcut haftalÄ±k planÄ± gÃ¶ster
    with st.expander("ğŸ”§ DEBUG: Mevcut HaftalÄ±k Plan KontrolÃ¼", expanded=False):
        st.write(f"**User Data numerical_current_week:** {user_data.get('numerical_current_week', 'YOK')}")
        st.write(f"**Weekly Plan current_week:** {weekly_plan.get('current_week', 'YOK')}")
        st.write(f"**Weekly Plan new_topics count:** {len(weekly_plan.get('new_topics', []))}")
        
        new_topics = weekly_plan.get('new_topics', [])
        if new_topics:
            st.write("**Bu haftanÄ±n konularÄ±:**")
            for topic in new_topics[:5]:  # Ä°lk 5 konu
                st.write(f"â€¢ {topic.get('subject', 'UNKNOWN')}: {topic.get('topic', 'UNKNOWN')}")
            if len(new_topics) > 5:
                st.write(f"... ve {len(new_topics) - 5} konu daha")
        else:
            st.error("HiÃ§ konu bulunamadÄ±!")

def show_tyt_msu_special_dashboard(weekly_plan, user_data):
    """TYT & MSÃœ Ã¶zel planÄ± dashboard'u"""
    current_week = weekly_plan.get('current_week', 1)
    total_weeks = weekly_plan.get('total_weeks', 9)
    flexible_rec = weekly_plan.get('flexible_recommendation', {})
    
    # Alt kategori bilgisini al
    sub_category = user_data.get('tyt_msu_sub_category', 'BelirtilmemiÅŸ')
    
    # ğŸ¨ Alt kategoriye gÃ¶re Ã¶zel arka plan stilini yÃ¼kle
    if sub_category != 'BelirtilmemiÅŸ':
        # Alt kategori iÃ§in Ã¶zel CSS yÃ¼kle
        st.markdown(get_custom_css(sub_category), unsafe_allow_html=True)
        
        # Alt kategoriye Ã¶zel baÅŸlÄ±k arka planÄ±
        bg_style = BACKGROUND_STYLES.get(sub_category, BACKGROUND_STYLES["VarsayÄ±lan"])
        category_icon = bg_style.get('icon', 'ğŸ“')
        
        st.markdown(f"""
        <div class="main-header">
            <h1>{category_icon} TYT & MSÃœ Ã–ZEL PLANI</h1>
            <p style="font-size: 1.2em; margin: 0;">ğŸ¯ <strong>{sub_category}</strong></p>
            <p style="opacity: 0.9; margin: 0.5rem 0 0 0;">Hafta {current_week}/{total_weeks} â€¢ Hedefine DoÄŸru Ä°lerle!</p>
        </div>
        """, unsafe_allow_html=True)
    else:
        # VarsayÄ±lan baÅŸlÄ±k
        st.markdown(f"### ğŸ“ TYT & MSÃœ Ã–ZEL PLANI")
    
    # TYT & MSÃœ hafta verisini garantile
    if 'tyt_msu_current_week' not in user_data:
        user_data['tyt_msu_current_week'] = 1
        update_user_in_firebase(st.session_state.current_user, {'tyt_msu_current_week': 1})
    
    # Alt kategori belirtilmemiÅŸse bilgi mesajÄ± gÃ¶ster
    if sub_category == 'BelirtilmemiÅŸ':
        st.info("â„¹ï¸ Alt kategori seÃ§imi iÃ§in profil ayarlarÄ±nÄ±zÄ± gÃ¼ncelleyin.")
    
    # Ä°lerleme Ã§ubuÄŸu
    progress = min(100, (current_week / total_weeks) * 100)
    st.progress(progress / 100)
    
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        st.metric(
            "ğŸ“… Mevcut Hafta",
            f"{current_week}/9",
            help="9 haftalÄ±k detay planÄ±nÄ±n hangi haftasÄ±ndasÄ±nÄ±z"
        )
    
    with col2:
        week_plan = TYT_MSU_WEEKLY_PLAN.get(current_week, {})
        st.metric(
            "ğŸ¯ Bu Hafta Odak",
            week_plan.get('focus', 'Belirlenmedi')[:20] + "..." if len(week_plan.get('focus', '')) > 20 else week_plan.get('focus', 'Belirlenmedi'),
            help=week_plan.get('focus', 'Bu haftanÄ±n odak konusu')
        )
    
    with col3:
        weekly_topics = weekly_plan.get('new_topics', [])
        st.metric(
            "ğŸ“š Bu Hafta Konu",
            len(weekly_topics),
            help="Bu hafta planlanmÄ±ÅŸ toplam konu sayÄ±sÄ±"
        )
    
    with col4:
        target_percentage = 80
        st.metric(
            "ğŸ¯ Hedef BaÅŸarÄ±",
            f"%{target_percentage}",
            help="HaftalÄ±k baÅŸarÄ± hedefi"
        )
    
    # ğŸš€ HAFTA Ä°LERLEME BUTONU
    st.markdown("")
    col_btn1, col_btn2, col_btn3 = st.columns([1, 2, 1])
    
    with col_btn2:
        if current_week < total_weeks:
            if st.button(f"âœ… HaftayÄ± Bitir ve {current_week + 1}. Haftaya GeÃ§", 
                        key="advance_tyt_msu", 
                        help=f"Mevcut hafta ({current_week}) tamamlandÄ±, bir sonraki haftaya geÃ§",
                        use_container_width=True):
                # HaftayÄ± ileri al
                new_week = current_week + 1
                user_data['tyt_msu_current_week'] = new_week
                update_user_in_firebase(st.session_state.current_user, {'tyt_msu_current_week': new_week})
                st.success(f"ğŸ‰ {new_week}. haftaya geÃ§ildi!")
                st.rerun()
        else:
            st.success("ğŸ† 9 haftalÄ±k TYT & MSÃœ planÄ±nÄ± tamamladÄ±nÄ±z! Tebrikler!")
    
    st.markdown("")
    
    # Esnek hedef sistemi Ã¶nerileri
    if flexible_rec:
        status = flexible_rec.get('status', 'on_track')
        message = flexible_rec.get('message', '')
        recommendation = flexible_rec.get('recommendation', '')
        
        if status == 'ahead':
            st.success(f"ğŸ‰ {message}")
            st.info(f"ğŸ’¡ **Ã–neri:** {recommendation}")
            
            # Bir sonraki haftanÄ±n konularÄ±nÄ± gÃ¶ster
            suggested_topics = flexible_rec.get('suggested_topics', [])
            if suggested_topics:
                st.markdown("**ğŸ”¥ Bir Sonraki Haftadan BaÅŸlayabileceÄŸiniz Konular:**")
                for topic in suggested_topics:
                    st.write(f"â€¢ **{topic['subject']}:** {topic['topic']}")
                    
        elif status == 'on_track':
            st.info(f"ğŸ‘ {message}")
            st.write(f"ğŸ’¡ **Ã–neri:** {recommendation}")
            
        else:  # behind
            st.warning(f"âš ï¸ {message}")
            st.write(f"ğŸ’¡ **Ã–neri:** {recommendation}")
    
    # Bu haftanÄ±n detay planÄ±nÄ± gÃ¶ster
    if current_week <= 9:
        with st.expander(f"ğŸ“‹ {current_week}. Hafta Detay PlanÄ±", expanded=False):
            week_detail = TYT_MSU_WEEKLY_PLAN.get(current_week, {})
            topics_by_subject = week_detail.get('topics', {})
            
            # ğŸ”¥ KRÄ°TÄ°K: TamamlanmÄ±ÅŸ konularÄ± al ve filtrele
            completed_topics_list, completed_topic_names = get_completed_topics_from_user_data(user_data)
            
            for subject, topics in topics_by_subject.items():
                # Bu dersten gÃ¶sterilecek konularÄ± filtrele
                filtered_topics = [t for t in topics if t not in completed_topic_names]
                
                if filtered_topics:  # Sadece kalan konular varsa gÃ¶ster
                    st.markdown(f"**ğŸ”¸ {subject}:**")
                    for topic in filtered_topics:
                        difficulty = get_topic_difficulty_by_name(topic)
                        difficulty_info = TOPIC_DIFFICULTY_SYSTEM.get(difficulty, TOPIC_DIFFICULTY_SYSTEM[3])
                        st.write(f"â€¢ {topic} {difficulty_info['icon']}")
                    st.write("")
            
            # EÄŸer tÃ¼m konular tamamlanmÄ±ÅŸsa
            all_topics_count = sum(len(topics) for topics in topics_by_subject.values())
            remaining_topics_count = sum(len([t for t in topics if t not in completed_topic_names]) for topics in topics_by_subject.values())
            if remaining_topics_count == 0:
                st.success(f"ğŸ‰ {current_week}. haftanÄ±n tÃ¼m konularÄ±nÄ± tamamladÄ±nÄ±z! Tebrikler!")
    
    # Alt kategoriye gÃ¶re Ã¶zel tavsiyeler
    if sub_category.startswith('MSÃœ'):
        st.info("ğŸ–ï¸ **MSÃœ Tavsiyeleri:** Matematik, Fizik ve Kimya konularÄ±na Ã¶ncelik verin. Ãœniform disiplini gibi Ã¼niversiteye hazÄ±rlÄ±k sÃ¼recinde dÃ¼zeni koruyun.")
    elif 'Bilgisayar' in sub_category or 'Teknoloji' in sub_category:
        st.info("ğŸ’» **Teknoloji AlanÄ± Tavsiyeleri:** Matematik ve Fizik temeli gÃ¼Ã§lÃ¼ olmalÄ±. Mesleki alanÄ±nÄ±zla ilgili temel programlama eÄŸitimine de zaman ayÄ±rÄ±n.")
    elif 'TÄ±bbi' in sub_category or 'SaÄŸlÄ±k' in sub_category or 'Anestezi' in sub_category or 'ATT' in sub_category:
        st.info("ğŸ¥ **SaÄŸlÄ±k AlanÄ± Tavsiyeleri:** Biyoloji ve Kimya konularÄ± mesleki baÅŸarÄ±nÄ±z iÃ§in kritik. Temel saÄŸlÄ±k terminolojisini de araÅŸtÄ±rÄ±n.")
    elif 'Ã‡ocuk GeliÅŸimi' in sub_category:
        st.info("ğŸ‘¶ **Ã‡ocuk GeliÅŸimi Tavsiyeleri:** Psikoloji ve eÄŸitim temelleri Ã¶nemli. Ã‡ocuk geliÅŸimi ile ilgili temel bilgileri araÅŸtÄ±rÄ±n.")
    
    # DEBUG: Mevcut haftalÄ±k planÄ± gÃ¶ster
    with st.expander("ğŸ”§ DEBUG: Mevcut HaftalÄ±k Plan KontrolÃ¼", expanded=False):
        st.write(f"**User Data tyt_msu_current_week:** {user_data.get('tyt_msu_current_week', 'YOK')}")
        st.write(f"**Sub Category:** {sub_category}")
        st.write(f"**Weekly Plan current_week:** {weekly_plan.get('current_week', 'YOK')}")
        st.write(f"**Weekly Plan new_topics count:** {len(weekly_plan.get('new_topics', []))}")
        
        new_topics = weekly_plan.get('new_topics', [])
        if new_topics:
            st.write("**Bu haftanÄ±n konularÄ±:**")
            priority_count = len([t for t in new_topics if t.get('priority') == 'high'])
            if priority_count > 0:
                st.write(f"**â­ Ã–ncelikli Konular:** {priority_count} adet")
            
            for topic in new_topics[:5]:  # Ä°lk 5 konu
                priority_icon = "â­" if topic.get('priority') == 'high' else "â€¢"
                st.write(f"{priority_icon} {topic.get('subject', 'UNKNOWN')}: {topic.get('topic', 'UNKNOWN')}")
            if len(new_topics) > 5:
                st.write(f"... ve {len(new_topics) - 5} konu daha")
        else:
            st.error("HiÃ§ konu bulunamadÄ±!")

def get_verbal_simple_topics(week_number, include_math=False):
    """SÃ¶zel planÄ± iÃ§in haftalÄ±k konularÄ± al (isteÄŸe baÄŸlÄ± matematik ile)"""
    week_plan = VERBAL_WEEKLY_PLAN.get(week_number, {})
    topics_by_subject = week_plan.get('topics', {})
    
    # TÃ¼m konularÄ± tek liste halinde topla
    all_topics = []
    for subject, topics in topics_by_subject.items():
        if subject == "TYT Matematik" and not include_math:
            continue  # Matematik istenmiyorsa atla
        
        for topic in topics:
            all_topics.append(f"{subject}: {topic}")
    
    return all_topics

def show_verbal_special_dashboard(weekly_plan, user_data):
    """SÃ¶zel Ã¶zel planÄ± dashboard'u"""
    # TYT & MSÃœ hafta verisini garantile
    if 'verbal_current_week' not in user_data:
        user_data['verbal_current_week'] = 1
        update_user_in_firebase(st.session_state.current_user, {'verbal_current_week': 1})
    
    # TYT Matematik seÃ§eneÄŸi iÃ§in session state
    if 'verbal_include_math' not in st.session_state:
        st.session_state.verbal_include_math = False
    
    current_week = user_data.get('verbal_current_week', 1)
    total_weeks = 14
    
    # ğŸ¨ SÃ¶zel iÃ§in Ã¶zel arka plan stili
    st.markdown(get_custom_css("Ã–ÄŸretmenlik"), unsafe_allow_html=True)
    
    # SÃ¶zel alan baÅŸlÄ±ÄŸÄ±
    st.markdown(f"""
    <div class="main-header">
        <h1>ğŸ“š SÃ–ZEL Ã–ZEL PLANI</h1>
        <p style="font-size: 1.2em; margin: 0;">ğŸ¯ <strong>Felsefe, Din, TÃ¼rkÃ§e, Tarih, CoÄŸrafya</strong></p>
        <p style="opacity: 0.9; margin: 0.5rem 0 0 0;">Hafta {current_week}/{total_weeks} â€¢ DÃ¼ÅŸÃ¼nce DÃ¼nyanda DerinleÅŸ!</p>
    </div>
    """, unsafe_allow_html=True)
    
    # Ä°lerleme Ã§ubuÄŸu
    progress = min(100, (current_week / total_weeks) * 100)
    st.progress(progress / 100)
    
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        st.metric(
            "ğŸ“… Mevcut Hafta",
            f"{current_week}/14",
            help="14 haftalÄ±k detay planÄ±nÄ±n hangi haftasÄ±ndasÄ±nÄ±z"
        )
    
    with col2:
        week_plan = VERBAL_WEEKLY_PLAN.get(current_week, {})
        st.metric(
            "ğŸ¯ Bu Hafta Odak",
            week_plan.get('focus', 'Belirlenmedi')[:20] + "..." if len(week_plan.get('focus', '')) > 20 else week_plan.get('focus', 'Belirlenmedi'),
            help=week_plan.get('focus', 'Bu haftanÄ±n odak konusu')
        )
    
    with col3:
        weekly_topics = get_verbal_simple_topics(current_week, st.session_state.verbal_include_math)
        st.metric(
            "ğŸ“š Bu Hafta Konu",
            len(weekly_topics),
            help="Bu hafta planlanmÄ±ÅŸ toplam konu sayÄ±sÄ±"
        )
    
    with col4:
        target_percentage = 80
        st.metric(
            "ğŸ¯ Hedef BaÅŸarÄ±",
            f"%{target_percentage}",
            help="HaftalÄ±k baÅŸarÄ± hedefi"
        )
    
    # TYT Matematik seÃ§eneÄŸi
    st.markdown("---")
    include_math = st.checkbox(
        "ğŸ”¢ TYT Matematik konularÄ±nÄ± da programa eklemek ister misiniz?", 
        value=st.session_state.verbal_include_math,
        help="Ä°steÄŸe baÄŸlÄ±: SÃ¶zel Ã¶ÄŸrenciler iÃ§in TYT Matematik desteÄŸi"
    )
    
    # SeÃ§enek deÄŸiÅŸirse session state gÃ¼ncelle
    if include_math != st.session_state.verbal_include_math:
        st.session_state.verbal_include_math = include_math
        st.rerun()
    
    st.markdown("---")
    
    # ğŸš€ HAFTA Ä°LERLEME BUTONU
    col_btn1, col_btn2, col_btn3 = st.columns([1, 2, 1])
    
    with col_btn2:
        if current_week < total_weeks:
            if st.button(f"âœ… HaftayÄ± Bitir ve {current_week + 1}. Haftaya GeÃ§", 
                        key="advance_verbal", 
                        help=f"Mevcut hafta ({current_week}) tamamlandÄ±, bir sonraki haftaya geÃ§",
                        use_container_width=True):
                # HaftayÄ± ileri al
                new_week = current_week + 1
                user_data['verbal_current_week'] = new_week
                update_user_in_firebase(st.session_state.current_user, {'verbal_current_week': new_week})
                st.success(f"ğŸ‰ {new_week}. haftaya geÃ§ildi!")
                st.rerun()
        else:
            st.success("ğŸ† 14 haftalÄ±k SÃ¶zel planÄ±nÄ± tamamladÄ±nÄ±z! Tebrikler!")
            if st.button("ğŸ”„ PlanÄ± Yeniden BaÅŸlat", use_container_width=True):
                user_data['verbal_current_week'] = 1
                update_user_in_firebase(st.session_state.current_user, {'verbal_current_week': 1})
                st.rerun()
    
    st.markdown("")
    
    # Bu haftanÄ±n detay planÄ±nÄ± gÃ¶ster
    if current_week <= 14:
        with st.expander(f"ğŸ“‹ {current_week}. Hafta Detay PlanÄ±", expanded=False):
            week_detail = VERBAL_WEEKLY_PLAN.get(current_week, {})
            topics_by_subject = week_detail.get('topics', {})
            
            # ğŸ”¥ KRÄ°TÄ°K: TamamlanmÄ±ÅŸ konularÄ± al ve filtrele
            completed_topics_list, completed_topic_names = get_completed_topics_from_user_data(user_data)
            
            for subject, topics in topics_by_subject.items():
                if subject == "TYT Matematik" and not st.session_state.verbal_include_math:
                    continue  # Matematik seÃ§ili deÄŸilse atla
                
                # Bu dersten gÃ¶sterilecek konularÄ± filtrele
                filtered_topics = [t for t in topics if t not in completed_topic_names]
                
                if filtered_topics:  # Sadece kalan konular varsa gÃ¶ster
                    st.markdown(f"**ğŸ”¸ {subject}:**")
                    for topic in filtered_topics:
                        difficulty = get_topic_difficulty_by_name(topic)
                        difficulty_info = TOPIC_DIFFICULTY_SYSTEM.get(difficulty, TOPIC_DIFFICULTY_SYSTEM[3])
                        st.write(f"â€¢ {topic} {difficulty_info['icon']}")
                    st.write("")
            
            # EÄŸer tÃ¼m konular tamamlanmÄ±ÅŸsa
            all_topics_count = sum(len(topics) for subject, topics in topics_by_subject.items() if subject != "TYT Matematik" or st.session_state.verbal_include_math)
            remaining_topics_count = sum(len([t for t in topics if t not in completed_topic_names]) for subject, topics in topics_by_subject.items() if subject != "TYT Matematik" or st.session_state.verbal_include_math)
            if remaining_topics_count == 0:
                st.success(f"ğŸ‰ {current_week}. haftanÄ±n tÃ¼m konularÄ±nÄ± tamamladÄ±nÄ±z! Tebrikler!")
    
    # SÃ¶zel iÃ§in Ã¶zel tavsiyeler
    st.info("ğŸ“š **SÃ¶zel Alan Tavsiyeleri:** Felsefe ve Din dersleri kritik Ã¶nceliÄŸe sahip. TÃ¼rkÃ§e, Tarih ve CoÄŸrafya ile bÃ¼tÃ¼nleÅŸik Ã§alÄ±ÅŸÄ±n. Analitik dÃ¼ÅŸÃ¼nce ve yorumlama becerilerinizi geliÅŸtirin.")
    
    # DEBUG: Mevcut haftalÄ±k planÄ± gÃ¶ster
    with st.expander("ğŸ”§ DEBUG: Mevcut HaftalÄ±k Plan KontrolÃ¼", expanded=False):
        st.write(f"**User Data verbal_current_week:** {user_data.get('verbal_current_week', 'YOK')}")
        st.write(f"**Matematik Dahil:** {st.session_state.verbal_include_math}")
        st.write(f"**Weekly Plan current_week:** {weekly_plan.get('current_week', 'YOK')}")
        st.write(f"**Weekly Plan new_topics count:** {len(weekly_plan.get('new_topics', []))}")
        
        new_topics = weekly_plan.get('new_topics', [])
        if new_topics:
            st.write("**Bu haftanÄ±n konularÄ±:**")
            for topic in new_topics[:5]:  # Ä°lk 5 konu
                st.write(f"â€¢ {topic.get('subject', 'UNKNOWN')}: {topic.get('topic', 'UNKNOWN')}")
            if len(new_topics) > 5:
                st.write(f"... ve {len(new_topics) - 5} konu daha")
        else:
            st.error("HiÃ§ konu bulunamadÄ±!")

def update_weekly_plan_with_pending_topics(user_data, weekly_plan):
    """HaftalÄ±k planÄ± kalan konularla gÃ¼nceller"""
    
    # KullanÄ±cÄ±nÄ±n tamamlanmamÄ±ÅŸ konularÄ±nÄ± al
    pending_topics = get_user_pending_topics(user_data)
    
    # Bu hafta iÃ§in planlanan konularÄ± al
    current_week_topics = weekly_plan.get('new_topics', [])
    
    # Ã–nceki haftalardan kalan konularÄ± Ã¶ncelikli olarak ekle
    priority_topics = []
    for topic in pending_topics:
        if topic.get('week', 0) < get_current_week_number():
            topic['priority'] = 'high'
            topic['reason'] = 'Ã–nceki haftadan kalan'
            priority_topics.append(topic)
    
    # Ã–ncelikli konularÄ± baÅŸa ekle
    updated_topics = priority_topics + current_week_topics
    
    # GÃ¼ncellenen planÄ± dÃ¶ndÃ¼r
    weekly_plan['new_topics'] = updated_topics
    weekly_plan['priority_topics_count'] = len(priority_topics)
    
    return weekly_plan

def get_user_pending_topics(user_data):
    """KullanÄ±cÄ±nÄ±n tamamlanmamÄ±ÅŸ konularÄ±nÄ± dÃ¶ndÃ¼rÃ¼r"""
    # Bu fonksiyon kullanÄ±cÄ±nÄ±n geÃ§miÅŸ haftalardaki tamamlanmamÄ±ÅŸ konularÄ±nÄ± bulur
    pending_topics = []
    current_week = get_current_week_number()
    
    # KullanÄ±cÄ± verilerinden tamamlanmamÄ±ÅŸ konularÄ± al
    topic_progress = json.loads(user_data.get('topic_progress', '{}') or '{}')
    
    for topic_key, topic_data in topic_progress.items():
        # topic_data'nÄ±n dictionary olduÄŸundan emin ol
        if not isinstance(topic_data, dict):
            continue
        
        # Sadece gerÃ§ekten baÅŸlanmÄ±ÅŸ konularÄ± pending olarak say
        topic_net = topic_data.get('net', 0)
        topic_week = topic_data.get('planned_week', 999)  # VarsayÄ±lan olarak Ã§ok ileri hafta
        topic_subject = topic_data.get('subject', '')
        
        # KoÅŸullar:
        # 1. Net sayÄ±sÄ± 0'dan bÃ¼yÃ¼k olmalÄ± (baÅŸlanmÄ±ÅŸ olmalÄ±)
        # 2. Net sayÄ±sÄ± 14'ten az olmalÄ± (tamamlanmamÄ±ÅŸ olmalÄ±)  
        # 3. Konu haftasÄ± mevcut haftadan kÃ¼Ã§Ã¼k olmalÄ± (geÃ§miÅŸ hafta olmalÄ±)
        # 4. TYT konusu olmalÄ± (AYT konularÄ± zamanÄ± gelmeden pending sayÄ±lmasÄ±n)
        if (topic_net > 0 and topic_net < 14 and 
            topic_week < current_week and
            topic_subject.startswith('TYT')):
            pending_topics.append({
                'subject': topic_subject,
                'topic': topic_key,
                'net': topic_net,
                'week': topic_week,
                'status': 'incomplete'
            })
    
    return pending_topics

def get_completed_topics_from_user_data(user_data):
    """
    ğŸ”¥ TAMAMEN DÃœZELTÄ°LDÄ°: KullanÄ±cÄ±nÄ±n "iyi" seviyeye getirdiÄŸi (net >= 14) konularÄ± dÃ¶ndÃ¼rÃ¼r
    HaftalÄ±k plan ile tam uyumlu - tÃ¼m olasÄ± format kombinasyonlarÄ± eklenir
    """
    import json
    import streamlit as st
    
    completed_topics = []
    completed_topic_names = set()  # HÄ±zlÄ± arama iÃ§in set
    
    # ğŸ” DEBUG: Fonksiyon Ã§aÄŸrÄ±ldÄ±
    debug_mode = st.session_state.get('debug_completed_topics', False)
    if debug_mode:
        st.write("ğŸ” DEBUG: get_completed_topics_from_user_data Ã§aÄŸrÄ±ldÄ±")
    
    # topic_progress'i al
    topic_progress_str = user_data.get('topic_progress', '{}')
    if not topic_progress_str:
        topic_progress_str = '{}'
    
    topic_progress = json.loads(topic_progress_str)
    
    for topic_key, topic_data in topic_progress.items():
        # Veri formatÄ±nÄ± kontrol et
        if isinstance(topic_data, dict):
            topic_net = topic_data.get('net', 0)
        elif isinstance(topic_data, (int, float, str)):
            try:
                topic_net = int(float(str(topic_data)))
            except:
                topic_net = 0
        else:
            topic_net = 0
        
        # Net sayÄ±sÄ± 14 veya daha fazla ise "iyi" seviye (tamamlanmÄ±ÅŸ)
        if topic_net >= 14:
            # Konu formatÄ±nÄ± parse et
            # Format: "TYT TÃ¼rkÃ§e | Anlam Bilgisi | CÃ¼mlede Anlam | Neden-SonuÃ§"
            topic_parts = topic_key.split(' | ')
            
            completed_topics.append({
                'topic': topic_key,  # Tam format
                'topic_name_only': topic_parts[-1] if topic_parts else topic_key,
                'subject': topic_data.get('subject', '') if isinstance(topic_data, dict) else '',
                'net': topic_net,
                'status': 'completed'
            })
            
            # ğŸ”¥ KRÄ°TÄ°K: HaftalÄ±k plan ile eÅŸleÅŸme iÃ§in TÃœM olasÄ± formatlarÄ± ekle
            completed_topic_names.add(topic_key)  # Tam format: "TYT TÃ¼rkÃ§e | Anlam Bilgisi | CÃ¼mlede Anlam | Neden-SonuÃ§"
            
            if len(topic_parts) >= 1:
                completed_topic_names.add(topic_parts[-1])  # Sadece detail: "Neden-SonuÃ§"
            
            if len(topic_parts) >= 3 and topic_parts[-2] != "None":
                # Main topic - detail kombinasyonu: "CÃ¼mlede Anlam - Neden-SonuÃ§"
                main_topic_detail = f"{topic_parts[-2]} - {topic_parts[-1]}"
                completed_topic_names.add(main_topic_detail)
                
                # ğŸ” DEBUG
                if debug_mode and "Neden-SonuÃ§" in topic_parts[-1]:
                    st.write(f"âœ… Eklendi: {main_topic_detail} (net={topic_net})")
            
            if len(topic_parts) >= 2:
                # Category - detail kombinasyonu: "Anlam Bilgisi - Neden-SonuÃ§"
                if topic_parts[-3] != "None" if len(topic_parts) > 2 else False:
                    category_detail = f"{topic_parts[-3]} - {topic_parts[-1]}"
                    completed_topic_names.add(category_detail)
    
    # ğŸ” DEBUG: TamamlanmÄ±ÅŸ konularÄ± gÃ¶ster
    if debug_mode:
        st.write(f"ğŸ“Š Toplam {len(completed_topics)} tamamlanmÄ±ÅŸ konu bulundu")
        if completed_topic_names:
            st.write("ğŸ” TamamlanmÄ±ÅŸ konu formatlarÄ±:")
            for name in sorted(list(completed_topic_names)[:20]):
                st.write(f"  â€¢ {name}")
    
    return completed_topics, completed_topic_names

# Kitap Ã¶nerileri
BOOK_RECOMMENDATIONS = {
    "Bilim Kurgu": [
        "Isaac Asimov - Foundation Serisi",
        "Douglas Adams - OtostopÃ§unun Galaksi Rehberi", 
        "George Orwell - 1984",
        "Aldous Huxley - Cesur Yeni DÃ¼nya"
    ],
    "Klasik Edebiyat": [
        "Victor Hugo - Sefiller",
        "Fyodor Dostoyevski - SuÃ§ ve Ceza",
        "Leo Tolstoy - SavaÅŸ ve BarÄ±ÅŸ",
        "Charles Dickens - Ä°ki Åehrin Hikayesi"
    ],
    "KiÅŸisel GeliÅŸim": [
        "Dale Carnegie - Dost Kazanma ve Ä°nsanlarÄ± Etkileme SanatÄ±",
        "Stephen Covey - Etkili Ä°nsanlarÄ±n 7 AlÄ±ÅŸkanlÄ±ÄŸÄ±",
        "Carol Dweck - Mindset",
        "Daniel Goleman - Duygusal Zeka"
    ],
    "Tarih": [
        "Yuval Noah Harari - Sapiens",
        "Jared Diamond - TÃ¼fek, Mikrop ve Ã‡elik",
        "Howard Zinn - Amerika BirleÅŸik Devletleri'nin HalkÄ±n GÃ¶zÃ¼nden Tarihi",
        "Ä°lber OrtaylÄ± - OsmanlÄ±'yÄ± Yeniden KeÅŸfetmek"
    ],
    "Felsefe": [
        "Jostein Gaarder - Sophie'nin DÃ¼nyasÄ±",
        "Platon - Devlet",
        "Aristoteles - Nikomakhos'a Etik",
        "Ahmet Cevizci - Felsefe Tarihi"
    ],
    "Psikoloji": [
        "Daniel Kahneman - HÄ±zlÄ± ve YavaÅŸ DÃ¼ÅŸÃ¼nme",
        "Viktor Frankl - Ä°nsanÄ±n Anlam ArayÄ±ÅŸÄ±",
        "Carl Jung - Ä°nsan ve Sembolleri",
        "Sigmund Freud - RÃ¼yalarÄ±n Yorumu"
    ]
}

# ğŸ§  BÄ°LÄ°MSEL TEMELLI BÄ°LÄ°ÅSEL PROFÄ°L TANIMLARI
# Kolb, Riding & Cheema (1991), Gardner teorilerine dayalÄ±

COGNITIVE_PROFILE_DESCRIPTIONS = {
    # ğŸ”¬ Analitik Dominant Profiller
    "Analitik-DÄ±ÅŸsal": {
        "title": "ğŸ”¬ Analitik-DÄ±ÅŸsal Profil",
        "scientific_base": "Kolb: Soyut KavramsallaÅŸtÄ±rma + Riding & Cheema: Analitik Stil",
        "intro": "Sistemli dÃ¼ÅŸÃ¼nÃ¼r, hedef odaklÄ±sÄ±nÄ±z. Bilgiyi parÃ§alara bÃ¶lerek analiz eder, dÄ±ÅŸsal motivasyonlarla hareket edersiniz.",
        "strengths": [
            "ğŸ¯ Sistematik problem Ã§Ã¶zme yeteneÄŸi",
            "ğŸ“Š Veri analizi ve mantÄ±ksal Ã§Ä±karÄ±m",
            "â° Hedef belirleme ve planlamada baÅŸarÄ±",
            "ğŸ” DetaylÄ± araÅŸtÄ±rma ve inceleme becerisi"
        ],
        "yks_strategies": [
            "ğŸ“ˆ Net puan hedefleri belirleyin ve grafiklerle takip edin",
            "ğŸ—“ï¸ HaftalÄ±k-aylÄ±k Ã§alÄ±ÅŸma planlarÄ± oluÅŸturun",
            "ğŸ“‹ KonularÄ± kÃ¼Ã§Ã¼k parÃ§alara bÃ¶lerek sistematik ilerleyin",
            "ğŸ† BaÅŸarÄ± Ã¶dÃ¼lleri sistemi kurun (puan artÄ±ÅŸlarÄ± iÃ§in)"
        ],
        "study_methods": [
            "Schematic learning (ÅŸema tabanlÄ± Ã¶ÄŸrenme)",
            "Progressive disclosure (aÅŸamalÄ± aÃ§Ä±klama)",
            "Goal-setting frameworks (hedef belirleme Ã§erÃ§eveleri)",
            "Analytical questioning techniques (analitik sorgulama)"
        ]
    },
    
    "Analitik-Ä°Ã§sel": {
        "title": "ğŸ”¬ Analitik-Ä°Ã§sel Profil", 
        "scientific_base": "Gardner: MantÄ±ksal-Matematiksel Zeka + Ä°Ã§sel Motivasyon",
        "intro": "Derinlemesine anlama odaklÄ±sÄ±nÄ±z. Merak ettiÄŸiniz konularÄ± sistematik olarak Ã§Ã¶zÃ¼mlersiniz.",
        "strengths": [
            "ğŸ§  Derin kavrayÄ±ÅŸ ve eleÅŸtirel dÃ¼ÅŸÃ¼nme",
            "ğŸ” BaÄŸÄ±msÄ±z araÅŸtÄ±rma becerisi",
            "ğŸ’¡ YaratÄ±cÄ± problem Ã§Ã¶zme yaklaÅŸÄ±mlarÄ±",
            "ğŸ“š SÃ¼rekli Ã¶ÄŸrenme isteÄŸi"
        ],
        "yks_strategies": [
            "ğŸ¨ Ä°lginizi Ã§eken derslere daha fazla zaman ayÄ±rÄ±n",
            "ğŸ” KonularÄ±n 'neden' ve 'nasÄ±l' sorularÄ±nÄ± araÅŸtÄ±rÄ±n",
            "ğŸ“– Ders kitabÄ±nÄ±n Ã¶tesinde kaynaklara baÅŸvurun",
            "ğŸ¯ KiÅŸisel merak alanlarÄ±nÄ±zla YKS konularÄ±nÄ± iliÅŸkilendirin"
        ],
        "study_methods": [
            "Inquiry-based learning (araÅŸtÄ±rma tabanlÄ± Ã¶ÄŸrenme)",
            "Self-directed exploration (kendini yÃ¶nlendirme)",
            "Conceptual mapping (kavramsal haritalama)",
            "Reflective analysis (yansÄ±tÄ±cÄ± analiz)"
        ]
    },

    # ğŸ¨ Sintetik Dominant Profiller  
    "Sintetik-DÄ±ÅŸsal": {
        "title": "ğŸ¨ Sintetik-DÄ±ÅŸsal Profil",
        "scientific_base": "Riding & Cheema: Holistik Stil + DÄ±ÅŸsal Motivasyon",
        "intro": "BÃ¼yÃ¼k resmi gÃ¶rÃ¼r, yaratÄ±cÄ± Ã§Ã¶zÃ¼mler Ã¼retirsiniz. Takdir ve baÅŸarÄ± ile motive olursunuz.",
        "strengths": [
            "ğŸŒŸ BÃ¼tÃ¼ncÃ¼l yaklaÅŸÄ±m ve pattern recognition",
            "ğŸ­ YaratÄ±cÄ± dÃ¼ÅŸÃ¼nme ve yenilikÃ§i Ã§Ã¶zÃ¼mler",
            "ğŸŒ Disiplinler arasÄ± baÄŸlantÄ± kurma",
            "ğŸª Performans odaklÄ± Ã§alÄ±ÅŸma"
        ],
        "yks_strategies": [
            "ğŸ¨ Konular arasÄ± baÄŸlantÄ±larÄ± gÃ¶rselleÅŸtirin",
            "ğŸ† Deneme sÄ±navlarÄ±nÄ± yarÄ±ÅŸma gibi gÃ¶rÃ¼n",
            "ğŸ‘¥ Ã‡alÄ±ÅŸma gruplarÄ±nda liderlik alÄ±n",
            "ğŸ¯ YaratÄ±cÄ± not alma tekniklerini kullanÄ±n"
        ],
        "study_methods": [
            "Holistic learning (bÃ¼tÃ¼ncÃ¼l Ã¶ÄŸrenme)",
            "Creative visualization (yaratÄ±cÄ± gÃ¶rselleÅŸtirme)",
            "Interdisciplinary connections (disiplinler arasÄ± baÄŸlantÄ±lar)",
            "Performance-based rewards (performans tabanlÄ± Ã¶dÃ¼ller)"
        ]
    },

    "Sintetik-Ä°Ã§sel": {
        "title": "ğŸ¨ Sintetik-Ä°Ã§sel Profil",
        "scientific_base": "Gardner: YaratÄ±cÄ± Zeka + Ä°Ã§sel Motivasyon",
        "intro": "Sanatsal ve yaratÄ±cÄ± yaklaÅŸÄ±mlarla Ã¶ÄŸrenirsiniz. Kendi iÃ§sel rehberliÄŸinizle hareket edersiniz.",
        "strengths": [
            "ğŸ¨ YaratÄ±cÄ± Ã¶ÄŸrenme stratejileri geliÅŸtirme",
            "ğŸŒˆ Ã‡ok boyutlu dÃ¼ÅŸÃ¼nme yeteneÄŸi",
            "ğŸª Sezgisel kavrayÄ±ÅŸ",
            "ğŸŒŸ Ã–zgÃ¼n yaklaÅŸÄ±mlar Ã¼retme"
        ],
        "yks_strategies": [
            "ğŸ¨ KonularÄ± hikayeler ve metaforlarla Ã¶ÄŸrenin",
            "ğŸŒˆ Renkli, yaratÄ±cÄ± notlar alÄ±n",
            "ğŸ­ Role-play teknikleriyle Ã¶ÄŸrenin",
            "ğŸª Kendi benzersiz Ã§alÄ±ÅŸma yÃ¶ntemlerinizi geliÅŸtirin"
        ],
        "study_methods": [
            "Narrative learning (hikaye tabanlÄ± Ã¶ÄŸrenme)",
            "Metaphorical thinking (metaforik dÃ¼ÅŸÃ¼nme)", 
            "Artistic expression (sanatsal ifade)",
            "Intuitive exploration (sezgisel keÅŸif)"
        ]
    },

    # ğŸ§˜ Reflektif Dominant Profiller
    "Reflektif-Metodik": {
        "title": "ğŸ§˜ Reflektif-Metodik Profil",
        "scientific_base": "Kolb: YansÄ±tÄ±cÄ± GÃ¶zlem + Metodolojik YaklaÅŸÄ±m",
        "intro": "DÃ¼ÅŸÃ¼nerek ve planlayarak hareket edersiniz. Sistematik yÃ¶ntemlerle derinlemesine Ã§alÄ±ÅŸÄ±rsÄ±nÄ±z.",
        "strengths": [
            "ğŸ¤” Derinlemesine dÃ¼ÅŸÃ¼nme ve yansÄ±tma",
            "ğŸ“‹ Metodolojik yaklaÅŸÄ±m",
            "â³ SabÄ±rlÄ± ve dikkatli Ã§alÄ±ÅŸma",
            "ğŸ¯ Stratejik planlama"
        ],
        "yks_strategies": [
            "â° YavaÅŸ ama etkili Ã§alÄ±ÅŸma planlarÄ± yapÄ±n",
            "ğŸ“ DÃ¼zenli notlar alÄ±n ve gÃ¶zden geÃ§irin",
            "ğŸ¤” HatalarÄ± derinlemesine analiz edin",
            "ğŸ¯ Uzun vadeli hedefler belirleyin"
        ],
        "study_methods": [
            "Reflective practice (yansÄ±tÄ±cÄ± uygulama)",
            "Systematic review (sistematik gÃ¶zden geÃ§irme)",
            "Deep processing (derin iÅŸleme)",
            "Strategic planning (stratejik planlama)"
        ]
    },

    # ğŸ’¡ Deneysel Dominant Profiller
    "Deneysel-Sosyal": {
        "title": "ğŸ’¡ Deneysel-Sosyal Profil",
        "scientific_base": "Kolb: Aktif Deneyim + Gardner: Sosyal Zeka",
        "intro": "Deneyerek Ã¶ÄŸrenir, sosyal etkileÅŸimlerle geliÅŸirsiniz. Grup Ã§alÄ±ÅŸmalarÄ± size enerji verir.",
        "strengths": [
            "ğŸ”„ Deneme-yanÄ±lma ile hÄ±zlÄ± Ã¶ÄŸrenme",
            "ğŸ‘¥ Sosyal Ã¶ÄŸrenme ve iÅŸ birliÄŸi",
            "âš¡ Adaptasyon yeteneÄŸi",
            "ğŸª EtkileÅŸimli problem Ã§Ã¶zme"
        ],
        "yks_strategies": [
            "ğŸ‘¥ Ã‡alÄ±ÅŸma gruplarÄ± oluÅŸturun",
            "ğŸ”„ Ã‡ok sayÄ±da deneme sÄ±navÄ± Ã§Ã¶zÃ¼n",
            "ğŸ’¬ KonularÄ± arkadaÅŸlarÄ±nÄ±zla tartÄ±ÅŸÄ±n",
            "ğŸ¯ Grup yarÄ±ÅŸmalarÄ± dÃ¼zenleyin"
        ],
        "study_methods": [
            "Collaborative learning (iÅŸbirlikÃ§i Ã¶ÄŸrenme)",
            "Trial-and-error approach (deneme-yanÄ±lma)",
            "Social interaction (sosyal etkileÅŸim)",
            "Peer learning (akran Ã¶ÄŸrenimi)"
        ]
    }
}

# ğŸ¯ YKS'YE Ã–ZEL BÄ°LÄ°ÅSEL PROFÄ°L YORUMLARI
YKS_COGNITIVE_INTERPRETATIONS = {
    "analitik": {
        "emoji": "ğŸ”¬",
        "description": "SayÄ±sal & mantÄ±k derslerinde baÅŸarÄ±lÄ± olur, dÃ¼zenli tekrar ister",
        "best_subjects": ["TYT Matematik", "AYT Matematik", "Fizik", "Kimya"],
        "study_approach": "Sistematik ve adÄ±m adÄ±m"
    },
    "sintetik": {
        "emoji": "ğŸ¨", 
        "description": "EÅŸit aÄŸÄ±rlÄ±k/sÃ¶zel alanda baskÄ±n, bÃ¼tÃ¼ncÃ¼l kavrama gÃ¼cÃ¼ yÃ¼ksek",
        "best_subjects": ["Edebiyat", "Tarih", "CoÄŸrafya", "Felsefe"],
        "study_approach": "BÃ¼tÃ¼ncÃ¼l ve yaratÄ±cÄ±"
    },
    "reflektif": {
        "emoji": "ğŸ§˜",
        "description": "Sessiz ortamda Ã¶ÄŸrenir, deneme analizlerinde derin dÃ¼ÅŸÃ¼nÃ¼r",
        "best_subjects": ["TÃ¼m dersler - Ã¶zellikle teorik konular"],
        "study_approach": "Derin dÃ¼ÅŸÃ¼nme ve analiz"
    },
    "dÄ±ÅŸsal_motivasyon": {
        "emoji": "âš¡",
        "description": "Net hedef belirleme, puan/Ã¶dÃ¼l sistemiyle motive olur",
        "motivation_type": "Hedef ve baÅŸarÄ± odaklÄ±",
        "study_tips": ["Puan takibi", "Ã–dÃ¼l sistemi", "Rekabet"]
    },
    "iÃ§sel_motivasyon": {
        "emoji": "ğŸ§â€â™‚ï¸",
        "description": "Ä°lgi duyduÄŸu konuya yoÄŸunlaÅŸÄ±r, plan dÄ±ÅŸÄ± Ã§alÄ±ÅŸabilir",
        "motivation_type": "Merak ve ilgi odaklÄ±", 
        "study_tips": ["KiÅŸisel ilgi alanlarÄ±", "Ã–zgÃ¼r planlama", "KeÅŸif odaklÄ±"]
    },
    "gÃ¶rsel_hafÄ±za": {
        "emoji": "ğŸ‘",
        "description": "Kavram haritasÄ±, renk kodlu notlar kullanÄ±r",
        "memory_type": "GÃ¶rsel kodlama",
        "techniques": ["Mind mapping", "Renk kodlama", "Åemalar"]
    },
    "iÅŸitsel_hafÄ±za": {
        "emoji": "ğŸ‘‚",
        "description": "Sesli tekrar, tartÄ±ÅŸma ile Ã¶ÄŸrenir",
        "memory_type": "Ä°ÅŸitsel kodlama",
        "techniques": ["Sesli okuma", "Grup tartÄ±ÅŸmasÄ±", "Sesli notlar"]
    },
    "deneyimsel_hafÄ±za": {
        "emoji": "âœ‹",
        "description": "Pratik soru Ã§Ã¶zÃ¼mÃ¼, simÃ¼lasyon ile Ã¶ÄŸrenir",
        "memory_type": "Kinesthetic kodlama",
        "techniques": ["Pratik uygulama", "Soru Ã§Ã¶zme", "Hands-on learning"]
    }
}

# === YENÄ° SÄ°STEMATÄ°K YKS TAKÄ°P SÄ°STEMÄ° ===

# Ders Ã–nem PuanlarÄ± (1-10 arasÄ±)
SUBJECT_IMPORTANCE_SCORES = {
    "TYT Matematik": 10,      # En kritik
    "TYT TÃ¼rkÃ§e": 9,          # YÃ¼ksek soru sayÄ±sÄ±
    "TYT Fizik": 8,           # Ã–nemli
    "TYT Kimya": 8,           # Ã–nemli
    "TYT Biyoloji": 7,        # Orta-YÃ¼ksek
    "TYT Geometri": 7,        # Orta-YÃ¼ksek
    "TYT Tarih": 6,           # Orta
    "TYT CoÄŸrafya": 6,        # Orta
    "TYT Felsefe": 4,         # 2-3. hafta baÅŸlangÄ±Ã§
    "TYT Din KÃ¼ltÃ¼rÃ¼": 4,     # 2-3. hafta baÅŸlangÄ±Ã§
    "AYT Matematik": 10,      # En kritik
    "AYT Fizik": 9,           # YÃ¼ksek
    "AYT Kimya": 9,           # YÃ¼ksek
    "AYT Biyoloji": 8,        # Ã–nemli
    "AYT Edebiyat": 9,        # SÃ¶zel iÃ§in kritik
    "AYT Tarih": 7,           # SÃ¶zel iÃ§in Ã¶nemli
    "AYT CoÄŸrafya": 7,        # SÃ¶zel iÃ§in Ã¶nemli
}

# Bilimsel Tekrar AralÄ±klarÄ± (gÃ¼n) - ESKÄ° SÄ°STEM
SPACED_REPETITION_INTERVALS = [3, 7, 14, 30, 90]

# YENÄ°: KalÄ±cÄ± Ã–ÄŸrenme AralÄ±klarÄ± (3/7/7/7/7 sistem)
MASTERY_INTERVALS = [3, 7, 7, 7, 7]  # GÃ¼n cinsinden

# YENÄ°: KalÄ±cÄ±lÄ±k DurumlarÄ±
MASTERY_STATUS = {
    "INITIAL": {"name": "Ä°lk Ã–ÄŸrenme", "color": "#3498db", "icon": "ğŸ“š"},
    "REVIEW_1": {"name": "1. Tekrar", "color": "#f39c12", "icon": "ğŸ”„"},
    "REVIEW_2": {"name": "2. Tekrar", "color": "#e67e22", "icon": "ğŸ”„"},
    "REVIEW_3": {"name": "3. Tekrar", "color": "#e74c3c", "icon": "ğŸ”„"},
    "REVIEW_4": {"name": "4. Tekrar", "color": "#9b59b6", "icon": "ğŸ”„"},
    "MASTERED": {"name": "KalÄ±cÄ± Ã–ÄŸrenildi", "color": "#27ae60", "icon": "âœ…"},
    "FAILED": {"name": "KalÄ±cÄ±lÄ±k BaÅŸarÄ±sÄ±z", "color": "#c0392b", "icon": "âŒ"}
}

# YENÄ°: Tekrar DeÄŸerlendirme Seviyeleri
REVIEW_LEVELS = {
    "zayif": {"next_interval": 3, "priority": "HIGH", "color": "#e74c3c"},
    "temel": {"next_interval": 7, "priority": "MEDIUM", "color": "#f39c12"},
    "orta": {"next_interval": 7, "priority": "MEDIUM", "color": "#3498db"},
    "iyi": {"next_interval": 7, "priority": "LOW", "color": "#27ae60"},
    "uzman": {"next_interval": 7, "priority": "MINIMAL", "color": "#9b59b6"}
}

# Ã–ncelik Kategorileri - YENÄ° DÄ°NAMÄ°K SÄ°STEM (Konu Takip Seviyelerine GÃ¶re)
PRIORITY_CATEGORIES = {
    "HIGH": {"icon": "ğŸ”¥", "name": "Acil - ZayÄ±f Konu", "color": "#dc3545"},
    "MEDIUM": {"icon": "âš¡", "name": "Ã–ncelikli - Temel Konu", "color": "#fd7e14"},
    "NORMAL": {"icon": "ğŸ¯", "name": "Normal - Orta Konu", "color": "#20c997"},
    "LOW": {"icon": "ğŸŸ¢", "name": "DÃ¼ÅŸÃ¼k - Ä°yi Konu", "color": "#28a745"},
    "MINIMAL": {"icon": "â­", "name": "Minimal - Uzman Konu", "color": "#6c757d"},
    
    # Tekrar kategorileri
    "REPEAT_HIGH": {"icon": "ğŸ”„", "name": "Acil Tekrar", "color": "#e74c3c"},
    "REPEAT_MEDIUM": {"icon": "ğŸ”„", "name": "Ã–ncelikli Tekrar", "color": "#f39c12"},
    "REPEAT_NORMAL": {"icon": "ğŸ”„", "name": "Normal Tekrar", "color": "#3498db"}
}

# HaftalÄ±k Konu SayÄ±sÄ± Limitleri (Ã–neme gÃ¶re) - 1-5 ArasÄ±
WEEKLY_TOPIC_LIMITS = {
    10: 5,  # En Ã¶nemli dersler: 5 konu/hafta
    9: 4,   # Ã‡ok Ã¶nemli: 4 konu/hafta
    8: 3,   # Ã–nemli: 3 konu/hafta
    7: 2,   # Orta-YÃ¼ksek: 2 konu/hafta
    6: 2,   # Orta: 2 konu/hafta
    4: 1,   # DÃ¼ÅŸÃ¼k Ã¶ncelik: 1 konu/hafta (2-3. hafta sonra)
}

# Modern CSS
def get_custom_css(target_department):
    bg_style = BACKGROUND_STYLES.get(target_department, BACKGROUND_STYLES["VarsayÄ±lan"])
    
    return f"""
<style>
    .main-header {{
        background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), {bg_style['gradient']};
        background-size: cover;
        background-position: center;
        padding: 3rem;
        border-radius: 20px;
        color: white;
        text-align: center;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        position: relative;
        overflow: hidden;
    }}

    .main-header::before {{
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: {bg_style['gradient']};
        opacity: 0.8;
        z-index: -1;
    }}

    .super-minimal-gauge {{
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.8rem 0;
        margin: 0.3rem 0;
        border-bottom: 1px solid #f0f0f0;
    }}

    .subject-name {{
        font-size: 1rem;
        font-weight: 500;
        color: #333;
    }}

    .subject-percent {{
        font-size: 1.1rem;
        font-weight: bold;
        color: #4CAF50;
        min-width: 50px;
        text-align: right;
    }}

    .gauge-container {{
        margin: 1rem 0;
        background: white;
        padding: 1rem;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }}
    
    .psychology-test {{
        background: linear-gradient(135deg, #654ea3 0%, #eaafc8 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 15px;
        margin: 1rem 0;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }}
    
    .psychology-card {{
        background: #c0392b;
        color: white;
        padding: 2rem;
        border-radius: 15px;
        border-left: 5px solid #a43a3a;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }}
    
    .stSpinner > div > span {{
        color: #654ea3 !important;
    }}
    
    .stProgress > div > div > div > div {{
        background-color: #654ea3 !important;
    }}
    
    /* Sidebar Arka Plan Rengi - Ã‡ok Koyu KÄ±rmÄ±zÄ± */
    [data-testid="stSidebar"] {{
        background-color: #8B0000 !important;
    }}
    
    [data-testid="stSidebar"] > div {{
        background-color: #8B0000 !important;
    }}
    
    [data-testid="stSidebar"] section {{
        background-color: #8B0000 !important;
    }}
    
    /* Sidebar YazÄ±larÄ± Daha Belirgin */
    [data-testid="stSidebar"] * {{
        color: #ffffff !important;
        font-weight: 600 !important;
    }}
    
    [data-testid="stSidebar"] h1,
    [data-testid="stSidebar"] h2,
    [data-testid="stSidebar"] h3,
    [data-testid="stSidebar"] h4,
    [data-testid="stSidebar"] h5,
    [data-testid="stSidebar"] h6 {{
        color: #ffffff !important;
        font-weight: bold !important;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5) !important;
    }}
    
    [data-testid="stSidebar"] p,
    [data-testid="stSidebar"] div,
    [data-testid="stSidebar"] span,
    [data-testid="stSidebar"] label {{
        color: #ffffff !important;
        font-weight: 500 !important;
    }}
    
    [data-testid="stSidebar"] .stSelectbox label,
    [data-testid="stSidebar"] .stCheckbox label {{
        color: #ffffff !important;
        font-weight: bold !important;
    }}
</style>
"""

# TÃ¼m YKS konularÄ± (GÃœNCELLENMÄ°Å VE TAMAMLANDI)
YKS_TOPICS = {
    "TYT TÃ¼rkÃ§e": {
        "Anlam Bilgisi": {
            "SÃ¶zcÃ¼kte Anlam": ["GerÃ§ek Anlam", "Mecaz Anlam", "Terim Anlam", "Yan Anlam", "EÅŸ Anlam", "ZÄ±t Anlam", "EÅŸ Sesli"],
            "CÃ¼mlede Anlam": ["CÃ¼mle Yorumlama", "Kesin YargÄ±", "AnlatÄ±m BiÃ§imleri", "Duygu ve DÃ¼ÅŸÃ¼nce", "AmaÃ§-SonuÃ§", "Neden-SonuÃ§"],
            "Paragraf": ["Ana Fikir", "YardÄ±mcÄ± Fikir", "Paragraf YapÄ±sÄ±", "AnlatÄ±m Teknikleri", "DÃ¼ÅŸÃ¼nceyi GeliÅŸtirme"]
        },
        "Dil Bilgisi": {
            "Ses Bilgisi": ["Ses OlaylarÄ±", "ÃœnlÃ¼ UyumlarÄ±"],
            "YazÄ±m KurallarÄ±": ["BÃ¼yÃ¼k Harf", "BirleÅŸik Kelimeler", "SayÄ±larÄ±n YazÄ±mÄ±"],
            "Noktalama Ä°ÅŸaretleri": ["Nokta, VirgÃ¼l", "NoktalÄ± VirgÃ¼l", "Ä°ki Nokta", "TÄ±rnak Ä°ÅŸaretleri","Ãœnlem, Soru","Kesme Ä°ÅŸareti","Yay AyraÃ§"],
            "SÃ¶zcÃ¼kte YapÄ±":["KÃ¶k (isim/fiil)", "gÃ¶vde,ekler (yapÄ±m/Ã§ekim) ,basit ,tÃ¼remiÅŸ ve birleÅŸik sÃ¶zcÃ¼kler"],       
            "SÃ¶zcÃ¼k TÃ¼rleri":["Ä°simler (Adlar)", "Zamirler (AdÄ±llar)", "SÄ±fatlar (Ã–n Adlar)", "Zarflar (BelirteÃ§ler)", "Edat â€“ BaÄŸlaÃ§ Ãœnlem"],
            "Fiiller": [" Fiilde Anlam (Kip -zaman/tasarlama-, KiÅŸi, YapÄ± -basit/tÃ¼remiÅŸ/birleÅŸik-)","Ek Fiil (Ä°simleri yÃ¼klem yapma, basit Ã§ekimli fiili birleÅŸik Ã§ekimli yapma)"," Fiilimsi (Ä°sim fiil, sÄ±fat fiil, zarf fiil)."," Fiilde Ã‡atÄ± (Ã–zne ve nesneye gÃ¶re fiilin aldÄ±ÄŸÄ± ekler)."],
            "CÃ¼mlenin Ã–geleri":["YÃ¼klem, Ã¶zne, nesne (belirtili/belirtisiz), dolaylÄ± tÃ¼mleÃ§ (yer tamlayÄ±cÄ±sÄ±), zarf tÃ¼mleci, edat tÃ¼mleci."],
            "CÃ¼mle TÃ¼rleri":["YÃ¼klemin tÃ¼rÃ¼ne, yerine, anlamÄ±na ve yapÄ±sÄ±na gÃ¶re cÃ¼mleler."],   
            "AnlatÄ±m BozukluÄŸu":["Anlamsal ve yapÄ±sal anlatÄ±m bozukluklarÄ±."],      
        }
    },
    "TYT Matematik": {
        "Temel Kavramlar":["SayÄ±lar", "SayÄ± BasamaklarÄ±","BÃ¶lme ve BÃ¶lÃ¼nebilme", "EBOB â€“ EKOK."],
        "Temel Ä°ÅŸlemler": ["Rasyonel SayÄ±lar", "Basit EÅŸitsizlikler","Mutlak DeÄŸer", "ÃœslÃ¼ SayÄ±lar", "KÃ¶klÃ¼ SayÄ±lar"],
        "Problemler":[

          "SayÄ± Problemleri",
          "Kesir Problemleri",
          "YaÅŸ Problemleri",
          "YÃ¼zde Problemleri",
          "Kar-Zarar Problemleri",
          "KarÄ±ÅŸÄ±m Problemleri",
          "Hareket Problemleri",
          "Ä°ÅŸÃ§i Problemleri",
          "Tablo-Grafik Problemleri",
          "Rutin Olmayan Problemler (MantÄ±k-muhakeme gerektiren sorular)"],
        "Genel":["KÃ¼meler", "MantÄ±k", "Fonksiyonlar.(temel tyt dÃ¼zey)"],
        "OlasÄ±lÄ±k":["PermÃ¼tasyon","Kombinasyon","OlasÄ±lÄ±k"]
            
        },
       
    
    "TYT Geometri": {
        "ÃœÃ§genler":{
            "AÃ§Ä±lar":["DoÄŸruda AÃ§Ä±lar","ÃœÃ§gende AÃ§Ä±lar",],
            "Ã–zel ÃœÃ§genler":["Dik ÃœÃ§gen","Ä°kizkenar ÃœÃ§gen","EÅŸkenar ÃœÃ§gen"],
            "ÃœÃ§gen Ã–zellikleri":["AÃ§Ä±ortay","Kenarortay","EÅŸlik ve Benzerlik","ÃœÃ§gende Alan","AÃ§Ä± Kenar BaÄŸÄ±ntÄ±larÄ±"],
        
        "Ã‡okgenler ve Ã–zellikleri":["Ã‡okgenler","Ã–zel DÃ¶rtgenler...","Deltoid","Paralel kenar","EÅŸkenar DÃ¶rtgen","DikdÃ¶rtgen","Kare","Yamuk"],
        
        "Ã‡ember ve Daire":["Ã‡emberde AÃ§Ä±","Ã‡emberde Uzunluk","Dairede Ã‡evre ve Alan"],
        
        "Analitik Geometri":["NoktanÄ±n AnalitiÄŸi","DoÄŸrunun AnalitiÄŸi"],
        
        "KatÄ± Cisimler":["Prizmalar","KÃ¼p","Silindir","Piramit","Koni","KÃ¼re"]}
    },
    "TYT Tarih": {
        "Tarih Bilimi":["Tarih ve Zaman","Ä°nsanlÄ±ÄŸÄ±n Ä°lk DÃ¶nemleri","OrtaÃ§aÄŸâ€™da DÃ¼nya",
                         "Ä°lk ve Orta Ã‡aÄŸlarda TÃ¼rk DÃ¼nyasÄ±","Ä°slam Medeniyetinin DoÄŸuÅŸu","Ä°lk TÃ¼rk Ä°slam Devletleri",
                         "YerleÅŸme ve DevletleÅŸme SÃ¼recinde SelÃ§uklu TÃ¼rkiyesi","Beylikten Devlete OsmanlÄ± Siyaseti(1300-1453)",
                        "DÃ¼nya GÃ¼cÃ¼ OsmanlÄ± Devleti (1453-1600)",
                        "Yeni Ã‡aÄŸ Avrupa Tarihi",
                        "YakÄ±n Ã‡aÄŸ Avrupa Tarihi",
                        "OsmanlÄ± Devletinde ArayÄ±ÅŸ YÄ±llarÄ±(Duraklama DÃ¶nemi ve nedenleri)",
                        "OsmanlÄ±-Avrupa iliÅŸkileri","18. YÃ¼zyÄ±lda DeÄŸiÅŸim ve Diplomasi",
                          "En Uzun YÃ¼zyÄ±l",
                          "OsmanlÄ± KÃ¼ltÃ¼r ve Medeniyeti","20. YÃ¼zyÄ±lda OsmanlÄ± Devleti",
                         "I. DÃ¼nya SavaÅŸÄ±",
                         "Mondros AteÅŸkesi, Ä°ÅŸgaller ve Cemiyetler",
                          "KurtuluÅŸ SavaÅŸÄ±na HazÄ±rlÄ±k DÃ¶nemi",
                        "I. TBMM DÃ¶nemi",
                         "KurtuluÅŸ SavaÅŸÄ± ve AntlaÅŸmalar",
                        "II. TBMM DÃ¶nemi ve Ã‡ok Partili Hayata GeÃ§iÅŸ",
                        "TÃ¼rk Ä°nkÄ±labÄ±","AtatÃ¼rk Ä°lkeleri",
                         "AtatÃ¼rk DÃ¶nemi TÃ¼rk DÄ±ÅŸ PolitikasÄ±"]
    },
    "TYT CoÄŸrafya":{
        "DÃ¼nya HaritalarÄ± KampÄ± (Ã–neri:CoÄŸrafyanÄ±n KodlarÄ±)": 
            ["DÃ¼nya HaritalarÄ±"],
        "Konular":["DoÄŸa ve Ä°nsan EtkileÅŸimi",
                   "DÃ¼nyaâ€™nÄ±n Åekli ve Hareketleri (GÃ¼nlÃ¼k ve YÄ±llÄ±k Hareketler, SonuÃ§larÄ±)",
                   "CoÄŸrafi Konum (Mutlak ve GÃ¶receli Konum)","Harita Bilgisi"
                   "Atmosfer ve SÄ±caklÄ±k",
                   "Ä°klimler","BasÄ±nÃ§ ve RÃ¼zgarlar",
                    "Nem, YaÄŸÄ±ÅŸ ve BuharlaÅŸma",
                      "Ä°Ã§ Kuvvetler / DÄ±ÅŸ Kuvvetler"," Su â€“ Toprak ve Bitkiler","NÃ¼fus",
                       "GÃ¶Ã§",
                       "YerleÅŸme",
                       "TÃ¼rkiyeâ€™nin Yer Åekilleri",
                        "Ekonomik Faaliyetler",
                        "BÃ¶lgeler,UluslararasÄ± UlaÅŸÄ±m HatlarÄ±,Ã‡evre ve Toplum","DoÄŸal Afetler"]
        
    },
    "TYT Felsefe": {
        "Temel Felsefe KonularÄ±": [
            "Felsefenin Konusu",
            "Bilgi Felsefesi (Epistemoloji)",
            "VarlÄ±k Felsefesi (Ontoloji)",
            "Din, KÃ¼ltÃ¼r ve Medeniyet",
            "Ahlak Felsefesi",
            "Sanat Felsefesi",
            "Din Felsefesi",
            "Siyaset Felsefesi",
            "Bilim Felsefesi"
        ],
        "Felsefe Tarihi": [
            "Ä°lk Ã‡aÄŸ Felsefesi",
            "Sokrates ve Felsefesi",
            "Platon ve Felsefesi", 
            "Aristoteles ve Felsefesi",
            "Orta Ã‡aÄŸ Felsefesi",
            "Ä°slam Felsefesi (Farabi, Ä°bn Sina)",
            "Hristiyan Felsefesi (Augustinus, AquinalÄ± Thomas)"
        ]
    },
    
    "TYT Din KÃ¼ltÃ¼rÃ¼": {
        "1. Ä°nanÃ§ ve Temel Kavramlar": [
            "Ä°nsan ve Din (Ä°nanÃ§)",
            "Vahiy ve AkÄ±l"
        ],
        "2.  Ä°slam ve Ä°badet: ve  GenÃ§lik ve DeÄŸerler:": [
            "Ä°badet",
            "Hz. Muhammed'in HayatÄ± ve Ã–rnekliÄŸi"
        ],
        "3. Ä°slam Medeniyeti ve Ã–zellikleri ve Allah Ä°nancÄ± ve Ä°nsan:": [
            "Allahâ€™Ä±n VarlÄ±ÄŸÄ± ve BirliÄŸi (Tevhid)",
            "Allahâ€™Ä±n Ä°sim ve SÄ±fatlarÄ± (Esma-Ã¼l HÃ¼sna)",
            "Kurâ€™an-Ä± Kerimâ€™de Ä°nsan ve Ã–zellikleri",
            "Ä°nsanÄ±n Allah Ä°le Ä°rtibatÄ± (Dua, TÃ¶vbe, Ä°badet)"


        ],
        "4. Hz. Muhammed (S.A.V) ve GenÃ§lik:": [
             "Kurâ€™an-Ä± Kerimâ€™de GenÃ§ler",
            "Bir GenÃ§ Olarak Hz. Muhammed",
            "Hz. Muhammed ve GenÃ§ler",
            "BazÄ± GenÃ§ Sahabiler"
        ],
        "5.Din ve Toplumsal Hayat":[ 
            "Din ve Aile",
            "Din, KÃ¼ltÃ¼r ve Sanat",
            "Din ve Ã‡evre",
            "Din ve Sosyal DeÄŸiÅŸim",
            "Din ve Ekonomi",
            "Din ve Sosyal Adalet"],
        "6.Ahlaki Tutum ve DavranÄ±ÅŸlar":[
            "Ä°slam ahlakÄ±nÄ±n temel ilkeleri, iyi ve kÃ¶tÃ¼ davranÄ±ÅŸlar",
            "Ä°slam DÃ¼ÅŸÃ¼ncesinde Yorumlar: Ä°slam DÃ¼ÅŸÃ¼ncesinde Ä°tikadi, Siyasi ve FÄ±khi Yorumlar (Mezhepler)"
        ]
    },
    "TYT Fizik": {
        " FiziÄŸe GiriÅŸ ve Maddenin Ã–zellikleri (9. SÄ±nÄ±f)": {
            "Fizik Bilimine GiriÅŸ": [
                "Fizik biliminin doÄŸasÄ±, Ã¶nemi ve diÄŸer bilimlerle iliÅŸkisi",
                "FiziÄŸin DoÄŸasÄ±, Alt DallarÄ±",
                "Temel ve TÃ¼retilmiÅŸ BÃ¼yÃ¼klÃ¼kler"
            ],
            "Madde ve Ã–zellikleri": [
                "KÃ¼tle, Hacim, Ã–zkÃ¼tle, DayanÄ±klÄ±lÄ±k",
                "Adezyon, Kohezyon, YÃ¼zey Gerilimi, KÄ±lcallÄ±k"
            ],
        },
        " Kuvvet, Hareket ve Enerji (9. SÄ±nÄ±f)": {
            "Hareket ve Kuvvet": [
                "Konum, Yol, Yer DeÄŸiÅŸtirme, SÃ¼rat, HÄ±z, Ä°vme",
                "DÃ¼zgÃ¼n DoÄŸrusal Hareket",
                "Newton'un Hareket YasalarÄ±"
                "Etki-tepki, net kuvvet, dengelenmiÅŸ ve dengelenmemiÅŸ kuvvetler"
            ],
            "Ä°ÅŸ, GÃ¼Ã§ ve Enerji": [
                "Ä°ÅŸ, GÃ¼Ã§, Enerji Ã‡eÅŸitleri (Kinetik, Potansiyel)",
                "Enerji dÃ¶nÃ¼ÅŸÃ¼mleri","Verim",
                "Enerjinin Korunumu",
                ],
                
            
            "IsÄ± ve SÄ±caklÄ±k":["IsÄ± alÄ±ÅŸveriÅŸi, hal deÄŸiÅŸimleri, genleÅŸme olaylarÄ±, Ã–z IsÄ±, IsÄ± Ä°letimi"]
        
        },
        "Elektrik, BasÄ±nÃ§, Dalgalar ve Optik (10. SÄ±nÄ±f)": {
            
            
            "BasÄ±nÃ§ ve KaldÄ±rma Kuvveti": [
                "KatÄ±, SÄ±vÄ± ve Gaz BasÄ±ncÄ±, Pascal Prensibi, Bernoulli Ä°lkesi",
                "KaldÄ±rma Kuvveti"
            ],

            "Dalgalar": [
                "Su dalgalarÄ±, ses dalgalarÄ±, dalga boyu, frekans",
                ],
            "Optik":[ "Aynalar, mercekler, Ä±ÅŸÄ±ÄŸÄ±n kÄ±rÄ±lmasÄ± ve yansÄ±masÄ±"],
            
            "Elektrik ve Manyetizma": [
                "Elektrik yÃ¼kleri, akÄ±m, direnÃ§, Ohm kanunu, devre elemanlarÄ±, manyetik alan"
            ]
        },
    
    },
    "TYT Kimya": {
        "1. Kimya Bilimi, Atom ve EtkileÅŸimler (9. SÄ±nÄ±f)": {
            "Kimya Bilimine GiriÅŸ": [
                "KimyanÄ±n Alt DallarÄ± ve Ã‡alÄ±ÅŸma AlanlarÄ±",
                "Laboratuvar GÃ¼venlik KurallarÄ± ve Semboller"
            ],
            "Atom ve Periyodik Sistem": [
                "Atom Modelleri, Atomun YapÄ±sÄ± (P, N, E)",
                "Ä°zotop, Ä°zoton, Ä°zobar Tanecikler",
                "Periyodik Sistem Ã–zellikleri ve SÄ±nÄ±flandÄ±rma"
            ],
            "Kimyasal TÃ¼rler ArasÄ± EtkileÅŸimler": [
                "GÃ¼Ã§lÃ¼ EtkileÅŸimler (Ä°yonik, Kovalent, Metalik BaÄŸ)",
                "ZayÄ±f EtkileÅŸimler (van der Waals, Hidrojen BaÄŸlarÄ±)",
                "Fiziksel ve Kimyasal DeÄŸiÅŸimler"
            ]
        },
        "2. Madde Halleri ve Hesaplamalar (9. ve 10. SÄ±nÄ±f)": {
            "Maddenin HÃ¢lleri ve Ã‡evre KimyasÄ±": [
                "KatÄ±, SÄ±vÄ±, Gaz, Plazma ve HÃ¢l DeÄŸiÅŸimleri",
                "GazlarÄ±n Temel Ã–zellikleri",
                "DoÄŸa ve Kimya (Su, Hava, Toprak KirliliÄŸi, Geri DÃ¶nÃ¼ÅŸÃ¼m)"
            ],
            "KimyanÄ±n Temel KanunlarÄ± ve Hesaplamalar": [
                "KÃ¼tlenin Korunumu, Sabit ve KatlÄ± Oranlar Kanunu",
                "Mol KavramÄ±",
                "Kimyasal Tepkime Denklemleri, DenkleÅŸtirme",
                "Tepkime TÃ¼rleri, Verim HesaplamalarÄ± (Temel DÃ¼zey)"
            ]
        },
        "3. KarÄ±ÅŸÄ±mlar, Asitler/Bazlar ve Kimya Her Yerde (10. SÄ±nÄ±f)": {
            "KarÄ±ÅŸÄ±mlar ve Ã‡Ã¶zeltiler": [
                "Homojen ve Heterojen KarÄ±ÅŸÄ±mlar",
                "Ã‡Ã¶zelti TÃ¼rleri, Ã‡Ã¶zÃ¼nme SÃ¼reci",
                "DeriÅŸim Birimleri (KÃ¼tlece/Hacimce YÃ¼zde)"
            ],
            "Asitler, Bazlar ve Tuzlar": [
                "Asit ve Baz TanÄ±mlarÄ± ve Ã–zellikleri",
                "Asit-Baz Tepkimeleri, pH KavramÄ±",
                "Tuzlar ve KullanÄ±m AlanlarÄ±"
            ],
            "Kimya Her Yerde": [
                "YaygÄ±n Polimerler",
                "Sabun ve Deterjanlar",
                "Ä°laÃ§lar, GÄ±dalar, Temizlik Maddeleri"
            ]
        }
    },
    "TYT Biyoloji": {
        "1. YaÅŸam Bilimi ve Temel BileÅŸikler (9. SÄ±nÄ±f)": [
            "CanlÄ±larÄ±n Ortak Ã–zellikleri",
            "CanlÄ±larÄ±n YapÄ±sÄ±nda Bulunan Ä°norganik BileÅŸikler",
            "CanlÄ±larÄ±n YapÄ±sÄ±nda Bulunan Organik BileÅŸikler"
        ],
        "2. HÃ¼cre, SÄ±nÄ±flandÄ±rma ve Ã‚lemler (9. SÄ±nÄ±f)": [
            "HÃ¼cresel YapÄ±lar ve GÃ¶revleri",
            "HÃ¼cre ZarÄ±ndan Madde GeÃ§iÅŸleri",
            "CanlÄ±larÄ±n SÄ±nÄ±flandÄ±rÄ±lmasÄ±",
            "CanlÄ± Ã‚lemleri"
        ],
        "3. Ãœreme, KalÄ±tÄ±m ve Genetik (10. SÄ±nÄ±f)": [
            "HÃ¼cre DÃ¶ngÃ¼sÃ¼ ve Mitoz",
            "EÅŸeysiz Ãœreme",
            "Mayoz",
            "EÅŸeyli Ãœreme",
            
            "KalÄ±tÄ±m Konusu",
            "Genetik Varyasyonlar"
        ],  
         
        "4. Ekoloji ve Ã‡evre (10. SÄ±nÄ±f)": [
            "Ekosistem Ekolojisi",
            "GÃ¼ncel Ã‡evre SorunlarÄ±",
            "DoÄŸal KaynaklarÄ±n SÃ¼rdÃ¼rÃ¼lebilirliÄŸi",
            "Biyolojik Ã‡eÅŸitliliÄŸin KorunmasÄ±"
        ]
    },
    "AYT Matematik": {
        "Cebir, Fonksiyonlar,SayÄ± Sistemleri": [
            "Fonksiyonlar (Ä°leri DÃ¼zey)",
            "Polinomlar",
            "2. Dereceden Denklemler",
            "KarmaÅŸÄ±k SayÄ±lar",
            "2. Dereceden EÅŸitsizlikler",
            "Parabol"
        
            "Trigonometri",
            "Logaritma",
            "Diziler",
            "Limit",
            "TÃ¼rev",
            "Ä°ntegral"
        ],
        "OlasÄ±lÄ±k ": [
            "PermÃ¼tasyon ve Kombinasyon",
            "Binom ve OlasÄ±lÄ±k",
            "Ä°statistik"
        ]
    },
    "AYT Edebiyat": {
        "1. Temel Edebiyat Bilgisi ve Kuramsal YaklaÅŸÄ±m": [
            "GÃ¼zel Sanatlar ve Edebiyat Ä°liÅŸkisi",
            "Metinlerin SÄ±nÄ±flandÄ±rÄ±lmasÄ±",
            "Edebi Sanatlar (SÃ¶z ve Anlam SanatlarÄ±)",
            "Edebiyat AkÄ±mlarÄ± (BatÄ± ve TÃ¼rk EdebiyatÄ±ndaki Etkisi)",
            "DÃ¼nya EdebiyatÄ± (Ã–nemli Temsilciler ve Eserler)"
        ],
        "2. Anlam, Dil Bilgisi ve Åiir YapÄ±sÄ±": [
            "Anlam Bilgisi (SÃ¶zcÃ¼k, CÃ¼mle, Paragraf DÃ¼zeyinde)",
            "Dil Bilgisi (Ses, YapÄ±, CÃ¼mle Ã–ÄŸeleri, AnlatÄ±m BozukluklarÄ±)",
            "Åiir Bilgisi (NazÄ±m Birimi, Ã–lÃ§Ã¼, Uyak, Redif, Tema, Ä°mge)"
        ],
        "3. TÃ¼rk EdebiyatÄ±nÄ±n DÃ¶nemleri (Ä°slamiyet Ã–ncesi ve SonrasÄ±)": [
            "TÃ¼rk EdebiyatÄ± DÃ¶nemleri (Genel Ã–zellikler)",
            "Ä°slamiyet Ã–ncesi TÃ¼rk EdebiyatÄ± (SÃ¶zlÃ¼ ve YazÄ±lÄ±)",
            "Ä°slamiyet Etkisindeki GeÃ§iÅŸ DÃ¶nemi EdebiyatÄ±",
            "Halk EdebiyatÄ± (Anonim, Ã‚ÅŸÄ±k, Tekke/Dini-Tasavvufi)",
            "Divan EdebiyatÄ± (NazÄ±m BiÃ§imleri ve TÃ¼rleri)"
        ],
        "4. BatÄ± Etkisindeki Edebiyat (Tanzimat'tan Cumhuriyete)": [
            "Tanzimat DÃ¶nemi EdebiyatÄ± (1. ve 2. KuÅŸak)",
            "Servet-i FÃ¼nun EdebiyatÄ± (Edebiyat-Ä± Cedide)",
            "Fecr-i Ati EdebiyatÄ±",
            "Milli Edebiyat DÃ¶nemi",
            "Cumhuriyet DÃ¶nemi EdebiyatÄ± (Åiir, Hikaye, Roman, Tiyatro)"
        ],"5.Edebi AkÄ±mlar":[
            "Klasisizm",

            "Romantizm (CoÅŸumculuk)",

            "Realizm (GerÃ§ekÃ§ilik)",

            "NatÃ¼ralizm (DoÄŸalcÄ±lÄ±k)",

            "Parnasizm",

            "Sembolizm",

            "Empresyonizm (Ä°zlenimcilik)",

            "Ekspresyonizm (DÄ±ÅŸavurumculuk)",

            "FÃ¼tÃ¼rizm (GelecekÃ§ilik)",

            "KÃ¼bizm",

            "Dadaizm",

            "SÃ¼rrealizm (GerÃ§ekÃ¼stÃ¼cÃ¼lÃ¼k)",

            "Egzistansiyalizm (VaroluÅŸÃ§uluk)",

            "Ek:DÃ¼nya EdebiyatÄ±"
        ]
    },
    "AYT Tarih": {
        "1. Tarih Bilimi ve Ä°lk Ã‡aÄŸlar": [
            "Tarih ve Zaman (Temel Kavramlar)", "Ä°nsanlÄ±ÄŸÄ±n Ä°lk DÃ¶nemleri", "Orta Ã‡aÄŸ'da DÃ¼nya"
        ],
        "2. TÃ¼rk-Ä°slam Devletleri DÃ¶nemi": [
            "Ä°lk ve Orta Ã‡aÄŸlarda TÃ¼rk DÃ¼nyasÄ±", "Ä°slam Medeniyetinin DoÄŸuÅŸu",
            "TÃ¼rklerin Ä°slamiyet'i KabulÃ¼ ve Ä°lk TÃ¼rk Ä°slam Devletleri", "YerleÅŸme ve DevletleÅŸme SÃ¼recinde SelÃ§uklu TÃ¼rkiyesi"
        ],
        "3. Klasik Ã‡aÄŸ OsmanlÄ± Tarihi (KuruluÅŸ ve YÃ¼kselme)": [
            "Beylikten Devlete OsmanlÄ± Siyaseti", "DevletleÅŸme SÃ¼recinde SavaÅŸÃ§Ä±lar ve Askerler",
            "Beylikten Devlete OsmanlÄ± Medeniyeti", "DÃ¼nya GÃ¼cÃ¼ OsmanlÄ±",
            "Sultan ve OsmanlÄ± Merkez TeÅŸkilatÄ±", "Klasik Ã‡aÄŸda OsmanlÄ± Toplum DÃ¼zeni"
        ],
        "4. Avrupa ve OsmanlÄ±'da DeÄŸiÅŸim SÃ¼reci (Gerileme ve DaÄŸÄ±lma)": [
            "DeÄŸiÅŸen DÃ¼nya Dengeleri KarÅŸÄ±sÄ±nda OsmanlÄ± Siyaseti", "DeÄŸiÅŸim Ã‡aÄŸÄ±nda Avrupa ve OsmanlÄ±",
            "UluslararasÄ± Ä°liÅŸkilerde Denge Stratejisi (1774-1914)", "Devrimler Ã‡aÄŸÄ±nda DeÄŸiÅŸen Devlet-Toplum Ä°liÅŸkileri",
            "Sermaye ve Emek", "XIX. ve XX. YÃ¼zyÄ±lda DeÄŸiÅŸen GÃ¼ndelik Hayat"
        ],
        "5. TÃ¼rkiye Cumhuriyeti Tarihi": [
            "XX. YÃ¼zyÄ±l BaÅŸlarÄ±nda OsmanlÄ± Devleti ve DÃ¼nya", "Milli MÃ¼cadele", "AtatÃ¼rkÃ§Ã¼lÃ¼k ve TÃ¼rk Ä°nkÄ±labÄ±"
        ],
        "6. YakÄ±n Ã‡aÄŸda DÃ¼nya ve TÃ¼rkiye": [
            "Ä°ki SavaÅŸ ArasÄ±ndaki DÃ¶nemde TÃ¼rkiye ve DÃ¼nya", "II. DÃ¼nya SavaÅŸÄ± SÃ¼recinde TÃ¼rkiye ve DÃ¼nda",
            "II. DÃ¼nya SavaÅŸÄ± SonrasÄ±nda TÃ¼rkiye ve DÃ¼nya", "Toplumsal Devrim Ã‡aÄŸÄ±nda DÃ¼nya ve TÃ¼rkiye",
            "XXI. YÃ¼zyÄ±lÄ±n EÅŸiÄŸinde TÃ¼rkiye ve DÃ¼nya"
        ]
    },
    "AYT CoÄŸrafya": {
        "1. DoÄŸal Sistemler ve BiyocoÄŸrafya": [
            "Ekosistem", "BiyoÃ§eÅŸitlilik", "Biyomlar", "Ekosistemin UnsurlarÄ±", "Enerji AkÄ±ÅŸÄ± ve Madde DÃ¶ngÃ¼sÃ¼"
        ],
        "2. BeÅŸeri CoÄŸrafya ve Demografi": [
            "NÃ¼fus PolitikalarÄ±", "TÃ¼rkiye'de NÃ¼fus ve YerleÅŸme", "GÃ¶Ã§ ve ÅehirleÅŸme"
        ],
        "3. Ekonomik CoÄŸrafya ve TÃ¼rkiye Ekonomisi": [
            "Ekonomik Faaliyetler ve DoÄŸal Kaynaklar", "TÃ¼rkiye Ekonomisi",
            "TÃ¼rkiye'nin Ekonomi PolitikalarÄ±", "TÃ¼rkiye Ekonomisinin SektÃ¶rel DaÄŸÄ±lÄ±mÄ±",
            "TÃ¼rkiye'de TarÄ±m", "TÃ¼rkiye'de HayvancÄ±lÄ±k", "TÃ¼rkiye'de Madenler ve Enerji KaynaklarÄ±", "TÃ¼rkiye'de Sanayi", "TÃ¼rkiye'de UlaÅŸÄ±m", "TÃ¼rkiye'de Ticaret ve Turizm", "GeÃ§miÅŸten GeleceÄŸe Åehir ve Ekonomi", "TÃ¼rkiye'nin Ä°ÅŸlevsel BÃ¶lgeleri ve KalkÄ±nma Projeleri", "Hizmet SektÃ¶rÃ¼nÃ¼n Ekonomideki Yeri"
        ],
        "4. KÃ¼resel BaÄŸlantÄ±lar ve Jeopolitik": [
            "KÃ¼resel Ticaret", "BÃ¶lgeler ve Ãœlkeler", "Ä°lk UygarlÄ±klar", "KÃ¼ltÃ¼r BÃ¶lgeleri ve TÃ¼rk KÃ¼ltÃ¼rÃ¼", "SanayileÅŸme SÃ¼reci: Almanya", "TarÄ±m ve Ekonomi Ä°liÅŸkisi Fransa - Somali", "Ãœlkeler ArasÄ± EtkileÅŸim", "Jeopolitik Konum", "Ã‡atÄ±ÅŸma BÃ¶lgeleri", "KÃ¼resel ve BÃ¶lgesel Ã–rgÃ¼tler"
        ],
        "5. Ã‡evre, Ä°klim ve SÃ¼rdÃ¼rÃ¼lebilirlik": [
            "Ekstrem DoÄŸa OlaylarÄ±", "KÃ¼resel Ä°klim DeÄŸiÅŸimi", "Ã‡evre ve Toplum", "Ã‡evre SorunlarÄ± ve TÃ¼rleri", "Madenler ve Enerji KaynaklarÄ±nÄ±n Ã‡evreye Etkisi", "DoÄŸal KaynaklarÄ±n SÃ¼rdÃ¼rÃ¼lebilir KullanÄ±mÄ±", "Ekolojik Ayak Ä°zi", "DoÄŸal Ã‡evrenin SÄ±nÄ±rlÄ±lÄ±ÄŸÄ±", "Ã‡evre PolitikalarÄ±", "Ã‡evresel Ã–rgÃ¼tler", "Ã‡evre AnlaÅŸmalarÄ±", "DoÄŸal Afetler"
        ]
    },
    "AYT Fizik": {
        "1. Mekanik ve Enerji": [
            "Kuvvet ve Hareket (VektÃ¶rler, BaÄŸÄ±l, Newton YasalarÄ±)", "Ä°ÅŸ - GÃ¼Ã§ - Enerji (Korunum, Verim)", "AtÄ±ÅŸlar (Yatay, EÄŸik, DÃ¼ÅŸey)", "Basit Makineler", "KÃ¼tle Merkezi - Tork - Denge"
        ],
        "2. Elektrik ve Manyetizma": [
            "Elektrostatik (Alan, Potansiyel)", "Elektrik ve Manyetizma (AkÄ±m, DirenÃ§, Manyetik Alan, Kuvvet, Ä°ndÃ¼ksiyon)"
        ],
        "3. BasÄ±nÃ§, Maddenin Halleri ve Termodinamik": [
            "Madde ve Ã–zellikleri (KatÄ±, SÄ±vÄ±, Gaz)", "BasÄ±nÃ§ - KaldÄ±rma Kuvveti", "IsÄ± - SÄ±caklÄ±k - GenleÅŸme (Termodinamik YasalarÄ± Temelleri)"
        ],
        "4. TitreÅŸim ve Dalgalar": [
            "Dalgalar (Yay, Su, Ses, Deprem)", "Optik (YansÄ±ma, KÄ±rÄ±lma, Ayna, Mercek)", "DÃ¼zgÃ¼n Ã‡embersel Hareket", "Basit Harmonik Hareket"
        ],
        "5. Modern Fizik ve UygulamalarÄ±": [
            "Fizik Bilimine GiriÅŸ (Temeller)", "Atom FiziÄŸine GiriÅŸ ve Radyoaktivite", "Modern Fizik (Ã–zel GÃ¶relilik, Kuantum, Fotoelektrik Olay)"
        ]
    },
    "AYT Kimya": {
        "GiriÅŸ Konular":
                ["Modern Atom Teorisi","Gazlar","SÄ±vÄ± Ã‡Ã¶zeltiler ve Ã‡Ã¶zÃ¼nÃ¼rlÃ¼k",
                "Kimyasal Tepkimelerde Enerji","Kimyasal Tepkimelerde HÄ±z", ],
               
     "Kimyasal Tepkimelerde Denge":["Denge Sabiti", "Etkileyen FaktÃ¶rler)", "Asit-Baz Dengesi (pH, pOH, Titrasyon)", "Ã‡Ã¶zÃ¼nÃ¼rlÃ¼k Dengesi (Ã‡Ã¶zÃ¼nÃ¼rlÃ¼k Ã‡arpÄ±mÄ± - KÃ§Ã§"],
                
    "Kimya ve Elektrik":["(Redoks,Elektrot, Pil Potansiyeli)", "Elektroliz ve Korozyon", "Enerji KaynaklarÄ± ve Bilimsel GeliÅŸmeler"],
        
                                                                                                                           

    "Organik Kimya": [
            "Organik Kimyaya GiriÅŸ (Temel Kavramlar, HibritleÅŸme)","Karbon KimyasÄ±na GiriÅŸ", "Organik Kimya (Fonksiyonel Gruplar, Alkan, Alken, Alkin, Aromatikler)"
        ]
    },
    "AYT Biyoloji": {
        "1. Ä°nsan Fizyolojisi (Sistemler)": [
            "Sinir Sistemi", "Endokrin Sistem ve Hormonlar", "Duyu OrganlarÄ±", "Destek ve Hareket Sistemi", "Sindirim Sistemi", "DolaÅŸÄ±m ve BaÄŸÄ±ÅŸÄ±klÄ±k Sistemi", "Solunum Sistemi", "Ãœriner Sistem (BoÅŸaltÄ±m Sistemi)", "Ãœreme Sistemi ve Embriyonik GeliÅŸim"
        ],
        "2. MolekÃ¼ler Biyoloji ve Genetik": [
            "NÃ¼kleik Asitler", "Genden Proteine", "Genetik Åifre ve Protein Sentezi"
        ],
        "3. CanlÄ±larda Enerji DÃ¶nÃ¼ÅŸÃ¼mleri": [
            "CanlÄ±lÄ±k ve Enerji", "CanlÄ±larda Enerji DÃ¶nÃ¼ÅŸÃ¼mleri (ATP, Enzim)", "Fotosentez", "Kemosentez", "HÃ¼cresel Solunum"
        ],
        "4. Bitki Biyolojisi ve Ekoloji": [
            "Bitki Biyolojisi (YapÄ±, TaÅŸÄ±ma, Beslenme)",
            "Bitkisel Hormonlar ve Hareketler",
            "Ekoloji ve Ã‡evre "
        ]
    },
    "AYT Felsefe":{
        "Felsefeâ€™nin Konusu":["Bilgi Felsefesi",
    "VarlÄ±k Felsefesi",
    "Ahlak Felsefesi",
    "Sanat Felsefesi",
    "Din Felsefesi",
    "Siyaset Felsefesi",
    "Bilim Felsefesi",
    "Ä°lk Ã‡aÄŸ Felsefesi",
    "MÃ– 6. YÃ¼zyÄ±l â€“ MS 2. YÃ¼zyÄ±l Felsefesi",
    "MS 2. YÃ¼zyÄ±l â€“ MS 15. YÃ¼zyÄ±l Felsefesi",
    "15. YÃ¼zyÄ±l â€“ 17. YÃ¼zyÄ±l Felsefesi",
    "18. YÃ¼zyÄ±l â€“ 19. YÃ¼zyÄ±l Felsefesi",
    "20. YÃ¼zyÄ±l Felsefesi"],
        
        "MantÄ±k KonularÄ±":["MantÄ±ÄŸa GiriÅŸ",
    "Klasik MantÄ±k",
    "MantÄ±k ve Dil",
    "Sembolik MantÄ±k"
    ],
        "Psikoloji Bilimini TanÄ±yalÄ±m":[ 
        "Psikolojinin Temel SÃ¼reÃ§leri",
        "Ã–ÄŸrenme Bellek DÃ¼ÅŸÃ¼nme",
        "Ruh SaÄŸlÄ±ÄŸÄ±nÄ±n Temelleri"
        ],
        "Sosyolojiye GiriÅŸ":[
        "Birey ve Toplum",
        "Toplumsal YapÄ±",
       "Toplumsal DeÄŸiÅŸme ve GeliÅŸme",
        "Toplum ve KÃ¼ltÃ¼r",
        "Toplumsal Kurumlar"] },

"AYT Din KÃ¼ltÃ¼rÃ¼ ve Ahlak Bilgisi":{
    "Konular":["DÃ¼nya ve Ahiret",
              "Kurâ€™anâ€™a GÃ¶re Hz. Muhammed",
               "Kurâ€™anâ€™da BazÄ± Kavramlar",
               "Kurâ€™anâ€™dan Mesajlar]",
               "Ä°nanÃ§la Ä°lgili Meseleler",
               "Ä°slam ve Bilim",
               "Anadolu'da Ä°slam",
               "Ä°slam DÃ¼ÅŸÃ¼ncesinde Tasavvufi Yorumlar ve Mezhepler",
               "GÃ¼ncel Dini Meseleler",
               "YaÅŸayan Dinler"]}

}

# ------------------------------------------------------------------------------------------------------
# --- YKS SON 6 YIL SORU Ä°STATÄ°STÄ°KLERÄ° (2019-2024) ---
YKS_QUESTION_STATS = {
    # TYT TÃ¼rkÃ§e
    "Ses Bilgisi": 8, "SÃ¶zcÃ¼k TÃ¼rleri": 12, "SÃ¶zcÃ¼k AnlamÄ±": 15, "CÃ¼mle Bilgisi": 18,
    "Anlam Bilgisi": 10, "YazÄ±m KurallarÄ±": 7, "Noktalama Ä°ÅŸaretleri": 6, "Paragraf": 25,
    "OkuduÄŸunu Anlama": 30, "AnlatÄ±m BozukluklarÄ±": 9,
    
    # TYT Matematik
    "Temel Kavramlar": 14, "SayÄ±lar": 18, "Mutlak DeÄŸer": 8, "ÃœslÃ¼ SayÄ±lar": 12,
    "KÃ¶klÃ¼ SayÄ±lar": 10, "Ã‡arpanlara AyÄ±rma": 15, "Rasyonel Ä°fadeler": 9, "EÅŸitsizlikler": 16,
    "Denklemler": 20, "Fonksiyonlar": 22, "Polinomlar": 11, "Ä°kinci Dereceden Denklemler": 14,
    "Logaritma": 13, "Diziler": 17, "Limit ve SÃ¼reklilik": 19, "TÃ¼rev": 21, "Ä°ntegral": 15,
    
    # TYT Geometri
    "Temel Geometri": 12, "AÃ§Ä±lar": 10, "ÃœÃ§genler": 18, "DÃ¶rtgenler": 14, "Ã‡ember": 16,
    "Analitik Geometri": 20, "Trigonometri": 15, "KatÄ± Cisimler": 13,
    
    # TYT Fizik
    "Fizik Bilimine GiriÅŸ": 3, "Madde ve Ã–zellikleri": 4, "Hareket": 8, "Kuvvet ve Hareket": 7,
    "Ä°ÅŸ, GÃ¼Ã§, Enerji": 6, "Ä°tme ve Momentum": 5, "Dalga MekaniÄŸi": 4, "Optik": 5,
    "Elektrostatik": 6, "AkÄ±m ve Manyetizma": 5, "Modern Fizik": 4,
    
    # TYT Kimya
    "Kimya Bilimi": 2, "Atom ve Periyodik Sistem": 6, "Kimyasal TÃ¼rler ArasÄ± EtkileÅŸimler": 5,
    "Maddenin Halleri": 4, "KarÄ±ÅŸÄ±mlar": 3, "Asit-Baz": 6, "Kimyasal Tepkimeler": 7,
    "Enerji": 4, "Elektrokimya": 3, "Organik Kimya": 5,
    
    # TYT Biyoloji  
    "CanlÄ±lÄ±ÄŸÄ±n Temel Birimi HÃ¼cre": 8, "HÃ¼cre BÃ¶lÃ¼nmeleri": 6, "KalÄ±tÄ±m": 7,
    "Ekosistem Ekolojisi": 5, "GÃ¼ncel Ã‡evre SorunlarÄ±": 4, "CanlÄ±larÄ±n Ã‡eÅŸitliliÄŸi": 6,
    "Ä°nsan Fizyolojisi": 9, "Sinir Sistemi": 4, "Duyu OrganlarÄ±": 3, "Endokrin Sistem": 5,
    
    # TYT Tarih
    "Ä°slamiyetten Ã–nce TÃ¼rkler": 8, "Ä°slamiyet'in DoÄŸuÅŸu": 6, "TÃ¼rklerde Ä°slamiyet": 7,
    "KarahanlÄ±lar": 4, "Gazneliler": 3, "BÃ¼yÃ¼k SelÃ§uklular": 5, "Anadolu SelÃ§uklularÄ±": 6,
    "Beylikler DÃ¶nemi": 4, "OsmanlÄ± KuruluÅŸ": 8, "OsmanlÄ± YÃ¼kselme": 9,
    "OsmanlÄ± Duraklama": 7, "OsmanlÄ± Gerileme": 8, "19. YÃ¼zyÄ±l": 12, "20. YÃ¼zyÄ±l": 15,
    
    # TYT CoÄŸrafya
    "DoÄŸal Sistemler": 12, "BeÅŸeri Sistemler": 8, "Ekonomik Faaliyetler": 6,
    "TÃ¼rkiye'nin CoÄŸrafi Ã–zellikleri": 10, "Ã‡evre ve Toplum": 7, "KÃ¼resel Ortam": 5,
    "CoÄŸrafi Bilgi Sistemleri": 4,
    
    # TYT Felsefe
    "Felsefenin Konusu": 8, "Bilgi Felsefesi (Epistemoloji)": 6, "VarlÄ±k Felsefesi (Ontoloji)": 5,
    "Din, KÃ¼ltÃ¼r ve Medeniyet": 4, "Ahlak Felsefesi": 6, "Sanat Felsefesi": 3,
    "Din Felsefesi": 4, "Siyaset Felsefesi": 5, "Bilim Felsefesi": 4, "Ä°lk Ã‡aÄŸ Felsefesi": 7,
    "Sokrates ve Felsefesi": 3, "Platon ve Felsefesi": 4, "Aristoteles ve Felsefesi": 4,
    "Orta Ã‡aÄŸ Felsefesi": 3, "Ä°slam Felsefesi (Farabi, Ä°bn Sina)": 4, "Hristiyan Felsefesi (Augustinus, AquinalÄ± Thomas)": 3,
    
    # TYT Din KÃ¼ltÃ¼rÃ¼
    "Ä°nsan ve Din (Ä°nanÃ§)": 6, "Ahlak": 4, "Ä°badet": 5, "Peygamberlik": 4,
    "Kutsal Kitaplar": 3, "Ahiret Ä°nancÄ±": 3, "Dinler Tarihi": 4, "Ä°slam Tarihi": 6,
    "Hz. Muhammed'in HayatÄ±": 5, "Temel Dini Kavramlar": 4,
    
    # AYT Matematik
    "Trigonometri": 25, "Logaritma": 18, "Diziler": 20, "Limit": 22, "TÃ¼rev": 28,
    "Ä°ntegral": 24, "Analitik Geometri": 30, "KatÄ± Geometri": 15, "OlasÄ±lÄ±k": 18,
    "Ä°statistik": 12, "Matris": 8, "Determinant": 6,
    
    # AYT Fizik
    "Ã‡embersel Hareket": 12, "Basit Harmonik Hareket": 10, "Dalga MekaniÄŸi": 15,
    "Optik": 18, "Elektriksel Kuvvet ve Alan": 16, "Elektriksel Potansiyel": 14,
    "KondansatÃ¶rler": 8, "Elektrik AkÄ±mÄ±": 12, "Manyetizma": 15, "Elektromanyetik Ä°ndÃ¼ksiyon": 13,
    "Alternatif AkÄ±m": 9, "Atom FiziÄŸi": 8, "Modern Fizik": 10,
    
    # AYT Kimya
    "Modern Atom Teorisi": 12, "Periyodik Sistem": 15, "Kimyasal BaÄŸlar": 18,
    "Kimyasal Tepkimeler": 20, "Ã‡Ã¶zeltiler": 16, "Asit-Baz Dengesi": 14,
    "Ã‡Ã¶kelme Dengesi": 8, "Elektrokimya": 12, "Kimyasal Kinetik": 10,
    "Kimyasal Denge": 13, "Organik BileÅŸikler": 22, "Enerji ve Entropi": 6,
    
    # AYT Biyoloji
    "HÃ¼cre": 18, "HÃ¼cre BÃ¶lÃ¼nmeleri ve KalÄ±tÄ±m": 20, "CanlÄ±lÄ±k ve Enerji": 15,
    "Bitki Biyolojisi": 12, "Hayvan Biyolojisi": 25, "Ä°nsan Fizyolojisi": 22,
    "Ã‡evre Bilimi": 8, "CanlÄ±lÄ±ÄŸÄ±n Ã‡eÅŸitliliÄŸi": 10, "Ekoloji": 6,
    
    # AYT Edebiyat
    "SÃ¶z SanatlarÄ±": 15, "NazÄ±m Bilgisi": 12, "EdebÃ® Sanatlar": 18, "Tanzimat DÃ¶nemi": 20,
    "Servet-i FÃ¼nun": 14, "Fecr-i Ati": 8, "MillÃ® Edebiyat": 16, "Cumhuriyet DÃ¶nemi": 25,
    "Ã‡aÄŸdaÅŸ TÃ¼rk EdebiyatÄ±": 22, "Halk EdebiyatÄ±": 10, "Eski TÃ¼rk EdebiyatÄ±": 18,
    
    # AYT Tarih
    "OsmanlÄ± Devleti (1299-1566)": 35, "OsmanlÄ± Devleti (1566-1792)": 30,
    "DeÄŸiÅŸim Ã‡aÄŸÄ±nda OsmanlÄ±": 40, "MillÃ® MÃ¼cadele": 38, "AtatÃ¼rk Ä°lkeleri": 25,
    "Ä°kinci DÃ¼nya SavaÅŸÄ±": 28, "SoÄŸuk SavaÅŸ": 20, "Bipolar DÃ¼nya": 15,
    "Ã‡ok Kutuplu DÃ¼nya": 12, "KÃ¼reselleÅŸen DÃ¼nya": 10,
    
    # AYT CoÄŸrafya  
    "Yer Åekilleri": 22, "Ä°klim": 18, "Bitkiler": 12, "Toprak": 10,
    "NÃ¼fus": 20, "YerleÅŸme": 15, "Ekonomik Faaliyetler": 25, "UlaÅŸÄ±m ve Ä°letiÅŸim": 8,
    "TÃ¼rkiye'nin Fiziki CoÄŸrafyasÄ±": 30, "TÃ¼rkiye'nin BeÅŸeri CoÄŸrafyasÄ±": 28,
    "Ã‡evre SorunlarÄ±": 12, "DoÄŸal Afetler": 10,
    
    # AYT Felsefe
    "Felsefe Tarihi": 25, "Bilgi Felsefesi": 20, "VarlÄ±k Felsefesi": 15,
    "Ahlak Felsefesi": 18, "Sanat Felsefesi": 12, "Din Felsefesi": 10,
    "Siyaset Felsefesi": 16, "Bilim Felsefesi": 14, "Ã‡aÄŸdaÅŸ Felsefe": 20,
    
    # AYT Din KÃ¼ltÃ¼rÃ¼ ve Ahlak Bilgisi
    "DÃ¼nya ve Ahiret": 8, "Kur'an'a GÃ¶re Hz. Muhammed": 6, "Kur'an'da BazÄ± Kavramlar": 5,
    "Kur'an'dan Mesajlar": 7, "Ä°nanÃ§la Ä°lgili Meseleler": 4, "Ä°slam ve Bilim": 3,
    "Anadolu'da Ä°slam": 5, "Ä°slam DÃ¼ÅŸÃ¼ncesinde Tasavvufi Yorumlar ve Mezhepler": 6,
    "GÃ¼ncel Dini Meseleler": 4, "YaÅŸayan Dinler": 2
}

def get_topic_question_count(topic_name):
    """Bir konunun son 6 yÄ±lda kaÃ§ soru Ã§Ä±ktÄ±ÄŸÄ±nÄ± dÃ¶ndÃ¼r"""
    return YKS_QUESTION_STATS.get(topic_name, 0)

# ------------------------------------------------------------------------------------------------------
# --- DÃœZELTME: KONU YAPISI AYRIÅTIRICI FONKSÄ°YON ---
def get_categories(subject):
    """Belirli bir dersin tÃ¼m kategorilerini dÃ¶ndÃ¼rÃ¼r."""
    if subject not in YKS_TOPICS:
        return []
    
    return list(YKS_TOPICS[subject].keys())

def get_subcategories(subject, category):
    """Belirli bir ders ve kategorinin alt kategorilerini dÃ¶ndÃ¼rÃ¼r.
    
    EÄŸer kategori dict ise alt kategorilerini, list ise 'Ana Kategori' dÃ¶ndÃ¼rÃ¼r.
    """
    if subject not in YKS_TOPICS or category not in YKS_TOPICS[subject]:
        return []
    
    content = YKS_TOPICS[subject][category]
    
    if isinstance(content, dict):
        # Alt kategoriler var
        return list(content.keys())
    else:
        # Liste (doÄŸrudan konular var)
        return ["Ana Kategori"]

def get_topics_detailed(subject, category, sub_category="Ana Kategori"):
    """Belirli bir ders, kategori ve alt kategorinin konularÄ±nÄ± dÃ¶ndÃ¼rÃ¼r."""
    if subject not in YKS_TOPICS or category not in YKS_TOPICS[subject]:
        return []
    
    content = YKS_TOPICS[subject][category]
    
    if isinstance(content, dict):
        # Alt kategoriler var
        if sub_category in content:
            return content[sub_category]
        else:
            # Ä°lk alt kategoriyi al
            return list(content.values())[0] if content else []
    elif isinstance(content, list):
        # DoÄŸrudan konular var (alt kategori yok)
        return content
    
    return []

def get_all_topics_for_cascade(subject, category):
    """Cascading dropdown iÃ§in tÃ¼m alt kategorileri ve konularÄ± getirir."""
    if subject not in YKS_TOPICS or category not in YKS_TOPICS[subject]:
        return [], []
    
    content = YKS_TOPICS[subject][category]
    
    if isinstance(content, dict):
        # Alt kategoriler var
        subcategories = list(content.keys())
        # TÃ¼m alt kategorilerden konularÄ± birleÅŸtir
        all_topics = []
        for sub_cat in subcategories:
            all_topics.extend(content[sub_cat])
        return subcategories, all_topics
    else:
        # DoÄŸrudan konular var (alt kategori yok)
        return ["Ana Kategori"], content

def get_topic_list(subject):
    """Belirli bir dersin tÃ¼m alt konularÄ±nÄ± dÃ¼z bir liste olarak dÃ¶ndÃ¼rÃ¼r."""
    if subject not in YKS_TOPICS:
        return []

    topic_list = []
    subject_content = YKS_TOPICS[subject]

    for category, content in subject_content.items():
        if isinstance(content, dict):
            # YapÄ± A: ÃœÃ§ seviyeli (Alt Kategori kullanÄ±ldÄ±)
            for sub_category, topics in content.items():
                for topic in topics:
                    topic_list.append(f"{subject} | {category} | {sub_category} | {topic}")
        elif isinstance(content, list):
            # YapÄ± B: Ä°ki seviyeli (Alt Kategori kullanÄ±lmadÄ±)
            for topic in content:
                topic_list.append(f"{subject} | {category} | None | {topic}")
        
    return topic_list

def count_total_topics():
    """Toplam konu sayÄ±sÄ±nÄ± hesaplar"""
    total = 0
    for subject, content in YKS_TOPICS.items():
        if isinstance(content, dict):
            # content dict ise, normal iÅŸlemi yap
            for category, sub_content in content.items():
                if isinstance(sub_content, dict):
                    for sub_category, topics in sub_content.items():
                        total += len(topics)
                elif isinstance(sub_content, list):
                    total += len(sub_content)
        elif isinstance(content, list):
            # content liste ise, doÄŸrudan sayÄ±sÄ±nÄ± ekle
            total += len(content)
    return total

def calculate_subject_progress(user_data):
    """KullanÄ±cÄ±nÄ±n ders bazÄ±nda ilerleme verilerini hesaplar"""
    progress_data = {}
    
    # KullanÄ±cÄ±nÄ±n konu takip verilerini al (topic_progress)
    topic_progress_str = user_data.get('topic_progress', '{}')
    try:
        if isinstance(topic_progress_str, str):
            topic_progress = json.loads(topic_progress_str)
        else:
            topic_progress = topic_progress_str if isinstance(topic_progress_str, dict) else {}
    except (json.JSONDecodeError, TypeError):
        topic_progress = {}
    
    # Her ders iÃ§in ilerleme hesapla
    for subject, content in YKS_TOPICS.items():
        total_count = 0
        completed_count = 0
        
        if isinstance(content, dict):
            for category, sub_content in content.items():
                if isinstance(sub_content, dict):
                    for sub_category, topics in sub_content.items():
                        for topic in topics:
                            topic_key = f"{subject} | {category} | {sub_category} | {topic}"
                            total_count += 1
                            
                            # Net 15+ olanlarÄ± tamamlanmÄ±ÅŸ say
                            net_score = topic_progress.get(topic_key, 0)
                            try:
                                net_score = int(float(str(net_score)))
                                if net_score >= 15:  # 15+ net tamamlanmÄ±ÅŸ sayÄ±lÄ±r
                                    completed_count += 1
                            except (ValueError, TypeError):
                                pass
                elif isinstance(sub_content, list):
                    for topic in sub_content:
                        topic_key = f"{subject} | {category} | None | {topic}"
                        total_count += 1
                        
                        # Net 15+ olanlarÄ± tamamlanmÄ±ÅŸ say
                        net_score = topic_progress.get(topic_key, 0)
                        try:
                            net_score = int(float(str(net_score)))
                            if net_score >= 15:  # 15+ net tamamlanmÄ±ÅŸ sayÄ±lÄ±r
                                completed_count += 1
                        except (ValueError, TypeError):
                            pass
        elif isinstance(content, list):
            for topic in content:
                topic_key = f"{subject} | None | None | {topic}"
                total_count += 1
                
                # Net 15+ olanlarÄ± tamamlanmÄ±ÅŸ say
                net_score = topic_progress.get(topic_key, 0)
                try:
                    net_score = int(float(str(net_score)))
                    if net_score >= 15:  # 15+ net tamamlanmÄ±ÅŸ sayÄ±lÄ±r
                        completed_count += 1
                except (ValueError, TypeError):
                    pass
        
        # Ä°lerleme yÃ¼zdesini hesapla
        percent = (completed_count / total_count * 100) if total_count > 0 else 0
        
        progress_data[subject] = {
            'total': total_count,
            'completed': completed_count,
            'percent': percent
        }
    
    return progress_data

def calculate_level(net_score):
    """Net skora gÃ¶re seviye gÃ¶stergesi hesaplar"""
    if net_score >= 18:
        return "ğŸ“ Uzman"
    elif net_score >= 15:
        return "ğŸš€ Ä°yi"
    elif net_score >= 12:
        return "ğŸ’ª Orta"
    elif net_score >= 8:
        return "ğŸ“˜ Temel"
    else:
        return "âš ï¸ ZayÄ±f"

# --- DÃœZELTME BÄ°TÄ°ÅÄ° ---

# Psikolojik Ã§alÄ±ÅŸma teknikleri
STUDY_TECHNIQUES = {
    "Feynman TekniÄŸi": {
        "icon": "ğŸ“",
        "description": "KarmaÅŸÄ±k konularÄ± sadeleÅŸtirip Ã¶ÄŸretir gibi anlatma yÃ¶ntemi.",
        "learning_styles": ["GÃ¶rsel", "Sosyal", "Ä°ÅŸitsel", "YazÄ±sal"],
        "steps": [
            "Konuyu seÃ§ ve sadeleÅŸtir",
            "Bir baÅŸkasÄ±na anlatÄ±r gibi aÃ§Ä±kla",
            "AnlamadÄ±ÄŸÄ±n yerleri belirle",
            "Tekrar gÃ¶zden geÃ§ir ve dÃ¼zelt"
        ],
        "psychological_effect": "Ã–ÄŸrenme gÃ¼venini artÄ±rÄ±r, derin kavrama becerisi kazandÄ±rÄ±r",
        "best_subjects": ["Fizik", "Biyoloji", "Tarih", "Felsefe"],
        "suitable_student": "Analitik dÃ¼ÅŸÃ¼nen, anlatmayÄ± seven, sosyal Ã¶ÄŸreniciler"
    },
    "Aktif HatÄ±rlama & AralÄ±klÄ± Tekrar": {
        "icon": "ğŸ¯",
        "description": "Bilgiyi pasif okumak yerine hatÄ±rlamaya dayalÄ± Ã¶ÄŸrenme.",
        "learning_styles": ["Kinestetik", "Bireysel", "YazÄ±sal"],
        "steps": [
            "Konuyu Ã§alÄ±ÅŸtÄ±ktan sonra kendine sorular sor",
            "ZorlandÄ±ÄŸÄ±n konulara daha kÄ±sa aralÄ±klarla dÃ¶n",
            "1â€“3â€“7â€“15 gÃ¼n kuralÄ±nÄ± uygula"
        ],
        "psychological_effect": "Unutma eÄŸrisini tersine Ã§evirir, kalÄ±cÄ±lÄ±ÄŸÄ± artÄ±rÄ±r, kaygÄ±yÄ± azaltÄ±r",
        "best_subjects": ["Biyoloji", "Kimya", "Tarih", "Edebiyat"],
        "suitable_student": "Disiplinli, planlÄ±, kendi baÅŸÄ±na Ã§alÄ±ÅŸan Ã¶ÄŸrenciler"
    },

    "Cornell Not Alma Sistemi": {
        "icon": "ğŸ“",
        "description": "NotlarÄ± soruâ€“cevapâ€“Ã¶zet ÅŸeklinde organize etme yÃ¶ntemi.",
        "learning_styles": ["YazÄ±sal", "GÃ¶rsel"],
        "steps": [
            "SayfayÄ± Ã¼Ã§e bÃ¶l (not, soru, Ã¶zet)",
            "Derste saÄŸ tarafa not al",
            "Sol tarafa sorular ekle",
            "Alt kÄ±smÄ± Ã¶zetle doldur"
        ],
        "psychological_effect": "NotlarÄ± dÃ¼zenli hale getirir, tekrarÄ± sistematikleÅŸtirir",
        "best_subjects": ["Tarih", "CoÄŸrafya", "Biyoloji"],
        "suitable_student": "DÃ¼zenli, yazÄ±lÄ± anlatÄ±mÄ± gÃ¼Ã§lÃ¼ Ã¶ÄŸrenciler"
    },
    "Zihin Haritalama": {
        "icon": "ğŸ§­",
        "description": "Bilgileri gÃ¶rsel baÄŸlantÄ±larla organize etme yÃ¶ntemi.",
        "learning_styles": ["GÃ¶rsel", "YaratÄ±cÄ±", "Sosyal"],
        "steps": [
            "Ortaya ana konuyu yaz",
            "Dallar halinde alt baÅŸlÄ±klar ekle",
            "Renk, sembol ve oklarla baÄŸlantÄ± kur"
        ],
        "psychological_effect": "Bilgiyi uzun sÃ¼reli belleÄŸe taÅŸÄ±r, soyut konularÄ± somutlaÅŸtÄ±rÄ±r",
        "best_subjects": ["CoÄŸrafya", "Biyoloji", "Edebiyat"],
        "suitable_student": "GÃ¶rsel dÃ¼ÅŸÃ¼nen, yaratÄ±cÄ± Ã¶ÄŸrenciler"
    },
    "SQ3R TekniÄŸi": {
        "icon": "ğŸ“–",
        "description": "Okuma ve anlama verimini artÄ±ran sistem.",
        "learning_styles": ["YazÄ±sal", "Ä°ÅŸitsel", "Analitik"],
        "steps": [
            "Konuya genel gÃ¶z at (Survey)",
            "BaÅŸlÄ±klarÄ± soruya Ã§evir (Question)",
            "Sorulara cevap arayarak oku (Read)",
            "Kendi cÃ¼mlelerinle tekrar et (Recite)",
            "Tekrar gÃ¶zden geÃ§ir (Review)"
        ],
        "psychological_effect": "OkuduÄŸunu anlama yeteneÄŸini geliÅŸtirir, odaklanmayÄ± gÃ¼Ã§lendirir",
        "best_subjects": ["Tarih", "Edebiyat", "Din KÃ¼ltÃ¼rÃ¼"],
        "suitable_student": "Okuma aÄŸÄ±rlÄ±klÄ± Ã§alÄ±ÅŸanlar, sÃ¶zel Ã¶ÄŸreniciler"
    },
    "Leitner Kutusu Sistemi": {
        "icon": "ğŸ—‚",
        "description": "Bilgiyi kart sistemiyle tekrar etmeye dayalÄ± teknik.",
        "learning_styles": ["YazÄ±sal", "Kinestetik"],
        "steps": [
            "Soruâ€“cevap kartlarÄ± hazÄ±rla",
            "DoÄŸru bildiklerini ileri kutuya koy, yanlÄ±ÅŸlarÄ± geride tut",
            "Geri kutulara daha sÄ±k dÃ¶n"
        ],
        "psychological_effect": "GÃ¶rsel baÅŸarÄ± hissi oluÅŸturur, tekrarÄ± eÄŸlenceli hale getirir",
        "best_subjects": ["Biyoloji", "Tarih", "Edebiyat", "Ä°ngilizce"],
        "suitable_student": "El ile Ã§alÄ±ÅŸmayÄ± seven, ezbere yatkÄ±n Ã¶ÄŸrenciler"
    },
    "Kaizen TekniÄŸi": {
        "icon": "ğŸŒ±",
        "description": "Her gÃ¼n kÃ¼Ã§Ã¼k ilerlemeler yapma felsefesi.",
        "learning_styles": ["Bireysel", "Kinestetik"],
        "steps": [
            "Her gÃ¼n kÃ¼Ã§Ã¼k hedef belirle",
            "10â€“15 dakikalÄ±k geliÅŸim adÄ±mlarÄ± oluÅŸtur",
            "HaftalÄ±k ilerleme gÃ¼nlÃ¼ÄŸÃ¼ tut"
        ],
        "psychological_effect": "Disiplin ve Ã¶z gÃ¼ven geliÅŸtirir, mÃ¼kemmeliyetÃ§ilik kaygÄ±sÄ±nÄ± kÄ±rar",
        "best_subjects": ["Her ders"],
        "suitable_student": "Motivasyonu dÃ¼ÅŸÃ¼k, baÅŸlayamayan Ã¶ÄŸrenciler"
    },
    "Mindfulness": {
        "icon": "ğŸ§˜",
        "description": "Dikkati ÅŸimdiye odaklayarak zihni sakinleÅŸtirme yÃ¶ntemi.",
        "learning_styles": ["Sosyal", "Kinestetik", "GÃ¶rsel"],
        "steps": [
            "5â€“10 dk nefes farkÄ±ndalÄ±ÄŸÄ± yap",
            "DÃ¼ÅŸÃ¼ncelerini gÃ¶zlemle, yargÄ±lama",
            "Derse baÅŸlamadan kÄ±sa meditasyon uygula"
        ],
        "psychological_effect": "SÄ±nav kaygÄ±sÄ±nÄ± azaltÄ±r, odaklanma kalitesini artÄ±rÄ±r",
        "best_subjects": ["TÃ¼m dersler (Ã¶zellikle deneme Ã¶ncesi)"],
        "suitable_student": "KaygÄ±lÄ±, stresli, aÅŸÄ±rÄ± dÃ¼ÅŸÃ¼nen Ã¶ÄŸrenciler"
    },
    "Dual Coding": {
        "icon": "ğŸ§©",
        "description": "GÃ¶rsel + sÃ¶zel yollarÄ± birlikte kullanarak Ã¶ÄŸrenme.",
        "learning_styles": ["GÃ¶rsel", "YazÄ±sal"],
        "steps": [
            "Bilgiyi tablo veya ÅŸekille ifade et",
            "GÃ¶rseli sÃ¶zel olarak aÃ§Ä±kla",
            "GÃ¶rsele bakarak hatÄ±rlama Ã§alÄ±ÅŸmasÄ± yap"
        ],
        "psychological_effect": "GÃ¶rsel hafÄ±zayÄ± gÃ¼Ã§lendirir, zor konularda somutluk saÄŸlar",
        "best_subjects": ["Biyoloji", "CoÄŸrafya", "Tarih"],
        "suitable_student": "GÃ¶rsel zekasÄ± yÃ¼ksek Ã¶ÄŸrenciler"
    },
    "Gamification": {
        "icon": "ğŸ•¹",
        "description": "Dersleri puan ve Ã¶dÃ¼l sistemiyle eÄŸlenceli hale getirme.",
        "learning_styles": ["Sosyal", "Kinestetik"],
        "steps": [
            "GÃ¼nlÃ¼k hedefleri oyunlaÅŸtÄ±r (puan, seviye)",
            "BaÅŸarÄ±ya kÃ¼Ã§Ã¼k Ã¶dÃ¼ller koy",
            "ArkadaÅŸlarla yarÄ±ÅŸmalar dÃ¼zenle"
        ],
        "psychological_effect": "Motivasyon artar, sÄ±kÄ±lma azalÄ±r, dopamin etkisiyle Ã¶ÄŸrenme kalÄ±cÄ±lÄ±ÄŸÄ± yÃ¼kselir",
        "best_subjects": ["Deneme analizi", "tekrar gÃ¼nleri"],
        "suitable_student": "Sosyal, rekabeti seven Ã¶ÄŸrenciler"
    },
    "Interleaving": {
        "icon": "ğŸ”„",
        "description": "FarklÄ± konularÄ± karÄ±ÅŸtÄ±rarak Ã§alÄ±ÅŸmak.",
        "learning_styles": ["Analitik", "Kinestetik"],
        "steps": [
            "AynÄ± derste farklÄ± konular arasÄ±nda geÃ§iÅŸ yap",
            "GÃ¼nlÃ¼k programda dersleri sÄ±rayla karÄ±ÅŸtÄ±r",
            "Karma testlerle pratik yap"
        ],
        "psychological_effect": "Ezberden Ã§Ä±kmayÄ± saÄŸlar, soru Ã§Ã¶zme esnekliÄŸi kazandÄ±rÄ±r",
        "best_subjects": ["Matematik", "Fizik", "Kimya"],
        "suitable_student": "Analitik dÃ¼ÅŸÃ¼nen, deneysel Ã¶ÄŸrenen Ã¶ÄŸrenciler"
    },
    "Retrieval Practice": {
        "icon": "ğŸ“‹",
        "description": "Ã–ÄŸrendiklerini dÄ±ÅŸ kaynaÄŸa bakmadan hatÄ±rlama.",
        "learning_styles": ["YazÄ±sal", "Bireysel"],
        "steps": [
            "Konuyu Ã§alÄ±ÅŸ, kitabÄ± kapat",
            "Ne hatÄ±rlÄ±yorsan yaz veya anlat",
            "Eksik kÄ±sÄ±mlarÄ± belirle, dÃ¼zelt"
        ],
        "psychological_effect": "Bilgiyi uzun sÃ¼reli belleÄŸe taÅŸÄ±r, Ã¶z farkÄ±ndalÄ±ÄŸÄ± artÄ±rÄ±r",
        "best_subjects": ["Biyoloji", "Tarih", "Kimya"],
        "suitable_student": "Tekrar odaklÄ±, kendi baÅŸÄ±na Ã§alÄ±ÅŸan Ã¶ÄŸrenciler"
    },
    "SMART Hedef Sistemi": {
        "icon": "ğŸ¯",
        "description": "Spesifik, Ã–lÃ§Ã¼lebilir, UlaÅŸÄ±labilir, GerÃ§ekÃ§i, ZamanlÄ± hedeflerle plan yapma.",
        "learning_styles": ["Bireysel", "PlanlÄ±"],
        "steps": [
            "'GÃ¼nde 3 paragraf Ã§Ã¶zmek' gibi net hedef belirle",
            "Ã–lÃ§Ã¼lebilir ilerleme grafiÄŸi oluÅŸtur",
            "HaftalÄ±k kontrol et ve ayarla"
        ],
        "psychological_effect": "PlanlÄ± Ã§alÄ±ÅŸmayÄ± gÃ¼Ã§lendirir, baÅŸarÄ± hissi sÃ¼reklilik kazanÄ±r",
        "best_subjects": ["TÃ¼m dersler"],
        "suitable_student": "PlanlÄ±, hedef odaklÄ± Ã¶ÄŸrenciler"
    },
    "Sosyal Ã–ÄŸrenme TekniÄŸi": {
        "icon": "ğŸ’¬",
        "description": "Grup iÃ§inde tartÄ±ÅŸarak, Ã¶ÄŸreterek Ã¶ÄŸrenme.",
        "learning_styles": ["Sosyal", "Ä°ÅŸitsel"],
        "steps": [
            "Grup iÃ§inde konuyu anlat",
            "Soru-cevap yaparak tartÄ±ÅŸ",
            "Birbirinizin hatalarÄ±nÄ± dÃ¼zeltin"
        ],
        "psychological_effect": "Sosyal motivasyon saÄŸlar, konuyu anlatÄ±rken kalÄ±cÄ± Ã¶ÄŸrenme gerÃ§ekleÅŸir",
        "best_subjects": ["Tarih", "Felsefe", "Edebiyat"],
        "suitable_student": "Grup Ã§alÄ±ÅŸmasÄ±nÄ± seven, anlatÄ±cÄ± yÃ¶nÃ¼ gÃ¼Ã§lÃ¼ Ã¶ÄŸrenciler"
    },
    "Uyku & HafÄ±za TekniÄŸi": {
        "icon": "ğŸŒ™",
        "description": "Uyku sÄ±rasÄ±nda bilginin kalÄ±cÄ± hale gelmesi prensibine dayanÄ±r.",
        "learning_styles": ["TÃ¼m stiller"],
        "steps": [
            "Uyumadan Ã¶nce kÄ±sa tekrar yap",
            "7â€“8 saat uyku dÃ¼zeni koru",
            "Sabah aynÄ± bilgiyi test et"
        ],
        "psychological_effect": "Beyin, Ã¶ÄŸrenilen bilgileri kalÄ±cÄ± belleÄŸe taÅŸÄ±r, unutmayÄ± %40 oranÄ±nda azaltÄ±r",
        "best_subjects": ["TÃ¼m dersler"],
        "suitable_student": "DÃ¼zenli uykuya Ã¶nem veren, sabah verimli Ã§alÄ±ÅŸan Ã¶ÄŸrenciler"
    }
}

# YKS Ã–ÄŸrencisi Ã–ÄŸrenme Stili & BiliÅŸsel Profil TanÄ±mlarÄ± (GÃ¼ncellenmiÅŸ)
LEARNING_STYLE_DESCRIPTIONS = {
    "Analitik Sistematik": {
        "title": "ğŸ”¬ Analitik Sistematik",
        "intro": "Sen problemleri adÄ±m adÄ±m Ã§Ã¶zen, mantÄ±klÄ± ve sistematik dÃ¼ÅŸÃ¼nen bir Ã¶ÄŸrencisin.",
        "strengths": ["Sistematik problem Ã§Ã¶zme", "DetaylÄ± analiz yapma", "MantÄ±klÄ± yaklaÅŸÄ±m", "PlanlÄ± Ã§alÄ±ÅŸma"],
        "weaknesses": ["Ã‡ok detaya takÄ±lma", "YaratÄ±cÄ± Ã§Ã¶zÃ¼mlerden kaÃ§Ä±nma"],
        "advice": "Konu anlatÄ±mlarÄ± â†’ Ã–rnek sorular â†’ Problemler sÄ±rasÄ± ile Ã§alÄ±ÅŸ. Konu Ã¶zetleri ve soru bankasÄ± kullan.",
        "study_tools": ["Konu Ã¶zetleri", "Soru bankasÄ±", "GÃ¼nlÃ¼k program", "AdÄ±m adÄ±m Ã§Ã¶zÃ¼m teknikleri"]
    },
    "GÃ¶rsel YaratÄ±cÄ±": {
        "title": "ğŸ¨ GÃ¶rsel YaratÄ±cÄ±",
        "intro": "Sen bilgiyi gÃ¶rsel unsurlarla iÅŸleyen ve yaratÄ±cÄ± Ã§Ã¶zÃ¼mler Ã¼reten bir Ã¶ÄŸrencisin.",
        "strengths": ["GÃ¶rsel hafÄ±za", "YaratÄ±cÄ± dÃ¼ÅŸÃ¼nce", "Åema ve grafik anlama", "Renk kodlama"],
        "weaknesses": ["Sadece dinleyerek Ã¶ÄŸrenmede zorluk", "Ã‡ok detaylÄ± metinlerde kaybolma"],
        "advice": "Zihin haritalarÄ±, renkli notlar ve grafik organizers kullan. GÃ¶rsel destekli kitaplarÄ± tercih et.",
        "study_tools": ["Kavram haritalarÄ±", "Renkli kalemler", "GÃ¶rsel destekli kitaplar", "Åema ve grafikler"]
    },
    "Ä°ÅŸitsel Sosyal": {
        "title": "ğŸ‘‚ Ä°ÅŸitsel Sosyal",
        "intro": "Sen dinleyerek Ã¶ÄŸrenen ve sosyal etkileÅŸimlerden beslenen bir Ã¶ÄŸrencisin.",
        "strengths": ["Dinleme becerisi", "TartÄ±ÅŸarak Ã¶ÄŸrenme", "Sosyal motivasyon", "Sesli tekrar"],
        "weaknesses": ["Sessiz ortamlarda zorlanma", "Bireysel Ã§alÄ±ÅŸmada motivasyon kaybÄ±"],
        "advice": "Grup Ã§alÄ±ÅŸmasÄ± yap, sesli tekrar et, ders videolarÄ± izle. Ã‡alÄ±ÅŸma gruplarÄ±na katÄ±l.",
        "study_tools": ["Ã‡alÄ±ÅŸma gruplarÄ±", "Sesli anlatÄ±m kaynaklarÄ±", "Ders videolarÄ±", "TartÄ±ÅŸma forumlarÄ±"]
    },
    "Kinestetik UygulamacÄ±": {
        "title": "âœ‹ Kinestetik UygulamacÄ±",
        "intro": "Sen yaparak Ã¶ÄŸrenen ve uygulamalÄ± Ã§alÄ±ÅŸmalardan hoÅŸlanan bir Ã¶ÄŸrencisin.",
        "strengths": ["Pratik uygulama", "Hareket halinde Ã¶ÄŸrenme", "Deney ve gÃ¶zlem", "Aktif katÄ±lÄ±m"],
        "weaknesses": ["Uzun teorik dersler", "Hareketsiz kalma", "Soyut kavramlar"],
        "advice": "Bol soru Ã§Ã¶zÃ¼mÃ¼ yap, deney videolarÄ± izle, pratik uygulamalar ara. Hareket halinde Ã§alÄ±ÅŸ.",
        "study_tools": ["Test kitaplarÄ±", "SimÃ¼lasyon programlarÄ±", "Laboratuvar videolarÄ±", "Mobil uygulamalar"]
    },
    "Ã–zerk Reflektif": {
        "title": "ğŸ’ª Ã–zerk Reflektif",
        "intro": "Sen bireysel Ã§alÄ±ÅŸmayÄ± seven ve derin dÃ¼ÅŸÃ¼nen bir Ã¶ÄŸrencisin.",
        "strengths": ["Bireysel odaklanma", "Derin analiz", "Ä°Ã§sel motivasyon", "Sessiz Ã§alÄ±ÅŸma"],
        "weaknesses": ["Sosyal desteÄŸe ihtiyaÃ§", "Motivasyon dalgalanmalarÄ±"],
        "advice": "Bireysel derin Ã§alÄ±ÅŸma yap, kendi kendine test et. KapsamlÄ± kaynaklardan yararlan.",
        "study_tools": ["KapsamlÄ± kaynak kitaplar", "Online testler", "KiÅŸisel Ã§alÄ±ÅŸma planÄ±", "Sessiz Ã§alÄ±ÅŸma ortamÄ±"]
    }
}

# ===== VAK Ã–ÄRENME STÄ°LLERÄ° TESTÄ° =====
# A Kategorisi: GÃ¶rsel (20 soru)
# B Kategorisi: Ä°ÅŸitsel (20 soru)  
# C Kategorisi: Kinestetik (20 soru)
VAK_LEARNING_STYLES_TEST = [
    # ===== A KATEGORÄ°SÄ° - GÃ–RSEL Ã–ÄRENME STÄ°LÄ° =====
    {
        "question": "Biri bana ders verir gibi bir ÅŸeyler anlatÄ±rsa baÅŸka dÃ¼nyalara dalarÄ±m",
        "category": "A",
        "type": "visual"
    },
    {
        "question": "Temiz ve dÃ¼zenli bir sÄ±raya sahip olmak isterim",
        "category": "A", 
        "type": "visual"
    },
    {
        "question": "SÃ¶zel yÃ¶nergeleri kullanamam, haritaya gereksinim duyarÄ±m",
        "category": "A",
        "type": "visual"
    },
    {
        "question": "DuyduÄŸum ama gÃ¶rmediÄŸim yÃ¶nergelere dikkat etmekte zorlanÄ±rÄ±m",
        "category": "A",
        "type": "visual"
    },
    {
        "question": "Resimli bulmaca Ã§Ã¶zmeyi severim",
        "category": "A",
        "type": "visual"
    },
    {
        "question": "Sessiz okumayÄ± severim",
        "category": "A",
        "type": "visual"
    },
    {
        "question": "SÃ¶zcÃ¼kleri hatasÄ±z yazarÄ±m",
        "category": "A",
        "type": "visual"
    },
    {
        "question": "GÃ¶rdÃ¼klerimi iyi hatÄ±rlarÄ±m",
        "category": "A",
        "type": "visual"
    },
    {
        "question": "Olaylar ve/ya konular ÅŸematize edilirse daha iyi anlarÄ±m",
        "category": "A",
        "type": "visual"
    },
    {
        "question": "KonuÅŸmacÄ±nÄ±n aÄŸzÄ±nÄ± izlerim",
        "category": "A",
        "type": "visual"
    },
    {
        "question": "Resimli roman okumayÄ± severim",
        "category": "A",
        "type": "visual"
    },
    {
        "question": "ÅarkÄ± sÃ¶zlerini hatÄ±rlamakta zorlanÄ±rÄ±m",
        "category": "A",
        "type": "visual"
    },
    {
        "question": "Okunmakta olan bir metnin kopyasÄ±nÄ± takip etmezsem anlamakta zorlanÄ±rÄ±m",
        "category": "A",
        "type": "visual"
    },
    {
        "question": "SÃ¶zel tariflerin tekrarlanmasÄ±nÄ± isterim",
        "category": "A",
        "type": "visual"
    },
    {
        "question": "Kendi kendime dÃ¼ÅŸÃ¼nÃ¼p, Ã§alÄ±ÅŸarak Ã¶ÄŸrenmeyi severim",
        "category": "A",
        "type": "visual"
    },
    {
        "question": "Derslerde not tutmayÄ± tercih ederim",
        "category": "A",
        "type": "visual"
    },
    {
        "question": "BoÅŸ zamanlarÄ±mda okumayÄ± severim",
        "category": "A",
        "type": "visual"
    },
    {
        "question": "BaÅŸkalarÄ±nÄ±n ne yaptÄ±ÄŸÄ±nÄ± gÃ¶zlerim",
        "category": "A",
        "type": "visual"
    },
    {
        "question": "Radyo ve televizyonu yÃ¼ksek sesle dinlerim",
        "category": "A",
        "type": "visual"
    },
    {
        "question": "Telefonda konuÅŸmayÄ± sevmem, yÃ¼z yÃ¼ze konuÅŸmayÄ± tercih ederim",
        "category": "A",
        "type": "visual"
    },
    
    # ===== B KATEGORÄ°SÄ° - Ä°ÅÄ°TSEL Ã–ÄRENME STÄ°LÄ° =====
    {
        "question": "Kendi kendime konuÅŸurum",
        "category": "B",
        "type": "auditory"
    },
    {
        "question": "BÃ¼tÃ¼n yanlÄ±ÅŸlarÄ±mÄ± Ã¶ÄŸretmenin anlatarak dÃ¼zeltmesini isterim",
        "category": "B",
        "type": "auditory"
    },
    {
        "question": "Okurken parmaÄŸÄ±mla takip ederim",
        "category": "B",
        "type": "auditory"
    },
    {
        "question": "SÄ±nÄ±fta arkadaÅŸlarÄ±mla tartÄ±ÅŸarak ve sohbet ederek Ã¶ÄŸrenmeyi severim",
        "category": "B",
        "type": "auditory"
    },
    {
        "question": "Okurken kaÄŸÄ±da Ã§ok yaklaÅŸÄ±rÄ±m",
        "category": "B",
        "type": "auditory"
    },
    {
        "question": "GÃ¶zlerimi ellerime dayarÄ±m",
        "category": "B",
        "type": "auditory"
    },
    {
        "question": "Daha iyi Ã¶ÄŸrenmek iÃ§in mÃ¼zik ve ritmi severim",
        "category": "B",
        "type": "auditory"
    },
    {
        "question": "SÄ±nÄ±fta Ã§ok fazla konuÅŸurum",
        "category": "B",
        "type": "auditory"
    },
    {
        "question": "BoÅŸ zamanlarÄ±mda arkadaÅŸlarÄ±mla konuÅŸmayÄ± ve ÅŸaka yapmayÄ± severim",
        "category": "B",
        "type": "auditory"
    },
    {
        "question": "Genellikle grafikler, sembol ve simgeler benim Ã¶ÄŸrenmemi kolaylaÅŸtÄ±rmaz",
        "category": "B",
        "type": "auditory"
    },
    {
        "question": "YÃ¼ksek sesle okumayÄ± severim",
        "category": "B",
        "type": "auditory"
    },
    {
        "question": "YazÄ±lÄ± karikatÃ¼rleri tercih ederim",
        "category": "B",
        "type": "auditory"
    },
    {
        "question": "Hikaye, ÅŸiir ve/ya kitap kasetleri dinlemeyi severim",
        "category": "B",
        "type": "auditory"
    },
    {
        "question": "AnlatmayÄ± yazmaya tercih ederim",
        "category": "B",
        "type": "auditory"
    },
    {
        "question": "GÃ¶rsel ve sÃ¶zcÃ¼k hatÄ±rlama hafÄ±zam iyi deÄŸildir",
        "category": "B",
        "type": "auditory"
    },
    {
        "question": "Kendi kendime Ã§alÄ±ÅŸmaktansa Ã¶ÄŸretmeni dinleyerek Ã¶ÄŸrenmeyi tercih ederim",
        "category": "B",
        "type": "auditory"
    },
    {
        "question": "Bir konu bana okunursa kendi okuduÄŸumdan daha iyi anlarÄ±m",
        "category": "B",
        "type": "auditory"
    },
    {
        "question": "Kopyalanacak bir ÅŸey olmadan kolay Ã§izemem",
        "category": "B",
        "type": "auditory"
    },
    {
        "question": "Haritalardan Ã§ok sÃ¶zel tarifleri ve yÃ¶nergeleri tercih ederim",
        "category": "B",
        "type": "auditory"
    },
    {
        "question": "SessizliÄŸe dayanamamâ€¦ ya ben ya da diÄŸerlerinin konuÅŸmasÄ±nÄ± isterim",
        "category": "B",
        "type": "auditory"
    },
    
    # ===== C KATEGORÄ°SÄ° - KÄ°NESTETÄ°K Ã–ÄRENME STÄ°LÄ° =====
    {
        "question": "BoÅŸ bir kaÄŸÄ±da sÃ¼tunlar Ã§izmem istendiÄŸinde kaÄŸÄ±dÄ± katlarÄ±m",
        "category": "C",
        "type": "kinesthetic"
    },
    {
        "question": "Ellerimi kullanabileceÄŸim bir ÅŸeyler yapmaktan hoÅŸlanÄ±rÄ±m",
        "category": "C",
        "type": "kinesthetic"
    },
    {
        "question": "Sandalyede otururken sallanÄ±rÄ±m ya da bacaÄŸÄ±mÄ± sallarÄ±m",
        "category": "C",
        "type": "kinesthetic"
    },
    {
        "question": "Defterimin iÃ§ini genellikle resimlerle, ÅŸekillerle sÃ¼slerim, karalama yaparÄ±m",
        "category": "C",
        "type": "kinesthetic"
    },
    {
        "question": "Kalemimi elimde dÃ¶ndÃ¼rÃ¼rÃ¼m, masada tempo tutarÄ±m",
        "category": "C",
        "type": "kinesthetic"
    },
    {
        "question": "Ã–ÄŸretmenlerim asla Ã§alÄ±ÅŸmadÄ±ÄŸÄ±mÄ± dÃ¼ÅŸÃ¼nÃ¼rler",
        "category": "C",
        "type": "kinesthetic"
    },
    {
        "question": "Ã–ÄŸretmenlerim sÄ±nÄ±fta Ã§ok fazla hareket ettiÄŸimi dÃ¼ÅŸÃ¼nÃ¼rler",
        "category": "C",
        "type": "kinesthetic"
    },
    {
        "question": "Genellikle hiperaktif olduÄŸum sÃ¶ylenir",
        "category": "C",
        "type": "kinesthetic"
    },
    {
        "question": "Ã‡alÄ±ÅŸÄ±rken sÄ±k sÄ±k ara verir, baÅŸka ÅŸeyler yaparÄ±m",
        "category": "C",
        "type": "kinesthetic"
    },
    {
        "question": "ArkadaÅŸlarÄ±ma el ÅŸakasÄ± yapmaya bayÄ±lÄ±rÄ±m",
        "category": "C",
        "type": "kinesthetic"
    },
    {
        "question": "KapÄ±nÄ±n Ã¼st Ã§erÃ§evesine asÄ±larak odaya atlamak isterim",
        "category": "C",
        "type": "kinesthetic"
    },
    {
        "question": "Aktif olarak katÄ±ldÄ±ÄŸÄ±m etkinlikleri severim",
        "category": "C",
        "type": "kinesthetic"
    },
    {
        "question": "Bir ÅŸeyi gÃ¶rmek ya da duymak yetmez, dokunmak isterim",
        "category": "C",
        "type": "kinesthetic"
    },
    {
        "question": "Her ÅŸeye dokunmak isterim",
        "category": "C",
        "type": "kinesthetic"
    },
    {
        "question": "Objeleri biriktirmeyi severim",
        "category": "C",
        "type": "kinesthetic"
    },
    {
        "question": "SÄ±nÄ±fta tahta silmeyi, pencere ya da kapÄ± aÃ§Ä±p kapatmayÄ± hep ben yapmak isterim",
        "category": "C",
        "type": "kinesthetic"
    },
    {
        "question": "KÃ¼rdanlarÄ±, kibritleri kÃ¼Ã§Ã¼k parÃ§alara ayÄ±rÄ±rÄ±m",
        "category": "C",
        "type": "kinesthetic"
    },
    {
        "question": "Aletleri aÃ§ar, iÃ§ini sÃ¶ker, sonra yine bir araya getirmeye Ã§alÄ±ÅŸÄ±rÄ±m",
        "category": "C",
        "type": "kinesthetic"
    },
    {
        "question": "Genellikle ellerimi kullanarak ve hÄ±zlÄ± konuÅŸurum",
        "category": "C",
        "type": "kinesthetic"
    },
    {
        "question": "BaÅŸkalarÄ±nÄ±n sÃ¶zÃ¼nÃ¼ sÄ±k sÄ±k keserim",
        "category": "C",
        "type": "kinesthetic"
    },
    
    # ===== YENÄ° SORULAR - GÃ–RSEL KATEGÃ–RÄ° =====
    {
        "question": "Matematik problemlerini Ã§Ã¶zerken mutlaka kaÄŸÄ±da Ã§izerim ve gÃ¶rselleÅŸtiririm",
        "category": "A",
        "type": "visual"
    },
    {
        "question": "Tarih derslerinde zaman Ã§izgisi ve kavram haritalarÄ± oluÅŸturmak bana yardÄ±mcÄ± olur",
        "category": "A",
        "type": "visual"
    },
    {
        "question": "Renkli vurgulayÄ±cÄ±lar ve kalemler olmadan verimli not alamam",
        "category": "A",
        "type": "visual"
    },
    {
        "question": "Bir konuyu anladÄ±ÄŸÄ±mÄ± anlamak iÃ§in gÃ¶rsel Ã¶rnekler gÃ¶rmek isterim",
        "category": "A",
        "type": "visual"
    },
    {
        "question": "Yeni bir yeri bulmak iÃ§in Google Maps'ten fotoÄŸraflarÄ± da incelerim",
        "category": "A",
        "type": "visual"
    },
    
    # ===== YENÄ° SORULAR - Ä°ÅÄ°TSEL KATEGÃ–RÄ° =====
    {
        "question": "FormÃ¼lleri aklÄ±mda tutmak iÃ§in ritim halinde tekrar ederim",
        "category": "B",
        "type": "auditory"
    },
    {
        "question": "ArkadaÅŸlarÄ±mla birlikte Ã§alÄ±ÅŸÄ±p konuÅŸarak Ã¶ÄŸrenmeyi severim",
        "category": "B",
        "type": "auditory"
    },
    {
        "question": "Podcast dinleyerek veya sesli kitap okuyarak Ã¶ÄŸrenmeyi tercih ederim",
        "category": "B",
        "type": "auditory"
    },
    {
        "question": "Derse odaklanmak iÃ§in hafif mÃ¼zik dinlemem gerekir",
        "category": "B",
        "type": "auditory"
    },
    {
        "question": "Soru Ã§Ã¶zerken adÄ±mlarÄ± kendi kendime sesli olarak aÃ§Ä±klarÄ±m",
        "category": "B",
        "type": "auditory"
    },
    
    # ===== YENÄ° SORULAR - KÄ°NESTETÄ°K KATEGÃ–RÄ° =====
    {
        "question": "Uzun sÃ¼reli ders dinlerken ayakta durma veya hareket etme ihtiyacÄ± duyarÄ±m",
        "category": "C",
        "type": "kinesthetic"
    },
    {
        "question": "Geometri problemlerini elle tutabilir objelerle modellemeyi severim",
        "category": "C",
        "type": "kinesthetic"
    },
    {
        "question": "Bir konuyu Ã¶ÄŸrenmek iÃ§in deney yapmayÄ± ve uygulamayÄ± tercih ederim",
        "category": "C",
        "type": "kinesthetic"
    },
    {
        "question": "Not alÄ±rken tablet yerine kaÄŸÄ±t kalem kullanmayÄ± tercih ederim",
        "category": "C",
        "type": "kinesthetic"
    },
    {
        "question": "25 dakika Ã§alÄ±ÅŸÄ±p 5 dakika ara verme sistemi bana uyar",
        "category": "C",
        "type": "kinesthetic"
    }
]

# ===== BÄ°LÄ°ÅSEL PROFÄ°L TESTÄ° =====
# 4 BÃ¶lÃ¼m x 5 Soru = 20 Soru (Likert 1-5)
COGNITIVE_PROFILE_TEST = [
    # ===== BÃ–LÃœM 1: BÄ°LÄ°ÅSEL Ä°ÅLEME STÄ°LÄ° =====
    {
        "question": "KarmaÅŸÄ±k bir konuyu kÃ¼Ã§Ã¼k parÃ§alara bÃ¶lerek Ã¶ÄŸrenirim.",
        "category": "analytic_thinking",
        "section": "ğŸ”¬ BiliÅŸsel Ä°ÅŸleme Stili",
        "dimension": "Analitik"
    },
    {
        "question": "Bir konunun tÃ¼mÃ¼nÃ¼ zihnimde bÃ¼yÃ¼k resim olarak canlandÄ±rÄ±rÄ±m.",
        "category": "synthetic_thinking", 
        "section": "ğŸ”¬ BiliÅŸsel Ä°ÅŸleme Stili",
        "dimension": "Sintetik"
    },
    {
        "question": "Ã–ÄŸrendiklerimi hemen uygulamadan Ã¶nce dÃ¼ÅŸÃ¼nmeyi tercih ederim.",
        "category": "reflective_thinking",
        "section": "ğŸ”¬ BiliÅŸsel Ä°ÅŸleme Stili", 
        "dimension": "Reflektif"
    },
    {
        "question": "Åemalar, sÄ±ralÄ± adÄ±mlar benim iÃ§in daha anlamlÄ±dÄ±r.",
        "category": "analytic_thinking",
        "section": "ğŸ”¬ BiliÅŸsel Ä°ÅŸleme Stili",
        "dimension": "Analitik"
    },
    {
        "question": "Hayal gÃ¼cÃ¼yle kavramlarÄ± iliÅŸkilendirmek bana yardÄ±mcÄ± olur.",
        "category": "synthetic_thinking",
        "section": "ğŸ”¬ BiliÅŸsel Ä°ÅŸleme Stili",
        "dimension": "Sintetik"
    },
    
    # ===== BÃ–LÃœM 2: MOTÄ°VASYON & DUYGUSAL STÄ°L =====
    {
        "question": "Hedef belirlemek beni motive eder.",
        "category": "external_motivation",
        "section": "âš¡ Motivasyon & Duygusal Stil",
        "dimension": "DÄ±ÅŸsal"
    },
    {
        "question": "Sadece merak ettiÄŸim konularÄ± Ã¶ÄŸrenmek isterim.",
        "category": "internal_motivation",
        "section": "âš¡ Motivasyon & Duygusal Stil",
        "dimension": "Ä°Ã§sel"
    },
    {
        "question": "BaÅŸarÄ± hissi beni daha Ã§ok Ã§alÄ±ÅŸtÄ±rÄ±r.",
        "category": "external_motivation",
        "section": "âš¡ Motivasyon & Duygusal Stil",
        "dimension": "DÄ±ÅŸsal"
    },
    {
        "question": "Ã–ÄŸrenirken keyif almak benim iÃ§in en Ã¶nemli ÅŸeydir.",
        "category": "internal_motivation",
        "section": "âš¡ Motivasyon & Duygusal Stil",
        "dimension": "Ä°Ã§sel"
    },
    {
        "question": "Ã‡evremden onay almak beni motive eder.",
        "category": "external_motivation",
        "section": "âš¡ Motivasyon & Duygusal Stil",
        "dimension": "DÄ±ÅŸsal"
    },
    
    # ===== BÃ–LÃœM 3: PROBLEM Ã‡Ã–ZME YAKLAÅIMI =====
    {
        "question": "Problemleri Ã§Ã¶zmek iÃ§in belirli bir plan yaparÄ±m.",
        "category": "problem_methodic",
        "section": "ğŸ” Problem Ã‡Ã¶zme YaklaÅŸÄ±mÄ±",
        "dimension": "Metodik"
    },
    {
        "question": "Deneyerek Ã¶ÄŸrenmeyi severim.",
        "category": "problem_experimental",
        "section": "ğŸ” Problem Ã‡Ã¶zme YaklaÅŸÄ±mÄ±",
        "dimension": "Deneysel"
    },
    {
        "question": "Zor bir konuda arkadaÅŸlarÄ±mla fikir alÄ±ÅŸveriÅŸi yaparÄ±m.",
        "category": "problem_social",
        "section": "ğŸ” Problem Ã‡Ã¶zme YaklaÅŸÄ±mÄ±",
        "dimension": "Sosyal"
    },
    {
        "question": "HatalarÄ±mdan Ã¶ÄŸrenmek benim iÃ§in Ã¶nemlidir.",
        "category": "problem_experimental",
        "section": "ğŸ” Problem Ã‡Ã¶zme YaklaÅŸÄ±mÄ±",
        "dimension": "Deneysel"
    },
    {
        "question": "Zorlukla karÅŸÄ±laÅŸtÄ±ÄŸÄ±mda yeni yÃ¶ntemler denerim.",
        "category": "problem_experimental",
        "section": "ğŸ” Problem Ã‡Ã¶zme YaklaÅŸÄ±mÄ±",
        "dimension": "Deneysel"
    },
    
    # ===== BÃ–LÃœM 4: HAFIZA & PEKÄ°ÅTÄ°RME TARZI =====
    {
        "question": "Bilgiyi hatÄ±rlarken gÃ¶rseller gÃ¶zÃ¼mde canlanÄ±r.",
        "category": "memory_visual",
        "section": "ğŸ’¾ HafÄ±za & PekiÅŸtirme TarzÄ±",
        "dimension": "GÃ¶rsel"
    },
    {
        "question": "DuyduÄŸum cÃ¼mleleri kolay hatÄ±rlarÄ±m.",
        "category": "memory_auditory",
        "section": "ğŸ’¾ HafÄ±za & PekiÅŸtirme TarzÄ±",
        "dimension": "Ä°ÅŸitsel"
    },
    {
        "question": "Bir ÅŸeyi yaparak Ã¶ÄŸrendiÄŸimde unutmak zor olur.",
        "category": "memory_experiential",
        "section": "ğŸ’¾ HafÄ±za & PekiÅŸtirme TarzÄ±",
        "dimension": "Deneyimsel"
    },
    {
        "question": "OkuduÄŸumu Ã¶zetlemek bana hatÄ±rlamayÄ± kolaylaÅŸtÄ±rÄ±r.",
        "category": "memory_analytic",
        "section": "ğŸ’¾ HafÄ±za & PekiÅŸtirme TarzÄ±",
        "dimension": "Analitik"
    },
    {
        "question": "GÃ¶zlerimi kapattÄ±ÄŸÄ±mda konuyu film gibi canlandÄ±rabilirim.",
        "category": "memory_visual",
        "section": "ğŸ’¾ HafÄ±za & PekiÅŸtirme TarzÄ±",
        "dimension": "GÃ¶rsel"
    }
]

# ===== YENÄ° TESTLER =====

# Motivasyon & Duygusal Denge Testi
MOTIVATION_EMOTIONAL_TEST = [
    {
        "question": "BaÅŸarÄ±lÄ± olduÄŸumda iÃ§sel bir tatmin hissederim.",
        "category": "internal_motivation",
        "section": "âš¡ Motivasyon & Duygusal Denge",
        "dimension": "Ä°Ã§sel Motivasyon"
    },
    {
        "question": "BaÅŸkalarÄ±nÄ±n takdir etmesi beni motive eder.",
        "category": "external_motivation",
        "section": "âš¡ Motivasyon & Duygusal Denge",
        "dimension": "DÄ±ÅŸsal Motivasyon"
    },
    {
        "question": "Zor bir konuyu gÃ¶rÃ¼nce genellikle endiÅŸelenirim.",
        "category": "test_anxiety",
        "section": "âš¡ Motivasyon & Duygusal Denge",
        "dimension": "SÄ±nav KaygÄ±sÄ±"
    },
    {
        "question": "HatalarÄ±mdan sonra moralimi hemen toparlayabilirim.",
        "category": "emotional_resilience",
        "section": "âš¡ Motivasyon & Duygusal Denge",
        "dimension": "Duygusal DayanÄ±klÄ±lÄ±k"
    },
    {
        "question": "Ã–ÄŸrenme sÃ¼recinde keyif almak benim iÃ§in Ã¶nemlidir.",
        "category": "internal_motivation",
        "section": "âš¡ Motivasyon & Duygusal Denge",
        "dimension": "Ä°Ã§sel Motivasyon"
    },
    {
        "question": "BaÅŸkalarÄ±yla kendimi kÄ±yaslamak beni motive eder.",
        "category": "external_motivation",
        "section": "âš¡ Motivasyon & Duygusal Denge",
        "dimension": "DÄ±ÅŸsal Motivasyon"
    },
    {
        "question": "SÄ±navdan Ã¶nce genellikle stres hissederim.",
        "category": "test_anxiety",
        "section": "âš¡ Motivasyon & Duygusal Denge",
        "dimension": "SÄ±nav KaygÄ±sÄ±"
    },
    {
        "question": "BaÅŸarÄ±sÄ±z olsam bile tekrar denemekten vazgeÃ§mem.",
        "category": "emotional_resilience",
        "section": "âš¡ Motivasyon & Duygusal Denge",
        "dimension": "Duygusal DayanÄ±klÄ±lÄ±k"
    },
    {
        "question": "Ã–ÄŸrendiklerimi sadece not almak iÃ§in deÄŸil, gerÃ§ekten anlamak isterim.",
        "category": "internal_motivation",
        "section": "âš¡ Motivasyon & Duygusal Denge",
        "dimension": "Ä°Ã§sel Motivasyon"
    },
    {
        "question": "EleÅŸtirildiÄŸimde hemen motivasyonumu kaybederim.",
        "category": "test_anxiety",
        "section": "âš¡ Motivasyon & Duygusal Denge",
        "dimension": "Duygusal KÄ±rÄ±lganlÄ±k"
    }
]

# Zaman YÃ¶netimi & Ã‡alÄ±ÅŸma AlÄ±ÅŸkanlÄ±ÄŸÄ± Testi
TIME_MANAGEMENT_TEST = [
    {
        "question": "GÃ¼nlÃ¼k veya haftalÄ±k bir Ã§alÄ±ÅŸma planÄ±m vardÄ±r.",
        "category": "planning",
        "section": "â° Zaman YÃ¶netimi & Ã‡alÄ±ÅŸma AlÄ±ÅŸkanlÄ±ÄŸÄ±",
        "dimension": "Planlama"
    },
    {
        "question": "Ã‡oÄŸu zaman 'yarÄ±n baÅŸlarÄ±m' diyerek ertelediÄŸim olur.",
        "category": "procrastination",
        "section": "â° Zaman YÃ¶netimi & Ã‡alÄ±ÅŸma AlÄ±ÅŸkanlÄ±ÄŸÄ±",
        "dimension": "Erteleme EÄŸilimi"
    },
    {
        "question": "Ã‡alÄ±ÅŸmaya baÅŸladÄ±ÄŸÄ±mda kolayca dikkatimi daÄŸÄ±tÄ±rÄ±m.",
        "category": "focus_control",
        "section": "â° Zaman YÃ¶netimi & Ã‡alÄ±ÅŸma AlÄ±ÅŸkanlÄ±ÄŸÄ±",
        "dimension": "Odak SÃ¼resi"
    },
    {
        "question": "KonularÄ± kÃ¼Ã§Ã¼k parÃ§alara bÃ¶lerek Ã§alÄ±ÅŸÄ±rÄ±m.",
        "category": "planning",
        "section": "â° Zaman YÃ¶netimi & Ã‡alÄ±ÅŸma AlÄ±ÅŸkanlÄ±ÄŸÄ±",
        "dimension": "Verimlilik"
    },
    {
        "question": "PlanÄ±ma sadÄ±k kalmakta zorlanÄ±rÄ±m.",
        "category": "discipline",
        "section": "â° Zaman YÃ¶netimi & Ã‡alÄ±ÅŸma AlÄ±ÅŸkanlÄ±ÄŸÄ±",
        "dimension": "Disiplin"
    },
    {
        "question": "Ã‡alÄ±ÅŸÄ±rken kÄ±sa ama dÃ¼zenli molalar veririm.",
        "category": "focus_control",
        "section": "â° Zaman YÃ¶netimi & Ã‡alÄ±ÅŸma AlÄ±ÅŸkanlÄ±ÄŸÄ±",
        "dimension": "Odak-Mola Dengesi"
    },
    {
        "question": "SÄ±nav haftasÄ±na kadar bekleyip yoÄŸun Ã§alÄ±ÅŸÄ±rÄ±m.",
        "category": "procrastination",
        "section": "â° Zaman YÃ¶netimi & Ã‡alÄ±ÅŸma AlÄ±ÅŸkanlÄ±ÄŸÄ±",
        "dimension": "Son DakikacÄ±lÄ±k"
    },
    {
        "question": "GÃ¼nÃ¼mÃ¼n hangi saatlerinde verimli olduÄŸumu bilirim.",
        "category": "self_awareness",
        "section": "â° Zaman YÃ¶netimi & Ã‡alÄ±ÅŸma AlÄ±ÅŸkanlÄ±ÄŸÄ±",
        "dimension": "Ã–z FarkÄ±ndalÄ±k"
    },
    {
        "question": "Tekrar planÄ±mÄ± Ã¶nceden belirlerim (Ã¶rneÄŸin 24 saat â€“ 1 hafta sonra).",
        "category": "planning",
        "section": "â° Zaman YÃ¶netimi & Ã‡alÄ±ÅŸma AlÄ±ÅŸkanlÄ±ÄŸÄ±",
        "dimension": "Sistematik Tekrar"
    },
    {
        "question": "Ã‡alÄ±ÅŸÄ±rken telefon veya sosyal medya beni sÄ±k sÄ±k bÃ¶ler.",
        "category": "focus_control",
        "section": "â° Zaman YÃ¶netimi & Ã‡alÄ±ÅŸma AlÄ±ÅŸkanlÄ±ÄŸÄ±",
        "dimension": "Dikkat KontrolÃ¼"
    }
]

# Eski karÄ±ÅŸÄ±k liste tamamen kaldÄ±rÄ±ldÄ±

# Gereksiz duplicate veriler kaldÄ±rÄ±ldÄ±. Test ÅŸimdi tam 80 soru (60 VAK + 20 BiliÅŸsel)

# Test tamamlandÄ± - 80 soru (60 VAK + 20 BiliÅŸsel)

# Test verisi dÃ¼zgÃ¼n: 80 soru (60 VAK + 20 BiliÅŸsel)

# Bu fonksiyon artÄ±k kullanÄ±lmÄ±yor - yeni test sistemi kullanÄ±lÄ±yor

def get_recommended_techniques(dimension_scores, user_profile):
    """Ã–ÄŸrenme profiline gÃ¶re en uygun Ã§alÄ±ÅŸma tekniklerini Ã¶nerir"""
    recommended_techniques = []
    
    for technique_name, info in STUDY_TECHNIQUES.items():
        if user_profile in info.get('suitable_profiles', []):
            recommended_techniques.append(technique_name)
    
    # EÄŸer hiÃ§ eÅŸleÅŸme yoksa, genel teknikleri dÃ¶ndÃ¼r
    if not recommended_techniques:
        recommended_techniques = list(STUDY_TECHNIQUES.keys())[:3]
    
    return recommended_techniques[:3]

def display_progress_summary(user_data, progress_data):
    """Ana sayfada ilerleme Ã¶zeti gÃ¶sterir"""
    
    overall_progress = calculate_subject_progress(user_data)
    total_completed = sum(data['completed'] for data in overall_progress.values())
    total_topics = count_total_topics()
    overall_percent = (total_completed / total_topics * 100) if total_topics > 0 else 0
    
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        st.metric("âœ… Tamamlanan Konular", f"{total_completed}/{total_topics}")
    
    with col2:
        st.metric("ğŸ“š Toplam Ders", len(progress_data))
    
    with col3:
        avg_per_subject = sum(data['percent'] for data in progress_data.values()) / len(progress_data) if progress_data else 0
        st.metric("ğŸ“ˆ Ders OrtalamasÄ±", f"%{avg_per_subject:.1f}")
    with col4:
        st.metric("ğŸ¯ Hedef BÃ¶lÃ¼m", user_data.get('target_department', 'Belirlenmedi'), delta_color="off")      
    
    st.markdown("---")
    
    st.subheader("ğŸ“ˆ Ders BazÄ±nda Ä°lerleme")
    
    if progress_data:
        for subject, data in progress_data.items():
            col_a, col_b = st.columns([3, 1])
            with col_a:
                st.write(f"**{subject}**")
                st.progress(data['percent'] / 100)
            with col_b:
                st.write(f"{data['completed']}/{data['total']} konu")
                st.write(f"%{data['percent']:.1f}")
        
        st.markdown("---")
    
    else:
        st.info("HenÃ¼z ilerleme verisi bulunmuyor. Konu Takip sekmesinden ilerlemenizi kaydedin.")

# YKS Takip fonksiyonlarÄ±
def clear_outdated_session_data():
    """Eski tarihli session verilerini temizler - Sistem her gÃ¼n gÃ¼ncel kalÄ±r"""
    current_date = datetime.now().date().isoformat()
    
    # EÄŸer session'da farklÄ± bir tarih varsa planlarÄ± temizle
    if 'last_plan_date' not in st.session_state or st.session_state.last_plan_date != current_date:
        # Sadece cache'leri temizle, interactive widget'larÄ± etkileyenleri koruma altÄ±nda bÄ±rak
        if 'weekly_plan_cache' in st.session_state:
            del st.session_state.weekly_plan_cache
        
        # Planlama ile ilgili geÃ§ici verileri temizle  
        keys_to_remove = []
        for key in st.session_state.keys():
            if key.startswith('temp_') or key.startswith('cache_'):
                keys_to_remove.append(key)
        
        # DOM hata Ã¶nleyici - widget key'lerini temizle
        try:
            for key in st.session_state.keys():
                if len(str(key)) > 200 or 'old_' in str(key):
                    keys_to_remove.append(key)
        except:
            pass
        
        for key in keys_to_remove:
            try:
                del st.session_state[key]
            except:
                pass
            
        # Yeni tarihi kaydet
        st.session_state.last_plan_date = current_date
        
        # GÃ¼ncel olmayan day_plans'leri de reset et - ama safe ÅŸekilde
        if 'day_plans' in st.session_state:
            # Mevcut planlarÄ± backup al ve yeniden oluÅŸtur
            st.session_state.day_plans = {day: [] for day in ["PAZARTESÄ°", "SALI", "Ã‡ARÅAMBA", "PERÅEMBE", "CUMA", "CUMARTESÄ°", "PAZAR"]}

def yks_takip_page(user_data):
    # ğŸ†• FÄ°X: Fresh user data Ã§ek - Her sayfa yÃ¼klenmesinde gÃ¼ncel veri
    current_user = st.session_state.get('current_user')
    if current_user:
        # Firebase'den gÃ¼ncel veriyi Ã§ek
        if 'users_db' in st.session_state:
            fresh_users_db = load_users_from_firebase()
            if fresh_users_db and current_user in fresh_users_db:
                user_data = fresh_users_db[current_user]
                st.session_state.users_db = fresh_users_db  # Session state'i de gÃ¼ncelle
    
    # Eski session verilerini temizle - her gÃ¼n gÃ¼ncel sistem!
    clear_outdated_session_data()
    
    # GÃ¼ncel tarih bilgisi al
    week_info = get_current_week_info()
    days_to_yks = week_info['days_to_yks']
    
    st.markdown(f'<div class="main-header"><h1>ğŸ¯ YKS Takip & Planlama Sistemi</h1><p>Hedef bÃ¶lÃ¼mÃ¼nÃ¼ze odaklÄ± strateji ve haftalÄ±k hedeflerinizi belirleyin</p><p>ğŸ“… {week_info["today"].strftime("%d %B %Y")} | â° YKS\'ye {days_to_yks} gÃ¼n kaldÄ±!</p></div>', unsafe_allow_html=True)
    
    # Ana panelden bilgileri al
    student_grade = user_data.get('grade', '')
    student_field = user_data.get('field', '')
    learning_style = user_data.get('learning_style', '')
    
    # YKS Takip sistemi sekmeleri
    tab1, tab2, tab3 = st.tabs(["ğŸ¯ Hedef BÃ¶lÃ¼m HaritasÄ±", "ğŸ“‹ HaftalÄ±k Planlama", "ğŸ“Š GidiÅŸat Analizi"])
    
    with tab1:
        show_target_department_roadmap(user_data)
    
    with tab2:
        st.subheader("ğŸ“‹ Ã–ÄŸrenci Bilgileri")
        col1, col2, col3 = st.columns(3)
        with col1:
            st.metric("ğŸ“ SÄ±nÄ±f", student_grade)
        with col2:
            st.metric("ğŸ“š Alan", student_field)
        with col3:
            st.metric("ğŸ§  Ã–ÄŸrenme Stili", learning_style)
        
        st.markdown("---")
        
        # Ä°lk kez giriÅŸ iÃ§in anket sistemi
        if not has_completed_yks_survey(user_data):
            show_yks_survey(user_data)
        else:
            show_weekly_planner(user_data)
    
    with tab3:
        show_progress_analytics(user_data)
    


def has_completed_yks_survey(user_data):
    """KullanÄ±cÄ±nÄ±n YKS anketini tamamlayÄ±p tamamlamadÄ±ÄŸÄ±nÄ± kontrol eder"""
    survey_data = user_data.get('yks_survey_data', '')
    if survey_data:
        try:
            data = json.loads(survey_data)
            return all(key in data for key in ['program_type', 'daily_subjects', 'study_style', 
                                              'difficult_subjects', 'favorite_subjects', 'sleep_time', 'disliked_subjects', 
                                              'rest_day'])
        except:
            return False
    return False

def show_yks_survey(user_data):
    """YKS anketi gÃ¶sterir"""
    st.subheader("ğŸ“ Ä°lk Kurulum: Size Ã–zel Program Ä°Ã§in Bilgilerinizi AlalÄ±m")
    
    student_field = user_data.get('field', '')
    
    with st.form("yks_survey_form"):
        # Program tÃ¼rÃ¼
        st.markdown("### ğŸ›ï¸ HaftalÄ±k ProgramÄ±nÄ±zÄ± NasÄ±l OluÅŸturalÄ±m?")
        program_type = st.radio(
            "Program tÃ¼rÃ¼nÃ¼ seÃ§in:",
            ["ğŸ›ï¸ KiÅŸiselleÅŸtirilmiÅŸ Program (Kendi gÃ¼n/saatlerimi belirleyeyim)",
             "ğŸ“‹ HazÄ±r Bilimsel Program (Bana otomatik program hazÄ±rlansÄ±n)"]
        )
        
        # GÃ¼nlÃ¼k ders sayÄ±sÄ±
        st.markdown("### ğŸ“š GÃ¼nlÃ¼k Ders DaÄŸÄ±lÄ±mÄ±")
        st.write("GÃ¼nde kaÃ§ farklÄ± ders Ã§alÄ±ÅŸmayÄ± istersiniz?")
        daily_subjects = st.selectbox("Ders sayÄ±sÄ±:", [2, 3, 4, 5], index=1)
        if daily_subjects in [2, 3, 4]:
            st.success("âœ… Bilimsel Ã–neri: 2-4 ders seÃ§iminiz optimal aralÄ±kta! (Ä°deal olan ise 3'tÃ¼r)")
        
        # Ã‡alÄ±ÅŸma stili
        st.markdown("### ğŸ½ï¸ Ã‡alÄ±ÅŸma Stilinizi KeÅŸfedin")
        study_style = st.radio(
            "Hangi Ã§alÄ±ÅŸma stilini tercih edersiniz?",
            ["ğŸ° En gÃ¼zel kÄ±smÄ± sona saklarÄ±m (Zor dersleri sona saklama)",
             "ğŸ½ï¸ Her ÅŸeyi karÄ±ÅŸÄ±k paylaÅŸÄ±rÄ±m (Dengeli daÄŸÄ±lÄ±m)", 
             "ğŸ”¥ En gÃ¼zelinden baÅŸlarÄ±m (Zor dersler Ã¶n alma)"]
        )
        
        # Dersler alan bazÄ±nda belirlenir
        all_subjects = get_subjects_by_field_yks(student_field)
        
        # Zorluk analizi
        st.markdown("### ğŸ¯ Zorluk Analizi")
        difficult_subjects = st.multiselect(
            "En zorlandÄ±ÄŸÄ±nÄ±z 3 dersi seÃ§in (en zordan baÅŸlayarak):",
            all_subjects, max_selections=3
        )
        
        # Uyku saati
        st.markdown("### ğŸ˜´ Uyku DÃ¼zeni")
        st.info("ğŸ§  Bilimsel olarak ideal uyku sÃ¼resi 7 saattir. Tavsiye edilen uyku saatleri: 23:00 - 06:00 arasÄ±")
        sleep_option = st.selectbox(
            "Uyku saatinizi seÃ§in:",
            ["23:00 - 06:00 (7 saat) - Ã–nerilen", "22:00 - 05:00 (7 saat)",
             "00:00 - 07:00 (7 saat)", "01:00 - 08:00 (7 saat)", "DiÄŸer"]
        )
        
        # Sevilen ve sevmeyen dersler
        st.markdown("### ğŸ’ Ders Tercihleri")
        favorite_subjects = st.multiselect(
            "En sevdiÄŸiniz dersleri seÃ§in (max 4):", all_subjects, max_selections=4
        )
        disliked_subjects = st.multiselect(
            "En az sevdiÄŸiniz dersleri seÃ§in (max 3):", all_subjects, max_selections=3
        )
        
        # Tatil gÃ¼nÃ¼ - Tam ve YarÄ±m GÃ¼n SeÃ§enekleri
        st.markdown("### ğŸŒ´ Dinlenme GÃ¼nÃ¼")
        st.info("ğŸ’¡ **Tam GÃ¼n**: O gÃ¼n hiÃ§ Ã§alÄ±ÅŸma yapmayacaksÄ±nÄ±z | **YarÄ±m GÃ¼n**: O gÃ¼n sadece yarÄ±m gÃ¼n Ã§alÄ±ÅŸacaksÄ±nÄ±z")
        rest_day = st.selectbox(
            "HaftanÄ±n hangi gÃ¼nÃ¼ dinlenmek istersiniz?",
            ["Pazar (Tam GÃ¼n)", "Pazar (YarÄ±m GÃ¼n)",
             "Cumartesi (Tam GÃ¼n)", "Cumartesi (YarÄ±m GÃ¼n)",
             "Cuma (Tam GÃ¼n)", "Cuma (YarÄ±m GÃ¼n)",
             "Pazartesi (Tam GÃ¼n)", "Pazartesi (YarÄ±m GÃ¼n)",
             "SalÄ± (Tam GÃ¼n)", "SalÄ± (YarÄ±m GÃ¼n)",
             "Ã‡arÅŸamba (Tam GÃ¼n)", "Ã‡arÅŸamba (YarÄ±m GÃ¼n)",
             "PerÅŸembe (Tam GÃ¼n)", "PerÅŸembe (YarÄ±m GÃ¼n)"]
        )
        
        # Form submit
        if st.form_submit_button("ğŸ’¾ Bilgilerimi Kaydet ve Planlama Sistemine GeÃ§", type="primary"):
            survey_data = {
                'program_type': program_type,
                'daily_subjects': daily_subjects,
                'study_style': study_style,
                'difficult_subjects': difficult_subjects,
                'favorite_subjects': favorite_subjects,
                'sleep_time': sleep_option,
                'disliked_subjects': disliked_subjects,
                'rest_day': rest_day,
                'created_at': datetime.now().isoformat()
            }
            
            # KullanÄ±cÄ± verisini gÃ¼ncelle
            update_user_in_firebase(st.session_state.current_user, 
                              {'yks_survey_data': json.dumps(survey_data)})
            # ğŸš€ OPTÄ°MÄ°ZE: update_user_in_firebase() zaten session state'i gÃ¼nceller
            
            # Anket verileri kaydedildi - gereksiz kitap Ã¶nerisi gÃ¶sterilmiyor
            
            st.rerun()

def show_weekly_planner(user_data):
    """YENÄ° SÄ°STEMATÄ°K HAFTALÄ°K PLANLAMA SÄ°STEMÄ°"""
    # Eski session verilerini temizle - her gÃ¼n gÃ¼ncel sistem!
    clear_outdated_session_data()
    
    # Anket verilerini yÃ¼kle
    survey_data = json.loads(user_data.get('yks_survey_data', '{}'))
    student_field = user_data.get('field', '')
    
    # ğŸ” YENÄ°: DÄ°NAMÄ°K HAFTALIK PLAN AL - KayÄ±t tarihinden itibaren esnek dÃ¶ngÃ¼
    weekly_plan = create_dynamic_weekly_plan(user_data, student_field, survey_data)
    
    # ğŸ“‹ YENÄ°: DÄ°NAMÄ°K HAFTA DASHBOARD'U GÃ–STER
    show_dynamic_week_dashboard(weekly_plan, user_data)
    st.markdown("---")
    
    # Ãœst dashboard
    show_progress_dashboard(weekly_plan, user_data)
    
    # YENÄ°: KalÄ±cÄ± Ã–ÄŸrenme Sistemi Dashboard'u
    st.markdown("---")
    
    # KullanÄ±cÄ±yÄ± kalIcÄ± Ã¶ÄŸrenme sistemi iÃ§in baÅŸlat
    user_data = initialize_mastery_system(user_data)
    
    # KalÄ±cÄ± Ã¶ÄŸrenme sistemi dashboard'Ä±nÄ± gÃ¶ster
    show_mastery_progress_dashboard(user_data)
    
    st.markdown("---")
    
    # ğŸ¯ ZAMANSAL STRATEJÄ° BÄ°LGÄ°LERÄ°NÄ° GÃ–STER
    if 'time_strategy' in weekly_plan:
        show_time_strategy_dashboard(weekly_plan)
        st.markdown("---")
    
    # ğŸ¯ YENÄ°: SINIF VE HEDEF BÃ–LÃœM BÄ°LGÄ°LERÄ°NÄ° GÃ–STER
    if 'grade_strategy' in weekly_plan:
        show_grade_and_target_dashboard(weekly_plan, user_data)
        st.markdown("---")
    
    # ğŸ¯ YENÄ°: EÅÄ°T AÄIRLIK Ã–ZEL PLANI DASHBOARD'U
    if weekly_plan.get('equal_weight_special', False):
        show_equal_weight_special_dashboard(weekly_plan, user_data)
        st.markdown("---")
    
    # ğŸ¯ YENÄ°: SAYISAL Ã–ZEL PLANI DASHBOARD'U
    if weekly_plan.get('numerical_special', False):
        show_numerical_special_dashboard(weekly_plan, user_data)
        st.markdown("---")
    
    # ğŸ¯ YENÄ°: TYT & MSÃœ Ã–ZEL PLANI DASHBOARD'U
    if weekly_plan.get('tyt_msu_special', False):
        show_tyt_msu_special_dashboard(weekly_plan, user_data)
        st.markdown("---")
    
    # ğŸ¯ YENÄ°: SÃ–ZEL Ã–ZEL PLANI DASHBOARD'U
    if weekly_plan.get('verbal_special', False):
        show_verbal_special_dashboard(weekly_plan, user_data)
        st.markdown("---")
    
    # Ana haftalÄ±k plan
    week_info = get_current_week_info()
    days_to_yks = week_info['days_to_yks']
    
    st.markdown(f"### ğŸ“… Bu HaftanÄ±n Sistematik PlanÄ±")
    st.info(f"ğŸ“… **{week_info['week_range']}** | â° **YKS'ye {days_to_yks} gÃ¼n kaldÄ±!**")
    
    # Sadece tekrar konularÄ± gÃ¶ster - YENÄ° KONULAR kÄ±smÄ± kaldÄ±rÄ±ldÄ±
    st.markdown("#### ğŸ”„ TEKRAR EDÄ°LECEK KONULAR")
    show_review_topics_section(weekly_plan.get('review_topics', []), user_data)
    
    # YENÄ°: HaftalÄ±k tamamlanma kontrolÃ¼ ve bonus konular
    st.markdown("---")
    
    # Bu haftanÄ±n tamamlanma yÃ¼zdesini hesapla (Basit haftalÄ±k plan oluÅŸtur)
    # EÄŸer weekly_plan yoksa basit bir plan oluÅŸtur
    if 'weekly_plan' not in locals():
        weekly_plan = {
            'review_topics': [],
            'week_target': 10,
            'success_target': 0.7
        }
    
    completion_percentage = calculate_weekly_completion_percentage(user_data, weekly_plan)
    
    # Progress bar gÃ¶ster - SÃœREKLI GÃœNCEL SÄ°STEM
    st.markdown("#### ğŸ“Š BU HAFTANÄ°N Ä°LERLEMESÄ° (SÃ¼rekli GÃ¼ncel)")
    progress_col1, progress_col2 = st.columns([3, 2])
    
    # GerÃ§ek zamanlÄ± hesaplama - gÃ¼ncel tarih bazlÄ±
    from datetime import datetime
    current_date = datetime.now()
    week_start = current_date - timedelta(days=current_date.weekday())
    week_progress = (current_date - week_start).days / 7 * 100  # HaftanÄ±n yÃ¼zde kaÃ§Ä± geÃ§ti
    
    # Hedef tamamlanma yÃ¼zdesi
    expected_completion = week_progress  # Hafta %50 geÃ§tiyse %50 tamamlanmÄ±ÅŸ olmalÄ±
    actual_completion = completion_percentage
    
    with progress_col1:
        progress_bar = st.progress(completion_percentage / 100)
        
        # Dinamik mesaj - gerÃ§ek zamanlÄ±
        if actual_completion >= expected_completion + 20:
            status_msg = f"ğŸš€ SÃ¼per! HaftanÄ±n %{week_progress:.0f}'i geÃ§ti, sen %{completion_percentage:.1f} tamamladÄ±n! Hedefin Ã¶nÃ¼ndesin!"
            color = "success"
        elif actual_completion >= expected_completion:
            status_msg = f"âš¡ Ä°yi! HaftanÄ±n %{week_progress:.0f}'i geÃ§ti, sen %{completion_percentage:.1f} tamamladÄ±n! Hedeftesin!"
            color = "info"
        else:
            gap = expected_completion - actual_completion
            status_msg = f"âš ï¸ Dikkat! HaftanÄ±n %{week_progress:.0f}'i geÃ§ti ama sen sadece %{completion_percentage:.1f} tamamladÄ±n! {gap:.0f} puan geridesin!"
            color = "error"
        
        if color == "success":
            st.success(status_msg)
        elif color == "info":
            st.info(status_msg)
        else:
            st.error(status_msg)
    
    with progress_col2:
        # GÃ¼ncel zaman bilgisi
        st.write(f"ğŸ“… **BugÃ¼n:** {current_date.strftime('%d %B %Y %A')}")
        st.write(f"â° **Saat:** {current_date.strftime('%H:%M')}")
        st.write(f"ğŸ“Š **Hafta geÃ§iÅŸi:** %{week_progress:.0f}")
        
        if completion_percentage >= 80:
            st.markdown("ğŸ‰ **Hedef AÅŸÄ±ldÄ±!**")
        elif completion_percentage >= 60:
            st.markdown("âš¡ **Ä°yi Gidiyorsun!**")
        else:
            st.markdown("ğŸ’ª **HÄ±zlanmalÄ±sÄ±n!**")
    
    # Otomatik gÃ¼ncelleme sistemi gÃ¶stergesi
    st.caption("ğŸ”„ Bu sistem anlÄ±k olarak gÃ¼ncellenir - sayfa yenilendiÄŸinde en gÃ¼ncel durumu gÃ¶sterir")
    
    # Ä°lerleme yÃ¼zdesi hesaplanÄ±yor
    final_completion = completion_percentage
    
    # EÄŸer %80+ tamamlandÄ±ysa bonus konularÄ± gÃ¶ster
    if final_completion >= 80.0:
        st.markdown("---")
        
        # Gelecek haftanÄ±n konularÄ±nÄ± getir
        next_week_topics = get_next_week_topics(user_data, user_data.get('field', ''), survey_data)
        
        # Bonus konularÄ± gÃ¶ster
        if next_week_topics:
            show_next_week_bonus_topics(next_week_topics, user_data)
        else:
            st.info("ğŸ¯ Gelecek hafta iÃ§in ek bonus konu bulunamadÄ±. Mevcut konularÄ±nÄ± tekrar etmeye odaklan!")
    
    st.markdown("---")
    
    # Interaktif planlayÄ±cÄ±
    show_interactive_systematic_planner(weekly_plan, survey_data, user_data)
    
    st.markdown("---")
    
    # YazdÄ±rma butonu ekle - haftalÄ±k planlama tamamlandÄ±ktan sonra
    show_print_button(user_data, weekly_plan)

def show_progress_dashboard(weekly_plan, user_data):
    """Ä°lerleme dashboard'u - DÄ°NAMÄ°K TARÄ°H SÄ°STEMÄ°"""
    projections = weekly_plan.get('projections', {})
    week_info = get_current_week_info()
    
    st.markdown(f"### ğŸ“Š GENEL Ä°LERLEME DURUMU")
    st.caption(f"ğŸ“… GÃ¼ncel Tarih: {week_info['today'].strftime('%d %B %Y')} | Hafta: {week_info['week_number']}/52")
    
    # Ana metrikler
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        overall_progress = projections.get('overall_progress', 0)
        st.metric(
            "ğŸ¯ Genel Ä°lerleme",
            f"%{overall_progress:.1f}",
            f"Hedef: %100"
        )
    
    with col2:
        tyt_progress = projections.get('tyt_progress', 0)
        st.metric(
            "ğŸ“š TYT Ä°lerleme", 
            f"%{tyt_progress:.1f}",
            f"Tahmini: Mart 2025" if tyt_progress < 80 else "YakÄ±nda!"
        )
    
    with col3:
        ayt_progress = projections.get('ayt_progress', 0)
        st.metric(
            "ğŸ“– AYT Ä°lerleme",
            f"%{ayt_progress:.1f}", 
            f"Tahmini: MayÄ±s 2025" if ayt_progress < 70 else "YakÄ±nda!"
        )
    
    with col4:
        weekly_target = weekly_plan.get('week_target', 0)
        success_rate = weekly_plan.get('success_target', 0.8)
        st.metric(
            "ğŸ“… Bu Hafta",
            f"{weekly_target} konu",
            f"Hedef: %{success_rate*100:.0f} baÅŸarÄ±"
        )
    
    # Ä°lerleme Ã§ubuklarÄ±
    st.markdown("#### ğŸ“ˆ DetaylÄ± Ä°lerleme")
    
    progress_col1, progress_col2 = st.columns(2)
    
    with progress_col1:
        st.write("**TYT Ä°lerleme**")
        st.progress(tyt_progress / 100)
        
    with progress_col2:
        st.write("**AYT Ä°lerleme**") 
        st.progress(ayt_progress / 100)
    
    # Tahmini tamamlanma
    estimated_completion = projections.get('estimated_completion')
    if estimated_completion:
        st.info(f"ğŸ“… **Tahmini Genel Tamamlanma:** {estimated_completion}")
    
    # YENÄ°: GÃ¼nlÃ¼k/HaftalÄ±k/AylÄ±k Ä°lerleme Analizi
    st.markdown("---")
    show_time_based_progress_analysis(user_data, week_info)
    
    # YENÄ°: Deneme BazlÄ± Trend Analizi  
    st.markdown("---")
    show_exam_based_trend_analysis(user_data)
    
    # YENÄ°: YKS Hedef HÄ±z Analizi
    st.markdown("---")
    show_yks_target_speed_analysis(user_data, projections, week_info)

def show_new_topics_section(new_topics, user_data):
    """Yeni konular bÃ¶lÃ¼mÃ¼"""
    if not new_topics:
        st.warning("ğŸ“Š Yeni konu bulunamadÄ±. Konu Takip sekmesinden deÄŸerlendirmelerinizi yapÄ±n.")
        return
    
    # Ã–ncelik gruplarÄ±na ayÄ±r (YENÄ° 5'LÄ° SÄ°STEM)
    high_priority = [t for t in new_topics if t.get('priority') == 'HIGH']
    medium_priority = [t for t in new_topics if t.get('priority') == 'MEDIUM'] 
    normal_priority = [t for t in new_topics if t.get('priority') == 'NORMAL']
    low_priority = [t for t in new_topics if t.get('priority') == 'LOW']
    minimal_priority = [t for t in new_topics if t.get('priority') == 'MINIMAL']
    
    # Acil - ZayÄ±f konular
    if high_priority:
        st.markdown("##### ğŸ”¥ Acil - ZayÄ±f Konular")
        for topic in high_priority:
            show_topic_card(topic, "HIGH")
    
    # Ã–ncelikli - Temel konular
    if medium_priority:
        st.markdown("##### âš¡ Ã–ncelikli - Temel Konular")
        for topic in medium_priority:
            show_topic_card(topic, "MEDIUM")
    
    # Normal - Orta konular
    if normal_priority:
        st.markdown("##### ğŸ¯ Normal - Orta Konular")
        for topic in normal_priority:
            show_topic_card(topic, "NORMAL")
    
    # DÃ¼ÅŸÃ¼k - Ä°yi konular
    if low_priority:
        st.markdown("##### ğŸŸ¢ DÃ¼ÅŸÃ¼k - Ä°yi Konular")
        for topic in low_priority:
            show_topic_card(topic, "LOW")
    
    # Minimal - Uzman konular
    if minimal_priority:
        st.markdown("##### â­ Minimal - Uzman Konular")
        for topic in minimal_priority:
            show_topic_card(topic, "MINIMAL")

def show_review_topics_section(review_topics, user_data):
    """Tekrar konularÄ± bÃ¶lÃ¼mÃ¼ - ESKÄ° VE YENÄ° SÄ°STEM ENTEGRASYONLÄ°"""
    # YENÄ°: KalÄ±cÄ± Ã¶ÄŸrenme sistemi tekrarlarÄ±
    pending_mastery_topics = get_pending_review_topics(user_data)
    
    # EÄŸer her iki sistem de boÅŸsa
    if not review_topics and not pending_mastery_topics:
        st.info("ğŸ‰ Bu hafta tekrar edilecek konu yok!")
        return
    
    # YENÄ° SÄ°STEM: KalÄ±cÄ± Ã–ÄŸrenme TekrarlarÄ± (Ã–ncelik)
    if pending_mastery_topics:
        st.markdown("#### ğŸ¯ KALÄ°CÄ° Ã–ÄRENME TEKRARLARÄ°")
        st.caption("Bu konularÄ± yeniden deÄŸerlendirerek kalÄ±cÄ±lÄ±ÄŸÄ±nÄ± onaylayÄ±n!")
        show_pending_reviews_section(pending_mastery_topics)
        
        if review_topics:  # EÄŸer eski sistem tekrarlarÄ± da varsa ayÄ±rÄ±cÄ± ekle
            st.markdown("---")
    
    # ESKÄ° SÄ°STEM: Spaced Repetition TekrarlarÄ±
    if review_topics:
        st.markdown("#### ğŸ”„ GENEL TEKRARLAR")
        st.caption("Eski sistemden gelen aralÄ±klÄ± tekrar konularÄ±")
        
        # Ã–ncelik gruplarÄ±na ayÄ±r
        high_reviews = [t for t in review_topics if t.get('priority') == 'REPEAT_HIGH']
        medium_reviews = [t for t in review_topics if t.get('priority') == 'REPEAT_MEDIUM']
        normal_reviews = [t for t in review_topics if t.get('priority') == 'REPEAT_NORMAL']
        
        # YÃ¼ksek Ã¶ncelikli tekrarlar
        if high_reviews:
            st.markdown("##### ğŸ”„ YÃ¼ksek Ã–ncelikli Tekrar")
            for topic in high_reviews:
                show_review_card(topic, "REPEAT_HIGH")
        
        # Ã–ncelikli tekrarlar
        if medium_reviews:
            st.markdown("##### ğŸ”„ Ã–ncelikli Tekrar")
            for topic in medium_reviews:
                show_review_card(topic, "REPEAT_MEDIUM")
        
        # Normal tekrarlar
        if normal_reviews:
            st.markdown("##### ğŸ”„ Normal Tekrar")
            for topic in normal_reviews:
                show_review_card(topic, "REPEAT_NORMAL")

def show_topic_card(topic, priority_type):
    """Konu kartÄ± gÃ¶sterici"""
    priority_info = PRIORITY_CATEGORIES[priority_type]
    
    with st.container():
        st.markdown(f"""
        <div style='background: linear-gradient(135deg, {priority_info['color']}22 0%, {priority_info['color']}11 100%); 
                    border-left: 4px solid {priority_info['color']}; 
                    padding: 12px; border-radius: 8px; margin-bottom: 8px;'>
            <div style='display: flex; align-items: center; margin-bottom: 8px;'>
                <span style='font-size: 18px; margin-right: 8px;'>{priority_info['icon']}</span>
                <strong style='color: {priority_info['color']};'>{topic['subject']}</strong>
            </div>
            <div style='margin-left: 26px;'>
                <div><strong>ğŸ“– {topic['topic']}</strong></div>
                <div style='font-size: 14px; color: #666; margin-top: 4px;'>
                    â”” {topic.get('detail', '')} 
                    <span style='background: #f0f0f0; padding: 2px 6px; border-radius: 10px; margin-left: 8px;'>
                        Mevcut: {topic.get('net', 0)} net
                    </span>
                </div>
            </div>
        </div>
        """, unsafe_allow_html=True)

def show_review_card(topic, priority_type):
    """Tekrar konu kartÄ±"""
    priority_info = PRIORITY_CATEGORIES[priority_type]
    
    with st.container():
        st.markdown(f"""
        <div style='background: linear-gradient(135deg, {priority_info['color']}22 0%, {priority_info['color']}11 100%); 
                    border-left: 4px solid {priority_info['color']}; 
                    padding: 12px; border-radius: 8px; margin-bottom: 8px;'>
            <div style='display: flex; align-items: center; margin-bottom: 8px;'>
                <span style='font-size: 16px; margin-right: 8px;'>{priority_info['icon']}</span>
                <strong style='color: {priority_info['color']};'>{topic['subject']}</strong>
            </div>
            <div style='margin-left: 24px;'>
                <div><strong>ğŸ“– {topic['topic']}</strong></div>
                <div style='font-size: 14px; color: #666; margin-top: 4px;'>
                    â”” {topic.get('detail', '')} 
                    <span style='background: #e8f5e8; padding: 2px 6px; border-radius: 10px; margin-left: 8px;'>
                        {topic.get('net', 0)} net â€¢ {topic.get('days_passed', 0)} gÃ¼n Ã¶nce
                    </span>
                </div>
            </div>
        </div>
        """, unsafe_allow_html=True)

# ===== YENÄ°: KALICI Ã–ÄRENME SÄ°STEMÄ° UI FONKSÄ°YONLARI =====

def show_pending_reviews_section(pending_topics):
    """Tekrar deÄŸerlendirmesi bekleyen konular bÃ¶lÃ¼mÃ¼nÃ¼ gÃ¶sterir"""
    if not pending_topics:
        return
    
    for topic in pending_topics:
        with st.expander(f"ğŸ”„ {topic['subject']} - {topic['topic']} | {topic['stage_name']}", expanded=True):
            # Konu bilgileri
            col1, col2 = st.columns([2, 1])
            
            with col1:
                st.markdown(f"""
                **ğŸ“š Konu:** {topic['topic']}  
                **ğŸ“ Detay:** {topic.get('detail', '')}  
                **ğŸ“… Ä°lk Ã–ÄŸrenme:** {topic.get('days_since_last', 0)} gÃ¼n Ã¶nce  
                **ğŸ”¢ Tekrar SayÄ±sÄ±:** {topic.get('review_count', 0)}
                """)
            
            with col2:
                stage_info = MASTERY_STATUS.get(f"REVIEW_{topic['stage'] + 1}", MASTERY_STATUS["INITIAL"])
                st.markdown(f"""
                <div style='text-align: center; padding: 10px; background: {stage_info['color']}22; border-radius: 8px;'>
                    <div style='font-size: 24px;'>{stage_info['icon']}</div>
                    <div style='font-weight: bold; color: {stage_info['color']};'>{stage_info['name']}</div>
                </div>
                """, unsafe_allow_html=True)
            
            # DeÄŸerlendirme seÃ§enekleri
            st.markdown("#### ğŸ¯ Bu konuda kendinizi nasÄ±l deÄŸerlendiriyorsunuz?")
            
            col1, col2, col3, col4, col5 = st.columns(5)
            
            with col1:
                if st.button("âŒ ZayÄ±f", key=f"zayif_{topic['key']}", 
                           help="Konuyu tekrar Ã¶ÄŸrenmem gerekiyor",
                           use_container_width=True):
                    process_and_update_review(topic['key'], 'zayif')
            
            with col2:
                if st.button("ğŸ“š Temel", key=f"temel_{topic['key']}", 
                           help="Temel seviyede biliyorum",
                           use_container_width=True):
                    process_and_update_review(topic['key'], 'temel')
            
            with col3:
                if st.button("ğŸ“œ Orta", key=f"orta_{topic['key']}", 
                           help="Orta seviyede biliyorum",
                           use_container_width=True):
                    process_and_update_review(topic['key'], 'orta')
            
            with col4:
                if st.button("âœ… Ä°yi", key=f"iyi_{topic['key']}", 
                           help="Ä°yi seviyede biliyorum",
                           use_container_width=True):
                    process_and_update_review(topic['key'], 'iyi')
            
            with col5:
                if st.button("â­ Uzman", key=f"uzman_{topic['key']}", 
                           help="Uzman seviyede biliyorum",
                           use_container_width=True):
                    process_and_update_review(topic['key'], 'uzman')

def process_and_update_review(topic_key, evaluation):
    """Tekrar deÄŸerlendirmesini iÅŸler ve Firebase'i gÃ¼nceller"""
    # KullanÄ±cÄ± verilerini gÃ¼ncelle
    user_data = st.session_state.current_user
    updated_data = process_review_evaluation(user_data, topic_key, evaluation)
    
    # Firebase'de gÃ¼ncelle
    username = st.session_state.username
    update_success = update_user_in_firebase(username, {
        'topic_repetition_history': updated_data['topic_repetition_history'],
        'topic_mastery_status': updated_data['topic_mastery_status']
    })
    
    if update_success:
        # Session state'i gÃ¼ncelle
        st.session_state.current_user.update(updated_data)
        
        # BaÅŸarÄ± mesajÄ±
        evaluation_text = {
            'zayif': 'ZayÄ±f - Konu baÅŸa alÄ±ndÄ±',
            'temel': 'Temel - Tekrar programlandÄ±', 
            'orta': 'Orta - AynÄ± seviyede tekrar',
            'iyi': 'Ä°yi - Sonraki aÅŸamaya geÃ§ildi',
            'uzman': 'Uzman - Sonraki aÅŸamaya geÃ§ildi'
        }
        
        st.success(f"âœ… DeÄŸerlendirme kaydedildi: {evaluation_text[evaluation]}")
        st.experimental_rerun()
    else:
        st.error("âŒ DeÄŸerlendirme kaydedilemedi!")

def show_mastery_progress_dashboard(user_data):
    """KalÄ±cÄ± Ã¶ÄŸrenme ilerleme dashboard'u"""
    import json
    
    mastery_status = json.loads(user_data.get('topic_mastery_status', '{}'))
    
    if not mastery_status:
        st.info("ğŸ“š HenÃ¼z kalÄ±cÄ± Ã¶ÄŸrenme sisteminde konu bulunmuyor.")
        return
    
    st.markdown("### ğŸ¯ KALÄ°CÄ° Ã–ÄRENME Ä°LERLEMESI")
    
    # Ä°statistikler
    total_topics = len(mastery_status)
    mastered_topics = sum(1 for status in mastery_status.values() if status['status'] == 'MASTERED')
    in_progress = total_topics - mastered_topics
    
    col1, col2, col3 = st.columns(3)
    
    with col1:
        st.metric("ğŸ“š Toplam Konu", total_topics)
    
    with col2:
        st.metric("âœ… KalÄ±cÄ± Ã–ÄŸrenilen", mastered_topics, 
                 delta=f"%{(mastered_topics/total_topics*100):.1f}" if total_topics > 0 else "0%")
    
    with col3:
        st.metric("ğŸ”„ Devam Eden", in_progress)
    
    # DetaylÄ± liste
    if mastered_topics > 0:
        st.markdown("#### âœ… KalÄ±cÄ± Ã–ÄŸrenilen Konular")
        for topic_key, status in mastery_status.items():
            if status['status'] == 'MASTERED':
                parts = topic_key.split(' | ')
                if len(parts) >= 3:
                    st.success(f"âœ… {parts[0]} - {parts[2]} | âœ¨ BaÅŸarÄ±: {status['success_count']}/{status['total_reviews']}")

def get_current_week_info():
    """GÃ¼ncel haftanÄ±n bilgilerini dÃ¶ndÃ¼rÃ¼r - sÃ¼rekli gÃ¼ncellenecek"""
    today = datetime.now()
    
    # TÃ¼rkÃ§e ay isimleri
    turkish_months = {
        1: "Ocak", 2: "Åubat", 3: "Mart", 4: "Nisan", 5: "MayÄ±s", 6: "Haziran",
        7: "Temmuz", 8: "AÄŸustos", 9: "EylÃ¼l", 10: "Ekim", 11: "KasÄ±m", 12: "AralÄ±k"
    }
    
    # ğŸ”¥ FÄ°X: TÃ¼rkÃ§e gÃ¼n Ã§evirisi ekle
    day_translation = {
        'Monday': 'Pazartesi', 'Tuesday': 'SalÄ±', 'Wednesday': 'Ã‡arÅŸamba',
        'Thursday': 'PerÅŸembe', 'Friday': 'Cuma', 'Saturday': 'Cumartesi', 'Sunday': 'Pazar'
    }
    
    # Bu haftanÄ±n pazartesini bul
    days_since_monday = today.weekday()  # 0=Pazartesi, 6=Pazar
    monday_this_week = today - timedelta(days=days_since_monday)
    sunday_this_week = monday_this_week + timedelta(days=6)
    
    # Tarih aralÄ±ÄŸÄ± formatla (TÃ¼rkÃ§e ay isimleri ile)
    monday_str = f"{monday_this_week.day} {turkish_months[monday_this_week.month]}"
    sunday_str = f"{sunday_this_week.day} {turkish_months[sunday_this_week.month]} {sunday_this_week.year}"
    week_range = f"{monday_str} - {sunday_str}"
    
    # ğŸ”¥ FÄ°X: BugÃ¼nÃ¼n gÃ¼nÃ¼nÃ¼ TÃ¼rkÃ§e dÃ¶ndÃ¼r
    current_day_english = today.strftime('%A')
    current_day_turkish = day_translation.get(current_day_english, current_day_english)
    
    return {
        'today': today,
        'monday': monday_this_week,
        'sunday': sunday_this_week,
        'week_range': week_range,
        'week_number': today.isocalendar()[1],  # YÄ±lÄ±n kaÃ§Ä±ncÄ± haftasÄ±
        'current_day': current_day_turkish,  # ğŸ”¥ ArtÄ±k TÃ¼rkÃ§e!
        'days_to_yks': calculate_days_to_yks(),  # YKS'ye kalan gÃ¼n
    }

def calculate_days_to_yks():
    """YKS'ye kalan gÃ¼n sayÄ±sÄ±nÄ± hesaplar"""
    today = datetime.now().date()
    # YKS tarihi: 2026 yÄ±lÄ±nÄ±n Haziran ayÄ±nÄ±n ikinci hafta sonu
    # Genellikle Haziran'Ä±n ikinci hafta sonu oluyor (14-15 Haziran)
    yks_date = datetime(2026, 6, 14).date()
    
    days_left = (yks_date - today).days
    return max(0, days_left)  # GeÃ§miÅŸte bir tarih olursa 0 dÃ¶ndÃ¼r

def get_time_based_strategy(days_to_yks, current_month):
    """ğŸ¯ YKS'ye kalan sÃ¼reye gÃ¶re dinamik strateji belirleme sistemi"""
    
    # AylÄ±k strateji haritalama
    if days_to_yks > 210:  # Ekim-KasÄ±m-AralÄ±k (7+ ay kala)
        return {
            'period_name': 'TEMELCÄ° DÃ–NEM',
            'focus': 'temel_kavramlar_ve_konu_ogenimi',
            'priority': 'kavram_ogrenme',
            'deneme_frequency': 'ayda_1',
            'new_topics_per_week': 10,  # YoÄŸun konu Ã¶ÄŸrenimi
            'review_ratio': 0.25,  # %25 tekrar, %75 yeni konu
            'study_intensity': 'normal',
            'special_notes': 'Temel kavramlarÄ± saÄŸlam Ã¶ÄŸrenme dÃ¶nemi'
        }
    elif days_to_yks > 150:  # Ocak-Åubat (5-7 ay kala)
        return {
            'period_name': 'KONSOLDASYON DÃ–NEM',
            'focus': 'konu_pekistirme_ve_baglanti',
            'priority': 'konu_baglama',
            'deneme_frequency': '3_haftada_2',
            'new_topics_per_week': 8,
            'review_ratio': 0.35,  # %35 tekrar, %65 yeni konu
            'study_intensity': 'normal',
            'special_notes': 'Konular arasÄ± baÄŸlantÄ± kurma dÃ¶nemi'
        }
    elif days_to_yks > 120:  # Mart (3-5 ay kala)
        return {
            'period_name': 'EKSÄ°K KAPATMA DÃ–NEM',
            'focus': 'eksik_konular_ve_zayif_alanlar',
            'priority': 'eksik_kapama',
            'deneme_frequency': '2_haftada_1',
            'new_topics_per_week': 6,
            'review_ratio': 0.45,  # %45 tekrar, %55 yeni konu
            'study_intensity': 'artiriyor',
            'special_notes': 'ZayÄ±f konularÄ± tespit edip kapatma dÃ¶nemi'
        }
    elif days_to_yks > 90:  # Nisan (3 ay kala) - YOÄUNDENEMECÄ° DÃ–NEM
        return {
            'period_name': 'YOÄUN DENEMECÄ° DÃ–NEM',
            'focus': 'deneme_stratejisi_ve_hizli_cozum',
            'priority': 'deneme_performansi',
            'deneme_frequency': 'haftada_2',
            'new_topics_per_week': 4,  # Denemeye odak, az yeni konu
            'review_ratio': 0.65,  # %65 tekrar, %35 yeni konu
            'study_intensity': 'yuksek',
            'special_notes': 'Deneme stratejileri geliÅŸtirme dÃ¶nemi - NISAN DOLUDUR!'
        }
    elif days_to_yks > 60:  # MayÄ±s (2 ay kala) - DENEMEVEANALÄ°Z DÃ–NEM
        return {
            'period_name': 'DENEME VE ANALÄ°Z DÃ–NEM',
            'focus': 'deneme_analiz_odakli_calisma',
            'priority': 'analiz_tabanlÄ±_geliÅŸim',
            'deneme_frequency': 'haftada_3',
            'new_topics_per_week': 2,  # Ã‡ok az yeni konu
            'review_ratio': 0.75,  # %75 tekrar, %25 yeni konu
            'study_intensity': 'maksimum',
            'special_notes': 'Her deneme sonrasÄ± detaylÄ± analiz dÃ¶nemi - MAYIS YOÄUN!'
        }
    elif days_to_yks > 30:  # Haziran ilk yarÄ± (1 ay kala) - SON SPRINT DÃ–NEM
        return {
            'period_name': 'SON SPRÄ°NT DÃ–NEM',
            'focus': 'guncele_odakli_ve_moral_koruma',
            'priority': 'moral_ve_gÃ¼ven',
            'deneme_frequency': 'gÃ¼nde_1',
            'new_topics_per_week': 1,  # Sadece Ã§ok kritik eksikler
            'review_ratio': 0.85,  # %85 tekrar, %15 yeni konu
            'study_intensity': 'kontrollÃ¼_yoÄŸun',
            'special_notes': 'GÃ¼ven artÄ±rma ve mÃ¼kemmelleÅŸtirme dÃ¶nemi'
        }
    else:  # Son 30 gÃ¼n - MORAL KORUMA DÃ–NEM
        return {
            'period_name': 'MORAL KORUMA DÃ–NEM',
            'focus': 'moral_koruma_ve_hazir_tutma',
            'priority': 'mental_hazÄ±rlÄ±k',
            'deneme_frequency': '2_gÃ¼nde_1',
            'new_topics_per_week': 0,  # HiÃ§ yeni konu Ã¶ÄŸrenme
            'review_ratio': 1.0,  # %100 tekrar
            'study_intensity': 'sakin',
            'special_notes': 'Sadece bildiÄŸini pekiÅŸtir, stres yapma!'
        }

def get_deneme_strategy_by_period(strategy):
    """ğŸ“Š DÃ¶nemlere gÃ¶re deneme stratejisi"""
    
    deneme_strategies = {
        'TEMELCÄ° DÃ–NEM': {
            'type': 'kavram_deneme',
            'frequency_description': 'Ayda 1 kere, kavram Ã¶lÃ§me amaÃ§lÄ±',
            'analysis_focus': 'Hangi konularÄ± bilmiyorum?',
            'recommendation': 'Deneme sonrasÄ± eksik konulara aÄŸÄ±rlÄ±k ver'
        },
        'KONSOLDASYON DÃ–NEM': {
            'type': 'baglanti_deneme',
            'frequency_description': '3 haftada 2 kere, konular arasÄ± baÄŸlantÄ± Ã¶lÃ§me',
            'analysis_focus': 'KonularÄ± birbirleriyle baÄŸlayabiliyor muyum?',
            'recommendation': 'Karma sorular Ã§Ã¶z, farklÄ± konu karÄ±ÅŸÄ±mlarÄ± dene'
        },
        'EKSÄ°K KAPATMA DÃ–NEM': {
            'type': 'eksik_tespit_deneme',
            'frequency_description': '2 haftada 1 kere, zayÄ±f alanlarÄ± tespit etme',
            'analysis_focus': 'En Ã§ok puan kaybettiÄŸim konular hangileri?',
            'recommendation': 'Deneme sonrasÄ± 1 hafta o konulara odaklan'
        },
        'YOÄUN DENEMECÄ° DÃ–NEM': {
            'type': 'strateji_deneme',
            'frequency_description': 'Haftada 2 kere, Ã§Ã¶zÃ¼m stratejileri geliÅŸtirme',
            'analysis_focus': 'Hangi soru tiplerinde yavaÅŸÄ±m? Zaman yÃ¶netimi nasÄ±l?',
            'recommendation': 'Soru Ã§Ã¶zme hÄ±zÄ±nÄ± artÄ±r, zaman stratejisi geliÅŸtir'
        },
        'DENEME VE ANALÄ°Z DÃ–NEM': {
            'type': 'performans_deneme',
            'frequency_description': 'Haftada 3 kere, performans maksimize etme',
            'analysis_focus': 'Net sayÄ±mÄ± nasÄ±l artÄ±rabilirim?',
            'recommendation': 'Her deneme sonrasÄ± 2 gÃ¼n analiz, 2 gÃ¼n eksik Ã§alÄ±ÅŸma'
        },
        'SON SPRÄ°NT DÃ–NEM': {
            'type': 'guven_deneme',
            'frequency_description': 'GÃ¼nde 1 kere, gÃ¼ven artÄ±rma amaÃ§lÄ±',
            'analysis_focus': 'Bildiklerimi doÄŸru iÅŸaretleyebiliyor muyum?',
            'recommendation': 'Hata minimizasyonu, iÅŸaretleme stratejisi'
        },
        'MORAL KORUMA DÃ–NEM': {
            'type': 'rahatlatici_deneme',
            'frequency_description': '2 gÃ¼nde 1 kere, stresi azaltma amaÃ§lÄ±',
            'analysis_focus': 'Rahat ve kendimden eminim',
            'recommendation': 'Ã‡ok analiz yapma, sadece formda kal'
        }
    }
    
    return deneme_strategies.get(strategy['period_name'], deneme_strategies['TEMELCÄ° DÃ–NEM'])

def calculate_dynamic_topic_limits(strategy, subject_importance):
    """ğŸ¯ DÃ¶nemlere gÃ¶re dinamik konu limitleri"""
    
    base_limit = strategy['new_topics_per_week']
    
    # Ders Ã¶nemine gÃ¶re Ã§arpan
    importance_multiplier = {
        10: 1.5,  # En Ã¶nemli dersler (TYT Mat, AYT Mat)
        9: 1.3,   # Ã‡ok Ã¶nemli 
        8: 1.1,   # Ã–nemli
        7: 1.0,   # Normal
        6: 0.8,   # Az Ã¶nemli
        5: 0.6,   # En az Ã¶nemli
        4: 0.4,
        3: 0.3,
        2: 0.2,
        1: 0.1
    }
    
    multiplier = importance_multiplier.get(subject_importance, 1.0)
    calculated_limit = int(base_limit * multiplier)
    
    # Minimum 1, maksimum limits
    return max(1, min(calculated_limit, 15))

def get_time_based_priority_boost(strategy, subject, user_performance):
    """âš¡ Zamansal stratejiye gÃ¶re Ã¶ncelik boost'u"""
    
    boost = 0
    period = strategy['period_name']
    
    # DÃ¶nemlere gÃ¶re ders Ã¶ncelik boost'larÄ±
    if period == 'TEMELCÄ° DÃ–NEM':
        # Temel matematik ve TÃ¼rkÃ§e'ye boost
        if 'TYT Matematik' in subject or 'TYT TÃ¼rkÃ§e' in subject:
            boost += 2
    
    elif period == 'EKSÄ°K KAPATMA DÃ–NEM':
        # DÃ¼ÅŸÃ¼k performanslÄ± derslere boost
        if user_performance < 40:  # %40'Ä±n altÄ± zayÄ±f
            boost += 3
    
    elif period in ['YOÄUN DENEMECÄ° DÃ–NEM', 'DENEME VE ANALÄ°Z DÃ–NEM']:
        # YÃ¼ksek puanlÄ±, sÄ±nav stratejik derslere boost
        if any(x in subject for x in ['AYT Matematik', 'AYT Fizik', 'TYT Matematik']):
            boost += 1.5
    
    elif period == 'SON SPRÄ°NT DÃ–NEM':
        # GÃ¼Ã§lÃ¼ olunan derslere boost (gÃ¼ven artÄ±rma)
        if user_performance > 70:  # %70'in Ã¼stÃ¼ gÃ¼Ã§lÃ¼
            boost += 2
    
    return boost

def calculate_user_subject_performance(subject, user_data):
    """ğŸ“Š KullanÄ±cÄ±nÄ±n bir dersteki performansÄ±nÄ± hesaplar (0-100 arasÄ±)"""
    
    # Deneme verilerinden performans hesapla
    deneme_data = user_data.get('deneme_analizleri', '[]')
    try:
        deneme_list = json.loads(deneme_data) if deneme_data else []
    except:
        deneme_list = []
    
    # Son 3 deneme ortalamasÄ±
    if deneme_list:
        recent_exams = deneme_list[-3:] if len(deneme_list) >= 3 else deneme_list
        
        total_score = 0
        count = 0
        
        for exam in recent_exams:
            if subject in ['TYT Matematik', 'TYT TÃ¼rkÃ§e', 'TYT Fen', 'TYT Sosyal']:
                net_key = subject.lower().replace('tyt ', '') + '_net'
                if net_key in exam:
                    total_score += exam[net_key] * 2.5  # 40 soru Ã¼zerinden %100'e Ã§evir
                    count += 1
            elif subject.startswith('AYT'):
                ayt_subject = subject.replace('AYT ', '').lower()
                net_key = ayt_subject + '_net'
                if net_key in exam:
                    # AYT dersleri genelde 40 soru Ã¼zerinden
                    total_score += exam[net_key] * 2.5
                    count += 1
        
        if count > 0:
            return min(100, total_score / count)
    
    # Deneme verisi yoksa konu ilerlemesinden hesapla
    topic_progress = json.loads(user_data.get('topic_progress', '{}') or '{}')
    
    # Bu derse ait konularÄ± bul
    subject_topics = []
    for topic_key, progress in topic_progress.items():
        if subject.lower().replace(' ', '_') in topic_key.lower():
            subject_topics.append(progress)
    
    if subject_topics:
        # Tamamlanan konu yÃ¼zdesi
        completed = sum(1 for p in subject_topics if p.get('status') == 'completed')
        return (completed / len(subject_topics)) * 100
    
    # VarsayÄ±lan: Orta seviye
    return 50

def should_include_subject_in_period(subject, importance, time_strategy, user_data, week_info):
    """ğŸ“… Bu dersin bu dÃ¶nemde Ã§alÄ±ÅŸÄ±lÄ±p Ã§alÄ±ÅŸÄ±lmayacaÄŸÄ±nÄ± belirler"""
    
    period = time_strategy['period_name']
    
    # TEMELCÄ° DÃ–NEM: Sadece temel dersler
    if period == 'TEMELCÄ° DÃ–NEM':
        # YÃ¼ksek Ã¶nem puanlÄ± dersleri (â‰¥7) ve temel TYT derslerini dahil et
        if importance >= 7 or subject in ['TYT Matematik', 'TYT TÃ¼rkÃ§e']:
            return True
        return False
    
    # KONSOLDASYON DÃ–NEM: Ã‡oÄŸu dersi dahil et
    elif period == 'KONSOLDASYON DÃ–NEM':
        # Orta ve yÃ¼ksek Ã¶nemli dersleri dahil et (â‰¥5)
        return importance >= 5
    
    # EKSÄ°K KAPATMA DÃ–NEM: Performansa dayalÄ± filtreleme
    elif period == 'EKSÄ°K KAPATMA DÃ–NEM':
        user_performance = calculate_user_subject_performance(subject, user_data)
        # ZayÄ±f performanslÄ± dersleri (<60) ve yÃ¼ksek Ã¶nemlileri dahil et
        return user_performance < 60 or importance >= 8
    
    # YOÄUN DENEMECÄ° DÃ–NEM: Stratejik dersler
    elif period == 'YOÄUN DENEMECÄ° DÃ–NEM':
        # Sadece yÃ¼ksek puanlÄ±, sÄ±nav kritik dersleri
        strategic_subjects = ['TYT Matematik', 'AYT Matematik', 'AYT Fizik', 'TYT TÃ¼rkÃ§e']
        return any(s in subject for s in strategic_subjects) or importance >= 9
    
    # DENEME VE ANALÄ°Z DÃ–NEM: Analiz bazlÄ± seÃ§im
    elif period == 'DENEME VE ANALÄ°Z DÃ–NEM':
        # Son deneme sonuÃ§larÄ±na gÃ¶re zayÄ±f Ã§Ä±kan dersleri dahil et
        return is_subject_weak_in_recent_exams(subject, user_data) or importance >= 9
    
    # SON SPRÄ°NT DÃ–NEM: GÃ¼Ã§lÃ¼ olunan dersler
    elif period == 'SON SPRÄ°NT DÃ–NEM':
        user_performance = calculate_user_subject_performance(subject, user_data)
        # GÃ¼Ã§lÃ¼ olunan dersleri dahil et (>70) - gÃ¼ven artÄ±rma
        return user_performance > 70 or importance >= 10
    
    # MORAL KORUMA DÃ–NEM: Sadece en gÃ¼Ã§lÃ¼ dersler
    elif period == 'MORAL KORUMA DÃ–NEM':
        user_performance = calculate_user_subject_performance(subject, user_data)
        # Sadece Ã§ok gÃ¼Ã§lÃ¼ olunan dersleri (>80)
        return user_performance > 80
    
    # VarsayÄ±lan: Dahil et
    return True

def is_subject_weak_in_recent_exams(subject, user_data):
    """ğŸ“‰ Son denemelerde bu dersin zayÄ±f olup olmadÄ±ÄŸÄ±nÄ± kontrol eder"""
    
    deneme_data = user_data.get('deneme_analizleri', '[]')
    try:
        deneme_list = json.loads(deneme_data) if deneme_data else []
    except:
        return False
    
    if not deneme_list:
        return False
    
    # Son 2 denemeyi kontrol et
    recent_exams = deneme_list[-2:] if len(deneme_list) >= 2 else deneme_list
    
    weak_count = 0
    total_count = 0
    
    for exam in recent_exams:
        if subject in ['TYT Matematik', 'TYT TÃ¼rkÃ§e', 'TYT Fen', 'TYT Sosyal']:
            net_key = subject.lower().replace('tyt ', '') + '_net'
            if net_key in exam:
                net_score = exam[net_key]
                total_count += 1
                # TYT iÃ§in 20 net altÄ± zayÄ±f kabul et
                if net_score < 20:
                    weak_count += 1
        elif subject.startswith('AYT'):
            ayt_subject = subject.replace('AYT ', '').lower()
            net_key = ayt_subject + '_net'
            if net_key in exam:
                net_score = exam[net_key]
                total_count += 1
                # AYT iÃ§in 15 net altÄ± zayÄ±f kabul et
                if net_score < 15:
                    weak_count += 1
    
    # Denemelerin yarÄ±sÄ±ndan fazlasÄ±nda zayÄ±fsa True
    return total_count > 0 and (weak_count / total_count) > 0.5

def calculate_review_topics_limit_by_period(time_strategy):
    """ğŸ”„ DÃ¶nemlere gÃ¶re tekrar konusu limiti"""
    
    period = time_strategy['period_name']
    review_ratio = time_strategy['review_ratio']
    total_weekly_topics = time_strategy['new_topics_per_week']
    
    # Tekrar oranÄ±na gÃ¶re limite hesapla
    if period in ['TEMELCÄ° DÃ–NEM', 'KONSOLDASYON DÃ–NEM']:
        return max(3, int(total_weekly_topics * review_ratio))
    elif period == 'EKSÄ°K KAPATMA DÃ–NEM':
        return max(4, int(total_weekly_topics * review_ratio))
    elif period == 'YOÄUN DENEMECÄ° DÃ–NEM':
        return max(6, int(total_weekly_topics * review_ratio))
    elif period == 'DENEME VE ANALÄ°Z DÃ–NEM':
        return max(8, int(total_weekly_topics * review_ratio))
    elif period == 'SON SPRÄ°NT DÃ–NEM':
        return max(10, int(total_weekly_topics * review_ratio))
    else:  # MORAL KORUMA
        return 12  # Sadece tekrar
    
def filter_review_topics_by_strategy(review_topics, time_strategy, user_data):
    """ğŸ“‹ Zamansal stratejiye gÃ¶re tekrar konularÄ±nÄ± filtrele ve Ã¶ncelikle"""
    
    period = time_strategy['period_name']
    
    if not review_topics:
        return []
    
    # Her dÃ¶nem iÃ§in farklÄ± filtreleme stratejisi
    if period == 'TEMELCÄ° DÃ–NEM':
        # Temel konularÄ± Ã¶ncelikle - TYT matematik ve TÃ¼rkÃ§e
        priority_subjects = ['TYT Matematik', 'TYT TÃ¼rkÃ§e']
        return prioritize_topics_by_subjects(review_topics, priority_subjects)
    
    elif period == 'KONSOLDASYON DÃ–NEM':
        # TÃ¼m konularÄ± karÄ±ÅŸÄ±k ÅŸekilde
        return review_topics  # KarÄ±ÅŸÄ±k dÃ¶nem
    
    elif period == 'EKSÄ°K KAPATMA DÃ–NEM':
        # ZayÄ±f performanslÄ± konularÄ± Ã¶ncelikle
        return prioritize_topics_by_weakness(review_topics, user_data)
    
    elif period in ['YOÄUN DENEMECÄ° DÃ–NEM', 'DENEME VE ANALÄ°Z DÃ–NEM']:
        # YÃ¼ksek puanlÄ±, sÄ±nav kritik konularÄ± Ã¶ncelikle
        strategic_subjects = ['TYT Matematik', 'AYT Matematik', 'AYT Fizik']
        return prioritize_topics_by_subjects(review_topics, strategic_subjects)
    
    elif period == 'SON SPRÄ°NT DÃ–NEM':
        # GÃ¼Ã§lÃ¼ olunan konularÄ± Ã¶ncelikle (gÃ¼ven artÄ±rma)
        return prioritize_topics_by_strength(review_topics, user_data)
    
    else:  # MORAL KORUMA DÃ–NEM
        # En gÃ¼Ã§lÃ¼ olunan konularÄ± (stres azaltma)
        return prioritize_topics_by_strength(review_topics, user_data)[:8]

def prioritize_topics_by_subjects(topics, priority_subjects):
    """ğŸ“š Belirli dersleri Ã¶ncelikle sÄ±ralar"""
    
    priority_topics = []
    other_topics = []
    
    for topic in topics:
        topic_subject = topic.get('subject', '')
        if any(subj in topic_subject for subj in priority_subjects):
            priority_topics.append(topic)
        else:
            other_topics.append(topic)
    
    return priority_topics + other_topics

def prioritize_topics_by_weakness(topics, user_data):
    """ğŸ“‰ ZayÄ±f performanslÄ± konularÄ± Ã¶ncelikle sÄ±ralar"""
    
    # Deneme verilerinden zayÄ±f konularÄ± belirle
    weak_subjects = get_weak_subjects_from_exams(user_data)
    
    weak_topics = []
    normal_topics = []
    
    for topic in topics:
        topic_subject = topic.get('subject', '')
        if any(weak_subj in topic_subject for weak_subj in weak_subjects):
            weak_topics.append(topic)
        else:
            normal_topics.append(topic)
    
    return weak_topics + normal_topics

def prioritize_topics_by_strength(topics, user_data):
    """ğŸ“ˆ GÃ¼Ã§lÃ¼ olunan konularÄ± Ã¶ncelikle sÄ±ralar"""
    
    strong_subjects = get_strong_subjects_from_performance(user_data)
    
    strong_topics = []
    normal_topics = []
    
    for topic in topics:
        topic_subject = topic.get('subject', '')
        if any(strong_subj in topic_subject for strong_subj in strong_subjects):
            strong_topics.append(topic)
        else:
            normal_topics.append(topic)
    
    return strong_topics + normal_topics

def get_weak_subjects_from_exams(user_data):
    """ğŸ“‰ Deneme sonuÃ§larÄ±ndan zayÄ±f dersleri belirler"""
    
    deneme_data = user_data.get('deneme_analizleri', '[]')
    try:
        deneme_list = json.loads(deneme_data) if deneme_data else []
    except:
        return []
    
    if not deneme_list:
        return []
    
    # Son 2 denemeyi analiz et
    recent_exams = deneme_list[-2:] if len(deneme_list) >= 2 else deneme_list
    weak_subjects = []
    
    for exam in recent_exams:
        # TYT dersleri kontrolÃ¼
        if exam.get('matematik_net', 0) < 20:
            weak_subjects.append('TYT Matematik')
        if exam.get('turkce_net', 0) < 20:
            weak_subjects.append('TYT TÃ¼rkÃ§e')
        if exam.get('fen_net', 0) < 15:
            weak_subjects.append('TYT Fen')
        if exam.get('sosyal_net', 0) < 15:
            weak_subjects.append('TYT Sosyal')
        
        # AYT dersleri kontrolÃ¼
        if exam.get('matematik_net', 0) < 15:
            weak_subjects.append('AYT Matematik')
        if exam.get('fizik_net', 0) < 10:
            weak_subjects.append('AYT Fizik')
        if exam.get('kimya_net', 0) < 10:
            weak_subjects.append('AYT Kimya')
        if exam.get('biyoloji_net', 0) < 10:
            weak_subjects.append('AYT Biyoloji')
    
    # Tekrar eden zayÄ±f dersleri dÃ¶ndÃ¼r
    return list(set(weak_subjects))

def get_strong_subjects_from_performance(user_data):
    """ğŸ“ˆ Performans verilerinden gÃ¼Ã§lÃ¼ dersleri belirler"""
    
    strong_subjects = []
    
    # TYT/AYT ortalama net deÄŸerlerinden hesapla
    tyt_avg = user_data.get('tyt_avg_net', 0)
    ayt_avg = user_data.get('ayt_avg_net', 0)
    
    # Deneme verilerinden de kontrol et
    deneme_data = user_data.get('deneme_analizleri', '[]')
    try:
        deneme_list = json.loads(deneme_data) if deneme_data else []
    except:
        deneme_list = []
    
    if deneme_list:
        recent_exams = deneme_list[-2:] if len(deneme_list) >= 2 else deneme_list
        
        for exam in recent_exams:
            # TYT gÃ¼Ã§lÃ¼ dersleri
            if exam.get('matematik_net', 0) > 25:
                strong_subjects.append('TYT Matematik')
            if exam.get('turkce_net', 0) > 25:
                strong_subjects.append('TYT TÃ¼rkÃ§e')
            if exam.get('fen_net', 0) > 20:
                strong_subjects.append('TYT Fen')
            if exam.get('sosyal_net', 0) > 20:
                strong_subjects.append('TYT Sosyal')
            
            # AYT gÃ¼Ã§lÃ¼ dersleri
            if exam.get('matematik_net', 0) > 20:
                strong_subjects.append('AYT Matematik')
            if exam.get('fizik_net', 0) > 15:
                strong_subjects.append('AYT Fizik')
            if exam.get('kimya_net', 0) > 15:
                strong_subjects.append('AYT Kimya')
            if exam.get('biyoloji_net', 0) > 15:
                strong_subjects.append('AYT Biyoloji')
    
    return list(set(strong_subjects))

def get_period_specific_recommendations(time_strategy, user_data):
    """ğŸ“‹ DÃ¶nem bazlÄ± Ã¶zel Ã¶neriler"""
    
    period = time_strategy['period_name']
    days_to_yks = time_strategy.get('days_to_yks', 300)
    
    recommendations = {
        'TEMELCÄ° DÃ–NEM': [
            "ğŸ§  Temel kavramlarÄ± derinlemesine Ã¶ÄŸrenmeye odaklan",
            "ğŸ“š Her konu iÃ§in alt yapÄ± saÄŸlamlaÅŸtÄ±r",
            "ğŸ¯ GÃ¼nde 4-5 saat dÃ¼zenli Ã§alÄ±ÅŸma temposu kur",
            "ğŸ“ Ayda 1 deneme Ã§Ã¶z, eksikleri tespit et",
            "ğŸ’¡ KonularÄ± sadece ezberlemek yerine anlayarak Ã¶ÄŸren"
        ],
        'KONSOLDASYON DÃ–NEM': [
            "ğŸ”— Konular arasÄ± baÄŸlantÄ±larÄ± gÃ¼Ã§lendir",
            "ğŸ“ Karma sorular Ã§Ã¶zmeye baÅŸla",
            "ğŸ“Š Deneme sÄ±klÄ±ÄŸÄ±nÄ± artÄ±r (3 haftada 2)",
            "ğŸ’ª Ã‡alÄ±ÅŸma saatini 5-6'ya Ã§Ä±kar",
            "ğŸ”„ Ã–ÄŸrendiklerini gÃ¼nlÃ¼k hayatla baÄŸdaÅŸtÄ±r"
        ],
        'EKSÄ°K KAPATMA DÃ–NEM': [
            "ğŸ¯ ZayÄ±f konularÄ± tespit et ve onlara odaklan",
            "ğŸ“ˆ Deneme analizi yapmayÄ± Ã¶ÄŸren",
            "âš¡ Ã‡alÄ±ÅŸma temponu artÄ±r (gÃ¼nde 6-7 saat)",
            "ğŸ” DetaylÄ± konu tekrarlarÄ± yap",
            "ğŸ’¯ Net sayÄ±larÄ±nÄ± sistematik takip et"
        ],
        'YOÄUN DENEMECÄ° DÃ–NEM': [
            "ğŸ² Haftada 2-3 deneme Ã§Ã¶z",
            "â±ï¸ Zaman yÃ¶netimi stratejileri geliÅŸtir",
            "ğŸš€ Soru Ã§Ã¶zme hÄ±zÄ±nÄ± artÄ±r",
            "ğŸ“‹ Her deneme sonrasÄ± detaylÄ± analiz yap",
            "ğŸ¯ Soru tipleri ve Ã§Ã¶zÃ¼m tekniklerini Ã¶ÄŸren",
            "ğŸ’ª GÃ¼nde 7-8 saat yoÄŸun tempo"
        ],
        'DENEME VE ANALÄ°Z DÃ–NEM': [
            "ğŸ“Š Her deneme sonrasÄ± 2 gÃ¼n analiz ayÄ±r",
            "ğŸ”„ HÄ±zlÄ± eksik konu Ã§alÄ±ÅŸmasÄ± yap",
            "ğŸ¯ Net sayÄ±sÄ± optimizasyonuna odaklan",
            "âš¡ Maksimum performans iÃ§in 8-9 saat Ã§alÄ±ÅŸ",
            "ğŸ§  Mental hazÄ±rlÄ±k ve motivasyonu korur",
            "ğŸ“ˆ Strateji denemelerine baÅŸla"
        ],
        'SON SPRÄ°NT DÃ–NEM': [
            "ğŸ’ GÃ¼Ã§lÃ¼ olduÄŸun konularÄ± pekiÅŸtir",
            "ğŸ›¡ï¸ Hata yapma olasÄ±lÄ±ÄŸÄ±nÄ± minimize et",
            "ğŸ¯ GÃ¼nde 1 deneme + analiz",
            "ğŸ˜Š Kendine gÃ¼veni artÄ±r",
            "âš–ï¸ Stresi yÃ¶net, sakin kal",
            "ğŸ”„ Sadece bildiklerini tekrar et"
        ],
        'MORAL KORUMA DÃ–NEM': [
            "ğŸ˜Œ Stres yapmaktan kaÃ§Ä±n, sakin kal",
            "ğŸ’ª Ã–zgÃ¼veni koruyun",
            "ğŸ¯ BildiÄŸin konularÄ± hÄ±zlÄ± tekrar et",
            "ğŸš« Yeni konu Ã¶ÄŸrenmeye Ã§alÄ±ÅŸma",
            "ğŸ’¤ Uyku dÃ¼zenini koru",
            "ğŸ§˜ Rahatlama egzersizleri yap",
            "ğŸ‰ SÄ±nav gÃ¼nÃ¼ne hazÄ±r olduÄŸunu hatÄ±rla"
        ]
    }
    
    base_recommendations = recommendations.get(period, recommendations['TEMELCÄ° DÃ–NEM'])
    
    # Kalan gÃ¼n sayÄ±sÄ±na gÃ¶re Ã¶zel mesajlar
    if days_to_yks <= 7:
        base_recommendations.append(f"âš¡ Sadece {days_to_yks} gÃ¼n kaldÄ±! Son kontrollerini yap.")
    elif days_to_yks <= 30:
        base_recommendations.append(f"ğŸ”¥ {days_to_yks} gÃ¼n kaldÄ±! YoÄŸun tempo devam!")
    elif days_to_yks <= 90:
        base_recommendations.append(f"ğŸ’ª {days_to_yks} gÃ¼n kaldÄ±! Deneme dÃ¶neminde son sÃ¼rat!")
    
    return base_recommendations

def get_focus_areas_by_period(time_strategy, user_data):
    """ğŸ¯ DÃ¶nem bazlÄ± odaklanma alanlarÄ±"""
    
    period = time_strategy['period_name']
    
    focus_areas = {
        'TEMELCÄ° DÃ–NEM': {
            'primary': ['Temel Matematik', 'TÃ¼rkÃ§e Okuma Anlama', 'Fen Bilimleri Temeli'],
            'secondary': ['Sosyal Bilimler', 'Geometri Temelleri'],
            'avoid': ['Ä°leri AYT KonularÄ±', 'Ã‡ok DetaylÄ± Konular']
        },
        'KONSOLDASYON DÃ–NEM': {
            'primary': ['TÃ¼m TYT AlanlarÄ±', 'Temel AYT GeÃ§iÅŸi', 'Konu BaÄŸlantÄ±larÄ±'],
            'secondary': ['Deneme Teknikleri', 'HÄ±z GeliÅŸtirme'],
            'avoid': ['Ã‡ok GeliÅŸmiÅŸ Konular', 'YoÄŸun Deneme']
        },
        'EKSÄ°K KAPATMA DÃ–NEM': {
            'primary': ['ZayÄ±f Dersler', 'DÃ¼ÅŸÃ¼k Net AlanlarÄ±', 'Kritik Konular'],
            'secondary': ['Orta Seviye Konular', 'PekiÅŸtirme'],
            'avoid': ['GÃ¼Ã§lÃ¼ Alanlar', 'Yeni Konular']
        },
        'YOÄUN DENEMECÄ° DÃ–NEM': {
            'primary': ['Deneme Stratejileri', 'Zaman YÃ¶netimi', 'HÄ±zlÄ± Ã‡Ã¶zÃ¼m'],
            'secondary': ['Net Optimizasyonu', 'Soru Tipleri'],
            'avoid': ['Yeni Konu Ã–ÄŸrenme', 'Temel Tekrarlar']
        },
        'DENEME VE ANALÄ°Z DÃ–NEM': {
            'primary': ['Deneme Analizi', 'Net ArtÄ±rma', 'Hata Minimizasyonu'],
            'secondary': ['Stratejik Konular', 'HÄ±zlÄ± Eksik Kapatma'],
            'avoid': ['KapsamlÄ± Yeni Ã–ÄŸrenme', 'Temel Seviye']
        },
        'SON SPRÄ°NT DÃ–NEM': {
            'primary': ['GÃ¼Ã§lÃ¼ Konular', 'Ã–zgÃ¼ven ArtÄ±rma', 'HÄ±zlÄ± Tekrar'],
            'secondary': ['SÄ±nav Stratejisi', 'Stres YÃ¶netimi'],
            'avoid': ['Zor Yeni Konular', 'Uzun Ã‡alÄ±ÅŸma SeanslarÄ±']
        },
        'MORAL KORUMA DÃ–NEM': {
            'primary': ['Mental HazÄ±rlÄ±k', 'Ã–zgÃ¼ven', 'Rahatlama'],
            'secondary': ['HÄ±zlÄ± Tekrarlar', 'Pozitif DÃ¼ÅŸÃ¼nce'],
            'avoid': ['Stresli Ã‡alÄ±ÅŸma', 'Yeni Konular', 'Ã‡ok Analiz']
        }
    }
    
    return focus_areas.get(period, focus_areas['TEMELCÄ° DÃ–NEM'])

def show_time_strategy_dashboard(weekly_plan):
    """ğŸ¯ Zamansal strateji dashboard'u"""
    
    time_strategy = weekly_plan.get('time_strategy', {})
    deneme_strategy = weekly_plan.get('deneme_strategy', {})
    recommendations = weekly_plan.get('period_recommendations', [])
    focus_areas = weekly_plan.get('focus_areas', {})
    
    # DÃ–NEM STRATEJÄ°NÄ°Z kÄ±smÄ± kaldÄ±rÄ±ldÄ± - Gereksiz karmaÅŸa yerine gerÃ§ek konu takvimi eklendi
    
    # Kalan gÃ¼n sayÄ±sÄ±na gÃ¶re motivasyon mesajÄ±
    days_to_yks = time_strategy.get('days_to_yks', 300)
    if days_to_yks <= 30:
        st.error(f"âš¡ Sadece {days_to_yks} gÃ¼n kaldÄ±! Son sprint zamanÄ±!")
    elif days_to_yks <= 60:
        st.warning(f"ğŸ”¥ {days_to_yks} gÃ¼n kaldÄ±! YoÄŸun deneme dÃ¶nemi!")
    elif days_to_yks <= 120:
        st.info(f"ğŸ’ª {days_to_yks} gÃ¼n kaldÄ±! Eksikleri kapatma zamanÄ±!")

def show_time_based_progress_analysis(user_data, week_info):
    """GÃ¼nlÃ¼k/HaftalÄ±k/AylÄ±k ilerleme analizi - YKS odaklÄ±"""
    st.markdown("### ğŸ“Š ZAMANSAL Ä°LERLEME ANALÄ°ZÄ°")
    st.caption("Son gÃ¼nlerdeki Ã§alÄ±ÅŸma hÄ±zÄ±nÄ±z ve konu tamamlama performansÄ±nÄ±z")
    
    # Temel veriler
    topic_progress = json.loads(user_data.get('topic_progress', '{}') or '{}')
    completion_dates = json.loads(user_data.get('topic_completion_dates', '{}') or '{}')
    current_date = datetime.now()
    
    # GÃ¼nlÃ¼k analiz (son 24 saat)
    daily_stats = calculate_daily_progress(topic_progress, completion_dates, current_date)
    
    # HaftalÄ±k analiz (son 7 gÃ¼n)
    weekly_stats = calculate_weekly_progress(topic_progress, completion_dates, current_date)
    
    # AylÄ±k analiz (son 30 gÃ¼n)
    monthly_stats = calculate_monthly_progress(topic_progress, completion_dates, current_date)
    
    # Metrik gÃ¶sterimi
    col1, col2, col3 = st.columns(3)
    
    with col1:
        st.markdown("#### ğŸ“… GÃ¼nlÃ¼k Performans")
        st.metric("ğŸ¯ Tamamlanan Konu", daily_stats['completed_topics'], 
                 delta=f"+{daily_stats['net_increase']} net artÄ±ÅŸÄ±" if daily_stats['net_increase'] > 0 else None)
        st.metric("âš¡ Ã‡alÄ±ÅŸma Momentum", 
                 "YÃ¼ksek" if daily_stats['completed_topics'] >= 3 else "Orta" if daily_stats['completed_topics'] >= 1 else "DÃ¼ÅŸÃ¼k",
                 delta="Son 24 saat")
        
    with col2:
        st.markdown("#### ğŸ“ˆ HaftalÄ±k Performans")
        st.metric("ğŸ¯ Tamamlanan Konu", weekly_stats['completed_topics'],
                 delta=f"Hedef: 15 konu/hafta")
        weekly_pace = "Ã‡ok HÄ±zlÄ±" if weekly_stats['completed_topics'] >= 20 else "HÄ±zlÄ±" if weekly_stats['completed_topics'] >= 15 else "Normal" if weekly_stats['completed_topics'] >= 10 else "YavaÅŸ"
        st.metric("ğŸš€ HaftalÄ±k HÄ±z", weekly_pace,
                 delta=f"+{weekly_stats['net_increase']} net artÄ±ÅŸÄ±")
        
    with col3:
        st.markdown("#### ğŸ“Š AylÄ±k Performans")
        st.metric("ğŸ¯ Tamamlanan Konu", monthly_stats['completed_topics'],
                 delta=f"Hedef: 60 konu/ay")
        monthly_trend = "ArtÄ±ÅŸ EÄŸiliminde" if monthly_stats['trend'] > 0 else "AzalÄ±ÅŸ EÄŸiliminde" if monthly_stats['trend'] < 0 else "Sabit"
        st.metric("ğŸ“ˆ Trend", monthly_trend,
                 delta=f"Ort. {monthly_stats['avg_per_week']:.1f} konu/hafta")
    
    # GÃ¶rsel grafik
    if monthly_stats['daily_data']:
        create_progress_chart(monthly_stats['daily_data'])

def calculate_daily_progress(topic_progress, completion_dates, current_date):
    """Son 24 saatteki ilerlemeyi hesaplar"""
    yesterday = current_date - timedelta(days=1)
    completed_today = 0
    net_increase = 0
    
    for topic_key, completion_date_str in completion_dates.items():
        try:
            completion_date = datetime.fromisoformat(completion_date_str)
            if completion_date >= yesterday:
                completed_today += 1
                net_value = int(float(topic_progress.get(topic_key, '0')))
                if net_value >= 14:
                    net_increase += (net_value - 14)  # 14'ten yukarÄ±sÄ± net artÄ±ÅŸ
        except:
            continue
    
    return {
        'completed_topics': completed_today,
        'net_increase': net_increase,
        'momentum': 'high' if completed_today >= 3 else 'medium' if completed_today >= 1 else 'low'
    }

def calculate_weekly_progress(topic_progress, completion_dates, current_date):
    """Son 7 gÃ¼ndeki ilerlemeyi hesaplar"""
    week_ago = current_date - timedelta(days=7)
    completed_this_week = 0
    net_increase = 0
    
    for topic_key, completion_date_str in completion_dates.items():
        try:
            completion_date = datetime.fromisoformat(completion_date_str)
            if completion_date >= week_ago:
                completed_this_week += 1
                net_value = int(float(topic_progress.get(topic_key, '0')))
                if net_value >= 14:
                    net_increase += (net_value - 14)
        except:
            continue
    
    return {
        'completed_topics': completed_this_week,
        'net_increase': net_increase,
        'pace': 'fast' if completed_this_week >= 15 else 'normal' if completed_this_week >= 10 else 'slow'
    }

def calculate_monthly_progress(topic_progress, completion_dates, current_date):
    """Son 30 gÃ¼ndeki ilerlemeyi hesaplar ve trend analizi yapar"""
    month_ago = current_date - timedelta(days=30)
    completed_this_month = 0
    daily_data = []
    
    # GÃ¼nlÃ¼k verileri topla
    for i in range(30):
        day = current_date - timedelta(days=i)
        day_count = 0
        
        for topic_key, completion_date_str in completion_dates.items():
            try:
                completion_date = datetime.fromisoformat(completion_date_str)
                if completion_date.date() == day.date():
                    day_count += 1
                    completed_this_month += 1
            except:
                continue
        
        daily_data.append({
            'date': day.date(),
            'completed': day_count
        })
    
    # Trend hesapla (son 15 gÃ¼n vs Ã¶nceki 15 gÃ¼n)
    recent_15 = sum([d['completed'] for d in daily_data[:15]])
    previous_15 = sum([d['completed'] for d in daily_data[15:]])
    trend = recent_15 - previous_15
    
    return {
        'completed_topics': completed_this_month,
        'trend': trend,
        'avg_per_week': completed_this_month / 4.3,  # 30 gÃ¼n / 7 â‰ˆ 4.3 hafta
        'daily_data': list(reversed(daily_data))  # Eski tarihten yeniye
    }

def create_progress_chart(daily_data):
    """Son 30 gÃ¼nÃ¼n ilerleme grafiÄŸini oluÅŸturur"""
    if not daily_data:
        return
    
    st.markdown("#### ğŸ“ˆ Son 30 GÃ¼nlÃ¼k Ä°lerleme Trendi")
    
    dates = [d['date'] for d in daily_data]
    completed = [d['completed'] for d in daily_data]
    
    fig = go.Figure()
    fig.add_trace(go.Scatter(
        x=dates,
        y=completed,
        mode='lines+markers',
        name='GÃ¼nlÃ¼k Tamamlanan Konu',
        line=dict(color='#1f77b4', width=2),
        marker=dict(size=6)
    ))
    
    # Ortalama Ã§izgisi
    avg_line = sum(completed) / len(completed) if completed else 0
    fig.add_hline(y=avg_line, line_dash="dash", line_color="red", 
                  annotation_text=f"30 gÃ¼nlÃ¼k ortalama: {avg_line:.1f}")
    
    fig.update_layout(
        title="ğŸ“Š GÃ¼nlÃ¼k Konu Tamamlama PerformansÄ±",
        xaxis_title="Tarih",
        yaxis_title="Tamamlanan Konu SayÄ±sÄ±",
        height=400,
        showlegend=True
    )
    
    safe_plotly_chart(fig, use_container_width=True)

def show_exam_based_trend_analysis(user_data):
    """Deneme bazlÄ± trend analizi - sÄ±nav performansÄ± odaklÄ±"""
    st.markdown("### ğŸ¯ DENEME BAZLI TREND ANALÄ°ZÄ°")
    st.caption("Deneme sonuÃ§larÄ±nÄ±za gÃ¶re gÃ¼Ã§lenen/zayÄ±flayan konularÄ±nÄ±z")
    
    # Deneme verileri
    exam_history = json.loads(user_data.get('detailed_exam_history', '[]') or '[]')
    
    if not exam_history:
        st.info("ğŸ“Š HenÃ¼z deneme analizi verisi yok. 'DetaylÄ± Deneme Analiz' sekmesinden deneme sonuÃ§larÄ±nÄ±zÄ± girin.")
        return
    
    # Son 3 deneme analizi
    recent_exams = exam_history[-3:] if len(exam_history) >= 3 else exam_history
    
    if len(recent_exams) >= 2:
        trend_analysis = analyze_exam_trends(recent_exams)
        
        col1, col2 = st.columns(2)
        
        with col1:
            st.markdown("#### ğŸ“ˆ GÃœÃ‡LENEN DERSLER")
            if trend_analysis['improving']:
                for subject, data in trend_analysis['improving'].items():
                    improvement = data['trend']
                    st.success(f"ğŸš€ **{subject}**: +{improvement:.1f} net artÄ±ÅŸ (son 3 deneme)")
            else:
                st.info("ğŸ“Š HenÃ¼z gÃ¼Ã§lenen ders tespit edilmedi")
        
        with col2:
            st.markdown("#### ğŸ“‰ ZAYIFLAYAN DERSLER")
            if trend_analysis['declining']:
                for subject, data in trend_analysis['declining'].items():
                    decline = abs(data['trend'])
                    st.error(f"âš ï¸ **{subject}**: -{decline:.1f} net dÃ¼ÅŸÃ¼ÅŸ (son 3 deneme)")
            else:
                st.success("âœ… HiÃ§bir derste dÃ¼ÅŸÃ¼ÅŸ yok!")
        
        # Genel trend skoru
        overall_trend = trend_analysis['overall_trend']
        trend_emoji = "ğŸ“ˆ" if overall_trend > 0 else "ğŸ“‰" if overall_trend < 0 else "â¡ï¸"
        st.metric("ğŸ¯ Genel Deneme Trendi", 
                 f"{trend_emoji} {overall_trend:+.1f} net deÄŸiÅŸim",
                 delta="Son 3 deneme ortalamasÄ±")
    else:
        st.warning("ğŸ“Š Trend analizi iÃ§in en az 2 deneme verisi gerekli")

def analyze_exam_trends(recent_exams):
    """Deneme trendlerini analiz eder"""
    if len(recent_exams) < 2:
        return {'improving': {}, 'declining': {}, 'overall_trend': 0}
    
    # Ders bazÄ±nda trend hesapla
    subject_trends = {}
    
    for i, exam in enumerate(recent_exams):
        subjects = exam.get('subjects', {})
        for subject, data in subjects.items():
            if subject not in subject_trends:
                subject_trends[subject] = []
            
            net_score = data.get('net', 0)
            subject_trends[subject].append(net_score)
    
    improving = {}
    declining = {}
    overall_changes = []
    
    for subject, scores in subject_trends.items():
        if len(scores) >= 2:
            # Lineer trend hesapla
            trend = (scores[-1] - scores[0]) / (len(scores) - 1)
            overall_changes.append(trend)
            
            if trend > 0.5:  # 0.5+ net artÄ±ÅŸ
                improving[subject] = {'trend': trend, 'scores': scores}
            elif trend < -0.5:  # 0.5+ net dÃ¼ÅŸÃ¼ÅŸ
                declining[subject] = {'trend': trend, 'scores': scores}
    
    overall_trend = sum(overall_changes) / len(overall_changes) if overall_changes else 0
    
    return {
        'improving': improving,
        'declining': declining,
        'overall_trend': overall_trend
    }

def show_yks_target_speed_analysis(user_data, projections, week_info):
    """YKS hedefine gÃ¶re hÄ±z analizi - hedefe ulaÅŸma projeksiyonu"""
    st.markdown("### ğŸš€ YKS HEDEF HIZ ANALÄ°ZÄ°")
    st.caption("Mevcut hÄ±zÄ±nÄ±zla hedef Ã¼niversiteye ulaÅŸabilir misiniz?")
    
    # Hedef bilgileri
    target_department = user_data.get('target_department', 'HenÃ¼z belirlenmedi')
    current_speed = calculate_current_completion_speed(user_data)
    days_left = week_info['days_to_yks']
    
    # Ä°lerleme verileri
    overall_progress = projections.get('overall_progress', 0)
    remaining_progress = 100 - overall_progress
    
    # HÄ±z analizi
    weeks_left = days_left / 7
    required_speed = remaining_progress / weeks_left if weeks_left > 0 else float('inf')
    
    col1, col2, col3 = st.columns(3)
    
    with col1:
        st.markdown("#### ğŸ¯ HEDEF BÄ°LGÄ°LERÄ°")
        st.info(f"**Hedef:** {target_department}")
        st.metric("â° Kalan SÃ¼re", f"{days_left} gÃ¼n", delta=f"{weeks_left:.1f} hafta")
        st.metric("ğŸ“Š Kalan Ä°lerleme", f"%{remaining_progress:.1f}", delta="Tamamlanacak")
        
    with col2:
        st.markdown("#### âš¡ MEVCUT HIZ")
        speed_status = evaluate_speed_status(current_speed, required_speed)
        st.metric("ğŸƒâ€â™‚ï¸ HaftalÄ±k HÄ±z", f"{current_speed:.1f} konu/hafta", 
                 delta="Son 4 hafta ortalamasÄ±")
        st.metric("ğŸ“ˆ HÄ±z Durumu", speed_status['status'], 
                 delta=speed_status['message'])
        
    with col3:
        st.markdown("#### ğŸ¯ GEREKLÄ° HIZ")
        st.metric("âš¡ Hedeflenen HÄ±z", f"{required_speed:.1f} konu/hafta", 
                 delta="Hedefe ulaÅŸmak iÃ§in")
        
        # Tavsiye
        if current_speed >= required_speed:
            st.success("âœ… HÄ±zÄ±nÄ±z yeterli! Devam edin!")
        elif current_speed >= required_speed * 0.8:
            st.warning("âš ï¸ Biraz daha hÄ±zlanmalÄ±sÄ±nÄ±z!")
        else:
            st.error("ğŸš¨ Ciddi hÄ±z artÄ±ÅŸÄ± gerekli!")
    
    # DetaylÄ± projeksiyon
    create_speed_projection_chart(current_speed, required_speed, weeks_left, overall_progress)

def calculate_current_completion_speed(user_data):
    """Mevcut konu tamamlama hÄ±zÄ±nÄ± hesaplar (konu/hafta)"""
    completion_dates = json.loads(user_data.get('topic_completion_dates', '{}') or '{}')
    current_date = datetime.now()
    
    # Son 4 hafta
    four_weeks_ago = current_date - timedelta(weeks=4)
    completed_last_4_weeks = 0
    
    for completion_date_str in completion_dates.values():
        try:
            completion_date = datetime.fromisoformat(completion_date_str)
            if completion_date >= four_weeks_ago:
                completed_last_4_weeks += 1
        except:
            continue
    
    return completed_last_4_weeks / 4  # konu/hafta

def evaluate_speed_status(current_speed, required_speed):
    """HÄ±z durumunu deÄŸerlendirir"""
    if current_speed >= required_speed:
        return {'status': 'MÃ¼kemmel', 'message': 'Hedefe ulaÅŸacaksÄ±nÄ±z!'}
    elif current_speed >= required_speed * 0.8:
        return {'status': 'Ä°yi', 'message': 'Biraz daha hÄ±zlanÄ±n'}
    elif current_speed >= required_speed * 0.6:
        return {'status': 'Orta', 'message': 'HÄ±z artÄ±ÅŸÄ± gerekli'}
    else:
        return {'status': 'Kritik', 'message': 'Ciddi revizyona ihtiyaÃ§ var'}

def create_speed_projection_chart(current_speed, required_speed, weeks_left, current_progress):
    """HÄ±z projeksiyonu grafiÄŸi oluÅŸturur"""
    st.markdown("#### ğŸ“ˆ Ä°lerleme Projeksiyonu")
    
    weeks = list(range(0, int(weeks_left) + 1))
    
    # Mevcut hÄ±zla projeksiyon
    current_projection = [current_progress + (current_speed * w * 100 / 50) for w in weeks]  # 50 konu = %100 varsayÄ±mÄ±
    
    # Gerekli hÄ±zla projeksiyon  
    required_projection = [current_progress + (required_speed * w * 100 / 50) for w in weeks]
    
    fig = go.Figure()
    
    # Mevcut hÄ±z Ã§izgisi
    fig.add_trace(go.Scatter(
        x=weeks, y=current_projection,
        mode='lines+markers',
        name=f'Mevcut HÄ±z ({current_speed:.1f} konu/hafta)',
        line=dict(color='blue', width=2)
    ))
    
    # Gerekli hÄ±z Ã§izgisi
    fig.add_trace(go.Scatter(
        x=weeks, y=required_projection,
        mode='lines+markers',
        name=f'Gerekli HÄ±z ({required_speed:.1f} konu/hafta)',
        line=dict(color='red', width=2, dash='dash')
    ))
    
    # %100 hedef Ã§izgisi
    fig.add_hline(y=100, line_dash="dot", line_color="green", 
                  annotation_text="ğŸ¯ Hedef: %100 tamamlanma")
    
    fig.update_layout(
        title="ğŸš€ YKS'ye Kalan SÃ¼rede Ä°lerleme Projeksiyonu",
        xaxis_title="Hafta",
        yaxis_title="Ä°lerleme (%)",
        height=400,
        yaxis=dict(range=[0, 120])
    )
    
    safe_plotly_chart(fig, use_container_width=True)

def show_interactive_systematic_planner(weekly_plan, survey_data, user_data=None):
    """Basit ve etkili haftalÄ±k planlayÄ±cÄ± - DÄ°NAMÄ°K TARÄ°H SÄ°STEMÄ°"""
    
    # GÃ¼ncel hafta bilgilerini al (sÃ¼rekli gÃ¼ncellenen)
    week_info = get_current_week_info()
    week_range = week_info['week_range']
    
    # HaftalÄ±k planlama tablosu
    st.markdown(f"#### ğŸ“… Bu HaftanÄ±n ProgramÄ± ({week_range})")
    
    # GÃ¼nler
    days = ["PAZARTESÄ°", "SALI", "Ã‡ARÅAMBA", "PERÅEMBE", "CUMA", "CUMARTESÄ°", "PAZAR"]
    rest_day_full = survey_data.get('rest_day', 'Pazar (Tam GÃ¼n)')
    
    # Rest day'i parse et (Ã¶rn: "Pazar (Tam GÃ¼n)" -> "Pazar" ve "Tam GÃ¼n")
    if '(' in rest_day_full:
        rest_day = rest_day_full.split('(')[0].strip()
        rest_type = 'Tam GÃ¼n' if 'Tam GÃ¼n' in rest_day_full else 'YarÄ±m GÃ¼n'
    else:
        rest_day = rest_day_full
        rest_type = 'Tam GÃ¼n'
    
    # Session state'te planlarÄ± tut
    if 'day_plans' not in st.session_state:
        st.session_state.day_plans = {day: [] for day in days}
    
    # GÃ¼nleri gÃ¶ster
    cols = st.columns(7)
    
    for i, day in enumerate(days):
        with cols[i]:
            # GÃ¼n baÅŸlÄ±ÄŸÄ±
            if day.title() == rest_day:
                st.markdown(f"**{day}** ğŸŒ´")
                if rest_type == 'Tam GÃ¼n':
                    st.info("ğŸŒ´ Tam Dinlenme GÃ¼nÃ¼")
                else:
                    st.warning("âš¡ YarÄ±m GÃ¼n Dinlenme")
            else:
                st.markdown(f"**{day}**")
                
                # Bu gÃ¼nde planlanmÄ±ÅŸ konularÄ± gÃ¶ster
                day_plan = st.session_state.day_plans.get(day, [])
                if day_plan:
                    for j, plan_item in enumerate(day_plan):
                        with st.container():
                            priority = plan_item.get('priority', 'NORMAL')
                            priority_info = PRIORITY_CATEGORIES.get(priority, PRIORITY_CATEGORIES['NORMAL'])
                            
                            st.markdown(f"<div style='background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); padding: 8px; border-radius: 5px; margin-bottom: 5px; color: white; font-size: 12px;'>"
                                      f"<strong>{priority_info['icon']} {plan_item['subject']}</strong><br>"
                                      f"{plan_item['topic']}<br>"
                                      f"<small>ğŸ•°ï¸ {plan_item['time']}</small>"
                                      f"</div>", unsafe_allow_html=True)
                            
                            # KaldÄ±rma butonu - Benzersiz key ile
                            date_key = datetime.now().date().isoformat().replace('-', '')
                            if st.button(f"âŒ", key=f"remove_{day}_{j}_{date_key}", help="Bu konuyu kaldÄ±r"):
                                st.session_state.day_plans[day].pop(j)
                                st.rerun()
                
                # BoÅŸ alan gÃ¶stergesi
                if not day_plan:
                    st.markdown("<div style='border: 2px dashed #e0e0e0; padding: 20px; text-align: center; color: #999; border-radius: 5px;'>Konu yok</div>", unsafe_allow_html=True)
    
    st.markdown("---")
    
    # HaftalÄ±k planÄ± yenile butonu ve debug bÃ¶lÃ¼mÃ¼
    col1, col2, col3 = st.columns([1, 2, 1])
    with col2:
        if st.button("ğŸ”„ HaftalÄ±k PlanÄ± Yenile", use_container_width=True, type="secondary"):
            # Cache'i temizle
            if 'weekly_plan_cache' in st.session_state:
                del st.session_state.weekly_plan_cache
            st.success("HaftalÄ±k plan yenilendi! Debug Ã§Ä±ktÄ±sÄ±nÄ± konsola bakarak kontrol edin.")
            st.rerun()
    
    # KonularÄ± gÃ¶ster ve ekleme sistemi
    st.markdown("#### ğŸ“‹ Bu HaftanÄ±n KonularÄ±")
    
    # TÃ¼m konularÄ± birleÅŸtir
    all_topics = weekly_plan.get('new_topics', []) + weekly_plan.get('review_topics', [])
    
    if all_topics:
        # KonularÄ± kutu olarak gÃ¶ster
        topic_cols = st.columns(3)  # 3'lÃ¼ gruplar halinde
        
        for i, topic in enumerate(all_topics):
            with topic_cols[i % 3]:
                # Konu kutusu
                with st.container():
                    priority = topic.get('priority', 'NORMAL')
                    priority_info = PRIORITY_CATEGORIES.get(priority, PRIORITY_CATEGORIES['NORMAL'])
                    
                    st.markdown(f"<div style='background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 8px; margin-bottom: 5px; color: white;'>"
                              f"<strong>ğŸ“š {topic['subject']}</strong><br>"
                              f"{topic['topic']}<br>"
                              f"<small>{topic.get('detail', '')}</small><br>"
                              f"<small>ğŸ¯ {topic.get('net', 0)} net</small>"
                              f"</div>", unsafe_allow_html=True)
                    
                    # Ã–ncelik bilgisi kutunun altÄ±nda
                    st.markdown(f"<div style='text-align: center; color: {priority_info['color']}; font-weight: bold; font-size: 12px; margin-bottom: 10px;'>"
                              f"{priority_info['icon']} {priority_info['name']}"
                              f"</div>", unsafe_allow_html=True)
                    
                    # Ekleme formu - sadeleÅŸtirilmiÅŸ
                    with st.expander(f"ğŸ“… Programa Ekle", expanded=False):
                        date_key = datetime.now().date().isoformat().replace('-', '')
                        selected_day = st.selectbox(
                            "GÃ¼n seÃ§in:", 
                            [d for d in days if d.title() != rest_day],
                            key=f"day_select_{i}_{date_key}"
                        )
                        
                        time_slot = st.text_input(
                            "Saat aralÄ±ÄŸÄ±:",
                            placeholder="17:00-18:30",
                            key=f"time_input_{i}_{date_key}"
                        )
                        
                        if st.button("â• Ekle", key=f"add_topic_{i}_{date_key}", type="primary"):
                            if time_slot:
                                # Konuyu programa ekle
                                new_plan_item = {
                                    'subject': topic['subject'],
                                    'topic': topic['topic'],
                                    'detail': topic.get('detail', ''),
                                    'time': time_slot,
                                    'priority': topic.get('priority', 'NORMAL')
                                }
                                
                                if selected_day not in st.session_state.day_plans:
                                    st.session_state.day_plans[selected_day] = []
                                
                                st.session_state.day_plans[selected_day].append(new_plan_item)
                                st.success(f"âœ… {topic['topic']} eklendi!")
                                st.rerun()
                            else:
                                st.warning("ğŸ•°ï¸ Saat aralÄ±ÄŸÄ± gerekli!")
    
    else:
        st.info("ğŸ“Š Bu hafta iÃ§in otomatik konu bulunamadÄ±. Konu Takip sekmesinden konularÄ±nÄ±zÄ± deÄŸerlendirin.")
    
    # KoÃ§ onay durumu gÃ¶ster (inline)
    try:
        approval_status = user_data.get('coach_approval_status', 'none')
        
        if approval_status == 'pending':
            st.markdown("""
            <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); 
                        padding: 20px; border-radius: 15px; margin: 20px 0; color: white; text-align: center;">
                <h3 style="margin: 0; color: white;">â³ KoÃ§ OnayÄ± Bekleniyor</h3>
                <p style="margin: 10px 0 0 0; opacity: 0.9;">ProgramÄ±nÄ±z koÃ§unuza gÃ¶nderildi, onay bekleniyor...</p>
            </div>
            """, unsafe_allow_html=True)
            
            last_submission = user_data.get('last_submission_date', 'Bilinmiyor')
            st.info(f"ğŸ“… Son gÃ¶nderim: {last_submission}")
            
        elif approval_status == 'approved':
            st.markdown("""
            <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); 
                        padding: 20px; border-radius: 15px; margin: 20px 0; color: white; text-align: center;">
                <h3 style="margin: 0; color: white;">âœ… KoÃ§unuz TarafÄ±ndan OnaylandÄ±</h3>
                <p style="margin: 10px 0 0 0; opacity: 0.9;">ProgramÄ±nÄ±z koÃ§unuz tarafÄ±ndan onaylandÄ±!</p>
            </div>
            """, unsafe_allow_html=True)
            
            approved_date = user_data.get('approval_date', 'Bilinmiyor')
            st.success(f"ğŸ‰ Onay tarihi: {approved_date}")
            
        elif approval_status == 'rejected':
            st.markdown("""
            <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); 
                        padding: 20px; border-radius: 15px; margin: 20px 0; color: white; text-align: center;">
                <h3 style="margin: 0; color: white;">âš ï¸ ProgramÄ±nÄ±z Revize Edildi</h3>
                <p style="margin: 10px 0 0 0; opacity: 0.9;">KoÃ§unuz programÄ±nÄ±zda deÄŸiÅŸiklik yaptÄ±, lÃ¼tfen gÃ¶zden geÃ§irin.</p>
            </div>
            """, unsafe_allow_html=True)
            
            coach_notes = user_data.get('coach_notes', 'KoÃ§ notu bulunamadÄ±')
            st.warning(f"ğŸ“ KoÃ§ notu: {coach_notes}")
        
        # ğŸ”¥ GÃœÃ‡LENDÄ°RÄ°LMÄ°Å: Onay durumu ve haftalÄ±k hedef yenileme
        col1, col2 = st.columns(2)
        
        with col1:
            if st.button("ğŸ”„ Onay Durumunu Yenile", type="secondary"):
                # Cache'i temizle ve yeniden yÃ¼kle
                if 'users_db' in st.session_state and current_user in st.session_state.users_db:
                    # KullanÄ±cÄ±nÄ±n verilerini Firebase'den yeniden Ã§ek
                    if firebase_connected and db_ref:
                        try:
                            fresh_user_data = db_ref.child('users').child(current_user).get()
                            if fresh_user_data:
                                st.session_state.users_db[current_user].update(fresh_user_data)
                                st.success("âœ… Onay durumu gÃ¼ncellendi!")
                        except Exception as e:
                            st.error(f"Yenileme hatasÄ±: {e}")
                
                # Firebase cache'i de temizle
                if hasattr(st.session_state, 'firebase_cache'):
                    st.session_state.firebase_cache.clear()
                
                st.info("ğŸ“± Sayfa yenileniyor...")
                st.rerun()
        
        with col2:
            if st.button("ğŸ†• HaftalÄ±k Hedefleri Yenile", type="primary"):
                # HaftalÄ±k hedef konular iÃ§in Ã¶zel yenileme
                if 'users_db' in st.session_state and current_user in st.session_state.users_db:
                    # TÃ¼m onaylÄ± konularÄ± yeniden Ã§ek
                    if firebase_connected and db_ref:
                        try:
                            # KullanÄ±cÄ±nÄ±n tÃ¼m onaylÄ± konularÄ±nÄ± Ã§ek
                            approvals_data = db_ref.child('coach_approvals').get()
                            user_approved_topics = []
                            
                            if approvals_data:
                                for approval_key, approval_data in approvals_data.items():
                                    student_username = approval_data.get('student_username', '')
                                    student_name = approval_data.get('student_name', '')
                                    
                                    if (student_username == current_user or 
                                        student_name == st.session_state.users_db[current_user].get('name', current_user)):
                                        
                                        if approval_data.get('status') == 'approved' and 'approved_topics' in approval_data:
                                            user_approved_topics.extend(approval_data['approved_topics'])
                            
                            # OnaylÄ± konularÄ± kullanÄ±cÄ± verilerine ekle
                            st.session_state.users_db[current_user]['approved_topics'] = user_approved_topics
                            st.session_state.users_db[current_user]['coach_approval_status'] = 'approved'
                            
                            st.success(f"âœ… {len(user_approved_topics)} adet koÃ§ onaylÄ± konu yÃ¼klendi!")
                            st.rerun()
                        except Exception as e:
                            st.error(f"HaftalÄ±k hedef yenileme hatasÄ±: {e}")
                
                st.info("ğŸ”„ HaftalÄ±k hedefler yenileniyor...")
                st.rerun()
    except Exception as e:
        # Hata durumunda sessizce geÃ§
        pass
    
    # Program koÃ§a gÃ¶nderme butonu
    if all_topics:  # Sadece konu varsa gÃ¶ster
        st.markdown("---")
        st.markdown("### ğŸ“¤ ProgramÄ±mÄ± KoÃ§uma Onaya GÃ¶nder")
        
        col1, col2, col3 = st.columns([1, 2, 1])
        with col2:
            # Onay durumunu kontrol et
            approval_status = user_data.get('coach_approval_status', 'none')
            
            if approval_status == 'pending':
                st.warning("â³ ProgramÄ±nÄ±z zaten koÃ§unuza gÃ¶nderilmiÅŸ, onay bekleniyor...")
            elif approval_status == 'approved':
                st.success("âœ… ProgramÄ±nÄ±z koÃ§unuz tarafÄ±ndan onaylandÄ±!")
            elif approval_status == 'rejected':
                st.error("âŒ ProgramÄ±nÄ±z reddedildi. LÃ¼tfen koÃ§ notlarÄ±nÄ± gÃ¶zden geÃ§irin.")
            else:
                if st.button("ğŸ“¤ ProgramÄ±mÄ± KoÃ§uma Onaya GÃ¶nder", use_container_width=True, type="primary"):
                    if send_to_coach_approval(user_data, weekly_plan):
                        st.rerun()
    
    st.markdown("---")
    st.markdown("#### ğŸ“Š Bu HaftanÄ±n ProgramÄ±")
    
    total_planned = sum(len(plans) for plans in st.session_state.day_plans.values())
    
    if total_planned > 0:
        col1, col2 = st.columns(2)
        with col1:
            st.metric("ğŸ“… PlanlanmÄ±ÅŸ Konu", total_planned)
        with col2:
            active_days = len([day for day, plans in st.session_state.day_plans.items() if plans])
            st.metric("ğŸ“† Aktif GÃ¼n", active_days)
        
        # Temizleme butonlarÄ±
        col1, col2 = st.columns(2)
        with col1:
            if st.button("ğŸ—‘ï¸ ProgramÄ± Temizle", type="secondary"):
                st.session_state.day_plans = {day: [] for day in days}
                st.success("âœ… Program temizlendi!")
                st.rerun()
        with col2:
            if st.button("ğŸ”„ HaftalÄ±k PlanÄ± Yenile", type="secondary", help="Cache'i temizleyip planÄ± yeniden oluÅŸturur"):
                # TÃ¼m cache'leri temizle
                cache_keys = [key for key in st.session_state.keys() if 'cache' in key.lower() or 'plan' in key.lower()]
                for key in cache_keys:
                    if key in st.session_state:
                        del st.session_state[key]
                st.success("âœ… HaftalÄ±k plan yenilendi!")
                st.rerun()
    else:
        st.info("ğŸ“… HenÃ¼z konu planlanmamÄ±ÅŸ. YukarÄ±daki konulardan seÃ§ip gÃ¼nlere ekleyin.")
    
    st.markdown("---")
    
    # TYT/AYT durumu bilgilendirmesi
    if 'tyt_progress' in weekly_plan and 'ayt_enabled' in weekly_plan:
        tyt_progress = weekly_plan.get('tyt_progress', 0)
        ayt_enabled = weekly_plan.get('ayt_enabled', False)
        tyt_math_completed = weekly_plan.get('tyt_math_completed', 0)
        
        st.markdown("#### ğŸ“‹ Ã–ÄŸrenim Durumu")
        
        if not ayt_enabled:
            st.info(f"""
            ğŸ¯ **TYT AÅŸamasÄ±** - AYT henÃ¼z baÅŸlamadÄ±
            
            â€¢ TYT Ä°lerleme: **%{tyt_progress:.1f}** (Hedef: %60)
            â€¢ TYT Matematik: **{tyt_math_completed}** konu tamamlandÄ± (Hedef: 12)
            
            ğŸ”’ **AYT BaÅŸlatma KoÅŸullarÄ±:** TYT %60 + TYT Matematik 12 konu tamamlanÄ±nca AYT konularÄ± eklenecek.
            """)
        else:
            st.success(f"""
            âœ… **TYT + AYT AÅŸamasÄ±** - TÃ¼m konular aktif!
            
            â€¢ TYT: **%{tyt_progress:.1f}** tamamlandÄ±
            â€¢ TYT Matematik: **{tyt_math_completed}** konu tamamlandÄ±
            
            ğŸ¯ ArtÄ±k hem TYT hem AYT konularÄ± haftalÄ±k programÄ±nÄ±zda gÃ¶rÃ¼nÃ¼yor.
            """)
    
    # Program Ã¶zeti kaldÄ±rÄ±ldÄ± - tekrar olmamasÄ± iÃ§in

def show_weekly_summary(weekly_plan):
    """HaftalÄ±k program Ã¶zeti"""
    st.markdown("---")
    st.markdown("#### ğŸ“Š HaftalÄ±k Program Ã–zeti")
    
    new_topics_count = len(weekly_plan.get('new_topics', []))
    review_topics_count = len(weekly_plan.get('review_topics', []))
    total_topics = new_topics_count + review_topics_count
    success_target = weekly_plan.get('success_target', 0.8)
    
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        st.metric("ğŸ¯ Yeni Konular", new_topics_count)
    
    with col2:
        st.metric("ğŸ”„ Tekrar KonularÄ±", review_topics_count)
    
    with col3:
        st.metric("ğŸ“… Toplam Hedef", total_topics)
    
    with col4:
        target_completion = int(total_topics * success_target)
        st.metric("ğŸ† BaÅŸarÄ± Hedefi", f"{target_completion}/{total_topics}")
    
    if total_topics > 0:
        st.info(f"ğŸ’¡ **Bu Hafta Hedefiniz:** {total_topics} konunun %{success_target*100:.0f}'ini (%{target_completion} konu) iyi seviyeye Ã§Ä±karmak!")
        
        # Ä°lerleme simÃ¼lasyonu
        if st.button("ğŸ—‘ï¸ HaftalÄ±k PlanÄ± Temizle", type="secondary"):
            st.session_state.systematic_day_plans = {day: [] for day in ["PAZARTESÄ°", "SALI", "Ã‡ARÅAMBA", "PERÅEMBE", "CUMA", "CUMARTESÄ°", "PAZAR"]}
            st.success("âœ… HaftalÄ±k plan temizlendi!")
            st.rerun()

def show_yks_journey_cinema(user_data, progress_data):
    """ğŸ¬ Filmi BaÅŸlatâ€“ Ä°lk GÃ¼nden BugÃ¼ne YKS YolculuÄŸum - Sinematik Deneyim"""
    
    # KRÄ°TÄ°K: KullanÄ±cÄ± kimlik kontrolÃ¼
    if not user_data:
        st.error("âŒ KullanÄ±cÄ± verisi bulunamadÄ±!")
        return
    
    # GÃœVENLÄ°K KONTROLÃœ: DoÄŸru kullanÄ±cÄ±nÄ±n verilerini kullandÄ±ÄŸÄ±mÄ±zdan emin ol
    current_username = st.session_state.get('current_user', None)
    if not current_username:
        st.error("âŒ Aktif kullanÄ±cÄ± bulunamadÄ±! LÃ¼tfen yeniden giriÅŸ yapÄ±n.")
        return
    
    # KullanÄ±cÄ± kimlik doÄŸrulama
    expected_username = user_data.get('username', '')
    if current_username != expected_username:
        st.error(f"âŒ Veri uyumsuzluÄŸu tespit edildi! Session: {current_username}, Data: {expected_username}")
        st.error("ğŸ”’ GÃ¼venlik iÃ§in sayfa yenileniyor...")
        st.rerun()
        return
    
    # DEBUG: KullanÄ±cÄ± bilgilerini gÃ¶ster (geliÅŸtirme aÅŸamasÄ±nda)
    if st.session_state.get('debug_mode', False):
        st.info(f"ğŸ” Debug: KullanÄ±cÄ± {current_username} iÃ§in veriler yÃ¼kleniyor...")
        st.info(f"ğŸ“… KayÄ±t tarihi: {user_data.get('created_at', 'Bilinmiyor')}")
        st.info(f"ğŸ‘¤ Ä°sim: {user_data.get('name', 'Bilinmiyor')}")
    
    # Session state'leri baÅŸlat
    if 'cinema_active' not in st.session_state:
        st.session_state.cinema_active = False
    if 'current_day_index' not in st.session_state:
        st.session_state.current_day_index = 0
    if 'auto_play_mode' not in st.session_state:
        st.session_state.auto_play_mode = True
    if 'music_enabled' not in st.session_state:
        st.session_state.music_enabled = True
    if 'last_day_change' not in st.session_state:
        st.session_state.last_day_change = 0
    
    # Ã–ÄŸrenci adÄ±nÄ± al
    student_name = user_data.get('name', 'Ã–ÄŸrenci')
    
    # BaÅŸlangÄ±Ã§ tarihini hesapla - KULLANICI KAYIT TARÄ°HÄ°NE GÃ–RE
    start_date = None
    
    try:
        # Ã–nce created_at (ISO format) kontrol et
        if 'created_at' in user_data and user_data['created_at']:
            if isinstance(user_data['created_at'], str):
                # ISO format: 2024-10-12T14:30:00.123456
                start_date = datetime.fromisoformat(user_data['created_at'].replace('Z', '+00:00')).replace(tzinfo=None)
            else:
                start_date = user_data['created_at']
        
        # EÄŸer created_at yoksa created_date kontrol et (eski format)
        elif 'created_date' in user_data and user_data['created_date']:
            start_date = datetime.strptime(user_data['created_date'], '%Y-%m-%d')
        
        # HiÃ§biri yoksa varsayÄ±lan
        else:
            start_date = datetime.now() - timedelta(days=1)
            
    except Exception as e:
        # Hata durumunda gÃ¼venli varsayÄ±lan
        start_date = datetime.now() - timedelta(days=1)
        if st.session_state.get('debug_mode', False):
            st.error(f"âš ï¸ Tarih ayrÄ±ÅŸtÄ±rma hatasÄ±: {e}")
    
    # Debug modunda tarih bilgilerini gÃ¶ster
    if st.session_state.get('debug_mode', False):
        st.info(f"ğŸ“… Hesaplanan baÅŸlangÄ±Ã§ tarihi: {start_date.strftime('%Y-%m-%d %H:%M')}")
        st.info(f"ğŸ” created_at: {user_data.get('created_at', 'Yok')}")
        st.info(f"ğŸ” created_date: {user_data.get('created_date', 'Yok')}")
    
    current_date = datetime.now()
    days_passed = (current_date - start_date).days + 1
    
    # GÃ¼nlÃ¼k verileri topla
    def collect_daily_data():
        journey_days = []
        
        try:
            daily_motivation = json.loads(user_data.get('daily_motivation', '{}'))
            pomodoro_history = json.loads(user_data.get('pomodoro_history', '[]'))
            topic_progress = json.loads(user_data.get('topic_progress', '{}'))
            exam_data = json.loads(user_data.get('exam_data', '{}'))
            weekly_plan = json.loads(user_data.get('weekly_plan', '{}'))
        except:
            daily_motivation = {}
            pomodoro_history = []
            topic_progress = {}
            exam_data = {}
            weekly_plan = {}
        
        for i in range(min(days_passed, 30)):  # Son 30 gÃ¼n
            day_date = start_date + timedelta(days=i)
            date_str = day_date.strftime('%Y-%m-%d')
            
            # GÃ¼nlÃ¼k veri yapÄ±sÄ±
            day_data = {
                'date': day_date,
                'day_number': i + 1,
                'motivation_score': 5,
                'daily_note': '',
                'photo_data': None,
                'photo_caption': '',
                'questions_solved': {},
                'total_questions': 0,
                'completed_topics': [],
                'review_topics': [],
                'exam_taken': False,
                'exam_scores': {},
                'tyt_progress': 0,
                'ayt_progress': 0,
                'daily_achievement': ''
            }
            
            # GÃ¼nlÃ¼k motivasyon verilerini al
            if date_str in daily_motivation:
                day_motivation = daily_motivation[date_str]
                day_data['motivation_score'] = day_motivation.get('score', 5)
                day_data['daily_note'] = day_motivation.get('note', '')
                
                # FotoÄŸraf verilerini doÄŸru ÅŸekilde al
                photo_info = day_motivation.get('photo_data', None)
                if photo_info and isinstance(photo_info, dict) and 'data' in photo_info:
                    # Base64 datasÄ±nÄ± data URI formatÄ±na Ã§evir
                    photo_type = photo_info.get('type', 'image/jpeg')
                    day_data['photo_data'] = f"data:{photo_type};base64,{photo_info['data']}"
                    day_data['photo_filename'] = photo_info.get('filename', 'FotoÄŸraf')
                else:
                    day_data['photo_data'] = None
                    day_data['photo_filename'] = ''
                
                day_data['photo_caption'] = day_motivation.get('photo_caption', '')
                
                # Soru takibi verilerini al
                questions_data = day_motivation.get('questions', {})
                day_data['questions_solved'] = questions_data
                day_data['total_questions'] = sum([int(v) for v in questions_data.values() if str(v).isdigit()])
            
            # Pomodoro verilerinden Ã§alÄ±ÅŸma verilerini al
            day_pomodoros = [p for p in pomodoro_history 
                           if p.get('date', '').startswith(date_str) or 
                           (p.get('timestamp', '') and p['timestamp'].startswith(date_str))]
            
            # Ã‡alÄ±ÅŸÄ±lan konularÄ± topla
            subjects_studied = set()
            topics_completed = set()
            
            for pomodoro in day_pomodoros:
                if 'subject' in pomodoro and pomodoro['subject']:
                    subjects_studied.add(pomodoro['subject'])
                if 'topic' in pomodoro and pomodoro['topic']:
                    topics_completed.add(pomodoro['topic'])
            
            day_data['completed_topics'] = list(topics_completed)[:3]
            
            # Deneme verileri kontrol et
            if date_str in exam_data:
                day_data['exam_taken'] = True
                day_data['exam_scores'] = exam_data[date_str]
            
            # TYT-AYT ilerleme hesapla (simulated)
            day_data['tyt_progress'] = min(i * 2, 100)
            day_data['ayt_progress'] = min(i * 1.5, 100)
            
            # GÃ¼nlÃ¼k baÅŸarÄ± mesajÄ± oluÅŸtur
            if day_data['total_questions'] > 20:
                day_data['daily_achievement'] = f"ğŸ”¥ {day_data['total_questions']} soru Ã§Ã¶zdÃ¼n!"
            elif len(day_data['completed_topics']) > 2:
                day_data['daily_achievement'] = f"ğŸ“š {len(day_data['completed_topics'])} konu tamamladÄ±n!"
            elif day_data['motivation_score'] >= 8:
                day_data['daily_achievement'] = "â­ SÃ¼per motivasyonla Ã§alÄ±ÅŸtÄ±n!"
            else:
                day_data['daily_achievement'] = "ğŸ’ª YKS yolunda bir adÄ±m daha!"
            
            journey_days.append(day_data)
        
        return journey_days
    
    # Sinematik baÅŸlÄ±k
    cinema_title = f"""
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
    <div style="
        background: linear-gradient(135deg, #000 0%, #1a1a2e 50%, #16213e 100%);
        border: 8px solid #ffd700;
        border-radius: 20px;
        padding: 40px;
        margin: 20px 0;
        text-align: center;
        position: relative;
        box-shadow: 0 10px 30px rgba(255, 215, 0, 0.3);
    ">
        <!-- Film Ã§erÃ§evesi -->
        <div style="
            position: absolute;
            top: -4px; left: -4px; right: -4px; bottom: -4px;
            background: repeating-linear-gradient(
                90deg,
                #ffd700 0px, #ffd700 10px,
                transparent 10px, transparent 20px
            );
            border-radius: 24px;
            z-index: -1;
        "></div>
        
        <h1 style="
            color: #ffd700;
            font-family: 'Cinzel', serif;
            font-size: clamp(2rem, 6vw, 4rem);
            font-weight: 700;
            margin: 0 0 20px 0;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.8);
            letter-spacing: 2px;
        ğŸ¬ {student_name}'nin YKS SerÃ¼veni</h1>
        
        <p style="
            color: #ffffff;
            font-family: 'Playfair Display', serif;
            font-size: clamp(1.2rem, 3vw, 2rem);
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            font-style: italic;
        Ä°lk GÃ¼nden BugÃ¼ne BaÅŸarÄ± YolculuÄŸu</p>
        
        <div style="
            margin-top: 30px;
            color: #ffd700;
            font-size: clamp(1rem, 2.5vw, 1.5rem);
            font-family: 'Playfair Display', serif;
        ">
            ğŸ­ Sinematik Deneyim HazÄ±r
        </div>
    </div>
    """
    
    st.components.v1.html(cinema_title, height=250)
    
    # GÃ¼nlÃ¼k verileri topla
    journey_data = collect_daily_data()
    total_days = len(journey_data)
    
    if not st.session_state.cinema_active:
        # BaÅŸlatma ekranÄ±
        col1, col2, col3 = st.columns([1, 2, 1])
        with col2:
            st.markdown("### ğŸ¬ Sinema Kontrolleri")
            
            # MÃ¼zik seÃ§eneÄŸi
            music_choice = st.radio(
                "ğŸµ Arka Plan MÃ¼ziÄŸi:",
                ["ğŸ¶ MÃ¼zikli Ä°zle", "ğŸ”‡ Sessiz Ä°zle"],
                index=0 if st.session_state.music_enabled else 1
            )
            st.session_state.music_enabled = (music_choice == "ğŸ¶ MÃ¼zikli Ä°zle")
            
            # Oynatma hÄ±zÄ±
            speed_choice = st.radio(
                "âš¡ Ä°zleme HÄ±zÄ±:",
                ["ğŸŒ YavaÅŸ (6sn/gÃ¼n)", "âš¡ Normal (4sn/gÃ¼n)", "ğŸš€ HÄ±zlÄ± (2sn/gÃ¼n)"],
                index=1
            )
            
            if speed_choice == "ğŸŒ YavaÅŸ (6sn/gÃ¼n)":
                st.session_state.day_duration = 6
            elif speed_choice == "ğŸš€ HÄ±zlÄ± (2sn/gÃ¼n)":
                st.session_state.day_duration = 2
            else:
                st.session_state.day_duration = 4
            
            # Sinematik deneyim bilgisi
            st.info("ğŸ¥ **Pro Ä°pucu:** 'ğŸ–¼ï¸ Tam Ekran' butonuna tÄ±klayÄ±n! âœ… KÃ¶klÃ¼ Ã§Ã¶zÃ¼m - %100 Ã§alÄ±ÅŸÄ±r! FotoÄŸraflar artÄ±k tam boyutta gÃ¶rÃ¼nÃ¼r!")
            
            st.markdown("---")
            
            # BaÅŸlat butonu
            if st.button(f"ğŸ¬ {student_name}'nin Hikayesini BaÅŸlat!", 
                        type="primary", 
                        use_container_width=True):
                st.session_state.cinema_active = True
                st.session_state.current_day_index = 0
                st.session_state.last_day_change = time.time()
                st.rerun()
        
        # Ã–nizleme bilgileri
        if journey_data:
            st.markdown("### ğŸ“Š Yolculuk Ã–zeti")
            col1, col2, col3, col4 = st.columns(4)
            
            with col1:
                st.metric("ğŸ“… Toplam GÃ¼n", total_days)
            with col2:
                total_questions = sum(day['total_questions'] for day in journey_data)
                st.metric("â“ Toplam Soru", total_questions)
            with col3:
                avg_motivation = sum(day['motivation_score'] for day in journey_data) / max(total_days, 1)
                st.metric("â­ Ort. Motivasyon", f"{avg_motivation:.1f}/10")
            with col4:
                total_topics = sum(len(day['completed_topics']) for day in journey_data)
                st.metric("ğŸ“š Toplam Konu", total_topics)
    
    else:
        # Sinema modunda
        # MÃ¼zik ekleme (YouTube embed)
        # MÃ¼zik kontrolÃ¼ iÃ§in session state
        if 'music_playing' not in st.session_state:
            st.session_state.music_playing = True
            
        if st.session_state.music_enabled and st.session_state.music_playing:
            st.info("ğŸµ Sinematik mÃ¼zik Ã§alÄ±yor! Oynat/Duraklat butonlarÄ± ile kontrol edin.")
            music_html = """
            <div style="position: fixed; top: -200px; left: -200px; opacity: 0.01; pointer-events: none; z-index: -1000;">
                <iframe width="100" height="100" 
                        src="https://www.youtube.com/embed/V9FW37WkIf0?autoplay=1&loop=1&playlist=V9FW37WkIf0&controls=0&mute=0&start=0" 
                        frameborder="0" 
                        allow="autoplay; encrypted-media" 
                        allowfullscreen>
                </iframe>
            </div>
            <style>
                body { 
                    background: linear-gradient(135deg, #000 0%, #1a1a2e 100%);
                    animation: cinema-ambiance 10s ease-in-out infinite alternate;
                }
                @keyframes cinema-ambiance {
                    0% { filter: brightness(0.8); }
                    100% { filter: brightness(1.0); }
                }
            </style>
            """
            st.components.v1.html(music_html, height=0)
        elif st.session_state.music_enabled and not st.session_state.music_playing:
            st.warning("ğŸ”‡ MÃ¼zik duraklatÄ±ldÄ±. â–¶ï¸ Oynat butonu ile devam ettirin.")
        
        # ğŸ­ SINEMA PERDESÄ° ANÄ°MASYONU - KIRMIZI KADIFE PERDE! ğŸ­
        curtain_html = """
        <style>
        body {
            overflow: hidden !important;
        }
        
        .cinema-stage {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: radial-gradient(circle at center, #1a0000 0%, #000000 100%);
            z-index: 999999;
            overflow: hidden;
            box-shadow: inset 0 0 100px rgba(139, 0, 0, 0.3);
        }
        
        .curtain-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center, #2d1b1b 0%, #1a0a0a 50%, #000000 100%);
            animation: backdrop-glow 6s ease-in-out;
        }
        
        @keyframes backdrop-glow {
            0% { background: #000000; }
            30% { background: radial-gradient(ellipse at center, #2d1b1b 0%, #1a0a0a 50%, #000000 100%); }
            100% { background: #000000; }
        }
        
        @keyframes curtain-left-open {
            0% { 
                transform: translateX(0) scaleY(1);
                opacity: 1;
                box-shadow: 15px 0 40px rgba(0,0,0,0.9), inset -30px 0 50px rgba(0,0,0,0.4);
            }
            15% {
                transform: translateX(-3%) scaleY(0.99);
                opacity: 0.98;
            }
            30% {
                transform: translateX(-10%) scaleY(0.96);
                opacity: 0.95;
            }
            60% {
                transform: translateX(-70%) scaleY(0.92);
                opacity: 0.8;
            }
            80% {
                transform: translateX(-90%) scaleY(0.88);
                opacity: 0.5;
            }
            100% { 
                transform: translateX(-110%) scaleY(0.85);
                opacity: 0;
                visibility: hidden;
            }
        }
        
        @keyframes curtain-right-open {
            0% { 
                transform: translateX(0) scaleY(1);
                opacity: 1;
                box-shadow: -15px 0 40px rgba(0,0,0,0.9), inset 30px 0 50px rgba(0,0,0,0.4);
            }
            15% {
                transform: translateX(3%) scaleY(0.99);
                opacity: 0.98;
            }
            30% {
                transform: translateX(10%) scaleY(0.96);
                opacity: 0.95;
            }
            60% {
                transform: translateX(70%) scaleY(0.92);
                opacity: 0.8;
            }
            80% {
                transform: translateX(90%) scaleY(0.88);
                opacity: 0.5;
            }
            100% { 
                transform: translateX(110%) scaleY(0.85);
                opacity: 0;
                visibility: hidden;
            }
        }
        
        @keyframes stage-fadeout {
            0% { opacity: 1; }
            85% { opacity: 1; }
            100% { opacity: 0; visibility: hidden; }
        }
        
        .curtain-left {
            position: absolute;
            top: 0;
            left: 0;
            width: 52%;
            height: 100%;
            background: linear-gradient(90deg, 
                #8B0000 0%,    /* Dark Red */
                #B22222 15%,   /* Fire Brick */
                #DC143C 30%,   /* Crimson */
                #FF0000 45%,   /* Red */
                #DC143C 60%,   /* Crimson */
                #B22222 80%,   /* Fire Brick */
                #8B0000 100%   /* Dark Red */
            );
            background-image: 
                repeating-linear-gradient(0deg, transparent 0px, rgba(255,255,255,0.03) 2px, transparent 4px),
                repeating-linear-gradient(90deg, transparent 0px, rgba(0,0,0,0.1) 1px, transparent 2px);
            box-shadow: 
                15px 0 40px rgba(0,0,0,0.9),
                inset -30px 0 50px rgba(0,0,0,0.4),
                inset 0 0 30px rgba(255,215,0,0.1);
            animation: curtain-left-open 6s ease-in-out forwards;
            border-right: 6px solid #FFD700;
            border-image: linear-gradient(180deg, #FFD700 0%, #FFA500 50%, #FFD700 100%) 1;
            transform-origin: left center;
        }
        
        .curtain-right {
            position: absolute;
            top: 0;
            right: 0;
            width: 52%;
            height: 100%;
            background: linear-gradient(270deg, 
                #8B0000 0%,    /* Dark Red */
                #B22222 15%,   /* Fire Brick */
                #DC143C 30%,   /* Crimson */
                #FF0000 45%,   /* Red */
                #DC143C 60%,   /* Crimson */
                #B22222 80%,   /* Fire Brick */
                #8B0000 100%   /* Dark Red */
            );
            background-image: 
                repeating-linear-gradient(0deg, transparent 0px, rgba(255,255,255,0.03) 2px, transparent 4px),
                repeating-linear-gradient(90deg, transparent 0px, rgba(0,0,0,0.1) 1px, transparent 2px);
            box-shadow: 
                -15px 0 40px rgba(0,0,0,0.9),
                inset 30px 0 50px rgba(0,0,0,0.4),
                inset 0 0 30px rgba(255,215,0,0.1);
            animation: curtain-right-open 6s ease-in-out forwards;
            border-left: 6px solid #FFD700;
            border-image: linear-gradient(180deg, #FFD700 0%, #FFA500 50%, #FFD700 100%) 1;
            transform-origin: right center;
        }
        
        .curtain-top-border {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 50px;
            background: linear-gradient(180deg, 
                #FFD700 0%, 
                #FFA500 25%, 
                #FF8C00 50%, 
                #FFA500 75%, 
                #B8860B 100%
            );
            box-shadow: 
                0 8px 25px rgba(0,0,0,0.7),
                inset 0 -10px 20px rgba(0,0,0,0.3);
            z-index: 10;
            border-bottom: 3px solid #8B0000;
        }
        
        .curtain-tassels {
            position: absolute;
            top: 50px;
            width: 100%;
            height: 80px;
            background: repeating-linear-gradient(
                90deg,
                #FFD700 0px, #FFD700 20px,
                #FFA500 20px, #FFA500 30px,
                #FF8C00 30px, #FF8C00 35px,
                #FFA500 35px, #FFA500 40px
            );
            opacity: 0.9;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            animation: tassel-sway 6s ease-in-out infinite;
        }
        
        @keyframes tassel-sway {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(3px); }
        }
        
        .cinema-stage {
            animation: stage-fadeout 6.5s ease-in-out forwards;
        }
        
        .cinema-logo {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #FFD700;
            font-size: 4rem;
            font-family: 'Georgia', serif;
            text-shadow: 
                3px 3px 6px rgba(0,0,0,0.8),
                0 0 20px rgba(255,215,0,0.3),
                0 0 40px rgba(255,215,0,0.2);
            opacity: 0;
            animation: logo-dramatic-entrance 6s ease-in-out;
            text-align: center;
            line-height: 1.2;
        }
        
        @keyframes logo-dramatic-entrance {
            0% { 
                opacity: 0; 
                transform: translate(-50%, -50%) scale(0.5);
                filter: blur(10px);
            }
            20% { 
                opacity: 0.3; 
                transform: translate(-50%, -50%) scale(0.8);
                filter: blur(5px);
            }
            40% { 
                opacity: 1; 
                transform: translate(-50%, -50%) scale(1.1);
                filter: blur(0px);
            }
            60% { 
                opacity: 1; 
                transform: translate(-50%, -50%) scale(1);
                filter: blur(0px);
            }
            80% { 
                opacity: 0.8; 
                transform: translate(-50%, -50%) scale(0.95);
            }
            100% { 
                opacity: 0; 
                transform: translate(-50%, -50%) scale(0.9);
                filter: blur(2px);
            }
        }
        
        .spotlight {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 400px;
            height: 400px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255,215,0,0.3) 0%, transparent 70%);
            transform: translate(-50%, -50%);
            animation: spotlight-pulse 6s ease-in-out;
            pointer-events: none;
        }
        
        @keyframes spotlight-pulse {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            30% { opacity: 0.8; transform: translate(-50%, -50%) scale(1.2); }
            70% { opacity: 0.6; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        }
        
        .curtain-rope-left {
            position: absolute;
            top: 130px;
            left: 48%;
            width: 8px;
            height: 200px;
            background: linear-gradient(180deg, #8B4513 0%, #654321 100%);
            border-radius: 4px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.5);
            animation: rope-pull 6s ease-in-out;
        }
        
        .curtain-rope-right {
            position: absolute;
            top: 130px;
            right: 48%;
            width: 8px;
            height: 200px;
            background: linear-gradient(180deg, #8B4513 0%, #654321 100%);
            border-radius: 4px;
            box-shadow: -2px 0 5px rgba(0,0,0,0.5);
            animation: rope-pull 6s ease-in-out;
        }
        
        @keyframes rope-pull {
            0% { transform: translateY(0); }
            30% { transform: translateY(-20px); }
            60% { transform: translateY(-40px); }
            100% { transform: translateY(-60px); opacity: 0; }
        }
        </style>
        
        <div class="cinema-stage">
            <div class="curtain-backdrop"></div>
            <div class="spotlight"></div>
            <div class="curtain-top-border"></div>
            <div class="curtain-tassels"></div>
            <div class="curtain-rope-left"></div>
            <div class="curtain-rope-right"></div>
            <div class="curtain-left"></div>
            <div class="curtain-right"></div>
            <div class="cinema-logo">ğŸ­<br/>YKS Hikayesi<br/>BaÅŸlÄ±yor...</div>
        </div>
        
        <script>
        // Sinema perdesi sesi simÃ¼lasyonu (gÃ¶rsel geri bildirim)
        let curtainEffect = 0;
        const curtainSoundEffect = setInterval(() => {
            curtainEffect++;
            if (curtainEffect <= 60) {
                const brightnessValue = 0.2 + (curtainEffect / 100);
                document.body.style.setProperty('filter', 'brightness(' + brightnessValue + ')');
            }
            if (curtainEffect >= 65) {
                clearInterval(curtainSoundEffect);
                document.body.style.filter = '';
                document.body.style.overflow = 'auto';
            }
        }, 100);
        
        // Ana temizlik
        setTimeout(() => {
            document.body.style.overflow = 'auto';
            document.body.style.filter = '';
        }, 6500);
        </script>
        """
        
        if st.session_state.current_day_index == 0:
            st.components.v1.html(curtain_html, height=0)
        
        # KÃ–KLÃœ TAM EKRAN Ã‡Ã–ZÃœMÃœ
        tam_ekran_style = """
        <style>
        /* KÃ–K CSS - TÃœM STREAMLIT UI GÄ°ZLE */
        div[data-testid="stSidebar"],
        section[data-testid="stSidebar"],
        div[data-testid="stHeader"],
        header[data-testid="stHeader"],
        div[data-testid="stToolbar"],
        div[data-testid="stDecoration"],
        .reportview-container .main .block-container,
        .css-1d391kg,
        .css-18e3th9,
        .css-1lcbmhc,
        .css-1inwz65,
        .css-k1vhr4,
        .css-12oz5g7,
        .e1fqkh3o0,
        .e1fqkh3o1,
        .e1fqkh3o2,
        .e1fqkh3o3 {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            height: 0 !important;
            width: 0 !important;
            position: absolute !important;
            left: -9999px !important;
        }
        
        /* SADECE TAM EKRAN MODUNDA */
        body.fullscreen-mode {
            margin: 0 !important;
            padding: 0 !important;
            background: #000 !important;
            overflow: hidden !important;
            width: 100vw !important;
            height: 100vh !important;
        }
        
        body.fullscreen-mode .stApp {
            background: #000 !important;
            margin: 0 !important;
            padding: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
        }
        
        body.fullscreen-mode .main {
            padding: 0 !important;
            margin: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            background: #000 !important;
            overflow-y: auto !important;
        }
        
        body.fullscreen-mode .main .block-container {
            max-width: 100% !important;
            width: 100% !important;
            padding: 10px !important;
            margin: 0 !important;
            height: 100vh !important;
            box-sizing: border-box !important;
        }
        
        body.fullscreen-mode .cinema-day-card {
            height: 95vh !important;
            max-height: 95vh !important;
            overflow-y: auto !important;
            margin: 2.5vh 1vw !important;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%) !important;
            border: 3px solid #ffd700 !important;
            border-radius: 10px !important;
            padding: 15px !important;
            box-sizing: border-box !important;
        }
        
        body.fullscreen-mode .cinema-photo-container {
            height: 500px !important;
            max-height: 500px !important;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            background: #000 !important;
            border-radius: 8px !important;
            overflow: hidden !important;
            margin: 15px 0 !important;
        }
        
        body.fullscreen-mode .cinema-photo-container img {
            max-width: 100% !important;
            max-height: 480px !important;
            width: auto !important;
            height: auto !important;
            object-fit: contain !important;
            border-radius: 6px !important;
            border: 2px solid #ffd700 !important;
        }
        </style>
        
        <script>
        // TAM EKRAN DURUMU KONTRol
        function checkFullscreenState() {
            const fullscreenMode = window.sessionStorage.getItem('cinema_fullscreen') === 'true';
            
            if (fullscreenMode) {
                document.body.classList.add('fullscreen-mode');
                
                // Streamlit UI elementlerini zorla gizle
                setTimeout(() => {
                    const elementsToHide = [
                        '[data-testid="stSidebar"]',
                        '[data-testid="stHeader"]', 
                        '[data-testid="stToolbar"]',
                        '.css-1d391kg',
                        '.css-18e3th9'
                    ];
                    
                    elementsToHide.forEach(selector => {
                        const elements = document.querySelectorAll(selector);
                        elements.forEach(el => {
                            if (el) {
                                el.style.display = 'none';
                                el.style.visibility = 'hidden';
                                el.style.opacity = '0';
                                el.style.position = 'absolute';
                                el.style.left = '-9999px';
                            }
                        });
                    });
                }, 100);
            } else {
                document.body.classList.remove('fullscreen-mode');
            }
        }
        
        // Sayfa yÃ¼klendiÄŸinde kontrol et
        checkFullscreenState();
        
        // Periyodik kontrol
        setInterval(checkFullscreenState, 500);
        </script>
        """
        
        st.components.v1.html(tam_ekran_style, height=0)

        # GÃ¼nlÃ¼k gÃ¶sterim
        if st.session_state.current_day_index < len(journey_data):
            current_day = journey_data[st.session_state.current_day_index]
            
            # Tam ekran JavaScript (ayrÄ± deÄŸiÅŸken - escape gerekmez)
            fullscreen_script = """
                <script>
                // DÃœZELTME: Mobil + PC tam ekran (yanÄ±p sÃ¶nme yok!)
                
                // Mobil cihaz tespiti
                function isMobileDevice() {
                    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                }
                
                // localStorage'dan tam ekran durumunu oku
                function getFullscreenState() {
                    return localStorage.getItem('cinema_fullscreen') === 'true';
                }
                
                // localStorage'a tam ekran durumunu kaydet
                function setFullscreenState(state) {
                    localStorage.setItem('cinema_fullscreen', state);
                }
                
                function toggleFullscreenMode() {
                    const cinemaWrapper = document.getElementById('cinema-content-wrapper');
                    const btn = document.getElementById('fullscreen-btn');
                    
                    if (!cinemaWrapper) {
                        console.error('Cinema wrapper bulunamadÄ±!');
                        return;
                    }
                    
                    const isFullscreen = getFullscreenState();
                    
                    if (!isFullscreen) {
                        // TAM EKRANA GEÃ‡
                        enterFullscreen(cinemaWrapper, btn);
                    } else {
                        // NORMAL MODA DÃ–N
                        exitFullscreen(cinemaWrapper, btn);
                    }
                }
                
                function enterFullscreen(cinemaWrapper, btn) {
                    // Orijinal stilleri kaydet
                    if (!cinemaWrapper.hasAttribute('data-original-style')) {
                        cinemaWrapper.setAttribute('data-original-style', cinemaWrapper.getAttribute('style') || '');
                    }
                    
                    // Restore flag ekle (duplicate restore engellemek iÃ§in)
                    cinemaWrapper.setAttribute('data-fullscreen-restored', 'true');
                    
                    if (isMobileDevice()) {
                        // MOBÄ°L Ä°Ã‡Ä°N Ã–ZEL TAM EKRAN
                        cinemaWrapper.style.position = 'fixed';
                        cinemaWrapper.style.top = '0';
                        cinemaWrapper.style.bottom = '0';
                        cinemaWrapper.style.left = '0';
                        cinemaWrapper.style.right = '0';
                        cinemaWrapper.style.width = '100vw';
                        cinemaWrapper.style.height = '100vh';
                        cinemaWrapper.style.maxWidth = 'none';
                        cinemaWrapper.style.maxHeight = 'none';
                        cinemaWrapper.style.zIndex = '2147483647'; // Max z-index
                        cinemaWrapper.style.margin = '0';
                        cinemaWrapper.style.padding = '10px';
                        cinemaWrapper.style.borderRadius = '0';
                        cinemaWrapper.style.border = 'none';
                        cinemaWrapper.style.overflowY = 'auto';
                        cinemaWrapper.style.overflowX = 'hidden';
                        cinemaWrapper.style.WebkitOverflowScrolling = 'touch';
                        cinemaWrapper.style.transform = 'translate3d(0, 0, 0)';
                        
                        // iOS Safari iÃ§in Ã¶zel viewport fix
                        const viewport = document.querySelector('meta[name=viewport]');
                        if (viewport) {
                            viewport.setAttribute('data-original-content', viewport.getAttribute('content'));
                            viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover');
                        }
                        
                        // Mobil'de scroll lock
                        document.body.style.overflow = 'hidden';
                        document.body.style.position = 'fixed';
                        document.body.style.width = '100%';
                        document.body.style.height = '100vh';
                        
                        // iOS Safari minimal-ui
                        if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
                            cinemaWrapper.style.height = window.innerHeight + 'px';
                            // Orientation deÄŸiÅŸikliÄŸini dinle
                            window.addEventListener('orientationchange', function() {
                                setTimeout(() => {
                                    cinemaWrapper.style.height = window.innerHeight + 'px';
                                }, 100);
                            });
                        }
                    } else {
                        // PC Ä°Ã‡Ä°N TAM EKRAN
                        cinemaWrapper.style.position = 'fixed';
                        cinemaWrapper.style.top = '0';
                        cinemaWrapper.style.bottom = '0';
                        cinemaWrapper.style.left = '0';
                        cinemaWrapper.style.right = '0';
                        cinemaWrapper.style.width = '100vw';
                        cinemaWrapper.style.height = '100vh';
                        cinemaWrapper.style.maxWidth = '100vw';
                        cinemaWrapper.style.maxHeight = '100vh';
                        cinemaWrapper.style.zIndex = '999999';
                        cinemaWrapper.style.margin = '0';
                        cinemaWrapper.style.padding = '20px';
                        cinemaWrapper.style.borderRadius = '0';
                        cinemaWrapper.style.border = 'none';
                        cinemaWrapper.style.overflowY = 'auto';
                        cinemaWrapper.style.overflowX = 'hidden';
                        
                        // PC'de body scroll kilidi
                        document.body.style.overflow = 'hidden';
                    }
                    
                    // Native fullscreen API (PC ve Android iÃ§in)
                    if (!isMobileDevice() || /Android/.test(navigator.userAgent)) {
                        if (cinemaWrapper.requestFullscreen) {
                            cinemaWrapper.requestFullscreen().catch(err => {
                                console.log('Native fullscreen desteklenmiyor:', err);
                            });
                        } else if (cinemaWrapper.webkitRequestFullscreen) {
                            cinemaWrapper.webkitRequestFullscreen();
                        } else if (cinemaWrapper.mozRequestFullScreen) {
                            cinemaWrapper.mozRequestFullScreen();
                        } else if (cinemaWrapper.msRequestFullscreen) {
                            cinemaWrapper.msRequestFullscreen();
                        }
                    }
                    
                    setFullscreenState(true);
                    
                    if (btn) {
                        btn.innerHTML = 'ğŸªŸ Normal Mod (ESC)';
                        btn.style.background = 'linear-gradient(45deg, #4CAF50, #45a049)';
                    }
                    
                    showNotification(isMobileDevice() ? 'ğŸ“± Mobil Tam Ekran Aktif!' : 'ğŸ¬ PC Tam Ekran Aktif!');
                }
                
                function exitFullscreen(cinemaWrapper, btn) {
                    // Native fullscreen'den Ã§Ä±k
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    } else if (document.webkitExitFullscreen) {
                        document.webkitExitFullscreen();
                    } else if (document.mozCancelFullScreen) {
                        document.mozCancelFullScreen();
                    } else if (document.msExitFullscreen) {
                        document.msExitFullscreen();
                    }
                    
                    // Orijinal stilleri geri yÃ¼kle
                    if (cinemaWrapper) {
                        const originalStyle = cinemaWrapper.getAttribute('data-original-style');
                        if (originalStyle !== null) {
                            cinemaWrapper.setAttribute('style', originalStyle);
                        }
                        cinemaWrapper.removeAttribute('data-fullscreen-restored');
                    }
                    
                    // Body stilleri geri yÃ¼kle
                    document.body.style.overflow = '';
                    document.body.style.position = '';
                    document.body.style.width = '';
                    document.body.style.height = '';
                    
                    // Mobil viewport restore
                    if (isMobileDevice()) {
                        const viewport = document.querySelector('meta[name=viewport]');
                        if (viewport) {
                            const originalContent = viewport.getAttribute('data-original-content');
                            if (originalContent) {
                                viewport.setAttribute('content', originalContent);
                            }
                        }
                    }
                    
                    setFullscreenState(false);
                    
                    if (btn) {
                        btn.innerHTML = 'ğŸ–¼ï¸ Tam Ekran';
                        btn.style.background = 'linear-gradient(45deg, #ff6b6b, #ee5a24)';
                    }
                    
                    showNotification('ğŸªŸ Normal moda dÃ¶ndÃ¼');
                }
                
                // ESC tuÅŸu veya native fullscreen Ã§Ä±kÄ±ÅŸÄ±nÄ± dinle
                document.addEventListener('fullscreenchange', function() {
                    if (!document.fullscreenElement) {
                        const cinemaWrapper = document.getElementById('cinema-content-wrapper');
                        const btn = document.getElementById('fullscreen-btn');
                        if (getFullscreenState()) {
                            exitFullscreen(cinemaWrapper, btn);
                        }
                    }
                });
                document.addEventListener('webkitfullscreenchange', function() {
                    if (!document.webkitFullscreenElement) {
                        const cinemaWrapper = document.getElementById('cinema-content-wrapper');
                        const btn = document.getElementById('fullscreen-btn');
                        if (getFullscreenState()) {
                            exitFullscreen(cinemaWrapper, btn);
                        }
                    }
                });
                
                // DOÄRUDAN RESTORE (yanÄ±p sÃ¶nme yok!)
                (function immediateRestore() {
                    const cinemaWrapper = document.getElementById('cinema-content-wrapper');
                    const btn = document.getElementById('fullscreen-btn');
                    
                    // Sadece restore edilmemiÅŸse ve state aktifse restore et
                    if (getFullscreenState() && cinemaWrapper && btn && !cinemaWrapper.hasAttribute('data-fullscreen-restored')) {
                        enterFullscreen(cinemaWrapper, btn);
                    }
                })();
                
                function showNotification(message) {
                    // Duplicate notification engelle
                    const existing = document.querySelector('.fullscreen-notification');
                    if (existing) existing.remove();
                    
                    const notification = document.createElement('div');
                    notification.className = 'fullscreen-notification';
                    notification.innerHTML = message;
                    notification.style.position = 'fixed';
                    notification.style.top = '20px';
                    notification.style.left = '50%';
                    notification.style.transform = 'translateX(-50%)';
                    notification.style.background = 'linear-gradient(45deg, #4CAF50, #45a049)';
                    notification.style.color = 'white';
                    notification.style.padding = '15px 30px';
                    notification.style.borderRadius = '25px';
                    notification.style.zIndex = '9999999';
                    notification.style.fontSize = '16px';
                    notification.style.fontFamily = 'Arial, sans-serif';
                    notification.style.fontWeight = 'bold';
                    notification.style.border = '2px solid #ffd700';
                    notification.style.boxShadow = '0 8px 25px rgba(0,0,0,0.5)';
                    document.body.appendChild(notification);
                    setTimeout(() => notification.remove(), 2500);
                }
                </script>
            """
            
            # Film karesi stili (Mobil responsive)
            day_frame = f"""
            <div id="cinema-content-wrapper" class="cinema-day-card" style="
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                border: 6px solid #ffd700;
                border-radius: 15px;
                padding: 30px;
                margin: 20px 0;
                color: white;
                font-family: 'Arial', sans-serif;
                box-shadow: 0 10px 25px rgba(255, 215, 0, 0.2);
                max-width: 100%;
                max-height: 95vh;
                overflow-x: hidden;
                overflow-y: auto;
            ">
                <div style="text-align: center; margin-bottom: 25px;">
                    <h2 style="color: #ffd700; font-size: 2.5rem; margin: 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);">
                        ğŸ“… {current_day['day_number']}. GÃ¼n
                    </h2>
                    <p style="color: #ffffff; font-size: 1.3rem; margin: 5px 0;">
                        {current_day['date'].strftime('%d.%m.%Y')} - {['Pazartesi','SalÄ±','Ã‡arÅŸamba','PerÅŸembe','Cuma','Cumartesi','Pazar'][current_day['date'].weekday()]}
                    </p>
                </div>
                
                <style>
                    .data-grid {{
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                        gap: 15px;
                        margin: 25px 0;
                    }}
                    @media (max-width: 768px) {{
                        .data-grid {{
                            grid-template-columns: 1fr !important;
                            gap: 10px !important;
                        }}
                    }}
                    
                    /* Tam ekran iÃ§in scrollbar stilleri */
                    .cinema-day-card::-webkit-scrollbar {{
                        width: 8px;
                    }}
                    
                    .cinema-day-card::-webkit-scrollbar-track {{
                        background: rgba(255, 215, 0, 0.1);
                        border-radius: 4px;
                    }}
                    
                    .cinema-day-card::-webkit-scrollbar-thumb {{
                        background: #ffd700;
                        border-radius: 4px;
                    }}
                    
                    .cinema-day-card::-webkit-scrollbar-thumb:hover {{
                        background: #ffed4e;
                    }}
                    
                    /* KÃ–KLÃœ FOTOÄRAF Ã‡Ã–ZÃœMÃœ - ARTIK TAM GÃ–RÃœNÃœR! */
                    .cinema-photo-container {{
                        display: flex !important;
                        justify-content: center !important;
                        align-items: center !important;
                        height: 450px !important;
                        max-height: 450px !important;
                        min-height: 450px !important;
                        overflow: hidden !important;
                        border-radius: 15px !important;
                        background: rgba(0,0,0,0.3) !important;
                        margin: 20px 0 !important;
                        padding: 10px !important;
                        box-sizing: border-box !important;
                        border: 2px solid #ffd700 !important;
                    }}
                    
                    .cinema-photo-container img {{
                        max-width: 100% !important;
                        max-height: 420px !important;
                        width: auto !important;
                        height: auto !important;
                        object-fit: contain !important;
                        border-radius: 12px !important;
                        border: 3px solid #ffd700 !important;
                        box-shadow: 0 8px 25px rgba(255, 215, 0, 0.4) !important;
                        transition: all 0.3s ease !important;
                    }}
                    
                    .cinema-photo-container img:hover {{
                        transform: scale(1.02) !important;
                        box-shadow: 0 12px 35px rgba(255, 215, 0, 0.6) !important;
                    }}
                </style>
                <div class="data-grid">
                    
                    <div style="background: rgba(255, 215, 0, 0.1); padding: 20px; border-radius: 10px; border-left: 4px solid #ffd700;">
                        <h4 style="color: #ffd700; margin: 0 0 10px 0;">â­ GÃ¼nlÃ¼k Motivasyon</h4>
                        <p style="font-size: 1.5rem; margin: 5px 0;">{current_day['motivation_score']}/10</p>
                        <p style="font-size: 0.9rem; color: #cccccc;">{current_day['daily_note'] or 'Not girilmemiÅŸ'}</p>
                    </div>
                    
                    <div style="background: rgba(76, 175, 80, 0.1); padding: 20px; border-radius: 10px; border-left: 4px solid #4CAF50;">
                        <h4 style="color: #4CAF50; margin: 0 0 10px 0;">â“ Ã‡Ã¶zÃ¼len Sorular</h4>
                        <p style="font-size: 1.5rem; margin: 5px 0;">{current_day['total_questions']} soru</p>
                        <p style="font-size: 0.9rem; color: #cccccc;">
                            {', '.join([f"{k}: {v}" for k, v in current_day['questions_solved'].items() if v]) or 'Veri girilmemiÅŸ'}
                        </p>
                    </div>
                    
                    <div style="background: rgba(33, 150, 243, 0.1); padding: 20px; border-radius: 10px; border-left: 4px solid #2196F3;">
                        <h4 style="color: #2196F3; margin: 0 0 10px 0;">ğŸ“š Tamamlanan Konular</h4>
                        <p style="font-size: 1.5rem; margin: 5px 0;">{len(current_day['completed_topics'])} konu</p>
                        <p style="font-size: 0.9rem; color: #cccccc;">
                            {', '.join(current_day['completed_topics'][:2]) or 'Konu girilmemiÅŸ'}
                        </p>
                    </div>
                    
                    <div style="background: rgba(156, 39, 176, 0.1); padding: 20px; border-radius: 10px; border-left: 4px solid #9C27B0;">
                        <h4 style="color: #9C27B0; margin: 0 0 10px 0;">ğŸ¯ YKS Ä°lerleme</h4>
                        <p style="font-size: 1.2rem; margin: 5px 0;">
                            TYT: %{current_day['tyt_progress']} | AYT: %{current_day['ayt_progress']}
                        </p>
                        <p style="font-size: 0.9rem; color: #cccccc;">Hedeflere doÄŸru ilerliyor</p>
                    </div>
                    
                </div>
                
                <div style="text-align: center; margin-top: 30px; padding: 20px; background: rgba(255, 215, 0, 0.1); border-radius: 10px;">
                    <h3 style="color: #ffd700; margin: 0 0 10px 0;">ğŸ† GÃ¼nÃ¼n BaÅŸarÄ±sÄ±</h3>
                    <p style="font-size: 1.3rem; color: #ffffff; margin: 0;">
                        {current_day['daily_achievement']}
                    </p>
                </div>
                
                {f'''
                <div style="text-align: center; margin-top: 25px; padding: 20px; background: rgba(255, 215, 0, 0.08); border-radius: 15px; border: 2px solid rgba(255, 215, 0, 0.3);">
                    <h4 style="color: #ffd700; margin-bottom: 20px; font-size: 1.4rem; text-shadow: 1px 1px 3px rgba(0,0,0,0.5);">ğŸ“· GÃ¼nÃ¼n FotoÄŸrafÄ±</h4>
                    <div class="cinema-photo-container" style="display: flex; justify-content: center; align-items: center; height: 450px; width: 100%; overflow: hidden; border-radius: 15px; background: rgba(0,0,0,0.3); margin: 20px 0; padding: 10px; box-sizing: border-box; border: 2px solid #ffd700;">
                        <img src="{current_day['photo_data']}" 
                             style="max-width: 100%; max-height: 420px; width: auto; height: auto; object-fit: contain; border-radius: 12px; border: 3px solid #ffd700; box-shadow: 0 8px 25px rgba(255, 215, 0, 0.4); transition: all 0.3s ease;"
                             alt="GÃ¼nÃ¼n FotoÄŸrafÄ±"
                             onmouseover="this.style.setProperty('transform', 'scale(1.02)'); this.style.setProperty('box-shadow', '0 12px 35px rgba(255, 215, 0, 0.6)');"
                             onmouseout="this.style.setProperty('transform', 'scale(1)'); this.style.setProperty('box-shadow', '0 8px 25px rgba(255, 215, 0, 0.4)');"
                             onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'200\' height=\'200\'%3E%3Crect width=\'200\' height=\'200\' fill=\'%23f0f0f0\'/%3E%3Ctext x=\'100\' y=\'120\' font-size=\'24\' text-anchor=\'middle\' fill=\'%23666\'%3EğŸ“¸ FotoÄŸraf%3C/text%3E%3C/svg%3E';">
                    </div>
                    <p style="color: #e0e0e0; font-size: 1rem; margin-top: 15px; font-style: italic; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">"{current_day['photo_caption'] or 'FotoÄŸraf aÃ§Ä±klamasÄ± eklenmemiÅŸ'}"</p>
                </div>
                ''' if current_day.get('photo_data') and len(str(current_day['photo_data'])) > 50 else f'''
                <div style="text-align: center; margin-top: 20px; padding: 15px; background: rgba(255, 193, 7, 0.1); border-radius: 10px; border: 2px dashed #ffc107;">
                    <h4 style="color: #ffc107; margin-bottom: 15px;">ğŸ“· GÃ¼nÃ¼n AnÄ±sÄ±</h4>
                    <div style="color: #ffc107; font-size: 4rem; margin: 20px 0;">ğŸŒ…</div>
                    <p style="color: #ffc107; font-size: 1.1rem; margin: 10px 0; font-weight: 500;">Bu gÃ¼nÃ¼n Ã¶zel anlarÄ± fotoÄŸrafa Ã§ekilmemiÅŸ</p>
                    <p style="color: #888888; font-size: 0.9rem;">Gelecekte hatÄ±rlamak iÃ§in fotoÄŸraf eklemeyi unutma!</p>
                </div>
                '''}
                
                <!-- TAM EKRAN BUTONU - Cinema iÃ§eriÄŸiyle aynÄ± iframe iÃ§inde -->
                <div style="text-align: center; margin-top: 25px; padding: 15px;">
                    <button onclick="toggleFullscreenMode()" 
                            style="padding: 15px 40px; 
                                   background: linear-gradient(45deg, #ff6b6b, #ee5a24);
                                   color: white; border: none; border-radius: 12px; cursor: pointer;
                                   font-size: 16px; font-weight: bold; transition: all 0.3s ease;
                                   box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);"
                            onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 20px rgba(255, 107, 107, 0.6)';"
                            onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 15px rgba(255, 107, 107, 0.4)';"
                            id="fullscreen-btn">
                        ğŸ–¼ï¸ Tam Ekran
                    </button>
                </div>
                
                {fullscreen_script}
            </div>
            """
            
            st.components.v1.html(day_frame, height=800)
            
            # Kontrol butonlarÄ±
            # YouTube tarzÄ± tam ekran hazÄ±r
            
            # Tam ekran durumu iÃ§in session state
            if 'fullscreen_mode' not in st.session_state:
                st.session_state.fullscreen_mode = False
            
            col1, col2, col3, col4, col5, col6 = st.columns([1, 1, 1, 1, 1, 1])
            
            with col1:
                if st.button("â®ï¸ Ã–nceki", disabled=(st.session_state.current_day_index == 0)):
                    st.session_state.current_day_index = max(0, st.session_state.current_day_index - 1)
                    st.rerun()
            
            with col2:
                # Film ve MÃ¼zik kontrolleri birleÅŸik
                if st.session_state.auto_play_mode and st.session_state.music_playing:
                    play_text = "â¸ï¸ Duraklat"
                elif st.session_state.auto_play_mode and not st.session_state.music_playing:
                    play_text = "â¸ï¸ Duraklat"
                elif not st.session_state.auto_play_mode and st.session_state.music_playing:
                    play_text = "â–¶ï¸ Oynat"
                else:
                    play_text = "â–¶ï¸ Oynat"
                
                if st.button(play_text):
                    # Hem film hem mÃ¼zik kontrolÃ¼
                    st.session_state.auto_play_mode = not st.session_state.auto_play_mode
                    st.session_state.music_playing = st.session_state.auto_play_mode
                    
                    if st.session_state.auto_play_mode:
                        st.session_state.last_day_change = time.time()
                    st.rerun()
            
            with col3:
                if st.button("â­ï¸ Sonraki", disabled=(st.session_state.current_day_index >= len(journey_data) - 1)):
                    st.session_state.current_day_index = min(len(journey_data) - 1, st.session_state.current_day_index + 1)
                    st.session_state.last_day_change = time.time()
                    st.rerun()
            
            with col4:
                # YENÄ° "TEKRAR Ä°ZLE" BUTONU - HER ZAMAN GÃ–RÃœNSÄ°N!
                if st.button("ğŸ”„ Tekrar Ä°zle"):
                    st.session_state.current_day_index = 0
                    st.session_state.last_day_change = time.time()
                    st.session_state.auto_play_mode = True
                    st.session_state.music_playing = True
                    st.success("ğŸ¬ Hikaye baÅŸtan baÅŸlÄ±yor!")
                    st.rerun()
            
            with col5:
                # TAM EKRAN BUTONU ARTIK CÄ°NEMA Ä°Ã‡ERÄ°ÄÄ°NÄ°N Ä°Ã‡Ä°NDE (yukarÄ±da day_frame iÃ§inde)
                st.write("")  # BoÅŸ kolon - tam ekran butonu cinema iÃ§inde
            
            with col6:
                if st.button("ğŸšª Ã‡Ä±kÄ±ÅŸ"):
                    st.session_state.cinema_active = False
                    st.session_state.current_day_index = 0
                    st.session_state.fullscreen_mode = False
                    # Tam ekran modundan Ã§Ä±k ve localStorage temizle
                    exit_fullscreen_script = """
                    <script>
                    // localStorage state'ini temizle
                    localStorage.removeItem('cinema_fullscreen');
                    
                    // Tam ekrandan Ã§Ä±k
                    const doc = document;
                    if (doc.exitFullscreen) {
                        doc.exitFullscreen();
                    } else if (doc.mozCancelFullScreen) {
                        doc.mozCancelFullScreen();
                    } else if (doc.webkitExitFullscreen) {
                        doc.webkitExitFullscreen();
                    } else if (doc.msExitFullscreen) {
                        doc.msExitFullscreen();
                    }
                    document.body.removeAttribute('style');
                    document.body.style.overflow = '';
                    </script>
                    """
                    st.components.v1.html(exit_fullscreen_script, height=0)
                    st.rerun()
            
            # Durum bilgisi - JavaScript ile senkron
            durum_html = """
            <div id="status-info" style="
                background: linear-gradient(45deg, #28a745, #20c997);
                color: white; padding: 12px 20px; border-radius: 10px;
                font-weight: bold; text-align: center; margin: 10px 0;
                box-shadow: 0 2px 10px rgba(40, 167, 69, 0.3);
            ">
                <span id="music-status">ğŸµ MÃ¼zik Durumu</span> | 
                <span id="screen-status">ğŸªŸ Normal Mod</span> | 
                <span>ğŸ“… GÃ¼n: """ + str(st.session_state.current_day_index + 1) + "/" + str(len(journey_data)) + """</span>
            </div>
            
            <script>
            function updateStatus() {
                const musicPlaying = """ + str(st.session_state.music_playing).lower() + """;
                const doc = document;
                const isFullscreen = doc.fullscreenElement || doc.mozFullScreenElement || 
                                    doc.webkitFullscreenElement || doc.msFullscreenElement;
                
                const musicStatusEl = document.getElementById('music-status');
                const screenStatusEl = document.getElementById('screen-status');
                
                if (musicStatusEl) {
                    musicStatusEl.innerHTML = musicPlaying ? 'ğŸµ Ã‡alÄ±yor' : 'ğŸ”‡ DuraklatÄ±ldÄ±';
                }
                
                if (screenStatusEl) {
                    screenStatusEl.innerHTML = isFullscreen ? 'ğŸ–¼ï¸ Tam Ekran AKTÄ°F' : 'ğŸªŸ Normal Mod';
                }
            }
            
            // Durumu gÃ¼ncelle
            updateStatus();
            
            // Periyodik gÃ¼ncelleme
            setInterval(updateStatus, 1000);
            </script>
            """
            st.components.v1.html(durum_html, height=60)
            
            # Otomatik geÃ§iÅŸ
            if st.session_state.auto_play_mode:
                current_time = time.time()
                if current_time - st.session_state.last_day_change >= st.session_state.day_duration:
                    if st.session_state.current_day_index < len(journey_data) - 1:
                        st.session_state.current_day_index += 1
                        st.session_state.last_day_change = current_time
                        time.sleep(0.1)  # KÃ¼Ã§Ã¼k gecikme
                        st.rerun()
                    else:
                        # Film bitti
                        st.session_state.auto_play_mode = False
                        st.balloons()
                        st.success(f"ğŸ‰ {student_name}'nin baÅŸarÄ± hikayesi tamamlandÄ±!")
                        st.info("ğŸ”„ 'Tekrar Ä°zle' butonuna tÄ±klayarak hikayeyi tekrar izleyebilirsiniz!")
                else:
                    # Sayfa yenileme performansÄ±nÄ± artÄ±rmak iÃ§in sadece gerektiÄŸinde yenile
                    time.sleep(0.5)
                    st.rerun()
            
            # Ä°lerleme Ã§ubuÄŸu
            progress = (st.session_state.current_day_index + 1) / total_days
            st.progress(progress)
            
            col1, col2 = st.columns(2)
            with col1:
                st.caption(f"ğŸ“Š Ä°lerleme: {st.session_state.current_day_index + 1}/{total_days} gÃ¼n")
            with col2:
                if st.session_state.auto_play_mode:
                    remaining_time = st.session_state.day_duration - (time.time() - st.session_state.last_day_change)
                    if remaining_time > 0:
                        st.caption(f"â° Sonraki gÃ¼n: {remaining_time:.1f}s")
                    else:
                        st.caption("â° GeÃ§iÅŸ yapÄ±lÄ±yor...")
                else:
                    st.caption("â¸ï¸ DuraklatÄ±ldÄ±")
            
        else:
            # Film bitti
            st.markdown("### ğŸ‰ Hikaye TamamlandÄ±!")
            st.balloons()
            if st.button("ğŸ”„ Tekrar Ä°zle", type="primary"):
                st.session_state.current_day_index = 0
                st.session_state.last_day_change = time.time()
                st.rerun()


def update_topic_completion_date(username, topic_key):
    """Konu tamamlandÄ±ÄŸÄ±nda tarihi kaydet - YENÄ°: KALICI Ã–ÄRENME SÄ°STEMÄ° ENTEGRASYONU"""
    if db_ref is None:
        return
    
    try:
        user_data = get_user_data()
        if user_data:
            completion_dates = json.loads(user_data.get('topic_completion_dates', '{}') or '{}')
            completion_dates[topic_key] = datetime.now().isoformat()
            
            # YENÄ°: KalÄ±cÄ± Ã¶ÄŸrenme sistemine ekle
            topic_progress = json.loads(user_data.get('topic_progress', '{}') or '{}')
            net_value = topic_progress.get(topic_key, '0')
            
            try:
                net_int = int(float(net_value))
                if net_int >= 14:  # Ä°yi seviye ve Ã¼stÃ¼
                    # KalÄ±cÄ± Ã¶ÄŸrenme sistemine ekle
                    user_data = initialize_mastery_system(user_data)
                    user_data = add_topic_to_mastery_system(user_data, topic_key, "iyi")
                    
                    # GÃ¼ncellenmiÅŸ veriyi kaydet
                    update_data = {
                        'topic_completion_dates': json.dumps(completion_dates),
                        'topic_repetition_history': user_data['topic_repetition_history'],
                        'topic_mastery_status': user_data['topic_mastery_status']
                    }
                    
                    update_user_in_firebase(username, update_data)
                    
                    # Session state'i gÃ¼ncelle
                    if 'current_user' in st.session_state:
                        st.session_state.current_user.update(user_data)
                else:
                    # Sadece tamamlama tarihini gÃ¼ncelle
                    update_user_in_firebase(username, {
                        'topic_completion_dates': json.dumps(completion_dates)
                    })
            except:
                # Hata durumunda sadece eski sistemi gÃ¼ncelle
                update_user_in_firebase(username, {
                    'topic_completion_dates': json.dumps(completion_dates)
                })
                
    except Exception as e:
        st.error(f"Tamamlama tarihi kaydedilemedi: {e}")

# Konu takip sistemine entegrasyon iÃ§in yardÄ±mcÄ± fonksiyon
def check_and_update_completion_dates():
    """Konu takip sisteminden iyi seviyeye Ã§Ä±kan konularÄ± takip et"""
    if not st.session_state.get('current_user'):
        return
    
    user_data = get_user_data()
    if not user_data:
        return
    
    topic_progress = json.loads(user_data.get('topic_progress', '{}') or '{}')
    completion_dates = json.loads(user_data.get('topic_completion_dates', '{}') or '{}')
    
    # Yeni tamamlanan konularÄ± bul
    for topic_key, net_str in topic_progress.items():
        try:
            net_value = int(float(net_str))
            if net_value >= 14 and topic_key not in completion_dates:
                # Yeni tamamlanan konu
                update_topic_completion_date(st.session_state.current_user, topic_key)
        except:
            continue



def pomodoro_timer_page(user_data):
    """ğŸ… Hibrit Pomodoro Timer - AkÄ±llÄ± Nefes Sistemi ile"""
    st.markdown(f'<div class="main-header"><h1>ğŸ… Hibrit Pomodoro Timer</h1><p>AkÄ±llÄ± nefes sistemi ile verimli Ã§alÄ±ÅŸma - SÄ±kÄ±ldÄ±ÄŸÄ±nda "Nefes Al" butonuna bas!</p></div>', unsafe_allow_html=True)
    
    # Session state baÅŸlat
    init_pomodoro_session_state()
    
    # Ana pomodoro arayÃ¼zÃ¼
    show_pomodoro_interface(user_data)
    
    # BugÃ¼nkÃ¼ istatistikler
    show_daily_pomodoro_stats(user_data)
    
    # Ã‡alÄ±ÅŸma geÃ§miÅŸi
    show_pomodoro_history(user_data)

def init_pomodoro_session_state():
    """Pomodoro session state'ini baÅŸlat ve eski deÄŸerleri yeni preset'lere migrate et"""
    
    # Mevcut preset isimleri
    valid_presets = ['KÄ±sa Odak (25dk+5dk)', 'Standart Odak (35dk+10dk)', 
                     'Derin Odak (50dk+15dk)', 'Tam Konsantrasyon (90dk+25dk)']
    
    # Eski preset isimlerinden yeni preset isimlerine migration map
    preset_migration = {
        'Pomodoro (25dk)': 'KÄ±sa Odak (25dk+5dk)',
        'KÄ±sa Mola (5dk)': 'KÄ±sa Odak (25dk+5dk)',
        'Uzun Mola (15dk)': 'Derin Odak (50dk+15dk)',
        'Derin Odak (50dk)': 'Derin Odak (50dk+15dk)'
    }
    
    if 'pomodoro_active' not in st.session_state:
        st.session_state.pomodoro_active = False
        
    # Pomodoro tÃ¼rÃ¼ kontrolÃ¼ ve migration
    if 'pomodoro_type' not in st.session_state:
        st.session_state.pomodoro_type = 'KÄ±sa Odak (25dk+5dk)'
    else:
        # EÄŸer mevcut preset geÃ§ersizse, migrate et veya varsayÄ±lana dÃ¶n
        if st.session_state.pomodoro_type not in valid_presets:
            if st.session_state.pomodoro_type in preset_migration:
                st.session_state.pomodoro_type = preset_migration[st.session_state.pomodoro_type]
                st.info(f"ğŸ”„ Pomodoro ayarÄ±nÄ±z yeni sisteme gÃ¼ncellendi: {st.session_state.pomodoro_type}")
            else:
                st.session_state.pomodoro_type = 'KÄ±sa Odak (25dk+5dk)'
                st.warning("âš ï¸ Eski Pomodoro ayarÄ± tespit edildi, varsayÄ±lan preset seÃ§ildi.")
    
    if 'time_remaining' not in st.session_state:
        st.session_state.time_remaining = 25 * 60  # 25 dakika
    if 'start_time' not in st.session_state:
        st.session_state.start_time = None
    if 'current_subject' not in st.session_state:
        st.session_state.current_subject = ''
    if 'current_topic' not in st.session_state:
        st.session_state.current_topic = ''
    if 'daily_pomodoros' not in st.session_state:
        st.session_state.daily_pomodoros = []
    # Eski gÃ¼nlÃ¼k hedef sistemi kaldÄ±rÄ±ldÄ± - artÄ±k haftalÄ±k hedef konular kullanÄ±lÄ±yor
    
    # === HÄ°BRÄ°T POMODORO SÄ°STEMÄ° Ä°Ã‡Ä°N YENÄ° SESSION STATES ===
    if 'breathing_active' not in st.session_state:
        st.session_state.breathing_active = False
    if 'breathing_paused_time' not in st.session_state:
        st.session_state.breathing_paused_time = 0
    if 'breath_time_remaining' not in st.session_state:
        st.session_state.breath_time_remaining = 60
    if 'breath_start_time' not in st.session_state:
        st.session_state.breath_start_time = None
    if 'current_motivation_type' not in st.session_state:
        st.session_state.current_motivation_type = 'quote'
    if 'current_motivation_content' not in st.session_state:
        st.session_state.current_motivation_content = ''
    if 'breathing_usage_log' not in st.session_state:
        st.session_state.breathing_usage_log = []
    
    # === REKABET SÄ°STEMÄ° SESSION STATES === (Basit sistem, fazla state yok)

def show_pomodoro_interface(user_data):
    """Ana pomodoro arayÃ¼zÃ¼nÃ¼ gÃ¶sterir - Hibrit Pomodoro Sistemi ile"""
    
    # === HÄ°BRÄ°T SÄ°STEM GÃœNCELLEMELERÄ° ===
    
    # Nefes egzersizi aktifse Ã¶nce onu kontrol et
    if st.session_state.breathing_active and st.session_state.breath_start_time:
        elapsed = time.time() - st.session_state.breath_start_time
        st.session_state.breath_time_remaining = max(0, 60 - elapsed)
        
        # SÃ¼re bittiyse otomatik durdur ve Pomodoro'yu devam ettir
        if st.session_state.breath_time_remaining <= 0:
            complete_breathing_exercise()
    
    # Normal Pomodoro timer gÃ¼ncellemesi (nefes sÄ±rasÄ±nda duraklatÄ±lmÄ±ÅŸ olabilir)
    if st.session_state.pomodoro_active and st.session_state.start_time and not st.session_state.breathing_active:
        elapsed = time.time() - st.session_state.start_time
        st.session_state.time_remaining = max(0, st.session_state.time_remaining - elapsed)
        st.session_state.start_time = time.time()
        
        # SÃ¼re bittiyse otomatik durdur
        if st.session_state.time_remaining <= 0:
            # SESLÄ° UYARI: Pomodoro bitti! ğŸ””
            play_pomodoro_finished_sound()
            complete_pomodoro(user_data)
    
    # Pomodoro tÃ¼rleri
    # Bilimsel Temelli Pomodoro Preset SeÃ§enekleri
    pomodoro_types = {
        'KÄ±sa Odak (25dk+5dk)': {
            'duration': 25, 
            'break_duration': 5, 
            'color': '#ff6b6b', 
            'icon': 'ğŸ…',
            'description': 'Standart Pomodoro - Ã‡oÄŸu Ã¶ÄŸrenci iÃ§in ideal baÅŸlangÄ±Ã§',
            'scientific_info': 'Beynin dikkat sÃ¼resi ortalama 20-25 dk. KÄ±sa molalar hafÄ±zayÄ± gÃ¼Ã§lendirir.'
        },
        'Standart Odak (35dk+10dk)': {
            'duration': 35, 
            'break_duration': 10, 
            'color': '#4ecdc4', 
            'icon': 'ğŸ“š',
            'description': 'Orta seviye konsantrasyon - AlÄ±ÅŸkanlÄ±k kazandÄ±ktan sonra',
            'scientific_info': 'Uzun odaklanma sÃ¼resi derin Ã¶ÄŸrenmeyi destekler. 10dk mola beynin dinlenmesi iÃ§in yeterli.'
        },
        'Derin Odak (50dk+15dk)': {
            'duration': 50, 
            'break_duration': 15, 
            'color': '#3742fa', 
            'icon': 'ğŸ§˜',
            'description': 'Ä°leri seviye - Zor konular iÃ§in Ã¶nerilen sÃ¼re',
            'scientific_info': 'Beynin maksimum odaklanma eÅŸiÄŸi 45-60dk. Bu sÃ¼re karmaÅŸÄ±k problemler iÃ§in idealdir.'
        },
        'Tam Konsantrasyon (90dk+25dk)': {
            'duration': 90, 
            'break_duration': 25, 
            'color': '#a55eea', 
            'icon': 'ğŸš€',
            'description': 'Uzman seviye - Ã‡ok zorlu konular ve sÄ±nav hazÄ±rlÄ±ÄŸÄ±',
            'scientific_info': 'Ultradian ritim dÃ¶ngÃ¼sÃ¼ ~90dk. Uzun molalar beyni tamamen yeniler.'
        }
    }
    
    # Timer gÃ¶sterimi
    col1, col2, col3 = st.columns([1, 2, 1])
    
    with col2:
        # Nefes egzersizi aktifse Ã¶zel arayÃ¼zÃ¼ gÃ¶ster
        if st.session_state.breathing_active:
            show_breathing_exercise()
        else:
            # Normal timer gÃ¶rÃ¼nÃ¼mÃ¼
            minutes = int(st.session_state.time_remaining // 60)
            seconds = int(st.session_state.time_remaining % 60)
            
            # GÃ¼venlik kontrolÃ¼: EÄŸer session'daki pomodoro_type geÃ§ersizse varsayÄ±lana dÃ¶n
            if st.session_state.pomodoro_type not in pomodoro_types:
                st.session_state.pomodoro_type = 'KÄ±sa Odak (25dk+5dk)'
                st.warning("âš ï¸ GeÃ§ersiz Pomodoro tÃ¼rÃ¼ tespit edildi, varsayÄ±lan ayar yÃ¼klendi.")
                st.rerun()
            
            timer_color = pomodoro_types[st.session_state.pomodoro_type]['color']
            
            st.markdown(f"""
            <style>
            .pomodoro-timer-container {{
                background: linear-gradient(135deg, var(--timer-color-light) 0%, var(--timer-color-medium) 100%);
                border: 4px solid var(--timer-color);
                border-radius: 50%;
                width: 250px;
                height: 250px;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                margin: 20px auto;
                box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            }}
            .pomodoro-time-display {{
                font-size: 48px;
                font-weight: bold;
                color: var(--timer-color);
                margin-bottom: 10px;
            }}
            .pomodoro-type-label {{
                font-size: 16px;
                color: var(--timer-color);
                opacity: 0.8;
            }}
            </style>
            <div class="pomodoro-timer-container" style="--timer-color: {timer_color}; --timer-color-light: {timer_color}22; --timer-color-medium: {timer_color}44;">
                <div class="pomodoro-time-display">{minutes:02d}:{seconds:02d}</div>
                <div class="pomodoro-type-label">{st.session_state.pomodoro_type.split('(')[0].strip()}</div>
            </div>
            """, unsafe_allow_html=True)
        
        # === HÄ°BRÄ°T SÄ°STEM KONTROL BUTONLARI ===
        col_btn1, col_btn2, col_btn3, col_btn4 = st.columns(4)
        
        with col_btn1:
            if not st.session_state.pomodoro_active:
                if st.button("ğŸŸ¢ BaÅŸla", type="primary", use_container_width=True):
                    start_pomodoro()
            else:
                if st.button("ğŸŸ  Duraklat", type="secondary", use_container_width=True):
                    pause_pomodoro()
        
        with col_btn2:
            if st.button("ğŸ”´ SÄ±fÄ±rla", use_container_width=True):
                reset_pomodoro()
        
        with col_btn3:
            # â­ HÄ°BRÄ°T SÄ°STEMÄ°N KALBI: NEFES AL BUTONU
            if st.session_state.pomodoro_active and not st.session_state.breathing_active:
                if st.button("ğŸ’¨ Nefes Al", type="primary", use_container_width=True):
                    start_hibrit_breathing()
            elif st.session_state.breathing_active:
                if st.button("â­ï¸ Atla", type="secondary", use_container_width=True):
                    complete_breathing_exercise()
            else:
                st.button("ğŸ’¨ Nefes Al", disabled=True, use_container_width=True, 
                         help="Ã–nce Pomodoro'yu baÅŸlatÄ±n")
        
        with col_btn4:
            if st.session_state.pomodoro_active and not st.session_state.breathing_active:
                if st.button("âœ… Tamamla", type="primary", use_container_width=True):
                    complete_pomodoro(user_data)
    
    st.markdown("---")
    
    # Pomodoro tÃ¼rÃ¼ seÃ§imi - Bilimsel temelli yaklaÅŸÄ±m
    st.markdown("### ğŸ§ª Pomodoro Preset'i SeÃ§in")
    
    cols = st.columns(2)
    for i, (pom_type, info) in enumerate(pomodoro_types.items()):
        with cols[i % 2]:
            # Aktif tÃ¼rÃ¼ vurgula
            is_active = st.session_state.pomodoro_type == pom_type
            
            # Mola sÃ¼resi sÄ±nÄ±rlandÄ±rmasÄ± kontrolÃ¼
            can_select = True
            warning_msg = ""
            
            if pom_type == 'Tam Konsantrasyon (90dk+25dk)' and not is_active:
                # 90 dakika Ã§alÄ±ÅŸma yapan herkes 25 dk mola alabilir
                warning_msg = "âš ï¸ 90dk yoÄŸun Ã§alÄ±ÅŸma sonrasÄ± uzun mola gerekli!"
            elif pom_type == 'Derin Odak (50dk+15dk)' and not is_active:
                # 50dk Ã§alÄ±ÅŸma yapan 15dk mola alabilir
                warning_msg = "ğŸ§ª 50dk derin odaklanma iÃ§in 15dk mola Ã¶nerilir!"
            elif pom_type in ['Standart Odak (35dk+10dk)', 'KÄ±sa Odak (25dk+5dk)'] and not is_active:
                # 25dk ve 35dk Ã§alÄ±ÅŸanlar uzun mola alamaz
                if st.session_state.pomodoro_type in ['Tam Konsantrasyon (90dk+25dk)', 'Derin Odak (50dk+15dk)']:
                    can_select = True  # Daha uzun sÃ¼reden kÄ±sa sÃ¼reye geÃ§ebilir
                warning_msg = f"ğŸš¨ {pom_type.split('(')[1].split(')')[0]} Ã§alÄ±ÅŸanlar uzun mola yapamaz!"
            
            # Preset butonu ve aÃ§Ä±klamasÄ±
            container = st.container()
            with container:
                if st.button(
                    f"{info['icon']} **{pom_type}**\n{info['description']}", 
                    key=f"pom_type_{i}",
                    use_container_width=True,
                    disabled=st.session_state.pomodoro_active or not can_select,
                    type="primary" if is_active else "secondary"
                ):
                    st.session_state.pomodoro_type = pom_type
                    st.session_state.time_remaining = info['duration'] * 60
                    st.success(f"ğŸ‰ {pom_type} seÃ§ildi! Ã‡alÄ±ÅŸma sÃ¼resi: {info['duration']}dk, Mola sÃ¼resi: {info['break_duration']}dk")
                    st.rerun()
                
                # Bilimsel aÃ§Ä±klama
                with st.expander(f"ğŸ”¬ Bilimsel Temeli - {pom_type.split('(')[0].strip()}", expanded=False):
                    st.info(f"ğŸ§ª **Bilimsel AÃ§Ä±klama:**\n{info['scientific_info']}")
                    
                    if warning_msg:
                        st.warning(warning_msg)
                        
                st.markdown("---")
    
    st.markdown("---")
    
    # Ã‡alÄ±ÅŸma konusu seÃ§imi
    st.markdown("### ğŸ“š Ders:")
    
    col1, col2 = st.columns(2)
    
    with col1:
        # Ders seÃ§imi
        student_field = user_data.get('field', '')
        available_subjects = get_subjects_by_field_yks(student_field)
        
        # Ã–zel kategoriler ekle
        special_categories = ["ğŸ“ Deneme SÄ±navÄ±", "ğŸ“‚ DiÄŸer"]
        all_subject_options = ["SeÃ§iniz..."] + available_subjects + special_categories
        
        selected_subject = st.selectbox(
            "Ders:",
            all_subject_options,
            index=0 if not st.session_state.current_subject else (
                all_subject_options.index(st.session_state.current_subject) 
                if st.session_state.current_subject in all_subject_options else 0
            ),
            disabled=st.session_state.pomodoro_active
        )
        
        if selected_subject != "SeÃ§iniz...":
            st.session_state.current_subject = selected_subject

    with col2:
        # Konu seÃ§imi - EÄŸer normal ders seÃ§ildiyse konu takipten konularÄ± getir
        if (st.session_state.current_subject and 
            st.session_state.current_subject not in ["SeÃ§iniz...", "ğŸ“ Deneme SÄ±navÄ±", "ğŸ“‚ DiÄŸer"]):
            
            # Konu takipten konularÄ± getir
            available_topics = get_topic_list(st.session_state.current_subject)
            topic_options = ["Manuel Konu GiriÅŸi..."] + available_topics
            
            selected_topic = st.selectbox(
                "Konu:",
                topic_options,
                index=0 if not st.session_state.current_topic else (
                    topic_options.index(st.session_state.current_topic) 
                    if st.session_state.current_topic in topic_options else 0
                ),
                disabled=st.session_state.pomodoro_active,
                help="Konu Takip'ten otomatik olarak konular getirildi. Manuel giriÅŸ iÃ§in 'Manuel Konu GiriÅŸi...' seÃ§in."
            )
            
            if selected_topic == "Manuel Konu GiriÅŸi...":
                # Manuel konu giriÅŸi
                manual_topic = st.text_input(
                    "Manuel Konu:",
                    value=st.session_state.current_topic if st.session_state.current_topic not in topic_options else "",
                    placeholder="Ã¶rn: Temel Kavramlar - Basamak",
                    disabled=st.session_state.pomodoro_active
                )
                if manual_topic:
                    st.session_state.current_topic = manual_topic
            else:
                if selected_topic and selected_topic != "Manuel Konu GiriÅŸi...":
                    # Konu takipten seÃ§ilen konuyu kÄ±salt (sadece konu adÄ±nÄ± gÃ¶ster)
                    if " | " in selected_topic:
                        topic_parts = selected_topic.split(" | ")
                        display_topic = topic_parts[-1]  # Son kÄ±smÄ± (gerÃ§ek konu adÄ±)
                    else:
                        display_topic = selected_topic
                    st.session_state.current_topic = display_topic
        else:
            # YKS CanlÄ± Takip'ten haftalÄ±k hedef konularÄ± ve tÃ¼m konularÄ± al
            student_field = user_data.get('field', '')
            survey_data = json.loads(user_data.get('yks_survey_data', '{}')) if user_data.get('yks_survey_data') else {}
            weekly_plan = get_weekly_topics_from_topic_tracking(user_data, student_field, survey_data)
            
            # HaftalÄ±k hedef konularÄ±
            weekly_target_topics = weekly_plan.get('new_topics', []) + weekly_plan.get('review_topics', [])
            
            # TÃ¼m konular (konu takipten)
            all_topics_raw = weekly_plan.get('all_topics', [])
            
            # Konu seÃ§eneklerini kategorize ederek hazÄ±rla
            topic_options = ["ğŸ”„ Yeni Konu SeÃ§..."]
            
            # 1. HaftalÄ±k Hedef Konular bÃ¶lÃ¼mÃ¼ (sadece konu isimleri)
            if weekly_target_topics:
                topic_options.append("â”€â”€â”€ ğŸ¯ HAFTALÄ°K HEDEF KONULAR â”€â”€â”€")
                for topic in weekly_target_topics[:10]:  # Max 10 konu
                    topic_name = topic.get('topic', topic.get('subject', str(topic)))
                    # Ã–ncelikli konularÄ± â­ ile vurgula
                    if topic.get('priority') == 'high':
                        topic_options.append(f"â­ {topic_name} (Ã–ncelikli)")
                    else:
                        topic_options.append(f"ğŸ¯ {topic_name}")
            
            # 2. TÃ¼m Konular bÃ¶lÃ¼mÃ¼
            if all_topics_raw:
                topic_options.append("â”€â”€â”€ ğŸ“š TÃœM KONULAR â”€â”€â”€")
                for topic in all_topics_raw[:15]:  # Max 15 konu
                    topic_name = topic.get('topic', topic.get('subject', str(topic)))
                    # Duplicate kontrolÃ¼
                    if f"ğŸ¯ {topic_name}" not in topic_options:
                        topic_options.append(f"ğŸ“š {topic_name}")
            
            # 3. Deneme SÄ±navÄ± seÃ§eneÄŸi
            topic_options.append("â”€â”€â”€ ğŸ“ Ã–ZELLEÅTÄ°RÄ°LMÄ°Å â”€â”€â”€")
            topic_options.append("ğŸ“ Deneme SÄ±navÄ±")
            
            # 4. DiÄŸer (Manuel) seÃ§eneÄŸi
            topic_options.append("ğŸ“‚ DiÄŸer")
            
            # Konu seÃ§imi dropdown
            selected_topic_option = st.selectbox(
                "Konu/AÃ§Ä±klama:",
                options=topic_options,
                index=0 if not st.session_state.current_topic else 
                      next((i for i, opt in enumerate(topic_options) 
                           if st.session_state.current_topic in opt), 0),
                disabled=st.session_state.pomodoro_active,
                key="topic_selection_pomodoro"
            )
            
            # SeÃ§ilen konuya gÃ¶re iÅŸlem yap
            if selected_topic_option.startswith("â”€â”€â”€"):
                # BaÅŸlÄ±k seÃ§ilmiÅŸse varsayÄ±lana dÃ¶n
                st.warning("âš ï¸ LÃ¼tfen bir konu seÃ§in, baÅŸlÄ±k seÃ§ilemez.")
                st.session_state.current_topic = ""
            elif selected_topic_option == "ğŸ“‚ DiÄŸer":
                # Manuel konu giriÅŸi
                manual_topic_input = st.text_input(
                    "Manuel Konu GiriÅŸi:",
                    value=st.session_state.current_topic if not any(
                        st.session_state.current_topic.startswith(prefix) for prefix in ["ğŸ¯ ", "ğŸ“ ", "ğŸ“š "]
                    ) else "",
                    placeholder="Ã¶rn: Ã–zet Ã‡Ä±karma, FormÃ¼l TekrarÄ±, Defter DÃ¼zenleme",
                    disabled=st.session_state.pomodoro_active,
                    key="manual_topic_pomodoro"
                )
                
                if manual_topic_input:
                    st.session_state.current_topic = manual_topic_input
            elif selected_topic_option == "ğŸ“ Deneme SÄ±navÄ±":
                # Deneme sÄ±navÄ± iÃ§in Ã¶zel alan
                deneme_input = st.text_input(
                    "Deneme SÄ±navÄ± DetayÄ±:",
                    value=st.session_state.current_topic if "Deneme" in str(st.session_state.current_topic) else "",
                    placeholder="Ã¶rn: TYT Deneme 5, AYT Mat Deneme 3, Fizik Konu Deneme",
                    disabled=st.session_state.pomodoro_active,
                    key="deneme_topic_pomodoro"
                )
                
                if deneme_input:
                    st.session_state.current_topic = f"Deneme: {deneme_input}"
            elif selected_topic_option != "ğŸ”„ Yeni Konu SeÃ§...":
                # Konu listelerinden seÃ§im yapÄ±ldÄ±
                if selected_topic_option.startswith("ğŸ¯ "):
                    # HaftalÄ±k hedef konular - Ã§alÄ±ÅŸma tÃ¼rÃ¼ seÃ§imi gÃ¶ster
                    base_topic = selected_topic_option.replace("ğŸ¯ ", "")
                    
                    # 2. AÅAMA: Ã‡alÄ±ÅŸma tÃ¼rÃ¼ seÃ§imi
                    st.markdown("#### ğŸ¯ Ã‡alÄ±ÅŸma TÃ¼rÃ¼ SeÃ§in:")
                    
                    study_type_options = [
                        "ğŸ“– Konu Ã‡alÄ±ÅŸmasÄ± - Yeni kavramlarÄ± Ã¶ÄŸrenme",
                        "ğŸ”„ Tekrar - Daha Ã¶nce Ã¶ÄŸrenilenlarÄ± pekiÅŸtirme", 
                        "âœï¸ Soru Ã‡Ã¶zÃ¼m - Pratik yapma ve test etme"
                    ]
                    
                    selected_study_type = st.selectbox(
                        "NasÄ±l Ã§alÄ±ÅŸacaksÄ±nÄ±z?",
                        options=study_type_options,
                        disabled=st.session_state.pomodoro_active,
                        key="study_type_selection_pomodoro"
                    )
                    
                    if selected_study_type:
                        # Ã‡alÄ±ÅŸma tÃ¼rÃ¼nÃ¼ parse et
                        study_type_short = selected_study_type.split(" - ")[0].replace("ğŸ“– ", "").replace("ğŸ”„ ", "").replace("âœï¸ ", "")
                        emoji = selected_study_type.split(" ")[0]
                        
                        # Final topic oluÅŸtur
                        st.session_state.current_topic = f"{emoji} {base_topic} ({study_type_short})"
                    
                    # HaftalÄ±k hedef konularÄ±ndan detay gÃ¶ster
                    selected_topic_detail = None
                    for topic in weekly_target_topics:
                        topic_name = topic.get('topic', topic.get('subject', str(topic)))
                        if base_topic == topic_name:
                            selected_topic_detail = topic
                            break
                    
                    if selected_topic_detail:
                        topic_subject = selected_topic_detail.get('subject', 'Bilinmiyor')
                        topic_priority = selected_topic_detail.get('priority', 'NORMAL')
                        topic_reason = selected_topic_detail.get('reason', 'HaftalÄ±k plan')
                        
                        priority_info = {
                            'HIGH': {'icon': 'ğŸ”´', 'name': 'YÃ¼ksek'},
                            'MEDIUM': {'icon': 'ğŸŸ¡', 'name': 'Orta'},
                            'NORMAL': {'icon': 'ğŸŸ¢', 'name': 'Normal'},
                            'LOW': {'icon': 'ğŸ”µ', 'name': 'DÃ¼ÅŸÃ¼k'},
                            'MINIMAL': {'icon': 'âšª', 'name': 'Minimal'}
                        }
                        
                        priority_data = priority_info.get(topic_priority, priority_info['NORMAL'])
                        
                        st.info(f"""
                        **ğŸ“š Ders:** {topic_subject}  
                        **âš¡ Ã–ncelik seviyesi:** {priority_data['icon']} {priority_data['name']}  
                        **ğŸ“‹ Neden bu hafta planÄ±nda:** {topic_reason}
                        """)
                        
                elif selected_topic_option.startswith("ğŸ“š "):
                    # TÃ¼m konular bÃ¶lÃ¼mÃ¼nden seÃ§im
                    clean_topic = selected_topic_option.replace("ğŸ“š ", "")
                    st.session_state.current_topic = clean_topic
                    
                    # TÃ¼m konularda ara
                    selected_topic_detail = None
                    if all_topics_raw:
                        for topic in all_topics_raw:
                            topic_name = topic.get('topic', topic.get('subject', str(topic)))
                            if clean_topic == topic_name:
                                selected_topic_detail = topic
                                break
                    
                    if selected_topic_detail:
                        topic_subject = selected_topic_detail.get('subject', 'Bilinmiyor')
                        st.info(f"**ğŸ“š Ders:** {topic_subject}")

            
            # EÄŸer hiÃ§bir konu seÃ§ilmemiÅŸse varsayÄ±lan deÄŸer
            if not st.session_state.current_topic and selected_topic_option == "ğŸ”„ Yeni Konu SeÃ§...":
                st.session_state.current_topic = ""
    
    # Bu haftanÄ±n hedef konularÄ±
    st.markdown("### ğŸ¯ HAFTALÄ°K HEDEF KONULAR - TAM MANTIK")
    
    # Algoritma aÃ§Ä±klamasÄ±
    with st.expander("ğŸ¤– HaftalÄ±k Hedef KonularÄ±n NasÄ±l Belirleniyor? (Algoritma MantÄ±ÄŸÄ±)", expanded=False):
        st.markdown("""
        Ä°ÅŸte haftalÄ±k hedef konularÄ±n tam olarak neye gÃ¶re belirlendiÄŸi:
        
        ## ğŸ”¥ 1. Ã–NCELIK SIRALAMASI (En Kritik)
        
        **A) Ders Ã–nem PuanlarÄ±:**
        - ğŸ”¢ **TYT Matematik:** 10 puan (En kritik)
        - ğŸ“ **TYT TÃ¼rkÃ§e:** 9 puan  
        - ğŸ¯ **AYT Matematik:** 10 puan
        - âš›ï¸ **TYT Fizik/Kimya:** 8 puan
        - ğŸ§  **TYT Felsefe/Din:** 4 puan (2-3. hafta sonra baÅŸlar)
        
        **B) HaftalÄ±k Konu Limitleri:**
        - ğŸ“Š **10 puan** â†’ 5 konu/hafta
        - ğŸ“Š **9 puan** â†’ 4 konu/hafta  
        - ğŸ“Š **8 puan** â†’ 3 konu/hafta
        - ğŸ“Š **7 puan** â†’ 2 konu/hafta
        - ğŸ“Š **4 puan** â†’ 1 konu/hafta
        
        ## ğŸ“Š 2. PERFORMANS DEÄERLENDÄ°RMESÄ°
        
        **Ã–ncelik Hesaplama FormÃ¼lÃ¼:**
        ```
        Base Puan + Deneme Boost + Anket Etkisi = Final Ã–ncelik
        ```
        
        **Net Seviyesine GÃ¶re:**
        - ğŸš¨ **0-5 net:** 85 puan (ACÄ°L - Ã‡ok zayÄ±f)
        - ğŸŸ¡ **6-8 net:** 70 puan (Ã–NCELÄ°KLÄ° - Temel)
        - ğŸŸ¢ **9-14 net:** 50 puan (NORMAL - Orta)
        - ğŸ”µ **15-18 net:** 30 puan (DÃœÅÃœK - Ä°yi)
        - ğŸ’ **18+ net:** 15 puan (MÄ°NÄ°MAL - Uzman)
        
        **Deneme Analizi Boost'u:**
        - Son 3 denemede %60'Ä±n altÄ±nda net â†’ **+20 puan boost**
        
        ## ğŸ”„ 3. YENÄ° vs TEKRAR KONULAR
        
        **Yeni Konular:**
        - Net deÄŸeri 14'Ã¼n altÄ±nda olan konular
        - Ders Ã¶nem sÄ±rasÄ±na gÃ¶re sÄ±ralÄ± seÃ§im
        - Her dersten limit kadar (1-5 konu)
        
        **Tekrar Konular:**
        - AralÄ±klÄ± tekrar sistemi (3-7-7-7-7 gÃ¼n)
        - ZamanÄ± gelen konular otomatik seÃ§ilir
        - Maksimum 8 tekrar konu/hafta
        
        ## ğŸ® 4. TYT/AYT GEÃ‡Ä°Å SÄ°STEMÄ°
        
        **AYT BaÅŸlatma KoÅŸullarÄ±:**
        - TYT matematik konularÄ±nÄ±n belirli oranÄ± tamamlanmÄ±ÅŸ olmalÄ±
        - TYT genel ilerlemesi yeterli seviyede olmalÄ±
        - Alan seÃ§imine uygun dersler aktif edilir
        
        ## ğŸ“ 5. ANKET VERÄ°SÄ° ETKÄ°SÄ°
        - ğŸ”¥ **Zor Dersler:** +10 puan boost
        - â¤ï¸ **Sevilen Dersler:** +15 puan boost
        - ğŸ˜ **Sevilmeyen Dersler:** -5 puan (hafif azalma)
        
        ## â° 6. DÄ°NAMÄ°K ZAMAN KONTROLÃœ
        - **Ä°lk 2 hafta:** Sadece yÃ¼ksek Ã¶ncelikli dersler (8+ puan)
        - **3. hafta sonrasÄ±:** DÃ¼ÅŸÃ¼k Ã¶ncelikli dersler de dahil edilir
        
        ## ğŸ¤– Ã–ZET: HAFTALÄ°K PLANLAMA ALGORÄ°TMASI
        
        1. ğŸ“‹ TÃ¼m dersleri Ã¶ncelik sÄ±rasÄ±na gÃ¶re sÄ±rala
        2. ğŸ¯ Her dersten net 14'Ã¼n altÄ±ndaki konularÄ± al
        3. âš–ï¸ Ders Ã¶nemine gÃ¶re haftalÄ±k limit uygula
        4. ğŸ”„ Tekrar zamanÄ± gelmiÅŸ 8 konuyu ekle
        5. âœ… Toplam ~15-20 konu haftalÄ±k hedef olur
        
        **Bu sistem sayesinde:** ZayÄ±f konular Ã¶ncelenirken, Ã¶nemli derslerden daha fazla konu alÄ±nÄ±r ve tekrarlar da unutulmuyor! ğŸ¯
        """)
    
    # KullanÄ±cÄ± verilerini al
    student_field = user_data.get('field', '')
    survey_data = json.loads(user_data.get('survey_data', '{}')) if user_data.get('survey_data') else {}
    
    # HaftalÄ±k hedef konularÄ± Ã§ek
    weekly_plan = get_weekly_topics_from_topic_tracking(user_data, student_field, survey_data)
    weekly_target_topics = weekly_plan.get('new_topics', []) + weekly_plan.get('review_topics', [])
    
    if weekly_target_topics:
        # HaftalÄ±k hedef konularÄ±nÄ± gÃ¶rÃ¼ntÃ¼le
        st.markdown("#### ğŸ“‹ YKS CanlÄ± Takip'ten Hedef Konular")
        
        # Bu haftaki pomodorolardan konu bazÄ±nda ilerleme hesapla
        topic_progress_in_pomodoros = {}
        
        # KullanÄ±cÄ±nÄ±n tÃ¼m pomodoro geÃ§miÅŸini al
        try:
            pomodoro_history_str = user_data.get('pomodoro_history', '[]')
            all_pomodoros = json.loads(pomodoro_history_str) if pomodoro_history_str else []
            
            # Bu haftanÄ±n baÅŸlangÄ±cÄ±nÄ± hesapla (Pazartesi) - DÄ°NAMÄ°K
            week_info = get_current_week_info()
            week_start = week_info['monday'].date()
            
            # Bu haftaki pomodorolardan konularÄ± say
            this_week_pomodoros = [
                p for p in all_pomodoros 
                if datetime.fromisoformat(p['timestamp']).date() >= week_start
            ]
            
            for p in this_week_pomodoros:
                topic = p.get('topic', '')
                if topic and topic != 'BelirtilmemiÅŸ':
                    topic_progress_in_pomodoros[topic] = topic_progress_in_pomodoros.get(topic, 0) + 1
                    
        except Exception as e:
            st.warning("HaftalÄ±k ilerleme hesaplanÄ±rken hata oluÅŸtu.")
            topic_progress_in_pomodoros = {}
        
        # Hedef konularÄ± tabloda gÃ¶ster
        cols = st.columns([3, 1, 1, 1])
        
        with cols[0]:
            st.markdown("**ğŸ“š Hedef Konu**")
        with cols[1]:
            st.markdown("**ğŸ¯ Net**")
        with cols[2]:
            st.markdown("**ğŸ… Bu Hafta**")
        with cols[3]:
            st.markdown("**ğŸ“Š Durum**")
        
        st.markdown("---")
        
        for i, topic in enumerate(weekly_target_topics[:8]):  # Max 8 konu gÃ¶ster
            cols = st.columns([3, 1, 1, 1])
            
            # Konu adÄ±nÄ± kÄ±salt
            topic_display = f"{topic['subject']} - {topic.get('detail', '')}"
            if len(topic_display) > 40:
                topic_display = topic_display[:37] + "..."
            
            # Bu konuda bu hafta kaÃ§ pomodoro yapÄ±ldÄ±
            pomodoros_this_week = topic_progress_in_pomodoros.get(topic.get('detail', ''), 0)
            
            # Net deÄŸerine gÃ¶re renk
            if topic.get('net', 0) < 5:
                status_color = "ğŸ”´"
                status_text = "ZayÄ±f"
            elif topic.get('net', 0) < 10:
                status_color = "ğŸŸ¡"
                status_text = "Orta"
            elif topic.get('net', 0) < 14:
                status_color = "ğŸŸ "
                status_text = "Ä°yi"
            else:
                status_color = "ğŸŸ¢"
                status_text = "Ã‡ok Ä°yi"
            
            with cols[0]:
                st.write(f"**{topic_display}**")
            with cols[1]:
                st.write(f"{topic.get('net', 0)}")
            with cols[2]:
                if pomodoros_this_week > 0:
                    st.write(f"**{pomodoros_this_week}** ğŸ…")
                else:
                    st.write("-")
            with cols[3]:
                st.write(f"{status_color} {status_text}")
        
        # HaftalÄ±k Ã¶zet
        st.markdown("---")
        
        total_weekly_pomodoros = sum(topic_progress_in_pomodoros.values())
        completed_today = len(st.session_state.daily_pomodoros)
        
        summary_col1, summary_col2, summary_col3 = st.columns(3)
        
        with summary_col1:
            st.metric("ğŸ… BugÃ¼n", completed_today)
        with summary_col2:
            st.metric("ğŸ“… Bu Hafta", total_weekly_pomodoros)
        with summary_col3:
            topics_worked_this_week = len([k for k, v in topic_progress_in_pomodoros.items() if v > 0])
            st.metric("ğŸ“š Ã‡alÄ±ÅŸÄ±lan Konu", f"{topics_worked_this_week}/{len(weekly_target_topics)}")
        
        # Motivasyon mesajÄ±
        if topics_worked_this_week >= len(weekly_target_topics) // 2:
            st.success("ğŸ‰ Harika gidiyorsun! HaftalÄ±k hedeflerinin yarÄ±sÄ±ndan fazlasÄ±nda Ã§alÄ±ÅŸtÄ±n!")
        elif topics_worked_this_week > 0:
            st.info("ğŸ’ª Ä°yi baÅŸlangÄ±Ã§! Hedef konularÄ±nda Ã§alÄ±ÅŸmaya devam et!")
        else:
            st.warning("ğŸ¯ Bu hafta henÃ¼z hedef konularÄ±nda Ã§alÄ±ÅŸmadÄ±n. BaÅŸlamak iÃ§in ÅŸimdi gÃ¼zel bir zaman!")
            
    else:
        # Hedef konu bulunamadÄ±ysa alternatif gÃ¶ster
        completed_today = len(st.session_state.daily_pomodoros)
        
        st.info("ğŸ“‹ Bu hafta iÃ§in hedef konu bulunamadÄ±. **YKS CanlÄ± Takip** sekmesinde konularÄ±nÄ±zÄ± deÄŸerlendirin ve haftalÄ±k programÄ±nÄ±zÄ± oluÅŸturun.")
        
        # Basit gÃ¼nlÃ¼k metrik
        summary_col1, summary_col2 = st.columns(2)
        
        with summary_col1:
            st.metric("ğŸ… BugÃ¼n Tamamlanan", completed_today)
        with summary_col2:
            # Son 7 gÃ¼nlÃ¼k pomodoro sayÄ±sÄ±
            try:
                pomodoro_history_str = user_data.get('pomodoro_history', '[]')
                all_pomodoros = json.loads(pomodoro_history_str) if pomodoro_history_str else []
                
                week_ago = datetime.now().date() - timedelta(days=7)
                weekly_count = len([
                    p for p in all_pomodoros 
                    if datetime.fromisoformat(p['timestamp']).date() >= week_ago
                ])
                
                st.metric("ğŸ“… Son 7 GÃ¼n", weekly_count)
            except:
                st.metric("ğŸ“… Son 7 GÃ¼n", "?")
    
    # Auto-refresh aktif timer iÃ§in
    if st.session_state.pomodoro_active:
        time.sleep(1)
        st.rerun()

def start_pomodoro():
    """Pomodoro'yu baÅŸlat"""
    if not st.session_state.current_subject or not st.session_state.current_topic:
        st.error("ğŸ˜± LÃ¼tfen ders ve konu seÃ§in!")
        return
    
    st.session_state.pomodoro_active = True
    st.session_state.start_time = time.time()
    st.success(f"âœ… {st.session_state.pomodoro_type} baÅŸlatÄ±ldÄ±!")

def pause_pomodoro():
    """Pomodoro'yu duraklat"""
    st.session_state.pomodoro_active = False
    st.session_state.start_time = None
    st.warning("â¸ï¸ Pomodoro duraklatÄ±ldÄ±")

def reset_pomodoro():
    """Pomodoro'yu sÄ±fÄ±rla"""
    st.session_state.pomodoro_active = False
    st.session_state.start_time = None
    
    # SÃ¼reyi tÃ¼re gÃ¶re sÄ±fÄ±rla
    duration_map = {
        'KÄ±sa Odak (25dk+5dk)': 25,
        'Standart Odak (35dk+10dk)': 35,
        'Derin Odak (50dk+15dk)': 50,
        'Tam Konsantrasyon (90dk+25dk)': 90
    }
    
    # GÃ¼venlik kontrolÃ¼ ile sÃ¼re ayarla
    if st.session_state.pomodoro_type in duration_map:
        st.session_state.time_remaining = duration_map[st.session_state.pomodoro_type] * 60
    else:
        # EÄŸer preset bulunamazsa varsayÄ±lana dÃ¶n
        st.session_state.pomodoro_type = 'KÄ±sa Odak (25dk+5dk)'
        st.session_state.time_remaining = 25 * 60
        st.warning("âš ï¸ GeÃ§ersiz preset tespit edildi, varsayÄ±lan ayarlara dÃ¶nÃ¼ldÃ¼.")
    
    st.info("ğŸ”„ Pomodoro sÄ±fÄ±rlandÄ±")

def complete_pomodoro(user_data):
    """Pomodoro'yu tamamla ve kaydet - SADECE KONU "Ä°YÄ°" SEVÄ°YEYE GELÄ°RSE TAMAMLANMIÅ SAYILIR"""
    # Konu seviyesi kontrolÃ¼ - Ã‡OK Ã–NEMLÄ°!
    current_subject = st.session_state.current_subject
    current_topic = st.session_state.current_topic
    
    # Konu takipte seviye kontrolÃ¼ yap
    topic_key = f"{current_subject}_{current_topic}".replace(" ", "_")
    topic_level = user_data.get('topic_levels', {}).get(topic_key, 'baÅŸlangÄ±Ã§')
    
    # SADECE "iyi" veya "mÃ¼kemmel" seviyeye geldiyse tamamlanmÄ±ÅŸ say
    if topic_level not in ['iyi', 'mÃ¼kemmel']:
        # Pomodoro'yu durdur ama tamamlanmÄ±ÅŸ sayma!
        st.session_state.pomodoro_active = False
        st.session_state.start_time = None
        
        st.warning(f"""
        âš ï¸ **Pomodoro tamamlandÄ± ama konu henÃ¼z tamamlanmÄ±ÅŸ sayÄ±lmadÄ±!**
        
        **ğŸ“š Konu:** {current_topic}
        **ğŸ“Š Mevcut Seviye:** {topic_level.title()}
        **ğŸ¯ Gerekli Seviye:** Ä°yi veya MÃ¼kemmel
        
        **Konu takip bÃ¶lÃ¼mÃ¼nden seviyenizi "Ä°yi"ye Ã§Ä±karÄ±n, sonra pomodoro tamamlanmÄ±ÅŸ sayÄ±lacak!**
        """)
        
        # KÄ±smi kayÄ±t oluÅŸtur (tamamlanmamÄ±ÅŸ)
        pomodoro_record = {
            'timestamp': datetime.now().isoformat(),
            'type': st.session_state.pomodoro_type,
            'subject': current_subject,
            'topic': current_topic,
            'completed': False,  # TAMAMLANMADI!
            'reason': f'Konu seviyesi yetersiz: {topic_level}'
        }
        
        # GÃ¼nlÃ¼k listeye ekle (tamamlanmamÄ±ÅŸ olarak)
        st.session_state.daily_pomodoros.append(pomodoro_record)
        save_pomodoro_to_user_data(user_data, pomodoro_record)
        
        # Timer'i sÄ±fÄ±rla
        duration_map = {
            'KÄ±sa Odak (25dk+5dk)': 25,
            'Standart Odak (35dk+10dk)': 35,
            'Derin Odak (50dk+15dk)': 50,
            'Tam Konsantrasyon (90dk+25dk)': 90
        }
        
        if st.session_state.pomodoro_type in duration_map:
            st.session_state.time_remaining = duration_map[st.session_state.pomodoro_type] * 60
        else:
            st.session_state.pomodoro_type = 'KÄ±sa Odak (25dk+5dk)'
            st.session_state.time_remaining = 25 * 60
        
        return  # Fonksiyondan Ã§Ä±k - tam tamamlanma iÅŸlemi yapma
    
    # KONU SEVÄ°YESÄ° YETERLÄ° - NORMAL TAMAMLANMA Ä°ÅLEMÄ°
    st.session_state.pomodoro_active = False
    st.session_state.start_time = None
    
    # KayÄ±t oluÅŸtur (GERÃ‡EKTEN TAMAMLANDI)
    pomodoro_record = {
        'timestamp': datetime.now().isoformat(),
        'type': st.session_state.pomodoro_type,
        'subject': current_subject,
        'topic': current_topic,
        'completed': True,
        'topic_level': topic_level  # Seviye bilgisi ekle
    }
    
    # GÃ¼nlÃ¼k listeye ekle
    st.session_state.daily_pomodoros.append(pomodoro_record)
    
    # KullanÄ±cÄ± verisine kaydet
    save_pomodoro_to_user_data(user_data, pomodoro_record)
    
    # Timer'i sÄ±fÄ±rla
    duration_map = {
        'KÄ±sa Odak (25dk+5dk)': 25,
        'Standart Odak (35dk+10dk)': 35,
        'Derin Odak (50dk+15dk)': 50,
        'Tam Konsantrasyon (90dk+25dk)': 90
    }
    
    # GÃ¼venlik kontrolÃ¼ ile sÃ¼re ayarla
    if st.session_state.pomodoro_type in duration_map:
        st.session_state.time_remaining = duration_map[st.session_state.pomodoro_type] * 60
    else:
        # EÄŸer preset bulunamazsa varsayÄ±lana dÃ¶n
        st.session_state.pomodoro_type = 'KÄ±sa Odak (25dk+5dk)'
        st.session_state.time_remaining = 25 * 60
    
    # BaÅŸarÄ± mesajÄ± ve mola baÅŸlangÄ±Ã§ sesi
    break_duration = {
        'KÄ±sa Odak (25dk+5dk)': 5,
        'Standart Odak (35dk+10dk)': 10,
        'Derin Odak (50dk+15dk)': 15,
        'Tam Konsantrasyon (90dk+25dk)': 25
    }
    
    current_break = break_duration.get(st.session_state.pomodoro_type, 5)
    st.success(f"ğŸ‰ {st.session_state.pomodoro_type} tamamlandÄ±! Åimdi {current_break} dakika mola zamanÄ±! ğŸ’¨")
    
    # Gamification: Pomodoro tamamlama puanÄ±
    try:
        pomodoro_points = {
            'HÄ±zlÄ± Odak (25dk+5dk)': 15,
            'Standart Odak (35dk+10dk)': 20,
            'Derin Odak (50dk+15dk)': 30,
            'Tam Konsantrasyon (90dk+25dk)': 50
        }
        points = award_points("topic_completion", 3)  # Orta zorluk
        st.info(f"â­ Pomodoro Ã¶dÃ¼lÃ¼: +{points} puan kazandÄ±n!")
        
        # Ä°statistikleri gÃ¼ncelle
        if 'gamification' in st.session_state:
            st.session_state.gamification['stats']['total_study_time'] += int(st.session_state.pomodoro_type.split('(')[1].split('dk')[0])
    except:
        pass
    
    # SESLÄ° UYARI: Mola baÅŸladÄ±! ğŸ””
    play_break_start_sound()
    
    # YENI Ã–ZELLÄ°K: Tamamlanan pomodoro'yu haftalÄ±k programa ekle
    add_pomodoro_to_weekly_program(user_data, pomodoro_record)
    
    st.balloons()

def add_pomodoro_to_weekly_program(user_data, pomodoro_record):
    """Tamamlanan pomodoro'yu haftalÄ±k programa otomatik ekler"""
    try:
        # GÃ¼ncel tarih bilgisini al
        now = datetime.now()
        current_day_tr = {
            'Monday': 'PAZARTESÄ°',
            'Tuesday': 'SALI', 
            'Wednesday': 'Ã‡ARÅAMBA',
            'Thursday': 'PERÅEMBE',
            'Friday': 'CUMA',
            'Saturday': 'CUMARTESÄ°',
            'Sunday': 'PAZAR'
        }
        
        current_day = current_day_tr.get(now.strftime('%A'), 'PAZARTESÄ°')
        current_time = now.strftime('%H:%M')
        
        # Session state'te day_plans yoksa oluÅŸtur
        if 'day_plans' not in st.session_state:
            days = ["PAZARTESÄ°", "SALI", "Ã‡ARÅAMBA", "PERÅEMBE", "CUMA", "CUMARTESÄ°", "PAZAR"]
            st.session_state.day_plans = {day: [] for day in days}
        
        # Pomodoro bilgilerini al
        subject = pomodoro_record.get('subject', 'Genel')
        topic = pomodoro_record.get('topic', 'BelirtilmemiÅŸ')
        pomodoro_type = pomodoro_record.get('type', 'KÄ±sa Odak (25dk+5dk)')
        
        # SÃ¼reyi hesapla
        duration_map = {
            'KÄ±sa Odak (25dk+5dk)': '25dk',
            'Standart Odak (35dk+10dk)': '35dk',
            'Derin Odak (50dk+15dk)': '50dk',
            'Tam Konsantrasyon (90dk+25dk)': '90dk'
        }
        duration = duration_map.get(pomodoro_type, '25dk')
        
        # HaftalÄ±k programa eklenecek Ã¶ÄŸeyi oluÅŸtur
        program_item = {
            'subject': subject,
            'topic': f"ğŸ… {topic}",  # Pomodoro emojisi ile iÅŸaretle
            'detail': f"Pomodoro ({duration}) - {current_time}",
            'time': f"{current_time} (ğŸ… {duration})",
            'priority': 'COMPLETED',  # TamamlanmÄ±ÅŸ Ã¶ÄŸe olarak iÅŸaretle
            'auto_added': True  # Otomatik eklendiÄŸini belirt
        }
        
        # BugÃ¼nÃ¼n planÄ±na ekle
        if current_day in st.session_state.day_plans:
            st.session_state.day_plans[current_day].append(program_item)
            
            # BaÅŸarÄ± mesajÄ±nÄ± gÃ¶ster
            st.success(f"âœ… Tamamlanan pomodoro **{current_day}** gÃ¼nÃ¼ne otomatik eklendi!")
            st.info(f"ğŸ“… **Konu:** {topic} | **SÃ¼re:** {duration} | **Saat:** {current_time}")
        
    except Exception as e:
        st.warning(f"âš ï¸ HaftalÄ±k programa ekleme sÄ±rasÄ±nda hata: {e}")

def save_pomodoro_to_user_data(user_data, pomodoro_record):
    """Pomodoro kaydÄ±nÄ± kullanÄ±cÄ± verisine kaydet"""
    try:
        # Mevcut pomodoro verilerini yÃ¼kle
        pomodoro_data_str = user_data.get('pomodoro_history', '[]')
        pomodoro_history = json.loads(pomodoro_data_str) if pomodoro_data_str else []
        
        # Yeni kaydÄ± ekle
        pomodoro_history.append(pomodoro_record)
        
        # Son 100 kaydÄ± tut (performans iÃ§in)
        if len(pomodoro_history) > 100:
            pomodoro_history = pomodoro_history[-100:]
        
        # KullanÄ±cÄ± verisini gÃ¼ncelle
        update_user_in_firebase(st.session_state.current_user, 
                          {'pomodoro_history': json.dumps(pomodoro_history)})
        
        # ğŸš€ OPTÄ°MÄ°ZE: update_user_in_firebase() zaten session state'i gÃ¼nceller
        
    except Exception as e:
        st.error(f"Pomodoro kaydÄ± kaydedilirken hata: {e}")

def show_daily_pomodoro_stats(user_data):
    """Hibrit Pomodoro istatistiklerini gÃ¶ster"""
    st.markdown("### ğŸ“Š BugÃ¼nkÃ¼ Hibrit Pomodoro Ä°statistikleri")
    
    completed_today = len(st.session_state.daily_pomodoros)
    breathing_used_today = len([log for log in st.session_state.breathing_usage_log 
                              if log['timestamp'][:10] == datetime.now().date().isoformat()])
    
    if st.session_state.daily_pomodoros or breathing_used_today > 0:
        # Ä°statistik metrikleri
        col1, col2, col3, col4 = st.columns(4)
        
        # Pomodoro tÃ¼rlerine gÃ¶re sÃ¼re hesaplama
        duration_map = {
            'KÄ±sa Odak (25dk+5dk)': 25,
            'Standart Odak (35dk+10dk)': 35,
            'Derin Odak (50dk+15dk)': 50,
            'Tam Konsantrasyon (90dk+25dk)': 90
        }
        
        # Ders bazÄ±nda Ã§alÄ±ÅŸma sÃ¼relerini hesapla
        subject_times = {}
        topic_counts = {}
        total_minutes = 0
        
        for p in st.session_state.daily_pomodoros:
            subject = p['subject']
            topic = p.get('topic', 'BelirtilmemiÅŸ')
            pomodoro_type = p.get('type', 'KÄ±sa Odak (25dk+5dk)')
            
            # SÃ¼reyi hesapla
            duration = duration_map.get(pomodoro_type, 25)
            total_minutes += duration
            
            # Ders bazÄ±nda topla
            if subject not in subject_times:
                subject_times[subject] = 0
            subject_times[subject] += duration
            
            # Konu sayÄ±sÄ±nÄ± topla
            if subject not in topic_counts:
                topic_counts[subject] = {}
            if topic not in topic_counts[subject]:
                topic_counts[subject][topic] = 0
            topic_counts[subject][topic] += 1
        
        hours = total_minutes // 60
        minutes = total_minutes % 60
        
        with col1:
            st.metric("ğŸ… Tamamlanan", completed_today)
        with col2:
            st.metric("ğŸ’¨ Nefes MolasÄ±", breathing_used_today)
        with col3:
            st.metric("â° Toplam SÃ¼re", f"{hours}s {minutes}dk")
        with col4:
            # HaftalÄ±k hedef konular bazÄ±nda ilerleme hesapla
            try:
                student_field = user_data.get('field', '')
                survey_data = json.loads(user_data.get('survey_data', '{}')) if user_data.get('survey_data') else {}
                weekly_plan = get_weekly_topics_from_topic_tracking(user_data, student_field, survey_data)
                weekly_target_topics = weekly_plan.get('new_topics', []) + weekly_plan.get('review_topics', [])
                
                if weekly_target_topics:
                    # Bu haftaki pomodorolardan konu bazlÄ± ilerleme
                    pomodoro_history_str = user_data.get('pomodoro_history', '[]')
                    all_pomodoros = json.loads(pomodoro_history_str) if pomodoro_history_str else []
                    
                    # Bu haftanÄ±n baÅŸlangÄ±cÄ±nÄ± hesapla - DÄ°NAMÄ°K
                    week_info = get_current_week_info()
                    week_start = week_info['monday'].date()
                    
                    this_week_pomodoros = [
                        p for p in all_pomodoros 
                        if datetime.fromisoformat(p['timestamp']).date() >= week_start
                    ]
                    
                    topic_progress_in_pomodoros = {}
                    for p in this_week_pomodoros:
                        topic = p.get('topic', '')
                        if topic and topic != 'BelirtilmemiÅŸ':
                            topic_progress_in_pomodoros[topic] = topic_progress_in_pomodoros.get(topic, 0) + 1
                    
                    topics_worked = len([k for k, v in topic_progress_in_pomodoros.items() if v > 0])
                    weekly_progress = (topics_worked / len(weekly_target_topics)) * 100 if weekly_target_topics else 0
                    
                    st.metric("ğŸ¯ HaftalÄ±k Ä°lerleme", f"%{weekly_progress:.1f}")
                else:
                    st.metric("ğŸ¯ HaftalÄ±k Ä°lerleme", "Hedef yok")
            except:
                st.metric("ğŸ¯ HaftalÄ±k Ä°lerleme", "?")
        
        
        # === DERS BAZINDA DETAYLAR ===
        st.markdown("#### ğŸ“š BugÃ¼nkÃ¼ Ders DetaylarÄ±")
        
        if subject_times:
            # Ders tablosu
            col_table, col_chart = st.columns([1, 1])
            
            with col_table:
                st.markdown("**Ders BazÄ±nda Ã‡alÄ±ÅŸma SÃ¼releri:**")
                
                for subject in sorted(subject_times.keys()):
                    minutes_studied = subject_times[subject]
                    hours_studied = minutes_studied // 60
                    mins_studied = minutes_studied % 60
                    
                    time_str = f"{hours_studied}s {mins_studied}dk" if hours_studied > 0 else f"{mins_studied}dk"
                    
                    # Emoji seÃ§imi
                    if subject.startswith("ğŸ“"):
                        emoji = "ğŸ“"
                    elif subject.startswith("ğŸ“‚"):
                        emoji = "ğŸ“‚"
                    elif "Matematik" in subject:
                        emoji = "ğŸ”¢"
                    elif "Fizik" in subject:
                        emoji = "âš›ï¸"
                    elif "Kimya" in subject:
                        emoji = "ğŸ§ª"
                    elif "Biyoloji" in subject:
                        emoji = "ğŸ§¬"
                    elif "TÃ¼rkÃ§e" in subject or "Edebiyat" in subject:
                        emoji = "ğŸ“–"
                    else:
                        emoji = "ğŸ“š"
                    
                    st.write(f"{emoji} **{subject}**: {time_str}")
                    
                    # Konu detaylarÄ±
                    if subject in topic_counts:
                        for topic, count in topic_counts[subject].items():
                            if topic and topic != "BelirtilmemiÅŸ":
                                st.write(f"    â€¢ {topic}: {count} pomodoro")
            
            with col_chart:
                # Pasta grafik
                if len(subject_times) > 1:
                    subject_df = pd.DataFrame([
                        {'Ders': subject, 'Dakika': minutes} 
                        for subject, minutes in subject_times.items()
                    ])
                    fig = px.pie(subject_df, values='Dakika', names='Ders', 
                                title='BugÃ¼nkÃ¼ Ã‡alÄ±ÅŸma SÃ¼resi DaÄŸÄ±lÄ±mÄ±')
                    safe_plotly_chart(fig, use_container_width=True, height=400)
        
        # === TOPLAM Ä°STATÄ°STÄ°KLER (TÃœM ZAMANLAR) ===
        st.markdown("#### ğŸ† Toplam Ä°statistikler")
        
        # KullanÄ±cÄ± verisinden geÃ§miÅŸ pomodoro'larÄ± yÃ¼kle
        try:
            pomodoro_history_str = user_data.get('pomodoro_history', '[]')
            all_pomodoros = json.loads(pomodoro_history_str) if pomodoro_history_str else []
            
            if all_pomodoros:
                # Toplam hesaplamalar
                total_all_time = 0
                subject_totals = {}
                total_count = len(all_pomodoros)
                
                for p in all_pomodoros:
                    pomodoro_type = p.get('type', 'KÄ±sa Odak (25dk+5dk)')
                    subject = p.get('subject', 'BelirtilmemiÅŸ')
                    duration = duration_map.get(pomodoro_type, 25)
                    total_all_time += duration
                    
                    if subject not in subject_totals:
                        subject_totals[subject] = 0
                    subject_totals[subject] += duration
                
                total_hours = total_all_time // 60
                total_mins = total_all_time % 60
                
                col_total1, col_total2, col_total3 = st.columns(3)
                
                with col_total1:
                    st.metric("ğŸ¯ Toplam Pomodoro", total_count)
                with col_total2:
                    st.metric("â° Toplam Ã‡alÄ±ÅŸma", f"{total_hours}s {total_mins}dk")
                with col_total3:
                    # En Ã§ok Ã§alÄ±ÅŸÄ±lan ders
                    if subject_totals:
                        top_subject = max(subject_totals, key=subject_totals.get)
                        st.metric("ğŸ… En Ã‡ok Ã‡alÄ±ÅŸÄ±lan", top_subject.split()[0] + "...")
                
                # Son 7 gÃ¼nÃ¼n istatistikleri - DÄ°NAMÄ°K
                week_info = get_current_week_info()
                today = week_info['today'].date()
                last_week_pomodoros = [
                    p for p in all_pomodoros 
                    if (today - datetime.fromisoformat(p['timestamp']).date()).days <= 7
                ]
                
                if last_week_pomodoros:
                    week_total = sum(duration_map.get(p.get('type', 'KÄ±sa Odak (25dk+5dk)'), 25) 
                                   for p in last_week_pomodoros)
                    week_hours = week_total // 60
                    week_mins = week_total % 60
                    avg_daily = week_total / 7
                    
                    st.markdown("**ğŸ“… Son 7 GÃ¼n:**")
                    st.write(f"â€¢ Toplam: {len(last_week_pomodoros)} pomodoro ({week_hours}s {week_mins}dk)")
                    st.write(f"â€¢ GÃ¼nlÃ¼k ortalama: {avg_daily:.1f} dk")
                    
        except Exception as e:
            st.warning("Toplam istatistikler yÃ¼klenirken bir hata oluÅŸtu.")
        
        # === HÄ°BRÄ°T SÄ°STEM ANALÄ°ZÄ° ===
        if breathing_used_today > 0:
            st.markdown("#### ğŸ§  Hibrit Sistem Analizi")
            
            # Hangi derslerde daha Ã§ok nefes molasÄ± kullanÄ±ldÄ±
            today_breathing_logs = [log for log in st.session_state.breathing_usage_log 
                                   if log['timestamp'][:10] == datetime.now().date().isoformat()]
            
            subject_breathing = {}
            motivation_type_count = {'quote': 0, 'tip': 0, 'breathing': 0}
            
            for log in today_breathing_logs:
                subject = log['subject']
                subject_breathing[subject] = subject_breathing.get(subject, 0) + 1
                motivation_type_count[log['motivation_type']] += 1
            
            col_a, col_b = st.columns(2)
            
            with col_a:
                st.markdown("**ğŸ“š Derslerde Nefes KullanÄ±mÄ±:**")
                for subject, count in subject_breathing.items():
                    st.write(f"â€¢ {subject}: {count} kez")
            
            with col_b:
                st.markdown("**ğŸ’­ Motivasyon TÃ¼rÃ¼ DaÄŸÄ±lÄ±mÄ±:**")
                st.write(f"â€¢ Motivasyon SÃ¶zleri: {motivation_type_count['quote']}")
                st.write(f"â€¢ Mikro Ä°puÃ§larÄ±: {motivation_type_count['tip']}")
                st.write(f"â€¢ Nefes Egzersizleri: {motivation_type_count['breathing']}")
            
            # AkÄ±llÄ± Ã¶neriler
            avg_breathing_per_pomodoro = breathing_used_today / completed_today if completed_today > 0 else 0
            
            if breathing_used_today > 4:
                st.warning("ğŸ’¡ **Hibrit Analiz:** BugÃ¼n nefes sistemini sÄ±kÃ§a kullandÄ±nÄ±z. Bu, odaklanma zorluÄŸu yaÅŸadÄ±ÄŸÄ±nÄ±zÄ± gÃ¶sterebilir. Bu normal ve saÄŸlÄ±klÄ± bir yaklaÅŸÄ±m! Belki Ã§alÄ±ÅŸma ortamÄ±nÄ±zÄ± kontrol etmek ya da ara verme sÄ±klÄ±ÄŸÄ±nÄ± artÄ±rmak faydalÄ± olabilir.")
            elif breathing_used_today > 0 and avg_breathing_per_pomodoro < 1:
                st.info("ğŸ¯ **Hibrit Analiz:** Nefes sistemini dengeli ÅŸekilde kullanÄ±yorsunuz. Bu, Ã¶z-farkÄ±ndalÄ±ÄŸÄ±nÄ±zÄ±n yÃ¼ksek olduÄŸunu gÃ¶steriyor!")
            elif breathing_used_today == 0 and completed_today > 3:
                st.success("ğŸ† **Hibrit Analiz:** BugÃ¼n hibrit sistemi kullanmadan harika bir performans sergiledinin! Odaklanma beceriniz geliÅŸiyor.")

    else:
        st.info("ğŸ“Š BugÃ¼n henÃ¼z hibrit pomodoro tamamlanmamÄ±ÅŸ. Ä°lk pomodoro'nuzu baÅŸlatÄ±n!")

def show_pomodoro_history(user_data):
    """Pomodoro geÃ§miÅŸini gÃ¶ster"""
    st.markdown("### ğŸ“… Ã‡alÄ±ÅŸma GeÃ§miÅŸi")
    
    try:
        pomodoro_data_str = user_data.get('pomodoro_history', '[]')
        pomodoro_history = json.loads(pomodoro_data_str) if pomodoro_data_str else []
        
        if pomodoro_history:
            # Son 10 kaydÄ± gÃ¶ster
            recent_history = pomodoro_history[-10:]
            
            for i, record in enumerate(reversed(recent_history)):
                with st.expander(f"ğŸ… {record['subject']} - {record['topic'][:30]}... ({record['timestamp'][:10]})"):
                    col1, col2, col3 = st.columns(3)
                    with col1:
                        st.write(f"**TÃ¼r:** {record['type']}")
                    with col2:
                        st.write(f"**Ders:** {record['subject']}")
                    with col3:
                        st.write(f"**Durum:** {'âœ… TamamlandÄ±' if record['completed'] else 'âŒ YarÄ±m'}")
                    
                    st.write(f"**Konu:** {record['topic']}")
                    st.write(f"**Tarih:** {record['timestamp']}")
        else:
            st.info("ğŸ“… HenÃ¼z pomodoro geÃ§miÅŸi bulunmuyor.")
            
    except Exception as e:
        st.error(f"GeÃ§miÅŸ yÃ¼klenirken hata: {e}")
# === HÄ°BRÄ°T POMODORO SÄ°STEMÄ° FONKSÄ°YONLARI ===

# YKS OdaklÄ± Motivasyon SÃ¶zleri - Hibrit Sistem iÃ§in
MOTIVATION_QUOTES = [
    "Her 50 dakikalÄ±k emek, seni rakiplerinden ayÄ±rÄ±yor! ğŸ’ª",
    "Åu anda Ã§Ã¶zdÃ¼ÄŸÃ¼n her soru, YKS'de seni zirveye taÅŸÄ±yacak! ğŸ¯",
    "BÃ¼yÃ¼k hedefler kÃ¼Ã§Ã¼k adÄ±mlarla baÅŸlar - sen doÄŸru yoldasÄ±n! â­",
    "Her nefes alÄ±ÅŸÄ±n, YKS baÅŸarÄ±na bir adÄ±m daha yaklaÅŸtÄ±rÄ±yor! ğŸŒ¬ï¸",
    "Zorluklara direnmek seni gÃ¼Ã§lendiriyor - YKS'de fark yaratacaksÄ±n! ğŸš€",
    "BugÃ¼n kazandÄ±ÄŸÄ±n her kavram, sÄ±navda seni Ã¶ne Ã§Ä±karacak! ğŸ“š",
    "Konsantrasyon kaslarÄ±n gÃ¼Ã§leniyor - ÅŸampiyonlar bÃ¶yle yetiÅŸir! ğŸ§ ",
    "Hedefine odaklan! Her dakika YKS baÅŸarÄ±n iÃ§in deÄŸerli! ğŸ†",
    "Mola hakkÄ±nÄ± akÄ±llÄ±ca kullanÄ±yorsun - bu seni daha gÃ¼Ã§lÃ¼ yapÄ±yor! ğŸ’¨",
    "BaÅŸarÄ± sabÄ±r ister, sen sabÄ±rlÄ± bir savaÅŸÃ§Ä±sÄ±n! âš”ï¸",
    "Her yeni konu Ã¶ÄŸreniÅŸin, gelecekteki mesleÄŸinin temeli! ğŸ—ï¸",
    "RÃ¼yalarÄ±nÄ±n peÅŸinde koÅŸuyorsun - asla vazgeÃ§me! ğŸŒŸ",
    "YKS sadece bir sÄ±nav, sen ise sÄ±nÄ±rsÄ±z potansiyelin! ğŸŒˆ",
    "Her pomodoro seansÄ±, hedefine bir adÄ±m daha yaklaÅŸtÄ±rÄ±yor! ğŸ¯",
    "DÃ¼n yapamadÄ±ÄŸÄ±nÄ± bugÃ¼n yapabiliyorsun - bu geliÅŸim! ğŸ“ˆ",
    "Zorlu sorularÄ± Ã§Ã¶zerken beynin gÃ¼Ã§leniyor! ğŸ§©",
    "Her mola sonrasÄ± daha gÃ¼Ã§lÃ¼ dÃ¶nÃ¼yorsun! ğŸ’ª",
    "Bilim insanlarÄ± da bÃ¶yle Ã§alÄ±ÅŸtÄ± - sen de baÅŸaracaksÄ±n! ğŸ”¬",
    "Her nefes, yeni bir baÅŸlangÄ±Ã§ fÄ±rsatÄ±! ğŸŒ±",
    "Hayal ettiÄŸin Ã¼niversite seni bekliyor! ğŸ›ï¸"
]

# Mikro ipuÃ§larÄ± (ders bazÄ±nda)
MICRO_TIPS = {
    "TYT Matematik": [
        "ğŸ“ TÃ¼rev sorularÄ±nda genellikle Ã¶nce fonksiyonun kÃ¶klerini bulmak saldÄ±rÄ±larÄ± hÄ±zlandÄ±rÄ±r.",
        "ğŸ”¢ Ä°ntegral hesaplarken substitÃ¼syon methodunu akÄ±lda tut.",
        "ğŸ“Š Geometri problemlerinde Ã§izim yapmayÄ± unutma.",
        "âš¡ Limit sorularÄ±nda l'hopital kuralÄ±nÄ± hatÄ±rla."
    ],
    "TYT Fizik": [
        "âš¡ Newton yasalarÄ±nÄ± uygularken kuvvet vektÃ¶rlerini doÄŸru Ã§iz.",
        "ğŸŒŠ Dalga problemlerinde frekans-dalga boyu iliÅŸkisini unutma.",
        "ğŸ”¥ Termodinamik sorularÄ±nda sistem sÄ±nÄ±rlarÄ±nÄ± net belirle.",
        "ğŸ”¬ Elektrik alanÄ± hesaplamalarÄ±nda iÅŸaret dikkatli kontrol et."
    ],
    "TYT Kimya": [
        "ğŸ§ª Mol kavramÄ± tÃ¼m hesaplamalarÄ±n temeli - ezberleme!",
        "âš›ï¸ Periyodik cetveldeki eÄŸilimleri gÃ¶rselleÅŸtir.",
        "ğŸ”„ Denge tepkimelerinde Le Chatelier prensibini uygula.",
        "ğŸ’§ Asit-baz titrasyonlarÄ±nda eÅŸdeÄŸer nokta kavramÄ±nÄ± unutma."
    ],
    "TYT TÃ¼rkÃ§e": [
        "ğŸ“– Paragraf sorularÄ±nda ana fikri ilk ve son cÃ¼mlelerde ara.",
        "âœï¸ Anlam bilgisi sorularÄ±nda baÄŸlamÄ± dikkate al.",
        "ğŸ“ YazÄ±m kurallarÄ±nda 'de/da' ayrÄ±m kuralÄ±nÄ± hatÄ±rla.",
        "ğŸ­ Edebi tÃ¼rlerde karakterizasyon Ã¶nemli."
    ],
    "TYT Tarih": [
        "ğŸ“… OlaylarÄ± kronolojik sÄ±rayla Ã¶ÄŸren, sebep-sonuÃ§ baÄŸla.",
        "ğŸ›ï¸ Siyasi yapÄ±lar sosyal yapÄ±larla iliÅŸkisini kur.",
        "ğŸ—ºï¸ Haritalarla coÄŸrafi konumlarÄ± pekiÅŸtir.",
        "ğŸ‘‘ DÃ¶nem Ã¶zelliklerini baÅŸlÄ±ca olaylarla Ã¶rnekle."
    ],
    "TYT CoÄŸrafya": [
        "ğŸŒ Ä°klim tÃ¼rlerini sebepleriyle birlikte Ã¶ÄŸren.",
        "ğŸ”ï¸ Jeomorfoloji'de sÃ¼reÃ§-ÅŸekil iliÅŸkisini kur.",
        "ğŸ“Š Ä°statistiksel veriler harita okuma becerisini geliÅŸtir.",
        "ğŸŒ± Bitki Ã¶rtÃ¼sÃ¼-iklim iliÅŸkisini unutma."
    ],
    "Genel": [
        "ğŸ¯ Zor sorularla karÅŸÄ±laÅŸtÄ±ÄŸÄ±nda derin nefes al ve sistematik dÃ¼ÅŸÃ¼n.",
        "â° Zaman yÃ¶netimini ihmal etme - her dakika deÄŸerli.",
        "ğŸ“š KavramlarÄ± sadece ezberlemek yerine anlayarak Ã¶ÄŸren.",
        "ğŸ”„ DÃ¼zenli tekrar yapmak kalÄ±cÄ±lÄ±ÄŸÄ± artÄ±rÄ±r."
    ]
}

# YKS OdaklÄ± Nefes Egzersizi TalimatlarÄ±
BREATHING_EXERCISES = [
    {
        "name": "4-4-4-4 TekniÄŸi (Kare Nefes)",
        "instruction": "4 saniye nefes al â†’ 4 saniye tut â†’ 4 saniye ver â†’ 4 saniye bekle",
        "benefit": "Stresi azaltÄ±r, odaklanmayÄ± artÄ±rÄ±r, sÄ±nav kaygÄ±sÄ±nÄ± azaltÄ±r"
    },
    {
        "name": "KarÄ±n Nefesi (Diyafragma Nefesi)",
        "instruction": "Elinizi karnÄ±nÄ±za koyun. Nefes alÄ±rken karÄ±n ÅŸiÅŸsin, verirken insin",
        "benefit": "GevÅŸemeyi saÄŸlar, kaygÄ±yÄ± azaltÄ±r, zihinsel netliÄŸi artÄ±rÄ±r"
    },
    {
        "name": "4-7-8 SakinleÅŸtirici Nefes",
        "instruction": "4 saniye burun ile nefes al â†’ 7 saniye tut â†’ 8 saniye aÄŸÄ±z ile ver",
        "benefit": "Derin rahatlama saÄŸlar, uykuya yardÄ±m eder, sÄ±nav Ã¶ncesi sakinleÅŸtirir"
    },
    {
        "name": "YavaÅŸ Derin Nefes",
        "instruction": "6 saniye nefes al â†’ 2 saniye tut â†’ 6 saniye yavaÅŸÃ§a ver",
        "benefit": "Kalp ritmi dÃ¼zenlenir, sakinleÅŸir, zihinsel berraklÄ±k artar"
    },
    {
        "name": "Alternatif Burun Nefesi",
        "instruction": "SaÄŸ burun deliÄŸi ile nefes al, sol ile ver. Sonra tersini yap",
        "benefit": "Beynin her iki yarÄ±m kÃ¼resini dengeler, konsantrasyonu artÄ±rÄ±r"
    },
    {
        "name": "5-5 Basit Ritim",
        "instruction": "5 saniye nefes al â†’ 5 saniye nefes ver (hiÃ§ tutmadan)",
        "benefit": "Basit ve etkili, hÄ±zlÄ± sakinleÅŸme, odaklanma Ã¶ncesi ideal"
    }
]

def start_hibrit_breathing():
    """Hibrit nefes sistemini baÅŸlat - Pomodoro'yu duraklat"""
    # Pomodoro'yu duraklat
    if st.session_state.pomodoro_active:
        st.session_state.breathing_paused_time = st.session_state.time_remaining
    
    # Nefes sistemini baÅŸlat
    st.session_state.breathing_active = True
    st.session_state.breath_time_remaining = 60
    st.session_state.breath_start_time = time.time()
    
    # Rastgele bir motivasyon tÃ¼rÃ¼ seÃ§
    motivation_types = ['quote', 'tip', 'breathing']
    st.session_state.current_motivation_type = random.choice(motivation_types)
    
    if st.session_state.current_motivation_type == 'quote':
        st.session_state.current_motivation_content = random.choice(MOTIVATION_QUOTES)
    elif st.session_state.current_motivation_type == 'tip':
        subject = st.session_state.current_subject
        if subject in MICRO_TIPS:
            st.session_state.current_motivation_content = random.choice(MICRO_TIPS[subject])
        else:
            st.session_state.current_motivation_content = random.choice(MICRO_TIPS['Genel'])
    else:  # breathing
        exercise = random.choice(BREATHING_EXERCISES)
        st.session_state.current_motivation_content = f"""
ğŸ« **{exercise['name']}**

ğŸ“‹ {exercise['instruction']}

âœ¨ **FaydasÄ±:** {exercise['benefit']}
        """
    
    # KullanÄ±m loguna kaydet
    log_entry = {
        'timestamp': datetime.now().isoformat(),
        'subject': st.session_state.current_subject,
        'motivation_type': st.session_state.current_motivation_type,
        'remaining_time_when_used': st.session_state.breathing_paused_time
    }
    st.session_state.breathing_usage_log.append(log_entry)
    
    st.success("ğŸ’¨ Hibrit nefes molasÄ± baÅŸladÄ±! Pomodoro timer duraklatÄ±ldÄ±.")

def complete_breathing_exercise():
    """Nefes egzersizini tamamla ve Pomodoro'ya dÃ¶n"""
    st.session_state.breathing_active = False
    st.session_state.breath_time_remaining = 60
    st.session_state.breath_start_time = None
    
    # Pomodoro'yu kaldÄ±ÄŸÄ± yerden devam ettir
    if st.session_state.pomodoro_active:
        st.session_state.time_remaining = st.session_state.breathing_paused_time
        st.session_state.start_time = time.time()
    
    st.success("ğŸ‰ Hibrit nefes molasÄ± tamamlandÄ±! Pomodoro kaldÄ±ÄŸÄ± yerden devam ediyor.")
    st.balloons()

def show_breathing_exercise():
    """Hibrit nefes egzersizini gÃ¶ster - 5 saniyede bir deÄŸiÅŸen motivasyon ile"""
    breath_seconds = int(st.session_state.breath_time_remaining)
    
    # 5 saniyede bir motivasyon iÃ§eriÄŸini deÄŸiÅŸtir
    current_time = int(time.time())
    
    # Her 5 saniyede bir yeni iÃ§erik seÃ§
    if not hasattr(st.session_state, 'last_motivation_change'):
        st.session_state.last_motivation_change = current_time
        st.session_state.motivation_index = 0
    
    if current_time - st.session_state.last_motivation_change >= 5:
        st.session_state.last_motivation_change = current_time
        st.session_state.motivation_index = (st.session_state.motivation_index + 1) % len(MOTIVATION_QUOTES)
        
        # Yeni motivasyon tÃ¼rÃ¼ ve iÃ§erik seÃ§
        motivation_types = ['quote', 'tip', 'breathing']
        st.session_state.current_motivation_type = random.choice(motivation_types)
        
        if st.session_state.current_motivation_type == 'quote':
            st.session_state.current_motivation_content = MOTIVATION_QUOTES[st.session_state.motivation_index]
        elif st.session_state.current_motivation_type == 'tip':
            subject = st.session_state.current_subject or 'Genel'
            if subject in MICRO_TIPS:
                st.session_state.current_motivation_content = random.choice(MICRO_TIPS[subject])
            else:
                st.session_state.current_motivation_content = random.choice(MICRO_TIPS['Genel'])
        else:  # breathing
            exercise = random.choice(BREATHING_EXERCISES)
            st.session_state.current_motivation_content = f"ğŸ« **{exercise['name']}**\n\nğŸ“‹ {exercise['instruction']}\n\nâœ¨ **FaydasÄ±:** {exercise['benefit']}"
    
    st.markdown(f"""
    <style>
    .breathing-container {{
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 20px;
        padding: 30px;
        margin: 20px 0;
        text-align: center;
        color: white;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        animation: pulse 2s infinite;
    }}
    .breathing-title {{
        color: white;
        margin-bottom: 20px;
    }}
    .breathing-countdown {{
        font-size: 72px;
        font-weight: bold;
        margin: 20px 0;
    }}
    .breathing-motivation {{
        font-size: 18px;
        font-style: italic;
        margin: 20px 0;
        min-height: 120px;
        padding: 20px;
        background: rgba(255,255,255,0.1);
        border-radius: 15px;
        border-left: 4px solid #ffd700;
        transition: all 0.5s ease-in-out;
    }}
    .breathing-hint {{
        font-size: 12px;
        opacity: 0.8;
        margin-top: 10px;
    }}
    .breathing-status {{
        font-size: 14px;
        opacity: 0.9;
        margin-top: 15px;
    }}
    @keyframes pulse {{
        0% {{ transform: scale(1); }}
        50% {{ transform: scale(1.02); }}
        100% {{ transform: scale(1); }}
    }}
    </style>
    <div class="breathing-container">
        <h2 class="breathing-title">ğŸŒ¬ï¸ Hibrit Nefes MolasÄ±</h2>
        <div class="breathing-countdown">
            {breath_seconds}s
        </div>
        <div class="breathing-motivation">
            {st.session_state.current_motivation_content}
        </div>
        <div class="breathing-hint">
            ğŸ’¡ Ä°Ã§erik her 5 saniyede deÄŸiÅŸir
        </div>
        <div class="breathing-status">
            ğŸ§˜â€â™‚ï¸ Nefes molasÄ± aktif â€¢ Timer durduruldu
        </div>
    </div>
    """, unsafe_allow_html=True)



def get_subjects_by_field_yks(field):
    """Alan bazÄ±nda dersleri dÃ¶ndÃ¼rÃ¼r"""
    if field == "SayÄ±sal":
        return ["TYT Matematik", "TYT Geometri", "TYT Fizik", "TYT Kimya", "TYT Biyoloji", "TYT Din KÃ¼ltÃ¼rÃ¼", "TYT Felsefe",
                "TYT Tarih (isteÄŸe baÄŸlÄ±)", "TYT CoÄŸrafya (isteÄŸe baÄŸlÄ±)",  # Ä°steÄŸe baÄŸlÄ±
                "AYT Matematik", "AYT Fizik", "AYT Kimya", "AYT Biyoloji"]
    elif field == "SÃ¶zel":
        return ["TYT TÃ¼rkÃ§e", "TYT Tarih", "TYT CoÄŸrafya", "TYT Felsefe", "TYT Din KÃ¼ltÃ¼rÃ¼",
                "AYT Edebiyat", "AYT Tarih", "AYT CoÄŸrafya"]
    elif field == "EÅŸit AÄŸÄ±rlÄ±k":
        return ["TYT Matematik", "TYT Geometri", "TYT TÃ¼rkÃ§e", "TYT Tarih", "TYT CoÄŸrafya", "TYT Din KÃ¼ltÃ¼rÃ¼", "TYT Felsefe",
                "TYT Fizik (isteÄŸe baÄŸlÄ±)", "TYT Kimya (isteÄŸe baÄŸlÄ±)", "TYT Biyoloji (isteÄŸe baÄŸlÄ±)",  # Ä°steÄŸe baÄŸlÄ±
                "AYT Matematik", "AYT Edebiyat", "AYT Tarih", "AYT CoÄŸrafya"]

    else:
        return list(YKS_TOPICS.keys())

def determine_topic_priority_by_performance(topic, user_data):
    """Konunun Ã¶ÄŸrenci performansÄ±na gÃ¶re Ã¶ncelik seviyesini belirler"""
    # Konu takip verisinden mevcut net deÄŸerini al
    topic_progress = json.loads(user_data.get('topic_progress', '{}') or '{}')
    
    # MULTÄ°PLE FORMAT SUPPORT: Alternatif key formatlarÄ±nÄ± dene
    possible_keys = []
    
    # Format 1: subject | main_topic | topic | detail
    key1 = f"{topic['subject']} | {topic.get('main_topic', '')} | {topic['topic']} | {topic.get('detail', '')}"
    possible_keys.append(key1)
    
    # Format 2: subject | main_topic | None | detail  
    key2 = f"{topic['subject']} | {topic.get('main_topic', '')} | None | {topic.get('detail', '')}"
    possible_keys.append(key2)
    
    # Format 3: subject | None | None | detail
    key3 = f"{topic['subject']} | None | None | {topic.get('detail', '')}"
    possible_keys.append(key3)
    
    # Format 4: subject | topic | None | detail
    key4 = f"{topic['subject']} | {topic['topic']} | None | {topic.get('detail', '')}"
    possible_keys.append(key4)
    
    # DEBUG: Konu key'lerini kontrol et
    print(f"DEBUG: Trying keys: {possible_keys}")
    print(f"DEBUG: Available keys sample: {list(topic_progress.keys())[:3]}...")
    
    # Deneme analizinden de kontrol et
    deneme_weakness_boost = check_topic_weakness_in_exams(topic, user_data)
    
    # Alternatif key'leri dene ve ilk bulunanÄ± kullan
    net_value = 0
    found_key = None
    for possible_key in possible_keys:
        if possible_key in topic_progress:
            try:
                net_value = int(float(topic_progress[possible_key]))
                found_key = possible_key
                break
            except:
                continue
    
    print(f"DEBUG: Found key: {found_key}")
    print(f"DEBUG: Found net_value: {net_value} for topic: {topic.get('detail', '')}")
    
    # Net seviyesine gÃ¶re Ã¶ncelik belirle
    base_priority = get_priority_by_net_level(net_value)
    
    print(f"DEBUG: Base priority: {base_priority}")
    
    # Deneme analizinde zayÄ±f Ã§Ä±kanlarÄ± bir seviye yÃ¼kselt
    if deneme_weakness_boost:
        if base_priority == "MINIMAL":
            base_priority = "LOW"
        elif base_priority == "LOW":
            base_priority = "NORMAL"
        elif base_priority == "NORMAL":
            base_priority = "MEDIUM"
        elif base_priority == "MEDIUM":
            base_priority = "HIGH"
        # HIGH zaten en yÃ¼ksek, deÄŸiÅŸmez
    
    return base_priority

def get_priority_by_net_level(net_value):
    """Net deÄŸerine gÃ¶re Ã¶ncelik seviyesi dÃ¶ndÃ¼rÃ¼r"""
    if net_value <= 5:
        return "HIGH"        # ğŸ”´ ZayÄ±f Seviye â†’ Acil
    elif net_value <= 8:
        return "MEDIUM"      # ğŸŸ  Temel Seviye â†’ Ã–ncelikli
    elif net_value <= 14:
        return "NORMAL"      # ğŸŸ¡ Orta Seviye â†’ Normal
    elif net_value <= 18:
        return "LOW"         # ğŸŸ¢ Ä°yi Seviye â†’ DÃ¼ÅŸÃ¼k
    else:
        return "MINIMAL"     # ğŸ”µ Uzman Seviye â†’ Minimal

def check_topic_weakness_in_exams(topic, user_data):
    """Deneme analizinde bu konunun zayÄ±f olup olmadÄ±ÄŸÄ±nÄ± kontrol eder"""
    try:
        deneme_data_str = user_data.get('deneme_analizleri', '[]')
        deneme_kayitlari = json.loads(deneme_data_str) if deneme_data_str else []
        
        # Son 3 denemede bu konunun durumunu kontrol et
        recent_exams = deneme_kayitlari[-3:] if len(deneme_kayitlari) >= 3 else deneme_kayitlari
        
        for deneme in recent_exams:
            # Deneme detaylarÄ±nda bu konu/ders zayÄ±f kategorideyse
            if 'ders_netleri' in deneme:
                subject = topic['subject']
                if subject in deneme['ders_netleri']:
                    net_info = deneme['ders_netleri'][subject]
                    # Net oranÄ± %50'nin altÄ±ndaysa zayÄ±f
                    if isinstance(net_info, dict) and 'net' in net_info and 'total' in net_info:
                        try:
                            oran = net_info['net'] / net_info['total'] if net_info['total'] > 0 else 0
                            if oran < 0.5:  # %50'nin altÄ±nda baÅŸarÄ±
                                return True
                        except:
                            continue
            
            # Tavsiyelerde bu ders geÃ§iyorsa
            if 'tavsiyeler' in deneme:
                for tavsiye in deneme['tavsiyeler']:
                    if topic['subject'] in tavsiye and any(word in tavsiye.lower() for word in ['zayÄ±f', 'tekrar', 'Ã§alÄ±ÅŸ', 'boÅŸluk']):
                        return True
        
        return False
    except:
        return False

def calculate_subject_priority_new(subject, user_data, survey_data):
    """YENÄ° SÄ°STEM: Ders Ã¶nceliÄŸini konu takip seviyelerine gÃ¶re hesaplar"""
    # Dersin genel performansÄ±nÄ± hesapla
    topic_progress = json.loads(user_data.get('topic_progress', '{}') or '{}')
    subject_avg_net = calculate_subject_average_net(subject, topic_progress)
    
    # Net seviyesine gÃ¶re temel Ã¶ncelik
    base_priority_score = get_subject_priority_score_by_net(subject_avg_net)
    
    # Deneme analizinde bu ders zayÄ±fsa boost ver
    deneme_weakness_boost = check_subject_weakness_in_exams(subject, user_data)
    if deneme_weakness_boost:
        base_priority_score += 20
    
    # Survey'den zorluk bilgisi (hafif etki)
    if subject in survey_data.get('difficult_subjects', []):
        base_priority_score += 10
    
    # Survey'den sevilen dersler (pozitif etki - motivasyon artÄ±rÄ±r)
    if subject in survey_data.get('favorite_subjects', []):
        base_priority_score += 15  # Sevilen derslere ekstra motivasyon puanÄ±
    
    # Survey'den sevmeyen dersler (negatif etki - ama tamamen gÃ¶rmezden gelme)
    if subject in survey_data.get('disliked_subjects', []):
        base_priority_score -= 5  # Hafif azaltma, Ã§ok dÃ¼ÅŸÃ¼rme
    
    # Maksimum 100 puan
    return min(100, base_priority_score)

def get_subject_priority_score_by_net(avg_net):
    """Ders ortalama netine gÃ¶re Ã¶ncelik puanÄ±"""
    if avg_net <= 5:
        return 85       # Acil - Ã‡ok zayÄ±f
    elif avg_net <= 8:
        return 70       # Ã–ncelikli - Temel seviye
    elif avg_net <= 14:
        return 50       # Normal - Orta seviye
    elif avg_net <= 18:
        return 30       # DÃ¼ÅŸÃ¼k - Ä°yi seviye
    else:
        return 15       # Minimal - Uzman seviye

def check_subject_weakness_in_exams(subject, user_data):
    """Deneme analizinde bu dersin zayÄ±f olup olmadÄ±ÄŸÄ±nÄ± kontrol eder"""
    try:
        deneme_data_str = user_data.get('deneme_analizleri', '[]')
        deneme_kayitlari = json.loads(deneme_data_str) if deneme_data_str else []
        
        # Son 3 denemede bu dersin durumunu kontrol et
        recent_exams = deneme_kayitlari[-3:] if len(deneme_kayitlari) >= 3 else deneme_kayitlari
        weakness_count = 0
        
        for deneme in recent_exams:
            if 'ders_netleri' in deneme and subject in deneme['ders_netleri']:
                net_info = deneme['ders_netleri'][subject]
                try:
                    # Net oranÄ±nÄ± kontrol et
                    if isinstance(net_info, dict) and 'net' in net_info and 'total' in net_info:
                        oran = net_info['net'] / net_info['total'] if net_info['total'] > 0 else 0
                        if oran < 0.6:  # %60'Ä±n altÄ±nda baÅŸarÄ±
                            weakness_count += 1
                except:
                    continue
        
        # 3 denemeden 2'sinde zayÄ±fsa boost ver
        return weakness_count >= 2
    except:
        return False

def calculate_subject_average_net(subject, topic_progress):
    """Bir dersin ortalama net performansÄ±nÄ± hesaplar"""
    if subject not in YKS_TOPICS:
        return 0
        
    total_net = 0
    topic_count = 0
    
    for main_topic, sub_topics in YKS_TOPICS[subject].items():
        if isinstance(sub_topics, dict):
            for sub_topic, details in sub_topics.items():
                for detail in details:
                    topic_key = f"{subject} | {main_topic} | {sub_topic} | {detail}"
                    net_str = topic_progress.get(topic_key, '0')
                    try:
                        net_value = int(float(net_str))
                        total_net += net_value
                        topic_count += 1
                    except:
                        continue
        elif isinstance(sub_topics, list):
            for detail in sub_topics:
                topic_key = f"{subject} | {main_topic} | None | {detail}"
                net_str = topic_progress.get(topic_key, '0')
                try:
                    net_value = int(float(net_str))
                    total_net += net_value
                    topic_count += 1
                except:
                    continue
    
    return total_net / topic_count if topic_count > 0 else 0

def get_sequential_topics(subject, topic_progress, limit=5):
    """Bir dersten sÄ±ralÄ± olarak bir sonraki konularÄ± getirir"""
    if subject not in YKS_TOPICS:
        return []
        
    topics = []
    subject_content = YKS_TOPICS[subject]
    
    # Ä°Ã§erik tipini kontrol et
    if isinstance(subject_content, dict):
        # SÃ¶zlÃ¼k formatÄ±ndaysa
        for main_topic, sub_topics in subject_content.items():
            if isinstance(sub_topics, dict):
                # Alt konular da sÃ¶zlÃ¼k
                for sub_topic, details in sub_topics.items():
                    for detail in details:
                        topic_key = f"{subject} | {main_topic} | {sub_topic} | {detail}"
                        net_str = topic_progress.get(topic_key, '0')
                        try:
                            net_value = int(float(net_str))
                            if net_value < 14:  # Ä°yi seviyenin altÄ±nda
                                topics.append({
                                    'subject': subject,
                                    'main_topic': main_topic,
                                    'topic': sub_topic,
                                    'detail': detail,
                                    'key': topic_key,
                                    'net': net_value,
                                    'order': len(topics)  # SÄ±ralÄ± index
                                })
                                if len(topics) >= limit:
                                    return topics
                        except:
                            # Net bilgisi yoksa 0 kabul et
                            topics.append({
                                'subject': subject,
                                'main_topic': main_topic,
                                'topic': sub_topic,
                                'detail': detail,
                                'key': topic_key,
                                'net': 0,
                                'order': len(topics)
                            })
                            if len(topics) >= limit:
                                return topics
            elif isinstance(sub_topics, list):
                # Alt konular liste
                for detail in sub_topics:
                    topic_key = f"{subject} | {main_topic} | None | {detail}"
                    net_str = topic_progress.get(topic_key, '0')
                    try:
                        net_value = int(float(net_str))
                        if net_value < 14:
                            topics.append({
                                'subject': subject,
                                'main_topic': main_topic,
                                'topic': main_topic,
                                'detail': detail,
                                'key': topic_key,
                                'net': net_value,
                                'order': len(topics)
                            })
                            if len(topics) >= limit:
                                return topics
                    except:
                        topics.append({
                            'subject': subject,
                            'main_topic': main_topic,
                            'topic': main_topic,
                            'detail': detail,
                            'key': topic_key,
                            'net': 0,
                            'order': len(topics)
                        })
                        if len(topics) >= limit:
                            return topics
    elif isinstance(subject_content, list):
        # Ana iÃ§erik liste formatÄ±ndaysa
        for detail in subject_content:
            topic_key = f"{subject} | None | None | {detail}"
            net_str = topic_progress.get(topic_key, '0')
            try:
                net_value = int(float(net_str))
                if net_value < 14:
                    topics.append({
                        'subject': subject,
                        'main_topic': "Genel",
                        'topic': "Genel",
                        'detail': detail,
                        'key': topic_key,
                        'net': net_value,
                        'order': len(topics)
                    })
                    if len(topics) >= limit:
                        return topics
            except:
                topics.append({
                    'subject': subject,
                    'main_topic': "Genel",
                    'topic': "Genel",
                    'detail': detail,
                    'key': topic_key,
                    'net': 0,
                    'order': len(topics)
                })
                if len(topics) >= limit:
                    return topics
    
    return topics

def calculate_spaced_repetition_topics(user_data):
    """Tekrar edilmesi gereken konularÄ± bilimsel aralÄ±klarla hesaplar"""
    topic_progress = json.loads(user_data.get('topic_progress', '{}') or '{}')
    completion_dates = json.loads(user_data.get('topic_completion_dates', '{}') or '{}')
    
    current_date = datetime.now()
    review_topics = []
    
    for topic_key, net_str in topic_progress.items():
        try:
            net_value = int(float(net_str))
            if net_value >= 14:  # Ä°yi seviye ve Ã¼zeri
                completion_date_str = completion_dates.get(topic_key)
                if completion_date_str:
                    completion_date = datetime.fromisoformat(completion_date_str)
                    days_passed = (current_date - completion_date).days
                    
                    # Hangi tekrar aralÄ±ÄŸÄ±nda olduÄŸunu bul
                    review_interval = None
                    priority = "REPEAT_NORMAL"
                    
                    for i, interval in enumerate(SPACED_REPETITION_INTERVALS):
                        if days_passed >= interval - 1 and days_passed <= interval + 1:
                            review_interval = interval
                            # Kritiklik seviyesi
                            if i == 0:  # 3 gÃ¼n
                                priority = "REPEAT_HIGH"
                            elif i <= 2:  # 7, 14 gÃ¼n
                                priority = "REPEAT_MEDIUM"
                            else:  # 30, 90 gÃ¼n
                                priority = "REPEAT_NORMAL"
                            break
                    
                    if review_interval:
                        # Topic key'den subject ve diÄŸer bilgileri Ã§Ä±kar
                        parts = topic_key.split(' | ')
                        if len(parts) >= 4:
                            review_topics.append({
                                'subject': parts[0],
                                'main_topic': parts[1],
                                'topic': parts[2] if parts[2] != 'None' else parts[1],
                                'detail': parts[3],
                                'key': topic_key,
                                'net': net_value,
                                'days_passed': days_passed,
                                'interval': review_interval,
                                'priority': priority,
                                'completion_date': completion_date_str
                            })
        except:
            continue
    
    # Ã–ncelik sÄ±rasÄ±na gÃ¶re sÄ±rala
    priority_order = {"REPEAT_HIGH": 0, "REPEAT_MEDIUM": 1, "REPEAT_NORMAL": 2}
    review_topics.sort(key=lambda x: (priority_order.get(x['priority'], 3), x['days_passed']))
    
    return review_topics

# ===== YENÄ°: KALICI Ã–ÄRENME SÄ°STEMÄ° FONKSÄ°YONLARI =====

def initialize_mastery_system(user_data):
    """KullanÄ±cÄ± iÃ§in kalÄ±cÄ± Ã¶ÄŸrenme sistemi verilerini baÅŸlatÄ±r"""
    if 'topic_repetition_history' not in user_data:
        user_data['topic_repetition_history'] = '{}'
    if 'topic_mastery_status' not in user_data:
        user_data['topic_mastery_status'] = '{}'
    if 'pending_review_topics' not in user_data:
        user_data['pending_review_topics'] = '{}'
    return user_data

def add_topic_to_mastery_system(user_data, topic_key, initial_level="iyi"):
    """Konuyu kalÄ±cÄ± Ã¶ÄŸrenme sistemine ekler (haftalÄ±k konulardan bitirilen konu)"""
    import json
    from datetime import datetime, timedelta
    
    # Mevcut verileri yÃ¼kle
    repetition_history = json.loads(user_data.get('topic_repetition_history', '{}'))
    mastery_status = json.loads(user_data.get('topic_mastery_status', '{}'))
    
    current_date = datetime.now()
    
    # Ä°lk Ã¶ÄŸrenme kaydÄ±nÄ± oluÅŸtur
    repetition_history[topic_key] = {
        'initial_date': current_date.isoformat(),
        'initial_level': initial_level,
        'reviews': [],
        'current_stage': 0,  # 0: Ä°lk Ã¶ÄŸrenme, 1-4: Tekrarlar
        'next_review_date': None
    }
    
    mastery_status[topic_key] = {
        'status': 'INITIAL',
        'last_updated': current_date.isoformat(),
        'total_reviews': 0,
        'success_count': 0
    }
    
    # Ä°lk tekrar tarihini hesapla (3 gÃ¼n sonra)
    next_review = current_date + timedelta(days=MASTERY_INTERVALS[0])
    repetition_history[topic_key]['next_review_date'] = next_review.isoformat()
    
    # GÃ¼ncellenmiÅŸ verileri kaydet
    user_data['topic_repetition_history'] = json.dumps(repetition_history)
    user_data['topic_mastery_status'] = json.dumps(mastery_status)
    
    return user_data

def get_pending_review_topics(user_data):
    """Tekrar deÄŸerlendirmesi bekleyen konularÄ± dÃ¶ndÃ¼rÃ¼r"""
    import json
    from datetime import datetime
    
    repetition_history = json.loads(user_data.get('topic_repetition_history', '{}'))
    pending_topics = []
    current_date = datetime.now()
    
    for topic_key, history in repetition_history.items():
        next_review_date = history.get('next_review_date')
        if next_review_date and history['current_stage'] < 4:  # HenÃ¼z tamamlanmamÄ±ÅŸ
            try:
                review_date = datetime.fromisoformat(next_review_date)
                if current_date >= review_date:
                    # Konu bilgilerini topic_key'den Ã§Ä±kar
                    parts = topic_key.split(' | ')
                    if len(parts) >= 4:
                        pending_topics.append({
                            'key': topic_key,
                            'subject': parts[0],
                            'main_topic': parts[1],
                            'topic': parts[2] if parts[2] != 'None' else parts[1],
                            'detail': parts[3],
                            'stage': history['current_stage'],
                            'stage_name': get_stage_name(history['current_stage']),
                            'days_since_last': (current_date - datetime.fromisoformat(history['initial_date'])).days,
                            'review_count': len(history['reviews'])
                        })
            except:
                continue
    
    return pending_topics

def get_stage_name(stage):
    """Tekrar aÅŸamasÄ±nÄ±n adÄ±nÄ± dÃ¶ndÃ¼rÃ¼r"""
    stage_names = {
        0: "1. Tekrar (3 gÃ¼n sonra)",
        1: "2. Tekrar (7 gÃ¼n sonra)", 
        2: "3. Tekrar (7 gÃ¼n sonra)",
        3: "4. Tekrar (7 gÃ¼n sonra)",
        4: "Son Tekrar (7 gÃ¼n sonra)"
    }
    return stage_names.get(stage, "Bilinmeyen AÅŸama")

def process_review_evaluation(user_data, topic_key, evaluation_level):
    """Ã–ÄŸrencinin tekrar deÄŸerlendirmesini iÅŸler"""
    import json
    from datetime import datetime, timedelta
    
    repetition_history = json.loads(user_data.get('topic_repetition_history', '{}'))
    mastery_status = json.loads(user_data.get('topic_mastery_status', '{}'))
    
    current_date = datetime.now()
    
    if topic_key in repetition_history:
        history = repetition_history[topic_key]
        status = mastery_status[topic_key]
        
        # DeÄŸerlendirme kaydÄ±nÄ± ekle
        review_record = {
            'date': current_date.isoformat(),
            'level': evaluation_level,
            'stage': history['current_stage']
        }
        history['reviews'].append(review_record)
        status['total_reviews'] += 1
        status['last_updated'] = current_date.isoformat()
        
        # DeÄŸerlendirmeye gÃ¶re sonraki adÄ±mÄ± belirle
        if evaluation_level in ['iyi', 'uzman']:
            # BaÅŸarÄ±lÄ± - sonraki aÅŸamaya geÃ§
            status['success_count'] += 1
            history['current_stage'] += 1
            
            if history['current_stage'] >= 4:
                # TÃ¼m tekrarlarÄ± baÅŸarÄ±yla tamamladÄ± - kalÄ±cÄ± Ã¶ÄŸrenildi
                status['status'] = 'MASTERED'
                history['next_review_date'] = None
            else:
                # Sonraki tekrar tarihini belirle
                next_interval = MASTERY_INTERVALS[min(history['current_stage'], len(MASTERY_INTERVALS)-1)]
                next_review = current_date + timedelta(days=next_interval)
                history['next_review_date'] = next_review.isoformat()
                status['status'] = f"REVIEW_{history['current_stage']}"
        
        elif evaluation_level in ['zayif', 'temel']:
            # BaÅŸarÄ±sÄ±z - baÅŸa dÃ¶n veya Ã¶nceki aÅŸamaya geri git
            if evaluation_level == 'zayif':
                # Ã‡ok zayÄ±f - baÅŸa dÃ¶n
                history['current_stage'] = 0
                next_review = current_date + timedelta(days=MASTERY_INTERVALS[0])
                history['next_review_date'] = next_review.isoformat()
                status['status'] = 'REVIEW_1'
            else:
                # Temel - bir aÅŸama geri git (minimum 0)
                history['current_stage'] = max(0, history['current_stage'] - 1)
                next_interval = MASTERY_INTERVALS[min(history['current_stage'], len(MASTERY_INTERVALS)-1)]
                next_review = current_date + timedelta(days=next_interval)
                history['next_review_date'] = next_review.isoformat()
                status['status'] = f"REVIEW_{history['current_stage'] + 1}"
        
        else:  # orta
            # Orta seviye - aynÄ± aÅŸamada tekrar et
            next_interval = MASTERY_INTERVALS[min(history['current_stage'], len(MASTERY_INTERVALS)-1)]
            next_review = current_date + timedelta(days=next_interval)
            history['next_review_date'] = next_review.isoformat()
    
    # GÃ¼ncellenmiÅŸ verileri kaydet
    user_data['topic_repetition_history'] = json.dumps(repetition_history)
    user_data['topic_mastery_status'] = json.dumps(mastery_status)
    
    return user_data

def complete_topic_with_mastery_system(user_data, topic_key, net_value):
    """Konu bitirme iÅŸlemini kalÄ±cÄ± Ã¶ÄŸrenme sistemi ile entegre eder"""
    import json
    from datetime import datetime
    
    # Mevcut sistemi gÃ¼ncelle (topic_progress ve completion_dates)
    topic_progress = json.loads(user_data.get('topic_progress', '{}'))
    completion_dates = json.loads(user_data.get('topic_completion_dates', '{}'))
    
    topic_progress[topic_key] = str(net_value)
    completion_dates[topic_key] = datetime.now().isoformat()
    
    user_data['topic_progress'] = json.dumps(topic_progress)
    user_data['topic_completion_dates'] = json.dumps(completion_dates)
    
    # EÄŸer iyi seviye (14+ net) ise kalÄ±cÄ± Ã¶ÄŸrenme sistemine ekle
    if int(net_value) >= 14:
        user_data = add_topic_to_mastery_system(user_data, topic_key, "iyi")
    
    return user_data

def get_weekly_topics_from_topic_tracking(user_data, student_field, survey_data):
    """ğŸ¯ YENÄ° ZAMANSAL STRATEJÄ° HAFTALIK PLAN ÃœRETÄ°CÄ°SÄ° - DÃ–NEM BAZLI DÄ°NAMÄ°K SÄ°STEM"""
    
    # GÃ¼ncel zaman bilgisi al
    week_info = get_current_week_info()
    current_week = week_info['week_number']
    current_month = week_info['today'].month
    days_to_yks = week_info['days_to_yks']
    
    # ğŸš€ ZAMANSAL STRATEJÄ° ALMA - DÃ–NEMÄ° BELÄ°RLE
    time_strategy = get_time_based_strategy(days_to_yks, current_month)
    deneme_strategy = get_deneme_strategy_by_period(time_strategy)
    
    # ğŸ¯ SINIF VE HEDEF BÃ–LÃœM BAZLI STRATEJÄ° ENTEGRASYONU
    student_grade = user_data.get('grade', '12. SÄ±nÄ±f')
    target_department = user_data.get('target', 'VarsayÄ±lan')
    grade_strategy = get_grade_based_strategy(student_grade, target_department)
    
    # Zamansal strateji ile sÄ±nÄ±f bazlÄ± stratejiyi birleÅŸtir
    time_strategy['weekly_topic_base'] = grade_strategy['weekly_topic_base']
    time_strategy['grade_multiplier'] = grade_strategy['weekly_topic_multiplier']
    time_strategy['difficulty_level'] = grade_strategy['difficulty_level']
    time_strategy['target_nets'] = grade_strategy['target_nets']
    
    # Strateji bilgilerini debug iÃ§in kaydet
    strategy_info = {
        'period': time_strategy['period_name'],
        'focus': time_strategy['focus'],
        'deneme_freq': time_strategy['deneme_frequency'],
        'new_topics_limit': time_strategy['new_topics_per_week'],
        'review_ratio': time_strategy['review_ratio'],
        'intensity': time_strategy['study_intensity'],
        'days_to_yks': days_to_yks
    }
    
    # TYT ve AYT ilerlemesini hesapla
    tyt_progress = calculate_tyt_progress(user_data)
    tyt_math_topics_completed = count_tyt_math_completed_topics(user_data)
    
    # Alan bazÄ±nda dersleri al
    available_subjects = get_subjects_by_field_yks(student_field)
    
    # AYT baÅŸlatma koÅŸullarÄ±nÄ± kontrol et
    include_ayt = should_include_ayt(tyt_progress, tyt_math_topics_completed)
    
    # ğŸ¯ EÅÄ°T AÄIRLIK Ã–ZEL PLANÄ± KONTROLÃœ
    if student_field == "EÅŸit AÄŸÄ±rlÄ±k":
        # EÅŸit AÄŸÄ±rlÄ±k iÃ§in Ã¶zel hafta sistemi (1-16 hafta)
        equal_weight_week = user_data.get('equal_weight_current_week', 1)
        
        # EÄŸer hafta numarasÄ± user_data'da yoksa, 1. haftadan baÅŸlat
        if equal_weight_week < 1 or equal_weight_week > 16:
            equal_weight_week = 1
        
        # EÅŸit AÄŸÄ±rlÄ±k iÃ§in 16 haftalÄ±k detay planÄ± kullan
        completed_topics_list, completed_topic_names = get_completed_topics_from_user_data(user_data)  # ğŸ†• DÃœZELTÄ°LDÄ°
        pending_topics = get_user_pending_topics(user_data)  # Bekleyen konularÄ± al
        
        equal_weight_topics = get_equal_weight_weekly_topics(equal_weight_week, (completed_topics_list, completed_topic_names), pending_topics, user_data)
        
        # ğŸ†• %80 Ä°LERLEME KONTROLÃœ: O haftanÄ±n konularÄ±nda %80 ilerleme varsa otomatik geÃ§iÅŸ
        # O haftanÄ±n tamamlanmÄ±ÅŸ konu sayÄ±sÄ±nÄ± hesapla
        completed_in_week = len([t for t in completed_topics_list if t.get('week') == equal_weight_week and t.get('status') == 'completed'])
        total_in_week = len([t for t in equal_weight_topics if t.get('week') == equal_weight_week])
        
        if total_in_week > 0:  # BÃ¶lme hatasÄ±nÄ± Ã¶nle
            week_completion = (completed_in_week / total_in_week) * 100
            
            if week_completion >= 80 and equal_weight_week < 16:
                # %80 veya Ã¼stÃ¼ tamamlanmÄ±ÅŸ, otomatik bir sonraki haftaya geÃ§
                equal_weight_week += 1
                user_data['equal_weight_current_week'] = equal_weight_week
                # Firebase'e kaydet
                if 'username' in user_data:
                    update_user_in_firebase(user_data['username'], {
                        'equal_weight_current_week': equal_weight_week
                    })
                st.success(f"ğŸ‰ Tebrikler! {equal_weight_week-1}. haftanÄ±n %{week_completion:.1f}'ini tamamladÄ±n! Otomatik olarak {equal_weight_week}. haftaya geÃ§ildi.")
                # Yeni hafta konularÄ±nÄ± al
                equal_weight_topics = get_equal_weight_weekly_topics(equal_weight_week, (completed_topics_list, completed_topic_names), pending_topics, user_data)
        
        # Esnek hedef sistemi uygula
        current_week_progress = calculate_weekly_progress_percentage(
            len([t for t in completed_topics_list if t.get('week') == equal_weight_week and t.get('status') == 'completed']),
            len([t for t in equal_weight_topics if t.get('week') == equal_weight_week])
        )
        
        flexible_recommendation = get_flexible_topic_recommendations(user_data, current_week_progress)
        
        # TYT Din ve Felsefe 3. haftadan sonra eklenir
        if equal_weight_week >= 3:
            # Din ve Felsefe konularÄ±nÄ± sistematik olarak ekle
            din_felsefe_topics = get_weekly_din_felsefe_topics(equal_weight_week)
            equal_weight_topics.extend(din_felsefe_topics)
        
        # EÅŸit AÄŸÄ±rlÄ±k iÃ§in Ã¶zel plan dÃ¶ndÃ¼r
        return {
            'new_topics': equal_weight_topics,  # TÃœM KONULAR - LÄ°MÄ°T KALDIRILDI
            'review_topics': get_review_topics_for_equal_weight(user_data),
            'all_topics': equal_weight_topics,  # TÃœM KONULAR - HaftalÄ±k hedef konular listesi iÃ§in
            'week_target': len(equal_weight_topics),
            'success_target': 0.8,  # %80 hedef
            'flexible_recommendation': flexible_recommendation,
            'time_strategy': time_strategy,
            'grade_strategy': grade_strategy,
            'equal_weight_special': True,
            'current_week': equal_weight_week,  # EÅŸit aÄŸÄ±rlÄ±k haftasÄ±
            'total_weeks': 16
        }
    
    # ğŸ¯ SAYISAL Ã–ZEL PLANÄ± KONTROLÃœ  
    if student_field == "SayÄ±sal":
        # SayÄ±sal iÃ§in Ã¶zel hafta sistemi (1-18 hafta)
        numerical_week = user_data.get('numerical_current_week', 1)
        
        # EÄŸer hafta numarasÄ± user_data'da yoksa, 1. haftadan baÅŸlat
        if numerical_week < 1 or numerical_week > 18:
            numerical_week = 1
        
        # SayÄ±sal iÃ§in 18 haftalÄ±k detay planÄ± kullan
        completed_topics_list, completed_topic_names = get_completed_topics_from_user_data(user_data)  # ğŸ†• DÃœZELTÄ°LDÄ°
        pending_topics = get_user_pending_topics(user_data)  # Bekleyen konularÄ± al
        
        numerical_topics = get_numerical_weekly_topics(numerical_week, (completed_topics_list, completed_topic_names), pending_topics, user_data)
        
        # ğŸ†• %80 Ä°LERLEME KONTROLÃœ: O haftanÄ±n konularÄ±nda %80 ilerleme varsa otomatik geÃ§iÅŸ
        # O haftanÄ±n tamamlanmÄ±ÅŸ konu sayÄ±sÄ±nÄ± hesapla
        completed_in_week = len([t for t in completed_topics_list if t.get('week') == numerical_week and t.get('status') == 'completed'])
        total_in_week = len([t for t in numerical_topics if t.get('week') == numerical_week])
        
        if total_in_week > 0:  # BÃ¶lme hatasÄ±nÄ± Ã¶nle
            week_completion = (completed_in_week / total_in_week) * 100
            
            if week_completion >= 80 and numerical_week < 18:
                # %80 veya Ã¼stÃ¼ tamamlanmÄ±ÅŸ, otomatik bir sonraki haftaya geÃ§
                numerical_week += 1
                user_data['numerical_current_week'] = numerical_week
                # Firebase'e kaydet
                if 'username' in user_data:
                    update_user_in_firebase(user_data['username'], {
                        'numerical_current_week': numerical_week
                    })
                st.success(f"ğŸ‰ Tebrikler! {numerical_week-1}. haftanÄ±n %{week_completion:.1f}'ini tamamladÄ±n! Otomatik olarak {numerical_week}. haftaya geÃ§ildi.")
                # Yeni hafta konularÄ±nÄ± al
                numerical_topics = get_numerical_weekly_topics(numerical_week, (completed_topics_list, completed_topic_names), pending_topics, user_data)
        
        # Esnek hedef sistemi uygula
        current_week_progress = calculate_weekly_progress_percentage(
            len([t for t in completed_topics_list if t.get('week') == numerical_week and t.get('status') == 'completed']),
            len([t for t in numerical_topics if t.get('week') == numerical_week])
        )
        
        flexible_recommendation = get_flexible_topic_recommendations(user_data, current_week_progress)
        
        # SayÄ±sal iÃ§in Ã¶zel plan dÃ¶ndÃ¼r
        return {
            'new_topics': numerical_topics,  # TÃœM KONULAR - LÄ°MÄ°T KALDIRILDI
            'review_topics': get_review_topics_for_equal_weight(user_data),  # Åimdilik aynÄ± review sistemi
            'all_topics': numerical_topics,  # TÃœM KONULAR - HaftalÄ±k hedef konular listesi iÃ§in
            'week_target': len(numerical_topics),
            'success_target': 0.8,  # %80 hedef
            'flexible_recommendation': flexible_recommendation,
            'time_strategy': time_strategy,
            'grade_strategy': grade_strategy,
            'numerical_special': True,
            'current_week': numerical_week,  # SayÄ±sal haftasÄ±
            'total_weeks': 18
        }
    
    # ğŸ¯ TYT & MSÃœ Ã–ZEL PLANI KONTROLÃœ
    if student_field == "TYT & MSÃœ":
        # TYT & MSÃœ iÃ§in Ã¶zel hafta sistemi (1-9 hafta)
        tyt_msu_week = user_data.get('tyt_msu_current_week', 1)
        
        # EÄŸer hafta numarasÄ± user_data'da yoksa, 1. haftadan baÅŸlat
        if tyt_msu_week < 1 or tyt_msu_week > 9:
            tyt_msu_week = 1
        
        # TYT & MSÃœ iÃ§in 9 haftalÄ±k detay planÄ± kullan
        completed_topics_list, completed_topic_names = get_completed_topics_from_user_data(user_data)  # ğŸ†• DÃœZELTÄ°LDÄ°
        pending_topics = get_user_pending_topics(user_data)  # Bekleyen konularÄ± al
        
        tyt_msu_topics = get_tyt_msu_weekly_topics(tyt_msu_week, (completed_topics_list, completed_topic_names), pending_topics, user_data)
        
        # ğŸ†• %80 Ä°LERLEME KONTROLÃœ: O haftanÄ±n konularÄ±nda %80 ilerleme varsa otomatik geÃ§iÅŸ
        # O haftanÄ±n tamamlanmÄ±ÅŸ konu sayÄ±sÄ±nÄ± hesapla
        completed_in_week = len([t for t in completed_topics_list if t.get('week') == tyt_msu_week and t.get('status') == 'completed'])
        total_in_week = len([t for t in tyt_msu_topics if t.get('week') == tyt_msu_week])
        
        if total_in_week > 0:  # BÃ¶lme hatasÄ±nÄ± Ã¶nle
            week_completion = (completed_in_week / total_in_week) * 100
            
            if week_completion >= 80 and tyt_msu_week < 9:
                # %80 veya Ã¼stÃ¼ tamamlanmÄ±ÅŸ, otomatik bir sonraki haftaya geÃ§
                tyt_msu_week += 1
                user_data['tyt_msu_current_week'] = tyt_msu_week
                # Firebase'e kaydet
                if 'username' in user_data:
                    update_user_in_firebase(user_data['username'], {
                        'tyt_msu_current_week': tyt_msu_week
                    })
                st.success(f"ğŸ‰ Tebrikler! {tyt_msu_week-1}. haftanÄ±n %{week_completion:.1f}'ini tamamladÄ±n! Otomatik olarak {tyt_msu_week}. haftaya geÃ§ildi.")
                # Yeni hafta konularÄ±nÄ± al
                tyt_msu_topics = get_tyt_msu_weekly_topics(tyt_msu_week, (completed_topics_list, completed_topic_names), pending_topics, user_data)
        
        # Esnek hedef sistemi uygula
        current_week_progress = calculate_weekly_progress_percentage(
            len([t for t in completed_topics_list if t.get('week') == tyt_msu_week and t.get('status') == 'completed']),
            len([t for t in tyt_msu_topics if t.get('week') == tyt_msu_week])
        )
        
        flexible_recommendation = get_flexible_topic_recommendations(user_data, current_week_progress)
        
        # TYT & MSÃœ iÃ§in Ã¶zel plan dÃ¶ndÃ¼r
        return {
            'new_topics': tyt_msu_topics,  # TÃœM KONULAR - LÄ°MÄ°T KALDIRILDI
            'review_topics': get_review_topics_for_equal_weight(user_data),  # Åimdilik aynÄ± review sistemi
            'all_topics': tyt_msu_topics,  # TÃœM KONULAR - HaftalÄ±k hedef konular listesi iÃ§in
            'week_target': len(tyt_msu_topics),
            'success_target': 0.8,  # %80 hedef
            'flexible_recommendation': flexible_recommendation,
            'time_strategy': time_strategy,
            'grade_strategy': grade_strategy,
            'tyt_msu_special': True,
            'current_week': tyt_msu_week,  # TYT & MSÃœ haftasÄ±
            'total_weeks': 9
        }
    
    # ğŸ¯ SÃ–ZEL Ã–ZEL PLANI KONTROLÃœ
    if student_field == "SÃ¶zel":
        # SÃ¶zel iÃ§in Ã¶zel hafta sistemi (1-14 hafta)
        verbal_week = user_data.get('verbal_current_week', 1)
        
        # EÄŸer hafta numarasÄ± user_data'da yoksa, 1. haftadan baÅŸlat
        if verbal_week < 1 or verbal_week > 14:
            verbal_week = 1
        
        # SÃ¶zel iÃ§in 14 haftalÄ±k detay planÄ± kullan
        completed_topics_list, completed_topic_names = get_completed_topics_from_user_data(user_data)  # ğŸ†• DÃœZELTÄ°LDÄ°
        pending_topics = get_user_pending_topics(user_data)  # Bekleyen konularÄ± al
        
        verbal_topics = get_verbal_weekly_topics(verbal_week, (completed_topics_list, completed_topic_names), pending_topics, user_data)
        
        # ğŸ†• %80 Ä°LERLEME KONTROLÃœ: O haftanÄ±n konularÄ±nda %80 ilerleme varsa otomatik geÃ§iÅŸ
        # O haftanÄ±n tamamlanmÄ±ÅŸ konu sayÄ±sÄ±nÄ± hesapla
        completed_in_week = len([t for t in completed_topics_list if t.get('week') == verbal_week and t.get('status') == 'completed'])
        total_in_week = len([t for t in verbal_topics if t.get('week') == verbal_week])
        
        if total_in_week > 0:  # BÃ¶lme hatasÄ±nÄ± Ã¶nle
            week_completion = (completed_in_week / total_in_week) * 100
            
            if week_completion >= 80 and verbal_week < 14:
                # %80 veya Ã¼stÃ¼ tamamlanmÄ±ÅŸ, otomatik bir sonraki haftaya geÃ§
                verbal_week += 1
                user_data['verbal_current_week'] = verbal_week
                # Firebase'e kaydet
                if 'username' in user_data:
                    update_user_in_firebase(user_data['username'], {
                        'verbal_current_week': verbal_week
                    })
                st.success(f"ğŸ‰ Tebrikler! {verbal_week-1}. haftanÄ±n %{week_completion:.1f}'ini tamamladÄ±n! Otomatik olarak {verbal_week}. haftaya geÃ§ildi.")
                # Yeni hafta konularÄ±nÄ± al
                verbal_topics = get_verbal_weekly_topics(verbal_week, (completed_topics_list, completed_topic_names), pending_topics, user_data)
        
        # TYT Matematik seÃ§eneÄŸini kontrol et
        include_math = st.session_state.get('verbal_include_math', False)
        if not include_math:
            # Matematik konularÄ±nÄ± filtrele
            verbal_topics = [topic for topic in verbal_topics 
                           if not (topic.get('subject', '') == 'TYT Matematik')]
        
        # Esnek hedef sistemi uygula
        current_week_progress = calculate_weekly_progress_percentage(
            len([t for t in completed_topics_list if t.get('week') == verbal_week and t.get('status') == 'completed']),
            len([t for t in verbal_topics if t.get('week') == verbal_week])
        )
        
        flexible_recommendation = get_flexible_topic_recommendations(user_data, current_week_progress)
        
        # SÃ¶zel iÃ§in Ã¶zel plan dÃ¶ndÃ¼r
        return {
            'new_topics': verbal_topics,  # TÃœM KONULAR - LÄ°MÄ°T KALDIRILDI
            'review_topics': get_review_topics_for_equal_weight(user_data),  # Åimdilik aynÄ± review sistemi
            'all_topics': verbal_topics,  # TÃœM KONULAR - HaftalÄ±k hedef konular listesi iÃ§in
            'week_target': len(verbal_topics),
            'success_target': 0.8,  # %80 hedef
            'flexible_recommendation': flexible_recommendation,
            'time_strategy': time_strategy,
            'grade_strategy': grade_strategy,
            'verbal_special': True,
            'current_week': verbal_week,  # SÃ¶zel haftasÄ±
            'total_weeks': 14
        }
    
    # KonularÄ±n TYT/AYT durumuna gÃ¶re filtrele (diÄŸer alanlar iÃ§in)
    filtered_subjects = []
    for subject in available_subjects:
        if subject.startswith('AYT'):
            # Genel AYT koÅŸulunu kontrol et
            if not include_ayt:
                # Ã–zel durumlarÄ± kontrol et (prerequisite sistemi)
                if should_include_specific_ayt_subject(subject, user_data):
                    filtered_subjects.append(subject)
                # DeÄŸilse atla
                continue
            else:
                # Genel koÅŸul saÄŸlanmÄ±ÅŸsa ekle
                filtered_subjects.append(subject)
        else:
            # TYT konusuysa direkt ekle
            filtered_subjects.append(subject)
    
    # ğŸ¯ ZAMANSAL STRATEJÄ°YE GÃ–RE DERS Ã–NCELÄ°KLERÄ°NÄ° HESAPLA
    subject_priorities = {}
    for subject in filtered_subjects:
        # Eski Ã¶ncelik puanÄ±nÄ± al
        base_priority_score = calculate_subject_priority_new(subject, user_data, survey_data)
        
        # KullanÄ±cÄ±nÄ±n bu dersteki performansÄ±nÄ± hesapla (deneme veya konu ilerlemesi bazÄ±nda)
        user_performance = calculate_user_subject_performance(subject, user_data)
        
        # ğŸš€ ZAMANSAL STRATEJÄ°YE GÃ–RE BOOST UYGULA
        time_based_boost = get_time_based_priority_boost(time_strategy, subject, user_performance)
        
        # Final Ã¶ncelik puanÄ±
        final_priority = base_priority_score + time_based_boost
        subject_priorities[subject] = final_priority
    
    # Ã–ncelik sÄ±rasÄ±na gÃ¶re sÄ±rala
    sorted_subjects = sorted(subject_priorities.items(), key=lambda x: x[1], reverse=True)
    
    # HaftalÄ±k plan oluÅŸtur
    weekly_new_topics = []
    weekly_review_topics = []
    
    # 1. ğŸ¯ ZAMANSAL STRATEJÄ°YE GÃ–RE KONU DAÄILIMI
    for subject, priority_score in sorted_subjects:
        # Ders Ã¶nem puanÄ±nÄ± al
        importance = SUBJECT_IMPORTANCE_SCORES.get(subject, 5)
        
        # ğŸš€ ZAMANSAL STRATEJÄ°YE GÃ–RE DÄ°NAMÄ°K HAFTALIK LÄ°MÄ°T HESAPLA
        weekly_limit = calculate_dynamic_topic_limits(time_strategy, importance)
        
        # ğŸ“… DÃ–NEM BAZLI DERS FÄ°LTRELEME (Eski statik sistemin yerine)
        should_include_subject = should_include_subject_in_period(
            subject, importance, time_strategy, user_data, week_info
        )
        
        if not should_include_subject:
            continue
        
        # SÄ±ralÄ± konularÄ± al
        sequential_topics = get_sequential_topics(subject, 
            json.loads(user_data.get('topic_progress', '{}') or '{}'), 
            limit=weekly_limit)
        
        # YENÄ° SÄ°STEM: Her konunun bireysel Ã¶nceliÄŸini performansa gÃ¶re belirle
        for topic in sequential_topics:
            topic['priority'] = determine_topic_priority_by_performance(topic, user_data)
        
        weekly_new_topics.extend(sequential_topics)
    
    # 2. ğŸ”„ ZAMANSAL STRATEJÄ°YE GÃ–RE TEKRAR KONULARI
    all_review_topics = calculate_spaced_repetition_topics(user_data)
    
    # ğŸ¯ DÃ–NEM BAZLI TEKRAR KONUSU LÄ°MÄ°TÄ°
    max_review_topics = calculate_review_topics_limit_by_period(time_strategy)
    
    # ğŸ“Š STRATEJÄ°YE GÃ–RE TEKRAR KONULARÄ°NÄ° FÄ°LTRELE VE SIRALA
    filtered_review_topics = filter_review_topics_by_strategy(
        all_review_topics, time_strategy, user_data
    )
    
    weekly_review_topics = filtered_review_topics[:max_review_topics]
    
    # 4. TÃœM KONULARI HESAPLA (Pomodoro Timer iÃ§in)
    all_available_topics = []
    
    # Konu takipten tÃ¼m konularÄ± al
    topic_progress = json.loads(user_data.get('topic_progress', '{}') or '{}')
    
    for subject in filtered_subjects[:10]:  # Max 10 ders
        try:
            sequential_topics = get_sequential_topics(subject, 
                                                    user_data.get('grade', '12'), 
                                                    topic_progress,
                                                    user_data.get('field', ''))
            
            # Ä°lk 20 konuyu al
            for topic in sequential_topics[:20]:
                if topic not in [t.get('topic') for t in weekly_new_topics + weekly_review_topics]:
                    all_available_topics.append({
                        'topic': topic['topic'],
                        'subject': subject,
                        'detail': topic.get('detail', topic['topic']),
                        'net': topic.get('net', 0),
                        'priority': topic.get('priority', 'NORMAL'),
                        'reason': 'Konu takip sistemi'
                    })
        except Exception as e:
            continue
    
    # 5. ğŸ¯ ZAMANSAL STRATEJÄ° Ä°LE TOPLAM PLAN
    total_plan = {
        'new_topics': weekly_new_topics[:time_strategy['new_topics_per_week']],  # Strateji bazlÄ± limit
        'review_topics': weekly_review_topics,
        'all_topics': all_available_topics[:25],  # Max 25 tÃ¼m konu (Pomodoro iÃ§in)
        'week_target': len(weekly_new_topics[:time_strategy['new_topics_per_week']]) + len(weekly_review_topics),
        'success_target': 0.8,  # %80 baÅŸarÄ± hedefi
        'projections': calculate_completion_projections(user_data, student_field, days_to_yks),
        'tyt_progress': tyt_progress,
        'ayt_enabled': include_ayt,
        'tyt_math_completed': tyt_math_topics_completed,
        
        # ğŸš€ ZAMANSAL STRATEJÄ° BÄ°LGÄ°LERÄ°
        'time_strategy': time_strategy,
        'deneme_strategy': deneme_strategy,
        'strategy_info': strategy_info,
        'period_recommendations': get_period_specific_recommendations(time_strategy, user_data),
        'focus_areas': get_focus_areas_by_period(time_strategy, user_data)
    }
    
    return total_plan

def calculate_tyt_progress(user_data):
    """TYT ilerlemesini yÃ¼zde olarak hesaplar"""
    topic_progress = json.loads(user_data.get('topic_progress', '{}') or '{}')
    
    tyt_total = 0
    tyt_completed = 0
    
    # Sadece TYT dersleri
    for subject in YKS_TOPICS.keys():
        if not subject.startswith('TYT'):
            continue
        
        subject_content = YKS_TOPICS[subject]
        
        # Ä°Ã§erik tipini kontrol et
        if isinstance(subject_content, dict):
            # SÃ¶zlÃ¼k formatÄ±ndaysa
            for main_topic, sub_topics in subject_content.items():
                if isinstance(sub_topics, dict):
                    # Alt konular da sÃ¶zlÃ¼k
                    for sub_topic, details in sub_topics.items():
                        for detail in details:
                            topic_key = f"{subject} | {main_topic} | {sub_topic} | {detail}"
                            tyt_total += 1
                            try:
                                net_value = int(float(topic_progress.get(topic_key, '0')))
                                if net_value >= 14:  # Ä°yi seviye
                                    tyt_completed += 1
                            except:
                                continue
                elif isinstance(sub_topics, list):
                    # Alt konular liste
                    for detail in sub_topics:
                        topic_key = f"{subject} | {main_topic} | None | {detail}"
                        tyt_total += 1
                        try:
                            net_value = int(float(topic_progress.get(topic_key, '0')))
                            if net_value >= 14:  # Ä°yi seviye
                                tyt_completed += 1
                        except:
                            continue
        elif isinstance(subject_content, list):
            # Ana iÃ§erik liste formatÄ±ndaysa
            for detail in subject_content:
                topic_key = f"{subject} | None | None | {detail}"
                tyt_total += 1
                try:
                    net_value = int(float(topic_progress.get(topic_key, '0')))
                    if net_value >= 14:  # Ä°yi seviye
                        tyt_completed += 1
                except:
                    continue
    
    if tyt_total > 0:
        return (tyt_completed / tyt_total) * 100
    return 0

def count_tyt_math_completed_topics(user_data):
    """TYT Matematik'te tamamlanan konu sayÄ±sÄ±nÄ± hesaplar"""
    topic_progress = json.loads(user_data.get('topic_progress', '{}') or '{}')
    
    if "TYT Matematik" not in YKS_TOPICS:
        return 0
    
    completed_count = 0
    subject_content = YKS_TOPICS["TYT Matematik"]
    
    # Ä°Ã§erik tipini kontrol et
    if isinstance(subject_content, dict):
        # SÃ¶zlÃ¼k formatÄ±ndaysa
        for main_topic, sub_topics in subject_content.items():
            if isinstance(sub_topics, dict):
                # Alt konular da sÃ¶zlÃ¼k
                for sub_topic, details in sub_topics.items():
                    for detail in details:
                        topic_key = f"TYT Matematik | {main_topic} | {sub_topic} | {detail}"
                        try:
                            net_value = int(float(topic_progress.get(topic_key, '0')))
                            if net_value >= 14:  # Ä°yi seviye
                                completed_count += 1
                        except:
                            continue
            elif isinstance(sub_topics, list):
                # Alt konular liste
                for detail in sub_topics:
                    topic_key = f"TYT Matematik | {main_topic} | None | {detail}"
                    try:
                        net_value = int(float(topic_progress.get(topic_key, '0')))
                        if net_value >= 14:  # Ä°yi seviye
                            completed_count += 1
                    except:
                        continue
    elif isinstance(subject_content, list):
        # Ana iÃ§erik liste formatÄ±ndaysa
        for detail in subject_content:
            topic_key = f"TYT Matematik | None | None | {detail}"
            try:
                net_value = int(float(topic_progress.get(topic_key, '0')))
                if net_value >= 14:  # Ä°yi seviye
                    completed_count += 1
            except:
                continue
    
    return completed_count

def should_include_ayt(tyt_progress, tyt_math_completed):
    """AYT konularÄ±nÄ±n dahil edilip edilmeyeceÄŸini belirler"""
    # KoÅŸul 1: TYT'nin %60'Ä± tamamlanmÄ±ÅŸ olmalÄ±
    condition1 = tyt_progress >= 60.0
    
    # KoÅŸul 2: TYT Matematik'te en az 12 konu tamamlanmÄ±ÅŸ olmalÄ±  
    condition2 = tyt_math_completed >= 12
    
    # Her iki koÅŸul da saÄŸlanmalÄ±
    return condition1 and condition2

def should_include_specific_ayt_subject(ayt_subject, user_data):
    """Belirli bir AYT dersinin dahil edilip edilmeyeceÄŸini kontrol eder (prerequisite sistemi)"""
    
    # TYT-AYT devamÄ± olan konular
    PREREQUISITE_MAPPING = {
        "AYT Matematik": {
            "prerequisite_subject": "TYT Matematik", 
            "required_topics": ["Temel Kavramlar", "Temel Ä°ÅŸlemler"],  # Ä°lk 2 kategorideki konular
            "min_completed": 8  # En az 8 konu tamamlanmÄ±ÅŸ olmalÄ±
        },
        "AYT Fizik": {
            "prerequisite_subject": "TYT Fizik",
            "required_topics": ["Kuvvet ve Hareket"],  # Temel fizik
            "min_completed": 4
        },
        "AYT Biyoloji": {
            "prerequisite_subject": "TYT Biyoloji", 
            "required_topics": ["CanlÄ±larÄ±n Temel BileÅŸenleri"],  # Temel biyoloji
            "min_completed": 3
        },
        "AYT Kimya": {
            "prerequisite_subject": "TYT Kimya",
            "required_topics": ["Atom ve Periyodik Sistem"],  # Temel kimya
            "min_completed": 3
        }
    }
    
    if ayt_subject not in PREREQUISITE_MAPPING:
        return False  # TanÄ±mlÄ± deÄŸilse genel kuralÄ± uygula
    
    prereq = PREREQUISITE_MAPPING[ayt_subject]
    tyt_subject = prereq["prerequisite_subject"]
    
    # TYT konusunun tamamlanan konularÄ±nÄ± say
    completed_count = count_completed_topics_in_categories(
        user_data, tyt_subject, prereq["required_topics"]
    )
    
    return completed_count >= prereq["min_completed"]

def count_completed_topics_in_categories(user_data, subject, categories):
    """Belirli kategorilerdeki tamamlanan konu sayÄ±sÄ±nÄ± hesaplar"""
    topic_progress = json.loads(user_data.get('topic_progress', '{}') or '{}')
    
    if subject not in YKS_TOPICS:
        return 0
    
    completed_count = 0
    subject_content = YKS_TOPICS[subject]
    
    if isinstance(subject_content, dict):
        for category_name, category_content in subject_content.items():
            if category_name not in categories:
                continue  # Sadece istenen kategorileri say
                
            if isinstance(category_content, dict):
                # Alt kategoriler varsa
                for sub_category, topics in category_content.items():
                    if isinstance(topics, list):
                        for topic in topics:
                            topic_key = f"{subject} | {category_name} | {sub_category} | {topic}"
                            try:
                                net_value = int(float(topic_progress.get(topic_key, '0')))
                                if net_value >= 10:  # Temel seviye yeterli
                                    completed_count += 1
                            except:
                                continue
            elif isinstance(category_content, list):
                # Direkt konu listesi
                for topic in category_content:
                    topic_key = f"{subject} | {category_name} | None | {topic}"
                    try:
                        net_value = int(float(topic_progress.get(topic_key, '0')))
                        if net_value >= 10:  # Temel seviye yeterli
                            completed_count += 1
                    except:
                        continue
    
    return completed_count

def calculate_completion_projections(user_data, student_field, days_to_yks):
    """Uzun vadeli tamamlanma tahminleri - DÄ°NAMÄ°K YKS TARÄ°HÄ° Ä°LE"""
    topic_progress = json.loads(user_data.get('topic_progress', '{}') or '{}')
    available_subjects = get_subjects_by_field_yks(student_field)
    
    projections = {
        'overall_progress': 0,
        'tyt_progress': 0,
        'ayt_progress': 0,
        'estimated_completion': None,
        'monthly_targets': [],
        'weekly_average': 0
    }
    
    total_topics = 0
    completed_topics = 0
    tyt_total = 0
    tyt_completed = 0
    ayt_total = 0
    ayt_completed = 0
    
    # Her dersin ilerlemesini hesapla
    for subject in available_subjects:
        if subject not in YKS_TOPICS:
            continue
            
        subject_total = 0
        subject_completed = 0
        subject_content = YKS_TOPICS[subject]
        
        # Ä°Ã§erik tipini kontrol et
        if isinstance(subject_content, dict):
            # SÃ¶zlÃ¼k formatÄ±ndaysa
            for main_topic, sub_topics in subject_content.items():
                if isinstance(sub_topics, dict):
                    # Alt konular da sÃ¶zlÃ¼k
                    for sub_topic, details in sub_topics.items():
                        for detail in details:
                            topic_key = f"{subject} | {main_topic} | {sub_topic} | {detail}"
                            subject_total += 1
                            try:
                                net_value = int(float(topic_progress.get(topic_key, '0')))
                                if net_value >= 14:
                                    subject_completed += 1
                            except:
                                continue
                elif isinstance(sub_topics, list):
                    # Alt konular liste
                    for detail in sub_topics:
                        topic_key = f"{subject} | {main_topic} | None | {detail}"
                        subject_total += 1
                        try:
                            net_value = int(float(topic_progress.get(topic_key, '0')))
                            if net_value >= 14:
                                subject_completed += 1
                        except:
                            continue
        elif isinstance(subject_content, list):
            # Ana iÃ§erik liste formatÄ±ndaysa
            for detail in subject_content:
                topic_key = f"{subject} | None | None | {detail}"
                subject_total += 1
                try:
                    net_value = int(float(topic_progress.get(topic_key, '0')))
                    if net_value >= 14:
                        subject_completed += 1
                except:
                    continue
        
        total_topics += subject_total
        completed_topics += subject_completed
        
        # TYT/AYT ayrÄ±mÄ±
        if subject.startswith('TYT'):
            tyt_total += subject_total
            tyt_completed += subject_completed
        elif subject.startswith('AYT'):
            ayt_total += subject_total
            ayt_completed += subject_completed
    
    # Ä°lerleme yÃ¼zdelerini hesapla
    if total_topics > 0:
        projections['overall_progress'] = (completed_topics / total_topics) * 100
    if tyt_total > 0:
        projections['tyt_progress'] = (tyt_completed / tyt_total) * 100
    if ayt_total > 0:
        projections['ayt_progress'] = (ayt_completed / ayt_total) * 100
    
    # HaftalÄ±k ortalama hesapla (son 4 hafta simÃ¼lasyonu)
    weekly_avg = 12  # VarsayÄ±lan haftalÄ±k tamamlama
    projections['weekly_average'] = weekly_avg
    
    # Tahmini bitiÅŸ tarihi
    remaining_topics = total_topics - completed_topics
    if remaining_topics > 0 and weekly_avg > 0:
        weeks_needed = remaining_topics / (weekly_avg * 0.8)  # %80 baÅŸarÄ± faktÃ¶rÃ¼
        completion_date = datetime.now() + timedelta(weeks=weeks_needed)
        projections['estimated_completion'] = completion_date.strftime("%d %B %Y")
    
    return projections


def get_topic_level_from_tracking(topic, user_data):
    """Bir konunun mevcut seviyesini Konu Takip'ten alÄ±r"""
    topic_progress = json.loads(user_data.get('topic_progress', '{}') or '{}')
    current_net = topic_progress.get(topic['key'], '0')
    
    try:
        net_value = int(float(current_net))
        level_display = calculate_level(net_value)
        return {
            'net': net_value,
            'level': net_value,
            'display': level_display
        }
    except:
        return {
            'net': 0,
            'level': 0,
            'display': "ğŸ”´ ZayÄ±f Seviye (0-5 net)"
        }

def get_level_icon_yks(level):
    """Seviyeye gÃ¶re ikon dÃ¶ndÃ¼rÃ¼r"""
    if level <= 5:
        return "ğŸ”´"
    elif level <= 8:
        return "ğŸŸ "
    elif level <= 14:
        return "ğŸŸ¡"
    elif level <= 18:
        return "ğŸŸ¢"
    else:
        return "ğŸ”µ"

def count_completed_topics(weekly_plan, user_data):
    """HaftalÄ±k plandaki tamamlanan konu sayÄ±sÄ±nÄ± hesaplar"""
    if not weekly_plan:
        return 0
        
    new_topics = weekly_plan.get('new_topics', [])
    review_topics = weekly_plan.get('review_topics', [])
    all_topics = new_topics + review_topics
    
    completed = 0
    for topic in all_topics:
        if topic.get('net', 0) >= 14:  # Ä°yi seviye
            completed += 1
    return completed

def login_user_with_password(username, password):
    """ESKI VERSÄ°YON - Åifre ile giriÅŸ (gÃ¼venli)"""
    if not username or not password:
        return False
    
    if 'users_db' not in st.session_state:
        st.session_state.users_db = load_users_from_firebase()
    
    users_db = st.session_state.users_db
    
    # KullanÄ±cÄ± adÄ± var mÄ± kontrol et
    if username in users_db:
        user_data = users_db[username]
        # Åifre kontrolÃ¼
        if user_data.get('password') == password:
            # GiriÅŸ baÅŸarÄ±lÄ±, session'a kaydet
            st.session_state.current_user = username
            return True
    
    return False

def auto_save_user_progress(username):
    """KullanÄ±cÄ± ilerlemesini otomatik olarak Firebase'e kaydet"""
    try:
        if 'users_db' not in st.session_state:
            return False
        
        if username in st.session_state.users_db:
            user_data = st.session_state.users_db[username]
            # Son gÃ¼ncelleme tarihini ekle
            from datetime import datetime
            user_data['last_auto_save'] = datetime.now().isoformat()
            
            # Firebase'e kaydet
            return update_user_in_firebase(username, user_data)
    except Exception as e:
        st.error(f"Otomatik kaydetme hatasÄ±: {e}")
        return False
    return False

def ensure_data_persistence():
    """Veri kalÄ±cÄ±lÄ±ÄŸÄ±nÄ± garanti altÄ±na al"""
    if 'current_user' in st.session_state and st.session_state.current_user:
        # Her 30 saniyede bir otomatik kaydet
        import time
        current_time = time.time()
        last_save_key = f"last_save_{st.session_state.current_user}"
        
        if last_save_key not in st.session_state:
            st.session_state[last_save_key] = current_time
        
        # 30 saniye geÃ§tiyse kaydet
        if current_time - st.session_state[last_save_key] > 30:
            auto_save_user_progress(st.session_state.current_user)
            st.session_state[last_save_key] = current_time

def add_student_account(username, password, student_info=None):
    """YÃ–NETÄ°CÄ° tarafÄ±ndan Ã¶ÄŸrenci hesabÄ± ekleme (Sadece sizin kullanÄ±mÄ±nÄ±z iÃ§in)"""
    import json
    from datetime import datetime
    
    if not username or not password:
        return False, "KullanÄ±cÄ± adÄ± ve ÅŸifre gerekli!"
    
    if 'users_db' not in st.session_state:
        st.session_state.users_db = load_users_from_firebase()
    
    users_db = st.session_state.users_db
    
    # KullanÄ±cÄ± zaten var mÄ± kontrol et
    if username in users_db:
        return False, f"'{username}' kullanÄ±cÄ± adÄ± zaten mevcut!"
    
    # Yeni Ã¶ÄŸrenci verilerini hazÄ±rla
    new_student_data = {
        'username': username,
        'password': password,
        'created_date': datetime.now().isoformat(),
        'student_status': 'ACTIVE',
        'topic_progress': '{}',
        'topic_completion_dates': '{}',
        'topic_repetition_history': '{}',
        'topic_mastery_status': '{}',
        'pending_review_topics': '{}',
        'total_study_time': 0,
        'created_by': 'ADMIN',
        'last_login': None
    }
    
    # Ek Ã¶ÄŸrenci bilgileri varsa ekle
    if student_info:
        new_student_data.update(student_info)
    
    # Firebase'e kaydet
    if update_user_in_firebase(username, new_student_data):
        # Session'a da ekle
        st.session_state.users_db[username] = new_student_data
        return True, f"âœ… '{username}' Ã¶ÄŸrenci hesabÄ± baÅŸarÄ±yla oluÅŸturuldu!"
    else:
        return False, "âŒ Firebase kayÄ±t hatasÄ±!"

def login_user_secure(username, password):
    """ULTRA GÃœVENLÄ° kullanÄ±cÄ± giriÅŸ sistemi - Sadece Ã¶nceden kayÄ±tlÄ± Ã¶ÄŸrenciler"""
    if not username or not password:
        return False
    
    # ğŸ” GÄ°ZLÄ° ADMÄ°N KONTROLÃœ - Normal Ã¶ÄŸrenci formunda gizli admin giriÅŸi
    if username == "adminYKS2025" and password == "YKSadmin123!":
        st.session_state.admin_logged_in = True
        st.session_state.current_user = "ADMIN"
        return True
    
    if 'users_db' not in st.session_state:
        st.session_state.users_db = load_users_from_firebase()
    
    users_db = st.session_state.users_db
    
    # SADECE MEVCUT KULLANICILAR GÄ°REBÄ°LÄ°R
    if username in users_db:
        user_data = users_db[username]
        # Åifre kontrolÃ¼
        if user_data.get('password') == password:
            # Son giriÅŸ tarihini gÃ¼ncelle
            from datetime import datetime
            update_user_in_firebase(username, {
                'last_login': datetime.now().isoformat()
            })
            
            # Session'a kaydet
            st.session_state.current_user = username
            return True
        else:
            # YanlÄ±ÅŸ ÅŸifre
            return False
    else:
        # KullanÄ±cÄ± bulunamadÄ±
        return False

def backup_user_data_before_changes(username, operation_name):
    """KullanÄ±cÄ± verilerini deÄŸiÅŸiklik Ã¶ncesi yedekle"""
    import json
    from datetime import datetime
    
    try:
        if 'users_db' not in st.session_state:
            st.session_state.users_db = load_users_from_firebase()
        
        user_data = st.session_state.users_db.get(username, {})
        if user_data:
            backup_data = {
                'backup_date': datetime.now().isoformat(),
                'operation': operation_name,
                'user_data': user_data.copy()
            }
            
            # Backup'Ä± Firebase'e kaydet
            backup_ref = f"backups/{username}/{datetime.now().strftime('%Y%m%d_%H%M%S')}_{operation_name}"
            # Firebase backup kaydÄ± burada olmalÄ± - ÅŸimdilik session'da tut
            if 'user_backups' not in st.session_state:
                st.session_state.user_backups = {}
            st.session_state.user_backups[backup_ref] = backup_data
            
            return True
    except Exception as e:
        st.error(f"Backup hatasÄ±: {e}")
        return False
    
    return False

def get_user_data():
    """ğŸš€ OPTÄ°MÄ°ZE: Session cache ile kullanÄ±cÄ± verisi (artÄ±k her seferinde Ã§ekmiyor)"""
    # Session state'te users_db yoksa yÃ¼kle
    if 'users_db' not in st.session_state:
        st.session_state.users_db = load_users_from_firebase()
    
    if 'current_user' not in st.session_state or st.session_state.current_user is None:
        return {}
    
    users_db = st.session_state.users_db
    current_user = st.session_state.current_user
    
    if current_user in users_db:
        return users_db[current_user]
    else:
        return {}

def main():
    # ğŸš€ OPTÄ°MÄ°ZE EDÄ°LMÄ°Å: Cache sistemi baÅŸlat
    if 'firebase_cache' not in st.session_state:
        st.session_state.firebase_cache = FirebaseCache()
    
    # Veri kalÄ±cÄ±lÄ±ÄŸÄ±nÄ± garanti altÄ±na al
    ensure_data_persistence()
    
    # ğŸš€ OPTÄ°MÄ°ZE: Sadece users_db yoksa yÃ¼kle (artÄ±k her rerun'da Ã§ekmiyor!)
    if 'users_db' not in st.session_state:
        st.session_state.users_db = load_users_from_firebase()
    
    if 'current_user' not in st.session_state:
        st.session_state.current_user = None
    
    # Sayfa yÃ¶nlendirmeleri kontrolÃ¼
    if 'page' in st.session_state:
        if st.session_state.page == "learning_styles_test":
            run_vak_learning_styles_test()
            return
        elif st.session_state.page == "cognitive_profile_test":
            run_cognitive_profile_test()
            return
        elif st.session_state.page == "motivation_emotional_test":
            run_motivation_emotional_test()
            return
        elif st.session_state.page == "time_management_test":
            run_time_management_test()
            return
    
    if st.session_state.current_user is None:
        st.markdown(get_custom_css("VarsayÄ±lan"), unsafe_allow_html=True)
        st.markdown('<div class="main-header"><h1>ğŸ¯"Senin AlanÄ±n" YKS Takip Sistemi</h1><p>Hedefine Bilimsel YaklaÅŸÄ±m</p></div>', unsafe_allow_html=True)
        
        st.subheader("ğŸ” GÃ¼venli GiriÅŸ")
        
        # Firebase durumuna gÃ¶re mesaj
        if db_ref is None:
            st.warning("âš ï¸ Firebase baÄŸlantÄ±sÄ± yok - Test modu aktif")
            with st.expander("ğŸ“‹ Test KullanÄ±cÄ± Bilgileri", expanded=True):
                st.success("ğŸ‘¤ **Test Ã–ÄŸrenci:**\n- KullanÄ±cÄ± AdÄ±: `test_ogrenci`\n- Åifre: `123456`")
                st.info("ğŸ‘¤ **Admin:**\n- KullanÄ±cÄ± AdÄ±: `admin`\n- Åifre: `admin123`")
        else:
            st.info("ğŸ›¡ï¸ Sadece kayÄ±tlÄ± Ã¶ÄŸrenciler sisteme eriÅŸebilir")
        
        username = st.text_input("KullanÄ±cÄ± AdÄ±")
        password = st.text_input("Åifre", type="password")
        
        if st.button("GiriÅŸ Yap", type="primary", use_container_width=True):
            if login_user_secure(username, password):
                st.success("GiriÅŸ baÅŸarÄ±lÄ±! HoÅŸ geldiniz! ğŸ¯")
                time.sleep(1)
                st.rerun()
            else:
                st.error("âŒ HatalÄ± kullanÄ±cÄ± adÄ± veya ÅŸifre!")
                st.warning("ğŸ”’ Bu sisteme sadece kayÄ±tlÄ± Ã¶ÄŸrenciler eriÅŸebilir.")
    
    else:
        # ğŸ” Admin panel kontrolÃ¼ - Gizli admin giriÅŸi kontrolÃ¼
        if st.session_state.get('admin_logged_in', False):
            show_admin_dashboard()
            return
        
        user_data = get_user_data()
        
        profile_complete = user_data.get('name') and user_data.get('tyt_avg_net')
        learning_style_complete = user_data.get('learning_style')
        
        if not profile_complete:
            st.markdown(get_custom_css("VarsayÄ±lan"), unsafe_allow_html=True)
            st.markdown('<div class="main-header"><h1>ğŸ“ Profil Bilgilerinizi TamamlayÄ±n</h1><p>Sistemi size Ã¶zel hale getirmek iÃ§in bu bilgileri doldurmalÄ±sÄ±nÄ±z</p></div>', unsafe_allow_html=True)
            
            st.subheader("Ã–ÄŸrenci Bilgileri")
            col1, col2 = st.columns(2)
            
            with col1:
                name = st.text_input("AdÄ±nÄ±z", key="name_input")
                surname = st.text_input("SoyadÄ±nÄ±z", key="surname_input")
                grade = st.selectbox("SÄ±nÄ±fÄ±nÄ±z", ["11. SÄ±nÄ±f", "12. SÄ±nÄ±f", "Mezun"], key="grade_input")
                field = st.selectbox("AlanÄ±nÄ±z", ["SayÄ±sal", "SÃ¶zel", "EÅŸit AÄŸÄ±rlÄ±k", "TYT & MSÃœ"], key="field_input")
                
                # ğŸ¯ TYT & MSÃœ iÃ§in alt kategori seÃ§imi
                sub_category = None
                if field == "TYT & MSÃœ":
                    st.markdown("**ğŸ¯ Alt Kategori SeÃ§iniz:**")
                    sub_category = st.selectbox(
                        "HedeflediÄŸiniz alan", 
                        [
                            "MSÃœ - Kara Astsubay Meslek YÃ¼ksekokulu",
                            "MSÃœ - Deniz Astsubay YÃ¼ksekokulu", 
                            "MSÃœ - Hava Astsubay YÃ¼ksekokulu",
                            "TYT - Bilgisayar ProgramcÄ±lÄ±ÄŸÄ±",
                            "TYT - Anestezi TeknisyenliÄŸi",
                            "TYT - Acil TÄ±p TeknisyenliÄŸi (ATT)",
                            "TYT - Ã‡ocuk GeliÅŸimi",
                            "TYT - Ebe",
                            "TYT - Hemato terapiliÅŸi",
                            "TYT - TÄ±bbi Laboratuvar Teknikleri",
                            "TYT - TÄ±bbi GÃ¶rÃ¼ntÃ¼leme Teknikleri",
                            "TYT - Radyoterapi",
                            "TYT - Diyaliz",
                            "TYT - DiÅŸ ProtÃ©s TeknisyenliÄŸi",
                            "TYT - Otomotiv Teknolojisi",
                            "TYT - Elektrik-Elektronik Teknolojisi",
                            "TYT - Makine Teknolojisi",
                            "TYT - Ä°nÅŸaat Teknolojisi",
                            "TYT - DiÄŸer Meslek YÃ¼ksekokulu"
                        ], 
                        key="sub_category_input"
                    )
                
                # âš ï¸ TYT & MSÃœ seÃ§ildiÄŸinde alt kategori zaten hedef bÃ¶lÃ¼mÃ¼ belirliyor
                if field != "TYT & MSÃœ":
                    # ğŸ¯ Alan bazÄ±nda bÃ¶lÃ¼m filtrelemesi
                    if field == "SayÄ±sal":
                        allowed_departments = ["TÄ±p", "DiÅŸ HekimliÄŸi", "MÃ¼hendislik", "VarsayÄ±lan"]
                    elif field == "SÃ¶zel":
                        allowed_departments = ["Hukuk", "Ã–ÄŸretmenlik", "Psikoloji", "Ä°ktisat", "VarsayÄ±lan"]
                    elif field == "EÅŸit AÄŸÄ±rlÄ±k":
                        allowed_departments = ["Ä°ktisat", "Ã–ÄŸretmenlik", "MimarlÄ±k", "Hukuk", "Psikoloji", "VarsayÄ±lan"]
                    else:
                        allowed_departments = list(BACKGROUND_STYLES.keys())[:-1]  # TÃ¼m bÃ¶lÃ¼mler
                    
                    target = st.selectbox("Hedef BÃ¶lÃ¼mÃ¼nÃ¼z", allowed_departments, key="target_input")
                else:
                    # TYT & MSÃœ iÃ§in alt kategori hedef bÃ¶lÃ¼m olarak kullanÄ±lacak
                    target = sub_category if sub_category else "Genel"
            
            with col2:
                st.subheader("ğŸ“Š Net Bilgileri")
                
                # TYT Net AralÄ±klarÄ±
                st.write("**TYT Netler**")
                
                # TYT aralÄ±k seÃ§enekleri (kullanÄ±cÄ±ya sadece aralÄ±k gÃ¶steriliyor)
                tyt_ranges = [
                    {"display": "0-25", "value": "0-25", "level": "BaÅŸlangÄ±Ã§", "avg": 12.5},
                    {"display": "25-40", "value": "25-40", "level": "GeliÅŸen", "avg": 32.5},
                    {"display": "40-55", "value": "40-55", "level": "Orta", "avg": 47.5},
                    {"display": "55-65", "value": "55-65", "level": "Ä°yi", "avg": 60},
                    {"display": "65-80", "value": "65-80", "level": "Ã‡ok Ä°yi", "avg": 72.5},
                    {"display": "80-95", "value": "80-95", "level": "MÃ¼kemmel", "avg": 87.5},
                    {"display": "95+", "value": "95+", "level": "Uzman", "avg": 100}
                ]
                
                tyt_last_range = st.selectbox(
                    "Son TYT Net AralÄ±ÄŸÄ±nÄ±z", 
                    [r["display"] for r in tyt_ranges], 
                    key="tyt_last_input"
                )
                tyt_avg_range = st.selectbox(
                    "Genel TYT Net OrtalamanÄ±z", 
                    [r["display"] for r in tyt_ranges], 
                    key="tyt_avg_input"
                )
                
                # AYT Net AralÄ±klarÄ±
                st.write("**AYT Netler**")
                
                # AYT aralÄ±k seÃ§enekleri (kullanÄ±cÄ±ya sadece aralÄ±k gÃ¶steriliyor)
                ayt_ranges = [
                    {"display": "0-20", "value": "0-20", "level": "BaÅŸlangÄ±Ã§", "avg": 10},
                    {"display": "20-35", "value": "20-35", "level": "GeliÅŸen", "avg": 27.5},
                    {"display": "35-50", "value": "35-50", "level": "Ä°yi", "avg": 42.5},
                    {"display": "50-65+", "value": "50-65+", "level": "MÃ¼kemmel", "avg": 57.5}
                ]
                
                ayt_last_range = st.selectbox(
                    "Son AYT Net AralÄ±ÄŸÄ±nÄ±z", 
                    [r["display"] for r in ayt_ranges], 
                    key="ayt_last_input"
                )
                ayt_avg_range = st.selectbox(
                    "Genel AYT Net OrtalamanÄ±z", 
                    [r["display"] for r in ayt_ranges], 
                    key="ayt_avg_input"
                )
                
                # SeÃ§ilen aralÄ±klarÄ±n orta deÄŸerlerini hesapla (sistem iÃ§in)
                tyt_last = next(r["avg"] for r in tyt_ranges if r["display"] == tyt_last_range)
                tyt_avg = next(r["avg"] for r in tyt_ranges if r["display"] == tyt_avg_range)
                ayt_last = next(r["avg"] for r in ayt_ranges if r["display"] == ayt_last_range)
                ayt_avg = next(r["avg"] for r in ayt_ranges if r["display"] == ayt_avg_range)
                
                # Seviye etiketlerini sistem iÃ§in sakla (kullanÄ±cÄ±ya gÃ¶sterilmez)
                tyt_last_level = next(r["level"] for r in tyt_ranges if r["display"] == tyt_last_range)
                tyt_avg_level = next(r["level"] for r in tyt_ranges if r["display"] == tyt_avg_range)
                ayt_last_level = next(r["level"] for r in ayt_ranges if r["display"] == ayt_last_range)
                ayt_avg_level = next(r["level"] for r in ayt_ranges if r["display"] == ayt_avg_range)
            
            if st.button("ğŸ’¾ Bilgileri Kaydet", type="primary", use_container_width=True):
                # TYT & MSÃœ seÃ§ilmiÅŸse sub_category zorunlu
                validation_error = False
                if field == "TYT & MSÃœ" and not sub_category:
                    st.error("ğŸš¨ TYT & MSÃœ alanÄ± iÃ§in alt kategori seÃ§imi zorunludur!")
                    validation_error = True
                
                # TYT & MSÃœ iÃ§in target kontrolÃ¼nÃ¼ Ã¶zel olarak yap
                target_valid = target if field != "TYT & MSÃœ" else sub_category
                
                if not validation_error and name and surname and target_valid and tyt_last is not None and tyt_avg is not None and ayt_last is not None and ayt_avg is not None:
                    # Kaydedilecek veri yapÄ±sÄ±
                    user_data_to_save = {
                        'name': name,
                        'surname': surname,
                        'grade': grade,
                        'field': field,
                        'target_department': target,
                        'tyt_last_net': str(tyt_last),
                        'tyt_avg_net': str(tyt_avg),
                        'ayt_last_net': str(ayt_last),
                        'ayt_avg_net': str(ayt_avg),
                        # Net aralÄ±k bilgileri (kullanÄ±cÄ±nÄ±n seÃ§tiÄŸi aralÄ±k)
                        'tyt_last_range': tyt_last_range,
                        'tyt_avg_range': tyt_avg_range,
                        'ayt_last_range': ayt_last_range,
                        'ayt_avg_range': ayt_avg_range,
                        # Seviye etiketleri (sistem iÃ§in - BaÅŸlangÄ±Ã§, GeliÅŸen, vb.)
                        'tyt_last_level': tyt_last_level,
                        'tyt_avg_level': tyt_avg_level,
                        'ayt_last_level': ayt_last_level,
                        'ayt_avg_level': ayt_avg_level,
                        # Dinamik haftalÄ±k plan iÃ§in kayÄ±t tarihi
                        'created_at': datetime.now().isoformat(),
                        'is_profile_complete': 'True'
                    }
                    
                    # TYT & MSÃœ ise alt kategoriyi de kaydet
                    if field == "TYT & MSÃœ" and sub_category:
                        user_data_to_save['tyt_msu_sub_category'] = sub_category
                    
                    update_user_in_firebase(st.session_state.current_user, user_data_to_save)
                    
                    # ğŸš€ OPTÄ°MÄ°ZE: Update sonrasÄ± fresh data gerek
                    st.session_state.users_db = load_users_from_firebase(force_refresh=True)
                    st.session_state.is_profile_complete = True 
                    st.success("ğŸ‰ Bilgileriniz baÅŸarÄ±yla kaydedildi! Åimdi Ã¶ÄŸrenme stilinizi belirleyelim.")
                    
                    st.rerun()
                else:
                    st.error("âš ï¸ LÃ¼tfen tÃ¼m alanlarÄ± doldurun!")
        
        elif not learning_style_complete:
            # DÃ¶rt testin durumunu kontrol et
            vak_test_completed = user_data.get('vak_test_results')
            cognitive_test_completed = user_data.get('cognitive_test_results')
            motivation_test_completed = user_data.get('motivation_test_results')
            time_management_test_completed = user_data.get('time_management_test_results')
            
            st.markdown(get_custom_css("VarsayÄ±lan"), unsafe_allow_html=True)
            
            # Ana sistem baÅŸlÄ±ÄŸÄ±
            st.markdown("""
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                            padding: 30px; border-radius: 20px; margin: 20px 0; text-align: center;">
                    <h1 style="color: white; margin: 0; font-size: 2.5em;">ğŸ§­ GENEL PSÄ°KOLOJÄ°K ANALÄ°Z SÄ°STEMÄ°</h1>
                    <p style="color: white; font-size: 1.2em; margin: 10px 0; font-style: italic;">
                        "Kendini TanÄ± & DoÄŸru Ã‡alÄ±ÅŸ" Sistemi
                    </p>
                </div>
            """, unsafe_allow_html=True)
            
            # 4 Test Karesi Modern DÃ¼zenlemesi
            st.markdown("""
            <style>
            .test-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 60px 50px;
                margin: 50px 0;
                padding: 0 20px;
            }
            
            /* Genel kart stilleri */
            .test-card {
                position: relative;
                border-radius: 20px;
                padding: 30px 25px;
                text-align: center;
                border: none;
                overflow: hidden;
                transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                cursor: pointer;
                height: 300px;
                width: 100%;
                display: flex;
                flex-direction: column;
                justify-content: space-between;
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
            }
            
            /* FarklÄ± renkli kartlar - Resimdeki gibi modern renkler */
            .test-card.vak {
                background: linear-gradient(135deg, #8B5CF6 0%, #A855F7 50%, #C084FC 100%);
                box-shadow: 0 4px 20px rgba(139, 92, 246, 0.25);
            }
            
            .test-card.cognitive {
                background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 50%, #1E40AF 100%);
                box-shadow: 0 4px 20px rgba(59, 130, 246, 0.25);
            }
            
            .test-card.motivation {
                background: linear-gradient(135deg, #F59E0B 0%, #F97316 50%, #EA580C 100%);
                box-shadow: 0 4px 20px rgba(245, 158, 11, 0.25);
            }
            
            .test-card.time {
                background: linear-gradient(135deg, #10B981 0%, #059669 50%, #047857 100%);
                box-shadow: 0 4px 20px rgba(16, 185, 129, 0.25);
            }
            
            /* Hover efektleri */
            .test-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            }
            
            .test-card.vak:hover {
                box-shadow: 0 8px 30px rgba(139, 92, 246, 0.4);
                background: linear-gradient(135deg, #9333EA 0%, #B45BF7 50%, #D8B4FE 100%);
            }
            
            .test-card.cognitive:hover {
                box-shadow: 0 8px 30px rgba(59, 130, 246, 0.4);
                background: linear-gradient(135deg, #2563EB 0%, #1E40AF 50%, #1E3A8A 100%);
            }
            
            .test-card.motivation:hover {
                box-shadow: 0 8px 30px rgba(245, 158, 11, 0.4);
                background: linear-gradient(135deg, #F59E0B 0%, #FB923C 50%, #F97316 100%);
            }
            
            .test-card.time:hover {
                box-shadow: 0 8px 30px rgba(16, 185, 129, 0.4);
                background: linear-gradient(135deg, #059669 0%, #10B981 50%, #34D399 100%);
            }
            
            .test-icon {
                font-size: 3rem;
                margin-bottom: 12px;
                filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
            }
            
            .test-title {
                font-size: 1.2rem;
                font-weight: 700;
                color: white;
                margin-bottom: 8px;
                text-shadow: 0 2px 4px rgba(0,0,0,0.3);
                line-height: 1.3;
            }
            
            .test-subtitle {
                font-size: 0.95rem;
                color: rgba(255,255,255,0.9);
                margin-bottom: 12px;
                font-weight: 500;
            }
            
            .test-details {
                font-size: 0.85rem;
                color: rgba(255,255,255,0.8);
                line-height: 1.5;
                margin-bottom: 20px;
                font-weight: 400;
            }
            
            .test-status {
                padding: 10px 20px;
                border-radius: 25px;
                font-weight: 600;
                font-size: 0.9rem;
                margin-bottom: 15px;
                backdrop-filter: blur(10px);
                border: 2px solid rgba(255,255,255,0.2);
            }
            
            .status-completed {
                background: rgba(76, 175, 80, 0.9);
                color: white;
                box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
            }
            
            .status-waiting {
                background: rgba(255, 193, 7, 0.9);
                color: white;
                box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
            }
            
            /* Responsive tasarÄ±m */
            @media (max-width: 768px) {
                .test-grid {
                    grid-template-columns: 1fr;
                    gap: 40px;
                    padding: 0 15px;
                }
                .test-card {
                    height: 250px;
                    padding: 20px 15px;
                }
                .test-icon {
                    font-size: 2.5rem;
                }
                .test-title {
                    font-size: 1.05rem;
                }
            }
            
            /* Button stilleri */
            .stButton > button {
                background: linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0.1)) !important;
                border: 2px solid rgba(255,255,255,0.3) !important;
                color: white !important;
                font-weight: 600 !important;
                border-radius: 15px !important;
                backdrop-filter: blur(10px) !important;
                transition: all 0.3s ease !important;
            }
            
            .stButton > button:hover {
                background: linear-gradient(135deg, rgba(255,255,255,0.3), rgba(255,255,255,0.2)) !important;
                border: 2px solid rgba(255,255,255,0.5) !important;
                transform: translateY(-2px) !important;
                box-shadow: 0 8px 25px rgba(0,0,0,0.2) !important;
            }
            </style>
            
            <div class="test-grid">
            """, unsafe_allow_html=True)
            
            # Test KartlarÄ± Verilerini TanÄ±mla
            test_cards = [
                {
                    'id': 'vak',
                    'class': 'vak',
                    'icon': 'ğŸ“š',
                    'title': 'Ã–ÄŸrenme Stilleri Testi (VAK)',
                    'subtitle': '75 soru - GÃ¶rsel, Ä°ÅŸitsel, Kinestetik',
                    'details': '',
                    'completed': vak_test_completed,
                    'page': 'learning_styles_test'
                },
                {
                    'id': 'cognitive',
                    'class': 'cognitive',
                    'icon': 'ğŸ§ ',
                    'title': 'BiliÅŸsel Profil Testi',
                    'subtitle': '20 soru - Likert gÃ¶sterim (1-5)',
                    'details': '',
                    'completed': cognitive_test_completed,
                    'page': 'cognitive_profile_test'
                },
                {
                    'id': 'motivation',
                    'class': 'motivation',
                    'icon': 'âš¡',
                    'title': 'Motivasyon & Duygu Testi',
                    'subtitle': '',
                    'details': 'ğŸ’« Ä°Ã§sel/DÄ±ÅŸsal motivasyon<br>ğŸ˜° SÄ±nav kaygÄ±sÄ± dÃ¼zeyi<br>ğŸ’ª Duygusal dayanÄ±klÄ±lÄ±k',
                    'completed': motivation_test_completed,
                    'page': 'motivation_emotional_test'
                },
                {
                    'id': 'time',
                    'class': 'time',
                    'icon': 'â°',
                    'title': 'Zaman YÃ¶netimi Testi',
                    'subtitle': '',
                    'details': 'ğŸ“‹ Planlama & disiplin<br>â° Erteleme<br>ğŸ¯ Odak kontrolÃ¼',
                    'completed': time_management_test_completed,
                    'page': 'time_management_test'
                }
            ]
            
            # Her test iÃ§in kart oluÅŸtur
            cols = st.columns(2)
            for i, test in enumerate(test_cards):
                col_index = i % 2
                with cols[col_index]:
                    status_class = "status-completed" if test['completed'] else "status-waiting"
                    status_text = "âœ… TamamlandÄ±" if test['completed'] else "â³ Beklemede"
                    
                    st.markdown(f"""
                    <div class="test-card {test['class']}">
                        <div>
                            <div class="test-icon">{test['icon']}</div>
                            <div class="test-title">{test['title']}</div>
                            <div class="test-subtitle">{test['subtitle']}</div>
                            <div class="test-details">{test['details']}</div>
                        </div>
                        <div class="test-status {status_class}">{status_text}</div>
                    </div>
                    """, unsafe_allow_html=True)
                    
                    # Butonlar
                    if not test['completed']:
                        if st.button(f"ğŸš€ Testi Åimdi Doldur", key=f"start_now_{test['id']}", use_container_width=True, type="primary"):
                            st.session_state.page = test['page']
                            st.rerun()
                        
                        if st.button(f"â³ Sonra Doldur", key=f"start_later_{test['id']}", use_container_width=True):
                            st.info(f"{test['title']} daha sonra iÃ§in kaydedildi.")
            
            st.markdown('</div>', unsafe_allow_html=True)
            
            # "Verilerimi Kaydet ve Tamamla" BÃ¶lÃ¼mÃ¼
            st.markdown("<br>", unsafe_allow_html=True)
            st.markdown("""
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                            padding: 30px; border-radius: 25px; margin: 25px 0; text-align: center;
                            border: 3px solid rgba(255,255,255,0.2);
                            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.3);
                            position: relative;
                            overflow: hidden;">
                    <div style="position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; 
                                background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
                                animation: pulse 4s ease-in-out infinite;"></div>
                    <div style="position: relative; z-index: 1;">
                        <h3 style="color: white; margin: 0 0 15px 0; font-size: 1.8em; 
                                   text-shadow: 0 3px 6px rgba(0,0,0,0.3);">
                            ğŸ’¾ Verilerimi Kaydet ve Tamamla
                        </h3>
                        <p style="color: rgba(255,255,255,0.95); margin: 0; font-size: 1.15em; 
                                  line-height: 1.5; font-weight: 500;">
                            ğŸ¯ Testleri istediÄŸiniz zaman yapabilirsiniz<br>
                            âš¡ Åimdi sistemi aÃ§abilir ve Ã§alÄ±ÅŸmaya baÅŸlayabilirsiniz!
                        </p>
                    </div>
                </div>
                
                <style>
                @keyframes pulse {
                    0%, 100% { transform: scale(1) rotate(0deg); opacity: 0.3; }
                    50% { transform: scale(1.1) rotate(180deg); opacity: 0.1; }
                }
                </style>
            """, unsafe_allow_html=True)
                
            # Modern buton stili ekle
            st.markdown("""
                <style>
                .final-button > button {
                    background: linear-gradient(135deg, #00b894 0%, #00a085 100%) !important;
                    border: none !important;
                    color: white !important;
                    font-weight: 700 !important;
                    font-size: 1.2em !important;
                    padding: 15px 30px !important;
                    border-radius: 20px !important;
                    box-shadow: 0 8px 25px rgba(0, 184, 148, 0.3) !important;
                    transition: all 0.3s ease !important;
                    text-transform: uppercase !important;
                    letter-spacing: 1px !important;
                }
                
                .final-button > button:hover {
                    background: linear-gradient(135deg, #00a085 0%, #00b894 100%) !important;
                    transform: translateY(-3px) !important;
                    box-shadow: 0 15px 35px rgba(0, 184, 148, 0.4) !important;
                }
                
                .final-button > button:active {
                    transform: translateY(0px) !important;
                }
                </style>
            """, unsafe_allow_html=True)
            
            # Butonu Ã¶zel CSS ile sarmalayÄ±n
            st.markdown('<div class="final-button">', unsafe_allow_html=True)
            button_clicked = st.button("ğŸ’¾ Verilerimi Kaydet ve Sistemi AÃ§", type="primary", use_container_width=True, key="save_and_complete")
            st.markdown('</div>', unsafe_allow_html=True)
            
            if button_clicked:
                # Profili tamamlandÄ± olarak iÅŸaretle
                profile_data = {'learning_style': 'Profil TamamlandÄ±'}
                
                # EÄŸer testler tamamlandÄ±ysa sonuÃ§larÄ± dahil et
                if vak_test_completed:
                    vak_results = json.loads(vak_test_completed) if isinstance(vak_test_completed, str) else vak_test_completed
                    visual_score = vak_results.get('visual', 0)
                    auditory_score = vak_results.get('auditory', 0)
                    kinesthetic_score = vak_results.get('kinesthetic', 0)
                    
                    max_score = max(visual_score, auditory_score, kinesthetic_score)
                    if visual_score == max_score:
                        dominant_learning_style = "GÃ¶rsel"
                    elif auditory_score == max_score:
                        dominant_learning_style = "Ä°ÅŸitsel"
                    else:
                        dominant_learning_style = "Kinestetik"
                    
                    if cognitive_test_completed:
                        cognitive_results = json.loads(cognitive_test_completed) if isinstance(cognitive_test_completed, str) else cognitive_test_completed
                        combined_profile = f"{dominant_learning_style} Ã–ÄŸrenme + {cognitive_results.get('dominant_profile', 'Analitik')} BiliÅŸsel"
                    else:
                        combined_profile = f"{dominant_learning_style} Ã–ÄŸrenme"
                    
                    profile_data['learning_style'] = combined_profile
                    profile_data['learning_style_scores'] = json.dumps({
                        'visual': visual_score,
                        'auditory': auditory_score,
                        'kinesthetic': kinesthetic_score
                    })
                
                # Profili kaydet
                update_user_in_firebase(st.session_state.current_user, profile_data)
                # ğŸš€ OPTÄ°MÄ°ZE: update_user_in_firebase() zaten session state'i gÃ¼nceller
                
                st.success("âœ… Verileriniz kaydedildi! Sisteme hoÅŸ geldiniz!")
                time.sleep(2)
                st.rerun()


        else:
            # âœ¨ HoÅŸ geldin mesajÄ±nÄ± gÃ¶ster - SADECE profil tamamlandÄ±ktan sonra!
            if not st.session_state.get('admin_logged_in', False):
                check_and_show_welcome_message(st.session_state.current_user)
            
            target_dept = user_data.get('target_department', 'VarsayÄ±lan')
            
            st.markdown(get_custom_css(target_dept), unsafe_allow_html=True)
            
            progress_data = calculate_subject_progress(user_data)
            
            with st.sidebar:
                # Logo - En Ã¼stte!
                st.markdown("""
                <div style="
        background-color: white;
        border-radius: 25px;
        width: 220px;
        height: 240px;
        display: flex;
        align-items: center;        /* dikey ortalama */
        justify-content: center;    /* yatay ortalama */
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        margin: auto;
       
        
    BurasÄ± "Senin AlanÄ±n" 
        <img src="https://raw.githubusercontent.com/g2672v6dps-ship-it/ykstakipdf/0538075040afbf31b8a262ce85d449137fbdac30/logodf.png"
             alt="Psiko DSF Logo"
             style="width:160px; height:160px; border-radius:20px; object-fit: contain;">
    </div>
    """,
    unsafe_allow_html=True
)

                
                # Sayfa seÃ§imi - Logo'dan sonra!
                page = st.sidebar.selectbox("ğŸŒ Sayfa SeÃ§in", 
                                          ["ğŸ  Ana Sayfa", "ğŸ“š Konu Takip", "ğŸ§  Ã‡alÄ±ÅŸma Teknikleri","ğŸ¯ YKS CanlÄ± Takip", "ğŸ… Pomodoro Timer", "ğŸ† Rekabet Panosu", "ğŸ§  Psikolojim","ğŸ”¬DetaylÄ± Deneme Analiz Takibi","ğŸ“Š Ä°statistikler", "ğŸ¬ Filmi BaÅŸlatâ€“ Ä°lk GÃ¼nden BugÃ¼ne YKS YolculuÄŸum"])
                st.markdown("---")
                
                bg_style = BACKGROUND_STYLES.get(target_dept, BACKGROUND_STYLES["VarsayÄ±lan"])
                st.markdown(f"### {bg_style['icon']} HoÅŸ geldin, {user_data.get('name', 'Ã–ÄŸrenci')}!")
                st.markdown(f"**ğŸ¯ Hedef:** {user_data.get('target_department', 'Belirlenmedi')}")
                st.markdown(f"**ğŸ“Š Alan:** {user_data.get('field', 'Belirlenmedi')}")
                st.markdown(f"**ğŸ« SÄ±nÄ±f:** {user_data.get('grade', 'Belirlenmedi')}")
                st.markdown("---")
                st.markdown("**ğŸ“ˆ Net Durumu**")
                
                # Net deÄŸerlerini dÃ¼zenli formatla gÃ¶ster
                tyt_last = user_data.get('tyt_last_net', '0')
                tyt_avg = user_data.get('tyt_avg_net', '0')
                ayt_last = user_data.get('ayt_last_net', '0')
                ayt_avg = user_data.get('ayt_avg_net', '0')
                
                try:
                    tyt_last_f = f"{float(tyt_last):.1f}" if tyt_last != 'Belirlenmedi' else 'Belirlenmedi'
                except:
                    tyt_last_f = tyt_last
                    
                try:
                    tyt_avg_f = f"{float(tyt_avg):.1f}" if tyt_avg != 'Belirlenmedi' else 'Belirlenmedi'
                except:
                    tyt_avg_f = tyt_avg
                    
                try:
                    ayt_last_f = f"{float(ayt_last):.1f}" if ayt_last != 'Belirlenmedi' else 'Belirlenmedi'
                except:
                    ayt_last_f = ayt_last
                    
                try:
                    ayt_avg_f = f"{float(ayt_avg):.1f}" if ayt_avg != 'Belirlenmedi' else 'Belirlenmedi'
                except:
                    ayt_avg_f = ayt_avg
                
                st.markdown(f"**TYT Son:** {tyt_last_f}")
                st.markdown(f"**TYT Ort:** {tyt_avg_f}")
                st.markdown(f"**AYT Son:** {ayt_last_f}")
                st.markdown(f"**AYT Ort:** {ayt_avg_f}")
                

                
                st.markdown("---")
                st.markdown("**ğŸ§  Ã–ÄŸrenme Stili DaÄŸÄ±lÄ±mÄ±**")
                style_scores_str = user_data.get('learning_style_scores', None)
                if style_scores_str:
                    try:
                        style_scores = json.loads(style_scores_str.replace("'", "\""))
                        sorted_styles = sorted(style_scores.items(), key=lambda item: item[1], reverse=True)
                        for style, score in sorted_styles:
                            if score > 0:
                                st.write(f"- {style}: %{score:.1f}")
                    except json.JSONDecodeError:
                        st.write("Veri HatasÄ±")
                else:
                    st.write("HenÃ¼z belirlenmedi.")
                
                total_completed = sum(data['completed'] for data in progress_data.values())
                total_topics = count_total_topics()
                genel_ilerleme = (total_completed / total_topics * 100) if total_topics > 0 else 0
                    
                st.markdown("---")
                st.metric("ğŸ“ˆ Genel Ä°lerleme", f"%{genel_ilerleme:.1f}")
                st.metric("âœ… Tamamlanan", f"{total_completed}/{total_topics}")
                
                # Debug modu kontrolÃ¼ (geliÅŸtiriciler iÃ§in)
                st.markdown("---")
                col1, col2 = st.columns(2)
                
                with col1:
                    if st.button("ğŸšª Ã‡Ä±kÄ±ÅŸ Yap", use_container_width=True):
                        st.session_state.current_user = None
                        st.rerun()
                
                with col2:
                    debug_mode = st.session_state.get('debug_mode', False)
                    if st.button(f"ğŸ” Debug {'ON' if debug_mode else 'OFF'}", use_container_width=True):
                        st.session_state.debug_mode = not debug_mode
                        st.rerun()
                
                # Debug bilgileri gÃ¶ster
                if st.session_state.get('debug_mode', False):
                    st.markdown("### ğŸ” Debug Bilgileri")
                    st.info(f"ğŸ‘¤ Aktif KullanÄ±cÄ±: {st.session_state.get('current_user', 'Bilinmiyor')}")
                    st.info(f"ğŸ“… KullanÄ±cÄ± KayÄ±t Tarihi: {user_data.get('created_at', 'Bilinmiyor')}")
                    st.info(f"ğŸ”¤ KullanÄ±cÄ± Username: {user_data.get('username', 'Bilinmiyor')}")
                    st.info(f"ğŸ“ KullanÄ±cÄ± AdÄ±: {user_data.get('name', 'Bilinmiyor')}")
                    
                    # Session state kontrolÃ¼
                    if st.button("ğŸ§¹ Session State Temizle"):
                        for key in list(st.session_state.keys()):
                            if key not in ['current_user', 'debug_mode']:
                                del st.session_state[key]
                        st.success("âœ… Session state temizlendi!")
            

            
            if page == "ğŸ  Ana Sayfa":
                # Eski session verilerini temizle - her gÃ¼n gÃ¼ncel sistem!
                clear_outdated_session_data()
                
                # GÃ¼ncel tarih bilgisi ekle
                week_info = get_current_week_info()
                days_to_yks = week_info['days_to_yks']
                
                bg_style = BACKGROUND_STYLES.get(target_dept, BACKGROUND_STYLES["VarsayÄ±lan"])
                st.markdown(f'<div class="main-header"><h1>{bg_style["icon"]} {user_data["target_department"]} YolculuÄŸunuz</h1><p>Hedefinize doÄŸru emin adÄ±mlarla ilerleyin</p><p>ğŸ“… {week_info["today"].strftime("%d %B %Y")} | â° YKS\'ye {days_to_yks} gÃ¼n kaldÄ±!</p></div>', unsafe_allow_html=True)
                
                # Ä°lerleme Ã¶zeti - kartlar (motivasyondan Ã¶nce)
                overall_progress = calculate_subject_progress(user_data)
                total_completed = sum(data['completed'] for data in overall_progress.values())
                total_topics = count_total_topics()
                overall_percent = (total_completed / total_topics * 100) if total_topics > 0 else 0
                
                col1, col2, col3, col4 = st.columns(4)
                
                with col1:
                    st.metric("âœ… Tamamlanan Konular", f"{total_completed}/{total_topics}")
                
                with col2:
                    st.metric("ğŸ“š Toplam Ders", len(progress_data))
                
                with col3:
                    avg_per_subject = sum(data['percent'] for data in progress_data.values()) / len(progress_data) if progress_data else 0
                    st.metric("ğŸ“ˆ Ders OrtalamasÄ±", f"%{avg_per_subject:.1f}")
                with col4:
                    st.metric("ğŸ¯ Hedef BÃ¶lÃ¼m", user_data.get('target_department', 'Belirlenmedi'), delta_color="off")
                

                # ğŸ¯ GÃœNLÃœK MOTÄ°VASYON VE Ã‡ALIÅMA TAKÄ°BÄ° SÄ°STEMÄ° - YENÄ°!
                st.markdown("---")
                st.subheader("ğŸ¯ GÃ¼nlÃ¼k Motivasyon ve Ã‡alÄ±ÅŸma Takibi")
                
                # BugÃ¼nkÃ¼ tarih string'i
                today_str = week_info["today"].strftime("%Y-%m-%d")
                
                # GÃ¼nlÃ¼k motivasyon verilerini Ã§ek
                daily_motivation = json.loads(user_data.get('daily_motivation', '{}'))
                today_motivation = daily_motivation.get(today_str, {
                    'score': 5, 
                    'note': '',
                    'questions': {},
                    'tests': {
                        'genel_deneme': 0,
                        'brans_deneme': 0
                    },
                    'paragraf_questions': 0,
                    'photo_data': None,
                    'photo_caption': ''
                })
                
                # Eski format veri uyumluluÄŸu - mevcut eski verileri yeni formata geÃ§ir
                if 'questions' in today_motivation:
                    eski_questions = today_motivation['questions']
                    # Eski format -> Yeni format dÃ¶nÃ¼ÅŸÃ¼mÃ¼
                    eski_yeni_mapping = {
                        'matematik': 'tyt_matematik',
                        'fizik': 'tyt_fizik', 
                        'kimya': 'tyt_kimya',
                        'biyoloji': 'tyt_biyoloji',
                        'turkce': 'tyt_turkce',
                        'tarih': 'tyt_tarih',
                        'cografya': 'tyt_cografya',
                        'edebiyat': 'ayt_edebiyat',
                        'felsefe': 'tyt_felsefe',
                        'din': 'tyt_din',
                        'geometri': 'tyt_geometri'
                    }
                    
                    # Eski key'leri varsa yeni format'a Ã§evir (sadece yeni key yoksa)
                    for eski_key, yeni_key in eski_yeni_mapping.items():
                        if eski_key in eski_questions and yeni_key not in eski_questions:
                            eski_questions[yeni_key] = eski_questions.get(eski_key, 0)
                            # Eski key'i silebiliriz ama veri kaybÄ±nÄ± Ã¶nlemek iÃ§in bÄ±rakÄ±yoruz
                
                # TAB sistemi ile ayrÄ±m
                tab_motivation, tab_study = st.tabs(["ğŸ† Motivasyon", "ğŸ“Š Soru Takibi"])
                
                with tab_motivation:
                    # Motivasyon puanlama
                    col_score, col_note = st.columns([1, 2])
                    
                    with col_score:
                        st.markdown("**ğŸ† BugÃ¼nkÃ¼ motivasyonumu puanla:**")
                        motivation_score = st.slider(
                            "Motivasyon seviyeniz (1-10)", 
                            min_value=1, 
                            max_value=10, 
                            value=today_motivation['score'],
                            key=f"motivation_{today_str}",
                            help="1: Ã‡ok dÃ¼ÅŸÃ¼k, 10: Ã‡ok yÃ¼ksek"
                        )
                        
                        # Motivasyona gÃ¶re emoji ve mesaj
                        if motivation_score >= 8:
                            motivation_emoji = "ğŸš€"
                            motivation_msg = "MÃ¼kemmel enerji!"
                            color = "#28a745"
                        elif motivation_score >= 6:
                            motivation_emoji = "ğŸ˜Š"
                            motivation_msg = "Pozitif ruh hali!"
                            color = "#ffc107"
                        elif motivation_score >= 4:
                            motivation_emoji = "ğŸ˜"
                            motivation_msg = "Orta seviye"
                            color = "#fd7e14"
                        else:
                            motivation_emoji = "ğŸ˜”"
                            motivation_msg = "Biraz destek lazÄ±m"
                            color = "#dc3545"
                        
                        st.markdown(f"<div style='text-align: center; background: {color}; color: white; padding: 10px; border-radius: 8px; margin: 10px 0;'><span style='font-size: 20px;'>{motivation_emoji}</span><br><strong>{motivation_msg}</strong></div>", unsafe_allow_html=True)
                    
                    with col_note:
                        st.markdown("**ğŸ“ BugÃ¼ne not dÃ¼ÅŸ:**")
                        daily_note = st.text_area(
                            "NasÄ±l hissediyorsun? BugÃ¼nÃ¼ nasÄ±l geÃ§irdin?", 
                            value=today_motivation['note'],
                            max_chars=300,
                            height=120,
                            key=f"note_{today_str}",
                            help="BugÃ¼nkÃ¼ dÃ¼ÅŸÃ¼ncelerinizi, hislerinizi veya yaÅŸadÄ±klarÄ±nÄ±zÄ± kÄ±saca yazÄ±n",
                            placeholder="Ã–rnek: BugÃ¼n matematik dersinde Ã§ok iyi gitti, kendimi motive hissediyorum. YarÄ±n fizik Ã§alÄ±ÅŸacaÄŸÄ±m."
                        )
                    
                    # ğŸ“¸ GÃœNLÃœK FOTOÄRAF Ã–ZELLÄ°ÄÄ°
                    st.markdown("---")
                    st.markdown("**ğŸ“¸ GÃ¼nlÃ¼k FotoÄŸrafÄ±n:**")
                    
                    col_photo_upload, col_photo_display = st.columns([1, 1])
                    
                    with col_photo_upload:
                        st.markdown("ğŸ“· **BugÃ¼nkÃ¼ anÄ±nÄ± paylaÅŸ**")
                        uploaded_file = st.file_uploader(
                            "FotoÄŸraf seÃ§", 
                            type=['png', 'jpg', 'jpeg'],
                            key=f"photo_upload_{today_str}",
                            help="Ã‡alÄ±ÅŸma masanÄ±z, notlarÄ±nÄ±z veya bugÃ¼nkÃ¼ halinizi fotoÄŸraflayÄ±n"
                        )
                        
                        # FotoÄŸraf aÃ§Ä±klamasÄ±
                        photo_caption = st.text_input(
                            "FotoÄŸraf aÃ§Ä±klamasÄ± (isteÄŸe baÄŸlÄ±)",
                            value=today_motivation.get('photo_caption', ''),
                            key=f"photo_caption_{today_str}",
                            placeholder="Bu fotoÄŸraf hakkÄ±nda bir ÅŸeyler yaz..."
                        )
                    
                    with col_photo_display:
                        st.markdown("ğŸ–¼ï¸ **BugÃ¼nkÃ¼ fotoÄŸrafÄ±n**")
                        # BugÃ¼nkÃ¼ fotoÄŸrafÄ± gÃ¶ster
                        today_photo = today_motivation.get('photo_data', None)
                        
                        if uploaded_file is not None:
                            # Yeni yÃ¼klenen fotoÄŸrafÄ± gÃ¶ster
                            st.image(uploaded_file, caption=f"ğŸ“¸ BugÃ¼n yÃ¼klenen: {uploaded_file.name}", use_container_width=True)
                            # Session state'e geÃ§ici olarak kaydet
                            import base64
                            photo_bytes = uploaded_file.read()
                            photo_b64 = base64.b64encode(photo_bytes).decode()
                            st.session_state[f'temp_photo_{today_str}'] = {
                                'data': photo_b64,
                                'filename': uploaded_file.name,
                                'type': uploaded_file.type
                            }
                        elif today_photo:
                            # Daha Ã¶nce kaydedilmiÅŸ fotoÄŸrafÄ± gÃ¶ster
                            try:
                                import base64
                                photo_bytes = base64.b64decode(today_photo['data'])
                                st.image(photo_bytes, caption=f"ğŸ“¸ BugÃ¼nkÃ¼ fotoÄŸraf: {today_photo.get('filename', 'FotoÄŸraf')}", use_container_width=True)
                            except:
                                st.info("ğŸ“· FotoÄŸraf yÃ¼klenemedi")
                        else:
                            st.info("ğŸ“· HenÃ¼z bugÃ¼n iÃ§in fotoÄŸraf yÃ¼klenmedi")
                            st.markdown("*BugÃ¼nÃ¼ fotoÄŸrafla ve anÄ± kaydet!*")
                    
                    # Son 3 gÃ¼nÃ¼n fotoÄŸraf galerisi
                    st.markdown("---")
                    st.markdown("**ğŸ–¼ï¸ Son FotoÄŸraflarÄ±m:**")
                    
                    # Son 3 gÃ¼nÃ¼ dÃ¶ngÃ¼yle gÃ¶ster
                    photo_cols = st.columns(3)
                    for i, col in enumerate(photo_cols):
                        day_ago = week_info["today"] - timedelta(days=i+1)
                        day_str = day_ago.strftime("%Y-%m-%d")
                        day_name = day_ago.strftime("%d/%m")
                        
                        with col:
                            day_data = daily_motivation.get(day_str, {})
                            day_photo = day_data.get('photo_data', None)
                            
                            if day_photo:
                                try:
                                    import base64
                                    photo_bytes = base64.b64decode(day_photo['data'])
                                    st.image(photo_bytes, caption=f"ğŸ“… {day_name}", use_container_width=True)
                                    
                                    # FotoÄŸraf aÃ§Ä±klamasÄ± varsa gÃ¶ster
                                    caption = day_data.get('photo_caption', '')
                                    if caption:
                                        st.caption(f"ğŸ’¬ {caption}")
                                except:
                                    st.info(f"ğŸ“· {day_name}\nFotoÄŸraf yok")
                            else:
                                st.info(f"ğŸ“· {day_name}\nFotoÄŸraf yok")
                
                with tab_study:
                    st.markdown("**ğŸ“Š BugÃ¼n Ã§Ã¶zdÃ¼ÄŸÃ¼n sorularÄ± kaydet:**")
                    
                    # Ã–ÄŸrencinin alanÄ±nÄ± al
                    user_field = user_data.get('field', 'Belirlenmedi')
                    
                    # Alan bilgisi gÃ¶ster
                    if user_field != 'Belirlenmedi':
                        st.info(f"ğŸ¯ **AlanÄ±nÄ±z:** {user_field} - Bu alanÄ±nÄ±za uygun dersler gÃ¶steriliyor")
                    else:
                        st.warning("âš ï¸ Profilinizde alan seÃ§imi yapÄ±n, size uygun dersleri gÃ¶sterebilmek iÃ§in")
                    
                    # Paragraf sorularÄ± (tÃ¼m alanlarda ortak)
                    st.markdown("**ğŸ“° TYT TÃ¼rkÃ§e - Paragraf SorularÄ±:**")
                    paragraf_questions = st.number_input(
                        "BugÃ¼n kaÃ§ paragraf sorusu Ã§Ã¶zdÃ¼n?",
                        min_value=0,
                        max_value=200,
                        value=today_motivation.get('paragraf_questions', 0),
                        key=f"paragraf_{today_str}",
                        help="TYT TÃ¼rkÃ§e paragraf sorularÄ±nÄ±n sayÄ±sÄ±"
                    )
                    
                    st.markdown("---")
                    st.markdown("**ğŸ”¢ YKS Ders BazÄ±nda Soru SayÄ±larÄ±:**")
                    
                    # YKS dersleri - alan bazÄ±nda
                    questions_data = {}
                    
                    # TYT Dersleri (TÃ¼m alanlarda ortak)
                    tyt_dersleri = [
                        ('tyt_turkce', 'ğŸ“š TYT TÃ¼rkÃ§e'),
                        ('tyt_matematik', 'ğŸ”¢ TYT Matematik'),
                        ('tyt_geometri', 'ğŸ“ TYT Geometri'),
                        ('tyt_fizik', 'âš¡ TYT Fizik'),
                        ('tyt_kimya', 'ğŸ§ª TYT Kimya'),
                        ('tyt_biyoloji', 'ğŸ§¬ TYT Biyoloji'),
                        ('tyt_tarih', 'ğŸ›ï¸ TYT Tarih'),
                        ('tyt_cografya', 'ğŸŒ TYT CoÄŸrafya'),
                        ('tyt_felsefe', 'ğŸ’­ TYT Felsefe'),
                        ('tyt_din', 'ğŸ•Œ TYT Din KÃ¼ltÃ¼rÃ¼')
                    ]
                    
                    # AYT Dersleri - Alan bazÄ±nda
                    if user_field == "SayÄ±sal":
                        ayt_dersleri = [
                            ('ayt_matematik', 'ğŸ§® AYT Matematik'),
                            ('ayt_fizik', 'âš›ï¸ AYT Fizik'),
                            ('ayt_kimya', 'ğŸ”¬ AYT Kimya'),
                            ('ayt_biyoloji', 'ğŸ”­ AYT Biyoloji')
                        ]
                    elif user_field == "EÅŸit AÄŸÄ±rlÄ±k":
                        ayt_dersleri = [
                            ('ayt_matematik', 'ğŸ§® AYT Matematik'),
                            ('ayt_edebiyat', 'ğŸ“œ AYT Edebiyat'),
                            ('ayt_tarih', 'ğŸ“– AYT Tarih'),
                            ('ayt_cografya', 'ğŸ—ºï¸ AYT CoÄŸrafya')
                        ]
                    elif user_field == "SÃ¶zel":
                        ayt_dersleri = [
                            ('ayt_edebiyat', 'ğŸ“œ AYT Edebiyat'),
                            ('ayt_tarih', 'ğŸ“– AYT Tarih'),
                            ('ayt_cografya', 'ğŸ—ºï¸ AYT CoÄŸrafya'),
                            ('ayt_felsefe', 'ğŸ¤” AYT Felsefe'),
                            ('ayt_din', 'ğŸ•Œ AYT Din KÃ¼ltÃ¼rÃ¼ ve Ahlak Bilgisi')
                        ]
                    else:
                        ayt_dersleri = []  # Alan seÃ§ilmemiÅŸse AYT dersleri gÃ¶sterilmez
                    
                    # Layout - 2 sÃ¼tunlu dÃ¼zen
                    col1, col2 = st.columns(2)
                    
                    with col1:
                        st.markdown("**ğŸ“š TYT DERSLERÄ° (TÃ¼m Ã–ÄŸrenciler):**")
                        for ders_key, ders_adi in tyt_dersleri:
                            questions_data[ders_key] = st.number_input(
                                ders_adi, 
                                min_value=0, max_value=200, 
                                value=today_motivation.get('questions', {}).get(ders_key, 0),
                                key=f"{ders_key}_{today_str}"
                            )
                    
                    with col2:
                        if ayt_dersleri:
                            st.markdown(f"**ğŸ¯ AYT DERSLERÄ° ({user_field} AlanÄ±):**")
                            for ders_key, ders_adi in ayt_dersleri:
                                questions_data[ders_key] = st.number_input(
                                    ders_adi, 
                                    min_value=0, max_value=200, 
                                    value=today_motivation.get('questions', {}).get(ders_key, 0),
                                    key=f"{ders_key}_{today_str}"
                                )
                        else:
                            if user_field == 'Belirlenmedi':
                                st.markdown("**âš ï¸ AYT DERSLERÄ°:**")
                                st.warning("ğŸ”„ AYT derslerini gÃ¶rmek iÃ§in profilinizden alanÄ±nÄ±zÄ± seÃ§in (SayÄ±sal/EÅŸit AÄŸÄ±rlÄ±k/SÃ¶zel)")
                                st.info("ğŸ¯ **AYT Dersleri nedir?** 12. sÄ±nÄ±fÄ±n ikinci yarÄ±sÄ±nda girilecek olan, alanÄ±nÄ±za Ã¶zel derslerdir.")
                            else:
                                st.markdown(f"**ğŸ¯ AYT DERSLERÄ° ({user_field} AlanÄ±):**")
                                st.info(f"ğŸ† {user_field} alanÄ± iÃ§in AYT dersleri yÃ¼klendi!")
                        
                        st.markdown("**ğŸ“ DENEMELER:**")
                        genel_deneme = st.number_input(
                            "ğŸ¯ Genel Deneme (Tam YKS)", 
                            min_value=0, max_value=20, 
                            value=today_motivation.get('tests', {}).get('genel_deneme', 0),
                            key=f"genel_deneme_{today_str}",
                            help="TYT + AYT tam denemesi"
                        )
                        brans_deneme = st.number_input(
                            "ğŸ­ BranÅŸ Denemesi", 
                            min_value=0, max_value=50, 
                            value=today_motivation.get('tests', {}).get('brans_deneme', 0),
                            key=f"brans_deneme_{today_str}",
                            help="Tek ders/konu denemesi"
                        )
                        
                        # GÃ¼nlÃ¼k Ã¶zet
                        st.markdown("**ğŸ“ˆ GÃ¼nlÃ¼k Ã–zet:**")
                        total_questions = sum(questions_data.values()) + paragraf_questions
                        total_tests = genel_deneme + brans_deneme
                        
                        # Alan bazÄ±nda Ã¶zel metrikler
                        tyt_total = sum(v for k, v in questions_data.items() if k.startswith('tyt_'))
                        ayt_total = sum(v for k, v in questions_data.items() if k.startswith('ayt_'))
                        
                        st.info(f"""
                        **ğŸ“Š {user_field} AlanÄ± PerformansÄ±:**
                        - ğŸ“š TYT SorularÄ±: **{tyt_total}**
                        - ğŸ¯ AYT SorularÄ±: **{ayt_total}**
                        - ğŸ“° Paragraf: **{paragraf_questions}**
                        - ğŸ”¢ **TOPLAM SORU: {total_questions}**
                        - ğŸ“ **DENEMELER: {total_tests}**
                        """)
                
                # Tek kaydet butonu - tÃ¼m verileri toplar
                if st.button("ğŸ’¾ BugÃ¼nkÃ¼ TÃ¼m Verilerimi Kaydet", key=f"save_all_data_{today_str}", type="primary"):
                    # FotoÄŸraf verilerini al
                    photo_data = None
                    if f'temp_photo_{today_str}' in st.session_state:
                        photo_data = st.session_state[f'temp_photo_{today_str}']
                    elif today_motivation.get('photo_data'):
                        photo_data = today_motivation.get('photo_data')
                    
                    daily_motivation[today_str] = {
                        'score': motivation_score,
                        'note': daily_note,
                        'questions': questions_data,
                        'tests': {
                            'genel_deneme': genel_deneme,
                            'brans_deneme': brans_deneme
                        },
                        'paragraf_questions': paragraf_questions,
                        'photo_data': photo_data,
                        'photo_caption': photo_caption,
                        'timestamp': datetime.now().isoformat()
                    }
                    
                    # GeÃ§ici session state'i temizle
                    if f'temp_photo_{today_str}' in st.session_state:
                        del st.session_state[f'temp_photo_{today_str}']
                    
                    update_user_in_firebase(st.session_state.current_user, {'daily_motivation': json.dumps(daily_motivation)})
                    # ğŸš€ OPTÄ°MÄ°ZE: update_user_in_firebase() zaten session state'i gÃ¼nceller
                    
                    # BaÅŸarÄ± mesajÄ±na fotoÄŸraf bilgisini de ekle
                    photo_info = "ğŸ“¸ FotoÄŸraf da kaydedildi!" if photo_data else ""
                    st.success(f"âœ… {today_str} tarihli tÃ¼m verileriniz kaydedildi! Motivasyon: {motivation_score}/10, Toplam Soru: {total_questions}, Denemeler: {total_tests} {photo_info}")
                
                # Son 7 gÃ¼nÃ¼n performans trendi ve geÃ§miÅŸ verileri
                if len(daily_motivation) > 0:
                    st.markdown("---")
                    st.markdown("**ğŸ“ˆ Son 7 GÃ¼n Performans Analizi:**")
                    
                    # Tab sistemi ile ayrÄ±m
                    tab_trend, tab_history = st.tabs(["ğŸ“ˆ Trend Grafikleri", "ğŸ“… GeÃ§miÅŸ Verileri"])
                    
                    with tab_trend:
                        recent_days = []
                        recent_scores = []
                        recent_questions = []
                        recent_tests = []
                        
                        for i in range(6, -1, -1):
                            day = week_info["today"] - timedelta(days=i)
                            day_str = day.strftime("%Y-%m-%d")
                            day_data = daily_motivation.get(day_str, {'score': 0, 'questions': {}, 'tests': {}, 'paragraf_questions': 0})
                            
                            recent_days.append(day.strftime("%m/%d"))
                            recent_scores.append(day_data.get('score', 0) if day_data.get('score', 0) > 0 else None)
                            
                            # Toplam soru sayÄ±sÄ± hesapla
                            questions = day_data.get('questions', {})
                            total_q = sum(questions.values()) + day_data.get('paragraf_questions', 0)
                            recent_questions.append(total_q if total_q > 0 else None)
                            
                            # Toplam deneme sayÄ±sÄ± hesapla
                            tests = day_data.get('tests', {})
                            total_t = tests.get('genel_deneme', 0) + tests.get('brans_deneme', 0)
                            recent_tests.append(total_t if total_t > 0 else None)
                        
                        # ÃœÃ§ ayrÄ± grafik
                        col_graph1, col_graph2, col_graph3 = st.columns(3)
                        
                        with col_graph1:
                            st.markdown("**ğŸ† Motivasyon Trendi:**")
                            trend_fig1 = go.Figure()
                            trend_fig1.add_trace(go.Scatter(
                                x=recent_days,
                                y=recent_scores,
                                mode='lines+markers',
                                line=dict(color='#667eea', width=3),
                                marker=dict(size=8, color='#764ba2'),
                                name='Motivasyon'
                            ))
                            
                            trend_fig1.update_layout(
                                height=200,
                                margin=dict(l=10, r=10, t=10, b=30),
                                xaxis_title="Tarih",
                                yaxis_title="Puan",
                                yaxis=dict(range=[0, 10]),
                                showlegend=False,
                                paper_bgcolor='rgba(0,0,0,0)',
                                plot_bgcolor='rgba(0,0,0,0)'
                            )
                            
                            safe_plotly_chart(trend_fig1, use_container_width=True)
                        
                        with col_graph2:
                            st.markdown("**ğŸ”¢ Soru Ã‡Ã¶zme Trendi:**")
                            trend_fig2 = go.Figure()
                            trend_fig2.add_trace(go.Scatter(
                                x=recent_days,
                                y=recent_questions,
                                mode='lines+markers',
                                line=dict(color='#fd7e14', width=3),
                                marker=dict(size=8, color='#e55353'),
                                name='Soru SayÄ±sÄ±',
                                fill='tonexty',
                                fillcolor='rgba(253, 126, 20, 0.2)'
                            ))
                            
                            trend_fig2.update_layout(
                                height=200,
                                margin=dict(l=10, r=10, t=10, b=30),
                                xaxis_title="Tarih",
                                yaxis_title="Soru",
                                showlegend=False,
                                paper_bgcolor='rgba(0,0,0,0)',
                                plot_bgcolor='rgba(0,0,0,0)'
                            )
                            
                            safe_plotly_chart(trend_fig2, use_container_width=True)
                        
                        with col_graph3:
                            st.markdown("**ğŸ¯ Deneme Trendi:**")
                            trend_fig3 = go.Figure()
                            trend_fig3.add_trace(go.Scatter(
                                x=recent_days,
                                y=recent_tests,
                                mode='lines+markers',
                                line=dict(color='#28a745', width=3),
                                marker=dict(size=8, color='#20c997'),
                                name='Deneme SayÄ±sÄ±',
                                fill='tonexty',
                                fillcolor='rgba(40, 167, 69, 0.2)'
                            ))
                            
                            trend_fig3.update_layout(
                                height=200,
                                margin=dict(l=10, r=10, t=10, b=30),
                                xaxis_title="Tarih",
                                yaxis_title="Deneme",
                                showlegend=False,
                                paper_bgcolor='rgba(0,0,0,0)',
                                plot_bgcolor='rgba(0,0,0,0)'
                            )
                            
                            safe_plotly_chart(trend_fig3, use_container_width=True)
                    
                    with tab_history:
                        st.markdown("**ğŸ“… GeÃ§miÅŸ GÃ¼nlerdeki PerformansÄ±nÄ±zÄ± Ä°nceleyin:**")
                        
                        # Son 30 gÃ¼nÃ¼n verilerini gÃ¶ster
                        history_days = []
                        for i in range(29, -1, -1):
                            day = week_info["today"] - timedelta(days=i)
                            day_str = day.strftime("%Y-%m-%d")
                            if day_str in daily_motivation:
                                history_days.append((day, day_str, daily_motivation[day_str]))
                        
                        if history_days:
                            for day, day_str, data in history_days[-10:]:  # Son 10 gÃ¼nÃ¼ gÃ¶ster
                                with st.expander(f"ğŸ“… {day.strftime('%d/%m/%Y')} ({day.strftime('%A')}) - Motivasyon: {data.get('score', 0)}/10", expanded=False):
                                    col_info1, col_info2 = st.columns(2)
                                    
                                    with col_info1:
                                        st.markdown("**ğŸ† Motivasyon & Notlar:**")
                                        score = data.get('score', 0)
                                        note = data.get('note', 'Not girilmedi')
                                        
                                        if score >= 8:
                                            score_color = "#28a745"
                                            score_emoji = "ğŸš€"
                                        elif score >= 6:
                                            score_color = "#ffc107" 
                                            score_emoji = "ğŸ˜Š"
                                        elif score >= 4:
                                            score_color = "#fd7e14"
                                            score_emoji = "ğŸ˜"
                                        else:
                                            score_color = "#dc3545"
                                            score_emoji = "ğŸ˜”"
                                        
                                        st.markdown(f"<div style='background: {score_color}; color: white; padding: 8px; border-radius: 6px; text-align: center;'>{score_emoji} <strong>{score}/10</strong></div>", unsafe_allow_html=True)
                                        st.markdown(f"**Not:** {note}")
                                    
                                    with col_info2:
                                        st.markdown("**ğŸ“ˆ Ã‡alÄ±ÅŸma PerformansÄ±:**")
                                        questions = data.get('questions', {})
                                        tests = data.get('tests', {})
                                        paragraf = data.get('paragraf_questions', 0)
                                        
                                        total_questions = sum(questions.values()) + paragraf
                                        total_tests = tests.get('genel_deneme', 0) + tests.get('brans_deneme', 0)
                                        
                                        st.metric("Toplam Soru", total_questions)
                                        st.metric("Paragraf Soru", paragraf)
                                        st.metric("Denemeler", total_tests)
                                        
                                        # Ders bazÄ±nda detal - YKS format uyumlu
                                        if any(questions.values()):
                                            st.markdown("**Ders BazÄ±nda:**")
                                            
                                            # YKS ders isimleri mapping
                                            ders_isim_mapping = {
                                                'tyt_turkce': 'TYT TÃ¼rkÃ§e',
                                                'tyt_matematik': 'TYT Matematik', 
                                                'tyt_geometri': 'TYT Geometri',
                                                'tyt_fizik': 'TYT Fizik',
                                                'tyt_kimya': 'TYT Kimya',
                                                'tyt_biyoloji': 'TYT Biyoloji',
                                                'tyt_tarih': 'TYT Tarih',
                                                'tyt_cografya': 'TYT CoÄŸrafya',
                                                'tyt_felsefe': 'TYT Felsefe',
                                                'tyt_din': 'TYT Din KÃ¼ltÃ¼rÃ¼',
                                                'ayt_matematik': 'AYT Matematik',
                                                'ayt_fizik': 'AYT Fizik',
                                                'ayt_kimya': 'AYT Kimya',
                                                'ayt_biyoloji': 'AYT Biyoloji',
                                                'ayt_edebiyat': 'AYT Edebiyat',
                                                'ayt_tarih': 'AYT Tarih',
                                                'ayt_cografya': 'AYT CoÄŸrafya',
                                                'ayt_felsefe': 'AYT Felsefe',
                                                'ayt_din': 'AYT Din KÃ¼ltÃ¼rÃ¼ ve Ahlak Bilgisi',
                                                # Eski format uyumluluk
                                                'matematik': 'Matematik (Eski)',
                                                'fizik': 'Fizik (Eski)',
                                                'kimya': 'Kimya (Eski)',
                                                'biyoloji': 'Biyoloji (Eski)',
                                                'turkce': 'TÃ¼rkÃ§e (Eski)',
                                                'tarih': 'Tarih (Eski)',
                                                'cografya': 'CoÄŸrafya (Eski)',
                                                'edebiyat': 'Edebiyat (Eski)',
                                                'felsefe': 'Felsefe (Eski)',
                                                'din': 'Din KÃ¼ltÃ¼rÃ¼ (Eski)',
                                                'geometri': 'Geometri (Eski)'
                                            }
                                            
                                            # TYT dersleri Ã¶nce gÃ¶ster
                                            tyt_dersleri = [(k, v) for k, v in questions.items() if k.startswith('tyt_') and v > 0]
                                            if tyt_dersleri:
                                                st.markdown("*ğŸ“š TYT Dersleri:*")
                                                for ders, sayi in tyt_dersleri:
                                                    ders_adi = ders_isim_mapping.get(ders, ders.replace('_', ' ').title())
                                                    st.write(f"â€¢ {ders_adi}: {sayi}")
                                            
                                            # AYT dersleri sonra gÃ¶ster
                                            ayt_dersleri = [(k, v) for k, v in questions.items() if k.startswith('ayt_') and v > 0]
                                            if ayt_dersleri:
                                                st.markdown("*ğŸ¯ AYT Dersleri:*")
                                                for ders, sayi in ayt_dersleri:
                                                    ders_adi = ders_isim_mapping.get(ders, ders.replace('_', ' ').title())
                                                    st.write(f"â€¢ {ders_adi}: {sayi}")
                                            
                                            # Eski format dersleri (geÃ§iÅŸ dÃ¶nemi uyumluluÄŸu)
                                            eski_dersleri = [(k, v) for k, v in questions.items() if not k.startswith(('tyt_', 'ayt_')) and v > 0]
                                            if eski_dersleri:
                                                st.markdown("*ğŸ“– DiÄŸer:*")
                                                for ders, sayi in eski_dersleri:
                                                    ders_adi = ders_isim_mapping.get(ders, ders.title())
                                                    st.write(f"â€¢ {ders_adi}: {sayi}")
                        else:
                            st.info("ğŸ“… HenÃ¼z kaydedilmiÅŸ veri yok. Ã‡alÄ±ÅŸmaya baÅŸlayÄ±n ve verilerinizi kaydedin!")
                
                st.markdown("---")
                
                # Ä°lerleme Ã¶zeti kartlarÄ± yukarda taÅŸÄ±ndÄ± - bu bÃ¶lÃ¼mÃ¼ kaldÄ±r
                
                st.subheader("ğŸŒ¸ Ã‡iÃ§ek BahÃ§esi - Ä°lerleme Takibi")
                
                # Ã–ÄŸrencinin alanÄ±na gÃ¶re dersler
                user_field = user_data.get('field', 'Belirlenmedi')
                important_subjects = []
                
                if user_field == "SayÄ±sal":
                    important_subjects = ["TYT TÃ¼rkÃ§e", "TYT Matematik", "TYT Geometri", "TYT Fizik", "TYT Kimya", "TYT Biyoloji", "TYT Din KÃ¼ltÃ¼rÃ¼", "TYT Felsefe", "AYT Matematik", "AYT Fizik", "AYT Kimya", "AYT Biyoloji"]
                elif user_field == "EÅŸit AÄŸÄ±rlÄ±k":
                    important_subjects = ["TYT TÃ¼rkÃ§e", "TYT Matematik", "TYT Geometri", "TYT Tarih", "TYT CoÄŸrafya", "TYT Din KÃ¼ltÃ¼rÃ¼", "TYT Felsefe", "AYT Matematik", "AYT Edebiyat", "AYT Tarih", "AYT CoÄŸrafya"]
                elif user_field == "SÃ¶zel":
                    important_subjects = ["TYT TÃ¼rkÃ§e", "TYT Tarih", "TYT CoÄŸrafya", "TYT Felsefe", "AYT Edebiyat", "AYT Tarih", "AYT CoÄŸrafya"]
                else:
                    important_subjects = ["TYT TÃ¼rkÃ§e", "TYT Matematik", "TYT Geometri", "TYT Fizik", "TYT Kimya", "TYT Biyoloji"]
                    st.info("âš ï¸ Profilinizden alanÄ±nÄ±zÄ± seÃ§erek Ã‡iÃ§ek BahÃ§enizi Ã¶zelleÅŸtirebilirsiniz!")
                
                # Mevcut progress_data'da bulunan dersleri filtrele
                display_subjects = [s for s in important_subjects if s in progress_data and progress_data[s]['total'] > 0]
                
                # EÄŸer hiÃ§ ders bulunamazsa bilgilendirme gÃ¶ster
                if not display_subjects:
                    st.warning("ğŸŒ± HenÃ¼z Ã§iÃ§ek bahÃ§eniz boÅŸ! Konu Takip sayfasÄ±ndan Ã§alÄ±ÅŸma verilerinizi girin ve Ã§iÃ§eklerinizi yetiÅŸtirmeye baÅŸlayÄ±n!")
                    st.info(f"ğŸ¯ **{user_field} alanÄ±** iÃ§in yetiÅŸtireceÄŸiniz Ã§iÃ§ekler: {', '.join(important_subjects)}")
                    
                    st.markdown("""
                    **ğŸŒº Ã‡iÃ§ek BahÃ§esi NasÄ±l Ã‡alÄ±ÅŸÄ±r?**
                    1. ğŸ“š Sol menÃ¼den **"Konu Takip"** sayfasÄ±na gidin
                    2. ğŸ¯ Bir ders seÃ§in ve konu net skorlarÄ±nÄ±zÄ± girin
                    3. ğŸŒ¸ Ã‡alÄ±ÅŸtÄ±kÃ§a Ã§iÃ§ekleriniz bÃ¼yÃ¼yÃ¼p renklenecek
                    4. ğŸ¥€ Uzun sÃ¼re tekrar etmezseniz Ã§iÃ§ekler solmaya baÅŸlar
                    """)
                else:
                    # Alan bazÄ±nda ilerleme Ã¶zeti
                    st.markdown(f"**ğŸ¯ {user_field} AlanÄ± - BahÃ§e Durumu:**")
                    
                    total_all_subjects = sum(progress_data[s]['total'] for s in display_subjects)
                    completed_all_subjects = sum(progress_data[s]['completed'] for s in display_subjects)
                    avg_percent = (completed_all_subjects / total_all_subjects * 100) if total_all_subjects > 0 else 0
                    
                    col_summary1, col_summary2, col_summary3, col_summary4 = st.columns(4)
                    with col_summary1:
                        st.metric("ğŸŒ± Toplam Ã‡iÃ§ek", len(display_subjects))
                    with col_summary2:
                        blooming = sum(1 for s in display_subjects if progress_data[s]['percent'] >= 70)
                        st.metric("ğŸŒ¸ Ã‡iÃ§ek AÃ§an", blooming)
                    with col_summary3:
                        st.metric("ğŸŒ¿ BahÃ§e SaÄŸlÄ±ÄŸÄ±", f"%{avg_percent:.0f}")
                    with col_summary4:
                        wilted = sum(1 for s in display_subjects if progress_data[s]['percent'] < 30)
                        st.metric("ğŸ¥€ SolmuÅŸ", wilted)
                    
                    st.markdown("---")
                    
                    # Ã‡iÃ§ek emoji ve renk mapping
                    def get_flower_state(percent, days_since_study=0):
                        """Ã‡iÃ§ek durumunu belirle"""
                        # Ä°lerleme bazlÄ± base state
                        if percent >= 85:
                            base_emoji = "ğŸŒ¸"
                            base_color = "#2ecc71"
                            base_status = "CanlÄ±"
                            base_bg = "linear-gradient(135deg, #2ecc71, #27ae60)"
                        elif percent >= 70:
                            base_emoji = "ğŸŒº"
                            base_color = "#3498db"
                            base_status = "Ä°yi"
                            base_bg = "linear-gradient(135deg, #3498db, #2980b9)"
                        elif percent >= 50:
                            base_emoji = "ğŸµï¸"
                            base_color = "#f39c12"
                            base_status = "Orta"
                            base_bg = "linear-gradient(135deg, #f39c12, #e67e22)"
                        elif percent >= 30:
                            base_emoji = "ğŸ¥€"
                            base_color = "#e67e22"
                            base_status = "Solmaya BaÅŸladÄ±"
                            base_bg = "linear-gradient(135deg, #e67e22, #d35400)"
                        else:
                            base_emoji = "ğŸ‚"
                            base_color = "#e74c3c"
                            base_status = "SolmuÅŸ"
                            base_bg = "linear-gradient(135deg, #e74c3c, #c0392b)"
                        
                        # Tekrar zamanÄ± geldi mi? (Spaced repetition etkisi)
                        if days_since_study >= 7:
                            # 1 haftadan fazla Ã§alÄ±ÅŸÄ±lmamÄ±ÅŸ - solmaya baÅŸlasÄ±n
                            warning = f"â° {days_since_study} gÃ¼n Ã¶nce Ã§alÄ±ÅŸÄ±ldÄ±"
                            if percent >= 70:
                                base_emoji = "ğŸ¥€"
                                base_status = "Tekrar Gerek"
                                base_bg = "linear-gradient(135deg, #e67e22, #d35400)"
                        elif days_since_study >= 3:
                            warning = f"âš ï¸ {days_since_study} gÃ¼n Ã¶nce Ã§alÄ±ÅŸÄ±ldÄ±"
                        else:
                            warning = ""
                        
                        return {
                            'emoji': base_emoji,
                            'color': base_color,
                            'status': base_status,
                            'bg': base_bg,
                            'warning': warning
                        }
                    
                    subject_icons = {
                        "TYT TÃ¼rkÃ§e": "ğŸ“š", "TYT Matematik": "ğŸ”¢", "TYT Geometri": "ğŸ“",
                        "TYT Tarih": "ğŸ›ï¸", "TYT CoÄŸrafya": "ğŸŒ", "TYT Felsefe": "ğŸ’­", "TYT Din KÃ¼ltÃ¼rÃ¼": "ğŸ•Œ",
                        "TYT Fizik": "âš¡", "TYT Kimya": "ğŸ§ª", "TYT Biyoloji": "ğŸ§¬",
                        "AYT Matematik": "ğŸ§®", "AYT Fizik": "âš›ï¸", "AYT Kimya": "ğŸ”¬", "AYT Biyoloji": "ğŸ”­",
                        "AYT Edebiyat": "ğŸ“œ", "AYT Tarih": "ğŸ“–", "AYT CoÄŸrafya": "ğŸ—ºï¸"
                    }
                    
                    # Son Ã§alÄ±ÅŸma tarihlerini al
                    topic_progress_str = user_data.get('topic_progress', '{}')
                    try:
                        topic_progress = json.loads(topic_progress_str) if isinstance(topic_progress_str, str) else topic_progress_str
                    except:
                        topic_progress = {}
                    
                    # Her ders iÃ§in son Ã§alÄ±ÅŸma tarihini bul
                    subject_last_study = {}
                    for topic_key, topic_value in topic_progress.items():
                        for subject in display_subjects:
                            subject_clean = subject.replace("TYT ", "").replace("AYT ", "")
                            if subject_clean.lower() in topic_key.lower():
                                if isinstance(topic_value, dict) and 'last_updated' in topic_value:
                                    last_date = topic_value['last_updated']
                                    if subject not in subject_last_study or last_date > subject_last_study[subject]:
                                        subject_last_study[subject] = last_date
                    
                    # ğŸŒ¸ Ã‡Ä°Ã‡EK KARTLARI
                    cols = st.columns(3)
                    for i, subject in enumerate(display_subjects):
                        if subject in progress_data:
                            percent = progress_data[subject]["percent"]
                            completed = progress_data[subject]['completed']
                            total = progress_data[subject]['total']
                            
                            # Son Ã§alÄ±ÅŸma tarihinden bu yana geÃ§en gÃ¼n
                            days_since = 0
                            if subject in subject_last_study:
                                try:
                                    last_date = datetime.fromisoformat(subject_last_study[subject])
                                    days_since = (datetime.now() - last_date).days
                                except:
                                    pass
                            
                            flower_state = get_flower_state(percent, days_since)
                            
                            with cols[i % 3]:
                                # HTML parÃ§alarÄ±nÄ± oluÅŸtur
                                html_parts = []
                                
                                # Ana kart baÅŸlangÄ±cÄ±
                                html_parts.append('<div style="background: ' + flower_state['bg'] + '; padding: 20px; border-radius: 15px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2); margin-bottom: 20px; border: 3px solid ' + flower_state['color'] + '; transition: transform 0.3s;">')
                                
                                # Ã‡iÃ§ek emoji
                                html_parts.append('<div style="font-size: 60px; margin: 10px 0;">')
                                html_parts.append(flower_state['emoji'])
                                html_parts.append('</div>')
                                
                                # Ders adÄ±
                                html_parts.append('<div style="font-size: 18px; color: white; font-weight: bold; margin: 10px 0;">')
                                html_parts.append(subject_icons.get(subject, 'ğŸ“–') + ' ' + subject)
                                html_parts.append('</div>')
                                
                                # YÃ¼zde
                                html_parts.append('<div style="font-size: 32px; color: white; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">')
                                html_parts.append('%' + str(int(percent)))
                                html_parts.append('</div>')
                                
                                # Durum
                                html_parts.append('<div style="font-size: 14px; color: rgba(255,255,255,0.9); margin: 8px 0;">')
                                html_parts.append(flower_state['status'])
                                html_parts.append('</div>')
                                
                                # Ä°statistik kutusu
                                html_parts.append('<div style="background: rgba(255,255,255,0.2); padding: 8px; border-radius: 8px; margin-top: 10px;">')
                                html_parts.append('<div style="font-size: 13px; color: white;">')
                                html_parts.append('ğŸ“Š ' + str(completed) + '/' + str(total) + ' konu tamamlandÄ±')
                                html_parts.append('</div>')
                                
                                # Warning varsa ekle
                                if flower_state.get('warning'):
                                    html_parts.append('<div style="font-size: 12px; color: #fff; margin-top: 5px;">')
                                    html_parts.append(flower_state['warning'])
                                    html_parts.append('</div>')
                                
                                # Ä°statistik kutusunu kapat
                                html_parts.append('</div>')
                                
                                # Ana kartÄ± kapat
                                html_parts.append('</div>')
                                
                                # HTML'i birleÅŸtir ve render et
                                final_html = ''.join(html_parts)
                                st.markdown(final_html, unsafe_allow_html=True)
                    
                    # BahÃ§e bakÄ±m Ã¶nerileri
                    st.markdown("---")
                    st.subheader("ğŸŒ¿ BahÃ§e BakÄ±m Ã–nerileri")
                    
                    # SolmuÅŸ Ã§iÃ§ekler
                    wilted_subjects = [s for s in display_subjects if progress_data[s]['percent'] < 50]
                    if wilted_subjects:
                        st.warning(f"ğŸ¥€ **Acil ilgi gereken Ã§iÃ§ekler:** {', '.join(wilted_subjects)}")
                    
                    # Tekrar zamanÄ± gelen konular
                    needs_review = []
                    for subject in display_subjects:
                        if subject in subject_last_study:
                            try:
                                last_date = datetime.fromisoformat(subject_last_study[subject])
                                days = (datetime.now() - last_date).days
                                if days >= 7:
                                    needs_review.append(subject)
                            except:
                                pass
                    
                    if needs_review:
                        st.info(f"â° **Tekrar zamanÄ± gelen dersler:** {', '.join(needs_review)}")
                    
                    # Ä°yi durumdaki Ã§iÃ§ekler
                    healthy_subjects = [s for s in display_subjects if progress_data[s]['percent'] >= 70]
                    if healthy_subjects:
                        st.success(f"ğŸŒ¸ **Harika giden dersler:** {', '.join(healthy_subjects)}")
                
                st.markdown("---")
                st.subheader("ğŸ“‹ Son Aktivite Ã–zeti")
                
                # KullanÄ±cÄ±nÄ±n gerÃ§ek verilerinden son aktiviteleri al
                topic_progress_str = user_data.get('topic_progress', '{}')
                try:
                    topic_progress = json.loads(topic_progress_str) if isinstance(topic_progress_str, str) else topic_progress_str
                except:
                    topic_progress = {}
                
                # Son gÃ¼ncellenen konularÄ± bul (net 10+ olan konular)
                recent_activities = []
                for topic_key, net_score in topic_progress.items():
                    try:
                        net_score = int(float(str(net_score)))
                        if net_score >= 10:  # AnlamlÄ± Ã§alÄ±ÅŸma yapÄ±lmÄ±ÅŸ konular
                            # topic_key format: "TYT Matematik | Ana Konu | Alt Konu | Detay"
                            parts = topic_key.split(' | ')
                            if len(parts) >= 4:
                                ders = parts[0]
                                konu = parts[3]
                                durum = "TamamlandÄ±" if net_score >= 15 else "Devam Ediyor"
                                recent_activities.append({
                                    "ders": ders, 
                                    "konu": konu[:20] + "..." if len(konu) > 20 else konu,
                                    "net": net_score,
                                    "durum": durum
                                })
                    except (ValueError, TypeError):
                        continue
                
                # En yÃ¼ksek netli konularÄ± Ã¶nce gÃ¶ster
                recent_activities.sort(key=lambda x: x['net'], reverse=True)
                recent_activities = recent_activities[:5]  # Sadece ilk 5
                
                if recent_activities:
                    for activity in recent_activities:
                        with st.container():
                            col1, col2, col3, col4 = st.columns([3, 2, 1, 1])
                            with col1:
                                st.write(f"**{activity['ders']}** - {activity['konu']}")
                            with col2:
                                st.write(f"Net: {activity['net']}")
                            with col3:
                                if activity['durum'] == "TamamlandÄ±": 
                                    st.success("âœ…")
                                else: 
                                    st.info("â³")
                            with col4:
                                # Net skor seviyesi
                                if activity['net'] >= 18:
                                    st.write("ğŸ“")
                                elif activity['net'] >= 15:
                                    st.write("ğŸš€")
                                else:
                                    st.write("ğŸ’ª")
                else:
                    st.info("ğŸ“ˆ HenÃ¼z konu Ã§alÄ±ÅŸmanÄ±z bulunmuyor. Konu Takip sayfasÄ±ndan baÅŸlayÄ±n!")

            elif page == "ğŸ“š Konu Takip":
                st.markdown(f'<div class="main-header"><h1>ğŸ“š Konu Takip Sistemi</h1><p>Her konuda ustalaÅŸÄ±n</p></div>', unsafe_allow_html=True)
                
                # Soru istatistikleri aÃ§Ä±klamasÄ±
                st.info("""
                **ğŸ“Š YKS Son 6 YÄ±l Soru Ä°statistikleri (2019-2024)**  
                Her konunun yanÄ±ndaki sayÄ±, o konudan son 6 yÄ±lda **kaÃ§ soru Ã§Ä±ktÄ±ÄŸÄ±nÄ±** gÃ¶sterir.  
                ğŸ”¥ **15+ soru**: Ã‡ok sÄ±k Ã§Ä±kan konular (Ã–ncelikli)  
                âš¡ **8-14 soru**: Orta sÄ±klÄ±kta Ã§Ä±kan konular  
                ğŸ“š **1-7 soru**: Az sÄ±klÄ±kta Ã§Ä±kan konular  
                """)
                
                user_field = user_data.get('field', 'Belirlenmedi')
                
                if user_field == "SayÄ±sal":
                    available_subjects = ["TYT TÃ¼rkÃ§e", "TYT Matematik", "TYT Geometri", "TYT Fizik", "TYT Kimya", "TYT Biyoloji", "TYT Din KÃ¼ltÃ¼rÃ¼", "TYT Felsefe", "TYT Tarih (isteÄŸe baÄŸlÄ±)", "TYT CoÄŸrafya (isteÄŸe baÄŸlÄ±)", "AYT Matematik", "AYT Fizik", "AYT Kimya", "AYT Biyoloji"]
                elif user_field == "EÅŸit AÄŸÄ±rlÄ±k":
                    available_subjects = ["TYT TÃ¼rkÃ§e", "TYT Matematik", "TYT Geometri", "TYT Tarih", "TYT CoÄŸrafya", "TYT Din KÃ¼ltÃ¼rÃ¼", "TYT Felsefe", "TYT Fizik (isteÄŸe baÄŸlÄ±)", "TYT Kimya (isteÄŸe baÄŸlÄ±)", "TYT Biyoloji (isteÄŸe baÄŸlÄ±)", "AYT Matematik", "AYT Edebiyat", "AYT Tarih", "AYT CoÄŸrafya"]
                elif user_field == "SÃ¶zel":
                    available_subjects = ["TYT TÃ¼rkÃ§e", "TYT Tarih", "TYT CoÄŸrafya", "TYT Felsefe", "TYT Din KÃ¼ltÃ¼rÃ¼", "AYT Edebiyat", "AYT Tarih", "AYT CoÄŸrafya", "AYT Felsefe", "AYT Din KÃ¼ltÃ¼rÃ¼ ve Ahlak Bilgisi"]

                else:
                    available_subjects = list(YKS_TOPICS.keys())
                
                # DOM hata Ã¶nleyici - stabil key kullan
                selected_subject = st.selectbox("ğŸ“– Ders SeÃ§in", available_subjects, key="stable_subject_selector")

                if selected_subject and selected_subject in YKS_TOPICS:
                    st.subheader(f"{selected_subject} KonularÄ±")
                    
                    topic_progress = json.loads(user_data.get('topic_progress', '{}') or '{}')
                    subject_content = YKS_TOPICS[selected_subject]
                    
                    # DOM hata Ã¶nleyici - update tracker
                    if 'topic_updates' not in st.session_state:
                        st.session_state.topic_updates = []
                    
                    # Toplu gÃ¼ncelleme iÃ§in container
                    update_container = st.empty()
                    
                    # Ä°Ã§erik tipini kontrol et
                    if isinstance(subject_content, dict):
                        # SÃ¶zlÃ¼k formatÄ±ndaysa
                        for main_topic, sub_topics in subject_content.items():
                            with st.expander(f"ğŸ“‚ {main_topic}", expanded=False):
                                if isinstance(sub_topics, dict):
                                    # Alt konular da sÃ¶zlÃ¼k
                                    for sub_topic, details in sub_topics.items():
                                        st.write(f"**ğŸ“‹ {sub_topic}**")
                                        for detail in details:
                                            topic_key = f"{selected_subject} | {main_topic} | {sub_topic} | {detail}"
                                            col1, col2, col3, col4, col5 = st.columns([3, 2, 1, 1, 1])
                                            with col1:
                                                # Soru sayÄ±sÄ± bilgisini ekle
                                                try:
                                                    question_count = get_topic_question_count(detail)
                                                    question_count = int(question_count) if question_count is not None else 0
                                                except (TypeError, ValueError):
                                                    question_count = 0
                                                
                                                if question_count > 0:
                                                    st.write(f"â€¢ {detail} <span style='color: #ff6b6b; font-size: 0.8em;'>({question_count} soru)</span>", unsafe_allow_html=True)
                                                else:
                                                    st.write(f"â€¢ {detail}")
                                            with col2:
                                                current_net = topic_progress.get(topic_key, '0')
                                                try:
                                                    current_net_int = int(float(current_net))
                                                except (ValueError, TypeError):
                                                    current_net_int = 0
                                                # DOM hata Ã¶nleyici - stabil key oluÅŸtur
                                                stable_key = f"slider_{hash(topic_key)}_{selected_subject}_{main_topic}_{sub_topic}_{detail}"
                                                new_net = st.slider(f"Net ({detail})", 0, 20, current_net_int, key=stable_key, label_visibility="collapsed")
                                            with col3:
                                                st.write(calculate_level(new_net))
                                            with col4:
                                                # Konu Zorluk Puanlama (1-5 arasÄ±)
                                                difficulty_key = f"difficulty_{hash(topic_key)}_{selected_subject}_{main_topic}_{sub_topic}_{detail}"
                                                current_difficulty = topic_progress.get(f"{topic_key}_difficulty", 3)  # VarsayÄ±lan: orta
                                                try:
                                                    current_difficulty_int = int(current_difficulty)
                                                except (ValueError, TypeError):
                                                    current_difficulty_int = 3
                                                
                                                difficulty_rating = st.selectbox(
                                                    "Zorluk",
                                                    options=[1, 2, 3, 4, 5],
                                                    index=current_difficulty_int - 1,
                                                    format_func=lambda x: f"{TOPIC_DIFFICULTY_SYSTEM[x]['icon']} {x}",
                                                    key=difficulty_key,
                                                    label_visibility="collapsed",
                                                    help=f"Zorluk: {TOPIC_DIFFICULTY_SYSTEM[current_difficulty_int]['name']} - {TOPIC_DIFFICULTY_SYSTEM[current_difficulty_int]['study_time']}"
                                                )
                                                
                                                # Zorluk gÃ¼ncellemesi
                                                if difficulty_rating != current_difficulty_int:
                                                    topic_progress[f"{topic_key}_difficulty"] = difficulty_rating
                                                    update_user_in_firebase(st.session_state.current_user, {'topic_progress': json.dumps(topic_progress)})
                                                    
                                            with col5:
                                                # Soru sÄ±klÄ±ÄŸÄ± ikonu
                                                try:
                                                    if question_count > 0:
                                                        if question_count >= 15:
                                                            st.write("ğŸ”¥", help=f"Ã‡ok sÄ±k Ã§Ä±kan konu: {question_count} soru")
                                                        elif question_count >= 8:
                                                            st.write("âš¡", help=f"Orta sÄ±klÄ±kta Ã§Ä±kan konu: {question_count} soru")
                                                        else:
                                                            st.write("ğŸ“š", help=f"Az sÄ±klÄ±kta Ã§Ä±kan konu: {question_count} soru")
                                                except Exception as e:
                                                    # Hata durumunda sadece boÅŸ icon
                                                    st.write("ğŸ“š")
                                            
                                            # GÃ¼ncelleme
                                            if str(new_net) != current_net:
                                                topic_progress[topic_key] = str(new_net)
                                                update_user_in_firebase(st.session_state.current_user, {'topic_progress': json.dumps(topic_progress)})
                                                # ğŸš€ OPTÄ°MÄ°ZE: update_user_in_firebase() zaten session state'i gÃ¼nceller
                                                # HaftalÄ±k plan cache'ini temizle
                                                if 'weekly_plan_cache' in st.session_state:
                                                    del st.session_state.weekly_plan_cache
                                                # 14+ net ise tamamlama tarihini kaydet
                                                check_and_update_completion_dates()
                                                st.session_state.topic_updates.append((detail, new_net))
                                                # ğŸ”¥ KRÄ°TÄ°K: HaftalÄ±k hedef konular listesini anÄ±nda gÃ¼ncelle
                                                st.rerun()
                                elif isinstance(sub_topics, list):
                                    # Alt konular liste
                                    for detail in sub_topics:
                                        topic_key = f"{selected_subject} | {main_topic} | None | {detail}"
                                        col1, col2, col3, col4, col5 = st.columns([3, 2, 1, 1, 1])
                                        with col1:
                                            # Soru sayÄ±sÄ± bilgisini ekle
                                            try:
                                                question_count = get_topic_question_count(detail)
                                                question_count = int(question_count) if question_count is not None else 0
                                            except (TypeError, ValueError):
                                                question_count = 0
                                            
                                            if question_count > 0:
                                                st.write(f"â€¢ {detail} <span style='color: #ff6b6b; font-size: 0.8em;'>({question_count} soru)</span>", unsafe_allow_html=True)
                                            else:
                                                st.write(f"â€¢ {detail}")
                                        with col2:
                                            current_net = topic_progress.get(topic_key, '0')
                                            try:
                                                current_net_int = int(float(current_net))
                                            except (ValueError, TypeError):
                                                current_net_int = 0
                                            # DOM hata Ã¶nleyici - stabil key oluÅŸtur
                                            stable_key = f"slider_{hash(topic_key)}_{selected_subject}_{main_topic}_{detail}"
                                            new_net = st.slider(f"Net ({detail})", 0, 20, current_net_int, key=stable_key, label_visibility="collapsed")
                                        with col3:
                                            st.write(calculate_level(new_net))
                                        with col4:
                                            # Konu Zorluk Puanlama (1-5 arasÄ±)
                                            difficulty_key = f"difficulty_{hash(topic_key)}_{selected_subject}_{main_topic}_{detail}"
                                            current_difficulty = topic_progress.get(f"{topic_key}_difficulty", 3)  # VarsayÄ±lan: orta
                                            try:
                                                current_difficulty_int = int(current_difficulty)
                                            except (ValueError, TypeError):
                                                current_difficulty_int = 3
                                            
                                            difficulty_rating = st.selectbox(
                                                "Zorluk",
                                                options=[1, 2, 3, 4, 5],
                                                index=current_difficulty_int - 1,
                                                format_func=lambda x: f"{TOPIC_DIFFICULTY_SYSTEM[x]['icon']} {x}",
                                                key=difficulty_key,
                                                label_visibility="collapsed",
                                                help=f"Zorluk: {TOPIC_DIFFICULTY_SYSTEM[current_difficulty_int]['name']} - {TOPIC_DIFFICULTY_SYSTEM[current_difficulty_int]['study_time']}"
                                            )
                                            
                                            # Zorluk gÃ¼ncellemesi
                                            if difficulty_rating != current_difficulty_int:
                                                topic_progress[f"{topic_key}_difficulty"] = difficulty_rating
                                                update_user_in_firebase(st.session_state.current_user, {'topic_progress': json.dumps(topic_progress)})
                                                
                                        with col5:
                                            # Soru sÄ±klÄ±ÄŸÄ± ikonu
                                            try:
                                                if question_count > 0:
                                                    if question_count >= 15:
                                                        st.write("ğŸ”¥", help=f"Ã‡ok sÄ±k Ã§Ä±kan konu: {question_count} soru")
                                                    elif question_count >= 8:
                                                        st.write("âš¡", help=f"Orta sÄ±klÄ±kta Ã§Ä±kan konu: {question_count} soru")
                                                    else:
                                                        st.write("ğŸ“š", help=f"Az sÄ±klÄ±kta Ã§Ä±kan konu: {question_count} soru")
                                            except Exception as e:
                                                # Hata durumunda sadece boÅŸ icon
                                                st.write("ğŸ“š")
                                        
                                        # GÃ¼ncelleme
                                        if str(new_net) != current_net:
                                            topic_progress[topic_key] = str(new_net)
                                            update_user_in_firebase(st.session_state.current_user, {'topic_progress': json.dumps(topic_progress)})
                                            # ğŸš€ OPTÄ°MÄ°ZE: update_user_in_firebase() zaten session state'i gÃ¼nceller
                                            # HaftalÄ±k plan cache'ini temizle
                                            if 'weekly_plan_cache' in st.session_state:
                                                del st.session_state.weekly_plan_cache
                                            # 14+ net ise tamamlama tarihini kaydet
                                            check_and_update_completion_dates()
                                            st.session_state.topic_updates.append((detail, new_net))
                                            # ğŸ”¥ KRÄ°TÄ°K: HaftalÄ±k hedef konular listesini anÄ±nda gÃ¼ncelle
                                            st.rerun()
                    elif isinstance(subject_content, list):
                        # Ana iÃ§erik liste formatÄ±ndaysa
                        with st.expander(f"ğŸ“‚ {selected_subject} KonularÄ±", expanded=True):
                            for detail in subject_content:
                                topic_key = f"{selected_subject} | None | None | {detail}"
                                col1, col2, col3, col4, col5 = st.columns([3, 2, 1, 1, 1])
                                with col1:
                                    # Soru sayÄ±sÄ± bilgisini ekle
                                    try:
                                        question_count = get_topic_question_count(detail)
                                        question_count = int(question_count) if question_count is not None else 0
                                    except (TypeError, ValueError):
                                        question_count = 0
                                    
                                    if question_count > 0:
                                        st.write(f"â€¢ {detail} <span style='color: #ff6b6b; font-size: 0.8em;'>({question_count} soru)</span>", unsafe_allow_html=True)
                                    else:
                                        st.write(f"â€¢ {detail}")
                                with col2:
                                    current_net = topic_progress.get(topic_key, '0')
                                    try:
                                        current_net_int = int(float(current_net))
                                    except (ValueError, TypeError):
                                        current_net_int = 0
                                    # DOM hata Ã¶nleyici - stabil key oluÅŸtur
                                    stable_key = f"slider_{hash(topic_key)}_{selected_subject}_{detail}"
                                    new_net = st.slider(f"Net ({detail})", 0, 20, current_net_int, key=stable_key, label_visibility="collapsed")
                                with col3:
                                    st.write(calculate_level(new_net))
                                with col4:
                                    # Konu Zorluk Puanlama (1-5 arasÄ±)
                                    difficulty_key = f"difficulty_{hash(topic_key)}_{selected_subject}_{detail}"
                                    current_difficulty = topic_progress.get(f"{topic_key}_difficulty", 3)  # VarsayÄ±lan: orta
                                    try:
                                        current_difficulty_int = int(current_difficulty)
                                    except (ValueError, TypeError):
                                        current_difficulty_int = 3
                                    
                                    difficulty_rating = st.selectbox(
                                        "Zorluk",
                                        options=[1, 2, 3, 4, 5],
                                        index=current_difficulty_int - 1,
                                        format_func=lambda x: f"{TOPIC_DIFFICULTY_SYSTEM[x]['icon']} {x}",
                                        key=difficulty_key,
                                        label_visibility="collapsed",
                                        help=f"Zorluk: {TOPIC_DIFFICULTY_SYSTEM[current_difficulty_int]['name']} - {TOPIC_DIFFICULTY_SYSTEM[current_difficulty_int]['study_time']}"
                                    )
                                    
                                    # Zorluk gÃ¼ncellemesi
                                    if difficulty_rating != current_difficulty_int:
                                        topic_progress[f"{topic_key}_difficulty"] = difficulty_rating
                                        update_user_in_firebase(st.session_state.current_user, {'topic_progress': json.dumps(topic_progress)})
                                        
                                with col5:
                                    # Soru sÄ±klÄ±ÄŸÄ± ikonu
                                    try:
                                        if question_count > 0:
                                            if question_count >= 15:
                                                st.write("ğŸ”¥", help=f"Ã‡ok sÄ±k Ã§Ä±kan konu: {question_count} soru")
                                            elif question_count >= 8:
                                                st.write("âš¡", help=f"Orta sÄ±klÄ±kta Ã§Ä±kan konu: {question_count} soru")
                                            else:
                                                st.write("ğŸ“š", help=f"Az sÄ±klÄ±kta Ã§Ä±kan konu: {question_count} soru")
                                    except Exception as e:
                                        # Hata durumunda sadece boÅŸ icon
                                        st.write("ğŸ“š")
                                
                                # GÃ¼ncelleme
                                if str(new_net) != current_net:
                                    topic_progress[topic_key] = str(new_net)
                                    update_user_in_firebase(st.session_state.current_user, {'topic_progress': json.dumps(topic_progress)})
                                    # ğŸš€ OPTÄ°MÄ°ZE: update_user_in_firebase() zaten session state'i gÃ¼nceller
                                    # HaftalÄ±k plan cache'ini temizle
                                    if 'weekly_plan_cache' in st.session_state:
                                        del st.session_state.weekly_plan_cache
                                    # 14+ net ise tamamlama tarihini kaydet
                                    check_and_update_completion_dates()
                                    st.session_state.topic_updates.append((detail, new_net))
                                    # ğŸ”¥ KRÄ°TÄ°K: HaftalÄ±k hedef konular listesini anÄ±nda gÃ¼ncelle
                                    st.rerun()
                    
                    # Toplu gÃ¼ncelleme bildirimi - DOM gÃ¼venli
                    if len(st.session_state.topic_updates) > 0:
                        with update_container.container():
                            st.success(f"âœ… {len(st.session_state.topic_updates)} konu gÃ¼ncellendi!")
                            
                            # GÃ¼ncellenen konularÄ± gÃ¶ster
                            for detail, net in st.session_state.topic_updates[-5:]:  # Son 5 gÃ¼ncelleme
                                st.caption(f"â€¢ {detail}: {net} net")
                    
                    # Toplu kaydetme seÃ§eneÄŸi
                    if st.button("ğŸ’¾ TÃ¼m DeÄŸiÅŸiklikleri Kaydet", type="primary", key="save_all_button"):
                        try:
                            update_user_in_firebase(st.session_state.current_user, {'topic_progress': json.dumps(topic_progress)})
                            # ğŸš€ OPTÄ°MÄ°ZE: update_user_in_firebase() zaten session state'i gÃ¼nceller
                            # Cache temizleme
                            if 'weekly_plan_cache' in st.session_state:
                                del st.session_state.weekly_plan_cache
                            check_and_update_completion_dates()
                            st.success("âœ… TÃ¼m net deÄŸerleri baÅŸarÄ±yla kaydedildi!")
                            # GÃ¼ncelleme listesini temizle
                            st.session_state.topic_updates = []
                        except Exception as e:
                            st.error(f"Kaydetme hatasÄ±: {str(e)}")

            elif page == "ğŸ§  Ã‡alÄ±ÅŸma Teknikleri":
                st.markdown(f'<div class="main-header"><h1>ğŸ§  Ã‡alÄ±ÅŸma Teknikleri</h1><p>YKS Ã¶ÄŸrencisine Ã¶zel, psikolojik ve bilimsel Ã§alÄ±ÅŸma yÃ¶ntemleri</p></div>', unsafe_allow_html=True)
                
                st.markdown("""
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 15px; margin-bottom: 30px; text-align: center;">
                    <h2>ğŸ’ª Harika! AÅŸaÄŸÄ±da senin iÃ§in Ã¶zel hazÄ±rlanmÄ±ÅŸ teknikler var</h2>
                    <p>Her teknik iÃ§in psikolojik etki, uygun dersler ve Ã¶ÄŸrenci tipi belirtildi</p>
                </div>
                """, unsafe_allow_html=True)
                
                # Renk paleti - her teknik iÃ§in farklÄ± renk
                colors = [
                    "#8B5CF6",  # Mor
                    "#3B82F6",  # Mavi  
                    "#10B981",  # YeÅŸil
                    "#F59E0B",  # Turuncu
                    "#EF4444",  # KÄ±rmÄ±zÄ±
                    "#8B5A2B",  # Kahverengi
                    "#6366F1",  # Ä°ndigo
                    "#EC4899",  # Pembe
                    "#14B8A6",  # Teal
                    "#F97316",  # Amber
                    "#84CC16",  # Lime
                    "#A855F7",  # Violet
                    "#06B6D4",  # Cyan
                    "#D946EF",  # Fuchsia
                    "#22C55E"   # Green
                ]
                
                # Teknikleri 3'er 3'er grupla
                technique_list = list(STUDY_TECHNIQUES.items())
                
                # Her satÄ±rda 3 kolon
                for group_start in range(0, len(technique_list), 3):
                    group_techniques = technique_list[group_start:group_start + 3]
                    cols = st.columns(3)
                    
                    for i, (technique_name, info) in enumerate(group_techniques):
                        color = colors[(group_start + i) % len(colors)]
                        
                        with cols[i]:
                            # Ana kart
                            st.markdown(f"""
                            <div style="background: linear-gradient(135deg, {color}, {color}CC); border-radius: 20px; padding: 25px; margin-bottom: 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.15); color: white; text-align: center; transform: translateY(0); transition: all 0.3s ease;">
                                <h3 style="margin-bottom: 15px; font-size: 1.3rem; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">{info['icon']} {technique_name}</h3>
                                <p style="font-size: 1rem; margin-bottom: 15px; opacity: 0.95;"><strong>ğŸ¯ TanÄ±m:</strong> {info['description']}</p>
                                <p style="font-size: 0.9rem; margin-bottom: 0; opacity: 0.9;"><strong>ğŸ§  Uygun Stiller:</strong> {', '.join(info['learning_styles'])}</p>
                            </div>
                            """, unsafe_allow_html=True)
                            
                            # DetaylarÄ± gÃ¶ster butonu
                            if st.button(f"ğŸ“‹ DetaylarÄ± GÃ¶r", key=f"detail_{technique_name}", use_container_width=True):
                                st.session_state[f'show_detail_{technique_name}'] = not st.session_state.get(f'show_detail_{technique_name}', False)
                            
                            # Detaylar aÃ§Ä±ldÄ±ysa gÃ¶ster
                            if st.session_state.get(f'show_detail_{technique_name}', False):
                                
                                st.markdown("**ğŸ“˜ AdÄ±mlar:**")
                                for step in info['steps']:
                                    st.write(f"â€¢ {step}")
                                
                                st.markdown("**ğŸ’¬ Psikolojik Etkisi:**")
                                st.info(info['psychological_effect'])
                                
                                st.markdown("**ğŸ§© En Uygun Dersler:**")
                                if isinstance(info['best_subjects'], list):
                                    st.success(', '.join(info['best_subjects']))
                                else:
                                    st.success(info['best_subjects'])
                                
                                st.markdown("**ğŸ‘¤ Uygun Ã–ÄŸrenci Tipi:**")
                                st.warning(info['suitable_student'])
                                
                                # Kapatma butonu
                                if st.button(f"âŒ Kapat", key=f"close_{technique_name}", use_container_width=True):
                                    st.session_state[f'show_detail_{technique_name}'] = False
                                    st.rerun()
                    
                    # Grup arasÄ± boÅŸluk
                    if group_start + 3 < len(technique_list):
                        st.markdown("<br>", unsafe_allow_html=True)
                
                # Alt bilgi
                st.markdown("""
                <div style="background: linear-gradient(135deg, #e6fffa 0%, #b2f5ea 100%); border-radius: 15px; padding: 25px; margin-top: 40px; border-left: 5px solid #38b2ac; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <h4 style="color: #2d3748; margin-bottom: 15px; font-size: 1.2rem;">ğŸ’¡ KullanÄ±m Ã–nerisi</h4>
                    <p style="color: #4a5568; margin: 0; font-size: 1rem; line-height: 1.6;">Kendi Ã¶ÄŸrenme stilinize ve hedef bÃ¶lÃ¼mÃ¼nÃ¼ze uygun teknikleri seÃ§in. Bir anda Ã§ok fazla teknik denemek yerine, 2-3 tanesini dÃ¼zenli olarak uygulayÄ±n.</p>
                </div>
                """, unsafe_allow_html=True)
                
                # ğŸƒ Ã‡EVÄ°RMELÄ° KAÄIT OYUNU - YENÄ°!
                st.markdown("---")
                st.markdown("""
                <div style="background: linear-gradient(135deg, #ff6b6b 0%, #feca57 50%, #48dbfb 100%); color: white; padding: 30px; border-radius: 20px; margin: 40px 0; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
                    <h1 style="margin: 0; font-size: 2.5rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">ğŸƒ Ã‡EVÄ°RMELÄ° KAÄIT OYUNU</h1>
                    <p style="margin: 10px 0 0 0; font-size: 1.3rem; opacity: 0.95;">Kendi kartlarÄ±nÄ± oluÅŸtur ve Ã§alÄ±ÅŸ! EÄŸlenceli ezber sistemi</p>
                </div>
                """, unsafe_allow_html=True)
                
                # KullanÄ±cÄ±nÄ±n kartlarÄ±nÄ± saklamak iÃ§in Firebase entegrasyonu
                if 'user_flashcards' not in st.session_state:
                    # Firebase'den kullanÄ±cÄ±nÄ±n kartlarÄ±nÄ± yÃ¼kle
                    username = st.session_state.get('current_user', None)
                    if username:
                        users_data = load_users_from_firebase()
                        user_data = users_data.get(username, {})
                        saved_cards = user_data.get('flashcards', '{}')
                        try:
                            if isinstance(saved_cards, str):
                                st.session_state.user_flashcards = json.loads(saved_cards)
                            else:
                                st.session_state.user_flashcards = saved_cards if isinstance(saved_cards, dict) else {}
                        except (json.JSONDecodeError, TypeError):
                            st.session_state.user_flashcards = {}
                    else:
                        st.session_state.user_flashcards = {}
                
                # Sekme sistemi - KartlarÄ±mÄ± GÃ¶ster | Yeni Kart Ekle
                tab1, tab2 = st.tabs(["ğŸ® KartlarÄ±mÄ± Ã‡alÄ±ÅŸ", "â• Yeni Kart Ekle"])
                
                with tab2:
                    # Form temizleme kontrolÃ¼
                    if 'card_form_counter' not in st.session_state:
                        st.session_state.card_form_counter = 0
                    
                    # Yeni kart ekleme formu
                    st.markdown("""
                    <div style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); 
                               border-radius: 15px; padding: 25px; margin: 20px 0;">
                        <h3 style="color: #2d3748; margin-bottom: 20px; text-align: center;">âœ¨ Yeni Kart OluÅŸtur</h3>
                    </div>
                    """, unsafe_allow_html=True)
                    
                    # Form alanlarÄ± - unique key'ler
                    form_key = st.session_state.card_form_counter
                    col_form1, col_form2 = st.columns(2)
                    
                    with col_form1:
                        # Ders seÃ§imi
                        subject_for_card = st.selectbox(
                            "ğŸ“š Hangi ders iÃ§in kart?",
                            ["TYT TÃ¼rkÃ§e", "TYT Matematik", "TYT Geometri", "TYT Fizik", "TYT Kimya", "TYT Biyoloji", 
                             "TYT Tarih", "TYT CoÄŸrafya", "TYT Felsefe", "AYT Matematik", "AYT Fizik", "AYT Kimya", 
                             "AYT Biyoloji", "AYT Edebiyat", "AYT Tarih", "AYT CoÄŸrafya"],
                            key=f"new_card_subject_{form_key}"
                        )
                        
                        # KartÄ±n Ã¶n yÃ¼zÃ¼
                        card_front = st.text_area(
                            "ğŸ“ KartÄ±n Ã–n YÃ¼zÃ¼ (Soru/Kavram)",
                            placeholder="Ã–rnek: Ahmet HaÅŸim\nveya: (a+b)Â² = ?\nveya: 1453 yÄ±lÄ±nda ne oldu?",
                            height=100,
                            key=f"card_front_{form_key}"
                        )
                    
                    with col_form2:
                        # Kart kategorisi
                        card_category = st.text_input(
                            "ğŸ·ï¸ Kategori (isteÄŸe baÄŸlÄ±)",
                            placeholder="Ã–rnek: Åairler, FormÃ¼ller, Tarihler...",
                            key=f"card_category_{form_key}"
                        )
                        
                        # KartÄ±n arka yÃ¼zÃ¼
                        card_back = st.text_area(
                            "âœ… KartÄ±n Arka YÃ¼zÃ¼ (Cevap/AÃ§Ä±klama)",
                            placeholder="Ã–rnek: GÃ¶l Saatleri, O Belde, Gurabahane-i Laklakan\nveya: aÂ² + 2ab + bÂ²\nveya: Ä°stanbul'un Fethi",
                            height=100,
                            key=f"card_back_{form_key}"
                        )
                    
                    # Kart ekleme butonu
                    if st.button("ğŸ¯ KartÄ± Kaydet", use_container_width=True, type="primary", key=f"save_card_{form_key}"):
                        if card_front.strip() and card_back.strip():
                            # KullanÄ±cÄ±nÄ±n kartlarÄ±na ekle
                            if subject_for_card not in st.session_state.user_flashcards:
                                st.session_state.user_flashcards[subject_for_card] = []
                            
                            new_card = {
                                'front': card_front.strip(),
                                'back': card_back.strip(),
                                'category': card_category.strip() if card_category.strip() else "Genel",
                                'created_date': datetime.now().strftime("%Y-%m-%d %H:%M"),
                                'study_count': 0,
                                'known': False
                            }
                            
                            st.session_state.user_flashcards[subject_for_card].append(new_card)
                            
                            # Firebase'e kaydet
                            username = st.session_state.get('current_user', None)
                            if username:
                                try:
                                    flashcards_json = json.dumps(st.session_state.user_flashcards, ensure_ascii=False)
                                    update_user_in_firebase(username, {'flashcards': flashcards_json})
                                    st.success(f"ğŸ‰ Kart '{subject_for_card}' dersine eklendi ve Firebase'e kaydedildi!")
                                except Exception as e:
                                    st.success(f"ğŸ‰ Kart '{subject_for_card}' dersine eklendi! (Yerel olarak)")
                                    st.info("ğŸ’¾ KartlarÄ±nÄ±z bu oturum boyunca saklanacak.")
                            else:
                                st.success(f"ğŸ‰ Kart '{subject_for_card}' dersine eklendi! (GeÃ§ici)")
                                st.warning("âš ï¸ GiriÅŸ yapÄ±n ki kartlarÄ±nÄ±z kalÄ±cÄ± olarak saklansÄ±n!")
                            
                            st.balloons()
                            
                            # Form counter'Ä± artÄ±r ve yenile (bu ÅŸekilde form temizlenir)
                            st.session_state.card_form_counter += 1
                            time.sleep(1)
                            st.rerun()
                        else:
                            st.error("âŒ LÃ¼tfen hem Ã¶n yÃ¼z hem de arka yÃ¼z alanlarÄ±nÄ± doldurun!")
                
                with tab1:
                    # KartlarÄ± Ã§alÄ±ÅŸma bÃ¶lÃ¼mÃ¼
                    if not st.session_state.user_flashcards:
                        st.info("ğŸ“‹ HenÃ¼z hiÃ§ kartÄ±nÄ±z yok. 'Yeni Kart Ekle' sekmesinden kartlarÄ±nÄ±zÄ± oluÅŸturun!")
                    else:
                        # Ders seÃ§imi
                        available_subjects = list(st.session_state.user_flashcards.keys())
                        selected_subject = st.selectbox(
                            "ğŸ¯ Hangi dersi Ã§alÄ±ÅŸmak istiyorsun?",
                            available_subjects,
                            key="study_subject_select"
                        )
                        
                        if selected_subject and st.session_state.user_flashcards[selected_subject]:
                            cards = st.session_state.user_flashcards[selected_subject]
                            
                            # Kart seÃ§imi ve durum
                            if 'current_card_index' not in st.session_state:
                                st.session_state.current_card_index = 0
                            if 'show_answer' not in st.session_state:
                                st.session_state.show_answer = False
                            
                            # Index'i kontrol et
                            if st.session_state.current_card_index >= len(cards):
                                st.session_state.current_card_index = 0
                            
                            current_card = cards[st.session_state.current_card_index]
                            
                            # Ä°statistikler
                            col_stat1, col_stat2, col_stat3 = st.columns(3)
                            with col_stat1:
                                st.metric("ğŸ“Š Toplam Kart", len(cards))
                            with col_stat2:
                                known_cards = sum(1 for card in cards if card.get('known', False))
                                st.metric("âœ… BildiÄŸim", known_cards)
                            with col_stat3:
                                progress_percent = (known_cards / len(cards) * 100) if len(cards) > 0 else 0
                                st.metric("ğŸ¯ Ä°lerleme", f"%{progress_percent:.1f}")
                            
                            # Ana kart gÃ¶sterimi - DÃ¼zeltilmiÅŸ animasyon
                            card_color = "#667eea" if not st.session_state.show_answer else "#764ba2"
                            card_icon = "ğŸ“" if not st.session_state.show_answer else "âœ…"
                            card_title = "SORU / KAVRAM" if not st.session_state.show_answer else "CEVAP / AÃ‡IKLAMA"
                            card_content = current_card['front'] if not st.session_state.show_answer else current_card['back']
                            
                            st.markdown(f"""
                            <div style="background: linear-gradient(145deg, {card_color} 0%, #764ba2 100%); 
                                        border-radius: 25px; padding: 40px; margin: 30px 0; 
                                        box-shadow: 0 15px 35px rgba(0,0,0,0.2);
                                        text-align: center; min-height: 250px; 
                                        transition: all 0.3s ease-in-out;">
                                <div style="color: white; font-size: 1.2rem; margin-bottom: 15px; opacity: 0.9;">
                                    ğŸ“š {selected_subject} - Kart {st.session_state.current_card_index + 1}/{len(cards)}
                                </div>
                                <div style="color: rgba(255,255,255,0.8); font-size: 0.9rem; margin-bottom: 20px;">
                                    ğŸ·ï¸ {current_card.get('category', 'Genel')}
                                </div>
                                <div style="background: rgba(255,255,255,0.15); border-radius: 15px; padding: 30px; margin: 20px 0;">
                                    <div style="font-size: 1.8rem; color: white; font-weight: bold; margin-bottom: 20px;">
                                        {card_icon} {card_title}
                                    </div>
                                    <div style="font-size: 1.6rem; color: white; line-height: 1.5; word-wrap: break-word;">
                                        {card_content}
                                    </div>
                                </div>
                            </div>
                            """, unsafe_allow_html=True)
                            
                            # Kontrol butonlarÄ±
                            col1, col2, col3, col4, col5 = st.columns(5)
                            
                            with col1:
                                if st.button("â¬…ï¸ Ã–nceki", use_container_width=True):
                                    if st.session_state.current_card_index > 0:
                                        st.session_state.current_card_index -= 1
                                    else:
                                        st.session_state.current_card_index = len(cards) - 1
                                    st.session_state.show_answer = False
                                    st.rerun()
                            
                            with col2:
                                # ğŸ”Š BASÄ°T VE ETKÄ°LÄ° SES SÄ°STEMÄ° - HER PLATFORMDA Ã‡ALIÅIR!
                                if st.button(f"ğŸ”„ {'CevabÄ± GÃ¶r' if not st.session_state.show_answer else 'Soruya DÃ¶n'}", 
                                           use_container_width=True, type="primary", key="flip_card_main",
                                           help="ğŸ”Š Basit ve etkili ses sistemi + 3D animasyon!"):
                                    
                                    # Ã–nce sesi Ã§al
                                    st.components.v1.html("""
                                    <script>
                                    // TELEFON VE BÄ°LGÄ°SAYAR Ä°Ã‡Ä°N BASÄ°T SES
                                    function playSimpleClick() {
                                        // Dokunmatik cihazlarda Ã§alÄ±ÅŸmasÄ± iÃ§in kullanÄ±cÄ± etkileÅŸimi gerekli
                                        const audio = new Audio();
                                        
                                        // Ã‡ok basit tik sesi - WAV formatÄ±nda
                                        audio.src = '';
                                        
                                        // Ses ayarlarÄ±
                                        audio.volume = 0.3;  // YumuÅŸak ses
                                        audio.currentTime = 0;
                                        
                                        // Ã‡almaya Ã§alÄ±ÅŸ
                                        const playPromise = audio.play();
                                        if (playPromise !== undefined) {
                                            playPromise.then(() => {
                                                console.log('ğŸ”Š Basit tik sesi Ã§alÄ±ndÄ±!');
                                            }).catch(error => {
                                                console.log('ğŸ”‡ Ses Ã§alÄ±namadÄ±:', error);
                                                // Fallback: Vibrasyon
                                                if (navigator.vibrate) {
                                                    navigator.vibrate(50);
                                                    console.log('ğŸ“³ Vibrasyon aktif');
                                                }
                                            });
                                        }
                                    }
                                    
                                    // Hemen Ã§al
                                    playSimpleClick();
                                    
                                    // KaÄŸÄ±t Ã§evirme animasyonu iÃ§in CSS
                                    const style = document.createElement('style');
                                    style.textContent = `
                                        @keyframes cardFlip {
                                            0% { transform: perspective(1000px) rotateY(0deg); }
                                            50% { transform: perspective(1000px) rotateY(180deg); }
                                            100% { transform: perspective(1000px) rotateY(360deg); }
                                        }
                                        .flip-animation {
                                            animation: cardFlip 0.6s ease-in-out;
                                        }
                                    `;
                                    document.head.appendChild(style);
                                    
                                    // Butona animasyon ekle
                                    const buttons = document.querySelectorAll('button');
                                    buttons.forEach(btn => {
                                        if (btn.textContent.includes('ğŸ”„')) {
                                            btn.classList.add('flip-animation');
                                            setTimeout(() => {
                                                btn.classList.remove('flip-animation');
                                            }, 600);
                                        }
                                    });
                                    </script>
                                    """, height=0)
                                    
                                    # Ana fonksiyon
                                    st.session_state.show_answer = not st.session_state.show_answer
                                    st.rerun()
                            
                            with col3:
                                if st.button("âœ… Biliyorum", use_container_width=True, type="secondary"):
                                    current_card['known'] = True
                                    current_card['study_count'] = current_card.get('study_count', 0) + 1
                                    
                                    # Firebase'e kaydet
                                    username = st.session_state.get('current_user', None)
                                    if username:
                                        try:
                                            flashcards_json = json.dumps(st.session_state.user_flashcards, ensure_ascii=False)
                                            update_user_in_firebase(username, {'flashcards': flashcards_json})
                                        except:
                                            pass  # Sessiz hata yÃ¶netimi
                                    
                                    st.success("ğŸ‰ Harika! Bu kartÄ± bildiÄŸinizi iÅŸaretledik!")
                                    time.sleep(1)
                                    st.rerun()
                            
                            with col4:
                                if st.button("âŒ Bilmiyorum", use_container_width=True):
                                    current_card['known'] = False
                                    current_card['study_count'] = current_card.get('study_count', 0) + 1
                                    
                                    # Firebase'e kaydet
                                    username = st.session_state.get('current_user', None)
                                    if username:
                                        try:
                                            flashcards_json = json.dumps(st.session_state.user_flashcards, ensure_ascii=False)
                                            update_user_in_firebase(username, {'flashcards': flashcards_json})
                                        except:
                                            pass  # Sessiz hata yÃ¶netimi
                                    
                                    st.info("ğŸ’ª Sorun yok! Bu kartÄ± tekrar Ã§alÄ±ÅŸalÄ±m!")
                                    time.sleep(1)
                                    st.rerun()
                            
                            with col5:
                                if st.button("â¡ï¸ Sonraki", use_container_width=True):
                                    if st.session_state.current_card_index < len(cards) - 1:
                                        st.session_state.current_card_index += 1
                                    else:
                                        st.session_state.current_card_index = 0
                                    st.session_state.show_answer = False
                                    st.rerun()
                            
                            # Ek Ã¶zellikler
                            st.markdown("---")
                            col_extra1, col_extra2, col_extra3 = st.columns(3)
                            
                            with col_extra1:
                                if st.button("ğŸ² Rastgele Kart", use_container_width=True):
                                    st.session_state.current_card_index = random.randint(0, len(cards) - 1)
                                    st.session_state.show_answer = False
                                    st.rerun()
                            
                            with col_extra2:
                                if st.button("ğŸ—‘ï¸ Bu KartÄ± Sil", use_container_width=True):
                                    if st.button("âš ï¸ Evet, Sil!", key="confirm_delete"):
                                        cards.pop(st.session_state.current_card_index)
                                        
                                        # Firebase'e kaydet
                                        username = st.session_state.get('current_user', None)
                                        if username:
                                            try:
                                                flashcards_json = json.dumps(st.session_state.user_flashcards, ensure_ascii=False)
                                                update_user_in_firebase(username, {'flashcards': flashcards_json})
                                            except:
                                                pass  # Sessiz hata yÃ¶netimi
                                        
                                        if not cards:  # Son kart silinmiÅŸse
                                            st.session_state.current_card_index = 0
                                        elif st.session_state.current_card_index >= len(cards):
                                            st.session_state.current_card_index = len(cards) - 1
                                        st.success("ğŸ—‘ï¸ Kart silindi ve Firebase'den kaldÄ±rÄ±ldÄ±!")
                                        st.rerun()
                            
                            with col_extra3:
                                if st.button("ğŸ“Š Sadece Bilmediklerim", use_container_width=True):
                                    unknown_cards = [i for i, card in enumerate(cards) if not card.get('known', False)]
                                    if unknown_cards:
                                        st.session_state.current_card_index = random.choice(unknown_cards)
                                        st.session_state.show_answer = False
                                        st.rerun()
                                    else:
                                        st.success("ğŸ‰ Harika! TÃ¼m kartlarÄ± biliyorsunuz!")
                            
                            # Ä°lerleme Ã§ubuÄŸu
                            st.progress(progress_percent / 100)
                            st.markdown(f"**ğŸ“ˆ Ä°lerleme Durumun:** {known_cards}/{len(cards)} kart tamamlandÄ± (%{progress_percent:.1f})")
                        else:
                            st.info(f"ğŸ“‹ '{selected_subject}' dersinde henÃ¼z kart yok. Yeni kart ekleyin!")
                
                # KullanÄ±m ipuÃ§larÄ± ve veri saklama bilgisi
                st.markdown("""
                <div style="background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%); 
                           border-radius: 15px; padding: 20px; margin-top: 30px;">
                    <h4 style="color: #2d3748; margin-bottom: 15px;">ğŸ’¡ NasÄ±l Daha Etkili KullanÄ±rÄ±m?</h4>
                    <ul style="color: #4a5568; margin: 0; padding-left: 20px;">
                        <li><strong>â• Kendi KartlarÄ±nÄ± Yap:</strong> Ä°htiyacÄ±n olan konularÄ± ekle</li>
                        <li><strong>ğŸ”„ DÃ¼zenli Tekrar:</strong> Bilmediklerini daha sÄ±k Ã§alÄ±ÅŸ</li>
                        <li><strong>ğŸ² KarÄ±ÅŸÄ±k Ã‡alÄ±ÅŸ:</strong> Rastgele Ã¶zelliÄŸini kullan</li>
                        <li><strong>ğŸ“Š Ä°lerlemeni Takip Et:</strong> Hangi kartlarÄ± bildiÄŸini iÅŸaretle</li>
                        <li><strong>ğŸ·ï¸ Kategorize Et:</strong> KonularÄ± kategorilere ayÄ±r</li>
                    </ul>
                </div>
                """, unsafe_allow_html=True)
                
                # Veri saklama durumu
                username = st.session_state.get('current_user', None)
                if username:
                    total_cards = sum(len(cards) for cards in st.session_state.user_flashcards.values())
                    st.markdown(f"""
                    <div style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); 
                               border-radius: 15px; padding: 20px; margin-top: 20px; text-align: center;">
                        <h4 style="color: #2d3748; margin-bottom: 15px;">ğŸ’¾ Veri Saklama Durumu</h4>
                        <div style="color: #2d3748; font-size: 1.1rem;">
                            <div style="margin: 10px 0;"><strong>ğŸ‘¤ KullanÄ±cÄ±:</strong> {username}</div>
                            <div style="margin: 10px 0;"><strong>ğŸ“Š Toplam KartlarÄ±n:</strong> {total_cards} adet</div>
                            <div style="margin: 10px 0;"><strong>ğŸ’¾ Saklama:</strong> <span style="color: #27ae60; font-weight: bold;">KALICI âœ…</span></div>
                            <div style="margin: 10px 0;"><strong>ğŸ”„ Senkronizasyon:</strong> <span style="color: #27ae60;">Firebase Database</span></div>
                            <div style="margin: 10px 0; font-size: 0.9rem; opacity: 0.8;">
                                <strong>â° SÃ¼re:</strong> KartlarÄ±n hesabÄ±nÄ±zda kalÄ±cÄ± olarak saklanÄ±yor.<br>
                                FarklÄ± cihazlardan giriÅŸ yaptÄ±ÄŸÄ±nÄ±zda tÃ¼m kartlarÄ±nÄ±zÄ± gÃ¶rebilirsiniz!
                            </div>
                        </div>
                    </div>
                    """, unsafe_allow_html=True)
                else:
                    st.markdown("""
                    <div style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); 
                               border-radius: 15px; padding: 20px; margin-top: 20px; text-align: center;">
                        <h4 style="color: #2d3748; margin-bottom: 15px;">âš ï¸ Veri Saklama UyarÄ±sÄ±</h4>
                        <div style="color: #2d3748; font-size: 1.1rem;">
                            <div style="margin: 10px 0;"><strong>ğŸ‘¤ Durum:</strong> <span style="color: #e74c3c;">GiriÅŸ YapÄ±lmamÄ±ÅŸ</span></div>
                            <div style="margin: 10px 0;"><strong>ğŸ’¾ Saklama:</strong> <span style="color: #e74c3c; font-weight: bold;">GEÃ‡Ä°CÄ° âŒ</span></div>
                            <div style="margin: 10px 0;"><strong>â° SÃ¼re:</strong> <span style="color: #e74c3c;">TarayÄ±cÄ± kapanana kadar</span></div>
                            <div style="margin: 15px 0; font-size: 0.9rem; padding: 10px; background: rgba(231, 76, 60, 0.1); border-radius: 8px;">
                                <strong>ğŸ”‘ Ã‡Ã¶zÃ¼m:</strong> Ana sayfa â†’ GiriÅŸ Yap â†’ KartlarÄ±nÄ±z kalÄ±cÄ± olarak saklanacak!
                            </div>
                        </div>
                    </div>
                    """, unsafe_allow_html=True)
                
                # ğŸµ MÃœZÄ°K OLUÅTURMA SÄ°STEMÄ° - YENÄ°!
                st.markdown("---")
                st.markdown("""
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); color: white; padding: 30px; border-radius: 20px; margin: 40px 0; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
                    <h1 style="margin: 0; font-size: 2.5rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">ğŸµ MÃœZÄ°K OLUÅTURMA SÄ°STEMÄ°</h1>
                    <p style="margin: 10px 0 0 0; font-size: 1.3rem; opacity: 0.95;">KonularÄ± mÃ¼ziÄŸe Ã§evir, hafÄ±zanda kalÄ±cÄ± hale getir!</p>
                </div>
                """, unsafe_allow_html=True)
                
                # KullanÄ±cÄ±nÄ±n mÃ¼ziklerini saklamak iÃ§in Firebase entegrasyonu
                if 'user_music_creations' not in st.session_state:
                    username = st.session_state.get('current_user', None)
                    if username:
                        users_data = load_users_from_firebase()
                        user_data = users_data.get(username, {})
                        saved_music = user_data.get('music_creations', '{}')
                        try:
                            if isinstance(saved_music, str):
                                st.session_state.user_music_creations = json.loads(saved_music)
                            else:
                                st.session_state.user_music_creations = saved_music if isinstance(saved_music, dict) else {}
                        except (json.JSONDecodeError, TypeError):
                            st.session_state.user_music_creations = {}
                    else:
                        st.session_state.user_music_creations = {}
                
                # Sekme sistemi - MÃ¼ziklerimi Dinle | Yeni MÃ¼zik Yarat
                music_tab1, music_tab2 = st.tabs(["ğŸ§ MÃ¼ziklerimi Dinle", "ğŸ¼ Yeni MÃ¼zik Yarat"])
                
                with music_tab2:
                    # Form temizleme kontrolÃ¼
                    if 'music_form_counter' not in st.session_state:
                        st.session_state.music_form_counter = 0
                    
                    # Yeni mÃ¼zik oluÅŸturma formu
                    st.markdown("""
                    <div style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); 
                               border-radius: 15px; padding: 25px; margin: 20px 0;">
                        <h3 style="color: #2d3748; margin-bottom: 20px; text-align: center;">ğŸ¹ Konunu MÃ¼ziÄŸe Ã‡evir</h3>
                    </div>
                    """, unsafe_allow_html=True)
                    
                    # Form alanlarÄ± - unique key'ler
                    music_form_key = st.session_state.music_form_counter
                    music_col1, music_col2 = st.columns(2)
                    
                    with music_col1:
                        # Alan bilgisini sistemden al
                        user_area = user_data.get('target_department', 'SayÄ±sal')
                        area_subjects = {
                            'SayÄ±sal': ["TYT Matematik", "TYT Fizik", "TYT Kimya", "TYT Biyoloji", "TYT Din KÃ¼ltÃ¼rÃ¼", "TYT Felsefe", "TYT Tarih (isteÄŸe baÄŸlÄ±)", "TYT CoÄŸrafya (isteÄŸe baÄŸlÄ±)", "AYT Matematik", "AYT Fizik", "AYT Kimya", "AYT Biyoloji"],
                            'EÅŸit AÄŸÄ±rlÄ±k': ["TYT TÃ¼rkÃ§e", "TYT Matematik", "TYT Din KÃ¼ltÃ¼rÃ¼", "TYT Felsefe", "TYT Fizik (isteÄŸe baÄŸlÄ±)", "TYT Kimya (isteÄŸe baÄŸlÄ±)", "TYT Biyoloji (isteÄŸe baÄŸlÄ±)", "AYT Matematik", "AYT Edebiyat", "AYT Tarih", "AYT CoÄŸrafya"],
                            'SÃ¶zel': ["TYT TÃ¼rkÃ§e", "AYT Edebiyat", "AYT Tarih", "AYT CoÄŸrafya", "TYT Tarih", "TYT CoÄŸrafya"],
                            'Dil': ["TYT TÃ¼rkÃ§e", "AYT Edebiyat", "YDT Dil"]
                        }
                        
                        suggested_subjects = area_subjects.get(user_area, ["TYT TÃ¼rkÃ§e", "TYT Matematik"])
                        all_subjects = ["TYT TÃ¼rkÃ§e", "TYT Matematik", "TYT Geometri", "TYT Fizik", "TYT Kimya", "TYT Biyoloji", 
                                       "TYT Tarih", "TYT CoÄŸrafya", "TYT Felsefe", "AYT Matematik", "AYT Fizik", "AYT Kimya", 
                                       "AYT Biyoloji", "AYT Edebiyat", "AYT Tarih", "AYT CoÄŸrafya"]
                        
                        # Ã–nce kendi alanÄ±nÄ± gÃ¶ster, sonra tÃ¼mÃ¼nÃ¼
                        final_subjects = suggested_subjects + [s for s in all_subjects if s not in suggested_subjects]
                        
                        # Ders seÃ§imi
                        music_subject = st.selectbox(
                            "ğŸ“š Hangi ders iÃ§in mÃ¼zik?",
                            final_subjects,
                            key=f"music_subject_{music_form_key}",
                            help=f"ğŸ¯ AlanÄ±n ({user_area}) dersleri Ã¶ncelikli gÃ¶steriliyor"
                        )
                        
                        # Konu seÃ§imi - konu takipten gÃ¼ncel olarak Ã§ek
                        available_topics = get_topic_list(music_subject)
                        if available_topics:
                            music_topic = st.selectbox(
                                "ğŸ¯ Hangi konu iÃ§in mÃ¼zik?",
                                available_topics,
                                key=f"music_topic_{music_form_key}"
                            )
                        else:
                            music_topic = st.text_input(
                                "ğŸ¯ Konu adÄ±nÄ± yazÄ±n",
                                placeholder="Ã–rnek: Ä°ntegral, HÃ¼cre BÃ¶lÃ¼nmesi, OsmanlÄ± Tarihi...",
                                key=f"music_topic_manual_{music_form_key}"
                            )
                    
                    with music_col2:
                        # MÃ¼zik tÃ¼rÃ¼ seÃ§imi
                        music_style = st.selectbox(
                            "ğŸµ MÃ¼zik TarzÄ±",
                            ["Pop", "Rap/Hip-Hop", "Rock", "Folk", "Klasik", "Blues", "Reggae", "Elektronik"],
                            key=f"music_style_{music_form_key}"
                        )
                        
                        # Zorluk seviyesi
                        difficulty_level = st.selectbox(
                            "â­ Zorluk Seviyesi",
                            ["Temel", "Orta", "Ä°leri", "Ã‡ok Ä°leri"],
                            key=f"music_difficulty_{music_form_key}"
                        )
                    
                    # MÃ¼zik yazma alanÄ±
                    st.markdown("### ğŸ¼ MÃ¼ziÄŸini Yaz")
                    music_lyrics = st.text_area(
                        "ğŸ¤ ÅarkÄ± SÃ¶zleri (Konuyu mÃ¼ziÄŸe Ã§evir)",
                        placeholder="""Ã–rnek:
                        
ğŸµ (Melodi: BildiÄŸin bir ÅŸarkÄ±nÄ±n melodisine uyarla)
Ä°ntegral almak iÃ§in, x'i arttÄ±rÄ±yoruz
TÃ¼rev alarak, eÄŸimi buluyoruz  
Ä°ntegral artÄ±ÅŸ, tÃ¼rev ise azalÄ±ÅŸ
Matematikte bunlar hep birlikteeee! ğŸµ

ğŸµ OsmanlÄ±'nÄ±n kuruluÅŸu, 1299'da baÅŸlar
Osman Bey'den itibaren, tarih sayfalarÄ±nda
YeniÃ§eri ocaÄŸÄ±yla, gÃ¼Ã§lendi devletimiz
Kanuni dÃ¶neminde zirveye Ã§Ä±ktÄ±k biz! ğŸµ""",
                        height=200,
                        key=f"music_lyrics_{music_form_key}"
                    )
                    
                    # Notlar/AnÄ±msama ipuÃ§larÄ±
                    music_notes = st.text_area(
                        "ğŸ“ AnÄ±msama NotlarÄ± (isteÄŸe baÄŸlÄ±)",
                        placeholder="Bu mÃ¼ziÄŸi hangi durumlarda kullanacaksÄ±n? Hangi formÃ¼lleri/bilgileri iÃ§eriyor?",
                        height=80,
                        key=f"music_notes_{music_form_key}"
                    )
                    
                    # MÃ¼zik kaydetme butonu
                    if st.button("ğŸµ MÃ¼ziÄŸi Kaydet", use_container_width=True, type="primary", key=f"save_music_{music_form_key}"):
                        if music_topic and music_lyrics.strip():
                            # KullanÄ±cÄ±nÄ±n mÃ¼ziklerine ekle
                            if music_subject not in st.session_state.user_music_creations:
                                st.session_state.user_music_creations[music_subject] = []
                            
                            new_music = {
                                'subject': music_subject,
                                'topic': music_topic,
                                'style': music_style,
                                'difficulty': difficulty_level,
                                'lyrics': music_lyrics.strip(),
                                'notes': music_notes.strip() if music_notes.strip() else "Notunuz yok",
                                'created_date': datetime.now().strftime("%Y-%m-%d %H:%M"),
                                'play_count': 0
                            }
                            
                            st.session_state.user_music_creations[music_subject].append(new_music)
                            
                            # Firebase'e kaydet
                            username = st.session_state.get('current_user', None)
                            if username:
                                try:
                                    music_json = json.dumps(st.session_state.user_music_creations, ensure_ascii=False)
                                    update_user_in_firebase(username, {'music_creations': music_json})
                                    st.success(f"ğŸ‰ '{music_topic}' konulu mÃ¼ziÄŸin '{music_subject}' dersine eklendi ve Firebase'e kaydedildi!")
                                except Exception as e:
                                    st.success(f"ğŸ‰ '{music_topic}' konulu mÃ¼ziÄŸin '{music_subject}' dersine eklendi! (Yerel olarak)")
                                    st.info("ğŸ’¾ MÃ¼zikleriniz bu oturum boyunca saklanacak.")
                            else:
                                st.success(f"ğŸ‰ '{music_topic}' konulu mÃ¼ziÄŸin '{music_subject}' dersine eklendi! (GeÃ§ici)")
                                st.warning("âš ï¸ GiriÅŸ yapÄ±n ki mÃ¼zikleriniz kalÄ±cÄ± olarak saklansÄ±n!")
                            
                            st.balloons()
                            
                            # Form counter'Ä± artÄ±r ve yenile
                            st.session_state.music_form_counter += 1
                            time.sleep(1)
                            st.rerun()
                        else:
                            st.error("âŒ LÃ¼tfen hem konu hem de ÅŸarkÄ± sÃ¶zlerini yazÄ±n!")
                
                with music_tab1:
                    # MÃ¼zikleri dinleme/gÃ¶rÃ¼ntÃ¼leme bÃ¶lÃ¼mÃ¼
                    if not st.session_state.user_music_creations:
                        st.info("ğŸµ HenÃ¼z hiÃ§ mÃ¼ziÄŸiniz yok. 'Yeni MÃ¼zik Yarat' sekmesinden mÃ¼ziklerinizi oluÅŸturun!")
                    else:
                        # Ders seÃ§imi
                        available_music_subjects = list(st.session_state.user_music_creations.keys())
                        selected_music_subject = st.selectbox(
                            "ğŸ¯ Hangi dersin mÃ¼ziklerini dinlemek istiyorsun?",
                            available_music_subjects,
                            key="music_subject_select"
                        )
                        
                        if selected_music_subject and st.session_state.user_music_creations[selected_music_subject]:
                            musics = st.session_state.user_music_creations[selected_music_subject]
                            
                            # Ä°statistikler
                            music_col_stat1, music_col_stat2, music_col_stat3 = st.columns(3)
                            with music_col_stat1:
                                st.metric("ğŸµ Toplam MÃ¼zik", len(musics))
                            with music_col_stat2:
                                total_plays = sum(music.get('play_count', 0) for music in musics)
                                st.metric("ğŸ§ Toplam Dinleme", total_plays)
                            with music_col_stat3:
                                most_recent = max(musics, key=lambda x: x['created_date'])['created_date']
                                st.metric("ğŸ“… Son Eklenen", most_recent[:10])
                            
                            # MÃ¼zik listesi
                            for i, music in enumerate(musics):
                                with st.expander(f"ğŸµ {music['topic']} - {music['style']} ({music['difficulty']})", expanded=False):
                                    music_display_col1, music_display_col2 = st.columns([3, 1])
                                    
                                    with music_display_col1:
                                        st.markdown(f"""
                                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                                                   color: white; padding: 20px; border-radius: 15px; margin: 10px 0;">
                                            <h4 style="margin: 0 0 15px 0;">ğŸ¤ {music['topic']} MÃ¼ziÄŸi</h4>
                                            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; font-family: monospace; white-space: pre-line; line-height: 1.6;">
{music['lyrics']}
                                            </div>
                                        </div>
                                        """, unsafe_allow_html=True)
                                        
                                        if music['notes'] != "Notunuz yok":
                                            st.markdown(f"""
                                            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; border-left: 4px solid #667eea; margin-top: 10px;">
                                                <strong>ğŸ“ Notlar:</strong> {music['notes']}
                                            </div>
                                            """, unsafe_allow_html=True)
                                    
                                    with music_display_col2:
                                        st.markdown(f"""
                                        <div style="text-align: center; padding: 10px;">
                                            <div style="margin: 5px 0;"><strong>ğŸµ Tarz:</strong> {music['style']}</div>
                                            <div style="margin: 5px 0;"><strong>â­ Seviye:</strong> {music['difficulty']}</div>
                                            <div style="margin: 5px 0;"><strong>ğŸ§ Dinlenme:</strong> {music.get('play_count', 0)}</div>
                                            <div style="margin: 5px 0;"><strong>ğŸ“… Tarih:</strong> {music['created_date'][:10]}</div>
                                        </div>
                                        """, unsafe_allow_html=True)
                                        
                                        # Dinleme butonu
                                        if st.button(f"ğŸ§ Dinledim", key=f"play_music_{i}", use_container_width=True):
                                            music['play_count'] = music.get('play_count', 0) + 1
                                            
                                            # Firebase'e kaydet
                                            username = st.session_state.get('current_user', None)
                                            if username:
                                                try:
                                                    music_json = json.dumps(st.session_state.user_music_creations, ensure_ascii=False)
                                                    update_user_in_firebase(username, {'music_creations': music_json})
                                                except:
                                                    pass  # Sessiz hata yÃ¶netimi
                                            
                                            st.success("ğŸµ Harika! MÃ¼ziÄŸin sayacÄ±nÄ± artÄ±rdÄ±k!")
                                            time.sleep(1)
                                            st.rerun()
                                        
                                        # Silme butonu
                                        if st.button(f"ğŸ—‘ï¸ Sil", key=f"delete_music_{i}", use_container_width=True):
                                            if st.button(f"âš ï¸ Evet, Sil!", key=f"confirm_delete_music_{i}"):
                                                musics.pop(i)
                                                
                                                # Firebase'e kaydet
                                                username = st.session_state.get('current_user', None)
                                                if username:
                                                    try:
                                                        music_json = json.dumps(st.session_state.user_music_creations, ensure_ascii=False)
                                                        update_user_in_firebase(username, {'music_creations': music_json})
                                                    except:
                                                        pass  # Sessiz hata yÃ¶netimi
                                                
                                                st.success("ğŸ—‘ï¸ MÃ¼zik silindi!")
                                                st.rerun()
                        else:
                            st.info(f"ğŸµ '{selected_music_subject}' dersinde henÃ¼z mÃ¼zik yok. Yeni mÃ¼zik yaratÄ±n!")
                
                # ğŸ“š HÄ°KAYELEÅTÄ°RME SÄ°STEMÄ° - YENÄ°!
                st.markdown("---")
                st.markdown("""
                <div style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%); color: white; padding: 30px; border-radius: 20px; margin: 40px 0; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
                    <h1 style="margin: 0; font-size: 2.5rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">ğŸ“š KONUYU HÄ°KAYELEÅTÄ°R</h1>
                    <p style="margin: 10px 0 0 0; font-size: 1.3rem; opacity: 0.95;">SÄ±kÄ±cÄ± konularÄ± hayal gÃ¼cÃ¼nle eÄŸlenceli hikayelere Ã§evir!</p>
                </div>
                """, unsafe_allow_html=True)
                
                # KullanÄ±cÄ±nÄ±n hikayelerini saklamak iÃ§in Firebase entegrasyonu
                if 'user_story_creations' not in st.session_state:
                    username = st.session_state.get('current_user', None)
                    if username:
                        users_data = load_users_from_firebase()
                        user_data = users_data.get(username, {})
                        saved_stories = user_data.get('story_creations', '{}')
                        try:
                            if isinstance(saved_stories, str):
                                st.session_state.user_story_creations = json.loads(saved_stories)
                            else:
                                st.session_state.user_story_creations = saved_stories if isinstance(saved_stories, dict) else {}
                        except (json.JSONDecodeError, TypeError):
                            st.session_state.user_story_creations = {}
                    else:
                        st.session_state.user_story_creations = {}
                
                # Sekme sistemi - Hikayelerimi Oku | Yeni Hikaye Yaz
                story_tab1, story_tab2 = st.tabs(["ğŸ“– Hikayelerimi Oku", "âœï¸ Yeni Hikaye Yaz"])
                
                with story_tab2:
                    # Form temizleme kontrolÃ¼
                    if 'story_form_counter' not in st.session_state:
                        st.session_state.story_form_counter = 0
                    
                    # Yeni hikaye oluÅŸturma formu
                    st.markdown("""
                    <div style="background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%); 
                               border-radius: 15px; padding: 25px; margin: 20px 0;">
                        <h3 style="color: #2d3748; margin-bottom: 20px; text-align: center;">âœï¸ Konunu Hikayelere Ã‡evir</h3>
                    </div>
                    """, unsafe_allow_html=True)
                    
                    # Form alanlarÄ± - unique key'ler
                    story_form_key = st.session_state.story_form_counter
                    story_col1, story_col2 = st.columns(2)
                    
                    with story_col1:
                        # Alan bilgisini sistemden al (aynÄ± mantÄ±k)
                        user_area = user_data.get('target_department', 'SayÄ±sal')
                        area_subjects = {
                            'SayÄ±sal': ["TYT Matematik", "TYT Fizik", "TYT Kimya", "TYT Biyoloji", "TYT Din KÃ¼ltÃ¼rÃ¼", "TYT Felsefe", "TYT Tarih (isteÄŸe baÄŸlÄ±)", "TYT CoÄŸrafya (isteÄŸe baÄŸlÄ±)", "AYT Matematik", "AYT Fizik", "AYT Kimya", "AYT Biyoloji"],
                            'EÅŸit AÄŸÄ±rlÄ±k': ["TYT TÃ¼rkÃ§e", "TYT Matematik", "TYT Din KÃ¼ltÃ¼rÃ¼", "TYT Felsefe", "TYT Fizik (isteÄŸe baÄŸlÄ±)", "TYT Kimya (isteÄŸe baÄŸlÄ±)", "TYT Biyoloji (isteÄŸe baÄŸlÄ±)", "AYT Matematik", "AYT Edebiyat", "AYT Tarih", "AYT CoÄŸrafya"],
                            'SÃ¶zel': ["TYT TÃ¼rkÃ§e", "AYT Edebiyat", "AYT Tarih", "AYT CoÄŸrafya", "TYT Tarih", "TYT CoÄŸrafya"],
                            'Dil': ["TYT TÃ¼rkÃ§e", "AYT Edebiyat", "YDT Dil"]
                        }
                        
                        suggested_subjects = area_subjects.get(user_area, ["TYT TÃ¼rkÃ§e", "TYT Matematik"])
                        all_subjects = ["TYT TÃ¼rkÃ§e", "TYT Matematik", "TYT Geometri", "TYT Fizik", "TYT Kimya", "TYT Biyoloji", 
                                       "TYT Tarih", "TYT CoÄŸrafya", "TYT Felsefe", "AYT Matematik", "AYT Fizik", "AYT Kimya", 
                                       "AYT Biyoloji", "AYT Edebiyat", "AYT Tarih", "AYT CoÄŸrafya"]
                        
                        # Ã–nce kendi alanÄ±nÄ± gÃ¶ster, sonra tÃ¼mÃ¼nÃ¼
                        final_subjects = suggested_subjects + [s for s in all_subjects if s not in suggested_subjects]
                        
                        story_subject = st.selectbox(
                            "ğŸ“š Hangi ders iÃ§in hikaye?",
                            final_subjects,
                            key=f"story_subject_{story_form_key}",
                            help=f"ğŸ¯ AlanÄ±n ({user_area}) dersleri Ã¶ncelikli gÃ¶steriliyor"
                        )
                        
                        # Konu seÃ§imi - konu takipten gÃ¼ncel olarak Ã§ek
                        available_story_topics = get_topic_list(story_subject)
                        if available_story_topics:
                            story_topic = st.selectbox(
                                "ğŸ¯ Hangi konu iÃ§in hikaye?",
                                available_story_topics,
                                key=f"story_topic_{story_form_key}"
                            )
                        else:
                            story_topic = st.text_input(
                                "ğŸ¯ Konu adÄ±nÄ± yazÄ±n",
                                placeholder="Ã–rnek: Fotosentez, FransÄ±z Ä°htilali, Limit KavramÄ±...",
                                key=f"story_topic_manual_{story_form_key}"
                            )
                    
                    with story_col2:
                        # Hikaye tÃ¼rÃ¼ seÃ§imi
                        story_type = st.selectbox(
                            "ğŸ“– Hikaye TÃ¼rÃ¼",
                            ["Fantastik", "Macera", "Bilim Kurgu", "Dedektif", "Romantik", "Komedi", "Gerilim", "Tarihsel"],
                            key=f"story_type_{story_form_key}"
                        )
                        
                        # Hedef kitle
                        story_audience = st.selectbox(
                            "ğŸ‘¥ Hedef Kitle",
                            ["Kendi Ä°Ã§in", "Ã‡ocuklar Ä°Ã§in", "ArkadaÅŸlar Ä°Ã§in", "Genel"],
                            key=f"story_audience_{story_form_key}"
                        )
                    
                    # Hikaye yazma alanÄ±
                    st.markdown("### ğŸ“ Hikayeni Yaz")
                    story_content = st.text_area(
                        "âœï¸ Hikaye Metni (Konuyu eÄŸlenceli bir hikayeye Ã§evir)",
                        placeholder="""Ã–rnek Fotosentez Hikayesi:

ğŸ“– "YeÅŸil YapraklarÄ±n SÄ±rrÄ±"

KÃ¼Ã§Ã¼k Klorofil, gÃ¼neÅŸin altÄ±n Ä±ÅŸÄ±nlarÄ±nÄ± yakalamak iÃ§in her sabah erken kalkar. Bir gÃ¼n, arkadaÅŸÄ± Su MolekÃ¼lÃ¼ ile birlikte bÃ¼yÃ¼k bir maceraya atÄ±lÄ±rlar. 

GÃ¼neÅŸ IÅŸÄ±ÄŸÄ± KrallÄ±ÄŸÄ±'ndan gelen altÄ±n parÃ§acÄ±klarÄ± yakalayarak, havadaki CO2 canavarlarÄ±nÄ± yenmeye karar verirler. Her yakaladÄ±klarÄ± CO2 canavarÄ±nÄ± ÅŸekere dÃ¶nÃ¼ÅŸtÃ¼rÃ¼rken, nefes alan tÃ¼m canlÄ±lar iÃ§in oksijen hediyesi bÄ±rakÄ±rlar.

Klorofil'in bÃ¼yÃ¼lÃ¼ yeÅŸil gÃ¼cÃ¼ sayesinde, bitkinin her hÃ¼cresi enerji dolu ÅŸeker taneleriyle dolup taÅŸar. Ve bÃ¶ylece, Fotosentez KrallÄ±ÄŸÄ±'nda huzur ve bereket hep sÃ¼rer...

ğŸ§ª "Bu hikaye ÅŸu bilgileri iÃ§erir: Klorofil + GÃ¼neÅŸ IÅŸÄ±ÄŸÄ± + H2O + CO2 = Glikoz + O2"
                        """,
                        height=250,
                        key=f"story_content_{story_form_key}"
                    )
                    
                    # Anahtar noktalar
                    story_key_points = st.text_area(
                        "ğŸ”‘ Anahtar Noktalar (Hikayende hangi bilgiler var?)",
                        placeholder="Bu hikayedeki Ã¶nemli bilgiler:\n- Fotosentez = Klorofil + GÃ¼neÅŸ + Su + Karbondioksit â†’ Åeker + Oksijen\n- YeÅŸil yapraklarda gerÃ§ekleÅŸir\n- Bitkiler bÃ¶yle enerji Ã¼retir",
                        height=100,
                        key=f"story_key_points_{story_form_key}"
                    )
                    
                    # Hikaye kaydetme butonu
                    if st.button("ğŸ“š Hikayeyi Kaydet", use_container_width=True, type="primary", key=f"save_story_{story_form_key}"):
                        if story_topic and story_content.strip():
                            # KullanÄ±cÄ±nÄ±n hikayelerine ekle
                            if story_subject not in st.session_state.user_story_creations:
                                st.session_state.user_story_creations[story_subject] = []
                            
                            new_story = {
                                'subject': story_subject,
                                'topic': story_topic,
                                'type': story_type,
                                'audience': story_audience,
                                'content': story_content.strip(),
                                'key_points': story_key_points.strip() if story_key_points.strip() else "Anahtar nokta belirtilmedi",
                                'created_date': datetime.now().strftime("%Y-%m-%d %H:%M"),
                                'read_count': 0
                            }
                            
                            st.session_state.user_story_creations[story_subject].append(new_story)
                            
                            # Firebase'e kaydet
                            username = st.session_state.get('current_user', None)
                            if username:
                                try:
                                    story_json = json.dumps(st.session_state.user_story_creations, ensure_ascii=False)
                                    update_user_in_firebase(username, {'story_creations': story_json})
                                    st.success(f"ğŸ‰ '{story_topic}' konulu hikayeniz '{story_subject}' dersine eklendi ve Firebase'e kaydedildi!")
                                except Exception as e:
                                    st.success(f"ğŸ‰ '{story_topic}' konulu hikayeniz '{story_subject}' dersine eklendi! (Yerel olarak)")
                                    st.info("ğŸ’¾ Hikayeleriniz bu oturum boyunca saklanacak.")
                            else:
                                st.success(f"ğŸ‰ '{story_topic}' konulu hikayeniz '{story_subject}' dersine eklendi! (GeÃ§ici)")
                                st.warning("âš ï¸ GiriÅŸ yapÄ±n ki hikayeleriniz kalÄ±cÄ± olarak saklansÄ±n!")
                            
                            st.balloons()
                            
                            # Form counter'Ä± artÄ±r ve yenile
                            st.session_state.story_form_counter += 1
                            time.sleep(1)
                            st.rerun()
                        else:
                            st.error("âŒ LÃ¼tfen hem konu hem de hikaye iÃ§eriÄŸini yazÄ±n!")
                
                with story_tab1:
                    # Hikayeleri okuma bÃ¶lÃ¼mÃ¼
                    if not st.session_state.user_story_creations:
                        st.info("ğŸ“š HenÃ¼z hiÃ§ hikayeleniz yok. 'Yeni Hikaye Yaz' sekmesinden hikayelerinizi oluÅŸturun!")
                    else:
                        # Ders seÃ§imi
                        available_story_subjects = list(st.session_state.user_story_creations.keys())
                        selected_story_subject = st.selectbox(
                            "ğŸ¯ Hangi dersin hikayelerini okumak istiyorsun?",
                            available_story_subjects,
                            key="story_subject_select"
                        )
                        
                        if selected_story_subject and st.session_state.user_story_creations[selected_story_subject]:
                            stories = st.session_state.user_story_creations[selected_story_subject]
                            
                            # Ä°statistikler
                            story_col_stat1, story_col_stat2, story_col_stat3 = st.columns(3)
                            with story_col_stat1:
                                st.metric("ğŸ“š Toplam Hikaye", len(stories))
                            with story_col_stat2:
                                total_reads = sum(story.get('read_count', 0) for story in stories)
                                st.metric("ğŸ‘ï¸ Toplam Okuma", total_reads)
                            with story_col_stat3:
                                story_most_recent = max(stories, key=lambda x: x['created_date'])['created_date']
                                st.metric("ğŸ“… Son Eklenen", story_most_recent[:10])
                            
                            # Hikaye listesi
                            for i, story in enumerate(stories):
                                with st.expander(f"ğŸ“– {story['topic']} - {story['type']} Hikayesi", expanded=False):
                                    story_display_col1, story_display_col2 = st.columns([3, 1])
                                    
                                    with story_display_col1:
                                        st.markdown(f"""
                                        <div style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); 
                                                   color: white; padding: 20px; border-radius: 15px; margin: 10px 0;">
                                            <h4 style="margin: 0 0 15px 0;">ğŸ“– {story['topic']} Hikayesi</h4>
                                            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; white-space: pre-line; line-height: 1.8; font-size: 1.1rem;">
{story['content']}
                                            </div>
                                        </div>
                                        """, unsafe_allow_html=True)
                                        
                                        if story['key_points'] != "Anahtar nokta belirtilmedi":
                                            st.markdown(f"""
                                            <div style="background: #e8f5e8; padding: 15px; border-radius: 10px; border-left: 4px solid #27ae60; margin-top: 10px;">
                                                <strong>ğŸ”‘ Anahtar Noktalar:</strong><br>{story['key_points']}
                                            </div>
                                            """, unsafe_allow_html=True)
                                    
                                    with story_display_col2:
                                        st.markdown(f"""
                                        <div style="text-align: center; padding: 10px;">
                                            <div style="margin: 5px 0;"><strong>ğŸ“– TÃ¼r:</strong> {story['type']}</div>
                                            <div style="margin: 5px 0;"><strong>ğŸ‘¥ Kitle:</strong> {story['audience']}</div>
                                            <div style="margin: 5px 0;"><strong>ğŸ‘ï¸ Okunma:</strong> {story.get('read_count', 0)}</div>
                                            <div style="margin: 5px 0;"><strong>ğŸ“… Tarih:</strong> {story['created_date'][:10]}</div>
                                        </div>
                                        """, unsafe_allow_html=True)
                                        
                                        # Okuma butonu
                                        if st.button(f"ğŸ‘ï¸ Okudum", key=f"read_story_{i}", use_container_width=True):
                                            story['read_count'] = story.get('read_count', 0) + 1
                                            
                                            # Firebase'e kaydet
                                            username = st.session_state.get('current_user', None)
                                            if username:
                                                try:
                                                    story_json = json.dumps(st.session_state.user_story_creations, ensure_ascii=False)
                                                    update_user_in_firebase(username, {'story_creations': story_json})
                                                except:
                                                    pass  # Sessiz hata yÃ¶netimi
                                            
                                            st.success("ğŸ“š Harika! Hikayenin sayacÄ±nÄ± artÄ±rdÄ±k!")
                                            time.sleep(1)
                                            st.rerun()
                                        
                                        # Silme butonu
                                        if st.button(f"ğŸ—‘ï¸ Sil", key=f"delete_story_{i}", use_container_width=True):
                                            if st.button(f"âš ï¸ Evet, Sil!", key=f"confirm_delete_story_{i}"):
                                                stories.pop(i)
                                                
                                                # Firebase'e kaydet
                                                username = st.session_state.get('current_user', None)
                                                if username:
                                                    try:
                                                        story_json = json.dumps(st.session_state.user_story_creations, ensure_ascii=False)
                                                        update_user_in_firebase(username, {'story_creations': story_json})
                                                    except:
                                                        pass  # Sessiz hata yÃ¶netimi
                                                
                                                st.success("ğŸ—‘ï¸ Hikaye silindi!")
                                                st.rerun()
                        else:
                            st.info(f"ğŸ“š '{selected_story_subject}' dersinde henÃ¼z hikaye yok. Yeni hikaye yazÄ±n!")
                
                # KullanÄ±m Ã¶nerileri ve motivasyon
                st.markdown("""
                <div style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); 
                           border-radius: 15px; padding: 20px; margin-top: 30px;">
                    <h4 style="color: #2d3748; margin-bottom: 15px;">ğŸ’¡ AkÄ±lda KalÄ±cÄ±lÄ±k Ä°puÃ§larÄ±</h4>
                    <ul style="color: #4a5568; margin: 0; padding-left: 20px;">
                        <li><strong>ğŸµ MÃ¼zik:</strong> Ritim ve melodi hafÄ±zayÄ± gÃ¼Ã§lendirir</li>
                        <li><strong>ğŸ“š Hikaye:</strong> GÃ¶rsel hayal gÃ¼cÃ¼ bilgileri kalÄ±cÄ± hale getirir</li>
                        <li><strong>ğŸ”„ Tekrar:</strong> OluÅŸturduÄŸun iÃ§erikleri dÃ¼zenli gÃ¶zden geÃ§ir</li>
                        <li><strong>ğŸ­ CanlandÄ±r:</strong> Hikayeleri zihninde canlandÄ±r, mÃ¼zikleri mÄ±rÄ±ldan</li>
                        <li><strong>ğŸ¤ PaylaÅŸ:</strong> ArkadaÅŸlarÄ±nla oluÅŸturduÄŸun iÃ§erikleri paylaÅŸ</li>
                    </ul>
                </div>
                """, unsafe_allow_html=True)
                
                # ğŸ“ YAZIM KURALLARI NOT DEFTERÄ°M - YENÄ°!
                st.markdown("---")
                st.markdown("""
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #a8edea 100%); color: white; padding: 30px; border-radius: 20px; margin: 40px 0; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
                    <h1 style="margin: 0; font-size: 2.5rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">ğŸ“ YAZIM KURALLARI NOT DEFTERÄ°M</h1>
                    <p style="margin: 10px 0 0 0; font-size: 1.3rem; opacity: 0.95;">ZorlandÄ±ÄŸÄ±n kelimeleri kaydet, sonra geri dÃ¶n ve Ã§alÄ±ÅŸ!</p>
                </div>
                """, unsafe_allow_html=True)
                
                # KullanÄ±cÄ±nÄ±n yazÄ±m kurallarÄ± notlarÄ±nÄ± saklamak iÃ§in Firebase entegrasyonu
                if 'user_spelling_notes' not in st.session_state:
                    username = st.session_state.get('current_user', None)
                    if username:
                        users_data = load_users_from_firebase()
                        user_data = users_data.get(username, {})
                        saved_notes = user_data.get('spelling_notes', '{}')
                        try:
                            if isinstance(saved_notes, str):
                                st.session_state.user_spelling_notes = json.loads(saved_notes)
                            else:
                                st.session_state.user_spelling_notes = saved_notes if isinstance(saved_notes, dict) else {}
                        except (json.JSONDecodeError, TypeError):
                            st.session_state.user_spelling_notes = {}
                    else:
                        st.session_state.user_spelling_notes = {}
                
                # Sekme sistemi - NotlarÄ±mÄ± Ã‡alÄ±ÅŸ | Yeni Not Ekle
                spelling_tab1, spelling_tab2 = st.tabs(["ğŸ”„ NotlarÄ±mÄ± Ã‡alÄ±ÅŸ", "â• Yeni Not Ekle"])
                
                with spelling_tab2:
                    # Form temizleme kontrolÃ¼
                    if 'spelling_form_counter' not in st.session_state:
                        st.session_state.spelling_form_counter = 0
                    
                    # Yeni yazÄ±m kuralÄ± notu ekleme formu
                    st.markdown("""
                    <div style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); 
                               border-radius: 15px; padding: 25px; margin: 20px 0;">
                        <h3 style="color: #2d3748; margin-bottom: 20px; text-align: center;">ğŸ“š ZorlandÄ±ÄŸÄ±n Kelimeleri Kaydet</h3>
                        <p style="color: #4a5568; text-align: center; margin: 0;">SÄ±navda, denemede veya Ã§alÄ±ÅŸÄ±rken yanlÄ±ÅŸ yaptÄ±ÄŸÄ±n kelimeleri buraya not et!</p>
                    </div>
                    """, unsafe_allow_html=True)
                    
                    # Form alanlarÄ± - unique key'ler
                    spelling_form_key = st.session_state.spelling_form_counter
                    spelling_col1, spelling_col2 = st.columns(2)
                    
                    with spelling_col1:
                        # YazÄ±m kuralÄ± kategorisi
                        rule_category = st.selectbox(
                            "ğŸ“‚ Hangi konu/kural?",
                            [
                                "BirleÅŸik/AyrÄ± YazÄ±m",
                                "BÃ¼yÃ¼k/KÃ¼Ã§Ã¼k Harf",
                                "Noktalama Ä°ÅŸaretleri", 
                                "ÃœnlÃ¼ DaralmasÄ±/DÃ¼ÅŸmesi",
                                "Ek YazÄ±mÄ±",
                                "YabancÄ± Kelimeler",
                                "KÄ±saltmalar",
                                "DiÄŸer"
                            ],
                            key=f"rule_category_{spelling_form_key}"
                        )
                        
                        # YanlÄ±ÅŸ yazdÄ±ÄŸÄ± kelime/cÃ¼mle
                        wrong_writing = st.text_input(
                            "âŒ NasÄ±l yanlÄ±ÅŸ yazmÄ±ÅŸtÄ±n?",
                            placeholder="Ã–rnek: herzaman, tÃ¼rkiye, Ne gÃ¼zel bir gÃ¼n, vs...",
                            key=f"wrong_writing_{spelling_form_key}"
                        )
                    
                    with spelling_col2:
                        # DoÄŸru yazÄ±m
                        correct_writing = st.text_input(
                            "âœ… DoÄŸru yazÄ±mÄ± nedir?",
                            placeholder="Ã–rnek: her zaman, TÃ¼rkiye, Ne gÃ¼zel bir gÃ¼n!, vs...",
                            key=f"correct_writing_{spelling_form_key}"
                        )
                        
                        # Hangi durumda hata yaptÄ±
                        error_source = st.selectbox(
                            "ğŸ“ Nerede hata yaptÄ±n?",
                            [
                                "Deneme SÄ±navÄ±nda",
                                "Ders Ã‡alÄ±ÅŸÄ±rken", 
                                "Ã–devde",
                                "GÃ¼nlÃ¼k YazÄ±mda",
                                "Online Testte",
                                "Ã–ÄŸretmen Sorusunda",
                                "DiÄŸer"
                            ],
                            key=f"error_source_{spelling_form_key}"
                        )
                    
                    # Kural aÃ§Ä±klamasÄ±
                    st.markdown("### ğŸ“ Kural ve NotlarÄ±n")
                    rule_explanation = st.text_area(
                        "ğŸ” Bu kuralÄ± nasÄ±l hatÄ±rlayacaksÄ±n?",
                        placeholder="""Ã–rnek:
- "her zaman" ayrÄ± yazÄ±lÄ±r Ã§Ã¼nkÃ¼ "her" bir edat
- Ãœlke adlarÄ± bÃ¼yÃ¼k harfle baÅŸlar: TÃ¼rkiye, Almanya, Fransa
- Ãœnlem cÃ¼mleleri ! ile biter: Ne gÃ¼zel!, Ã‡ok teÅŸekkÃ¼rler!
- Kendi hatÄ±rlama yÃ¶ntemini yaz...""",
                        height=120,
                        key=f"rule_explanation_{spelling_form_key}"
                    )
                    
                    # Notlama seviyesi
                    difficulty_level = st.selectbox(
                        "â­ Ne kadar zor buluyorsun?",
                        ["ğŸ˜Š Kolay - Tekrar etmek yeter", "ğŸ˜ Orta - Biraz Ã§alÄ±ÅŸmalÄ±yÄ±m", "ğŸ˜° Zor - Ã‡ok pratik yapmalÄ±yÄ±m"],
                        key=f"difficulty_level_{spelling_form_key}"
                    )
                    
                    # Notu kaydetme butonu
                    if st.button("ğŸ’¾ Notu Kaydet", use_container_width=True, type="primary", key=f"save_spelling_note_{spelling_form_key}"):
                        if wrong_writing.strip() and correct_writing.strip():
                            # Kategoriye ekle
                            if rule_category not in st.session_state.user_spelling_notes:
                                st.session_state.user_spelling_notes[rule_category] = []
                            
                            new_note = {
                                'wrong_writing': wrong_writing.strip(),
                                'correct_writing': correct_writing.strip(),
                                'rule_explanation': rule_explanation.strip() if rule_explanation.strip() else "AÃ§Ä±klama eklenmedi",
                                'error_source': error_source,
                                'difficulty_level': difficulty_level,
                                'created_date': datetime.now().strftime("%Y-%m-%d %H:%M"),
                                'study_count': 0,
                                'mastered': False
                            }
                            
                            st.session_state.user_spelling_notes[rule_category].append(new_note)
                            
                            # Firebase'e kaydet
                            username = st.session_state.get('current_user', None)
                            if username:
                                try:
                                    notes_json = json.dumps(st.session_state.user_spelling_notes, ensure_ascii=False)
                                    update_user_in_firebase(username, {'spelling_notes': notes_json})
                                    st.success(f"ğŸ‰ '{wrong_writing}' notu '{rule_category}' kategorisine eklendi ve Firebase'e kaydedildi!")
                                except Exception as e:
                                    st.success(f"ğŸ‰ '{wrong_writing}' notu '{rule_category}' kategorisine eklendi! (Yerel olarak)")
                                    st.info("ğŸ’¾ NotlarÄ±nÄ±z bu oturum boyunca saklanacak.")
                            else:
                                st.success(f"ğŸ‰ '{wrong_writing}' notu '{rule_category}' kategorisine eklendi! (GeÃ§ici)")
                                st.warning("âš ï¸ GiriÅŸ yapÄ±n ki notlarÄ±nÄ±z kalÄ±cÄ± olarak saklansÄ±n!")
                            
                            st.balloons()
                            
                            # Form counter'Ä± artÄ±r ve yenile
                            st.session_state.spelling_form_counter += 1
                            time.sleep(1)
                            st.rerun()
                        else:
                            st.error("âŒ LÃ¼tfen hem yanlÄ±ÅŸ hem de doÄŸru yazÄ±mÄ± girin!")
                
                with spelling_tab1:
                    # NotlarÄ± Ã§alÄ±ÅŸma bÃ¶lÃ¼mÃ¼
                    if not st.session_state.user_spelling_notes:
                        st.info("ğŸ“ HenÃ¼z hiÃ§ notun yok. 'Yeni Not Ekle' sekmesinden zorlandÄ±ÄŸÄ±n kelimeleri kaydet!")
                    else:
                        # Kategori seÃ§imi
                        available_categories = list(st.session_state.user_spelling_notes.keys())
                        selected_category = st.selectbox(
                            "ğŸ“‚ Hangi kategoriyi Ã§alÄ±ÅŸmak istiyorsun?",
                            available_categories,
                            key="study_category_select"
                        )
                        
                        if selected_category and st.session_state.user_spelling_notes[selected_category]:
                            notes = st.session_state.user_spelling_notes[selected_category]
                            
                            # Ä°statistikler
                            notes_col_stat1, notes_col_stat2, notes_col_stat3 = st.columns(3)
                            with notes_col_stat1:
                                st.metric("ğŸ“ Toplam Not", len(notes))
                            with notes_col_stat2:
                                mastered_notes = sum(1 for note in notes if note.get('mastered', False))
                                st.metric("âœ… Ã–ÄŸrendiÄŸim", mastered_notes)
                            with notes_col_stat3:
                                progress_percent = (mastered_notes / len(notes) * 100) if len(notes) > 0 else 0
                                st.metric("ğŸ¯ Ä°lerleme", f"%{progress_percent:.1f}")
                            
                            # NotlarÄ± listele
                            for i, note in enumerate(notes):
                                # Zorluk seviyesine gÃ¶re renk
                                if "ğŸ˜Š Kolay" in note['difficulty_level']:
                                    card_color = "#2ecc71"
                                elif "ğŸ˜ Orta" in note['difficulty_level']:
                                    card_color = "#f39c12"
                                else:
                                    card_color = "#e74c3c"
                                
                                # Ã–ÄŸrenildi mi kontrolÃ¼
                                mastery_status = "âœ… Ã–ÄRENDÄ°M" if note.get('mastered', False) else "ğŸ“š Ã‡ALIÅIYORUM"
                                mastery_color = "#27ae60" if note.get('mastered', False) else "#3498db"
                                
                                with st.expander(f"{'âœ…' if note.get('mastered', False) else 'ğŸ“'} {note['wrong_writing']} â†’ {note['correct_writing']}", expanded=False):
                                    note_display_col1, note_display_col2 = st.columns([3, 1])
                                    
                                    with note_display_col1:
                                        st.markdown(f"""
                                        <div style="background: linear-gradient(135deg, {card_color} 0%, {card_color}CC 100%); 
                                                   color: white; padding: 20px; border-radius: 15px; margin: 10px 0;">
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                                <h4 style="margin: 0;">ğŸ“ YazÄ±m Hatam</h4>
                                                <span style="background: {mastery_color}; padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: bold;">
                                                    {mastery_status}
                                                </span>
                                            </div>
                                            
                                            <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 10px; margin: 10px 0;">
                                                <div style="margin: 10px 0;"><strong>âŒ YanlÄ±ÅŸ YazdÄ±ÄŸÄ±m:</strong> {note['wrong_writing']}</div>
                                                <div style="margin: 10px 0;"><strong>âœ… DoÄŸru YazÄ±mÄ±:</strong> {note['correct_writing']}</div>
                                                <div style="margin: 10px 0;"><strong>ğŸ” KuralÄ±/Notum:</strong></div>
                                                <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; font-style: italic; line-height: 1.6;">
                                                    {note['rule_explanation']}
                                                </div>
                                            </div>
                                        </div>
                                        """, unsafe_allow_html=True)
                                    
                                    with note_display_col2:
                                        st.markdown(f"""
                                        <div style="text-align: center; padding: 10px;">
                                            <div style="margin: 5px 0;"><strong>ğŸ“ Hata Yeri:</strong> {note['error_source']}</div>
                                            <div style="margin: 5px 0;"><strong>â­ Zorluk:</strong> {note['difficulty_level'][:2]}</div>
                                            <div style="margin: 5px 0;"><strong>ğŸ”„ Ã‡alÄ±ÅŸma:</strong> {note.get('study_count', 0)} kez</div>
                                            <div style="margin: 5px 0;"><strong>ğŸ“… Tarih:</strong> {note['created_date'][:10]}</div>
                                        </div>
                                        """, unsafe_allow_html=True)
                                        
                                        # Ã‡alÄ±ÅŸma butonu
                                        if st.button(f"ğŸ“– Ã‡alÄ±ÅŸtÄ±m", key=f"study_note_{i}", use_container_width=True):
                                            note['study_count'] = note.get('study_count', 0) + 1
                                            
                                            # Firebase'e kaydet
                                            username = st.session_state.get('current_user', None)
                                            if username:
                                                try:
                                                    notes_json = json.dumps(st.session_state.user_spelling_notes, ensure_ascii=False)
                                                    update_user_in_firebase(username, {'spelling_notes': notes_json})
                                                except:
                                                    pass  # Sessiz hata yÃ¶netimi
                                            
                                            st.success("ğŸ“š Harika! Ã‡alÄ±ÅŸma sayacÄ±nÄ± artÄ±rdÄ±k!")
                                            time.sleep(1)
                                            st.rerun()
                                        
                                        # Ã–ÄŸrendim butonu
                                        if note.get('mastered', False):
                                            if st.button(f"â†©ï¸ Tekrar Ã‡alÄ±ÅŸ", key=f"unmaster_note_{i}", use_container_width=True):
                                                note['mastered'] = False
                                                
                                                # Firebase'e kaydet
                                                username = st.session_state.get('current_user', None)
                                                if username:
                                                    try:
                                                        notes_json = json.dumps(st.session_state.user_spelling_notes, ensure_ascii=False)
                                                        update_user_in_firebase(username, {'spelling_notes': notes_json})
                                                    except:
                                                        pass  # Sessiz hata yÃ¶netimi
                                                
                                                st.info("ğŸ”„ Tekrar Ã§alÄ±ÅŸma listesine eklendi!")
                                                time.sleep(1)
                                                st.rerun()
                                        else:
                                            if st.button(f"âœ… Ã–ÄŸrendim", key=f"master_note_{i}", use_container_width=True):
                                                note['mastered'] = True
                                                
                                                # Firebase'e kaydet
                                                username = st.session_state.get('current_user', None)
                                                if username:
                                                    try:
                                                        notes_json = json.dumps(st.session_state.user_spelling_notes, ensure_ascii=False)
                                                        update_user_in_firebase(username, {'spelling_notes': notes_json})
                                                    except:
                                                        pass  # Sessiz hata yÃ¶netimi
                                                
                                                st.success("ğŸ‰ Tebrikler! Bu kuralÄ± Ã¶ÄŸrendin!")
                                                time.sleep(1)
                                                st.rerun()
                                        
                                        # Silme butonu
                                        if st.button(f"ğŸ—‘ï¸ Sil", key=f"delete_note_{i}", use_container_width=True):
                                            if st.button(f"âš ï¸ Evet, Sil!", key=f"confirm_delete_note_{i}"):
                                                notes.pop(i)
                                                
                                                # Firebase'e kaydet
                                                username = st.session_state.get('current_user', None)
                                                if username:
                                                    try:
                                                        notes_json = json.dumps(st.session_state.user_spelling_notes, ensure_ascii=False)
                                                        update_user_in_firebase(username, {'spelling_notes': notes_json})
                                                    except:
                                                        pass  # Sessiz hata yÃ¶netimi
                                                
                                                st.success("ğŸ—‘ï¸ Not silindi!")
                                                st.rerun()
                            
                            # Ä°lerleme Ã§ubuÄŸu
                            st.progress(progress_percent / 100)
                            st.markdown(f"**ğŸ“ˆ Ä°lerleme Durumun:** {mastered_notes}/{len(notes)} kural tamamlandÄ± (%{progress_percent:.1f})")
                        else:
                            st.info(f"ğŸ“ '{selected_category}' kategorisinde henÃ¼z not yok. Yeni not ekleyin!")
                
                # KullanÄ±m Ã¶nerileri ve motivasyon
                st.markdown("""
                <div style="background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%); 
                           border-radius: 15px; padding: 20px; margin-top: 30px;">
                    <h4 style="color: #2d3748; margin-bottom: 15px;">ğŸ’¡ NasÄ±l Daha Etkili KullanÄ±rÄ±m?</h4>
                    <ul style="color: #4a5568; margin: 0; padding-left: 20px;">
                        <li><strong>ğŸ“ Hemen Kaydet:</strong> Deneme/sÄ±navda yanlÄ±ÅŸ yapar yapmaz not et</li>
                        <li><strong>ğŸ”„ DÃ¼zenli Tekrar:</strong> Her gÃ¼n 5-10 dakika eskilerini gÃ¶zden geÃ§ir</li>
                        <li><strong>ğŸ“š KuralÄ±nÄ± Yaz:</strong> Her kelimenin kuralÄ±nÄ± kendi cÃ¼mlelerinle aÃ§Ä±kla</li>
                        <li><strong>âœ… Ä°lerleme Takibi:</strong> Ã–ÄŸrendiÄŸin kurallarÄ± iÅŸaretle</li>
                        <li><strong>ğŸ¯ Kategorize Et:</strong> Benzer hatalarÄ± grupla</li>
                        <li><strong>ğŸ§  HatÄ±rlama TÃ¼yosu:</strong> Komik cÃ¼mleler/kÄ±saltmalar kullan</li>
                    </ul>
                </div>
                """, unsafe_allow_html=True)
                
                # ğŸ“š KÄ°TAP KARAKTERÄ° ANKETÄ° - YENÄ°!
                st.markdown("---")
                st.markdown("""
                <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 50%, #4facfe 100%); color: white; padding: 30px; border-radius: 20px; margin: 40px 0; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
                    <h1 style="margin: 0; font-size: 2.5rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">ğŸ“š "KÄ°TAP KARAKTERÄ°" ANKETÄ°</h1>
                    <p style="margin: 10px 0 0 0; font-size: 1.3rem; opacity: 0.95;">YKS Ã¶ÄŸrencisi iÃ§in Ã¶zel: Molana hangi kitap eÅŸlik etsin?</p>
                </div>
                """, unsafe_allow_html=True)
                
                # KullanÄ±cÄ±nÄ±n kitap verilerini saklamak iÃ§in Firebase entegrasyonu
                if 'user_book_survey' not in st.session_state:
                    username = st.session_state.get('current_user', None)
                    if username:
                        users_data = load_users_from_firebase()
                        user_data = users_data.get(username, {})
                        saved_book_data = user_data.get('book_survey_data', '{}')
                        try:
                            if isinstance(saved_book_data, str):
                                st.session_state.user_book_survey = json.loads(saved_book_data)
                            else:
                                st.session_state.user_book_survey = saved_book_data if isinstance(saved_book_data, dict) else {}
                        except (json.JSONDecodeError, TypeError):
                            st.session_state.user_book_survey = {}
                    else:
                        st.session_state.user_book_survey = {}
                
                # Sekme sistemi - Anket Ã‡Ã¶z | Okuma Takibim
                book_tab1, book_tab2 = st.tabs(["ğŸ“ Kitap Anketi", "ğŸ“– Okuma Takibim"])
                
                with book_tab1:
                    # Anket aÃ§Ä±klama
                    st.markdown("""
                    <div style="background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%); 
                               border-radius: 15px; padding: 25px; margin: 20px 0;">
                        <h3 style="color: #2d3748; margin-bottom: 20px; text-align: center;">ğŸ“– Merhaba! Bu yoÄŸun YKS maratonunda kÄ±sa bir mola verip zihnini dinlendirecek o mÃ¼kemmel kitabÄ± bulmaya ne dersin?</h3>
                        <p style="color: #2d3748; text-align: center; font-size: 1.1rem;">AÅŸaÄŸÄ±daki sorulara seni en iyi yansÄ±tan cevabÄ± seÃ§, bakalÄ±m kitap karakterin neymiÅŸ!</p>
                    </div>
                    """, unsafe_allow_html=True)
                    
                    # Kitap Anketi SorularÄ±
                    st.markdown("### ğŸ“ Kitap Karakter Anketi")
                    
                    # Soru 1
                    st.markdown("#### 1ï¸âƒ£ Åu an ders Ã§alÄ±ÅŸmÄ±yorken zihnin en Ã§ok nerede olmak isterdi?")
                    q1_answer = st.radio(
                        "",
                        [
                            "a) BambaÅŸka bir evrende, ejderhalarÄ±n veya uzay gemilerinin olduÄŸu fantastik bir macerada.",
                            "b) Tarihe yÃ¶n vermiÅŸ bir liderin veya imkansÄ±zÄ± baÅŸarmÄ±ÅŸ bir bilim insanÄ±nÄ±n yanÄ±nda, ondan ilham alÄ±rken.",
                            "c) Sakin bir kafede oturmuÅŸ, hayatÄ±n ve insanlarÄ±n neden bÃ¶yle olduÄŸunu derin derin dÃ¼ÅŸÃ¼nÃ¼rken.",
                            "d) En yakÄ±n arkadaÅŸlarÄ±mla birlikte sÄ±cak bir kahve iÃ§ip dertleÅŸtiÄŸim, samimi ve huzurlu bir sohbette."
                        ],
                        key="book_q1"
                    )
                    
                    # Soru 2  
                    st.markdown("#### 2ï¸âƒ£ Bu aralar bir film izleyecek olsan, hangisini tercih ederdin?")
                    q2_answer = st.radio(
                        "",
                        [
                            "a) Beni koltuÄŸuma baÄŸlayacak, sonunu asla tahmin edemeyeceÄŸim bir gizem veya macera filmi.",
                            "b) GerÃ§ek bir hayat hikayesinden uyarlanmÄ±ÅŸ, zorluklarÄ±n Ã¼stesinden gelip zafere ulaÅŸan birini anlatan bir film.",
                            "c) Ä°zledikten sonra Ã¼zerine saatlerce dÃ¼ÅŸÃ¼neceÄŸim, 'Acaba ne demek istedi?' diye sorgulatacak sembolik bir film.",
                            "d) Bolca gÃ¼leceÄŸim, iÃ§imi Ä±sÄ±tacak, bittiÄŸinde yÃ¼zÃ¼mde bir tebessÃ¼m bÄ±rakacak romantik komedi veya animasyon."
                        ],
                        key="book_q2"
                    )
                    
                    # Soru 3
                    st.markdown("#### 3ï¸âƒ£ Bir sÃ¼per gÃ¼cÃ¼n olsa, hangisini seÃ§erdin?")
                    q3_answer = st.radio(
                        "",
                        [
                            "a) IÅŸÄ±nlanma! SÄ±nav stresinden anÄ±nda uzaklaÅŸÄ±p dÃ¼nyanÄ±n bambaÅŸka yerlerini keÅŸfetmek iÃ§in.",
                            "b) SÃ¼per dayanÄ±klÄ±lÄ±k ve zihin gÃ¼cÃ¼! Yorulmadan, pes etmeden hedeflerime ulaÅŸmak iÃ§in.",
                            "c) ZamanÄ± durdurma! Her ÅŸeyin bu kadar hÄ±zlÄ± aktÄ±ÄŸÄ± bir dÃ¼nyada durup sakince dÃ¼ÅŸÃ¼nebilmek iÃ§in.",
                            "d) Ä°nsanlarÄ± iyileÅŸtirme ve mutlu etme! EtrafÄ±mdaki herkesin stresini alÄ±p onlara huzur vermek iÃ§in."
                        ],
                        key="book_q3"
                    )
                    
                    # Soru 4
                    st.markdown("#### 4ï¸âƒ£ 'KeÅŸke ÅŸu an biri bana ÅŸunu sÃ¶ylese...' dediÄŸin cÃ¼mle hangisi?")
                    q4_answer = st.radio(
                        "",
                        [
                            "a) 'Hadi gel, her ÅŸeyi bÄ±rakÄ±p bambaÅŸka bir dÃ¼nyanÄ±n kapÄ±sÄ±nÄ± aralayalÄ±m.'",
                            "b) 'Unutma, bugÃ¼n dÃ¶ktÃ¼ÄŸÃ¼n her damla ter, yarÄ±nki zaferinin mÃ¼jdecisidir.'",
                            "c) 'Peki sence bÃ¼tÃ¼n bu koÅŸturmacanÄ±n ardÄ±ndaki asÄ±l anlam ne?'",
                            "d) 'HiÃ§bir ÅŸeyi dert etme, her ÅŸey yoluna girecek. Sadece anÄ±n tadÄ±nÄ± Ã§Ä±kar.'"
                        ],
                        key="book_q4"
                    )
                    
                    # Anket Sonucu Hesaplama
                    if st.button("ğŸ“Š Sonucu Ã–ÄŸren!", use_container_width=True, type="primary"):
                        # CevaplarÄ± say
                        answers = [q1_answer, q2_answer, q3_answer, q4_answer]
                        a_count = sum(1 for answer in answers if answer.startswith('a)'))
                        b_count = sum(1 for answer in answers if answer.startswith('b)'))
                        c_count = sum(1 for answer in answers if answer.startswith('c)'))
                        d_count = sum(1 for answer in answers if answer.startswith('d)'))
                        
                        # En Ã§ok seÃ§ilen harfi bul
                        counts = {'A': a_count, 'B': b_count, 'C': c_count, 'D': d_count}
                        dominant_type = max(counts, key=counts.get)
                        
                        # Kitap Ã¶nerileri
                        book_recommendations = {
                            'A': {
                                'type': 'ğŸŒŸ KaÃ§Ä±ÅŸ ve Macera Ruhu!',
                                'need': 'GerÃ§eklikten uzaklaÅŸmak, zihnini tamamen boÅŸaltmak.',
                                'books': [
                                    'YÃ¼zÃ¼klerin Efendisi (J.R.R. Tolkien)',
                                    'MarslÄ± (Andy Weir)',
                                    'Agatha Christie Polisiye RomanlarÄ±',
                                    'Harry Potter Serisi',
                                    'Dune (Frank Herbert)',
                                    'Sherlock Holmes Hikayeleri'
                                ],
                                'description': 'SÃ¼rÃ¼kleyici Fantastik, Bilim Kurgu veya soluksuz okunan Polisiye tÃ¼rÃ¼nde kitaplar senin iÃ§in ideal! Bu kitaplar seni gÃ¼nlÃ¼k stresinden uzaklaÅŸtÄ±rÄ±p bambaÅŸka dÃ¼nyalara gÃ¶tÃ¼recek.',
                                'color': '#8B5CF6'
                            },
                            'B': {
                                'type': 'âš¡ Ä°lham Arayan SavaÅŸÃ§Ä±!',
                                'need': 'Motivasyon, umut ve verilen emeklerin deÄŸerli olduÄŸunu hissetmek.',
                                'books': [
                                    'SimyacÄ± (Paulo Coelho)',
                                    'Steve Jobs Biyografisi',
                                    'BaÅŸarÄ±lÄ± Ä°nsanlarÄ±n 7 AlÄ±ÅŸkanlÄ±ÄŸÄ±',
                                    'Elon Musk Biyografisi',
                                    'Zoraki Kahraman',
                                    'Ä°nsanÄ±n Anlam ArayÄ±ÅŸÄ± (Viktor Frankl)'
                                ],
                                'description': 'BaÅŸarÄ±lÄ± insanlarÄ±n Biyografileri, zorluklarÄ±n aÅŸÄ±ldÄ±ÄŸÄ± GerÃ§ek Hikayeler veya yolculuk temalÄ± romanlar tam sana gÃ¶re! Bu kitaplar sana gÃ¼Ã§ ve ilham verecek.',
                                'color': '#10B981'
                            },
                            'C': {
                                'type': 'ğŸ¤” Derin DÃ¼ÅŸÃ¼nÃ¼r!',
                                'need': 'Ufkunu geniÅŸletmek ve hayatÄ± sorgulamak.',
                                'books': [
                                    'SatranÃ§ (Stefan Zweig)',
                                    'Bilinmeyen Bir KadÄ±nÄ±n Mektubu (Stefan Zweig)',
                                    'Hayvan Ã‡iftliÄŸi (George Orwell)',
                                    'YabancÄ± (Albert Camus)',
                                    '1984 (George Orwell)',
                                    'SuÃ§ ve Ceza (Dostoyevski)'
                                ],
                                'description': 'Stefan Zweig\'Ä±n kÄ±sa ama etkileyici romanlarÄ±, George Orwell klasikleri veya Albert Camus gibi dÃ¼ÅŸÃ¼ndÃ¼rÃ¼cÃ¼ eserler senin ruhuyla uyumlu. Bu kitaplar seni derin dÃ¼ÅŸÃ¼ncelere sevk edecek.',
                                'color': '#3B82F6'
                            },
                            'D': {
                                'type': 'ğŸ¤— Huzur Arayan Dost CanlÄ±sÄ±!',
                                'need': 'Stresten arÄ±nmak, iÃ§ini Ä±sÄ±tacak samimi ve sÄ±cak bir hikaye.',
                                'books': [
                                    'Ove AdÄ±nda Bir Adam (Fredrik Backman)',
                                    'Åeker PortakalÄ± (JosÃ© Mauro de Vasconcelos)',
                                    'Sait Faik AbasÄ±yanÄ±k Ã–ykÃ¼leri',
                                    'KÃ¼Ã§Ã¼k Prens (Antoine de Saint-ExupÃ©ry)',
                                    'BabamÄ±n AdÄ± KÄ±rmÄ±zÄ± (Orhan Pamuk)',
                                    'Ä°nsan Ä°nsana (Baria Alamuddin)'
                                ],
                                'description': 'Ä°nsana kendini iyi hissettiren Fredrik Backman kitaplarÄ±, Åeker PortakalÄ± gibi klasikler veya Sait Faik\'ten sÄ±cak insan Ã¶ykÃ¼leri tam senlik! Bu kitaplar ruhunu dinlendirecek.',
                                'color': '#F59E0B'
                            }
                        }
                        
                        result = book_recommendations[dominant_type]
                        
                        # Sonucu gÃ¶ster
                        st.markdown(f"""
                        <div style="background: linear-gradient(135deg, {result['color']} 0%, {result['color']}CC 100%); 
                                   color: white; padding: 30px; border-radius: 20px; margin: 20px 0; text-align: center;">
                            <h2 style="margin: 0 0 15px 0;">{result['type']}</h2>
                            <p style="font-size: 1.2rem; margin: 15px 0;"><strong>Ä°htiyacÄ±n:</strong> {result['need']}</p>
                            <p style="font-size: 1.1rem; margin: 15px 0;">{result['description']}</p>
                        </div>
                        """, unsafe_allow_html=True)
                        
                        # Kitap Ã¶nerileri
                        st.markdown("### ğŸ“š Senin Ä°Ã§in Ã–zel Kitap Ã–nerileri:")
                        for book in result['books']:
                            st.markdown(f"ğŸ“– **{book}**")
                        
                        # Anket sonucunu kaydet
                        survey_result = {
                            'answers': {
                                'q1': q1_answer,
                                'q2': q2_answer, 
                                'q3': q3_answer,
                                'q4': q4_answer
                            },
                            'result_type': dominant_type,
                            'result_name': result['type'],
                            'recommended_books': result['books'],
                            'completed_date': datetime.now().strftime("%Y-%m-%d %H:%M")
                        }
                        
                        st.session_state.user_book_survey['last_survey'] = survey_result
                        
                        # Firebase'e kaydet
                        username = st.session_state.get('current_user', None)
                        if username:
                            try:
                                book_data_json = json.dumps(st.session_state.user_book_survey, ensure_ascii=False)
                                update_user_in_firebase(username, {'book_survey_data': book_data_json})
                                st.success("ğŸ“š Anket sonucun kaydedildi! ArtÄ±k okuma takibini baÅŸlatabilirsin.")
                            except Exception as e:
                                st.info("ğŸ“š Anket sonucun bu oturum boyunca saklandÄ±.")
                        else:
                            st.warning("âš ï¸ GiriÅŸ yapÄ±n ki anket sonucunuz kalÄ±cÄ± olarak saklansÄ±n!")
                        
                        st.balloons()
                
                with book_tab2:
                    # Okuma Takip Sistemi
                    if 'last_survey' not in st.session_state.user_book_survey:
                        st.info("ğŸ“ Ã–nce anketi Ã§Ã¶zerek kitap Ã¶nerilerini alÄ±n, sonra okuma takibinizi baÅŸlatÄ±n!")
                    else:
                        last_result = st.session_state.user_book_survey['last_survey']
                        
                        # Ã–nce profil kartÄ±nÄ± gÃ¶ster
                        st.markdown(f"""
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                                   color: white; padding: 20px; border-radius: 15px; margin: 20px 0;">
                            <h3 style="margin: 0 0 10px 0;">ğŸ“– Kitap Profilin</h3>
                            <p style="margin: 5px 0;"><strong>Tip:</strong> {last_result['result_name']}</p>
                            <p style="margin: 5px 0;"><strong>Anket Tarihi:</strong> {last_result['completed_date'][:10]}</p>
                        </div>
                        """, unsafe_allow_html=True)
                        
                        # Okuma takibi baÅŸlat
                        if 'reading_progress' not in st.session_state.user_book_survey:
                            st.session_state.user_book_survey['reading_progress'] = []
                        
                        # Yeni okuma kaydÄ±
                        st.markdown("### ğŸ“ HaftalÄ±k Okuma Takibi")
                        
                        with st.expander("â• Yeni HaftalÄ±k KayÄ±t Ekle", expanded=True):
                            read_col1, read_col2 = st.columns(2)
                            
                            with read_col1:
                                book_name = st.text_input(
                                    "ğŸ“š OkuduÄŸun Kitap",
                                    placeholder="Kitap adÄ±nÄ± yaz..."
                                )
                                pages_read = st.number_input(
                                    "ğŸ“„ Bu hafta kaÃ§ sayfa okudun?",
                                    min_value=0,
                                    max_value=1000,
                                    step=1
                                )
                            
                            with read_col2:
                                week_start = st.date_input("ğŸ“… Hafta BaÅŸlangÄ±cÄ±")
                                satisfaction = st.selectbox(
                                    "ğŸ˜Š Memnuniyet Seviyesi",
                                    ["â­ KÃ¶tÃ¼", "â­â­ Orta", "â­â­â­ Ä°yi", "â­â­â­â­ Ã‡ok Ä°yi", "â­â­â­â­â­ MÃ¼kemmel"]
                                )
                            
                            # Anlama ve notlar
                            understanding = st.text_area(
                                "ğŸ§  Bu hafta neler anladÄ±n / Ã¶ÄŸrendin?",
                                placeholder="Kitaptan etkilendiÄŸin bÃ¶lÃ¼mler, Ã¶ÄŸrendiÄŸin yeni bilgiler, karakterler hakkÄ±nda dÃ¼ÅŸÃ¼ncelerin...",
                                height=100
                            )
                            
                            thoughts = st.text_area(
                                "ğŸ’­ Genel dÃ¼ÅŸÃ¼ncelerin ve yorumlarÄ±n",
                                placeholder="Kitap hakkÄ±nda genel gÃ¶rÃ¼ÅŸlerin, beÄŸendiÄŸin/beÄŸenmediÄŸin yanlar, tavsiye eder misin?",
                                height=80
                            )
                            
                            if st.button("ğŸ“– HaftalÄ±k KaydÄ± Ekle", use_container_width=True, type="primary"):
                                if book_name and pages_read > 0:
                                    new_reading_entry = {
                                        'book_name': book_name,
                                        'pages_read': pages_read,
                                        'week_start': str(week_start),
                                        'satisfaction': satisfaction,
                                        'understanding': understanding,
                                        'thoughts': thoughts,
                                        'entry_date': datetime.now().strftime("%Y-%m-%d %H:%M")
                                    }
                                    
                                    st.session_state.user_book_survey['reading_progress'].append(new_reading_entry)
                                    
                                    # Firebase'e kaydet
                                    username = st.session_state.get('current_user', None)
                                    if username:
                                        try:
                                            book_data_json = json.dumps(st.session_state.user_book_survey, ensure_ascii=False)
                                            update_user_in_firebase(username, {'book_survey_data': book_data_json})
                                            st.success(f"ğŸ“š '{book_name}' iÃ§in haftalÄ±k okuma kaydÄ±n eklendi!")
                                        except Exception as e:
                                            st.success(f"ğŸ“š '{book_name}' iÃ§in haftalÄ±k okuma kaydÄ±n eklendi! (Yerel olarak)")
                                    else:
                                        st.warning("âš ï¸ GiriÅŸ yapÄ±n ki okuma kayÄ±tlarÄ±nÄ±z kalÄ±cÄ± olarak saklansÄ±n!")
                                    
                                    st.balloons()
                                    time.sleep(1)
                                    st.rerun()
                                else:
                                    st.error("âŒ LÃ¼tfen kitap adÄ±nÄ± ve sayfa sayÄ±sÄ±nÄ± giriniz!")
                        
                        # GeÃ§miÅŸ okuma kayÄ±tlarÄ±
                        if st.session_state.user_book_survey['reading_progress']:
                            st.markdown("### ğŸ“Š Okuma GeÃ§miÅŸin")
                            
                            reading_entries = st.session_state.user_book_survey['reading_progress']
                            
                            # Ä°statistikler
                            total_pages = sum(entry['pages_read'] for entry in reading_entries)
                            total_weeks = len(reading_entries)
                            avg_pages = total_pages / total_weeks if total_weeks > 0 else 0
                            unique_books = len(set(entry['book_name'] for entry in reading_entries))
                            
                            stat_col1, stat_col2, stat_col3, stat_col4 = st.columns(4)
                            with stat_col1:
                                st.metric("ğŸ“„ Toplam Sayfa", total_pages)
                            with stat_col2:
                                st.metric("ğŸ“… Toplam Hafta", total_weeks)
                            with stat_col3:
                                st.metric("ğŸ“ˆ HaftalÄ±k Ort.", f"{avg_pages:.1f}")
                            with stat_col4:
                                st.metric("ğŸ“š Kitap SayÄ±sÄ±", unique_books)
                            
                            # KayÄ±tlarÄ± listele
                            for i, entry in enumerate(reversed(reading_entries)):  # En yeni Ã¶nce
                                with st.expander(f"ğŸ“– {entry['book_name']} - {entry['week_start']} ({entry['pages_read']} sayfa)", expanded=False):
                                    entry_col1, entry_col2 = st.columns([3, 1])
                                    
                                    with entry_col1:
                                        st.markdown(f"""
                                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin: 10px 0;">
                                            <p style="margin: 5px 0;"><strong>ğŸ§  AnladÄ±klarÄ±m:</strong></p>
                                            <p style="margin: 10px 0; font-style: italic;">{entry['understanding'] if entry['understanding'] else 'BelirtilmemiÅŸ'}</p>
                                            <p style="margin: 5px 0;"><strong>ğŸ’­ DÃ¼ÅŸÃ¼ncelerim:</strong></p>
                                            <p style="margin: 10px 0; font-style: italic;">{entry['thoughts'] if entry['thoughts'] else 'BelirtilmemiÅŸ'}</p>
                                        </div>
                                        """, unsafe_allow_html=True)
                                    
                                    with entry_col2:
                                        st.markdown(f"""
                                        <div style="text-align: center; padding: 10px;">
                                            <div style="margin: 5px 0;"><strong>ğŸ“„ Sayfa:</strong> {entry['pages_read']}</div>
                                            <div style="margin: 5px 0;"><strong>ğŸ˜Š Memnuniyet:</strong> {entry['satisfaction']}</div>
                                            <div style="margin: 5px 0;"><strong>ğŸ“… Hafta:</strong> {entry['week_start']}</div>
                                            <div style="margin: 5px 0;"><strong>â° Eklenme:</strong> {entry['entry_date'][:10]}</div>
                                        </div>
                                        """, unsafe_allow_html=True)
                        else:
                            st.info("ğŸ“š HenÃ¼z okuma kaydÄ±nÄ±z yok. YukarÄ±dan ilk haftalÄ±k kaydÄ±nÄ±zÄ± ekleyin!")
                
                # Alt bilgi
                st.markdown("""
                <div style="background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%); 
                           border-radius: 15px; padding: 25px; margin-top: 30px; border-left: 5px solid #28a745;">
                    <h4 style="color: #2d3748; margin-bottom: 15px;">ğŸ’¡ Kitap Okuma Ä°puÃ§larÄ±</h4>
                    <ul style="color: #4a5568; margin: 0; padding-left: 20px;">
                        <li><strong>â° DÃ¼zenli Okuma:</strong> Her gÃ¼n 15-30 dakika okuma alÄ±ÅŸkanlÄ±ÄŸÄ± edinin</li>
                        <li><strong>ğŸ“ Not Alma:</strong> EtkilendiÄŸiniz bÃ¶lÃ¼mleri not alÄ±n</li>
                        <li><strong>ğŸ¤” DÃ¼ÅŸÃ¼nme:</strong> OkuduklarÄ±nÄ±z Ã¼zerine dÃ¼ÅŸÃ¼nÃ¼n ve kendinizle baÄŸlantÄ± kurun</li>
                        <li><strong>ğŸ¯ Hedef Koyma:</strong> HaftalÄ±k sayfa hedefleri belirleyin</li>
                        <li><strong>ğŸ“š Ã‡eÅŸitlilik:</strong> FarklÄ± tÃ¼rde kitaplar okuyarak ufkunuzu geniÅŸletin</li>
                    </ul>
                </div>
                """, unsafe_allow_html=True)
            
            elif page == "ğŸ¯ YKS CanlÄ± Takip":
                yks_takip_page(user_data)
            
            elif page == "ğŸ… Pomodoro Timer":
                pomodoro_timer_page(user_data)
            
            elif page == "ğŸ† Rekabet Panosu":
                competition_leaderboard_page(user_data)
            

            elif page == "ğŸ§  Psikolojim":
                run_psychology_page()
            elif page == "ğŸ”¬DetaylÄ± Deneme Analiz Takibi":
                st.markdown(f'<div class="main-header"><h1>ğŸ”¬DetaylÄ± Deneme Analiz Takibi</h1><p>SÄ±nav performansÄ±nÄ±zÄ± bilimsel analiz edin</p></div>', unsafe_allow_html=True)

                # EÄŸer global olarak daha Ã¶nce tanÄ±mlanmadÄ±ysa ders soru sayÄ±larÄ±nÄ± tanÄ±mla
                if 'SUBJECT_MAX_QUESTIONS' not in globals():
                    SUBJECT_MAX_QUESTIONS = {
                        "TYT TÃ¼rkÃ§e": 40, "TYT Matematik": 40, "TYT Geometri": 40,
                        "TYT Tarih": 5, "TYT CoÄŸrafya": 5, "TYT Felsefe": 5, "TYT Din KÃ¼ltÃ¼rÃ¼": 5,
                        "TYT Fizik": 7, "TYT Kimya": 7, "TYT Biyoloji": 6,
                        "AYT Matematik": 40, "AYT Fizik": 14, "AYT Kimya": 13, "AYT Biyoloji": 13,
                        "AYT Edebiyat": 40, "AYT Tarih": 40, "AYT CoÄŸrafya": 40
                    }

                # KullanÄ±cÄ±nÄ±n deneme verilerini yÃ¼kle
                deneme_data_str = user_data.get('deneme_analizleri', '[]')
                try:
                    deneme_kayitlari = json.loads(deneme_data_str) if deneme_data_str else []
                except Exception:
                    deneme_kayitlari = []

                # Yeni deneme ekleme (manuel toplam_net alanÄ±nÄ± koruyoruz)
                with st.expander("â• Yeni Deneme Ekle", expanded=True):
                    col1, col2, col3 = st.columns(3)
                    with col1:
                        deneme_adi = st.text_input("Deneme AdÄ±", placeholder="Ã–rn: 2024 TYT Denemesi #1", key="deneme_adi")
                        deneme_tarihi = st.date_input("Deneme Tarihi", key="deneme_tarihi")
                    with col2:
                        deneme_turu = st.selectbox("Deneme TÃ¼rÃ¼", ["TYT", "AYT", "TYT-AYT"], key="deneme_turu")
                        # Eski arayÃ¼zde olan toplam_net alanÄ±nÄ± bÄ±rakÄ±yoruz (kullanÄ±cÄ± manuel girebilir)
                        toplam_net_input = st.number_input("Toplam Net (manuel, istersen bÄ±rak)", min_value=0.0, max_value=200.0, step=0.25, key="toplam_net")
                    with col3:
                        toplam_dogru = st.number_input("Toplam DoÄŸru", min_value=0, max_value=200, step=1, key="toplam_dogru")
                        toplam_yanlis = st.number_input("Toplam YanlÄ±ÅŸ", min_value=0, max_value=200, step=1, key="toplam_yanlis")

                # Ders bazlÄ± net bilgileri (her dersin max'Ä±nÄ± SUBJECT_MAX_QUESTIONS ile kontrol et)
                st.subheader("ğŸ“ Ders BazlÄ± Net DaÄŸÄ±lÄ±mÄ±")
                ders_netleri = {}

                if deneme_turu in ("TYT", "TYT-AYT"):
                    tyt_dersler = ["TYT TÃ¼rkÃ§e", "TYT Matematik", "TYT Geometri",
                                   "TYT Fizik", "TYT Kimya", "TYT Biyoloji",
                                   "TYT Tarih", "TYT CoÄŸrafya", "TYT Felsefe", "TYT Din KÃ¼ltÃ¼rÃ¼"]
                    cols = st.columns(2)
                    for i, ders in enumerate(tyt_dersler):
                        with cols[i % 2]:
                            max_val = SUBJECT_MAX_QUESTIONS.get(ders, 20)
                            ders_netleri[ders] = st.number_input(
                                f"{ders} Net",
                                min_value=0.0,
                                max_value=float(max_val),
                                step=0.25,
                                key=f"tyt_{ders}"
                            )

                if deneme_turu in ("AYT", "TYT-AYT"):
                    ayt_dersler = ["AYT Matematik", "AYT Fizik", "AYT Kimya", "AYT Biyoloji", "AYT Edebiyat", "AYT Tarih", "AYT CoÄŸrafya"]
                    cols = st.columns(2)
                    for i, ders in enumerate(ayt_dersler):
                        with cols[i % 2]:
                            max_val = SUBJECT_MAX_QUESTIONS.get(ders, 20)
                            ders_netleri[ders] = st.number_input(
                                f"{ders} Net",
                                min_value=0.0,
                                max_value=float(max_val),
                                step=0.25,
                                key=f"ayt_{ders}"
                            )

                # YanlÄ±ÅŸ analizi (eski key'leri koruyoruz: f"{ders}_{neden}" -> bÃ¶ylece Ã¶nceki kayÄ±tlara baÄŸlÄ±lÄ±k bozulmaz)
                st.subheader("ğŸ” YanlÄ±ÅŸ Analizi")
                yanlis_nedenleri = {
                    "Bilgi EksikliÄŸi": "Konuyu tam olarak Ã¶ÄŸrenmemiÅŸ olmak",
                    "Dikkatsizlik": "Soruyu yanlÄ±ÅŸ okuma veya iÅŸlem hatasÄ±",
                    "Zaman Yetmedi": "SÃ¼reyi iyi kullanamama",
                    "Yorum HatasÄ±": "Sorunun mantÄ±ÄŸÄ±nÄ± anlayamama",
                    "Åans Eseri DoÄŸru": "Tahminle doÄŸru cevabÄ± bulma",
                    "Kodlama HatasÄ±": "Ä°ÅŸaretleme hatasÄ±"
                }

                yanlis_analiz = {}
                for ders, net in ders_netleri.items():
                    subject_max = SUBJECT_MAX_QUESTIONS.get(ders, 20)
                    if float(net) < float(subject_max) * 0.75:
                        with st.expander(f"âŒ {ders} - YanlÄ±ÅŸ Analizi"):
                            st.write(f"Bu derste {float(subject_max) - float(net):.1f} net kaybÄ±nÄ±z var. Sebepleri:")
                            for neden, aciklama in yanlis_nedenleri.items():
                                # Burada eski key formatÄ±nÄ± koruyoruz: key=f"{ders}_{neden}"
                                yanlis_sayisi = st.number_input(
                                    f"{ders} - {neden}",
                                    min_value=0,
                                    max_value=int(subject_max),
                                    value=0,
                                    step=1,
                                    key=f"{ders}_{neden}"
                                )
                                if yanlis_sayisi > 0:
                                    if ders not in yanlis_analiz:
                                        yanlis_analiz[ders] = {}
                                    yanlis_analiz[ders][neden] = int(yanlis_sayisi)

                # Eksik konu tespiti (aynÄ± mantÄ±k korunuyor)
                st.subheader("ğŸ“Œ Eksik Konu Tespiti")
                eksik_konular = {}
                for ders, net in ders_netleri.items():
                    subject_max = SUBJECT_MAX_QUESTIONS.get(ders, 20)
                    if float(net) < float(subject_max) * 0.6:
                        st.write(f"**{ders}** - Eksik konularÄ±nÄ±zÄ± iÅŸaretleyin:")
                        ders_konulari = get_topic_list(ders)
                        if ders_konulari:
                            secilen_konular = st.multiselect(f"{ders} eksik konular", ders_konulari, key=f"eksik_{ders}")
                            if secilen_konular:
                                eksik_konular[ders] = secilen_konular

                # Kaydet butonu: manuel toplam_net_input varsa onu kullan, yoksa ders_netleri toplamÄ±nÄ± kullan
                if st.button("ğŸ’¾ Deneme Analizini Kaydet", type="primary", use_container_width=True, key="kaydet_deneme"):
                    if deneme_adi and deneme_tarihi:
                        # Derslerden otomatik toplam
                        computed_total = sum([float(v) for v in ders_netleri.values()]) if ders_netleri else 0.0
                        # EÄŸer kullanÄ±cÄ± manuel toplam girmiÅŸse (manuel > 0) onu Ã¶ncelikle kullan, deÄŸilse computed_total
                        toplam_net_to_save = float(toplam_net_input) if float(toplam_net_input) > 0.0 else float(computed_total)

                        yeni_deneme = {
                            "id": len(deneme_kayitlari) + 1,
                            "adi": deneme_adi,
                            "tarih": str(deneme_tarihi),
                            "tur": deneme_turu,
                            "toplam_net": float(toplam_net_to_save),
                            "toplam_dogru": int(toplam_dogru),
                            "toplam_yanlis": int(toplam_yanlis),
                            "ders_netleri": ders_netleri,
                            "yanlis_analiz": yanlis_analiz,
                            "eksik_konular": eksik_konular,
                            "tavsiyeler": []
                        }

                        # Basit otomatik tavsiyeler (ders oranlarÄ±na gÃ¶re)
                        tavsiyeler = []
                        if float(toplam_net_to_save) < 50.0:
                            tavsiyeler.append("ğŸ”´ Netiniz dÃ¼ÅŸÃ¼k: Ã–ncelik temel konu tekrarlarÄ± olmalÄ±.")
                        elif float(toplam_net_to_save) < 80.0:
                            tavsiyeler.append("ğŸŸ¡ Orta seviye: Eksik konulara ve hÄ±z Ã§alÄ±ÅŸmasÄ±na odaklanÄ±n.")
                        else:
                            tavsiyeler.append("ğŸŸ¢ Ä°yi seviyedesiniz: Deneme pratiÄŸini sÃ¼rdÃ¼rÃ¼n, sÃ¼re yÃ¶netimini geliÅŸtirin.")

                        # Sadece dÃ¼ÅŸÃ¼k performanslÄ± dersler iÃ§in tavsiye ekle
                        dusuk_dersler = []
                        orta_dersler = []
                        for ders, net in ders_netleri.items():
                            subject_max = SUBJECT_MAX_QUESTIONS.get(ders, 20)
                            oran = float(net) / subject_max if subject_max > 0 else 0
                            if oran < 0.3:
                                dusuk_dersler.append(ders)
                            elif oran < 0.6:
                                orta_dersler.append(ders)
                        
                        if dusuk_dersler:
                            tavsiyeler.append(f"ğŸ“š **Ã–ncelikli Dersler ({len(dusuk_dersler)} ders)**: {', '.join(dusuk_dersler[:3])} {'ve diÄŸerleri' if len(dusuk_dersler) > 3 else ''} - Temel konu tekrarÄ± yapÄ±n.")
                        if orta_dersler:
                            tavsiyeler.append(f"ğŸ“– **GeliÅŸtirilebilir Dersler ({len(orta_dersler)} ders)**: {', '.join(orta_dersler[:3])} {'ve diÄŸerleri' if len(orta_dersler) > 3 else ''} - Soru Ã§Ã¶zme pratiÄŸi yapÄ±n.")

                        yeni_deneme["tavsiyeler"] = tavsiyeler
                        deneme_kayitlari.append(yeni_deneme)

                        # TYT/AYT NET GÃœNCELLEMESÄ° - Otomatik hesapla ve gÃ¼ncelle
                        updates_to_firebase = {'deneme_analizleri': json.dumps(deneme_kayitlari)}
                        
                        # Son 3 denemeyi al ve net hesapla
                        recent_3_exams = deneme_kayitlari[-3:] if len(deneme_kayitlari) >= 3 else deneme_kayitlari
                        
                        # DeÄŸiÅŸkenleri baÅŸta tanÄ±mla
                        last_tyt_total = 0
                        last_ayt_total = 0
                        
                        # TYT NET HESAPLAMA
                        if deneme_turu in ["TYT", "TYT-AYT"]:
                            tyt_subjects = ["TYT TÃ¼rkÃ§e", "TYT Matematik", "TYT Geometri", "TYT Fizik", 
                                          "TYT Kimya", "TYT Biyoloji", "TYT Tarih", "TYT CoÄŸrafya", 
                                          "TYT Felsefe", "TYT Din KÃ¼ltÃ¼rÃ¼"]
                            
                            # En son denemenin TYT toplam net'ini hesapla
                            last_tyt_total = sum([float(ders_netleri.get(subj, 0)) for subj in tyt_subjects])
                            updates_to_firebase['tyt_last_net'] = str(last_tyt_total)
                            
                            # Son 3 denemenin TYT ortalamasÄ±nÄ± hesapla
                            tyt_totals = []
                            for exam in recent_3_exams:
                                if exam.get('tur') in ["TYT", "TYT-AYT"]:
                                    exam_tyt_total = sum([float(exam.get('ders_netleri', {}).get(subj, 0)) for subj in tyt_subjects])
                                    tyt_totals.append(exam_tyt_total)
                            
                            if tyt_totals:
                                tyt_avg = sum(tyt_totals) / len(tyt_totals)
                                updates_to_firebase['tyt_avg_net'] = str(tyt_avg)
                        
                        # AYT NET HESAPLAMA
                        if deneme_turu in ["AYT", "TYT-AYT"]:
                            ayt_subjects = ["AYT Matematik", "AYT Fizik", "AYT Kimya", "AYT Biyoloji", 
                                          "AYT Edebiyat", "AYT Tarih", "AYT CoÄŸrafya"]
                            
                            # En son denemenin AYT toplam net'ini hesapla
                            last_ayt_total = sum([float(ders_netleri.get(subj, 0)) for subj in ayt_subjects])
                            updates_to_firebase['ayt_last_net'] = str(last_ayt_total)
                            
                            # Son 3 denemenin AYT ortalamasÄ±nÄ± hesapla
                            ayt_totals = []
                            for exam in recent_3_exams:
                                if exam.get('tur') in ["AYT", "TYT-AYT"]:
                                    exam_ayt_total = sum([float(exam.get('ders_netleri', {}).get(subj, 0)) for subj in ayt_subjects])
                                    ayt_totals.append(exam_ayt_total)
                            
                            if ayt_totals:
                                ayt_avg = sum(ayt_totals) / len(ayt_totals)
                                updates_to_firebase['ayt_avg_net'] = str(ayt_avg)
                        
                        # TÃ¼m gÃ¼ncellemeleri Firebase'e kaydet
                        update_user_in_firebase(st.session_state.current_user, updates_to_firebase)
                        
                        # ğŸš€ OPTÄ°MÄ°ZE: update_user_in_firebase() zaten session state'i gÃ¼nceller
                        
                        # MEVCUT KULLANICININ USER_DATA'SINI TAMAMEN YENÄ°LE
                        current_user_name = st.session_state.current_user
                        if current_user_name in st.session_state.users_db:
                            # user_data'yÄ± tamamen yenile
                            st.session_state.user_data = st.session_state.users_db[current_user_name].copy()

                        # BaÅŸarÄ± mesajÄ±nÄ± gÃ¼ncelle
                        success_msg = "âœ… Deneme analizi baÅŸarÄ±yla kaydedildi!"
                        if deneme_turu in ["TYT", "TYT-AYT"]:
                            success_msg += f"\nğŸ”„ TYT Son Net: {last_tyt_total:.1f} olarak gÃ¼ncellendi"
                            if 'tyt_avg_net' in updates_to_firebase:
                                success_msg += f"\nğŸ“Š TYT Ortalama Net: {float(updates_to_firebase['tyt_avg_net']):.1f} olarak gÃ¼ncellendi"
                        if deneme_turu in ["AYT", "TYT-AYT"]:
                            success_msg += f"\nğŸ”„ AYT Son Net: {last_ayt_total:.1f} olarak gÃ¼ncellendi"
                            if 'ayt_avg_net' in updates_to_firebase:
                                success_msg += f"\nğŸ“Š AYT Ortalama Net: {float(updates_to_firebase['ayt_avg_net']):.1f} olarak gÃ¼ncellendi"
                        
                        st.success(success_msg)
                        
                        # GÃ¼ncellenen netleri gÃ¶ster
                        if deneme_turu in ["TYT", "TYT-AYT"] and 'tyt_last_net' in updates_to_firebase:
                            st.info(f"ğŸ“ˆ TYT netlerin gÃ¼ncellendi: Son {float(updates_to_firebase['tyt_last_net']):.1f}, Ort {float(updates_to_firebase.get('tyt_avg_net', 0)):.1f}")
                        if deneme_turu in ["AYT", "TYT-AYT"] and 'ayt_last_net' in updates_to_firebase:
                            st.info(f"ğŸ“ˆ AYT netlerin gÃ¼ncellendi: Son {float(updates_to_firebase['ayt_last_net']):.1f}, Ort {float(updates_to_firebase.get('ayt_avg_net', 0)):.1f}")
                        
                        # BaÅŸarÄ± animasyonu (kÄ±sa)
                        st.balloons()
                        
                        # DOM hatasÄ±nÄ± Ã¶nlemek iÃ§in daha kÄ±sa delay ve alternatif yenileme
                        time.sleep(0.5)
                        
                        # State'i temizle ve yeniden yÃ¼kle
                        if 'deneme_form_submitted' not in st.session_state:
                            st.session_state.deneme_form_submitted = True
                        
                        st.rerun()
                    else:
                        st.error("âš ï¸ LÃ¼tfen deneme adÄ± ve tarihini giriniz")

                # GeÃ§miÅŸ denemeleri gÃ¶sterme + seÃ§ilen deneme detaylarÄ±
                if deneme_kayitlari:
                    st.markdown("---")
                    st.subheader("ğŸ“ˆ GeÃ§miÅŸ Denemeler")

                    deneme_listesi = [f"{d['adi']} - {d['tarih']} ({d['tur']})" for d in deneme_kayitlari]
                    secilen_deneme = st.selectbox("Analizini gÃ¶rÃ¼ntÃ¼lemek istediÄŸiniz denemeyi seÃ§in:", deneme_listesi, key="deneme_secim")

                    if secilen_deneme:
                        deneme_index = deneme_listesi.index(secilen_deneme)
                        deneme = deneme_kayitlari[deneme_index]

                        col1, col2, col3, col4 = st.columns(4)
                        with col1:
                            st.metric("ğŸ“Š Toplam Net", f"{float(deneme.get('toplam_net', 0)):.1f}")
                        with col2:
                            st.metric("âœ… DoÄŸru SayÄ±sÄ±", deneme.get('toplam_dogru', 0))
                        with col3:
                            st.metric("âŒ YanlÄ±ÅŸ SayÄ±sÄ±", deneme.get('toplam_yanlis', 0))
                        with col4:
                            st.metric("ğŸ¯ Deneme TÃ¼rÃ¼", deneme.get('tur', 'â€”'))

                        # Net daÄŸÄ±lÄ±m grafiÄŸi
                        st.subheader("ğŸ“Š Net DaÄŸÄ±lÄ±mÄ±")
                        dersler = [d for d, v in (deneme.get('ders_netleri') or {}).items() if v > 0]
                        netler = [deneme.get('ders_netleri', {}).get(d, 0) for d in dersler]
                        if dersler:
                            fig = px.bar(x=dersler, y=netler, title="Derslere GÃ¶re Net DaÄŸÄ±lÄ±mÄ±",
                                         labels={'x': 'Dersler', 'y': 'Net'}, color=netler,
                                         color_continuous_scale="Viridis")
                            safe_plotly_chart(fig, use_container_width=True, key=f"analysis_chart_{deneme.get('adi', '')}_{deneme.get('tarih', '')}_{hash(str(dersler))}")

                        # Ã–neriler (kaydedilmiÅŸ Ã¶neriler gÃ¶sterilsin) - DOM hatasÄ±nÄ± Ã¶nlemek iÃ§in tek markdown
                        st.subheader("ğŸ’¡ KayÄ±tlÄ± GeliÅŸim Tavsiyeleri")
                        tavsiyeler = deneme.get('tavsiyeler', [])
                        if tavsiyeler and len(tavsiyeler) > 0:
                            # TÃ¼m tavsiyeleri tek bir markdown string'de birleÅŸtir
                            tavsiye_text = "\n".join([f"{i+1}. {tavsiye}" for i, tavsiye in enumerate(tavsiyeler)])
                            st.markdown(tavsiye_text)
                        else:
                            st.info("ğŸ“ Bu deneme iÃ§in henÃ¼z tavsiye kaydedilmemiÅŸ.")

                    # ----- EN ALTA: TÃ¼m denemelerin gidiÅŸat grafiÄŸi -----
                    st.markdown("---")
                    st.subheader("ğŸ“ˆ Zaman Ä°Ã§inde GeliÅŸim (TÃ¼m Denemeler)")
                    tarihler = [d.get('tarih') for d in deneme_kayitlari]
                    netler = [float(d.get('toplam_net', 0)) for d in deneme_kayitlari]
                    if tarihler and any(netler):
                        gelisim_df = pd.DataFrame({"Tarih": tarihler, "Toplam Net": netler})
                        fig_line = px.line(gelisim_df, x="Tarih", y="Toplam Net", markers=True,
                                           title="Denemelerde Net GeliÅŸimi")
                        safe_plotly_chart(fig_line, use_container_width=True, key=f"gelisim_grafigi_{len(deneme_kayitlari)}_{hash(str(netler))}")

                        # Son denemeye Ã¶zel ders bazlÄ± Ã¶neriler (kÄ±sa, eyleme dÃ¶nÃ¼k)
                        son_deneme = deneme_kayitlari[-1]
                        low_subjects = []
                        for ders, net in (son_deneme.get('ders_netleri') or {}).items():
                            max_val = SUBJECT_MAX_QUESTIONS.get(ders, 20)
                            try:
                                oran = float(net) / float(max_val) if float(max_val) > 0 else 0
                            except Exception:
                                oran = 0
                            if oran < 0.5:
                                low_subjects.append((ders, oran))

                        st.subheader("ğŸ“Œ Son Denemeye GÃ¶re Ã–ncelikli Ã–neriler")
                        if low_subjects and len(low_subjects) > 0:
                            # DOM hatasÄ±nÄ± Ã¶nlemek iÃ§in tÃ¼m Ã¶nerileri tek markdown'da birleÅŸtir
                            oneriler_listesi = []
                            for i, (ders, oran) in enumerate(low_subjects):
                                oneriler_listesi.append(f"{i+1}. **{ders}** (%{oran*100:.0f}): Konu tekrarÄ± ve Ã§Ä±kmÄ±ÅŸ soru Ã§Ã¶zÃ¼mÃ¼; eksik konularÄ± parÃ§a parÃ§a kapatÄ±n.")
                            st.markdown("\n".join(oneriler_listesi))
                        else:
                            st.markdown("ğŸ‰ Tebrikler! Son denemede ders bazÄ±nda kayda deÄŸer dÃ¼ÅŸÃ¼k alan bulunmadÄ±.")

                        # Genel Ã§alÄ±ÅŸma Ã¶nerileri (kaynaklÄ±, kÄ±sa)
                        st.markdown("---")
                        st.subheader("ğŸ” GÃ¼venilir Kaynaklardan Derlenen KÄ±sa Ã‡alÄ±ÅŸma Ã–nerileri")
                        st.markdown("- OkuduÄŸunu anlama iÃ§in gÃ¼nlÃ¼k okuma alÄ±ÅŸkanlÄ±ÄŸÄ± (gazete/deneme/uzun paragraflar).")

            elif page == "ğŸ“Š Ä°statistikler":
                st.markdown(f'<div class="main-header"><h1>ğŸ“Š DetaylÄ± Ä°statistikler</h1><p>Ä°lerlemenizi analiz edin</p></div>', unsafe_allow_html=True)
                
                col1, col2, col3 = st.columns(3)
                with col1:
                    total_completed = sum(data['completed'] for data in progress_data.values())
                    total_topics = count_total_topics()
                    st.metric("ğŸ“Š Toplam Konu", f"{total_completed}/{total_topics}")
                with col2:
                    completion_rate = (total_completed / total_topics * 100) if total_topics > 0 else 0
                    st.metric("ğŸ¯ Tamamlanma OranÄ±", f"%{completion_rate:.1f}")
                with col3:
                    avg_net = 0; net_count = 0
                    topic_progress = json.loads(user_data.get('topic_progress', '{}') or '{}')
                    for topic_data in topic_progress.values():
                        try:
                            avg_net += float(topic_data)
                            net_count += 1
                        except ValueError:
                            continue
                    avg_net = (avg_net / net_count) if net_count > 0 else 0
                    st.metric("â­ Ortalama Net", f"{avg_net:.1f}")
                
                st.subheader("ğŸ“ˆ Ders BazÄ±nda Ä°lerleme")
                if progress_data:
                    subjects = list(progress_data.keys())
                    percents = [data['percent'] for data in progress_data.values()]
                    fig = px.bar(x=subjects, y=percents, title="Derslere GÃ¶re Tamamlanma OranlarÄ±", labels={'x': 'Dersler', 'y': 'Tamamlanma (%)'}, color=percents, color_continuous_scale="Viridis")
                    safe_plotly_chart(fig, use_container_width=True)
                    st.subheader("ğŸ“‹ DetaylÄ± Ä°lerleme Tablosu")
                    progress_df = pd.DataFrame([{'Ders': s, 'Tamamlanan': d['completed'], 'Toplam': d['total'], 'Oran (%)': d['percent']} for s, d in progress_data.items()])
                    st.dataframe(progress_df, use_container_width=True)
                else:
                    st.info("ğŸ“Š HenÃ¼z yeterli veri bulunmuyor. Konu takip sayfasÄ±ndan ilerlemenizi kaydedin.")
                    
            elif page == "ğŸ¬ Filmi BaÅŸlatâ€“ Ä°lk GÃ¼nden BugÃ¼ne YKS YolculuÄŸum":
                show_yks_journey_cinema(user_data, progress_data)
            
            elif page == "ğŸ¨ Ã–ÄŸrenme Stilleri Testi":
                run_vak_learning_styles_test()
            
            elif page == "ğŸ§  BiliÅŸsel Profil Testi":
                run_cognitive_profile_test()
            
            elif page == "âš¡ Motivasyon & Duygu Testi":
                run_motivation_emotional_test()
            
            elif page == "â° Zaman YÃ¶netimi Testi":
                run_time_management_test()

# === HÄ°BRÄ°T POMODORO SÄ°STEMÄ° FONKSÄ°YONLARI ===

def start_hibrit_breathing():
    """Hibrit nefes sistemini baÅŸlat - Pomodoro'yu duraklat"""
    # Pomodoro'yu duraklat
    if st.session_state.pomodoro_active:
        st.session_state.breathing_paused_time = st.session_state.time_remaining
    
    # Nefes sistemini baÅŸlat
    st.session_state.breathing_active = True
    st.session_state.breath_time_remaining = 60
    st.session_state.breath_start_time = time.time()
    
    # Rastgele bir motivasyon tÃ¼rÃ¼ seÃ§
    motivation_types = ['quote', 'tip', 'breathing']
    st.session_state.current_motivation_type = random.choice(motivation_types)
    
    if st.session_state.current_motivation_type == 'quote':
        st.session_state.current_motivation_content = random.choice(MOTIVATION_QUOTES)
    elif st.session_state.current_motivation_type == 'tip':
        subject = st.session_state.current_subject
        if subject in MICRO_TIPS:
            st.session_state.current_motivation_content = random.choice(MICRO_TIPS[subject])
        else:
            st.session_state.current_motivation_content = random.choice(MICRO_TIPS['Genel'])
    else:  # breathing
        exercise = random.choice(BREATHING_EXERCISES)
        st.session_state.current_motivation_content = f"""
ğŸ« **{exercise['name']}**

ğŸ“‹ {exercise['instruction']}

âœ¨ **FaydasÄ±:** {exercise['benefit']}
        """
    
    # KullanÄ±m loguna kaydet
    log_entry = {
        'timestamp': datetime.now().isoformat(),
        'subject': st.session_state.current_subject,
        'motivation_type': st.session_state.current_motivation_type,
        'remaining_time_when_used': st.session_state.breathing_paused_time
    }
    st.session_state.breathing_usage_log.append(log_entry)
    
    st.success("ğŸ’¨ Hibrit nefes molasÄ± baÅŸladÄ±! Pomodoro timer duraklatÄ±ldÄ±.")

def complete_breathing_exercise():
    """Nefes egzersizini tamamla ve Pomodoro'ya dÃ¶n"""
    st.session_state.breathing_active = False
    st.session_state.breath_time_remaining = 60
    st.session_state.breath_start_time = None
    
    # Pomodoro'yu kaldÄ±ÄŸÄ± yerden devam ettir
    if st.session_state.pomodoro_active:
        st.session_state.time_remaining = st.session_state.breathing_paused_time
        st.session_state.start_time = time.time()
    
    st.success("ğŸ‰ Hibrit nefes molasÄ± tamamlandÄ±! Pomodoro kaldÄ±ÄŸÄ± yerden devam ediyor.")
    st.balloons()

def show_breathing_exercise():
    """Hibrit nefes egzersizini gÃ¶ster"""
    breath_seconds = int(st.session_state.breath_time_remaining)
    
    st.markdown(f"""
    <div style="
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 20px;
        padding: 30px;
        margin: 20px 0;
        text-align: center;
        color: white;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        animation: pulse 2s infinite;
    ">
        <h2 style="color: white; margin-bottom: 20px;">ğŸŒ¬ï¸ Hibrit Nefes MolasÄ±</h2>
        <div style="font-size: 72px; font-weight: bold; margin: 20px 0;">
            {breath_seconds}s
        </div>
        <div style="
            font-size: 18px; 
            font-style: italic; 
            margin: 20px 0; 
            min-height: 100px;
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            border-left: 4px solid #ffd700;
            white-space: pre-line;
        ">
            {st.session_state.current_motivation_content}
        </div>
        <div style="font-size: 14px; opacity: 0.9; margin-top: 15px;">
            ğŸ§˜â€â™‚ï¸ Nefes molasÄ± aktif â€¢ Timer durduruldu
        </div>
    </div>
    
    <style>
    @keyframes pulse {{
        0% {{ transform: scale(1); }}
        50% {{ transform: scale(1.02); }}
        100% {{ transform: scale(1); }}
    }}
    </style>
    """, unsafe_allow_html=True)

# ===== MODERN VAK ANALIZ FONKSÄ°YONLARI =====

def display_modern_vak_analysis(dominant_style, visual_percent, auditory_percent, kinesthetic_percent):
    """Modern ve detaylÄ± VAK analizi gÃ¶sterir"""
    
    # PaydaÅŸÄ±lan bilgi paragrafÄ±na gÃ¶re detaylÄ± Ã¶zellikler
    vak_detailed_info = {
        "GÃ¶rsel": {
            "icon": "ğŸ‘ï¸",
            "title": "GÃ–RSEL Ã–ÄRENME STÄ°LÄ°",
            "natural_places": [
                "DoÄŸal olarak dÃ¼zenli ve temiz bir Ã§evresi olmasÄ±nÄ± ister",
                "AyrÄ±ntÄ±larÄ± ve renkleri iyi hatÄ±rlar",
                "OkumayÄ±, yazmayÄ± sever",
                "Ä°nsanlarÄ±n yÃ¼zÃ¼nÃ¼ hatÄ±rlar ama isimlerini unutur",
                "Zihinsel (gÃ¶rsel) imgeler yaratmayÄ± sever"
            ],
            "problem_solving": [
                "TalimatlarÄ± okumayÄ± tercih eder",
                "Problemleri listeler",
                "DÃ¼ÅŸÃ¼ncelerini dÃ¼zenlerken grafiksel malzemeler kullanÄ±r",
                "AkÄ±ÅŸ kartlarÄ± ve ÅŸemalarÄ± etkili kullanÄ±r",
                "KaÄŸÄ±t Ã¼zerinde grafiksel Ã§alÄ±ÅŸmalar yapar"
            ],
            "evaluation_needs": [
                "GÃ¶rsel-yazÄ±lÄ± testlerde baÅŸarÄ±lÄ±",
                "AraÅŸtÄ±rma raporlarÄ± hazÄ±rlamayÄ± sever",
                "Grafiksel gÃ¶sterimlerden yararlanÄ±r",
                "YazÄ±lÄ± sÄ±navlarda yÃ¼ksek baÅŸarÄ± gÃ¶sterir"
            ],
            "best_learning": [
                "Not alarak Ã¶ÄŸrenir",
                "Liste yaparak bilgileri organize eder",
                "Bir gÃ¶steriyi izleyerek Ã¶ÄŸrenir",
                "Kitaplar, video filmler ve basÄ±lÄ± materyallerden yararlanÄ±r",
                "GÃ¶rsel destekli iÃ§eriklerle daha iyi anlar"
            ],
            "school_difficulties": [
                "Ne yapÄ±lacaÄŸÄ±nÄ± gÃ¶rmeden hareket etmekte zorlanÄ±r",
                "GÃ¼rÃ¼ltÃ¼lÃ¼ ve hareketli Ã§evrede Ã§alÄ±ÅŸamaz",
                "GÃ¶rsel resim ve malzeme olmadan Ã¶ÄŸretmeni dinleyemez",
                "SÄ±kÄ±cÄ± ve dÃ¼zensiz sÄ±nÄ±fta Ã§alÄ±ÅŸmak istemez",
                "Florasan Ä±ÅŸÄ±ÄŸÄ± altÄ±nda Ã§alÄ±ÅŸmaktan verim alamaz"
            ],
            "general_evaluation": [
                "Ã–zel yaÅŸamlarÄ±nda genellikle dÃ¼zenlidirler",
                "KarÄ±ÅŸÄ±klÄ±k ve daÄŸÄ±nÄ±klÄ±ktan rahatsÄ±z olurlar",
                "Ã‡antalarÄ±, dolaplarÄ± her zaman dÃ¼zenlidir",
                "Harita, poster, ÅŸema, grafik gibi gÃ¶rsel araÃ§lardan kolay etkilenirler",
                "Ã–ÄŸrendikleri konularÄ± gÃ¶zlerinin Ã¶nÃ¼ne getirerek hatÄ±rlamaya Ã§alÄ±ÅŸÄ±rlar"
            ]
        },
        "Ä°ÅŸitsel": {
            "icon": "ğŸ‘‚",
            "title": "Ä°ÅÄ°TSEL Ã–ÄRENME STÄ°LÄ°",
            "natural_places": [
                "DoÄŸaÃ§lama (spontan) konuÅŸur",
                "AyakÃ¼stÃ¼ dÃ¼ÅŸÃ¼nÃ¼r",
                "KarÅŸÄ±laÅŸtÄ±ÄŸÄ± insanlarÄ±n yÃ¼zlerini unutur ama adlarÄ±nÄ± hatÄ±rlar",
                "Kelimelerle ve dille Ã§alÄ±ÅŸmayÄ± sever",
                "Hafif sesli ortamlardan hoÅŸlanÄ±r"
            ],
            "problem_solving": [
                "TartÄ±ÅŸmalardan hoÅŸlanÄ±r",
                "SeÃ§enekler hakkÄ±nda konuÅŸur",
                "Bir durumda ne yapÄ±lacaÄŸÄ±nÄ± o durumu yaÅŸayanlara sorar",
                "Hedefi sÃ¶zle ifade eder",
                "SÃ¶zlÃ¼ tekrarlar yapar"
            ],
            "evaluation_needs": [
                "YazÄ±lÄ±lardan ziyade sÃ¶zlÃ¼lerde baÅŸarÄ±lÄ± olur",
                "Projelerini sÃ¶zlÃ¼ olarak sunar",
                "Ne Ã¶ÄŸrendiÄŸinin birileri tarafÄ±ndan sorulmasÄ±nÄ± ister",
                "Åiir okumaktan, ÅŸarkÄ± sÃ¶ylemekten hoÅŸlanÄ±r"
            ],
            "best_learning": [
                "YÃ¼ksek sesle anlatÄ±m dinleyerek",
                "KÃ¼Ã§Ã¼k ve bÃ¼yÃ¼k grup tartÄ±ÅŸmasÄ± yaparak",
                "Ã‡alÄ±ÅŸma yerinde fon olarak sessiz mÃ¼zik dinleyerek",
                "Sesli kaynak materyallerle",
                "KonularÄ± anlatarak ve tartÄ±ÅŸarak"
            ],
            "school_difficulties": [
                "GÃ¶rsel Ã¶ÄŸrencilerden daha yavaÅŸ okur",
                "Uzun sÃ¼re sessiz okuyamaz",
                "OkuduÄŸu parÃ§ada resimleri umursamaz",
                "SessizleÅŸtirilmiÅŸ ortamda yaÅŸamada sÄ±kÄ±ntÄ± yaÅŸar",
                "Uzun sÃ¼re sessiz kalmakta zorlanÄ±r"
            ],
            "general_evaluation": [
                "KÃ¼Ã§Ã¼k yaÅŸlarda kendi kendilerine konuÅŸurlar",
                "Ses ve mÃ¼ziÄŸe duyarlÄ±dÄ±rlar",
                "Sohbet etmeyi, birileri ile Ã§alÄ±ÅŸmayÄ± severler",
                "Genellikle ahenkli ve gÃ¼zel konuÅŸurlar",
                "Ä°ÅŸittiklerini daha iyi anlarlar ve hatÄ±rlarlar"
            ]
        },
        "Kinestetik": {
            "icon": "âœ‹",
            "title": "KÄ°NESTETÄ°K Ã–ÄRENME STÄ°LÄ°",
            "natural_places": [
                "Ã‡eÅŸitli spor ve danslarla uÄŸraÅŸmayÄ± sever",
                "YarÄ±ÅŸmalardan ve maceradan hoÅŸlanÄ±r",
                "Zorluklara meydan okur",
                "KoÅŸma, sÄ±Ã§rama, atlama, yuvarlanma gibi hareketlerden hoÅŸlanÄ±r",
                "BÃ¼yÃ¼k motor kaslarÄ± kullanmayÄ± gerektiren eylemlerden hoÅŸlanÄ±r"
            ],
            "problem_solving": [
                "Harekete geÃ§er daha sonra da sonuÃ§lara bakarak plan yapar",
                "Problemleri gÃ¼Ã§ kullanarak (fiziksel olarak) Ã§Ã¶zmeye Ã§alÄ±ÅŸÄ±r",
                "Ã–nemli Ã¶lÃ§Ã¼de bedensel Ã§aba gerektiren Ã§Ã¶zÃ¼mler arar",
                "Problemleri bireysel olarak veya Ã§ok kÃ¼Ã§Ã¼k gruplarla Ã§alÄ±ÅŸarak Ã§Ã¶zmeyi tercih eder",
                "Deneme-yanÄ±lma ve keÅŸfetme yoluyla Ã¶ÄŸrenir"
            ],
            "evaluation_needs": [
                "Performansa dayalÄ± ve proje yÃ¶nelimli deÄŸerlendirmelerde baÅŸarÄ±lÄ± olur",
                "Ã–ÄŸrendiÄŸi ÅŸeyi sergileme veya gÃ¶sterme eÄŸilimi vardÄ±r",
                "Bir ÅŸeyi anlatmaktan ziyade nasÄ±l yapÄ±lacaÄŸÄ±nÄ± gÃ¶stermeyi tercih eder",
                "UygulamalÄ± deÄŸerlendirmelerde daha baÅŸarÄ±lÄ±"
            ],
            "best_learning": [
                "CanlandÄ±rma ve taklit yaparak",
                "Gezerek ve performansa dayalÄ± Ã¶ÄŸrenmeyle",
                "KÃ¼Ã§Ã¼k tartÄ±ÅŸma gruplarÄ± ile",
                "Yaparak yaÅŸayarak Ã¶ÄŸrenir",
                "Ellerini kullanabileceÄŸi yÃ¶ntemlerle"
            ],
            "school_difficulties": [
                "OkunaaklÄ± el yazÄ±sÄ±na sahip deÄŸildir",
                "Uzun sÃ¼re oturamaz",
                "Kelimeleri doÄŸru okuma ve kullanmada sÄ±kÄ±ntÄ± yaÅŸar",
                "Duyulan, gÃ¶rÃ¼len ve yapÄ±lan ÅŸeyleri hatÄ±rlamakta zorlanÄ±r",
                "Uzun sÃ¼re herhangi bir eylemi devam ettiremez"
            ],
            "general_evaluation": [
                "OldukÃ§a hareketli olurlar",
                "SÄ±nÄ±fta yerlerinde duramazlar",
                "SÃ¼rekli hareket halindedirler",
                "Dersin anlatÄ±lmasÄ± veya gÃ¶rsel malzemelerle zenginleÅŸtirilmesi beklenildiÄŸi Ã¶lÃ§Ã¼lerde katkÄ± saÄŸlamaz",
                "Mutlaka ellerini kullanabilecekleri, yaparak yaÅŸayarak Ã¶ÄŸrenme yÃ¶ntemlerinin kullanÄ±lmasÄ± gerekir"
            ]
        }
    }
    
    style_info = vak_detailed_info[dominant_style]
    
    st.markdown("---")
    st.markdown(f"## {style_info['icon']} **{style_info['title']}** - BaskÄ±n Stiliniz!")
    
    # Stil daÄŸÄ±lÄ±mÄ± grafik
    col1, col2 = st.columns([2, 1])
    
    with col1:
        import plotly.express as px
        
        vak_data = {
            'Stil': ['GÃ¶rsel', 'Ä°ÅŸitsel', 'Kinestetik'],
            'YÃ¼zde': [visual_percent, auditory_percent, kinesthetic_percent],
            'Renk': ['#FF6B6B', '#4ECDC4', '#45B7D1']
        }
        
        fig = px.pie(
            values=vak_data['YÃ¼zde'], 
            names=vak_data['Stil'],
            title="ğŸ“Š Ã–ÄŸrenme Stili DaÄŸÄ±lÄ±mÄ±niz",
            color_discrete_sequence=['#FF6B6B', '#4ECDC4', '#45B7D1']
        )
        fig.update_traces(textposition='inside', textinfo='percent+label')
        fig.update_layout(
            height=400,
            font=dict(size=14),
            showlegend=True
        )
        safe_plotly_chart(fig, use_container_width=True)
    
    with col2:
        st.markdown("### ğŸ“ˆ Puan DetaylarÄ±")
        styles = [
            ("GÃ¶rsel ğŸ‘ï¸", visual_percent, "#FF6B6B"),
            ("Ä°ÅŸitsel ğŸ‘‚", auditory_percent, "#4ECDC4"),
            ("Kinestetik âœ‹", kinesthetic_percent, "#45B7D1")
        ]
        
        for style_name, percentage, color in styles:
            is_dominant = style_name.split()[0] == dominant_style
            border = "3px solid #gold" if is_dominant else "1px solid #ddd"
            
            st.markdown(f"""
                <div style="
                    border: {border};
                    padding: 10px;
                    margin: 8px 0;
                    border-radius: 8px;
                    background: linear-gradient(90deg, {color}20, transparent);
                    text-align: center;
                ">
                    <strong>{style_name}</strong><br>
                    <span style="font-size: 24px; color: {color};">%{percentage:.1f}</span>
                </div>
            """, unsafe_allow_html=True)
    
    # DetaylÄ± Ã¶zellikler
    st.markdown("### ğŸ” DetaylÄ± Ã–zellik Analizi")
    
    tab1, tab2, tab3, tab4, tab5, tab6 = st.tabs([
        "ğŸŒŸ DoÄŸal Ã–zellikler", 
        "ğŸ”§ Problem Ã‡Ã¶zme", 
        "ğŸ“‰ DeÄŸerlendirme", 
        "ğŸ¯ En Ä°yi Ã–ÄŸrenme", 
        "âš ï¸ Okul ZorluklarÄ±", 
        "ğŸ“„ Genel DeÄŸerlendirme"
    ])
    
    with tab1:
        st.markdown("**DoÄŸal olduÄŸunuz yerler:**")
        for item in style_info['natural_places']:
            st.write(f"â€¢ {item}")
    
    with tab2:
        st.markdown("**Problem Ã§Ã¶zme yollarÄ±nÄ±z:**")
        for item in style_info['problem_solving']:
            st.write(f"â€¢ {item}")
    
    with tab3:
        st.markdown("**DeÄŸerlendirme ve test etme ihtiyacÄ±nÄ±z:**")
        for item in style_info['evaluation_needs']:
            st.write(f"â€¢ {item}")
    
    with tab4:
        st.markdown("**En iyi Ã¶ÄŸrenme yollarÄ±nÄ±z:**")
        for item in style_info['best_learning']:
            st.write(f"â€¢ {item}")
    
    with tab5:
        st.markdown("**Okuldaki gÃ¼Ã§lÃ¼kleriniz:**")
        for item in style_info['school_difficulties']:
            st.write(f"â€¢ {item}")
    
    with tab6:
        st.markdown("**Genel deÄŸerlendirmeniz:**")
        for item in style_info['general_evaluation']:
            st.write(f"â€¢ {item}")
    
    # YKS'ye Ã¶zel stratejiler
    st.markdown("### ğŸ¯ YKS Ä°Ã§in Ã–zel Stratejileriniz")
    
    yks_strategies = {
        "GÃ¶rsel": [
            "ğŸ—ºï¸ **Kavram haritalarÄ±** oluÅŸturun ve konularÄ± gÃ¶rsel olarak baÄŸlayÄ±n",
            "ğŸ¨ **Renkli kalemler** kullanarak notlarÄ±nÄ±zÄ± kategorilendirin",
            "ğŸ“Š **Åemalar ve grafikler** Ã§izerek formÃ¼lleri ve sÃ¼reci gÃ¶rselleÅŸtirin",
            "ğŸ“¹ **GÃ¶rsel destekli videolar** izleyin ve ekran gÃ¶rÃ¼ntÃ¼sÃ¼ alÄ±n",
            "ğŸ“– **GÃ¼zel tasarlanmÄ±ÅŸ kitaplar** ve renkli test kitaplarÄ± tercih edin",
            "ğŸ“ **AkÄ±ÅŸ ÅŸemalarÄ±** ile konularÄ± adÄ±m adÄ±m Ã§izin",
            "ğŸ–¼ï¸ **Poster ve infografikler** hazÄ±rlayarak duvarlarÄ±nÄ±za asÄ±n"
        ],
        "Ä°ÅŸitsel": [
            "ğŸ§ **Podcast ve sesli anlatÄ±m** kaynaklarÄ± bulun ve dinleyin",
            "ğŸ‘¥ **Ã‡alÄ±ÅŸma gruplarÄ±** oluÅŸturun ve konularÄ± tartÄ±ÅŸÄ±n",
            "ğŸ—£ï¸ **KonularÄ± sesli anlatÄ±n** (kendinize ya da arkadaÅŸlarÄ±nÄ±za)",
            "ğŸµ **Hafif klasik mÃ¼zik** eÅŸliÄŸinde Ã§alÄ±ÅŸÄ±n",
            "ğŸ“ **Online grup Ã§alÄ±ÅŸmalarÄ±** ve Zoom seansÄ± organize edin",
            "ğŸ¤ **Sesli notlar** kayÄ±t edin ve tekrar dinleyin",
            "ğŸ“» **Radyo programlarÄ±** ve eÄŸitim yayÄ±nlarÄ± takip edin"
        ],
        "Kinestetik": [
            "âœï¸ **Ã‡ok soru Ã§Ã¶zÃ¼mÃ¼** yapÄ±n (mutlaka elle yazarak)",
            "ğŸš¶ **Ayakta Ã§alÄ±ÅŸma** dÃ¶nemleri ekleyin (masa baÅŸÄ±nda)",
            "ğŸ”§ **Laboratuvar ve pratik uygulamalar** yapÄ±n",
            "ğŸ“ **El yazÄ±sÄ± notlar** alÄ±n, tablet yerine kaÄŸÄ±t kullanÄ±n",
            "âš¡ **25 dk Ã§alÄ±ÅŸ, 5 dk hareket** sistemi uygulayÄ±n",
            "ğŸ¯ **Interaktif simÃ¼lasyonlar** ve oyunlar kullanÄ±n",
            "ğŸƒ **YÃ¼rÃ¼yÃ¼ÅŸ yaparken** ses kayÄ±tlarÄ± dinleyin"
        ]
    }
    
    strategies = yks_strategies[dominant_style]
    
    for i, strategy in enumerate(strategies, 1):
        st.markdown(f"{i}. {strategy}")

def display_teacher_guide_section(dominant_style):
    """EÄŸitimciler iÃ§in rehber bÃ¶lÃ¼mÃ¼"""
    
    st.markdown("---")
    st.markdown("ğŸ“ ## EÄŸitimci Rehberi")
    
    teacher_guide = {
        "GÃ¶rsel": {
            "recommended_methods": [
                "Tahtada renkli kalemler kullanarak anlatÄ±m yapÄ±n",
                "Kavram haritalarÄ± ve akÄ±ÅŸ ÅŸemalarÄ± hazÄ±rlayÄ±n",
                "GÃ¶rsel destekli sunumlar ve videolar kullanÄ±n",
                "Grafik, tablo ve ÅŸekiller Ã§izerek aÃ§Ä±klayÄ±n",
                "SÄ±nÄ±fÄ± dÃ¼zenli ve gÃ¶rsel olarak zengin tutun"
            ],
            "classroom_setup": [
                "Parlak ve iyi aydÄ±nlatÄ±lmÄ±ÅŸ sÄ±nÄ±f ortamÄ±",
                "Duvar posterler ve eÄŸitici gÃ¶rseller",
                "DÃ¼zenli sÄ±ra dÃ¼zenlemesi",
                "Beyaz tahta ve projeksiyon kullanÄ±mÄ±",
                "Renkli Ã¶ÄŸretim materyalleri"
            ],
            "avoid": [
                "Sadece sÃ¶zlÃ¼ anlatÄ±m yapmayÄ± uzun sÃ¼re sÃ¼rdÃ¼rmek",
                "GÃ¼rÃ¼ltÃ¼lÃ¼ ve karÄ±ÅŸÄ±k sÄ±nÄ±f ortamÄ±",
                "GÃ¶rsel destek olmadan sÄ±navlar yapmak"
            ]
        },
        "Ä°ÅŸitsel": {
            "recommended_methods": [
                "Sesli anlatÄ±m ve hikaye anlatÄ±mÄ± kullanÄ±n",
                "Grup tartÄ±ÅŸmalarÄ± ve beyin fÄ±rtÄ±nasÄ± organize edin",
                "MÃ¼zik ve ses efektleri ile dersi zenginleÅŸtirin",
                "SÄ±k sÄ±k soru-cevap seÃ§imi kullanÄ±n",
                "Sesli okuma ve tekrar seÃ§imi yapÄ±n"
            ],
            "classroom_setup": [
                "Akustik kalitesi iyi sÄ±nÄ±f",
                "Grup Ã§alÄ±ÅŸmasÄ±na uygun oturma dÃ¼zenlemesi",
                "Ses sistemi ve mikrofonlar",
                "MÃ¼zik Ã§alar ve ses kaydÄ± imkanlarÄ±",
                "TartÄ±ÅŸmaya uygun havalandÄ±rma"
            ],
            "avoid": [
                "Uzun sÃ¼re sessizlik dayatmak",
                "Sadece gÃ¶rsel materyallerle ders iÅŸlemek",
                "Bireysel Ã§alÄ±ÅŸmayÄ± Ã§ok uzun sÃ¼rdÃ¼rmek"
            ]
        },
        "Kinestetik": {
            "recommended_methods": [
                "UygulamalÄ± etkinlikler ve deneyler organize edin",
                "Hareket gerektiren oyunlar ve simÃ¼lasyonlar kullanÄ±n",
                "SÄ±k ara verme ve fiziksel aktivite ekleyin",
                "Elle tutulur materyaller ve modellerle Ã§alÄ±ÅŸÄ±n",
                "Proje tabanlÄ± Ã¶ÄŸrenme yÃ¶ntemini tercih edin"
            ],
            "classroom_setup": [
                "Hareket edebilecek geniÅŸ alan",
                "Grup Ã§alÄ±ÅŸmasÄ±na uygun masa dÃ¼zenlemesi",
                "Deneysel malzemeler ve araÃ§lar",
                "Ayakta Ã§alÄ±ÅŸma imkanÄ±",
                "Esnek oturma dÃ¼zenleri"
            ],
            "avoid": [
                "Uzun sÃ¼re hareketsiz oturmaya zorlama",
                "Sadece teorik anlatÄ±m yapma",
                "Fiziksel aktiviteyi kÄ±sÄ±tlama"
            ]
        }
    }
    
    guide = teacher_guide[dominant_style]
    
    col1, col2, col3 = st.columns(3)
    
    with col1:
        st.markdown("### âœ… **Tavsiye Edilen YÃ¶ntemler**")
        for method in guide['recommended_methods']:
            st.write(f"â€¢ {method}")
    
    with col2:
        st.markdown("### ğŸ¢ **SÄ±nÄ±f DÃ¼zenlemesi**")
        for setup in guide['classroom_setup']:
            st.write(f"â€¢ {setup}")
    
    with col3:
        st.markdown("### âŒ **KaÃ§Ä±nÄ±lmasÄ± Gerekenler**")
        for avoid in guide['avoid']:
            st.write(f"â€¢ {avoid}")

def display_advanced_study_techniques(dominant_style):
    """GeliÅŸmiÅŸ Ã§alÄ±ÅŸma teknikleri"""
    
    st.markdown("---")
    st.markdown("âš™ï¸ ## GeliÅŸmiÅŸ Ã‡alÄ±ÅŸma Teknikleri")
    
    advanced_techniques = {
        "GÃ¶rsel": {
            "memory_techniques": [
                "ğŸ—ºï¸ **Zihin HaritasÄ±**: KonularÄ± renkli dallar halinde Ã§izin",
                "ğŸ¨ **GÃ¶rsel HafÄ±za Teknikleri**: Bilgileri resim ve sembollerle iliÅŸkilendirin",
                "ğŸ­ **Hikaye YÃ¶ntemi**: Bilgileri gÃ¶rsel hikayeler halinde organize edin",
                "ğŸ“‹ **Zaman Ã‡izgisi**: Tarih ve sÄ±ralÄ± konularÄ± Ã§izgisel gÃ¶rsele dÃ¶nÃ¼ÅŸtÃ¼rÃ¼n"
            ],
            "study_tools": [
                "Canva, Miro, MindMeister gibi gÃ¶rsel tasarÄ±m araÃ§larÄ±",
                "iPad ve Apple Pencil ile dijital Ã§izim",
                "Renkli kaÄŸÄ±tlar ve yapÄ±ÅŸkan notlar",
                "GÃ¶rsel plan bÃ§leri ve infografikler"
            ],
            "exam_prep": [
                "Soru tiplerine gÃ¶re renkli kodlama sistemi",
                "GÃ¶rsel formÃ¼l kartÄ± hazÄ±rlama",
                "Konu baÅŸlÄ±klarÄ±nÄ± akÄ±ÅŸ ÅŸemasÄ± olarak dÃ¼zenleme"
            ]
        },
        "Ä°ÅŸitsel": {
            "memory_techniques": [
                "ğŸµ **MÃ¼ziksel HafÄ±za**: Bilgileri ÅŸarkÄ± ya da ritim halinde Ã¶ÄŸrenin",
                "ğŸ—£ï¸ **Sesli Tekrar**: KonularÄ± kendi sesinizle kaydedin ve dinleyin",
                "ğŸ‘¥ **Sosyal Ã–ÄŸrenme**: ArkadaÅŸlarÄ±nÄ±zla tartÄ±ÅŸarak Ã¶ÄŸrenin",
                "ğŸ¤ **AnlatÄ±m YÃ¶ntemi**: KonularÄ± baÅŸkalarÄ±na anlatarak pekiÅŸtirin"
            ],
            "study_tools": [
                "Otter.ai, Rev gibi ses kayÄ±t ve tranÃ¼kripsiyon araÃ§larÄ±",
                "Spotify, Apple Music eÄŸitim listleri",
                "Discord, Zoom grup Ã§alÄ±ÅŸma platformlarÄ±",
                "Podcast uygulamalarÄ± ve sesli kitaplar"
            ],
            "exam_prep": [
                "Soru Ã§Ã¶zÃ¼m adÄ±mlarÄ±nÄ± sesli aÃ§Ä±klama",
                "Grup halinde mock sÄ±nav yapÄ±mÄ±",
                "FormÃ¼lleri ritimli ÅŸekilde ezberleme"
            ]
        },
        "Kinestetik": {
            "memory_techniques": [
                "âœ‹ **Hareket ile HafÄ±za**: El hareketleriyle formÃ¼lleri iliÅŸkilendirin",
                "ğŸš¶ **YÃ¼rÃ¼yÃ¼ÅŸ HafÄ±zasÄ±**: YÃ¼rÃ¼yerek seslice tekrar yapÄ±n",
                "ğŸ¯ **Fiziksel Model**: KonularÄ± 3D modellerle gÃ¶rselleÅŸtirin",
                "âœï¸ **Yazma HafÄ±zasÄ±**: Elle yazarak kas hafÄ±zasÄ±nÄ± geliÅŸtirin"
            ],
            "study_tools": [
                "Pomodoro Timer uygulamalarÄ±",
                "Standing desk ve egzersiz toplarÄ±",
                "Fidget araÃ§larÄ± ve stres toplarÄ±",
                "Ä°nteraktif simÃ¼lasyon yazÄ±Ã§larÄ±"
            ],
            "exam_prep": [
                "El yazÄ±sÄ± ile Ã§ok soru Ã§Ã¶zme pratiÄŸi",
                "Fiziksel hareket ile mental ara verme",
                "Mock sÄ±nav sÄ±rasÄ±nda hareket gÃ¼lÃ¼mseme"
            ]
        }
    }
    
    techniques = advanced_techniques[dominant_style]
    
    tab1, tab2, tab3 = st.tabs(["ğŸ§  HafÄ±za Teknikleri", "ğŸ› ï¸ Ã‡alÄ±ÅŸma AraÃ§larÄ±", "ğŸ“ˆ SÄ±nav HazÄ±rlÄ±ÄŸÄ±"])
    
    with tab1:
        st.markdown("**HafÄ±za ve Ã–ÄŸrenme Teknikleri:**")
        for technique in techniques['memory_techniques']:
            st.write(f"â€¢ {technique}")
    
    with tab2:
        st.markdown("**Tavsiye Edilen Ã‡alÄ±ÅŸma AraÃ§larÄ±:**")
        for tool in techniques['study_tools']:
            st.write(f"â€¢ {tool}")
    
    with tab3:
        st.markdown("**SÄ±nav HazÄ±rlÄ±k Stratejileri:**")
        for prep in techniques['exam_prep']:
            st.write(f"â€¢ {prep}")
    
    # Bonus motivasyon bÃ¶lÃ¼mÃ¼
    st.markdown("### ğŸ† Motivasyon Ä°puÃ§larÄ±")
    motivation_tips = {
        "GÃ¶rsel": "GÃ¶rsel hedefler koyun! YKS hedef Ã¼niversitenizin fotoÄŸrafÄ±nÄ± Ã§alÄ±ÅŸma alanÄ±nÄ±za asÄ±n. Ä°lerleme grafikleri hazÄ±rlayÄ±n.",
        "Ä°ÅŸitsel": "Motivasyon mÃ¼ziÄŸi dinleyin! BaÅŸarÄ± hikayeleri podcast'lerini takip edin. Kendinize gÃ¼nÃ¼n sonunda ses kaydÄ± ile teÅŸekkÃ¼r mesajÄ± bÄ±rakÄ±n.",
        "Kinestetik": "Hareket halinde hedef belirleyin! Her baÅŸarÄ± iÃ§in kendinizi fiziksel bir aktivite ile Ã¶dÃ¼llendirin. Ä°lerleme iÃ§in fiziksel bir baÅŸarÄ± panosu hazÄ±rlayÄ±n."
    }
    
    st.info(motivation_tips[dominant_style])

# ===== PSÄ°KOLOJÄ°M SAYFA FONKSÄ°YONU =====

def run_psychology_page():
    """GENEL PSÄ°KOLOJÄ°K ANALÄ°Z SÄ°STEMÄ° - Kendini TanÄ± & DoÄŸru Ã‡alÄ±ÅŸ"""
    
    # Modern CSS stilleri
    st.markdown("""
    <style>
    /* Ana sistem baÅŸlÄ±ÄŸÄ± */
    .main-header {
        text-align: center;
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        padding: 2rem;
        border-radius: 15px;
        margin-bottom: 2rem;
        box-shadow: 0 8px 25px rgba(0,0,0,0.12);
    }
    
    .main-header h1 {
        margin: 0 0 0.5rem 0;
        font-size: 2.2rem;
        font-weight: 600;
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .main-header p {
        margin: 0;
        font-size: 1.1rem;
        opacity: 0.9;
    }
    
    /* Psikoloji sayfasÄ± iÃ§in Ã¶zel header stili */
    .psychology-header {
        position: relative;
        min-height: 200px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
    
    .psychology-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(0,0,0,0.6), rgba(0,0,0,0.3));
        border-radius: 15px;
        z-index: 1;
    }
    
    .psychology-header h1,
    .psychology-header p {
        position: relative;
        z-index: 2;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }
    
    .section-title {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.2rem;
        border-radius: 12px;
        margin: 2rem 0 1.5rem 0;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .section-title h2 {
        margin: 0;
        font-size: 1.6rem;
        font-weight: 600;
    }
    
    /* Modern Test KartlarÄ± - Sade ve Okunabilir */
    .analysis-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        border: 1px solid #e0e6ed;
        transition: all 0.3s ease;
        margin-bottom: 15px;
    }
    
    /* Test KartlarÄ± iÃ§in Renkli Gradient'ler */
    .analysis-card-vak {
        background: linear-gradient(135deg, #8B5CF6, #A855F7, #C084FC);
        border: 1px solid rgba(139, 92, 246, 0.2);
    }
    
    .analysis-card-cognitive {
        background: linear-gradient(135deg, #3B82F6, #1D4ED8, #2563EB);
        border: 1px solid rgba(59, 130, 246, 0.2);
    }
    
    .analysis-card-motivation {
        background: linear-gradient(135deg, #F59E0B, #D97706, #EAB308);
        border: 1px solid rgba(245, 158, 11, 0.2);
    }
    
    .analysis-card-time {
        background: linear-gradient(135deg, #10B981, #059669, #16A34A);
        border: 1px solid rgba(16, 185, 129, 0.2);
    }
    
    /* Renkli kartlar iÃ§in yazÄ± rengini beyaza Ã§evirelim */
    .analysis-card-vak h3,
    .analysis-card-cognitive h3,
    .analysis-card-motivation h3,
    .analysis-card-time h3 {
        color: white;
        text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    
    .analysis-card-vak p,
    .analysis-card-cognitive p,
    .analysis-card-motivation p,
    .analysis-card-time p {
        color: rgba(255,255,255,0.9);
        text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    
    .analysis-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        border-color: #667eea;
    }
    
    .analysis-card-vak:hover,
    .analysis-card-cognitive:hover,
    .analysis-card-motivation:hover,
    .analysis-card-time:hover {
        transform: translateY(-4px) scale(1.02);
        box-shadow: 0 12px 30px rgba(0,0,0,0.15);
    }
    
    .analysis-card h3 {
        color: #2d3748;
        margin-bottom: 12px;
        font-size: 1.2rem;
        font-weight: 600;
    }
    
    .analysis-card p {
        color: #4a5568;
        margin-bottom: 15px;
        font-size: 0.95rem;
        line-height: 1.5;
    }
    
    .status-badge {
        display: inline-block;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        margin-bottom: 15px;
    }
    
    .status-completed {
        background: #e6fffa;
        color: #234e52;
        border: 1px solid #81e6d9;
    }
    
    .status-pending {
        background: #fffbeb;
        color: #92400e;
        border: 1px solid #fbd38d;
    }
    
    /* Genel profil analizi - Daha sade */
    .comprehensive-profile {
        background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
        color: #2d3748;
        padding: 2rem;
        border-radius: 15px;
        margin: 2rem 0;
        box-shadow: 0 8px 25px rgba(0,0,0,0.08);
        border: 1px solid #e2e8f0;
    }
    
    .comprehensive-profile h2 {
        color: #2d3748;
        margin-bottom: 0.5rem;
    }
    
    .comprehensive-profile p {
        color: #4a5568;
    }
    
    .profile-chart {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin: 20px 0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        border: 1px solid #e2e8f0;
    }
    
    /* Analiz section */
    .analysis-section {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin: 20px 0;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        border-left: 4px solid #667eea;
    }
    
    .analysis-section h3 {
        color: #2d3748;
        margin: 0;
        font-size: 1.4rem;
        font-weight: 600;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .main-header {
            padding: 1.5rem;
        }
        .section-title {
            padding: 1rem;
        }
        .analysis-card {
            padding: 15px;
        }
    }
    </style>
    """, unsafe_allow_html=True)
    
    # KullanÄ±cÄ± kontrolÃ¼
    username = st.session_state.get('current_user', None)
    if not username:
        st.warning("âš ï¸ Bu sayfaya eriÅŸim iÃ§in Ã¶nce giriÅŸ yapmanÄ±z gerekir.")
        st.info("ğŸ‘ˆ LÃ¼tfen sol menÃ¼den 'Ana Sayfa' bÃ¶lÃ¼mÃ¼nde giriÅŸ yapÄ±n.")
        return
    
    users_data = load_users_from_firebase()
    user_data = users_data.get(username, {})
    
    # Ana baÅŸlÄ±k - Hedef bÃ¶lÃ¼me gÃ¶re dinamik arka plan
    target_department = user_data.get('target_department', 'VarsayÄ±lan')
    bg_style = BACKGROUND_STYLES.get(target_department, BACKGROUND_STYLES["VarsayÄ±lan"])
    
    st.markdown(f'''
    <div class="main-header psychology-header" style="background-image: linear-gradient(135deg, rgba(0,0,0,0.6), rgba(0,0,0,0.4)), {bg_style['gradient']}; background-size: cover; background-position: center; background-attachment: fixed;">
        <h1>ğŸ§­ GENEL PSÄ°KOLOJÄ°K ANALÄ°Z SÄ°STEMÄ°</h1>
        <p>"Kendini TanÄ± & DoÄŸru Ã‡alÄ±ÅŸ" Sistemi</p>
        <p style="font-size: 0.9rem; opacity: 0.8;">ğŸ¯ Hedef: {target_department} {bg_style["icon"]}</p>
    </div>
    ''', unsafe_allow_html=True)
    
    # Test yapÄ±landÄ±rmalarÄ±
    test_configs = [
        {
            'id': 'vak',
            'title': 'ğŸ“š VAK Ã–ÄŸrenme Stilleri Testi',
            'icon': 'ğŸ“š',
            'description': 'GÃ¶rsel, Ä°ÅŸitsel ve Kinestetik Ã¶ÄŸrenme tercihlerinizi analiz eder.',
            'data_key': 'vak_test_results'
        },
        {
            'id': 'cognitive',
            'title': 'ğŸ§  BiliÅŸsel Profil Testi',
            'icon': 'ğŸ§ ',
            'description': 'Analitik dÃ¼ÅŸÃ¼nce gÃ¼cÃ¼nÃ¼z ve problem Ã§Ã¶zme yaklaÅŸÄ±mÄ±nÄ±zÄ± deÄŸerlendirir.',
            'data_key': 'cognitive_test_results'
        },
        {
            'id': 'motivation',
            'title': 'âš¡ Motivasyon & Duygusal Denge Testi',
            'icon': 'âš¡',
            'description': 'Ä°Ã§sel/dÄ±ÅŸsal motivasyon dÃ¼zeyiniz ve duygusal dengenizi analiz eder.',
            'data_key': 'motivation_test_results'
        },
        {
            'id': 'time',
            'title': 'â° Zaman YÃ¶netimi Testi',
            'icon': 'â°',
            'description': 'Planlama becerileriniz, erteleme eÄŸiliminiz ve odak kontrolÃ¼nÃ¼zÃ¼ deÄŸerlendirir.',
            'data_key': 'time_test_results'
        }
    ]
    
    # 1. BÃ–LÃœM: GENEL PSÄ°KOLOJÄ°K TAHMÄ°NÄ° ANALÄ°ZÄ°M
    st.markdown('''
    <div class="section-title">
        <h2>ğŸ” Genel Psikolojik Tahmini Analizim</h2>
    </div>
    ''', unsafe_allow_html=True)
    
    # Test kartlarÄ±nÄ± 2x2 grid ile gÃ¶ster
    cols = st.columns(2)
    completed_tests = []
    
    for i, test in enumerate(test_configs):
        is_completed = bool(user_data.get(test['data_key']))
        if is_completed:
            completed_tests.append(test['id'])
        
        col_index = i % 2
        with cols[col_index]:
            status_class = "status-completed" if is_completed else "status-pending"
            status_text = "âœ… TamamlandÄ±" if is_completed else "â³ HenÃ¼z YapÄ±lmadÄ±"
            
            st.markdown(f'''
            <div class="analysis-card analysis-card-{test['id']}">
                <h3>{test['icon']} {test['title']}</h3>
                <p>{test['description']}</p>
                <div class="status-badge {status_class}">{status_text}</div>
            </div>
            ''', unsafe_allow_html=True)
            
            # Analiz sonucunu gÃ¶rÃ¼ntÃ¼le butonu
            if is_completed:
                if st.button(f"ğŸ“Š Analizini GÃ¶r", key=f"view_{test['id']}", use_container_width=True):
                    st.session_state[f'show_{test["id"]}_analysis'] = True
                    st.rerun()
            else:
                st.info("Bu test henÃ¼z tamamlanmamÄ±ÅŸ.")
            
            # GÃ¼ncelle/Tekrarla butonu
            if st.button(f"ğŸ”„ Testimi GÃ¼ncelle/Tekrarla", key=f"update_{test['id']}", use_container_width=True):
                # Teste yÃ¶nlendir
                if test['id'] == 'vak':
                    st.session_state.page = "learning_styles_test"
                elif test['id'] == 'cognitive':
                    st.session_state.page = "cognitive_profile_test"
                elif test['id'] == 'motivation':
                    st.session_state.page = "motivation_emotional_test"
                elif test['id'] == 'time':
                    st.session_state.page = "time_management_test"
                st.rerun()
    
    # Test analizlerini gÃ¶ster
    for test in test_configs:
        if test['id'] in completed_tests and st.session_state.get(f'show_{test["id"]}_analysis', False):
            st.markdown("---")
            
            # Kapat butonu
            if st.button("âŒ Analizi Kapat", key=f"close_{test['id']}"):
                st.session_state[f'show_{test["id"]}_analysis'] = False
                st.rerun()
            
            display_individual_test_analysis(test, user_data)
    
    # 2. BÃ–LÃœM: GENEL TAHMÄ°NÄ° PSÄ°KOLOJÄ°K PROFÄ°LÄ°M
    if len(completed_tests) >= 2:
        st.markdown("---")
        st.markdown('''
        <div class="section-title">
            <h2>ğŸ¯ Genel Tahmini Psikolojik Profilim</h2>
        </div>
        ''', unsafe_allow_html=True)
        
        display_comprehensive_psychological_profile(completed_tests, user_data)
    else:
        st.markdown("---")
        st.info("ğŸ¯ **Genel psikolojik profilinizi gÃ¶rebilmek iÃ§in en az 2 test tamamlayÄ±n.** Bu sayede size Ã¶zel, detaylÄ± Ã¶neriler sunabiliriz!")
    
    # Test sonucu yoksa bilgilendirme
    if not completed_tests:
        st.markdown("---")
        st.info("ğŸ¯ **HenÃ¼z hiÃ§ test yapmadÄ±nÄ±z.** KiÅŸiselleÅŸtirilmiÅŸ Ã¶neriler alabilmek iÃ§in yukarÄ±daki testlerden birini tamamlamaya baÅŸlayabilirsiniz!")

def display_comprehensive_psychological_profile(completed_tests, user_data):
    """TÃ¼m testlerden genel psikolojik profil Ã§Ä±karÄ±mÄ± - Ã–rneÄŸe gÃ¶re yeniden yazÄ±ldÄ±"""
    
    st.markdown('''
    <div class="comprehensive-profile">
        <h2>ğŸ§­ GENEL PSÄ°KOLOJÄ°K PROFÄ°L ANALÄ°ZÄ°N</h2>
        <p><strong>Ã–ÄŸrenci:</strong> "Senin Beyin Haritan"</p>
        <p><strong>Kaynak:</strong> Ã–ÄŸrenme Stilleri + BiliÅŸsel Profil + Motivasyon + Zaman YÃ¶netimi Testleri</p>
    </div>
    ''', unsafe_allow_html=True)
    
    # Test sonuÃ§larÄ±nÄ± topla
    profile_data = {}
    
    # VAK Test sonuÃ§larÄ±
    if 'vak' in completed_tests:
        vak_scores = user_data.get('learning_style_scores', '')
        vak_style = user_data.get('learning_style', '')
        if vak_scores and vak_style:
            try:
                vak_data = json.loads(vak_scores.replace("'", '"'))
                vak_data['dominant_style'] = vak_style
                profile_data['vak'] = vak_data
            except:
                pass
    
    # BiliÅŸsel Test sonuÃ§larÄ±
    if 'cognitive' in completed_tests:
        cognitive_scores = user_data.get('cognitive_test_scores', '')
        if cognitive_scores:
            try:
                raw_cognitive = json.loads(cognitive_scores.replace("'", '"'))
                
                # ADAPTIF VERÄ° Ä°ÅLEME - herhangi bir formattaki veriyi dÃ¼zenli hale getir
                analytic_score = 0
                synthetic_score = 0
                reflective_score = 0
                
                # TÃ¼m anahtarlarÄ± kontrol et ve kategorilere ayÄ±r
                for key, value in raw_cognitive.items():
                    key_lower = key.lower()
                    
                    # Analitik dÃ¼ÅŸÃ¼nme
                    if any(word in key_lower for word in ['analytic', 'analytical', 'analyze']):
                        analytic_score += float(value)
                    
                    # Sintetik/BÃ¼tÃ¼ncÃ¼l dÃ¼ÅŸÃ¼nme  
                    elif any(word in key_lower for word in ['synthetic', 'synthesis', 'creative', 'visual', 'experiential', 'holistic']):
                        synthetic_score += float(value)
                    
                    # Reflektif dÃ¼ÅŸÃ¼nme
                    elif any(word in key_lower for word in ['reflective', 'reflection', 'auditory', 'listening']):
                        reflective_score += float(value)
                    
                    # EÄŸer thinking ile bitiyorsa direkt kullan
                    elif 'thinking' in key_lower:
                        if 'analytic' in key_lower:
                            analytic_score = float(value)
                        elif 'synthetic' in key_lower:
                            synthetic_score = float(value)
                        elif 'reflective' in key_lower:
                            reflective_score = float(value)
                
                # EÄŸer hiÃ§ puan bulunamadÄ±ysa default deÄŸerler
                if analytic_score == 0 and synthetic_score == 0 and reflective_score == 0:
                    analytic_score = 3.5
                    synthetic_score = 3.2
                    reflective_score = 3.8
                
                # Son format
                cognitive_data = {
                    'analytic_thinking': analytic_score,
                    'synthetic_thinking': synthetic_score,
                    'reflective_thinking': reflective_score
                }
                    
                profile_data['cognitive'] = cognitive_data
            except:
                pass
    
    # Motivasyon Test sonuÃ§larÄ±
    if 'motivation' in completed_tests:
        motivation_scores = user_data.get('motivation_test_scores', '')
        if motivation_scores:
            try:
                raw_motivation = json.loads(motivation_scores.replace("'", '"'))
                
                # ADAPTIF VERÄ° Ä°ÅLEME - herhangi bir formattaki veriyi dÃ¼zenli hale getir
                internal_score = 0
                external_score = 0
                anxiety_score = 0
                resilience_score = 0
                
                # TÃ¼m anahtarlarÄ± kontrol et ve kategorilere ayÄ±r
                for key, value in raw_motivation.items():
                    key_lower = key.lower()
                    
                    # Ä°Ã§sel motivasyon
                    if any(word in key_lower for word in ['internal', 'intrinsic', 'inner', 'motivation_internal']):
                        internal_score += float(value)
                    
                    # DÄ±ÅŸsal motivasyon  
                    elif any(word in key_lower for word in ['external', 'extrinsic', 'outer', 'motivation_external']):
                        external_score += float(value)
                    
                    # SÄ±nav kaygÄ±sÄ±
                    elif any(word in key_lower for word in ['anxiety', 'worry', 'stress', 'exam_anxiety', 'test_anxiety']):
                        anxiety_score += float(value)
                    
                    # Duygusal dayanÄ±klÄ±lÄ±k
                    elif any(word in key_lower for word in ['resilience', 'emotional', 'strength', 'durability']):
                        resilience_score += float(value)
                
                # EÄŸer hiÃ§ puan bulunamadÄ±ysa default deÄŸerler
                if internal_score == 0 and external_score == 0 and anxiety_score == 0 and resilience_score == 0:
                    internal_score = 3.8
                    external_score = 3.2
                    anxiety_score = 2.5
                    resilience_score = 3.9
                
                # Son format
                motivation_data = {
                    'internal_motivation': internal_score,
                    'external_motivation': external_score,
                    'test_anxiety': anxiety_score,
                    'emotional_resilience': resilience_score
                }
                
                profile_data['motivation'] = motivation_data
            except:
                pass
    
    # Zaman YÃ¶netimi Test sonuÃ§larÄ±
    if 'time' in completed_tests:
        time_scores = user_data.get('time_test_scores', '')
        if time_scores:
            try:
                raw_time = json.loads(time_scores.replace("'", '"'))
                
                # ADAPTIF VERÄ° Ä°ÅLEME - herhangi bir formattaki veriyi dÃ¼zenli hale getir
                planning_score = 0
                procrastination_score = 0
                focus_score = 0
                time_score = 0
                priority_score = 0
                discipline_score = 0
                awareness_score = 0
                
                # TÃ¼m anahtarlarÄ± kontrol et ve kategorilere ayÄ±r
                for key, value in raw_time.items():
                    key_lower = key.lower()
                    
                    # Planlama
                    if any(word in key_lower for word in ['planning', 'plan', 'organize', 'structure']):
                        planning_score += float(value)
                    
                    # Erteleme  
                    elif any(word in key_lower for word in ['procrastination', 'delay', 'postpone', 'erteleme']):
                        procrastination_score += float(value)
                    
                    # Odak kontrolÃ¼
                    elif any(word in key_lower for word in ['focus', 'concentrate', 'attention', 'odak']):
                        focus_score += float(value)
                    
                    # Zaman bilinci
                    elif any(word in key_lower for word in ['time_awareness', 'time', 'temporal', 'zaman']):
                        time_score += float(value)
                    
                    # Ã–ncelik yÃ¶netimi
                    elif any(word in key_lower for word in ['priority', 'prioritization', 'Ã¶ncelik']):
                        priority_score += float(value)
                    
                    # Disiplin
                    elif any(word in key_lower for word in ['discipline', 'disiplin', 'self_control', 'control']):
                        discipline_score += float(value)
                    
                    # Ã–z-farkÄ±ndalÄ±k
                    elif any(word in key_lower for word in ['self_awareness', 'awareness', 'farkÄ±ndalÄ±k', 'conscious']):
                        awareness_score += float(value)
                
                # EÄŸer hiÃ§ puan bulunamadÄ±ysa default deÄŸerler
                if all(score == 0 for score in [planning_score, procrastination_score, focus_score, time_score, priority_score]):
                    planning_score = 3.4
                    procrastination_score = 2.8
                    focus_score = 3.7
                    time_score = 3.1
                    priority_score = 3.5
                
                # Son format
                time_data = {
                    'planning': planning_score,
                    'procrastination': procrastination_score,
                    'focus_control': focus_score,
                    'time_awareness': time_score,
                    'priority_management': priority_score
                }
                
                # Ek kategoriler varsa ekle
                if discipline_score > 0:
                    time_data['discipline'] = discipline_score
                if awareness_score > 0:
                    time_data['self_awareness'] = awareness_score
                
                profile_data['time'] = time_data
            except:
                pass
    
    # Debug bilgisi
    if len(profile_data) == 0:
        st.warning("âš ï¸ Test sonuÃ§larÄ± yÃ¼klenirken bir sorun oluÅŸtu. LÃ¼tfen testleri yeniden yapÄ±n.")
        return
    
    # DETAYLI PSIKOLOJIK PROFÄ°L ANALÄ°ZÄ° - Ã–rneÄŸe gÃ¶re hazÄ±rlandÄ±
    
    # 1. BÄ°LÄ°ÅSEL PROFÄ°L
    if 'cognitive' in profile_data:
        st.markdown("---")
        st.markdown("## ğŸ§  1. BiliÅŸsel Profilin")
        
        cognitive = profile_data['cognitive']
        # En yÃ¼ksek biliÅŸsel Ã¶zelliÄŸi bul
        max_cognitive = max(cognitive.items(), key=lambda x: x[1])
        cognitive_style_map = {
            'analytic_thinking': 'Analitik',
            'synthetic_thinking': 'BÃ¼tÃ¼ncÃ¼l', 
            'reflective_thinking': 'Reflektif'
        }
        dominant_cognitive = cognitive_style_map.get(max_cognitive[0], 'Karma')
        
        # Ä°kincil stil
        sorted_cognitive = sorted(cognitive.items(), key=lambda x: x[1], reverse=True)
        secondary_cognitive = cognitive_style_map.get(sorted_cognitive[1][0], '')
        
        st.markdown(f"""
        **SonuÃ§ eÄŸilimi:** {dominant_cognitive} â€“ {secondary_cognitive}
        
        Sen bilgiyi sistematik dÃ¼ÅŸÃ¼nerek iÅŸleyen, neden-sonuÃ§ iliÅŸkilerini Ã§Ã¶zÃ¼mlemeyi seven bir yapÄ±ya sahip olabilirsin.
        Bir konuyu anlamadan ezberlemeyi sevmiyor, Ã¶nce "neden" sorusuna cevap bulmayÄ± tercih ediyor olabilirsin.
        """)
        
        st.markdown("### ğŸ’¡ Sana uygun Ã§alÄ±ÅŸma stratejileri:")
        
        strategies = []
        if max_cognitive[0] == 'analytic_thinking':
            strategies.extend([
                "â€¢ **Feynman TekniÄŸi:** Bir konuyu sanki bir arkadaÅŸÄ±na anlatÄ±r gibi basitleÅŸtirerek anlat â€” anlamadÄ±ÄŸÄ±n yer eksik bilgin olur.",
                "â€¢ **Kavram AÄŸlarÄ±:** Bilgiler arasÄ±ndaki baÄŸlantÄ±larÄ± gÃ¶rselleÅŸtir.",
                "â€¢ **Soru Ã¼retme yÃ¶ntemi:** Konudan 3 soru Ã¼ret, kendine sor, kendi cevabÄ±nÄ± test et."
            ])
        elif max_cognitive[0] == 'synthetic_thinking':
            strategies.extend([
                "â€¢ **BÃ¼yÃ¼k Resim TekniÄŸi:** Ã–nce konunun genel mantÄ±ÄŸÄ±nÄ± kavra, sonra detaylara in.",
                "â€¢ **Kavram HaritasÄ±:** TÃ¼m bilgileri birbirine baÄŸlayarak bÃ¼tÃ¼ncÃ¼l ÅŸemalar oluÅŸtur.",
                "â€¢ **Analoji Kurma:** Yeni Ã¶ÄŸrendiÄŸin konularÄ± bildiÄŸin ÅŸeylerle iliÅŸkilendir."
            ])
        else:
            strategies.extend([
                "â€¢ **DÃ¼ÅŸÃ¼nce GÃ¼nlÃ¼ÄŸÃ¼:** Ã–ÄŸrendiklerini yazarak iÅŸle ve Ã¼zerinde dÃ¼ÅŸÃ¼n.",
                "â€¢ **Sessiz Tekrar:** KonularÄ± zihninde gÃ¶zden geÃ§ir ve kendi yorumunu ekle.",
                "â€¢ **Soru-Cevap Metodu:** Kendine sorular sor ve derin dÃ¼ÅŸÃ¼nerek cevapla."
            ])
        
        for strategy in strategies:
            st.info(strategy)
        
        # TYT'ye Ã¶zel ipuÃ§larÄ±
        st.markdown("### ğŸ“˜ TYT'ye Ã¶zel ipuÃ§larÄ±:")
        
        tyt_tips = []
        if max_cognitive[0] == 'analytic_thinking':
            tyt_tips.extend([
                "â€¢ **TYT Matematik:** Her yeni konu iÃ§in \"Ã¶nce mantÄ±ÄŸÄ±nÄ± anla, sonra soru Ã§Ã¶z.\" Ã–zellikle problemleri tabloya dÃ¶k.",
                "â€¢ **TYT Fizik:** Konu formÃ¼llerini ezberleme, her formÃ¼lÃ¼n neyi temsil ettiÄŸini Feynman tarzÄ±nda anlat.",
                "â€¢ **TYT Biyoloji:** Sebep-sonuÃ§ iliÅŸkilerini (Ã¶rneÄŸin \"neden fotosentezde su gerekir?\") sorgula.",
                "â€¢ **TYT TÃ¼rkÃ§e:** Paragraf sorularÄ±nda \"yazarÄ±n mantÄ±ÄŸÄ±nÄ± Ã§Ã¶zme\" odaklÄ± Ã§alÄ±ÅŸ."
            ])
        elif max_cognitive[0] == 'synthetic_thinking':
            tyt_tips.extend([
                "â€¢ **TYT Matematik:** FormÃ¼lleri ezberlemek yerine, aralarÄ±ndaki iliÅŸkileri kur.",
                "â€¢ **TYT Fizik:** OlaylarÄ± gÃ¼nlÃ¼k hayatla iliÅŸkilendir, bÃ¼yÃ¼k sistemi gÃ¶re.",
                "â€¢ **TYT Biyoloji:** CanlÄ± sistemlerini bir bÃ¼tÃ¼n olarak dÃ¼ÅŸÃ¼n, parÃ§alar arasÄ± baÄŸlantÄ±larÄ± kur.",
                "â€¢ **TYT CoÄŸrafya:** Ãœlkeler, iklim ve ekonomi arasÄ±ndaki genel baÄŸlantÄ±larÄ± kavra."
            ])
        else:
            tyt_tips.extend([
                "â€¢ **TYT Matematik:** Ã‡Ã¶zÃ¼mÃ¼ yaparken her adÄ±mÄ± \"neden bÃ¶yle yaptÄ±m?\" diye sor.",
                "â€¢ **TYT TÃ¼rkÃ§e:** Metinleri okuduktan sonra kendi dÃ¼ÅŸÃ¼ncelerini de deÄŸerlendÄ±r.",
                "â€¢ **TYT Tarih:** OlaylarÄ± sadece ezberleme, \"bu ne anlama geliyor?\" diye sor.",
                "â€¢ **TYT Felsefe:** KavramlarÄ± gÃ¼nlÃ¼k hayatla iliÅŸkilendir ve Ã¼zerinde dÃ¼ÅŸÃ¼n."
            ])
        
        for tip in tyt_tips:
            st.success(tip)
    
    # 2. Ã–ÄRENME STÄ°LÄ° EÄÄ°LÄ°MÄ°
    if 'vak' in profile_data:
        st.markdown("---")
        st.markdown("## ğŸ¨ 2. Ã–ÄŸrenme Stil EÄŸilimin")
        
        vak = profile_data['vak']
        dominant_style = vak.get('dominant_style', 'Karma')
        
        # YÃ¼zdelik hesaplamasÄ±
        visual_score = vak.get('Visual', 0)
        auditory_score = vak.get('Auditory', 0) 
        kinesthetic_score = vak.get('Kinesthetic', 0)
        
        total_score = visual_score + auditory_score + kinesthetic_score
        if total_score > 0:
            visual_percent = int((visual_score / total_score) * 100)
            auditory_percent = int((auditory_score / total_score) * 100)
            kinesthetic_percent = int((kinesthetic_score / total_score) * 100)
        else:
            visual_percent = auditory_percent = kinesthetic_percent = 33
        
        st.markdown(f"""
        **SonuÃ§ eÄŸilimi:** GÃ¶rsel (%{visual_percent}) â€“ Ä°ÅŸitsel (%{auditory_percent}) â€“ Kinestetik (%{kinesthetic_percent})
        
        Senin Ã¶ÄŸrenme eÄŸilimin {"gÃ¶rsel" if visual_percent > 40 else "iÅŸitsel" if auditory_percent > 40 else "kinestetik" if kinesthetic_percent > 40 else "karma"} kanala dayanÄ±yor olabilir. 
        Yani {"renkler, grafikler, ÅŸemalar ve video iÃ§erikler" if visual_percent > 40 else "sesli aÃ§Ä±klamalar, tartÄ±ÅŸmalar ve mÃ¼zik" if auditory_percent > 40 else "hareket, dokunma ve uygulama" if kinesthetic_percent > 40 else "farklÄ± yÃ¶ntemlerin kombinasyonu"} bilgiyi beynine daha gÃ¼Ã§lÃ¼ kazÄ±yor olabilir.
        """)
        
        st.markdown("### ğŸ§© Sana uygun Ã¶ÄŸrenme teknikleri:")
        
        if visual_percent > 35:
            learning_techniques = [
                "â€¢ **GÃ¶rsel Kodlama:** Konu Ã¶zetlerini renkli bloklar veya ikonlarla Ã§Ä±kar.",
                "â€¢ **\"GÃ¶râ€“SÃ¶yleâ€“Yaz\" TekniÄŸi:** GÃ¶zle gÃ¶r, sesli tekrar et, kendi cÃ¼mlelerinle yaz.",
                "â€¢ **Video + Not:** Konuyu Ã¶nce video ile Ã¶ÄŸren, ardÄ±ndan aynÄ± konuyu yazarak pekiÅŸtir."
            ]
        elif auditory_percent > 35:
            learning_techniques = [
                "â€¢ **Sesli Tekrar:** Ã–ÄŸrendiklerini kendine yÃ¼ksek sesle anlat.",
                "â€¢ **MÃ¼zik + Ã‡alÄ±ÅŸma:** Uygun mÃ¼zik eÅŸliÄŸinde Ã§alÄ±ÅŸ, ritim yarat.",
                "â€¢ **TartÄ±ÅŸma GruplarÄ±:** ArkadaÅŸlarÄ±nla konularÄ± tartÄ±ÅŸarak Ã¶ÄŸren."
            ]
        elif kinesthetic_percent > 35:
            learning_techniques = [
                "â€¢ **Hareket + Ã–ÄŸrenme:** YÃ¼rÃ¼rken formÃ¼l tekrar et, ayakta Ã§alÄ±ÅŸ.",
                "â€¢ **Elle Yazma:** Bilgileri mutlaka el yazÄ±sÄ±yla yaz, Ã§iz.",
                "â€¢ **Pratik + Teori:** Her konuyu Ã¶ÄŸrendikten hemen sonra soru Ã§Ã¶z."
            ]
        else:
            learning_techniques = [
                "â€¢ **Ã‡oklu Kanal:** GÃ¶rsel, iÅŸitsel ve hareket Ã¶ÄŸelerini birleÅŸtir.",
                "â€¢ **Esnek YÃ¶ntem:** GÃ¼nlÃ¼k durumuna gÃ¶re farklÄ± teknikleri dene.",
                "â€¢ **Karma Teknik:** Bir konuyu hem izle, hem dinle, hem de uygula."
            ]
        
        for technique in learning_techniques:
            st.info(technique)
        
        # Ders odaklÄ± Ã¶neriler
        st.markdown("### ğŸ“˜ Ders odaklÄ± Ã¶neriler:")
        
        if visual_percent > 35:
            subject_tips = [
                "â€¢ **TYT CoÄŸrafya:** HaritalÄ± Ã§alÄ±ÅŸ, haritalarÄ± boÅŸ kÃ¢ÄŸÄ±da yeniden Ã§izmeyi dene.",
                "â€¢ **TYT Kimya:** Tepkime ÅŸemalarÄ±nÄ± renkli kutularla gÃ¶ster.",
                "â€¢ **TYT Tarih:** Zaman Ã§izelgesi oluÅŸtur, olaylarÄ± renk kodlarÄ±yla sÄ±rala.",
                "â€¢ **TYT Geometri:** Åekil Ã§izmeden asla soru Ã§Ã¶zme; ÅŸekil ve Ã§Ã¶zÃ¼m arasÄ±ndaki iliÅŸkiyi renkli kalemlerle belirginleÅŸtir."
            ]
        elif auditory_percent > 35:
            subject_tips = [
                "â€¢ **TYT TÃ¼rkÃ§e:** Metinleri sesli oku, ÅŸiirleri sesli tekrar et.",
                "â€¢ **TYT Matematik:** FormÃ¼lleri kendine anlatarak Ã¶ÄŸren.",
                "â€¢ **TYT Fizik:** KavramlarÄ± sesli aÃ§Ä±kla, derse katÄ±l.",
                "â€¢ **TYT Felsefe:** KavramlarÄ± tartÄ±ÅŸa tartÄ±ÅŸa Ã¶ÄŸren."
            ]
        elif kinesthetic_percent > 35:
            subject_tips = [
                "â€¢ **TYT Matematik:** Bol bol soru Ã§Ã¶z, hesap makinesi kullanmadan pratik yap.",
                "â€¢ **TYT Kimya:** Laboratuvar videolarÄ±nÄ± izle, tepkimeleri simÃ¼le et.",
                "â€¢ **TYT Biyoloji:** Modeller kullan, organ sistemlerini Ã§izerek Ã¶ÄŸren.",
                "â€¢ **TYT CoÄŸrafya:** HaritalarÄ± parmaÄŸÄ±nla takip et, fiziki Ã¶zellikleri Ã§iz."
            ]
        else:
            subject_tips = [
                "â€¢ **TÃ¼m Dersler:** Her konu iÃ§in en az 2 farklÄ± yÃ¶ntem kullan.",
                "â€¢ **Esnek YaklaÅŸÄ±m:** Hangi ders iÃ§in hangi yÃ¶ntemin etkili olduÄŸunu keÅŸfet.",
                "â€¢ **Kombine Ã‡alÄ±ÅŸma:** GÃ¶rsel malzemeler + sesli aÃ§Ä±klama + pratik yapma."
            ]
        
        for tip in subject_tips:
            st.success(tip)
    
    # 3. MOTÄ°VASYON & DUYGUSAL DENGE
    if 'motivation' in profile_data:
        st.markdown("---")
        st.markdown("## âš¡ 3. Motivasyon & Duygusal Denge")
        
        motivation = profile_data['motivation']
        internal_mot = motivation.get('internal_motivation', 0)
        external_mot = motivation.get('external_motivation', 0)
        
        total_motivation = internal_mot + external_mot
        if total_motivation > 0:
            internal_percent = int((internal_mot / total_motivation) * 100)
            external_percent = int((external_mot / total_motivation) * 100)
        else:
            internal_percent = external_percent = 50
        
        st.markdown(f"""
        **SonuÃ§ eÄŸilimi:** Ä°Ã§sel %{internal_percent} â€“ DÄ±ÅŸsal %{external_percent}
        
        Ã–ÄŸrenme isteÄŸin bÃ¼yÃ¼k ihtimalle {"kendi geliÅŸimini gÃ¶rmekten geliyor. Ancak bazen Ã§evresel beklentiler (aile, sÄ±nav baskÄ±sÄ±) moralini etkileyebiliyor olabilir." if internal_percent > external_percent else "Ã§evresel faktÃ¶rlerden (baÅŸarÄ±, takdir, rekabet) gÃ¼Ã§ alÄ±yor. Ä°Ã§sel motivasyonunu da geliÅŸtirmeye odaklanabilirsin."}
        """)
        
        st.markdown("### ğŸ’¬ Sana uygun psikolojik destek yÃ¶ntemleri:")
        
        psychological_methods = []
        if internal_percent > external_percent:
            psychological_methods.extend([
                "â€¢ **GÃ¼nlÃ¼k kÃ¼Ã§Ã¼k hedef:** \"BugÃ¼n sadece 20 soru Ã§Ã¶zeceÄŸim\" diyerek baÅŸla, kÃ¼Ã§Ã¼k baÅŸarÄ± dopamini Ã¼ret.",
                "â€¢ **Ä°lerleme takibi:** Sistemiyle geÃ§miÅŸ ilerlemelerini gÃ¶r, moralin artar.",
                "â€¢ **KiÅŸisel geliÅŸim odaÄŸÄ±:** \"Bu konu beni nasÄ±l daha iyi yapacak?\" diye sor.",
                "â€¢ **Ã–zgÃ¼r seÃ§im:** Ã‡alÄ±ÅŸma saatlerini ve konularÄ±nÄ± sen belirle."
            ])
        else:
            psychological_methods.extend([
                "â€¢ **Hedef ve Ã¶dÃ¼l sistemi:** Her baÅŸarÄ±n iÃ§in kendini Ã¶dÃ¼llendir.",
                "â€¢ **Sosyal paylaÅŸÄ±m:** Ä°lerlemeni aile ve arkadaÅŸlarÄ±nla paylaÅŸ.",
                "â€¢ **Rekabet unsuru:** ArkadaÅŸlarÄ±nla saÄŸlÄ±klÄ± rekabet yap.",
                "â€¢ **BaÅŸarÄ± gÃ¶rselleÅŸtirmesi:** HedeflediÄŸin sonuÃ§larÄ± zihninde canlandÄ±r."
            ])
        
        # Ortak Ã¶neriler
        psychological_methods.extend([
            "â€¢ **Nefes egzersizi (4-7-8):** 4 saniye nefes al, 7 tut, 8 ver â†’ kaygÄ±yÄ± azaltÄ±r.",
            "â€¢ **GÃ¼nÃ¼n sonunda yaz:** \"BugÃ¼n az da olsa ilerledim.\"",
            "â€¢ **Pozitif konuÅŸma:** Kendine \"yapamam\" yerine \"nasÄ±l yaparÄ±m\" de."
        ])
        
        for method in psychological_methods:
            st.info(method)
    
    # 4. ZAMAN YÃ–NETÄ°MÄ° & Ã‡ALIÅMA ALIÅKANLIÄI
    if 'time' in profile_data:
        st.markdown("---")
        st.markdown("## â° 4. Zaman YÃ¶netimi & Ã‡alÄ±ÅŸma AlÄ±ÅŸkanlÄ±ÄŸÄ±")
        
        time_data = profile_data['time']
        planning_score = time_data.get('planning', 0)
        procrastination_score = time_data.get('procrastination', 0)
        
        # Profil belirleme
        if planning_score > 3.5 and procrastination_score < 3.0:
            time_profile = "PlanlÄ± ve disiplinli"
        elif planning_score > 3.5 and procrastination_score > 3.0:
            time_profile = "PlanlÄ± ama zaman zaman erteleyici"
        elif planning_score < 3.0 and procrastination_score < 3.0:
            time_profile = "Spontan ama etkili"
        else:
            time_profile = "GeliÅŸtirilebilir zaman yÃ¶netimi"
        
        st.markdown(f"""
        **SonuÃ§ eÄŸilimi:** {time_profile} olabilirsin.
        
        {"Plan yapmayÄ± seviyor ama bazen yorgunluk veya stres seni \"baÅŸlamayÄ± ertelemeye\" itiyor olabilir." if "erteleyici" in time_profile else "Zaman konusunda doÄŸal bir yeteneÄŸin var gibi gÃ¶rÃ¼nÃ¼yor." if "etkili" in time_profile else "Bu alanda kendini geliÅŸtirme potansiyelin yÃ¼ksek."}
        """)
        
        st.markdown("### ğŸ•“ Sana uygun sistemler:")
        
        time_systems = []
        if procrastination_score > 3.0:
            time_systems.extend([
                "â€¢ **Pomodoro TekniÄŸi:** 25 dakika Ã§alÄ±ÅŸ, 5 dakika mola ver. Her 4 turda 20 dakika bÃ¼yÃ¼k mola.",
                "â€¢ **\"2 Dakika KuralÄ±\":** 2 dakikada bitecek iÅŸleri hemen yap, erteleme.",
                "â€¢ **Erteleme kilidi:** Telefonu baÅŸka odaya bÄ±rak, dikkat daÄŸÄ±tÄ±cÄ±larÄ± kaldÄ±r."
            ])
        
        if planning_score < 3.0:
            time_systems.extend([
                "â€¢ **\"Mini hedef\" sistemi:** Tek seferde bÃ¼yÃ¼k planlar yerine 3 ana hedef (sabahâ€“Ã¶ÄŸleâ€“akÅŸam).",
                "â€¢ **HaftalÄ±k tema:** Her haftayÄ± bir derse odakla (Bu hafta matematik haftasÄ±).",
                "â€¢ **Esnek planlama:** Sabit saatler yerine \"Ã¶ncelik sÄ±ralÄ±\" gÃ¶revler yap."
            ])
        
        time_systems.extend([
            "â€¢ **\"GÃ¶rsel ilerleme grafiÄŸi\":** GÃ¼nlÃ¼k yÃ¼zdelik ilerlemeyi takip et, motivasyonun artar.",
            "â€¢ **BaÅŸlama ritÃ¼eli:** Ã‡alÄ±ÅŸmaya Ä±sÄ±nmak iÃ§in 10 dakikalÄ±k \"baÅŸlama seansÄ±\" yap.",
            "â€¢ **DÃ¶nÃ¼ÅŸÃ¼mlÃ¼ Ã§alÄ±ÅŸma:** SevdiÄŸin bir dersle zor bir dersi dÃ¶nÃ¼ÅŸÃ¼mlÃ¼ Ã§alÄ±ÅŸ."
        ])
        
        for system in time_systems:
            st.info(system)
        
        st.markdown("### ğŸ“˜ Uygulama Ã¶nerisi:")
        
        application_tips = [
            "â€¢ **Sabah rutini:** GÃ¼ne aynÄ± ÅŸekilde baÅŸla, beynin hazÄ±r olsun.",
            "â€¢ **Ã‡alÄ±ÅŸma Ã¶ncesi:** MasayÄ± topla, su hazÄ±rla, 3 derin nefes al.",
            "â€¢ **Mola aktiviteleri:** Uzanma, su iÃ§me, pencereden bakma - telefon deÄŸil!"
        ]
        
        for tip in application_tips:
            st.success(tip)
    
    # 5. GENEL BEYÄ°N PROFÄ°LÄ° (KISA Ã–ZET)
    st.markdown("---")
    st.markdown("## ğŸ”® GENEL BEYÄ°N PROFÄ°LÄ°N (KÄ±sa Ã–zet)")
    
    # Genel profil Ã¶zeti
    cognitive_summary = ""
    learning_summary = ""
    motivation_summary = ""
    time_summary = ""
    
    if 'cognitive' in profile_data:
        cognitive = profile_data['cognitive']
        max_cognitive = max(cognitive.items(), key=lambda x: x[1])
        if max_cognitive[0] == 'analytic_thinking':
            cognitive_summary = "analitik ve sistematik dÃ¼ÅŸÃ¼nebilen"
        elif max_cognitive[0] == 'synthetic_thinking':
            cognitive_summary = "bÃ¼tÃ¼ncÃ¼l ve yaratÄ±cÄ± dÃ¼ÅŸÃ¼nebilen"
        else:
            cognitive_summary = "reflektif ve derin dÃ¼ÅŸÃ¼nebilen"
    
    if 'vak' in profile_data:
        vak = profile_data['vak']
        visual_score = vak.get('Visual', 0)
        auditory_score = vak.get('Auditory', 0)
        kinesthetic_score = vak.get('Kinesthetic', 0)
        
        if visual_score > auditory_score and visual_score > kinesthetic_score:
            learning_summary = "gÃ¶rsel"
        elif auditory_score > kinesthetic_score:
            learning_summary = "iÅŸitsel"
        else:
            learning_summary = "kinestetik"
    
    if 'motivation' in profile_data:
        motivation = profile_data['motivation']
        if motivation.get('internal_motivation', 0) > motivation.get('external_motivation', 0):
            motivation_summary = "iÃ§sel motivasyonu gÃ¼Ã§lÃ¼"
        else:
            motivation_summary = "dÄ±ÅŸsal motivasyonu gÃ¼Ã§lÃ¼"
    
    if 'time' in profile_data:
        time_data = profile_data['time']
        if time_data.get('planning', 0) > 3.5:
            if time_data.get('procrastination', 0) > 3.0:
                time_summary = "planlÄ± ama zaman zaman duygusal ertelemeye aÃ§Ä±k"
            else:
                time_summary = "planlÄ± ve disiplinli"
        else:
            time_summary = "esnek ama geliÅŸtirilebilir zaman yÃ¶netimli"
    
    summary_text = f"{cognitive_summary}, {learning_summary} Ã¶ÄŸrenme stiline sahip, {motivation_summary}, {time_summary} bir Ã¶ÄŸrenci profiline sahip olabilirsin."
    
    st.info(f"""
    **{summary_text.capitalize()}**
    
    Bu tarz Ã¶ÄŸrenciler, kendi sistemlerini kurduklarÄ±nda uzun vadede Ã§ok yÃ¼ksek baÅŸarÄ± elde ederler.
    """)
    
    # Motivasyonel sloganlar
    st.markdown("### ğŸ’« Senin Ã§alÄ±ÅŸma mottolarÄ±n:")
    
    mottos = [
        "**\"BugÃ¼n az da olsa ilerledim.\"**",
        "**\"AnladÄ±ÄŸÄ±m her ÅŸey kalÄ±cÄ± hale geliyor.\"**", 
        "**\"Bir adÄ±m bile bir ilerlemedir.\"**"
    ]
    
    for motto in mottos:
        st.success(motto)

def display_individual_test_analysis(test_config, user_data):
    """Bireysel test analizini gÃ¶sterir"""
    st.markdown(f'''
    <div class="analysis-section">
        <h3>{test_config['icon']} {test_config['title']} - DetaylÄ± Analiz</h3>
    </div>
    ''', unsafe_allow_html=True)
    
    # Test tÃ¼rÃ¼ne gÃ¶re analiz gÃ¶ster
    if test_config['id'] == 'vak':
        display_vak_analysis(user_data)
    elif test_config['id'] == 'cognitive':
        display_cognitive_analysis(user_data)
    elif test_config['id'] == 'motivation':
        display_motivation_analysis(user_data)
    elif test_config['id'] == 'time':
        display_time_management_analysis(user_data)

def setup_matplotlib_for_plotting():
    """
    Setup matplotlib for plotting with proper configuration.
    Call this function before creating any plots to ensure proper rendering.
    """
    import warnings
    import matplotlib.pyplot as plt

    # Ensure warnings are printed
    warnings.filterwarnings('default')  # Show all warnings

    # Configure matplotlib for non-interactive mode
    plt.switch_backend("Agg")

    # Set clean modern style
    plt.style.use("default")

    # Configure platform-appropriate fonts for cross-platform compatibility
    plt.rcParams["font.sans-serif"] = ["Noto Sans CJK SC", "WenQuanYi Zen Hei", "PingFang SC", "Arial Unicode MS", "Hiragino Sans GB", "DejaVu Sans"]
    plt.rcParams["axes.unicode_minus"] = False
    
    # Basic styling
    plt.rcParams["figure.facecolor"] = "white"
    plt.rcParams["axes.facecolor"] = "white"
    plt.rcParams["axes.edgecolor"] = "#CCCCCC"
    plt.rcParams["axes.linewidth"] = 0.8
    plt.rcParams["grid.alpha"] = 0.3

def display_vak_analysis(user_data):
    """VAK testi detaylÄ± analizi - Basit ve anlaÅŸÄ±lÄ±r grafik gÃ¶sterimi"""
    style_scores_str = user_data.get('learning_style_scores', '')
    dominant_style = user_data.get('learning_style', '')
    
    # VAK test sonuÃ§larÄ± kontrol et - hem eski hem yeni field isimleri
    vak_test_completed = user_data.get('vak_test_results', '') or user_data.get('learning_style_results', '')
    
    # EÄŸer test tamamlanmÄ±ÅŸsa ve veri varsa
    if vak_test_completed and (style_scores_str or dominant_style):
        try:
            import plotly.express as px
            import json
            
            # Verileri parse et
            if style_scores_str:
                style_scores = json.loads(style_scores_str.replace("'", "\""))
            else:
                # Default deÄŸerler - test tamamlanmÄ±ÅŸsa
                style_scores = {'visual': 35, 'auditory': 30, 'kinesthetic': 35}
                dominant_style = 'GÃ¶rsel' if not dominant_style else dominant_style
            
            # YÃ¼zdeleri hesapla
            visual_percent = style_scores.get('visual', 0)
            auditory_percent = style_scores.get('auditory', 0)
            kinesthetic_percent = style_scores.get('kinesthetic', 0)
            
            # Dominant style bilgisini al
            vak_detailed_info = {
                'GÃ¶rsel': {'icon': 'ğŸ‘ï¸', 'title': 'GÃ¶rsel Ã–ÄŸrenme'},
                'Ä°ÅŸitsel': {'icon': 'ğŸ‘‚', 'title': 'Ä°ÅŸitsel Ã–ÄŸrenme'},
                'Kinestetik': {'icon': 'âœ‹', 'title': 'Kinestetik Ã–ÄŸrenme'}
            }
            
            # BaskÄ±n stil belirleme
            max_score = max(visual_percent, auditory_percent, kinesthetic_percent)
            if visual_percent == max_score:
                dominant_style = 'GÃ¶rsel'
            elif auditory_percent == max_score:
                dominant_style = 'Ä°ÅŸitsel'
            else:
                dominant_style = 'Kinestetik'
                
            style_info = vak_detailed_info[dominant_style]
            
            st.markdown("---")
            st.markdown(f"## {style_info['icon']} **{style_info['title']}** - BaskÄ±n Stiliniz!")
            
            # Stil daÄŸÄ±lÄ±mÄ± grafik
            col1, col2 = st.columns([2, 1])
            
            with col1:
                vak_data = {
                    'Stil': ['GÃ¶rsel', 'Ä°ÅŸitsel', 'Kinestetik'],
                    'YÃ¼zde': [visual_percent, auditory_percent, kinesthetic_percent],
                    'Renk': ['#FF6B6B', '#4ECDC4', '#45B7D1']
                }
                
                fig = px.pie(
                    values=vak_data['YÃ¼zde'], 
                    names=vak_data['Stil'],
                    title="ğŸ“Š Ã–ÄŸrenme Stili DaÄŸÄ±lÄ±mÄ±nÄ±z",
                    color_discrete_sequence=['#FF6B6B', '#4ECDC4', '#45B7D1']
                )
                fig.update_traces(textposition='inside', textinfo='percent+label')
                fig.update_layout(
                    height=400,
                    font=dict(size=14),
                    showlegend=True
                )
                safe_plotly_chart(fig, use_container_width=True)
            
            with col2:
                st.markdown("### ğŸ“ˆ Puan DetaylarÄ±")
                styles = [
                    ("GÃ¶rsel ğŸ‘ï¸", visual_percent, "#FF6B6B"),
                    ("Ä°ÅŸitsel ğŸ‘‚", auditory_percent, "#4ECDC4"),
                    ("Kinestetik âœ‹", kinesthetic_percent, "#45B7D1")
                ]
                
                for style_name, percentage, color in styles:
                    is_dominant = style_name.split()[0] == dominant_style
                    border = "3px solid #FFD700" if is_dominant else "1px solid #ddd"
                    
                    st.markdown(f"""
                        <div style="
                            border: {border};
                            padding: 10px;
                            margin: 8px 0;
                            border-radius: 8px;
                            background: linear-gradient(90deg, {color}20, transparent);
                            text-align: center;
                        ">
                            <strong>{style_name}</strong><br>
                            <span style="font-size: 24px; color: {color};">%{percentage:.1f}</span>
                        </div>
                    """, unsafe_allow_html=True)
            
            # DETAYLI ANALÄ°Z YAZILARI - Basit format
            st.markdown("---")
            
            # Stil aÃ§Ä±klamasÄ±
            style_descriptions = {
                'GÃ¶rsel': "Sen bilgiyi en iyi gÃ¶zlerle algÄ±layan bir Ã¶ÄŸrencisin. Zihninde canlandÄ±rdÄ±ÄŸÄ±n resimler, renkler ve ÅŸemalar, Ã¶ÄŸrenme sÃ¼recini Ã§ok daha kolay ve kalÄ±cÄ± hale getirebilir.",
                'Ä°ÅŸitsel': "Sen bilgiyi en iyi kulaÄŸÄ±nla algÄ±layan bir Ã¶ÄŸrencisin. Sesler, mÃ¼zik ve konuÅŸmalar senin iÃ§in en etkili Ã¶ÄŸrenme araÃ§larÄ±dÄ±r.",
                'Kinestetik': "Sen bilgiyi en iyi hareket ederek ve yaparak algÄ±layan bir Ã¶ÄŸrencisin. Ellerinle dokunmak, hareket etmek ve uygulama yapmak senin iÃ§in en etkili Ã¶ÄŸrenme yÃ¶ntemidir."
            }
            
            st.info(style_descriptions[dominant_style])
            
            # GÃ¼Ã§lÃ¼ YÃ¶nler
            st.markdown("### ğŸ’ª GÃ¼Ã§lÃ¼ YÃ¶nlerin:")
            
            strengths = {
                'GÃ¶rsel': [
                    "Harita, grafik ve ÅŸemalarÄ± kolay anlayabilirsin",
                    "Renkli notlar ve gÃ¶rsellerle daha hÄ±zlÄ± Ã¶ÄŸrenebilirsin", 
                    "KarmaÅŸÄ±k bilgileri zihninde gÃ¶rselleÅŸtirme yeteneÄŸin gÃ¼Ã§lÃ¼dÃ¼r"
                ],
                'Ä°ÅŸitsel': [
                    "Dinleyerek hÄ±zlÄ± Ã¶ÄŸrenebilir ve hatÄ±rlayabilirsin",
                    "KonularÄ± sesli anlatarak daha iyi kavrayabilirsin",
                    "MÃ¼zik ve ses tonlarÄ±ndan yararlanarak etkili Ã§alÄ±ÅŸabilirsin"
                ],
                'Kinestetik': [
                    "Bol soru Ã§Ã¶zÃ¼mÃ¼ yaparak hÄ±zlÄ± Ã¶ÄŸrenebilirsin",
                    "Pratik uygulamalarla bilgiyi kalÄ±cÄ± hale getirebilirsin",
                    "Hareket halindeyken daha verimli Ã§alÄ±ÅŸabilirsin"
                ]
            }
            
            for strength in strengths[dominant_style]:
                st.success(f"â€¢ {strength}")
            
            # ZayÄ±f YÃ¶nler
            st.markdown("### âš ï¸ ZayÄ±f YÃ¶nlerin:")
            
            weaknesses = {
                'GÃ¶rsel': [
                    "Sadece dinleyerek Ã¶ÄŸrenmekte zorlanabilirsin",
                    "Ders notlarÄ± daÄŸÄ±nÄ±k olduÄŸunda odaklanman zorlaÅŸabilir"
                ],
                'Ä°ÅŸitsel': [
                    "Sessiz ortamda Ã§alÄ±ÅŸmakta zorlanabilirsin",
                    "GÃ¶rsel materyalleri anlamakta zaman gerekebilir"
                ],
                'Kinestetik': [
                    "Uzun sÃ¼re hareketsiz oturmakta zorlanabilirsin",
                    "Teorik konularÄ± kavramak zaman alabilir"
                ]
            }
            
            for weakness in weaknesses[dominant_style]:
                st.warning(f"â€¢ {weakness}")
            
            # Akademik GeliÅŸim Ã–nerileri
            st.markdown("### ğŸ“ Akademik GeliÅŸim Ã–nerilerin:")
            
            academic_tips = {
                'GÃ¶rsel': [
                    "**Zihin Haritalama:** Her konu iÃ§in renkli zihin haritalarÄ± oluÅŸtur",
                    "**Renk Kodlama:** FarklÄ± konularÄ± farklÄ± renklerle iÅŸaretle",
                    "**Grafik NotlarÄ±:** Bilgileri tablo, grafik ve ÅŸema halinde Ã¶zetle",
                    "**FormÃ¼l KartlarÄ±:** FormÃ¼lleri renkli kartlar halinde hazÄ±rla"
                ],
                'Ä°ÅŸitsel': [
                    "**Sesli Tekrar:** KonularÄ± kendi kendine yÃ¼ksek sesle anlat",
                    "**MÃ¼zik EÅŸliÄŸi:** Uygun mÃ¼zik eÅŸliÄŸinde Ã§alÄ±ÅŸ",
                    "**TartÄ±ÅŸma GruplarÄ±:** ArkadaÅŸlarÄ±nla konu tartÄ±ÅŸmalarÄ± yap",
                    "**Ses KayÄ±tlarÄ±:** Ã–nemli konularÄ± ses kaydÄ± olarak al"
                ],
                'Kinestetik': [
                    "**Hareket + Ã‡alÄ±ÅŸma:** YÃ¼rÃ¼rken formÃ¼l tekrar et",
                    "**Bol Uygulama:** Her konu iÃ§in Ã§ok sayÄ±da soru Ã§Ã¶z",
                    "**Elle Yazma:** Bilgileri mutlaka el yazÄ±sÄ±yla yaz",
                    "**KÄ±sa Molalar:** 25 dakika Ã§alÄ±ÅŸ, 5 dakika hareket et"
                ]
            }
            
            for tip in academic_tips[dominant_style]:
                st.info(f"â€¢ {tip}")
                        
        except Exception as e:
            import traceback
            st.error(f"VAK analizi gÃ¶sterilirken hata oluÅŸtu: {str(e)}")
            st.error(f"Detay: {traceback.format_exc()}")
            # Fallback basit gÃ¶rÃ¼nÃ¼m
            if dominant_style:
                st.markdown(f"**BaskÄ±n Ã–ÄŸrenme Stili:** {dominant_style}")
                st.info("Grafik yÃ¼klenemedi, ancak analiz sonuÃ§larÄ±nÄ±z kaydedildi.")

def display_cognitive_analysis(user_data):
    """BiliÅŸsel test detaylÄ± analizi - Basit grafik gÃ¶sterimi"""
    cognitive_results = user_data.get('cognitive_test_results', '')
    cognitive_scores = user_data.get('cognitive_test_scores', '')
    
    if cognitive_results and (cognitive_scores or cognitive_results):
        try:
            import plotly.express as px
            import json
            
            # Verileri parse et
            if cognitive_scores:
                raw_scores = json.loads(cognitive_scores.replace("'", '"'))
                
                # ADAPTIF VERÄ° Ä°ÅLEME - herhangi bir formattaki veriyi dÃ¼zenli hale getir
                analytic_score = 0
                synthetic_score = 0
                reflective_score = 0
                
                # TÃ¼m anahtarlarÄ± kontrol et ve kategorilere ayÄ±r
                for key, value in raw_scores.items():
                    key_lower = key.lower()
                    
                    # Analitik dÃ¼ÅŸÃ¼nme
                    if any(word in key_lower for word in ['analytic', 'analytical', 'analyze']):
                        analytic_score += float(value)
                    
                    # Sintetik/BÃ¼tÃ¼ncÃ¼l dÃ¼ÅŸÃ¼nme  
                    elif any(word in key_lower for word in ['synthetic', 'synthesis', 'creative', 'visual', 'experiential', 'holistic']):
                        synthetic_score += float(value)
                    
                    # Reflektif dÃ¼ÅŸÃ¼nme
                    elif any(word in key_lower for word in ['reflective', 'reflection', 'auditory', 'listening']):
                        reflective_score += float(value)
                    
                    # EÄŸer thinking ile bitiyorsa direkt kullan
                    elif 'thinking' in key_lower:
                        if 'analytic' in key_lower:
                            analytic_score = float(value)
                        elif 'synthetic' in key_lower:
                            synthetic_score = float(value)
                        elif 'reflective' in key_lower:
                            reflective_score = float(value)
                
                # EÄŸer hiÃ§ puan bulunamadÄ±ysa default deÄŸerler
                if analytic_score == 0 and synthetic_score == 0 and reflective_score == 0:
                    analytic_score = 3.5
                    synthetic_score = 3.2
                    reflective_score = 3.8
                
                # Son format
                scores_data = {
                    'analytic_thinking': analytic_score,
                    'synthetic_thinking': synthetic_score,
                    'reflective_thinking': reflective_score
                }
                    
            else:
                # Default deÄŸerler - test tamamlanmÄ±ÅŸsa
                scores_data = {'analytic_thinking': 3.5, 'synthetic_thinking': 3.2, 'reflective_thinking': 3.8}
            
            # YÃ¼zdeleri hesapla
            total_score = sum(scores_data.values())
            percentages = {key: (value/total_score)*100 for key, value in scores_data.items()}
            
            # En yÃ¼ksek skoru bul
            max_category = max(scores_data, key=scores_data.get)
            
            # Kategori bilgileri
            category_info = {
                'analytic_thinking': {
                    'name': 'Analitik DÃ¼ÅŸÃ¼nce',
                    'icon': 'ğŸ”¬',
                    'color': '#FF6B6B'
                },
                'synthetic_thinking': {
                    'name': 'BÃ¼tÃ¼ncÃ¼l DÃ¼ÅŸÃ¼nce', 
                    'icon': 'ğŸ¨',
                    'color': '#4ECDC4'
                },
                'reflective_thinking': {
                    'name': 'Reflektif DÃ¼ÅŸÃ¼nce',
                    'icon': 'ğŸ¤”',
                    'color': '#45B7D1'
                }
            }
            
            dominant_info = category_info[max_category]
            
            st.markdown("---")
            st.markdown(f"## {dominant_info['icon']} **{dominant_info['name']}** - BaskÄ±n DÃ¼ÅŸÃ¼nce Stiliniz!")
            
            # Grafik bÃ¶lÃ¼mÃ¼
            col1, col2 = st.columns([2, 1])
            
            with col1:
                # Pie chart
                fig = px.pie(
                    values=list(percentages.values()),
                    names=[category_info[key]['name'] for key in percentages.keys()],
                    title="ğŸ§  BiliÅŸsel Profil DaÄŸÄ±lÄ±mÄ±nÄ±z",
                    color_discrete_sequence=['#FF6B6B', '#4ECDC4', '#45B7D1']
                )
                fig.update_traces(textposition='inside', textinfo='percent+label')
                fig.update_layout(
                    height=400,
                    font=dict(size=14),
                    showlegend=True
                )
                safe_plotly_chart(fig, use_container_width=True)
            
            with col2:
                st.markdown("### ğŸ“ˆ Puan DetaylarÄ±")
                
                for key, value in scores_data.items():
                    info = category_info[key]
                    percentage = percentages[key]
                    is_dominant = key == max_category
                    border = "3px solid gold" if is_dominant else "1px solid #ddd"
                    
                    st.markdown(f"""
                        <div style="
                            border: {border};
                            padding: 10px;
                            margin: 8px 0;
                            border-radius: 8px;
                            background: linear-gradient(90deg, {info['color']}20, transparent);
                            text-align: center;
                        ">
                            <strong>{info['name']} {info['icon']}</strong><br>
                            <span style="font-size: 20px; color: {info['color']};">%{percentage:.1f}</span><br>
                            <small style="color: {info['color']};">({value:.1f}/5 puan)</small>
                        </div>
                    """, unsafe_allow_html=True)
            
            # BaskÄ±n stil aÃ§Ä±klamalarÄ±
            st.markdown("---")
            st.markdown(f"### ğŸ¯ **{dominant_info['name']}** Ã–zellikleri")
            
            cognitive_profiles = {
                'analytic_thinking': {
                    'description': 'Sistematik dÃ¼ÅŸÃ¼nme ve problem Ã§Ã¶zme becerileriniz gÃ¼Ã§lÃ¼.',
                    'strengths': ['MantÄ±ksal Ã§Ä±karÄ±m yapma', 'Problemleri adÄ±m adÄ±m Ã§Ã¶zme', 'Sistematik yaklaÅŸÄ±m', 'DetaylÄ± analiz'],
                    'study_tips': ['KonularÄ± kÃ¼Ã§Ã¼k parÃ§alara bÃ¶lÃ¼n', 'AdÄ±m adÄ±m Ã§alÄ±ÅŸma planlarÄ± yapÄ±n', 'MantÄ±k sorularÄ± Ã§Ã¶zÃ¼n', 'Grafik ve ÅŸemalar kullanÄ±n']
                },
                'synthetic_thinking': {
                    'description': 'BÃ¼tÃ¼ncÃ¼l bakÄ±ÅŸ aÃ§Ä±sÄ± ve yaratÄ±cÄ± dÃ¼ÅŸÃ¼nme becerileriniz geliÅŸmiÅŸ.',
                    'strengths': ['BÃ¼yÃ¼k resmi gÃ¶rme', 'YaratÄ±cÄ± Ã§Ã¶zÃ¼mler Ã¼retme', 'FarklÄ± konularÄ± birleÅŸtirme', 'Sezgisel kavrayÄ±ÅŸ'],
                    'study_tips': ['Kavram haritalarÄ± oluÅŸturun', 'Konular arasÄ± baÄŸlantÄ± kurun', 'Hikaye anlatÄ±mÄ± tekniÄŸi kullanÄ±n', 'Beyin fÄ±rtÄ±nasÄ± yapÄ±n']
                },
                'reflective_thinking': {
                    'description': 'DÃ¼ÅŸÃ¼nce sÃ¼reÃ§lerinizi deÄŸerlendirme ve Ã¶z-analiz beceriniz yÃ¼ksek.',
                    'strengths': ['Ã–z-farkÄ±ndalÄ±k', 'Stratejik planlama', 'Hata analizi yapma', 'SÃ¼reÃ§ deÄŸerlendirme'],
                    'study_tips': ['Ã–ÄŸrenme gÃ¼nlÃ¼ÄŸÃ¼ tutun', 'DÃ¼zenli self-deÄŸerlendirme yapÄ±n', 'Hata analizleri oluÅŸturun', 'Stratejik Ã§alÄ±ÅŸma planlarÄ± hazÄ±rlayÄ±n']
                }
            }
            
            profile = cognitive_profiles[max_category]
            st.markdown(profile['description'])
            
            col1, col2 = st.columns(2)
            
            with col1:
                st.markdown("#### ğŸ’ª GÃ¼Ã§lÃ¼ YanlarÄ±nÄ±z")
                for strength in profile['strengths']:
                    st.markdown(f"â€¢ {strength}")
            
            with col2:
                st.markdown("#### ğŸ“š Ã‡alÄ±ÅŸma Ã–nerileriniz")
                for tip in profile['study_tips']:
                    st.markdown(f"â€¢ {tip}")
                    
        except Exception as e:
            st.error(f"Analiz gÃ¶sterilirken hata: {str(e)}")
            st.info("ğŸ§  **BiliÅŸsel Profil:** Test sonuÃ§larÄ±nÄ±z kaydedildi.")
    else:
        st.warning("âš ï¸ Test sonuÃ§larÄ± yÃ¼klenemedi.")

def display_motivation_analysis(user_data):
    """Motivasyon ve duygusal denge analizi - Basit grafik gÃ¶sterimi"""
    motivation_results = user_data.get('motivation_test_results', '')
    motivation_scores = user_data.get('motivation_test_scores', '')
    
    if motivation_results and (motivation_scores or motivation_results):
        try:
            import plotly.express as px
            import json
            
            # Verileri parse et
            if motivation_scores:
                raw_scores = json.loads(motivation_scores.replace("'", '"'))
                
                # ADAPTIF VERÄ° Ä°ÅLEME - herhangi bir formattaki veriyi dÃ¼zenli hale getir
                internal_score = 0
                external_score = 0
                anxiety_score = 0
                resilience_score = 0
                
                # TÃ¼m anahtarlarÄ± kontrol et ve kategorilere ayÄ±r
                for key, value in raw_scores.items():
                    key_lower = key.lower()
                    
                    # Ä°Ã§sel motivasyon
                    if any(word in key_lower for word in ['internal', 'intrinsic', 'inner', 'motivation_internal']):
                        internal_score += float(value)
                    
                    # DÄ±ÅŸsal motivasyon  
                    elif any(word in key_lower for word in ['external', 'extrinsic', 'outer', 'motivation_external']):
                        external_score += float(value)
                    
                    # SÄ±nav kaygÄ±sÄ±
                    elif any(word in key_lower for word in ['anxiety', 'worry', 'stress', 'exam_anxiety', 'test_anxiety']):
                        anxiety_score += float(value)
                    
                    # Duygusal dayanÄ±klÄ±lÄ±k
                    elif any(word in key_lower for word in ['resilience', 'emotional', 'strength', 'durability']):
                        resilience_score += float(value)
                
                # EÄŸer hiÃ§ puan bulunamadÄ±ysa default deÄŸerler
                if internal_score == 0 and external_score == 0 and anxiety_score == 0 and resilience_score == 0:
                    internal_score = 3.8
                    external_score = 3.2
                    anxiety_score = 2.5
                    resilience_score = 3.9
                
                # Son format
                scores_data = {
                    'internal_motivation': internal_score,
                    'external_motivation': external_score,
                    'test_anxiety': anxiety_score,
                    'emotional_resilience': resilience_score
                }
                
            else:
                # Default deÄŸerler - test tamamlanmÄ±ÅŸsa
                scores_data = {
                    'internal_motivation': 3.8, 'external_motivation': 3.2, 
                    'test_anxiety': 2.5, 'emotional_resilience': 3.9
                }
            
            # YÃ¼zdeleri hesapla
            total_score = sum(scores_data.values())
            percentages = {key: (value/total_score)*100 for key, value in scores_data.items()}
            
            # En yÃ¼ksek skoru bul
            max_category = max(scores_data, key=scores_data.get)
            
            # Kategori bilgileri
            category_info = {
                'internal_motivation': {
                    'name': 'Ä°Ã§sel Motivasyon',
                    'icon': 'ğŸŒŸ',
                    'color': '#FF6B6B'
                },
                'external_motivation': {
                    'name': 'DÄ±ÅŸsal Motivasyon', 
                    'icon': 'ğŸ¯',
                    'color': '#4ECDC4'
                },
                'test_anxiety': {
                    'name': 'SÄ±nav KaygÄ±sÄ±',
                    'icon': 'ğŸ˜°',
                    'color': '#45B7D1'
                },
                'emotional_resilience': {
                    'name': 'Duygusal DayanÄ±klÄ±lÄ±k',
                    'icon': 'ğŸ’ª',
                    'color': '#96CEB4'
                }
            }
            
            dominant_info = category_info[max_category]
            
            st.markdown("---")
            st.markdown(f"## {dominant_info['icon']} **{dominant_info['name']}** - BaskÄ±n Ã–zelliÄŸiniz!")
            
            # Grafik bÃ¶lÃ¼mÃ¼
            col1, col2 = st.columns([2, 1])
            
            with col1:
                # Pie chart
                fig = px.pie(
                    values=list(percentages.values()),
                    names=[category_info[key]['name'] for key in percentages.keys()],
                    title="âš¡ Motivasyon ve Duygusal Profil DaÄŸÄ±lÄ±mÄ±nÄ±z",
                    color_discrete_sequence=['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4']
                )
                fig.update_traces(textposition='inside', textinfo='percent+label')
                fig.update_layout(
                    height=400,
                    font=dict(size=14),
                    showlegend=True
                )
                safe_plotly_chart(fig, use_container_width=True)
            
            with col2:
                st.markdown("### ğŸ“ˆ Puan DetaylarÄ±")
                
                for key, value in scores_data.items():
                    info = category_info[key]
                    percentage = percentages[key]
                    is_dominant = key == max_category
                    border = "3px solid gold" if is_dominant else "1px solid #ddd"
                    
                    st.markdown(f"""
                        <div style="
                            border: {border};
                            padding: 10px;
                            margin: 8px 0;
                            border-radius: 8px;
                            background: linear-gradient(90deg, {info['color']}20, transparent);
                            text-align: center;
                        ">
                            <strong>{info['name']} {info['icon']}</strong><br>
                            <span style="font-size: 20px; color: {info['color']};">%{percentage:.1f}</span><br>
                            <small style="color: {info['color']};">({value:.1f}/5 puan)</small>
                        </div>
                    """, unsafe_allow_html=True)
            
            # BaskÄ±n Ã¶zellik aÃ§Ä±klamalarÄ±
            st.markdown("---")
            st.markdown(f"### ğŸ¯ **{dominant_info['name']}** Ã–zellikleri")
            
            motivation_profiles = {
                'internal_motivation': {
                    'description': 'Kendi iÃ§ dÃ¼nyanÄ±zdan gelen motivasyonla hareket edersiniz.',
                    'strengths': ['Kendi kendini motive etme', 'Merak odaklÄ± Ã¶ÄŸrenme', 'BaÄŸÄ±msÄ±z Ã§alÄ±ÅŸma', 'YaratÄ±cÄ± dÃ¼ÅŸÃ¼nme'],
                    'study_tips': ['Ä°lgi duyduÄŸunuz konulara odaklanÄ±n', 'KiÅŸisel hedefler belirleyin', 'Kendi hevesli olduÄŸunuz zamanlarda Ã§alÄ±ÅŸÄ±n', 'KeÅŸif yapmaya zaman ayÄ±rÄ±n']
                },
                'external_motivation': {
                    'description': 'DÄ±ÅŸ Ã¶dÃ¼ller ve hedeflerle motive olursunuz.',
                    'strengths': ['Hedef odaklÄ± Ã§alÄ±ÅŸma', 'Rekabet ortamÄ±nda baÅŸarÄ±', 'Somut sonuÃ§lar alma', 'PlanÄ± takip etme'],
                    'study_tips': ['Net hedefler ve Ã¶dÃ¼ller belirleyin', 'Rekabet ortamlarÄ± oluÅŸturun', 'BaÅŸarÄ±larÄ±nÄ±zÄ± gÃ¶rsel olarak takip edin', 'DÄ±ÅŸ destek alÄ±n']
                },
                'test_anxiety': {
                    'description': 'SÄ±nav durumlarmda stres yaÅŸama eÄŸiliminiz var.',
                    'strengths': ['YÃ¼ksek farkÄ±ndalÄ±k', 'Dikkatli hazÄ±rlÄ±k', 'DetaycÄ± yaklaÅŸÄ±m', 'Performans odaklÄ±lÄ±k'],
                    'study_tips': ['Nefes egzersizleri yapÄ±n', 'Deneme sÄ±navlarÄ± Ã§Ã¶zÃ¼n', 'Zaman yÃ¶netimi pratikte edin', 'Rahatlatici teknikler Ã¶ÄŸrenin']
                },
                'emotional_resilience': {
                    'description': 'Duygusal zorluklar karÅŸÄ±sÄ±nda gÃ¼Ã§lÃ¼ direncÃ§ gÃ¶sterirsiniz.',
                    'strengths': ['Stresle baÅŸ etme', 'HÄ±zlÄ± toparlanma', 'Pozitif bakÄ±ÅŸ aÃ§Ä±sÄ±', 'Adaptasyon yeteneÄŸi'],
                    'study_tips': ['Zorlu konulara cesurca yaklaÅŸÄ±n', 'HatalarÄ±nÄ±zdan hÄ±zla Ã¶ÄŸrenin', 'Uzun vadeli planlar yapÄ±n', 'Kendinize gÃ¼venin']
                }
            }
            
            profile = motivation_profiles[max_category]
            st.markdown(profile['description'])
            
            col1, col2 = st.columns(2)
            
            with col1:
                st.markdown("#### ğŸ’ª GÃ¼Ã§lÃ¼ YanlarÄ±nÄ±z")
                for strength in profile['strengths']:
                    st.markdown(f"â€¢ {strength}")
            
            with col2:
                st.markdown("#### ğŸ“š Ã‡alÄ±ÅŸma Ã–nerileriniz")
                for tip in profile['study_tips']:
                    st.markdown(f"â€¢ {tip}")
                    
        except Exception as e:
            st.error(f"Motivasyon analizi gÃ¶sterilirken hata oluÅŸtu: {str(e)}")
            st.info("âš¡ **Motivasyon & Duygusal Denge:** Test sonuÃ§larÄ±nÄ±z kaydedildi.")
    else:
        st.warning("âš ï¸ Test sonuÃ§larÄ± yÃ¼klenemedi.")

def display_time_management_analysis(user_data):
    """Zaman yÃ¶netimi analizi - Basit grafik gÃ¶sterimi"""
    time_results = user_data.get('time_test_results', '')
    time_scores = user_data.get('time_test_scores', '')
    
    if time_results and (time_scores or time_results):
        try:
            import plotly.express as px
            import json
            
            # Verileri parse et
            if time_scores:
                raw_scores = json.loads(time_scores.replace("'", '"'))
                
                # ADAPTIF VERÄ° Ä°ÅLEME - herhangi bir formattaki veriyi dÃ¼zenli hale getir
                planning_score = 0
                procrastination_score = 0
                focus_score = 0
                time_score = 0
                priority_score = 0
                discipline_score = 0
                awareness_score = 0
                
                # TÃ¼m anahtarlarÄ± kontrol et ve kategorilere ayÄ±r
                for key, value in raw_scores.items():
                    key_lower = key.lower()
                    
                    # Planlama
                    if any(word in key_lower for word in ['planning', 'plan', 'organize', 'structure']):
                        planning_score += float(value)
                    
                    # Erteleme  
                    elif any(word in key_lower for word in ['procrastination', 'delay', 'postpone', 'erteleme']):
                        procrastination_score += float(value)
                    
                    # Odak kontrolÃ¼
                    elif any(word in key_lower for word in ['focus', 'concentrate', 'attention', 'odak']):
                        focus_score += float(value)
                    
                    # Zaman bilinci
                    elif any(word in key_lower for word in ['time_awareness', 'time', 'temporal', 'zaman']):
                        time_score += float(value)
                    
                    # Ã–ncelik yÃ¶netimi
                    elif any(word in key_lower for word in ['priority', 'prioritization', 'Ã¶ncelik']):
                        priority_score += float(value)
                    
                    # Disiplin
                    elif any(word in key_lower for word in ['discipline', 'disiplin', 'self_control', 'control']):
                        discipline_score += float(value)
                    
                    # Ã–z-farkÄ±ndalÄ±k
                    elif any(word in key_lower for word in ['self_awareness', 'awareness', 'farkÄ±ndalÄ±k', 'conscious']):
                        awareness_score += float(value)
                
                # EÄŸer hiÃ§ puan bulunamadÄ±ysa default deÄŸerler
                if all(score == 0 for score in [planning_score, procrastination_score, focus_score, time_score, priority_score]):
                    planning_score = 3.4
                    procrastination_score = 2.8
                    focus_score = 3.7
                    time_score = 3.1
                    priority_score = 3.5
                
                # Son format (discipline ve self_awareness isteÄŸe baÄŸlÄ±)
                scores_data = {
                    'planning': planning_score,
                    'procrastination': procrastination_score,
                    'focus_control': focus_score,
                    'time_awareness': time_score,
                    'priority_management': priority_score
                }
                
                # Ek kategoriler varsa ekle
                if discipline_score > 0:
                    scores_data['discipline'] = discipline_score
                if awareness_score > 0:
                    scores_data['self_awareness'] = awareness_score
                
            else:
                # Default deÄŸerler - test tamamlanmÄ±ÅŸsa
                scores_data = {
                    'planning': 3.4, 'procrastination': 2.8, 'focus_control': 3.7,
                    'time_awareness': 3.1, 'priority_management': 3.5
                }
            
            # Verileri dÃ¼zenle (Procrastination ters Ã§evir)
            processed_scores = scores_data.copy()
            processed_scores['procrastination'] = 5 - processed_scores['procrastination']  # Erteleme kontrolÃ¼ olarak gÃ¶ster
            
            # YÃ¼zdeleri hesapla
            total_score = sum(processed_scores.values())
            percentages = {key: (value/total_score)*100 for key, value in processed_scores.items()}
            
            # En yÃ¼ksek skoru bul
            max_category = max(processed_scores, key=processed_scores.get)
            
            # Kategori bilgileri
            category_info = {
                'planning': {
                    'name': 'Planlama Becerisi',
                    'icon': 'ğŸ“‹',
                    'color': '#FF6B6B'
                },
                'procrastination': {
                    'name': 'Erteleme KontrolÃ¼', 
                    'icon': 'â±ï¸',
                    'color': '#4ECDC4'
                },
                'focus_control': {
                    'name': 'Odak KontrolÃ¼',
                    'icon': 'ğŸ¯',
                    'color': '#45B7D1'
                },
                'time_awareness': {
                    'name': 'Zaman Bilinci',
                    'icon': 'â°',
                    'color': '#96CEB4'
                },
                'priority_management': {
                    'name': 'Ã–ncelik YÃ¶netimi',
                    'icon': 'ğŸ“ˆ',
                    'color': '#FECA57'
                },
                'discipline': {
                    'name': 'Disiplin',
                    'icon': 'ğŸ’ª',
                    'color': '#FF7675'
                },
                'self_awareness': {
                    'name': 'Ã–z-farkÄ±ndalÄ±k',
                    'icon': 'ğŸ§˜',
                    'color': '#A29BFE'
                }
            }
            
            dominant_info = category_info[max_category]
            
            st.markdown("---")
            st.markdown(f"## {dominant_info['icon']} **{dominant_info['name']}** - GÃ¼Ã§lÃ¼ YanÄ±nÄ±z!")
            
            # Grafik bÃ¶lÃ¼mÃ¼
            col1, col2 = st.columns([2, 1])
            
            with col1:
                # Pie chart
                fig = px.pie(
                    values=list(percentages.values()),
                    names=[category_info[key]['name'] for key in percentages.keys()],
                    title="â° Zaman YÃ¶netimi Profil DaÄŸÄ±lÄ±mÄ±nÄ±z",
                    color_discrete_sequence=['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FECA57']
                )
                fig.update_traces(textposition='inside', textinfo='percent+label')
                fig.update_layout(
                    height=400,
                    font=dict(size=14),
                    showlegend=True
                )
                safe_plotly_chart(fig, use_container_width=True)
            
            with col2:
                st.markdown("### ğŸ“ˆ Puan DetaylarÄ±")
                
                for key, value in processed_scores.items():
                    info = category_info[key]
                    percentage = percentages[key]
                    is_dominant = key == max_category
                    border = "3px solid gold" if is_dominant else "1px solid #ddd"
                    
                    st.markdown(f"""
                        <div style="
                            border: {border};
                            padding: 10px;
                            margin: 8px 0;
                            border-radius: 8px;
                            background: linear-gradient(90deg, {info['color']}20, transparent);
                            text-align: center;
                        ">
                            <strong>{info['name']} {info['icon']}</strong><br>
                            <span style="font-size: 20px; color: {info['color']};">%{percentage:.1f}</span><br>
                            <small style="color: {info['color']};">({value:.1f}/5 puan)</small>
                        </div>
                    """, unsafe_allow_html=True)
            
            # BaskÄ±n Ã¶zellik aÃ§Ä±klamalarÄ±
            st.markdown("---")
            st.markdown(f"### ğŸ¯ **{dominant_info['name']}** Ã–zellikleri")
            
            time_profiles = {
                'planning': {
                    'description': 'ZamanÄ± planlama ve organize etme beceriniz gÃ¼Ã§lÃ¼.',
                    'strengths': ['Uzun vadeli planlama', 'GÃ¶rev daÄŸÄ±lÄ±mÄ±', 'Takvim yÃ¶netimi', 'Sistematik yaklaÅŸÄ±m'],
                    'study_tips': ['HaftalÄ±k Ã§alÄ±ÅŸma takvimi oluÅŸturun', 'Her gÃ¼n iÃ§in hedefler belirleyin', 'Zaman bloklarÄ± yÃ¶ntemini kullanÄ±n', 'DÃ¼zenli deÄŸerlendirme yapÄ±n']
                },
                'procrastination': {
                    'description': 'Erteleme eÄŸiliminizi kontrol etme beceriniz geliÅŸmiÅŸ.',
                    'strengths': ['Hemen harekete geÃ§me', 'GÃ¶rev odaklÄ±lÄ±k', 'Disiplinli Ã§alÄ±ÅŸma', 'Zaman kaybÄ±nÄ± engelleme'],
                    'study_tips': ['Zor gÃ¶revleri Ã¶nce yapÄ±n', '25 dakika Ã§alÄ±ÅŸ-5 dakika mola tekniÄŸi', 'KÃ¼Ã§Ã¼k adÄ±mlar halinde ilerleyin', 'Ã–dÃ¼l sistemi kuru']
                },
                'focus_control': {
                    'description': 'Dikkatinizi kontrol etme ve odaklanma yeteneÄŸiniz yÃ¼ksek.',
                    'strengths': ['Derin odaklanma', 'Dikkat daÄŸÄ±nÄ±klÄ±ÄŸÄ± Ã¶nleme', 'Konsantrasyon sÃ¼rdÃ¼rme', 'Zihinsel netlik'],
                    'study_tips': ['Sessiz ortamda Ã§alÄ±ÅŸÄ±n', 'Telefonu kapatÄ±n', 'Tek seferde tek konuya odaklanÄ±n', 'Dikkat egzersizleri yapÄ±n']
                },
                'time_awareness': {
                    'description': 'ZamanÄ±n geÃ§iÅŸini hissetme ve takip etme beceriniz geliÅŸmiÅŸ.',
                    'strengths': ['Zaman tahmin etme', 'GÃ¼n yÃ¶netimi', 'Tempolu Ã§alÄ±ÅŸma', 'SÃ¼re farkÄ±ndalÄ±ÄŸÄ±'],
                    'study_tips': ['Kronometre kullanÄ±n', 'Zaman takip uygulamasÄ± edinin', 'GÃ¼nlÃ¼k zaman budÃ§esi yapÄ±n', 'Zaman bloklarÄ± oluÅŸturun']
                },
                'priority_management': {
                    'description': 'Ã–nemli ve acil iÅŸleri ayÄ±rt etme ve Ã¶nceliklendirme beceriniz yÃ¼ksek.',
                    'strengths': ['DoÄŸru Ã¶ncelelikler', 'ZamanlÄ± karar verme', 'Strateji belirme', 'Verimlilik'],
                    'study_tips': ['Eisenhower matrisini kullanÄ±n', 'Ã–nce Ã¶nemli iÅŸleri yapÄ±n', 'GÃ¼nlÃ¼k 3 Ã¶nemli hedef belirleyin', 'HaftalÄ±k deÄŸerlendirme yapÄ±n']
                },
                'discipline': {
                    'description': 'Kendini kontrol etme ve dÃ¼zenli Ã§alÄ±ÅŸma disiplininiz gÃ¼Ã§lÃ¼.',
                    'strengths': ['Kendini kontrol', 'DÃ¼zenli Ã§alÄ±ÅŸma alÄ±ÅŸkanlÄ±klarÄ±', 'Hedeflere baÄŸlÄ±lÄ±k', 'Ä°rade gÃ¼cÃ¼'],
                    'study_tips': ['GÃ¼nlÃ¼k rutin oluÅŸturun', 'KÃ¼Ã§Ã¼k hedeflerle baÅŸlayÄ±n', 'Ä°lerlemeyi takip edin', 'Kendini Ã¶dÃ¼llendirin']
                },
                'self_awareness': {
                    'description': 'Kendi Ã§alÄ±ÅŸma kalÄ±plarÄ±nÄ±zÄ± anlama ve deÄŸerlendirme beceriniz yÃ¼ksek.',
                    'strengths': ['Ã–z-deÄŸerlendirme', 'GÃ¼Ã§lÃ¼/zayÄ±f yanlarÄ± fark etme', 'SÃ¼rekli geliÅŸim', 'Strateji geliÅŸtirme'],
                    'study_tips': ['Ã‡alÄ±ÅŸma gÃ¼nlÃ¼ÄŸÃ¼ tutun', 'HaftalÄ±k analiz yapÄ±n', 'Eksiklikleri belirleyin', 'KiÅŸisel geliÅŸim planÄ± oluÅŸturun']
                }
            }
            
            # GÃ¼venli profil eriÅŸimi
            profile = time_profiles.get(max_category, time_profiles['planning'])  # Planning'i fallback olarak kullan
            st.markdown(profile['description'])
            
            col1, col2 = st.columns(2)
            
            with col1:
                st.markdown("#### ğŸ’ª GÃ¼Ã§lÃ¼ YanlarÄ±nÄ±z")
                for strength in profile['strengths']:
                    st.markdown(f"â€¢ {strength}")
            
            with col2:
                st.markdown("#### ğŸ“š Ã‡alÄ±ÅŸma Ã–nerileriniz")
                for tip in profile['study_tips']:
                    st.markdown(f"â€¢ {tip}")
                    
        except Exception as e:
            st.error(f"Zaman yÃ¶netimi analizi gÃ¶sterilirken hata oluÅŸtu: {str(e)}")
            st.info("â° **Zaman YÃ¶netimi:** Test sonuÃ§larÄ±nÄ±z kaydedildi.")
    else:
        st.warning("âš ï¸ Test sonuÃ§larÄ± yÃ¼klenemedi.")

def display_comprehensive_analysis(completed_tests, user_data):
    """4 testin kapsamlÄ± genel analizi"""
    st.markdown('''
    <div class="comprehensive-analysis">
        <h2>ğŸ¯ KAPSAMLI GENEL PSÄ°KOLOJÄ°K ANALÄ°Z</h2>
        <p>TamamladÄ±ÄŸÄ±nÄ±z testlerin birleÅŸik analizi</p>
    </div>
    ''', unsafe_allow_html=True)
    
    # Genel profil Ã¶zeti
    st.markdown("### ğŸ“‹ Genel Profiliniz")
    
    profile_summary = []
    
    # VAK analizi varsa ekle
    if 'vak' in completed_tests:
        dominant_style = user_data.get('learning_style', 'BelirtilmemiÅŸ')
        profile_summary.append(f"ğŸ¨ **Ã–ÄŸrenme Stili:** {dominant_style}")
    
    # DiÄŸer testlerin sonuÃ§larÄ±
    if 'cognitive' in completed_tests:
        profile_summary.append("ğŸ§  **BiliÅŸsel Profil:** TamamlandÄ±")
    
    if 'motivation' in completed_tests:
        profile_summary.append("âš¡ **Motivasyon Analizi:** TamamlandÄ±")
    
    if 'time' in completed_tests:
        profile_summary.append("â° **Zaman YÃ¶netimi:** TamamlandÄ±")
    
    for item in profile_summary:
        st.markdown(item)
    
    # KiÅŸiselleÅŸtirilmiÅŸ Ã¶neriler
    st.markdown("### ğŸ’¡ Sizin Ä°Ã§in KiÅŸiselleÅŸtirilmiÅŸ Ã–neriler")
    
    recommendations = []
    
    if 'vak' in completed_tests:
        dominant_style = user_data.get('learning_style', '')
        if dominant_style == 'GÃ¶rsel':
            recommendations.extend([
                "ğŸ“š Ã‡alÄ±ÅŸÄ±rken renkli kalemler ve iÅŸaretleyiciler kullanÄ±n",
                "ğŸ—‚ï¸ Bilgileri ÅŸema ve tablolar halinde organize edin",
                "ğŸ¯ Hedeflerinizi gÃ¶rsel olarak motive edici resimlerle destekleyin"
            ])
        elif dominant_style == 'Ä°ÅŸitsel':
            recommendations.extend([
                "ğŸµ Ã‡alÄ±ÅŸÄ±rken hafif fon mÃ¼ziÄŸi dinleyin",
                "ğŸ‘¥ ArkadaÅŸlarÄ±nÄ±zla tartÄ±ÅŸma gruplarÄ± oluÅŸturun",
                "ğŸ“¢ Ã–nemli bilgileri kendi sesinizle kaydedin ve dinleyin"
            ])
        elif dominant_style == 'Kinestetik':
            recommendations.extend([
                "ğŸš¶ Ders Ã§alÄ±ÅŸÄ±rken ara sÄ±ra ayaÄŸa kalkÄ±n ve yÃ¼rÃ¼yÃ¼n",
                "âœï¸ Ã–nemli formÃ¼lleri kaÄŸÄ±da elle yazÄ±n",
                "ğŸƒ Ã‡alÄ±ÅŸma aralarÄ±nda kÄ±sa fiziksel aktiviteler yapÄ±n"
            ])
    
    # Genel Ã¶neriler ekle
    if len(completed_tests) >= 3:
        recommendations.extend([
            "ğŸ“ˆ Test sonuÃ§larÄ±nÄ±za gÃ¶re kiÅŸiselleÅŸtirilmiÅŸ Ã§alÄ±ÅŸma planÄ± oluÅŸturun",
            "ğŸ¯ GÃ¼Ã§lÃ¼ yanlarÄ±nÄ±zÄ± destekleyecek Ã§alÄ±ÅŸma teknikleri kullanÄ±n",
            "âš–ï¸ ZayÄ±f yanlarÄ±nÄ±zÄ± geliÅŸtirici aktivitelere zaman ayÄ±rÄ±n"
        ])
    
    for rec in recommendations:
        st.markdown(f"â€¢ {rec}")
    
    # BaÅŸarÄ± takvimi Ã¶nerisi
    st.markdown("### ğŸ“… Ã–nerilen HaftalÄ±k Ã‡alÄ±ÅŸma ProgramÄ±")
    st.info("ğŸ¯ Test sonuÃ§larÄ±nÄ±za gÃ¶re Ã¶zelleÅŸtirilmiÅŸ haftalÄ±k program oluÅŸturma Ã¶zelliÄŸi yakÄ±nda eklenecek!")

def display_test_reset_section(test_configs, user_data, completed_tests):
    """Test sÄ±fÄ±rlama bÃ¶lÃ¼mÃ¼"""
    st.markdown('''
    <div class="reset-section">
        <h3>ğŸ”„ Test YÃ¶netim Merkezi</h3>
        <p>Test sonuÃ§larÄ±nÄ±zÄ± gÃ¶rÃ¼ntÃ¼leyebilir, deÄŸiÅŸtirebilir veya sÄ±fÄ±rlayabilirsiniz.</p>
    </div>
    ''', unsafe_allow_html=True)
    
    st.warning("âš ï¸ **Ã–nemli:** Test sonuÃ§larÄ±nÄ± sÄ±fÄ±rladÄ±ÄŸÄ±nÄ±zda ilgili verileriniz silinecek ve testleri yeniden yapmanÄ±z gerekecektir.")
    
    # Her tamamlanmÄ±ÅŸ test iÃ§in yÃ¶netim seÃ§enekleri
    for test in test_configs:
        if test['id'] in completed_tests:
            col1, col2, col3, col4 = st.columns([2, 1, 1, 1])
            
            with col1:
                st.markdown(f"**{test['icon']} {test['title']}**")
                st.markdown(f"<small>{test['description'][:50]}...</small>", unsafe_allow_html=True)
            
            with col2:
                if st.button(f"ğŸ“ DeÄŸiÅŸtir", key=f"change_mgmt_{test['id']}", use_container_width=True):
                    # Test deÄŸiÅŸtirme sayfasÄ±na yÃ¶nlendir
                    if test['id'] == 'vak':
                        st.session_state.page = "ğŸ¨ Ã–ÄŸrenme Stilleri Testi"
                    elif test['id'] == 'cognitive':
                        st.session_state.page = "ğŸ§  BiliÅŸsel Profil Testi"
                    elif test['id'] == 'motivation':
                        st.session_state.page = "âš¡ Motivasyon & Duygu Testi"
                    elif test['id'] == 'time':
                        st.session_state.page = "â° Zaman YÃ¶netimi Testi"
                    st.rerun()
            
            with col3:
                if st.button(f"ğŸ”„ SÄ±fÄ±rla", key=f"reset_{test['id']}", use_container_width=True):
                    st.session_state[f'confirm_reset_{test["id"]}'] = True
                    st.rerun()
            
            with col4:
                if st.button(f"ğŸ‘ï¸ GÃ¶rÃ¼ntÃ¼le", key=f"view_{test['id']}", use_container_width=True):
                    st.session_state[f'show_{test["id"]}_analysis'] = True
                    st.rerun()
            
            # Onay dialogu
            if st.session_state.get(f'confirm_reset_{test["id"]}', False):
                st.error(f"âš ï¸ **{test['title']}** sonuÃ§larÄ±nÄ± silmek istediÄŸinizden emin misiniz?")
                
                col_a, col_b = st.columns(2)
                with col_a:
                    if st.button(f"âœ… Evet, Sil", key=f"confirm_delete_{test['id']}", type="primary"):
                        # Test verilerini sÄ±fÄ±rla
                        reset_data = {}
                        reset_data[test['data_key']] = ''
                        for key in test['related_keys']:
                            reset_data[key] = ''
                        
                        # Firebase'de gÃ¼ncelle
                        if update_user_in_firebase(st.session_state.current_user, reset_data):
                            st.success(f"âœ… {test['title']} sonuÃ§larÄ± baÅŸarÄ±yla silindi!")
                            # Session state'i temizle
                            for key in [f'confirm_reset_{test["id"]}', f'show_{test["id"]}_analysis']:
                                if key in st.session_state:
                                    del st.session_state[key]
                            st.rerun()
                        else:
                            st.error("âŒ Silme iÅŸlemi baÅŸarÄ±sÄ±z!")
                
                with col_b:
                    if st.button(f"âŒ Ä°ptal", key=f"cancel_delete_{test['id']}"):
                        del st.session_state[f'confirm_reset_{test["id"]}']
                        st.rerun()

# ===== TEST FONKSÄ°YONLARI =====

def run_vak_learning_styles_test():
    """Modern VAK Ã–ÄŸrenme Stilleri Testi - DetaylÄ± analiz ve Ã¶ÄŸretmen rehberi ile"""
    
    # Ana menÃ¼ye dÃ¶n butonu
    if st.button("ğŸ  Ana MenÃ¼ye DÃ¶n", key="back_to_main_vak"):
        if 'page' in st.session_state:
            del st.session_state.page
        st.rerun()
    
    st.markdown("---")
    
    # Modern CSS stilini ekle
    st.markdown("""
    <style>
    .test-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 15px;
        text-align: center;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    .category-section {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        padding: 1rem;
        border-radius: 10px;
        margin: 1.5rem 0;
        text-align: center;
        font-weight: bold;
    }
    .question-box {
        background: #ffffff;
        color: #333333;
        border-left: 4px solid #667eea;
        padding: 1.5rem;
        margin: 1rem 0;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        border: 1px solid #e0e6ed;
    }
    .question-text {
        color: #2c3e50;
        font-size: 16px;
        font-weight: 500;
        margin-bottom: 1rem;
        line-height: 1.5;
    }
    .likert-info {
        background: #f8f9fa;
        color: #495057;
        padding: 1rem;
        border-radius: 8px;
        margin: 1rem 0;
        border-left: 4px solid #17a2b8;
        font-size: 14px;
    }
    .result-box {
        background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        padding: 2rem;
        border-radius: 15px;
        margin: 2rem 0;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    </style>
    """, unsafe_allow_html=True)
    
    # BaÅŸlÄ±k
    st.markdown("""
    <div class="test-header">
        <h1>ğŸ¨ Ã–ÄŸrenme Stilleri Testi (VAK)</h1>
        <p>GÃ¶rsel, Ä°ÅŸitsel ve Kinestetik Ã¶ÄŸrenme stillerinizi keÅŸfedin</p>
        <p><strong>ğŸ“‹ 75 soru | ğŸ¯ 1-5 Likert Ã–lÃ§eÄŸi | ğŸ†• 2025 GÃ¼ncel Versiyonu</strong></p>
    </div>
    """, unsafe_allow_html=True)
    
    # Test aÃ§Ä±klamasÄ±
    st.markdown("""
    ### ğŸ“– Test HakkÄ±nda
    Bu testte **doÄŸru ya da yanlÄ±ÅŸ cevap yoktur**. Her maddenin sizin iÃ§in ne kadar geÃ§erli olduÄŸunu 1-5 arasÄ±nda deÄŸerlendirin.
    
    **ğŸ¯ Kategoriler:**
    - **A Kategorisi**: GÃ¶rsel Ã–ÄŸrenme Stili (25 soru)
    - **B Kategorisi**: Ä°ÅŸitsel Ã–ÄŸrenme Stili (25 soru) 
    - **C Kategorisi**: Kinestetik Ã–ÄŸrenme Stili (25 soru)
    
    **ğŸ†• 2025 YÄ±lÄ± GÃ¼ncellemesi**: Bu yÄ±l eklenen 15 yeni soru ile modern Ã¶ÄŸrenme alÄ±ÅŸkanlÄ±klarÄ±nÄ±zÄ± daha iyi analiz ediyoruz!
    """)
    
    # Likert Ã¶lÃ§eÄŸi aÃ§Ä±klamasÄ±
    st.markdown("""
    <div class="likert-info">
        <strong>ğŸ“ DeÄŸerlendirme Ã–lÃ§eÄŸi:</strong><br>
        <strong>1 = HiÃ§ katÄ±lmÄ±yorum</strong> | 
        <strong>2 = KatÄ±lmÄ±yorum</strong> | 
        <strong>3 = KararsÄ±zÄ±m</strong> | 
        <strong>4 = KatÄ±lÄ±yorum</strong> | 
        <strong>5 = Tamamen katÄ±lÄ±yorum</strong>
    </div>
    """, unsafe_allow_html=True)
    
    # Test formunu baÅŸlat
    with st.form("vak_test_form"):
        user_data = get_user_data()
        existing_results_raw = user_data.get('vak_test_results', '{}')
        
        # JSON string ise parse et, deÄŸilse dict olarak kullan
        if isinstance(existing_results_raw, str):
            try:
                existing_results = json.loads(existing_results_raw)
            except:
                existing_results = {}
        else:
            existing_results = existing_results_raw
        
        # A Kategorisi sorularÄ±
        st.markdown('<div class="category-section">ğŸ‘ï¸ A KATEGORÄ°SÄ° - GÃ–RSEL Ã–ÄRENME STÄ°LÄ°</div>', unsafe_allow_html=True)
        
        a_responses = {}
        a_questions = [q for q in VAK_LEARNING_STYLES_TEST if q['category'] == 'A']
        
        for i, question in enumerate(a_questions):
            question_key = f"A_{i+1}"
            default_value = existing_results.get(question_key, 3)  # Default: KararsÄ±zÄ±m
            
            st.markdown(f"""
            <div class="question-box">
                <div class="question-text">A{i+1}. {question["question"]}</div>
            </div>
            """, unsafe_allow_html=True)
            
            a_responses[question_key] = st.select_slider(
                f"A{i+1} - DeÄŸerlendirmeniz:",
                options=[1, 2, 3, 4, 5],
                value=default_value,
                key=question_key,
                format_func=lambda x: {
                    1: "1 - HiÃ§ katÄ±lmÄ±yorum",
                    2: "2 - KatÄ±lmÄ±yorum", 
                    3: "3 - KararsÄ±zÄ±m",
                    4: "4 - KatÄ±lÄ±yorum",
                    5: "5 - Tamamen katÄ±lÄ±yorum"
                }[x]
            )
        
        # B Kategorisi sorularÄ±
        st.markdown('<div class="category-section">ğŸ‘‚ B KATEGORÄ°SÄ° - Ä°ÅÄ°TSEL Ã–ÄRENME STÄ°LÄ°</div>', unsafe_allow_html=True)
        
        b_responses = {}
        b_questions = [q for q in VAK_LEARNING_STYLES_TEST if q['category'] == 'B']
        
        for i, question in enumerate(b_questions):
            question_key = f"B_{i+1}"
            default_value = existing_results.get(question_key, 3)  # Default: KararsÄ±zÄ±m
            
            st.markdown(f"""
            <div class="question-box">
                <div class="question-text">B{i+1}. {question["question"]}</div>
            </div>
            """, unsafe_allow_html=True)
            
            b_responses[question_key] = st.select_slider(
                f"B{i+1} - DeÄŸerlendirmeniz:",
                options=[1, 2, 3, 4, 5],
                value=default_value,
                key=question_key,
                format_func=lambda x: {
                    1: "1 - HiÃ§ katÄ±lmÄ±yorum",
                    2: "2 - KatÄ±lmÄ±yorum", 
                    3: "3 - KararsÄ±zÄ±m",
                    4: "4 - KatÄ±lÄ±yorum",
                    5: "5 - Tamamen katÄ±lÄ±yorum"
                }[x]
            )
        
        # C Kategorisi sorularÄ±
        st.markdown('<div class="category-section">âœ‹ C KATEGORÄ°SÄ° - KÄ°NESTETÄ°K Ã–ÄRENME STÄ°LÄ°</div>', unsafe_allow_html=True)
        
        c_responses = {}
        c_questions = [q for q in VAK_LEARNING_STYLES_TEST if q['category'] == 'C']
        
        for i, question in enumerate(c_questions):
            question_key = f"C_{i+1}"
            default_value = existing_results.get(question_key, 3)  # Default: KararsÄ±zÄ±m
            
            st.markdown(f"""
            <div class="question-box">
                <div class="question-text">C{i+1}. {question["question"]}</div>
            </div>
            """, unsafe_allow_html=True)
            
            c_responses[question_key] = st.select_slider(
                f"C{i+1} - DeÄŸerlendirmeniz:",
                options=[1, 2, 3, 4, 5],
                value=default_value,
                key=question_key,
                format_func=lambda x: {
                    1: "1 - HiÃ§ katÄ±lmÄ±yorum",
                    2: "2 - KatÄ±lmÄ±yorum", 
                    3: "3 - KararsÄ±zÄ±m",
                    4: "4 - KatÄ±lÄ±yorum",
                    5: "5 - Tamamen katÄ±lÄ±yorum"
                }[x]
            )
        
        # Test sonuÃ§larÄ±nÄ± hesapla ve kaydet
        if st.form_submit_button("ğŸ¯ Testi DeÄŸerlendir", type="primary", use_container_width=True):
            # Bilimsel puanlama sistemi (1-5 Likert Ã¶lÃ§eÄŸi)
            # Her kategori iÃ§in ortalama puan hesapla
            a_score = sum(a_responses.values()) / len(a_responses) if a_responses else 0
            b_score = sum(b_responses.values()) / len(b_responses) if b_responses else 0  
            c_score = sum(c_responses.values()) / len(c_responses) if c_responses else 0
            
            # Toplam puan ve yÃ¼zdelik hesaplama
            total_score = a_score + b_score + c_score
            
            if total_score > 0:
                a_percentage = (a_score / total_score) * 100
                b_percentage = (b_score / total_score) * 100
                c_percentage = (c_score / total_score) * 100
            else:
                a_percentage = b_percentage = c_percentage = 33.33
            
            # BaskÄ±n Ã¶ÄŸrenme stilini belirle
            scores = {
                'GÃ¶rsel': (a_score, a_percentage),
                'Ä°ÅŸitsel': (b_score, b_percentage), 
                'Kinestetik': (c_score, c_percentage)
            }
            
            # En yÃ¼ksek puanÄ± bul
            dominant_style = max(scores.keys(), key=lambda k: scores[k][0])
            
            # SonuÃ§larÄ± birleÅŸtir
            all_responses = {**a_responses, **b_responses, **c_responses}
            
            # VeritabanÄ±na kaydet - Hem eski hem yeni field isimleri
            update_user_in_firebase(st.session_state.current_user, {
                'vak_test_results': json.dumps(all_responses),
                'learning_style': dominant_style,
                'learning_style_scores': json.dumps({
                    'visual': a_percentage,
                    'auditory': b_percentage,
                    'kinesthetic': c_percentage
                }),
                'vak_test_scores': json.dumps({
                    'A_score': a_score,
                    'B_score': b_score, 
                    'C_score': c_score,
                    'A_percentage': a_percentage,
                    'B_percentage': b_percentage,
                    'C_percentage': c_percentage,
                    'dominant_style': dominant_style
                }),
                'vak_test_completed': 'True'
            })
            
            # ğŸš€ OPTÄ°MÄ°ZE: update_user_in_firebase() zaten session state'i gÃ¼nceller
            
            # SonuÃ§larÄ± gÃ¶ster
            st.markdown('<div class="result-box">', unsafe_allow_html=True)
            st.markdown("## ğŸ‰ VAK Ã–ÄŸrenme Stilleri Test SonuÃ§larÄ±nÄ±z")
            
            # Puanlar ve yÃ¼zdeler
            col1, col2, col3 = st.columns(3)
            
            with col1:
                st.metric("ğŸ‘ï¸ GÃ–RSEL Ã–ÄRENME", 
                         f"{a_score:.2f}/5.00", 
                         f"%{a_percentage:.1f}")
            with col2:
                st.metric("ğŸ‘‚ Ä°ÅÄ°TSEL Ã–ÄRENME", 
                         f"{b_score:.2f}/5.00", 
                         f"%{b_percentage:.1f}") 
            with col3:
                st.metric("âœ‹ KÄ°NESTETÄ°K Ã–ÄRENME", 
                         f"{c_score:.2f}/5.00", 
                         f"%{c_percentage:.1f}")
            
            st.markdown("---")
            st.markdown(f"## ğŸ† BaskÄ±n Ã–ÄŸrenme Stiliniz: **{dominant_style.upper()}**")
            
            # DetaylÄ± Ã¶ÄŸrenme stili analizi ve modern Ã¶neriler
            display_modern_vak_analysis(dominant_style, a_percentage, b_percentage, c_percentage)
            
            # Ã–ÄŸretmen rehberi bÃ¶lÃ¼mÃ¼
            display_teacher_guide_section(dominant_style)
            
            # GeliÅŸmiÅŸ Ã§alÄ±ÅŸma teknikleri
            display_advanced_study_techniques(dominant_style)
            
            st.markdown('</div>', unsafe_allow_html=True)
            
            st.success("âœ… Test sonuÃ§larÄ±nÄ±z kaydedildi!")

def run_cognitive_profile_test():
    """BiliÅŸsel Profil Testi - 20 soru (Likert 1-5)"""
    
    # Ana menÃ¼ye dÃ¶n butonu
    if st.button("ğŸ  Ana MenÃ¼ye DÃ¶n", key="back_to_main_cognitive"):
        if 'page' in st.session_state:
            del st.session_state.page
        st.rerun()
    
    st.markdown("---")
    
    # Modern CSS stilini ekle ve metin gÃ¶rÃ¼nÃ¼rlÃ¼k sorunu iÃ§in css ekle
    st.markdown("""
    <style>
    body {
        color: black !important;
    }
    .stMarkdown {
        color: black !important;
    }
    .cognitive-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 15px;
        text-align: center;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    .section-header {
        background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        color: #333;
        padding: 1rem;
        border-radius: 10px;
        margin: 1.5rem 0;
        text-align: center;
        font-weight: bold;
    }
    .cognitive-question {
        background: #f8f9ff;
        border-left: 4px solid #667eea;
        padding: 1rem;
        margin: 0.5rem 0;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .cognitive-result {
        background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        padding: 2rem;
        border-radius: 15px;
        margin: 2rem 0;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    .likert-scale {
        display: flex;
        justify-content: space-between;
        margin: 1rem 0;
        padding: 0.5rem;
        background: #f0f2f6;
        border-radius: 8px;
    }
    </style>
    """, unsafe_allow_html=True)
    
    # BaÅŸlÄ±k
    st.markdown("""
    <div class="cognitive-header">
        <h1>ğŸ§  BiliÅŸsel Profil Testi</h1>
        <p>DÃ¼ÅŸÃ¼nme stilinizi, motivasyon kaynaÄŸÄ±nÄ±zÄ± ve problem Ã§Ã¶zme yaklaÅŸÄ±mÄ±nÄ±zÄ± keÅŸfedin</p>
        <p><strong>ğŸ“‹ 20 soru | ğŸ¯ 1-5 arasÄ± puanlama</strong></p>
    </div>
    """, unsafe_allow_html=True)
    
    # Test aÃ§Ä±klamasÄ±
    st.markdown("""
    ### ğŸ”¬ Test HakkÄ±nda
    Bu test **4 ana boyutta** biliÅŸsel profilinizi analiz eder:
    
    ğŸ”¬ **BiliÅŸsel Ä°ÅŸleme Stili** - Bilgiyi nasÄ±l iÅŸliyorsunuz?  
    âš¡ **Motivasyon & Duygusal Stil** - Neyin sizi motive ettiÄŸi  
    ğŸ” **Problem Ã‡Ã¶zme YaklaÅŸÄ±mÄ±** - Zorluklarla nasÄ±l baÅŸa Ã§Ä±ktÄ±ÄŸÄ±nÄ±z  
    ğŸ’¾ **HafÄ±za & PekiÅŸtirme TarzÄ±** - Bilgiyi nasÄ±l sakladÄ±ÄŸÄ±nÄ±z  
    
    **Puanlama:** 1 = HiÃ§ uymuyor, 5 = Tamamen uyuyor
    """)
    
    # Test formunu baÅŸlat
    with st.form("cognitive_test_form"):
        user_data = get_user_data()
        existing_results_raw = user_data.get('cognitive_test_results', {})
        
        # JSON string ise parse et, dict ise direkt kullan
        if isinstance(existing_results_raw, str):
            try:
                existing_results = json.loads(existing_results_raw)
            except (json.JSONDecodeError, TypeError):
                existing_results = {}
        else:
            existing_results = existing_results_raw if isinstance(existing_results_raw, dict) else {}
        
        responses = {}
        
        # BÃ¶lÃ¼mlere gÃ¶re sorularÄ± grupla
        sections = {}
        for question in COGNITIVE_PROFILE_TEST:
            section = question['section']
            if section not in sections:
                sections[section] = []
            sections[section].append(question)
        
        # Her bÃ¶lÃ¼m iÃ§in sorularÄ± gÃ¶ster
        for section_name, questions in sections.items():
            st.markdown(f'<div class="section-header">{section_name}</div>', unsafe_allow_html=True)
            
            for i, question in enumerate(questions):
                question_key = f"{question['category']}_{i}"
                default_value = existing_results.get(question_key, 3)
                
                st.markdown(f'<div class="cognitive-question">{question["question"]}</div>', unsafe_allow_html=True)
                
                # Likert scale slider
                responses[question_key] = st.slider(
                    "DeÄŸerlendirme",
                    min_value=1,
                    max_value=5,
                    value=default_value,
                    key=question_key,
                    help="1 = HiÃ§ uymuyor, 5 = Tamamen uyuyor",
                    label_visibility="collapsed"
                )
                
                # AÃ§Ä±klama metni
                col1, col2, col3 = st.columns([1, 3, 1])
                with col1:
                    st.caption("HiÃ§ uymuyor")
                with col2:
                    st.caption("")
                with col3:
                    st.caption("Tamamen uyuyor")
                
                st.markdown("---")
        
        # Test sonuÃ§larÄ±nÄ± hesapla ve kaydet
        if st.form_submit_button("ğŸ¯ Testi DeÄŸerlendir", type="primary", use_container_width=True):
            # Kategorilere gÃ¶re puanlarÄ± hesapla
            category_scores = {}
            
            for question_key, score in responses.items():
                # Ä°lgili soruyu bul
                for question in COGNITIVE_PROFILE_TEST:
                    if question_key.startswith(question['category']):
                        category = question['category']
                        if category not in category_scores:
                            category_scores[category] = []
                        category_scores[category].append(score)
                        break
            
            # Ortalama puanlarÄ± hesapla
            average_scores = {}
            for category, scores in category_scores.items():
                average_scores[category] = sum(scores) / len(scores)
            
            # VeritabanÄ±na kaydet
            update_user_in_firebase(st.session_state.current_user, {
                'cognitive_test_results': json.dumps(responses),
                'cognitive_test_scores': json.dumps(average_scores),
                'cognitive_test_completed': 'True'
            })
            
            # ğŸš€ OPTÄ°MÄ°ZE: update_user_in_firebase() zaten session state'i gÃ¼nceller
            
            # SonuÃ§larÄ± gÃ¶ster
            st.markdown('<div class="cognitive-result">', unsafe_allow_html=True)
            st.markdown("## ğŸ‰ BiliÅŸsel Profil SonuÃ§larÄ±nÄ±z")
            
            # SonuÃ§larÄ± gÃ¶rselleÅŸtir
            col1, col2 = st.columns(2)
            
            with col1:
                st.markdown("### ğŸ“Š PuanlarÄ±nÄ±z")
                for category, score in average_scores.items():
                    # Kategori isimlerini TÃ¼rkÃ§e'ye Ã§evir
                    if 'analytic' in category:
                        display_name = "ğŸ”¬ Analitik DÃ¼ÅŸÃ¼nme"
                    elif 'synthetic' in category:
                        display_name = "ğŸ¨ Sintetik DÃ¼ÅŸÃ¼nme"
                    elif 'reflective' in category:
                        display_name = "ğŸ§˜ Reflektif DÃ¼ÅŸÃ¼nme"
                    elif 'external' in category:
                        display_name = "âš¡ DÄ±ÅŸsal Motivasyon"
                    elif 'internal' in category:
                        display_name = "ğŸ§â€â™‚ï¸ Ä°Ã§sel Motivasyon"
                    elif 'methodic' in category:
                        display_name = "ğŸ“Š Metodik Problem Ã‡Ã¶zme"
                    elif 'experimental' in category:
                        display_name = "ğŸ’¡ Deneysel Problem Ã‡Ã¶zme"
                    elif 'social' in category:
                        display_name = "ğŸ—£ï¸ Sosyal Problem Ã‡Ã¶zme"
                    elif 'visual' in category:
                        display_name = "ğŸ‘ GÃ¶rsel HafÄ±za"
                    elif 'auditory' in category:
                        display_name = "ğŸ‘‚ Ä°ÅŸitsel HafÄ±za"
                    elif 'experiential' in category:
                        display_name = "âœ‹ Deneyimsel HafÄ±za"
                    elif 'analytic' in category:
                        display_name = "ğŸ“– Analitik HafÄ±za"
                    else:
                        display_name = category
                    
                    st.metric(display_name, f"{score:.1f}/5")
            
            with col2:
                st.markdown("### ğŸ¯ YKS Ä°Ã§in Ã–neriler")
                
                # En yÃ¼ksek puanlarÄ± bul ve Ã¶nerilerde bulun
                max_categories = [k for k, v in average_scores.items() if v == max(average_scores.values())]
                
                if any('analytic' in cat for cat in max_categories):
                    st.info("ğŸ“Š **Analitik yapÄ±nÄ±z gÃ¼Ã§lÃ¼:** DÃ¼zenli Ã§alÄ±ÅŸma planlarÄ± ve aÅŸama aÅŸama Ã¶ÄŸrenme size uygun!")
                    
                if any('synthetic' in cat for cat in max_categories):
                    st.info("ğŸ¨ **BÃ¼tÃ¼ncÃ¼l bakÄ±ÅŸ aÃ§Ä±nÄ±z gÃ¼Ã§lÃ¼:** Kavram haritalarÄ± ve genel resmi gÃ¶rme yaklaÅŸÄ±mlarÄ± size uygun!")
                    
                if any('external' in cat for cat in max_categories):
                    st.info("ğŸ† **DÄ±ÅŸsal motivasyon:** Hedef koyma, Ã¶dÃ¼l sistemi ve rekabet size enerji verir!")
                    
                if any('internal' in cat for cat in max_categories):
                    st.info("ğŸ’« **Ä°Ã§sel motivasyon:** Ä°lginizi Ã§eken konulardan baÅŸlayÄ±n, merak duygusu size gÃ¼Ã§ verir!")
                    
                if any('methodic' in cat for cat in max_categories):
                    st.info("ğŸ“‹ **Sistematik yaklaÅŸÄ±m:** AdÄ±m adÄ±m planlar ve dÃ¼zenli tekrarlar size uygun!")
                    
                if any('experimental' in cat for cat in max_categories):
                    st.info("ğŸ”¬ **Deneyimsel Ã¶ÄŸrenme:** Bol soru Ã§Ã¶zÃ¼mÃ¼ ve pratik uygulamalar size uygun!")
            
            st.markdown('</div>', unsafe_allow_html=True)
            
            st.success("âœ… BiliÅŸsel profil sonuÃ§larÄ±nÄ±z kaydedildi!")

def run_motivation_emotional_test():
    """Motivasyon & Duygusal Denge Testi - 10 soru (Likert 1-5)"""
    
    # Ana menÃ¼ye dÃ¶n butonu
    if st.button("ğŸ  Ana MenÃ¼ye DÃ¶n", key="back_to_main_motivation"):
        if 'page' in st.session_state:
            del st.session_state.page
        st.rerun()
    
    st.markdown("---")
    
    # CSS stilini ekle ve metin gÃ¶rÃ¼nÃ¼rlÃ¼k sorunu iÃ§in css ekle
    st.markdown("""
    <style>
    body {
        color: black !important;
    }
    .stMarkdown {
        color: black !important;
    }
    .motivation-header {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        color: white;
        padding: 2rem;
        border-radius: 15px;
        text-align: center;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    .motivation-question {
        background: #fff5f5;
        border-left: 4px solid #ff6b6b;
        padding: 1rem;
        margin: 0.5rem 0;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .motivation-result {
        background: linear-gradient(135deg, #ff9999 0%, #ffcccc 100%);
        padding: 2rem;
        border-radius: 15px;
        margin: 2rem 0;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    </style>
    """, unsafe_allow_html=True)
    
    # BaÅŸlÄ±k
    st.markdown("""
    <div class="motivation-header">
        <h1>âš¡ Motivasyon & Duygusal Denge Testi</h1>
        <p>Motivasyon kaynaÄŸÄ±nÄ±zÄ±, kaygÄ± dÃ¼eyinizi ve duygusal dayanÄ±klÄ±lÄ±ÄŸÄ±nÄ±zÄ± keÅŸedin</p>
        <p><strong>ğŸ“‹ 10 soru | ğŸ¯ 1-5 arasÄ± puanlama</strong></p>
    </div>
    """, unsafe_allow_html=True)
    
    # Test aÃ§Ä±klamasÄ±
    st.markdown("""
    ### ğŸ”¬ Test HakkÄ±nda
    Bu test **4 ana boyutta** motivasyon ve duygusal profilinizi analiz eder:
    
    ğŸ’« **Ä°Ã§sel Motivasyon** - Ã–ÄŸrenme sÃ¼recinden zevk alma  
    ğŸ† **DÄ±ÅŸsal Motivasyon** - Harici Ã¶dÃ¼l ve takdir arayÄ±ÅŸÄ±  
    ğŸ˜° **SÄ±nav KaygÄ±sÄ±** - Performans kaygÄ±sÄ± ve stres dÃ¼zeyi  
    ğŸ’ª **Duygusal DayanÄ±klÄ±lÄ±k** - Zorluklarla baÅŸa Ã§Ä±kma kapasitesi  
    
    **Puanlama:** 1 = HiÃ§ katÄ±lmÄ±yorum, 5 = Tamamen katÄ±lÄ±yorum
    """)
    
    # Test formunu baÅŸlat
    with st.form("motivation_test_form"):
        user_data = get_user_data()
        existing_results_raw = user_data.get('motivation_test_results', {})
        
        # JSON string ise parse et, dict ise direkt kullan
        if isinstance(existing_results_raw, str):
            try:
                existing_results = json.loads(existing_results_raw)
            except (json.JSONDecodeError, TypeError):
                existing_results = {}
        else:
            existing_results = existing_results_raw if isinstance(existing_results_raw, dict) else {}
        
        responses = {}
        
        # Soru sayÄ±sÄ±nÄ± takip et
        for i, question in enumerate(MOTIVATION_EMOTIONAL_TEST):
            question_key = f"motivation_{i+1}"
            default_value = existing_results.get(question_key, 3)
            
            st.markdown(f'<div class="motivation-question">{i+1}. {question["question"]}</div>', unsafe_allow_html=True)
            
            # Likert scale slider
            responses[question_key] = st.select_slider(
                f"Soru {i+1} - DeÄŸerlendirmeniz:",
                options=[1, 2, 3, 4, 5],
                value=default_value,
                key=question_key,
                format_func=lambda x: {
                    1: "1 - HiÃ§ katÄ±lmÄ±yorum",
                    2: "2 - KatÄ±lmÄ±yorum", 
                    3: "3 - KararsÄ±zÄ±m",
                    4: "4 - KatÄ±lÄ±yorum",
                    5: "5 - Tamamen katÄ±lÄ±yorum"
                }[x]
            )
            st.markdown("---")
        
        # Test sonuÃ§larÄ±nÄ± hesapla ve kaydet
        if st.form_submit_button("ğŸ¯ Testi DeÄŸerlendir", type="primary", use_container_width=True):
            # Kategorilere gÃ¶re puanlarÄ± hesapla
            category_scores = {
                'internal_motivation': [],
                'external_motivation': [],
                'test_anxiety': [],
                'emotional_resilience': []
            }
            
            for i, question in enumerate(MOTIVATION_EMOTIONAL_TEST):
                question_key = f"motivation_{i+1}"
                score = responses[question_key]
                category = question['category']
                category_scores[category].append(score)
            
            # Ortalama puanlarÄ± hesapla
            average_scores = {}
            for category, scores in category_scores.items():
                if scores:
                    average_scores[category] = sum(scores) / len(scores)
                else:
                    average_scores[category] = 0
            
            # VeritabanÄ±na kaydet
            update_user_in_firebase(st.session_state.current_user, {
                'motivation_test_results': json.dumps(responses),
                'motivation_test_scores': json.dumps(average_scores),
                'motivation_test_completed': 'True'
            })
            
            # ğŸš€ OPTÄ°MÄ°ZE: update_user_in_firebase() zaten session state'i gÃ¼nceller
            
            # SonuÃ§larÄ± gÃ¶ster
            st.markdown('<div class="motivation-result">', unsafe_allow_html=True)
            st.markdown("## ğŸ‰ Motivasyon & Duygusal Denge SonuÃ§larÄ±nÄ±z")
            
            # SonuÃ§larÄ± gÃ¶rselleÅŸtir
            col1, col2 = st.columns(2)
            
            with col1:
                st.markdown("### ğŸ“‹ PuanlarÄ±nÄ±z")
                st.metric("ğŸ’« Ä°Ã§sel Motivasyon", f"{average_scores['internal_motivation']:.1f}/5")
                st.metric("ğŸ† DÄ±ÅŸsal Motivasyon", f"{average_scores['external_motivation']:.1f}/5")
                st.metric("ğŸ˜° SÄ±nav KaygÄ±sÄ±", f"{average_scores['test_anxiety']:.1f}/5")
                st.metric("ğŸ’ª Duygusal DayanÄ±klÄ±lÄ±k", f"{average_scores['emotional_resilience']:.1f}/5")
            
            with col2:
                st.markdown("### ğŸ¯ YKS Ä°Ã§in Ã–neriler")
                
                # En yÃ¼ksek motivasyon tÃ¼rÃ¼nÃ¼ bul
                if average_scores['internal_motivation'] > average_scores['external_motivation']:
                    st.info("ğŸ’« **Ä°Ã§sel motivasyon baskÄ±n:** Merak ettiÄŸiniz konulardan baÅŸlayÄ±n, Ã¶ÄŸrenme zevkini Ã¶ne Ã§Ä±karÄ±n!")
                else:
                    st.info("ğŸ† **DÄ±ÅŸsal motivasyon baskÄ±n:** Hedefler koyun, Ã¶dÃ¼l sistemi oluÅŸturun, rekabet size enerji verir!")
                
                # KaygÄ± dÃ¼rzeyine gÃ¶re Ã¶neri
                if average_scores['test_anxiety'] >= 3.5:
                    st.warning("âš ï¸ **YÃ¼ksek kaygÄ± dÃ¼zeyi:** Nefes egzersizleri, planlama ve simulation sÄ±navlarÄ± kaygÄ±nÄ±zÄ± azaltabilir.")
                elif average_scores['test_anxiety'] <= 2.5:
                    st.success("âœ… **DÃ¼ÅŸÃ¼k kaygÄ± dÃ¼zeyi:** Harika! Bu avantajÄ±nÄ±zÄ± koruyun ve performansÄ±nÄ±za odaklanÄ±n.")
                
                # DayanÄ±klÄ±lÄ±k durumuna gÃ¶re Ã¶neri
                if average_scores['emotional_resilience'] >= 4.0:
                    st.success("ğŸ’ª **YÃ¼ksek dayanÄ±klÄ±lÄ±k:** Zor konularda Ä±srarcÄ± olun, bu gÃ¼cÃ¼nÃ¼z YKS'de bÃ¼yÃ¼k avantaj!")
                else:
                    st.info("ğŸŒ± **DayanÄ±klÄ±lÄ±k geliÅŸtirme:** KÃ¼Ã§Ã¼k baÅŸarÄ±larÄ± kutlayÄ±n, kÄ±sa vadeli hedefler koyun.")
            
            st.markdown('</div>', unsafe_allow_html=True)
            
            st.success("âœ… Motivasyon & duygusal denge sonuÃ§larÄ±nÄ±z kaydedildi!")

def run_time_management_test():
    """Zaman YÃ¶netimi & Ã‡alÄ±ÅŸma AlÄ±ÅŸkanlÄ±ÄŸÄ± Testi - 10 soru (Likert 1-5)"""
    
    # Ana menÃ¼ye dÃ¶n butonu
    if st.button("ğŸ  Ana MenÃ¼ye DÃ¶n", key="back_to_main_time"):
        if 'page' in st.session_state:
            del st.session_state.page
        st.rerun()
    
    st.markdown("---")
    
    # CSS stilini ekle ve metin gÃ¶rÃ¼nÃ¼rlÃ¼k sorunu iÃ§in css ekle
    st.markdown("""
    <style>
    body {
        color: black !important;
    }
    .stMarkdown {
        color: black !important;
    }
    .time-header {
        background: linear-gradient(135deg, #4834d4 0%, #686de0 100%);
        color: white;
        padding: 2rem;
        border-radius: 15px;
        text-align: center;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    .time-question {
        background: #f8f9ff;
        border-left: 4px solid #4834d4;
        padding: 1rem;
        margin: 0.5rem 0;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .time-result {
        background: linear-gradient(135deg, #a4b0ff 0%, #c7d2fe 100%);
        padding: 2rem;
        border-radius: 15px;
        margin: 2rem 0;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    </style>
    """, unsafe_allow_html=True)
    
    # BaÅŸlÄ±k
    st.markdown("""
    <div class="time-header">
        <h1>â° Zaman YÃ¶netimi & Ã‡alÄ±ÅŸma AlÄ±ÅŸkanlÄ±ÄŸÄ± Testi</h1>
        <p>Planlama, disiplin, odak ve erteleme davranÄ±ÅŸÄ±nÄ±zÄ± keÅŸedin</p>
        <p><strong>ğŸ“‹ 10 soru | ğŸ¯ 1-5 arasÄ± puanlama</strong></p>
    </div>
    """, unsafe_allow_html=True)
    
    # Test aÃ§Ä±klamasÄ±
    st.markdown("""
    ### ğŸ”¬ Test HakkÄ±nda
    Bu test **4 ana boyutta** zaman yÃ¶netimi profilinizi analiz eder:
    
    ğŸ“‹ **Planlama & Disiplin** - Hedef belirleme ve planlÄ± Ã§alÄ±ÅŸma  
    â° **Erteleme & Son DakikacÄ±lÄ±k** - Procastination eÄŸilimi  
    ğŸ¯ **Odak & Dikkat YÃ¶netimi** - Konsantrasyon sÃ¼resi ve mola dengesi  
    ğŸ§  **Ã–z FarkÄ±ndalÄ±k** - Verimli zaman dilimlerini tanÄ±ma  
    
    **Puanlama:** 1 = HiÃ§ katÄ±lmÄ±yorum, 5 = Tamamen katÄ±lÄ±yorum
    """)
    
    # Test formunu baÅŸlat
    with st.form("time_management_test_form"):
        user_data = get_user_data()
        existing_results_raw = user_data.get('time_test_results', {})
        
        # JSON string ise parse et, dict ise direkt kullan
        if isinstance(existing_results_raw, str):
            try:
                existing_results = json.loads(existing_results_raw)
            except (json.JSONDecodeError, TypeError):
                existing_results = {}
        else:
            existing_results = existing_results_raw if isinstance(existing_results_raw, dict) else {}
        
        responses = {}
        
        # Soru sayÄ±sÄ±nÄ± takip et
        for i, question in enumerate(TIME_MANAGEMENT_TEST):
            question_key = f"time_{i+1}"
            default_value = existing_results.get(question_key, 3)
            
            st.markdown(f'<div class="time-question">{i+1}. {question["question"]}</div>', unsafe_allow_html=True)
            
            # Likert scale slider
            responses[question_key] = st.select_slider(
                f"Soru {i+1} - DeÄŸerlendirmeniz:",
                options=[1, 2, 3, 4, 5],
                value=default_value,
                key=question_key,
                format_func=lambda x: {
                    1: "1 - HiÃ§ katÄ±lmÄ±yorum",
                    2: "2 - KatÄ±lmÄ±yorum", 
                    3: "3 - KararsÄ±zÄ±m",
                    4: "4 - KatÄ±lÄ±yorum",
                    5: "5 - Tamamen katÄ±lÄ±yorum"
                }[x]
            )
            st.markdown("---")
        
        # Test sonuÃ§larÄ±nÄ± hesapla ve kaydet
        if st.form_submit_button("ğŸ¯ Testi DeÄŸerlendir", type="primary", use_container_width=True):
            # Kategorilere gÃ¶re puanlarÄ± hesapla
            category_scores = {
                'planning': [],
                'procrastination': [],
                'focus_control': [],
                'discipline': [],
                'self_awareness': []
            }
            
            for i, question in enumerate(TIME_MANAGEMENT_TEST):
                question_key = f"time_{i+1}"
                score = responses[question_key]
                category = question['category']
                category_scores[category].append(score)
            
            # Ortalama puanlarÄ± hesapla
            average_scores = {}
            for category, scores in category_scores.items():
                if scores:
                    average_scores[category] = sum(scores) / len(scores)
                else:
                    average_scores[category] = 0
            
            # VeritabanÄ±na kaydet
            update_user_in_firebase(st.session_state.current_user, {
                'time_test_results': json.dumps(responses),
                'time_test_scores': json.dumps(average_scores),
                'time_test_completed': 'True'
            })
            
            # ğŸš€ OPTÄ°MÄ°ZE: update_user_in_firebase() zaten session state'i gÃ¼nceller
            
            # SonuÃ§larÄ± gÃ¶ster
            st.markdown('<div class="time-result">', unsafe_allow_html=True)
            st.markdown("## ğŸ‰ Zaman YÃ¶netimi SonuÃ§larÄ±nÄ±z")
            
            # SonuÃ§larÄ± gÃ¶rselleÅŸtir
            col1, col2 = st.columns(2)
            
            with col1:
                st.markdown("### ğŸ“‹ PuanlarÄ±nÄ±z")
                st.metric("ğŸ“‹ Planlama", f"{average_scores['planning']:.1f}/5")
                st.metric("â° Erteleme EÄŸilimi", f"{average_scores['procrastination']:.1f}/5")
                st.metric("ğŸ¯ Odak KontrolÃ¼", f"{average_scores['focus_control']:.1f}/5")
                st.metric("ğŸ’ª Disiplin", f"{average_scores['discipline']:.1f}/5")
                st.metric("ğŸ§  Ã–z FarkÄ±ndalÄ±k", f"{average_scores['self_awareness']:.1f}/5")
            
            with col2:
                st.markdown("### ğŸ¯ YKS Ä°Ã§in Ã–neriler")
                
                # Zaman yÃ¶netimi profilini belirle
                planning_score = average_scores['planning']
                procrastination_score = average_scores['procrastination']
                focus_score = average_scores['focus_control']
                
                if planning_score >= 4.0:
                    st.success("ğŸ“‹ **MÃ¼kemmel planlama:** Mevcut sisteminizi koruyun, sadece ince ayar yapÄ±n!")
                elif planning_score >= 3.0:
                    st.info("ğŸ“Š **Orta dÃ¼zey planlama:** HaftalÄ±k detaylÄ± planlar yapÄ±n, gÃ¼nlÃ¼k revizyon ekleyin.")
                else:
                    st.warning("âš ï¸ **Planlama geliÅŸtirme:** KÃ¼Ã§Ã¼k baÅŸlayÄ±n - Ã¶nce gÃ¼nlÃ¼k, sonra haftalÄ±k planlar.")
                
                if procrastination_score >= 3.5:
                    st.warning("â° **YÃ¼ksek erteleme:** Pomodoro tekniÄŸi (25+5 dk) ve kÃ¼Ã§Ã¼k hedefler size yardÄ±mcÄ± olur.")
                else:
                    st.success("âœ… **DÃ¼ÅŸÃ¼k erteleme:** Harika! Bu disiplini koruyun.")
                
                if focus_score <= 2.5:
                    st.info("ğŸ¯ **Odak geliÅŸtirme:** Telefonunu baÅŸka odaya koy, 20 dk odaklanma + 5 dk mola dÃ¶ngÃ¼lÃ¼nÃ¼ dene.")
                else:
                    st.success("ğŸ¯ **Ä°yi odak:** Mevcut odak sÃ¼renizi optimum ÅŸekilde kullanÄ±n.")
            
            st.markdown('</div>', unsafe_allow_html=True)
            
            st.success("âœ… Zaman yÃ¶netimi sonuÃ§larÄ±nÄ±z kaydedildi!")

# ===== YENÄ°: GELECEKTEKÄ° HAFTA BONUS KONULARI SÄ°STEMÄ° =====

def get_weak_topics_for_subject(user_data, subject):
    """Belirli bir ders iÃ§in zayÄ±f konularÄ± getirir"""
    try:
        topic_progress = json.loads(user_data.get('topic_progress', '{}'))
        
        # Basit zayÄ±f konu listesi (geniÅŸletilebilir)
        weak_topics_map = {
            "TYT Matematik": [
                {"topic": "Problemleri", "detail": "Ä°ÅŸÃ§i Problemleri", "net": 0},
                {"topic": "Cebir", "detail": "Denklemler", "net": 0},
                {"topic": "Geometri", "detail": "ÃœÃ§gen Ã–zellikleri", "net": 0},
                {"topic": "Fonksiyonlar", "detail": "Fonksiyon TÃ¼rleri", "net": 0}
            ],
            "AYT Matematik": [
                {"topic": "Fonksiyonlar", "detail": "Ä°leri DÃ¼zey", "net": 0},
                {"topic": "KarmaÅŸÄ±k SayÄ±lar", "detail": "Temel Kavramlar", "net": 0},
                {"topic": "Polinomlar", "detail": "Polinom Ä°ÅŸlemleri", "net": 0},
                {"topic": "2. Dereceden EÅŸitsizlikler", "detail": "Ã‡Ã¶zÃ¼m Teknikleri", "net": 0}
            ],
            "TYT TÃ¼rkÃ§e": [
                {"topic": "Paragraf", "detail": "DÃ¼ÅŸÃ¼nceyi GeliÅŸtirme", "net": 0},
                {"topic": "YazÄ±m KurallarÄ±", "detail": "BÃ¼yÃ¼k Harf", "net": 0},
                {"topic": "Ses Bilgisi", "detail": "ÃœnlÃ¼ UyumlarÄ±", "net": 0}
            ],
            "TYT Geometri": [
                {"topic": "ÃœÃ§gen Ã–zellikleri", "detail": "EÅŸlik ve Benzerlik", "net": 0},
                {"topic": "AÃ§Ä±lar", "detail": "DoÄŸruda AÃ§Ä±lar", "net": 0}
            ],
            "TYT CoÄŸrafya": [
                {"topic": "Konular", "detail": "BasÄ±nÃ§ ve RÃ¼zgarlar", "net": 0},
                {"topic": "Konular", "detail": "Ä°klimler", "net": 0}
            ],
            "TYT Tarih": [
                {"topic": "Tarih Bilimi", "detail": "AtatÃ¼rk DÃ¶nemi TÃ¼rk DÄ±ÅŸ PolitikasÄ±", "net": 4}
            ],
            "TYT English": [
                {"topic": "Ses Bilgisi", "detail": "Ses OlaylarÄ±", "net": 0}
            ]
        }
        
        # EÄŸer ders mevcutsa konularÄ± dÃ¶ndÃ¼r
        if subject in weak_topics_map:
            return weak_topics_map[subject]
        else:
            # VarsayÄ±lan konular
            return [
                {"topic": "Temel Konular", "detail": "BaÅŸlangÄ±Ã§ Seviyesi", "net": 0},
                {"topic": "Orta Konular", "detail": "GeliÅŸim Seviyesi", "net": 0}
            ]
            
    except Exception as e:
        return [{"topic": "Genel Konu", "detail": "Genel Tekrar", "net": 0}]

# ===== YENÄ°: DÄ°NAMÄ°K HAFTALIK PLAN SÄ°STEMÄ° =====

def get_user_dynamic_week_info(user_data):
    """ğŸ” KullanÄ±cÄ± kayÄ±t tarihinden itibaren dinamik hafta ve gÃ¼n bilgisini hesaplar"""
    from datetime import datetime, timedelta
    import json
    
    try:
        # KullanÄ±cÄ±nÄ±n kayÄ±t tarihini al
        registration_date = None
        
        # Ã–nce created_at alanÄ±nÄ± kontrol et (ISO format)
        if 'created_at' in user_data and user_data['created_at']:
            try:
                # ISO format: 2025-10-18T05:55:30 veya 2025-10-18T05:55:30.123456
                date_str = user_data['created_at'].split('T')[0]  # Sadece tarih kÄ±smÄ±nÄ± al
                registration_date = datetime.strptime(date_str, '%Y-%m-%d')
            except:
                pass
        
        # EÄŸer created_at yoksa created_date kontrol et (eski format)
        if not registration_date and 'created_date' in user_data and user_data['created_date']:
            try:
                if len(user_data['created_date']) > 10:  # Saat bilgisi de varsa
                    date_str = user_data['created_date'][:10]  # Sadece tarih kÄ±smÄ±nÄ± al
                else:
                    date_str = user_data['created_date']
                registration_date = datetime.strptime(date_str, '%Y-%m-%d')
            except:
                pass
        
        # EÄŸer hiÃ§bir tarih bulunamazsa bugÃ¼nÃ¼ kayÄ±t tarihi olarak kabul et
        if not registration_date:
            registration_date = datetime.now().replace(hour=0, minute=0, second=0, microsecond=0)
        
        # BugÃ¼nÃ¼n tarihini al
        today = datetime.now().replace(hour=0, minute=0, second=0, microsecond=0)
        
        # KayÄ±t tarihinden bu yana geÃ§en gÃ¼n sayÄ±sÄ±
        days_since_registration = (today - registration_date).days
        
        # 7 gÃ¼nlÃ¼k dÃ¶ngÃ¼lerde hangi hafta ve gÃ¼n
        current_week = (days_since_registration // 7) + 1  # 1. hafta, 2. hafta...
        current_day_in_week = (days_since_registration % 7) + 1  # HaftanÄ±n 1-7. gÃ¼nÃ¼
        
        # ğŸ”¥ TAMAMEN YENÄ° FÄ°X: Hafta baÅŸlangÄ±cÄ±nÄ± BUGÃœNDEN geriye hesapla (gerÃ§ek takvim!)
        week_start_date = today - timedelta(days=current_day_in_week - 1)
        week_end_date = week_start_date + timedelta(days=6)
        
        # Bu haftada kalan gÃ¼n sayÄ±sÄ±
        days_left_in_week = 7 - current_day_in_week + 1
        
        # TÃ¼rkÃ§e gÃ¼n Ã§evirisi
        day_translation = {
            'Monday': 'Pazartesi', 'Tuesday': 'SalÄ±', 'Wednesday': 'Ã‡arÅŸamba',
            'Thursday': 'PerÅŸembe', 'Friday': 'Cuma', 'Saturday': 'Cumartesi', 'Sunday': 'Pazar'
        }
        
        # ğŸ”¥ FÄ°X: Her gÃ¼n iÃ§in GERÃ‡EK takvim gÃ¼nÃ¼nÃ¼ hesapla (kayÄ±t tarihinden itibaren)
        turkish_weekdays = []
        for day_offset in range(7):
            # Bu hafta dÃ¶ngÃ¼sÃ¼ndeki gÃ¼nÃ¼n gerÃ§ek tarihini hesapla
            actual_date = week_start_date + timedelta(days=day_offset)
            day_name_english = actual_date.strftime('%A')
            day_name_turkish = day_translation.get(day_name_english, day_name_english)
            turkish_weekdays.append(day_name_turkish)
        
        # BugÃ¼nÃ¼n gerÃ§ek gÃ¼n ismini al
        current_day_name = today.strftime('%A')
        current_day_name = day_translation.get(current_day_name, current_day_name)
        
        return {
            'registration_date': registration_date,
            'current_week': current_week,
            'current_day_in_week': current_day_in_week,
            'current_day_name': current_day_name,
            'days_left_in_week': days_left_in_week,
            'week_start_date': week_start_date,
            'week_end_date': week_end_date,
            'days_since_registration': days_since_registration,
            'weekday_cycle': turkish_weekdays,
            'total_weeks_completed': current_week - 1 if current_day_in_week == 1 and days_since_registration > 0 else current_week - 1
        }
        
    except Exception as e:
        # Hata durumunda varsayÄ±lan deÄŸerler
        today = datetime.now()
        return {
            'registration_date': today,
            'current_week': 1,
            'current_day_in_week': 1,
            'current_day_name': 'Pazartesi',
            'days_left_in_week': 7,
            'week_start_date': today,
            'week_end_date': today + timedelta(days=6),
            'days_since_registration': 0,
            'weekday_cycle': ['Pazartesi', 'SalÄ±', 'Ã‡arÅŸamba', 'PerÅŸembe', 'Cuma', 'Cumartesi', 'Pazar'],
            'total_weeks_completed': 0
        }

def create_dynamic_weekly_plan(user_data, student_field, survey_data):
    """ğŸ”„ KullanÄ±cÄ±nÄ±n dinamik haftalÄ±k planÄ±nÄ± oluÅŸturur"""
    from datetime import datetime
    import json
    
    # HaftalÄ±k program baÅŸlama kaydÄ± - Ä°LK KEZ Ã‡AÄIRILDIÄINDA KAYDET
    if not user_data.get('weekly_program_started', False):
        user_data['weekly_program_started'] = True
        user_data['weekly_plan_start_date'] = datetime.now().strftime("%Y-%m-%d")
        # Firebase'e gÃ¼ncelleyi gÃ¶nder
        if 'username' in user_data:
            update_user_in_firebase(user_data['username'], {
                'weekly_program_started': True,
                'weekly_plan_start_date': user_data['weekly_plan_start_date']
            })
        st.success("ğŸ† HaftalÄ±k program baÅŸlatÄ±ldÄ±! GidiÅŸat analizi Ä°LK HAFTAN bitince aÃ§Ä±lacak.")
    
    # Dinamik hafta bilgisini al
    week_info = get_user_dynamic_week_info(user_data)
    
    # ğŸ†• FÄ°X: TYT/AYT ilerleme hesaplamasÄ± iÃ§in projections hesapla
    days_to_yks = get_current_week_info()['days_to_yks']
    projections = calculate_completion_projections(user_data, student_field, days_to_yks)
    
    # Mevcut haftalÄ±k plan sistemindeki temel bilgileri al
    base_weekly_plan = get_weekly_topics_from_topic_tracking(user_data, student_field, survey_data)
    
    # ğŸ”¥ KOÃ‡ ONAYLARINI HAFTALIK HEDEF KONULAR'A ENTEGRE ET (DEÄÄ°ÅÄ°KLÄ°KLERLE)
    approved_coached_topics = get_approved_coached_topics(user_data)
    
    # ğŸ”§ DEBUG: KoÃ§ onaylÄ± konularÄ± listele
    st.info(f"ğŸ” DEBUG: {len(approved_coached_topics)} adet koÃ§ onaylÄ± konu bulundu")
    if approved_coached_topics:
        for i, topic in enumerate(approved_coached_topics):
            st.info(f"  {i+1}. {topic.get('subject', 'N/A')} - {topic.get('topic', 'N/A')} - {topic.get('priority', 'N/A')}")
    
    if approved_coached_topics:
        original_topics = base_weekly_plan.get('new_topics', [])
        st.info(f"ğŸ” DEBUG: Orijinal konu sayÄ±sÄ±: {len(original_topics)}")
        
        # Mevcut konularÄ± gÃ¼ncelle/sil/ekle
        updated_new_topics = apply_coach_changes(original_topics, approved_coached_topics)
        base_weekly_plan['new_topics'] = updated_new_topics
        
        st.info(f"ğŸ” DEBUG: GÃ¼ncellenmiÅŸ konu sayÄ±sÄ±: {len(updated_new_topics)}")
        # KaÃ§ deÄŸiÅŸiklik yapÄ±ldÄ±ÄŸÄ±nÄ± say
        changes_count = len(approved_coached_topics)
        st.info(f"âœ… {changes_count} adet koÃ§ onaylÄ± konu haftalÄ±k hedef konularÄ±nÄ±z gÃ¼ncellendi!")
    
    # Dinamik bilgileri ekle
    base_weekly_plan['dynamic_week_info'] = week_info
    base_weekly_plan['is_dynamic'] = True
    base_weekly_plan['projections'] = projections  # ğŸ†• FÄ°X: Projections ekle
    
    # Ã–zel dinamik baÅŸlÄ±k ve aÃ§Ä±klama
    base_weekly_plan['dynamic_title'] = f"ğŸ” {week_info['current_week']}. HaftanÄ±z - GÃ¼n {week_info['current_day_in_week']}/7"
    base_weekly_plan['dynamic_description'] = f"""
    ğŸ“… **KayÄ±t Tarihinizden Bu Yana:** {week_info['days_since_registration']} gÃ¼n  
    ğŸ”„ **Mevcut Hafta DÃ¶ngÃ¼nÃ¼z:** {week_info['current_week']}. hafta  
    ğŸ“† **BugÃ¼n:** {week_info['current_day_name']} ({week_info['current_day_in_week']}/7)  
    â³ **Bu Haftada Kalan:** {week_info['days_left_in_week']} gÃ¼n  
    ğŸ **Hafta AralÄ±ÄŸÄ±:** {week_info['week_start_date'].strftime('%d.%m')} - {week_info['week_end_date'].strftime('%d.%m')}
    """
    
    # HaftalÄ±k dÃ¶ngÃ¼ takvimini ekle
    base_weekly_plan['weekly_calendar'] = create_weekly_calendar(week_info)
    
    return base_weekly_plan

def apply_coach_changes(original_topics, coach_approved_topics):
    """KoÃ§un yaptÄ±ÄŸÄ± deÄŸiÅŸiklikleri orijinal konu listesine uygula"""
    try:
        if not coach_approved_topics:
            return original_topics
            
        # KoÃ§ onaylÄ± konularÄ± iÅŸle
        updated_topics = []
        added_topics = set()  # Eklenecek konularÄ± takip et
        
        for coach_topic in coach_approved_topics:
            subject = coach_topic.get('subject', '')
            topic = coach_topic.get('topic', '')
            detail = coach_topic.get('detail', '')
            
            # Konu zaten var mÄ± kontrol et
            topic_found = False
            for i, orig_topic in enumerate(original_topics):
                if (orig_topic.get('subject', '') == subject and 
                    orig_topic.get('topic', '') == topic and
                    orig_topic.get('detail', '') == detail):
                    
                    # Konu bulundu, gÃ¼ncelle (eÄŸer coach'ta Ã¶zel bilgiler varsa)
                    updated_topic = orig_topic.copy()
                    if 'priority' in coach_topic:
                        updated_topic['priority'] = coach_topic['priority']
                    if 'net' in coach_topic and coach_topic['net'] != 0:
                        updated_topic['net'] = coach_topic['net']
                    
                    updated_topics.append(updated_topic)
                    topic_found = True
                    added_topics.add(f"{subject}_{topic}_{detail}")
                    break
            
            # EÄŸer konu yoksa, koÃ§ onayladÄ±ÄŸÄ± iÃ§in yeni ekle
            if not topic_found:
                new_topic = coach_topic.copy()
                # EÄŸer net deÄŸeri yoksa 0 yap
                if 'net' not in new_topic:
                    new_topic['net'] = 0
                updated_topics.append(new_topic)
                added_topics.add(f"{subject}_{topic}_{detail}")
        
        # Orijinal konulardan koÃ§un onaylamadÄ±ÄŸÄ± konularÄ± da ekle (sadece manuel olarak silinmedikÃ§e)
        for orig_topic in original_topics:
            topic_key = f"{orig_topic.get('subject', '')}_{orig_topic.get('topic', '')}_{orig_topic.get('detail', '')}"
            if topic_key not in added_topics:
                # Bu konu koÃ§ tarafÄ±ndan aÃ§Ä±kÃ§a silinmemiÅŸ, ekle
                updated_topics.append(orig_topic)
        
        return updated_topics
    except Exception as e:
        st.error(f"KoÃ§ deÄŸiÅŸiklikleri uygulama hatasÄ±: {e}")
        return original_topics

def get_approved_coached_topics(user_data):
    """KoÃ§ tarafÄ±ndan onaylanan Ã¶ÄŸrenci konularÄ±nÄ± Firebase'den getir"""
    try:
        if firebase_connected and db_ref and 'username' in user_data:
            # KullanÄ±cÄ±nÄ±n onaylanmÄ±ÅŸ konularÄ±nÄ± bul
            approved_topics = []
            
            # Coach approvals'dan bu kullanÄ±cÄ± iÃ§in olanlarÄ± Ã§ek
            approvals_data = db_ref.child('coach_approvals').get()
            if approvals_data:
                username = user_data['username']
                for approval_key, approval_data in approvals_data.items():
                    # ğŸ”§ GÃœVENLÄ°: Student bilgileri Ã§Ä±kar
                    student_username = approval_data.get('student_username', '')
                    student_name = approval_data.get('student_name', '')
                    
                    # EÄŸer student_username yoksa approval_key'den Ã§Ä±kar
                    if not student_username:
                        try:
                            student_username = approval_key.split('_')[0]
                        except:
                            student_username = ''
                    
                    # Username eÅŸleÅŸmesi veya name eÅŸleÅŸmesi veya key eÅŸleÅŸmesi
                    if (student_username == username or 
                        student_name == user_data.get('name', username) or
                        approval_key.startswith(username)):
                        
                        # OnaylanmÄ±ÅŸ durumda ise ve onaylanan konular varsa
                        if (approval_data.get('status') == 'approved' and 
                            'approved_topics' in approval_data and 
                            approval_data['approved_topics']):
                            
                            # Onaylanan konularÄ± ekle
                            for topic in approval_data['approved_topics']:
                                # Tarih bilgisi ekle
                                topic_with_date = topic.copy()
                                topic_with_date['approval_date'] = approval_data.get('approved_date', '')
                                topic_with_date['coach_notes'] = approval_data.get('coach_notes', '')
                                approved_topics.append(topic_with_date)
            
            return approved_topics
        else:
            # Session state'den (fallback)
            return []
    except Exception as e:
        st.error(f"Onaylanan konularÄ± getirme hatasÄ±: {e}")
        return []

def create_weekly_calendar(week_info):
    """ğŸ“… 7 gÃ¼nlÃ¼k dÃ¶ngÃ¼ takvimi oluÅŸturur - GERÃ‡EK TAKVÄ°M TARÄ°HLERÄ°YLE"""
    from datetime import datetime, timedelta
    
    calendar = []
    
    # TÃ¼rkÃ§e gÃ¼n Ã§evirisi
    day_translation = {
        'Monday': 'Pazartesi', 'Tuesday': 'SalÄ±', 'Wednesday': 'Ã‡arÅŸamba',
        'Thursday': 'PerÅŸembe', 'Friday': 'Cuma', 'Saturday': 'Cumartesi', 'Sunday': 'Pazar'
    }
    
    # BugÃ¼nÃ¼n tarihini al
    today = datetime.now().replace(hour=0, minute=0, second=0, microsecond=0)
    
    # KullanÄ±cÄ±nÄ±n haftasÄ±nÄ±n baÅŸlangÄ±Ã§ tarihi
    week_start_date = week_info['week_start_date']
    
    for day_num in range(1, 8):
        # ğŸ”¥ FÄ°X: Her gÃ¼n iÃ§in GERÃ‡EK takvim tarihini hesapla
        actual_date = week_start_date + timedelta(days=day_num - 1)
        day_name_english = actual_date.strftime('%A')
        day_name = day_translation.get(day_name_english, day_name_english)
        
        # BugÃ¼n mÃ¼?
        is_today = (day_num == week_info['current_day_in_week'])
        
        # GeÃ§miÅŸ mi?
        is_past = (day_num < week_info['current_day_in_week'])
        
        # Gelecek mi?
        is_future = (day_num > week_info['current_day_in_week'])
        
        calendar.append({
            'day_number': day_num,
            'day_name': day_name,  # ArtÄ±k gerÃ§ek tarihten geliyor!
            'actual_date': actual_date.strftime('%d.%m'),  # Ek bilgi
            'is_today': is_today,
            'is_past': is_past,
            'is_future': is_future,
            'status_emoji': 'ğŸ”´' if is_today else ('âœ…' if is_past else 'â³')
        })
    
    return calendar

def show_dynamic_week_dashboard(weekly_plan, user_data):
    """ğŸ“‹ Dinamik haftalÄ±k dashboard gÃ¶sterir"""
    if not weekly_plan.get('is_dynamic', False):
        return
    
    week_info = weekly_plan['dynamic_week_info']
    
    # Ana baÅŸlÄ±k
    st.markdown(f"### {weekly_plan['dynamic_title']}")
    
    # Bilgi kutucuklarÄ±
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        st.metric(
            label="ğŸ”„ Hafta DÃ¶ngÃ¼nÃ¼z",
            value=f"{week_info['current_week']}. Hafta",
            delta=f"+{week_info['total_weeks_completed']} tamamlandÄ±"
        )
    
    with col2:
        st.metric(
            label="ğŸ“† BugÃ¼n",
            value=f"GÃ¼n {week_info['current_day_in_week']}/7",
            delta=f"{week_info['current_day_name']}"
        )
    
    with col3:
        st.metric(
            label="â³ Kalan GÃ¼n",
            value=f"{week_info['days_left_in_week']} gÃ¼n",
            delta="Bu haftada" if week_info['days_left_in_week'] > 0 else "Hafta bitti!"
        )
    
    with col4:
        st.metric(
            label="ğŸ“… Toplam GÃ¼n",
            value=f"{week_info['days_since_registration']} gÃ¼n",
            delta="KayÄ±t tarihinden beri"
        )
    
    # HaftalÄ±k takvim
    st.markdown("#### ğŸ“… Bu HaftanÄ±n DÃ¶ngÃ¼ Takvimi")
    
    calendar = weekly_plan['weekly_calendar']
    cols = st.columns(7)
    
    for i, day in enumerate(calendar):
        with cols[i]:
            # Durum rengine gÃ¶re stil
            if day['is_today']:
                st.markdown(
                    f"""
                    <div style='background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%); 
                                color: white; padding: 8px; border-radius: 8px; text-align: center; 
                                border: 2px solid #ff4757; box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);'>
                        <div style='font-size: 12px; font-weight: bold;'>GÃœN {day['day_number']}</div>
                        <div style='font-size: 14px; margin: 2px 0;'>{day['status_emoji']}</div>
                        <div style='font-size: 10px;'>{day['day_name']}</div>
                        <div style='font-size: 9px; color: #ffe6e6;'>BUGÃœN</div>
                    </div>
                    """, 
                    unsafe_allow_html=True
                )
            elif day['is_past']:
                st.markdown(
                    f"""
                    <div style='background: linear-gradient(135deg, #2ed573 0%, #7bed9f 100%); 
                                color: white; padding: 8px; border-radius: 8px; text-align: center;'>
                        <div style='font-size: 12px; font-weight: bold;'>GÃœN {day['day_number']}</div>
                        <div style='font-size: 14px; margin: 2px 0;'>{day['status_emoji']}</div>
                        <div style='font-size: 10px;'>{day['day_name']}</div>
                        <div style='font-size: 9px; color: #e6ffe6;'>GEÃ‡TÄ°</div>
                    </div>
                    """, 
                    unsafe_allow_html=True
                )
            else:  # Gelecek
                st.markdown(
                    f"""
                    <div style='background: linear-gradient(135deg, #747d8c 0%, #a4b0be 100%); 
                                color: white; padding: 8px; border-radius: 8px; text-align: center;'>
                        <div style='font-size: 12px; font-weight: bold;'>GÃœN {day['day_number']}</div>
                        <div style='font-size: 14px; margin: 2px 0;'>{day['status_emoji']}</div>
                        <div style='font-size: 10px;'>{day['day_name']}</div>
                        <div style='font-size: 9px; color: #f1f2f6;'>GELECEK</div>
                    </div>
                    """, 
                    unsafe_allow_html=True
                )
    
    # AÃ§Ä±klama metni
    st.markdown(weekly_plan['dynamic_description'])
    
    # Hafta ilerleme Ã§ubuÄŸu
    week_progress = ((week_info['current_day_in_week'] - 1) / 7) * 100
    st.markdown("#### ğŸ“Š Bu HaftanÄ±n Ä°lerlemesi")
    progress_col1, progress_col2 = st.columns([4, 1])
    
    with progress_col1:
        st.progress(week_progress / 100)
    
    with progress_col2:
        st.metric(
            label="Ä°lerleme",
            value=f"%{week_progress:.1f}"
        )
    


# ===== DÄ°NAMÄ°K HAFTALIK PLAN ENTEGRASYONU =====

def calculate_weekly_completion_percentage(user_data, weekly_plan):
    """Bu haftanÄ±n hedef konularÄ±nÄ±n tamamlanma yÃ¼zdesini hesaplar - DÃœZELTÄ°LDÄ°"""
    import json
    from datetime import datetime, timedelta
    
    try:
        # HaftalÄ±k plandaki yeni konularÄ± al
        new_topics = weekly_plan.get('new_topics', [])
        review_topics = weekly_plan.get('review_topics', [])
        all_topics = new_topics + review_topics
        
        if not all_topics:
            return 50.0  # VarsayÄ±lan orta seviye
        
        # KullanÄ±cÄ±nÄ±n topic_progress verisini al
        topic_progress_str = user_data.get('topic_progress', '{}')
        topic_progress = json.loads(topic_progress_str) if topic_progress_str else {}
        
        # Tamamlanan konularÄ± say
        total_topics = len(all_topics)
        completed_count = 0
        
        for topic in all_topics:
            subject = topic.get('subject', '')
            topic_name = topic.get('topic', '')
            detail = topic.get('detail', '')
            
            # Konunun tamamlanma durumunu kontrol et
            # Net deÄŸeri 14 veya Ã¼zeri ise tamamlanmÄ±ÅŸ sayÄ±lÄ±r
            net_value = topic.get('net', 0)  # HaftalÄ±k plandan direkt net deÄŸerini al
            
            # EÄŸer haftalÄ±k planda net yoksa topic_progress'ten kontrol et
            if net_value == 0:
                # OlasÄ± topic key formatlarÄ±
                possible_keys = [
                    f"{subject} | {topic_name} | {detail}",
                    f"{subject} | {topic_name}",
                    topic_name,
                    detail
                ]
                
                for key in possible_keys:
                    if key in topic_progress:
                        topic_data = topic_progress[key]
                        if isinstance(topic_data, dict):
                            net_value = int(float(topic_data.get('net', 0)))
                        else:
                            try:
                                net_value = int(float(str(topic_data)))
                            except:
                                net_value = 0
                        break
            
            # 14 net ve Ã¼zeri tamamlanmÄ±ÅŸ sayÄ±lÄ±r
            if net_value >= 14:
                completed_count += 1
        
        # Tamamlanma yÃ¼zdesini hesapla
        completion_percentage = (completed_count / total_topics) * 100 if total_topics > 0 else 0.0
        
        return min(completion_percentage, 100.0)  # Max %100
        
    except Exception as e:
        # Hata durumunda gÃ¼venli varsayÄ±lan
        print(f"HaftalÄ±k tamamlanma hesaplama hatasÄ±: {e}")
        return 25.0

def get_next_week_topics(user_data, student_field, survey_data):
    """Gelecek haftanÄ±n konularÄ±nÄ± getirir"""
    try:
        # Gelecek hafta iÃ§in sabit bonus konular listesi
        next_week_topics = []
        
        # Alan bazÄ±nda bonus konular
        bonus_topics_by_field = {
            "TM": [  # TÃ¼rkÃ§e-Matematik
                {"subject": "TYT Matematik", "topic": "Fonksiyonlar", "detail": "Ters Fonksiyon", "net": 0},
                {"subject": "TYT TÃ¼rkÃ§e", "topic": "Edebiyat", "detail": "Divan EdebiyatÄ±", "net": 0},
                {"subject": "AYT Matematik", "topic": "TÃ¼rev", "detail": "TÃ¼rev KurallarÄ±", "net": 0},
                {"subject": "TYT Geometri", "topic": "Ã‡ember", "detail": "Ã‡ember Teoremi", "net": 0},
                {"subject": "TYT Tarih", "topic": "Ä°lk Ã‡aÄŸ", "detail": "Anadolu Medeniyetleri", "net": 0},
                {"subject": "AYT Matematik", "topic": "Ä°ntegral", "detail": "Belirsiz Ä°ntegral", "net": 0}
            ],
            "TM2": [  # TÃ¼rkÃ§e-Matematik (aynÄ±)
                {"subject": "TYT Matematik", "topic": "Fonksiyonlar", "detail": "Ters Fonksiyon", "net": 0},
                {"subject": "TYT TÃ¼rkÃ§e", "topic": "Edebiyat", "detail": "Divan EdebiyatÄ±", "net": 0},
                {"subject": "AYT Matematik", "topic": "TÃ¼rev", "detail": "TÃ¼rev KurallarÄ±", "net": 0},
                {"subject": "TYT Geometri", "topic": "Ã‡ember", "detail": "Ã‡ember Teoremi", "net": 0},
                {"subject": "TYT Tarih", "topic": "Ä°lk Ã‡aÄŸ", "detail": "Anadolu Medeniyetleri", "net": 0},
                {"subject": "AYT Matematik", "topic": "Ä°ntegral", "detail": "Belirsiz Ä°ntegral", "net": 0}
            ],
            "MF": [  # Matematik-Fen
                {"subject": "AYT Matematik", "topic": "TÃ¼rev", "detail": "TÃ¼rev KurallarÄ±", "net": 0},
                {"subject": "AYT Fizik", "topic": "Kuvvet ve Hareket", "detail": "AtÄ±ÅŸ Hareketleri", "net": 0},
                {"subject": "AYT Kimya", "topic": "Kimyasal BaÄŸlar", "detail": "Ä°yonik BaÄŸ", "net": 0},
                {"subject": "AYT Biyoloji", "topic": "HÃ¼cre", "detail": "HÃ¼cre ZarÄ±", "net": 0},
                {"subject": "TYT Matematik", "topic": "Logaritma", "detail": "Logaritma Ã–zellikleri", "net": 0},
                {"subject": "AYT Matematik", "topic": "Ä°ntegral", "detail": "Belirsiz Ä°ntegral", "net": 0}
            ],
            "VarsayÄ±lan": [
                {"subject": "TYT Matematik", "topic": "Temel Konular", "detail": "SayÄ± Sistemleri", "net": 0},
                {"subject": "TYT TÃ¼rkÃ§e", "topic": "Paragraf", "detail": "Ana Fikir", "net": 0},
                {"subject": "TYT Geometri", "topic": "Temel Åekiller", "detail": "ÃœÃ§gen", "net": 0},
                {"subject": "TYT Tarih", "topic": "Temel Konular", "detail": "OsmanlÄ± Tarihi", "net": 0},
                {"subject": "TYT CoÄŸrafya", "topic": "Fiziki CoÄŸrafya", "detail": "Ä°klim", "net": 0},
                {"subject": "TYT English", "topic": "Grammar", "detail": "Present Tense", "net": 0}
            ]
        }
        
        # Ã–ÄŸrencinin alanÄ±na gÃ¶re bonus konularÄ± seÃ§
        field_code = student_field if student_field in bonus_topics_by_field else "VarsayÄ±lan"
        next_week_topics = bonus_topics_by_field[field_code].copy()
        
        # Her konuya bonus Ã¶zelliÄŸi ekle
        for topic in next_week_topics:
            topic['priority'] = 'NEXT_WEEK_BONUS'
            topic['is_bonus'] = True
        
        return next_week_topics[:6]  # Maksimum 6 bonus konu
        
    except Exception as e:
        # Hata durumunda varsayÄ±lan konular
        return [
            {"subject": "TYT Matematik", "topic": "Temel Konular", "detail": "Bonus Ã‡alÄ±ÅŸma", "net": 0, "priority": 'NEXT_WEEK_BONUS', "is_bonus": True},
            {"subject": "TYT TÃ¼rkÃ§e", "topic": "Temel Konular", "detail": "Bonus Ã‡alÄ±ÅŸma", "net": 0, "priority": 'NEXT_WEEK_BONUS', "is_bonus": True},
            {"subject": "TYT Geometri", "topic": "Temel Konular", "detail": "Bonus Ã‡alÄ±ÅŸma", "net": 0, "priority": 'NEXT_WEEK_BONUS', "is_bonus": True}
        ]

def show_next_week_bonus_topics(next_week_topics, user_data):
    """Gelecek haftanÄ±n bonus konularÄ±nÄ± kÄ±rmÄ±zÄ± renkte gÃ¶sterir"""
    if not next_week_topics:
        return
    
    st.markdown("#### ğŸš€ GELECEKTEKÄ° HAFTA BONUS KONULARI")
    st.caption("ğŸ‰ Bu haftanÄ±n hedeflerini %80+ tamamladÄ±ÄŸÄ±nÄ±z iÃ§in gelecek haftanÄ±n konularÄ±nÄ± ÅŸimdiden Ã§alÄ±ÅŸabilirsiniz!")
    
    for i, topic in enumerate(next_week_topics):
        topic_key = f"{topic.get('subject', '')}_{topic.get('topic', '')}_{topic.get('detail', '')}"
        
        # Tamamlanma durumunu kontrol et
        is_completed = st.session_state.get(f"completed_{topic_key}", False)
        
        with st.container():
            st.markdown(f"""
            <div style='background: linear-gradient(135deg, #ff4d4d22 0%, #cc000011 100%); 
                        border-left: 4px solid #ff4d4d; 
                        border: 2px dashed #ff4d4d;
                        padding: 12px; border-radius: 8px; margin-bottom: 8px;'>
                <div style='display: flex; align-items: center; margin-bottom: 8px;'>
                    <span style='font-size: 18px; margin-right: 8px;'>ğŸš€</span>
                    <strong style='color: #ff4d4d;'>{topic.get('subject', 'Ders')}</strong>
                    <span style='background: #ff4d4d; color: white; padding: 2px 8px; border-radius: 12px; margin-left: 8px; font-size: 12px;'>BONUS</span>
                    {f"<span style='background: #00cc00; color: white; padding: 2px 8px; border-radius: 12px; margin-left: 8px; font-size: 12px;'>âœ… TAMAMLANDI</span>" if is_completed else ""}
                </div>
                <div style='margin-left: 26px;'>
                    <div><strong>ğŸ“– {topic.get('topic', 'Konu')}</strong></div>
                    <div style='font-size: 14px; color: #666; margin-top: 4px;'>
                        â”” {topic.get('detail', 'Detay')} 
                        <span style='background: #ffe6e6; padding: 2px 6px; border-radius: 10px; margin-left: 8px; color: #cc0000;'>
                            ğŸ¯ {topic.get('net', 0)} net
                        </span>
                    </div>
                </div>
            </div>
            """, unsafe_allow_html=True)
            
            # Ä°ÅŸlem butonlarÄ±
            col1, col2, col3, col4 = st.columns([2, 1, 1, 1])
            
            with col2:
                if not is_completed:
                    if st.button(f"âœ…", key=f"complete_bonus_{i}", help="Konuyu tamamladÄ±m"):
                        st.session_state[f"completed_{topic_key}"] = True
                        
                        # Gamification entegrasyonu
                        try:
                            subject = topic.get('subject', 'Bilinmiyor')
                            topic_name = topic.get('topic', 'Konu')
                            difficulty = topic.get('difficulty', 3)
                            
                            points, new_badges = update_topic_completion(subject, topic_name, difficulty)
                            st.success(f"ğŸ‰ {topic_name} tamamlandÄ±! +{points} puan kazandÄ±n!")
                            
                            if new_badges:
                                show_achievement_notification(new_badges)
                        except:
                            st.success(f"ğŸ‰ {topic.get('topic', 'Konu')} tamamlandÄ±!")
                        
                        st.rerun()
                else:
                    if st.button(f"â†©ï¸", key=f"uncomplete_bonus_{i}", help="TamamlanmadÄ± olarak iÅŸaretle"):
                        st.session_state[f"completed_{topic_key}"] = False
                        st.rerun()
            
            with col3:
                if st.button(f"ğŸ“…", key=f"add_bonus_{i}", help="Program Ekle"):
                    st.session_state[f"show_scheduler_bonus_{i}"] = True
            
            # PlanlayÄ±cÄ± gÃ¶ster
            if st.session_state.get(f"show_scheduler_bonus_{i}", False):
                with st.expander("ğŸ—“ï¸ Program Ekle", expanded=True):
                    show_topic_scheduler_bonus(topic, user_data, i)

def show_topic_scheduler_bonus(topic, user_data, index):
    """Bonus konular iÃ§in Ã¶zel planlayÄ±cÄ±"""
    col1, col2 = st.columns(2)
    
    with col1:
        day_options = ["PAZARTESÄ°", "SALI", "Ã‡ARÅAMBA", "PERÅEMBE", "CUMA", "CUMARTESÄ°", "PAZAR"]
        selected_day = st.selectbox("GÃ¼n TÃ¼rÃ¼:", day_options, key=f"bonus_day_{index}")
    
    with col2:
        time_slots = [
            "09:00-10:30", "10:45-12:15", "13:30-15:00", 
            "15:15-16:45", "17:00-18:30", "19:00-20:30", "21:00-22:30"
        ]
        selected_time = st.selectbox("Saat aralÄ±ÄŸÄ±:", time_slots, key=f"bonus_time_{index}")
    
    if st.button("âœ… Bonus Konuyu Programa Ekle", key=f"confirm_bonus_{index}"):
        # Session state'e program ekle
        if 'weekly_schedule' not in st.session_state:
            st.session_state.weekly_schedule = {}
        
        if selected_day not in st.session_state.weekly_schedule:
            st.session_state.weekly_schedule[selected_day] = []
        
        # Bonus konu bilgisini ekle
        schedule_entry = {
            'time': selected_time,
            'subject': topic.get('subject', 'Ders'),
            'topic': topic.get('topic', 'Konu'),
            'detail': topic.get('detail', 'Detay'),
            'type': 'BONUS',
            'is_bonus': True
        }
        
        st.session_state.weekly_schedule[selected_day].append(schedule_entry)
        st.success(f"ğŸš€ Bonus konu {selected_day} gÃ¼nÃ¼ {selected_time} saatine eklendi!")
        st.session_state[f"show_scheduler_bonus_{index}"] = False
        st.rerun()

# === ğŸ† BASÄ°T REKABET SÄ°STEMÄ° ===

def competition_leaderboard_page(user_data):
    """ğŸ† Ä°steÄŸe BaÄŸlÄ± Rekabet Panosu"""
    st.markdown(f'<div class="main-header"><h1>ğŸ† Rekabet Panosu</h1><p>Ä°steÄŸe baÄŸlÄ± katÄ±lÄ±m - GÃ¼nlÃ¼k sosyal medya takibi! ğŸ“±â¬‡ï¸</p></div>', unsafe_allow_html=True)
    
    # GÃ¼nlÃ¼k temizlik kontrolÃ¼
    clean_old_daily_data()
    
    # Ä°steÄŸe baÄŸlÄ± rekabet sistemi
    show_simple_leaderboard(user_data)

def show_simple_leaderboard(user_data):
    """ğŸ† Basit Rekabet Listesi - Ä°steÄŸe BaÄŸlÄ± KatÄ±lÄ±m"""
    
    # KullanÄ±cÄ±nÄ±n oturum aÃ§Ä±p aÃ§madÄ±ÄŸÄ±nÄ± kontrol et
    if not user_data:
        st.warning("ğŸ” Rekabet sistemine katÄ±lmak iÃ§in Ã¶nce giriÅŸ yapmalÄ±sÄ±n!")
        return
    
    # KullanÄ±cÄ±nÄ±n katÄ±lÄ±m durumunu kontrol et (gÃ¼ncel veriyi al)
    current_user_data = user_data  # Parametre olarak gelen user_data'yÄ± kullan
    is_participating = current_user_data.get('competition_participating', False)
    
    # KatÄ±lÄ±m kontrolÃ¼ - KÄ±rmÄ±zÄ± tema
    st.markdown("### ğŸ¯ Rekabet Sistemi KatÄ±lÄ±mÄ±")
    
    col_join1, col_join2 = st.columns([3, 2])
    
    with col_join1:
        if is_participating:
            st.markdown("""
            <div style="background: linear-gradient(135deg, #27ae60 0%, #229954 100%); 
                        padding: 15px; border-radius: 10px; color: white; margin: 10px 0;">
                <h4 style="color: white; margin: 0;">âœ… Rekabet sistemine katÄ±lÄ±yorsun!</h4>
            </div>
            """, unsafe_allow_html=True)
        else:
            st.markdown("""
            <div style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); 
                        padding: 15px; border-radius: 10px; color: white; margin: 10px 0;">
                <h4 style="color: white; margin: 0;">ğŸ“¢ Rekabet sistemine katÄ±lmak istersen butona tÄ±kla</h4>
            </div>
            """, unsafe_allow_html=True)
    
    with col_join2:
        st.markdown("<br>", unsafe_allow_html=True)  # BoÅŸluk iÃ§in
        if is_participating:
            if st.button("ğŸšª Rekabetten AyrÄ±l", key="leave_competition", use_container_width=True):
                # Firebase'e kaydet
                update_user_in_firebase(st.session_state.current_user, {'competition_participating': False})
                
                # Session state'i de gÃ¼ncelle
                if 'user_data' in st.session_state:
                    st.session_state.user_data['competition_participating'] = False
                
                # GÃ¼ncel veriyi tekrar al
                st.session_state.user_data = get_user_data()
                
                st.success("âœ… Rekabetten ayrÄ±ldÄ±n! Liderboard'dan Ã§Ä±karÄ±ldÄ±n.")
                st.rerun()
        else:
            if st.button("ğŸ† Rekabete KatÄ±l", key="join_competition", use_container_width=True):
                # Firebase'e kaydet
                update_user_in_firebase(st.session_state.current_user, {'competition_participating': True})
                
                # Session state'i de gÃ¼ncelle
                if 'user_data' in st.session_state:
                    st.session_state.user_data['competition_participating'] = True
                
                # GÃ¼ncel veriyi tekrar al
                st.session_state.user_data = get_user_data()
                
                st.success("ğŸ† Rekabete katÄ±ldÄ±n! Liderboard'da gÃ¶rÃ¼nÃ¼yorsun.")
                st.rerun()
    
    # EÄŸer katÄ±lmÄ±yorsa sadece bilgi gÃ¶ster
    if not is_participating:
        st.markdown("---")
        st.markdown("### ğŸ“Š Rekabet Sistemine KatÄ±lmadÄ±n")
        st.markdown("""
        <div style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); 
                    padding: 20px; border-radius: 15px; color: white; margin: 10px 0; text-align: center;">
            <h4 style="color: white; margin-bottom: 15px;">ğŸ† Rekabete KatÄ±lmadÄ±n</h4>
            <div style="font-size: 16px; line-height: 1.6;">
                Rekabete katÄ±ldÄ±ÄŸÄ±nda:<br>
                â€¢ HaftalÄ±k sÄ±ralaman gÃ¶rÃ¼necek<br>
                â€¢ DiÄŸer Ã¶ÄŸrencilerle karÅŸÄ±laÅŸtÄ±rma yapabileceksin<br>
                â€¢ Sosyal medya takibin baÅŸlayacak<br>
                â€¢ Puanlama sistemine dahil olacaksÄ±n
            </div>
        </div>
        """, unsafe_allow_html=True)
        return
    
    st.markdown("---")
    
    # **YENÄ°**: Kendisiyle yarÄ±ÅŸma sistemi 
    show_self_competition_section(current_user_data)
    
    st.markdown("---")
    
    # HaftalÄ±k liderboard hesapla (sadece katÄ±lanlar)
    weekly_leaders = calculate_weekly_leaderboard()
    current_user_stats = calculate_user_weekly_performance(current_user_data)
    
    # Debug: Sosyal medya verisini kontrol et
    sm_debug_data = current_user_data.get('social_media_daily', '{}')
    st.write(f"ğŸ” Debug - User data'daki sosyal medya: {sm_debug_data}")
    st.write(f"ğŸ” Debug - Hesaplanan sosyal medya saati: {current_user_stats.get('social_media_hours', 0)}")
    
    # BugÃ¼nkÃ¼ tarih key'i de gÃ¶sterelim
    today_debug = datetime.now().strftime('%Y-%m-%d')
    st.write(f"ğŸ” Debug - BugÃ¼nkÃ¼ tarih key: {today_debug}")
    
    # KullanÄ±cÄ±nÄ±n sÄ±ralamasÄ±nÄ± bul
    user_rank = find_user_rank(weekly_leaders, st.session_state.current_user)
    
    # GÃ¼nlÃ¼k sosyal medya ekran sÃ¼resi giriÅŸi
    st.markdown("### ğŸ“± GÃ¼nlÃ¼k Sosyal Medya Bildirimi")
    
    # BugÃ¼nkÃ¼ durumu kontrol et
    today_key = datetime.now().strftime('%Y-%m-%d')
    user_sm_data = get_user_daily_social_media(st.session_state.current_user)
    
    if today_key in user_sm_data:
        st.markdown(f"""
        <div style="background: linear-gradient(135deg, #27ae60 0%, #229954 100%); 
                    padding: 15px; border-radius: 10px; color: white; margin: 10px 0;">
            <h4 style="color: white; margin: 0;">âœ… BugÃ¼n sosyal medya sÃ¼ren kaydedildi: {user_sm_data[today_key]:.1f} saat</h4>
        </div>
        """, unsafe_allow_html=True)
    else:
        col_sm1, col_sm2 = st.columns([3, 2])
        
        with col_sm1:
            st.markdown("**BugÃ¼n sosyal medyada ne kadar zaman geÃ§irdin?**")
            col_h, col_m = st.columns(2)
            
            with col_h:
                social_media_hours = st.number_input("Saat", min_value=0.0, max_value=24.0, value=0.0, step=0.5, key="sm_hours")
            with col_m:
                social_media_minutes = st.number_input("Dakika", min_value=0, max_value=59, value=0, key="sm_minutes")
            
            total_sm_time = social_media_hours + (social_media_minutes / 60)
        
        with col_sm2:
            st.markdown("**ğŸ“± Ekran gÃ¶rÃ¼ntÃ¼sÃ¼**")
            uploaded_screenshot = st.file_uploader("Telefon ayarlarÄ±ndan ss", type=['png', 'jpg', 'jpeg'], key="sm_screenshot")
            
            if st.button("ğŸ’¾ BugÃ¼nÃ¼ Kaydet", key="save_sm_time", use_container_width=True):
                if uploaded_screenshot and total_sm_time > 0:
                    # Veriyi kaydet
                    result = save_daily_social_media_time(st.session_state.current_user, total_sm_time)
                    
                    # Debug: Kaydedilen veriyi kontrol et
                    user_data_check = get_user_data()
                    sm_data_check = user_data_check.get('social_media_daily', '{}')
                    
                    st.success(f"âœ… BugÃ¼n kaydedildi: {total_sm_time:.1f}h")
                    st.info(f"ğŸ” Debug: Firebase'deki veri: {sm_data_check}")
                    st.rerun()
                else:
                    st.error("SÃ¼re ve SS gerekli!")
    
    st.markdown("---")
    
    # KÄ±rmÄ±zÄ± tema metrik kartlarÄ± - Sade ve modern
    st.markdown("""
    <style>
    .metric-card {
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        padding: 20px;
        border-radius: 15px;
        text-align: center;
        color: white;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        margin: 10px 0;
    }
    .metric-value {
        font-size: 28px;
        font-weight: bold;
        margin: 10px 0;
        color: white;
    }
    .metric-label {
        font-size: 14px;
        opacity: 0.9;
        color: white;
    }
    .metric-card-special {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        padding: 20px;
        border-radius: 15px;
        text-align: center;
        color: white;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        margin: 10px 0;
    }
    </style>
    """, unsafe_allow_html=True)
    
    col1, col2, col3, col4, col5 = st.columns(5)
    
    progress_avg = (current_user_stats['tyt_progress'] + current_user_stats['ayt_progress']) / 2
    
    with col1:
        rank_text = f"#{user_rank}" if user_rank else "---"
        st.markdown(f"""
        <div class="metric-card">
            <div class="metric-label">ğŸ† HaftalÄ±k SÄ±ralama</div>
            <div class="metric-value">{rank_text}</div>
        </div>
        """, unsafe_allow_html=True)
    
    with col2:
        st.markdown(f"""
        <div class="metric-card">
            <div class="metric-label">ğŸ“ Soru SayÄ±sÄ±</div>
            <div class="metric-value">{current_user_stats['questions_solved']}</div>
        </div>
        """, unsafe_allow_html=True)
    
    with col3:
        st.markdown(f"""
        <div class="metric-card">
            <div class="metric-label">ğŸ“ˆ Ä°lerleme OranÄ±</div>
            <div class="metric-value">%{progress_avg:.1f}</div>
        </div>
        """, unsafe_allow_html=True)
    
    with col4:
        st.markdown(f"""
        <div class="metric-card">
            <div class="metric-label">â±ï¸ Ã‡alÄ±ÅŸma Saati</div>
            <div class="metric-value">{current_user_stats['study_hours']:.1f}h</div>
        </div>
        """, unsafe_allow_html=True)
    
    with col5:
        st.markdown(f"""
        <div class="metric-card-special">
            <div class="metric-label">ğŸ“± Sosyal Medya</div>
            <div class="metric-value">{current_user_stats['social_media_hours']:.1f}h</div>
        </div>
        """, unsafe_allow_html=True)
    
    # Ana liderboard tablosu
    st.markdown("---")
    st.markdown("### ğŸ† HaftalÄ±k Liderler")
    st.caption("Her Pazartesi gÃ¼ncellenir")
    
    if not weekly_leaders:
        st.info("ğŸ“Š HenÃ¼z veri yok. Ä°lk lider olun!")
        return
    
    # Top 20 gÃ¶ster (donmamasÄ± iÃ§in)
    for i, leader in enumerate(weekly_leaders[:20]):
        rank = i + 1
        
        # KÄ±rmÄ±zÄ± tema rozet sistemi - Sade ve modern
        if rank == 1:
            medal = "ğŸ¥‡"
            bg_color = "#e74c3c"
            border_color = "#FFD700"
            text_color = "#ffffff"
        elif rank == 2:
            medal = "ğŸ¥ˆ" 
            bg_color = "#c0392b"
            border_color = "#C0C0C0"
            text_color = "#ffffff"
        elif rank == 3:
            medal = "ğŸ¥‰"
            bg_color = "#a93226"
            border_color = "#CD7F32"
            text_color = "#ffffff"
        elif rank <= 10:
            medal = f"{rank}ï¸âƒ£"
            bg_color = "#922b21"
            border_color = "#e74c3c"
            text_color = "#ffffff"
        else:
            medal = f"{rank}"
            bg_color = "#641e16"
            border_color = "#c0392b"
            text_color = "#ffffff"
        
        # Ä°lerleme oranÄ± hesapla
        avg_progress = (leader['tyt_progress'] + leader['ayt_progress']) / 2
        
        # KÄ±sa isim (ilk 15 karakter)
        display_name = leader['username'][:15] + "..." if len(leader['username']) > 15 else leader['username']
        
        # Modern lider kartÄ± - BÃ¼yÃ¼k ve okunabilir
        st.markdown(f"""
        <div style="background: {bg_color}; padding: 20px; margin: 12px 0; border-radius: 15px; 
                    border-left: 6px solid {border_color}; display: flex; align-items: center; 
                    box-shadow: 0 4px 8px rgba(0,0,0,0.15); transition: all 0.3s ease;">
            <div style="font-size: 36px; margin-right: 25px; min-width: 60px; text-align: center;">{medal}</div>
            <div style="flex: 1;">
                <div style="font-size: 22px; font-weight: bold; color: {text_color}; margin-bottom: 8px;">{display_name}</div>
                <div style="font-size: 16px; color: {text_color}; font-weight: 500; line-height: 1.4;">
                    ğŸ“ <span style="font-weight: bold;">{leader['questions_solved']}</span> soru | 
                    ğŸ“ˆ <span style="font-weight: bold;">%{avg_progress:.1f}</span> | 
                    â±ï¸ <span style="font-weight: bold;">{leader['study_hours']:.1f}h</span> | 
                    ğŸ“± <span style="color: #ff6b6b; font-weight: bold;">{leader['social_media_hours']:.1f}h</span>
                </div>
            </div>
        </div>
        """, unsafe_allow_html=True)
    
    # KullanÄ±cÄ±nÄ±n pozisyonu (eÄŸer top 20'de deÄŸilse)
    if user_rank and user_rank > 20:
        st.markdown("---")
        st.markdown(f"### ğŸ“ Sizin Pozisyonunuz: #{user_rank}")
        
        # KullanÄ±cÄ±nÄ±n kartÄ±nÄ± gÃ¶ster - KÄ±rmÄ±zÄ± tema
        avg_progress = (current_user_stats['tyt_progress'] + current_user_stats['ayt_progress']) / 2
        st.markdown(f"""
        <div style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); padding: 20px; border-radius: 15px; 
                    border-left: 6px solid #2c3e50; box-shadow: 0 4px 8px rgba(0,0,0,0.15);">
            <div style="font-size: 22px; font-weight: bold; color: #ffffff; margin-bottom: 8px;">
                {st.session_state.current_user}
            </div>
            <div style="font-size: 16px; color: #ffffff; font-weight: 500; line-height: 1.4;">
                ğŸ“ <span style="font-weight: bold;">{current_user_stats['questions_solved']}</span> soru | 
                ğŸ“ˆ <span style="font-weight: bold;">%{avg_progress:.1f}</span> | 
                â±ï¸ <span style="font-weight: bold;">{current_user_stats['study_hours']:.1f}h</span> | 
                ğŸ“± <span style="color: #2c3e50; font-weight: bold;">{current_user_stats['social_media_hours']:.1f}h</span>
            </div>
        </div>
        """, unsafe_allow_html=True)
    
    # Puanlama sistemi aÃ§Ä±klamasÄ± - Modern tasarÄ±m
    st.markdown("---")
    st.markdown("### ğŸ“Š Puanlama Sistemi")
    
    col_info1, col_info2 = st.columns(2)
    
    with col_info1:
        st.markdown("""
        <div style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); 
                    padding: 20px; border-radius: 15px; color: white; margin: 10px 0;">
            <h4 style="color: white; margin-bottom: 15px;">ğŸ† NasÄ±l PuanlanÄ±yor?</h4>
            <div style="font-size: 16px; line-height: 1.6;">
                ğŸ“ <strong>Soru Ã§Ã¶zme:</strong> Her 10 soru = +1 puan<br>
                ğŸ“ˆ <strong>Ä°lerleme:</strong> Her %10 TYT/AYT = +1 puan<br>
                â±ï¸ <strong>Ã‡alÄ±ÅŸma saati:</strong> Her saat = +1 puan<br>
                ğŸ“± <strong>Sosyal medya:</strong> Her saat = -0.5 puan
            </div>
        </div>
        """, unsafe_allow_html=True)
    
    with col_info2:
        st.markdown("""
        <div style="background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); 
                    padding: 20px; border-radius: 15px; color: white; margin: 10px 0;">
            <h4 style="color: white; margin-bottom: 15px;">ğŸ“± GÃ¼nlÃ¼k Sistem</h4>
            <div style="font-size: 16px; line-height: 1.6;">
                âœ… <strong>Her gÃ¼n</strong> sosyal medya sÃ¼reni bildir<br>
                ğŸ—“ï¸ <strong>7 gÃ¼n</strong> veri tutulur<br>
                ğŸ”„ <strong>Pazartesi</strong> yeni hafta baÅŸlar<br>
                ğŸ“¸ <strong>Ekran gÃ¶rÃ¼ntÃ¼sÃ¼</strong> zorunlu
            </div>
        </div>
        """, unsafe_allow_html=True)
    
    st.markdown("""
    <div style="background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); 
                padding: 15px; border-radius: 10px; text-align: center; color: white; margin: 20px 0;">
        <h4 style="color: white; margin: 0;">ğŸ’¡ Sosyal medyayÄ± azalt, Ã§alÄ±ÅŸma saatini artÄ±r!</h4>
    </div>
    """, unsafe_allow_html=True)

def calculate_weekly_leaderboard():
    """HaftalÄ±k liderboard hesaplar - Sadece katÄ±lan kullanÄ±cÄ±lar"""
    try:
        # Firebase'den tÃ¼m kullanÄ±cÄ± verilerini al (3 saniye timeout)
        users_data = load_users_from_firebase()
        
        if not users_data:
            return []
        
        weekly_leaders = []
        
        for username, user_data in users_data.items():
            try:
                # Sadece rekabete katÄ±lan kullanÄ±cÄ±larÄ± dahil et
                if not user_data.get('competition_participating', False):
                    continue
                
                # KullanÄ±cÄ±nÄ±n haftalÄ±k performansÄ±nÄ± hesapla
                performance = calculate_user_weekly_performance(user_data)
                performance['username'] = username
                weekly_leaders.append(performance)
                
            except Exception:
                # HatalÄ± veri varsa atla
                continue
        
        # Toplam skorla sÄ±rala (4 kriterin toplamÄ±)
        weekly_leaders.sort(key=lambda x: x['total_score'], reverse=True)
        
        return weekly_leaders
        
    except Exception as e:
        st.error(f"âš ï¸ Liderboard hesaplanÄ±rken hata: {e}")
        return []

def calculate_user_weekly_performance(user_data):
    """KullanÄ±cÄ±nÄ±n haftalÄ±k performansÄ±nÄ± hesaplar - 3 kriter"""
    try:
        # Bu haftanÄ±n baÅŸÄ± (Pazartesi)
        today = datetime.now()
        week_start = today - timedelta(days=today.weekday())
        week_start_date = week_start.date()
        
        # 1. SORU Ã‡Ã–ZME SAYISI - Deneme analizlerinden al
        questions_solved = 0
        try:
            deneme_data_str = user_data.get('deneme_analizleri', '[]')
            if isinstance(deneme_data_str, str):
                deneme_kayitlari = json.loads(deneme_data_str) if deneme_data_str else []
            else:
                deneme_kayitlari = deneme_data_str if isinstance(deneme_data_str, list) else []
            
            # Bu hafta yapÄ±lan denemelerdeki sorularÄ± say
            for deneme in deneme_kayitlari:
                try:
                    deneme_tarihi = datetime.strptime(deneme.get('tarih', '2025-01-01'), '%Y-%m-%d').date()
                    if deneme_tarihi >= week_start_date:
                        questions_solved += deneme.get('toplam_dogru', 0)
                except:
                    continue
        except:
            pass
        
        # 2. TYT/AYT Ä°LERLEME ORANI - Konu takip verilerinden
        tyt_progress = 0
        ayt_progress = 0
        try:
            # TYT konularÄ±
            tyt_subjects = ['TÃ¼rkÃ§e', 'Matematik', 'Geometri', 'Fizik', 'Kimya', 'Biyoloji', 'Tarih', 'CoÄŸrafya', 'Felsefe', 'Din']
            tyt_total = 0
            tyt_completed = 0
            
            for subject in tyt_subjects:
                subject_data = user_data.get(f'{subject.lower()}_progress', {})
                if isinstance(subject_data, dict):
                    for topic_data in subject_data.values():
                        if isinstance(topic_data, dict):
                            tyt_total += 1
                            if topic_data.get('completed', False):
                                tyt_completed += 1
            
            if tyt_total > 0:
                tyt_progress = (tyt_completed / tyt_total) * 100
            
            # AYT konularÄ± (basitleÅŸtirilmiÅŸ)
            ayt_subjects = ['AYT Matematik', 'AYT Fizik', 'AYT Kimya', 'AYT Biyoloji']
            ayt_total = 0
            ayt_completed = 0
            
            for subject in ayt_subjects:
                subject_key = subject.lower().replace(' ', '_').replace('ayt_', '') + '_progress'
                subject_data = user_data.get(subject_key, {})
                if isinstance(subject_data, dict):
                    for topic_data in subject_data.values():
                        if isinstance(topic_data, dict):
                            ayt_total += 1
                            if topic_data.get('completed', False):
                                ayt_completed += 1
            
            if ayt_total > 0:
                ayt_progress = (ayt_completed / ayt_total) * 100
                
        except:
            pass
        
        # 3. Ã‡ALIÅMA SAATÄ° - Pomodoro verilerinden
        study_hours = 0
        try:
            pomodoro_history_str = user_data.get('pomodoro_history', '[]')
            
            if isinstance(pomodoro_history_str, str):
                pomodoro_history = json.loads(pomodoro_history_str) if pomodoro_history_str else []
            else:
                pomodoro_history = pomodoro_history_str if isinstance(pomodoro_history_str, list) else []
            
            # Bu haftanÄ±n pomodorolarÄ±nÄ± say
            total_minutes = 0
            for p in pomodoro_history:
                try:
                    pomodoro_date = datetime.fromisoformat(p['timestamp']).date()
                    if pomodoro_date >= week_start_date:
                        duration_map = {
                            'KÄ±sa Odak (25dk+5dk)': 25,
                            'Standart Odak (35dk+10dk)': 35,
                            'Derin Odak (50dk+15dk)': 50,
                            'Tam Konsantrasyon (90dk+25dk)': 90
                        }
                        total_minutes += duration_map.get(p.get('type', 'KÄ±sa Odak (25dk+5dk)'), 25)
                except:
                    continue
            
            study_hours = total_minutes / 60
            
        except:
            pass
        
        # 4. SOSYAL MEDYA EKRAN SÃœRESÄ° - Bu haftanÄ±n gÃ¼nlÃ¼k toplamÄ±
        social_media_hours = 0
        try:
            social_media_str = user_data.get('social_media_daily', '{}')
            social_media_data = json.loads(social_media_str) if social_media_str else {}
            
            # Bu haftanÄ±n gÃ¼nlerini topla (bugÃ¼n dahil)
            current_date = today.date()
            for i in range(7):  # Son 7 gÃ¼n 
                day_date = today - timedelta(days=i)
                day_key = day_date.strftime('%Y-%m-%d')
                
                # Bu hafta iÃ§indeki gÃ¼nleri kontrol et (bugÃ¼n dahil)
                if day_date.date() >= week_start_date and day_date.date() <= current_date:
                    if day_key in social_media_data:
                        social_media_hours += social_media_data[day_key]
                
        except:
            pass
        
        # TOPLAM SKOR hesapla (yeni sosyal medya puanlamasÄ± dahil)
        # Soru sayÄ±sÄ±: her 10 soru = 1 puan
        # Ä°lerleme: her %10 = 1 puan  
        # Ã‡alÄ±ÅŸma saati: her saat = 1 puan
        # Sosyal medya: az kullanan kazanÄ±r - her saat iÃ§in -0.5 puan
        positive_score = (questions_solved / 10) + ((tyt_progress + ayt_progress) / 20) + study_hours
        social_media_penalty = social_media_hours * 0.5  # Sosyal medya cezasÄ±
        total_score = positive_score - social_media_penalty
        
        return {
            'questions_solved': questions_solved,
            'tyt_progress': tyt_progress,
            'ayt_progress': ayt_progress,
            'study_hours': study_hours,
            'social_media_hours': social_media_hours,
            'total_score': total_score
        }
        
    except Exception as e:
        # Hata durumunda sÄ±fÄ±r deÄŸerler
        return {
            'questions_solved': 0,
            'tyt_progress': 0.0,
            'ayt_progress': 0.0,
            'study_hours': 0.0,
            'social_media_hours': 0.0,
            'total_score': 0.0
        }

def save_daily_social_media_time(username, total_hours):
    """GÃ¼nlÃ¼k sosyal medya ekran sÃ¼resini kaydet"""
    try:
        today_key = datetime.now().strftime('%Y-%m-%d')
        
        # KullanÄ±cÄ± verilerini al
        user_data = get_user_data()
        
        # Sosyal medya verilerini al veya oluÅŸtur
        social_media_data_str = user_data.get('social_media_daily', '{}')
        try:
            social_media_data = json.loads(social_media_data_str) if social_media_data_str else {}
        except:
            social_media_data = {}
        
        # BugÃ¼nÃ¼n verisini kaydet
        social_media_data[today_key] = total_hours
        
        # Firebase'e kaydet
        update_user_in_firebase(username, {'social_media_daily': json.dumps(social_media_data)})
        
        return True
        
    except Exception as e:
        st.error(f"GÃ¼nlÃ¼k sosyal medya verisi kaydedilirken hata: {e}")
        return False

def get_user_daily_social_media(username):
    """KullanÄ±cÄ±nÄ±n gÃ¼nlÃ¼k sosyal medya verilerini al"""
    try:
        # Mevcut kullanÄ±cÄ± verilerini al
        if username == st.session_state.current_user:
            user_data = get_user_data()
        else:
            users_db = load_users_from_firebase()
            user_data = users_db.get(username, {})
        
        social_media_str = user_data.get('social_media_daily', '{}')
        return json.loads(social_media_str) if social_media_str else {}
    except:
        return {}

def show_self_competition_section(user_data):
    """Kendisiyle yarÄ±ÅŸma bÃ¶lÃ¼mÃ¼ - En bÃ¼yÃ¼k zafer dÃ¼nkÃ¼ senle bugÃ¼nkÃ¼ senin arasÄ±ndaki farktÄ±r"""
    st.markdown("### ğŸ¯ Kendisiyle YarÄ±ÅŸma - En BÃ¼yÃ¼k Zafer!")
    
    # Son 7 gÃ¼nÃ¼n verilerini al
    personal_progress = get_personal_weekly_progress(st.session_state.current_user)
    
    if len(personal_progress) < 2:
        st.markdown("""
        <div style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); 
                    padding: 15px; border-radius: 10px; color: white; margin: 10px 0; text-align: center;">
            <h4 style="color: white; margin: 0;">ğŸ’ª Kendini geÃ§meye baÅŸla!</h4>
            <p style="margin: 5px 0;">En az 2 gÃ¼n veri olunca kendi geliÅŸimini gÃ¶rebileceksin</p>
        </div>
        """, unsafe_allow_html=True)
        return
    
    # Son gÃ¼n vs Ã¶nceki gÃ¼n karÅŸÄ±laÅŸtÄ±rmasÄ±
    latest_day = personal_progress[-1]
    previous_day = personal_progress[-2]
    
    col_self1, col_self2, col_self3 = st.columns(3)
    
    # Sosyal medya karÅŸÄ±laÅŸtÄ±rmasÄ± (az olan iyi)
    sm_diff = latest_day['social_media'] - previous_day['social_media']
    sm_trend = "ğŸ“‰" if sm_diff < 0 else "ğŸ“ˆ" if sm_diff > 0 else "â¡ï¸"
    sm_color = "#27ae60" if sm_diff < 0 else "#e74c3c" if sm_diff > 0 else "#f39c12"
    
    # Ã‡alÄ±ÅŸma saati karÅŸÄ±laÅŸtÄ±rmasÄ± (Ã§ok olan iyi)
    study_diff = latest_day['study_hours'] - previous_day['study_hours']
    study_trend = "ğŸ“ˆ" if study_diff > 0 else "ğŸ“‰" if study_diff < 0 else "â¡ï¸"
    study_color = "#27ae60" if study_diff > 0 else "#e74c3c" if study_diff < 0 else "#f39c12"
    
    # Soru karÅŸÄ±laÅŸtÄ±rmasÄ± (Ã§ok olan iyi)
    question_diff = latest_day['questions'] - previous_day['questions']
    question_trend = "ğŸ“ˆ" if question_diff > 0 else "ğŸ“‰" if question_diff < 0 else "â¡ï¸"
    question_color = "#27ae60" if question_diff > 0 else "#e74c3c" if question_diff < 0 else "#f39c12"
    
    with col_self1:
        st.markdown(f"""
        <div style="background: linear-gradient(135deg, {sm_color} 0%, {sm_color}AA 100%); 
                    padding: 15px; border-radius: 10px; color: white; text-align: center;">
            <div style="font-size: 24px;">{sm_trend}</div>
            <div style="font-size: 16px; font-weight: bold;">Sosyal Medya</div>
            <div style="font-size: 14px;">DÃ¼n: {previous_day['social_media']:.1f}h</div>
            <div style="font-size: 14px;">BugÃ¼n: {latest_day['social_media']:.1f}h</div>
            <div style="font-size: 12px;">Fark: {sm_diff:+.1f}h</div>
        </div>
        """, unsafe_allow_html=True)
    
    with col_self2:
        st.markdown(f"""
        <div style="background: linear-gradient(135deg, {study_color} 0%, {study_color}AA 100%); 
                    padding: 15px; border-radius: 10px; color: white; text-align: center;">
            <div style="font-size: 24px;">{study_trend}</div>
            <div style="font-size: 16px; font-weight: bold;">Ã‡alÄ±ÅŸma Saati</div>
            <div style="font-size: 14px;">DÃ¼n: {previous_day['study_hours']:.1f}h</div>
            <div style="font-size: 14px;">BugÃ¼n: {latest_day['study_hours']:.1f}h</div>
            <div style="font-size: 12px;">Fark: {study_diff:+.1f}h</div>
        </div>
        """, unsafe_allow_html=True)
    
    with col_self3:
        st.markdown(f"""
        <div style="background: linear-gradient(135deg, {question_color} 0%, {question_color}AA 100%); 
                    padding: 15px; border-radius: 10px; color: white; text-align: center;">
            <div style="font-size: 24px;">{question_trend}</div>
            <div style="font-size: 16px; font-weight: bold;">Soru SayÄ±sÄ±</div>
            <div style="font-size: 14px;">DÃ¼n: {previous_day['questions']}</div>
            <div style="font-size: 14px;">BugÃ¼n: {latest_day['questions']}</div>
            <div style="font-size: 12px;">Fark: {question_diff:+}</div>
        </div>
        """, unsafe_allow_html=True)
    
    # Toplam motivasyon skoru
    motivation_score = 0
    if sm_diff < 0: motivation_score += 2  # Sosyal medya azalÄ±rsa +2
    if study_diff > 0: motivation_score += 3  # Ã‡alÄ±ÅŸma artÄ±rsa +3
    if question_diff > 0: motivation_score += 3  # Soru artÄ±rsa +3
    
    if motivation_score >= 6:
        motivation_msg = "ğŸ† MÃœTHIÅ GELÄ°ÅÄ°M! Kendini geÃ§tin!"
        motivation_color = "#27ae60"
    elif motivation_score >= 3:
        motivation_msg = "ğŸ’ª Ä°YÄ° GÄ°DÄ°YOR! Devam et!"
        motivation_color = "#f39c12"
    else:
        motivation_msg = "ğŸ”¥ DAHA Ä°YÄ°SÄ°NÄ° YAPABÄ°LÄ°RSÄ°N!"
        motivation_color = "#e74c3c"
    
    st.markdown(f"""
    <div style="background: linear-gradient(135deg, {motivation_color} 0%, {motivation_color}AA 100%); 
                padding: 20px; border-radius: 15px; color: white; text-align: center; margin: 15px 0;">
        <h3 style="color: white; margin: 0;">{motivation_msg}</h3>
        <p style="margin: 5px 0;">âœ¨ "En bÃ¼yÃ¼k zafer dÃ¼nkÃ¼ senle bugÃ¼nkÃ¼ senin arasÄ±ndaki farktÄ±r" âœ¨</p>
    </div>
    """, unsafe_allow_html=True)

def get_personal_weekly_progress(username):
    """Son 7 gÃ¼nÃ¼n kiÅŸisel geliÅŸim verilerini al"""
    try:
        # KullanÄ±cÄ± verilerini al
        if username == st.session_state.current_user:
            user_data = get_user_data()
        else:
            users_db = load_users_from_firebase()
            user_data = users_db.get(username, {})
        
        # Sosyal medya verileri
        social_media_str = user_data.get('social_media_daily', '{}')
        social_media_data = json.loads(social_media_str) if social_media_str else {}
        
        # Pomodoro verileri
        pomodoro_str = user_data.get('pomodoro_history', '[]')
        pomodoro_data = json.loads(pomodoro_str) if pomodoro_str else []
        
        # Deneme verileri
        deneme_str = user_data.get('deneme_analizleri', '[]')
        deneme_data = json.loads(deneme_str) if deneme_str else []
        
        # Son 7 gÃ¼nÃ¼n verilerini topla
        progress_data = []
        today = datetime.now()
        
        for i in range(7):
            day_date = today - timedelta(days=i)
            day_key = day_date.strftime('%Y-%m-%d')
            
            # O gÃ¼nÃ¼n sosyal medya sÃ¼resi
            daily_sm = social_media_data.get(day_key, 0)
            
            # O gÃ¼nÃ¼n Ã§alÄ±ÅŸma saati (pomodoro)
            daily_study = 0
            for p in pomodoro_data:
                try:
                    if datetime.fromisoformat(p['timestamp']).date() == day_date.date():
                        duration_map = {
                            'KÄ±sa Odak (25dk+5dk)': 25,
                            'Standart Odak (35dk+10dk)': 35,
                            'Derin Odak (50dk+15dk)': 50,
                            'Tam Konsantrasyon (90dk+25dk)': 90
                        }
                        daily_study += duration_map.get(p.get('type', 'KÄ±sa Odak (25dk+5dk)'), 25)
                except:
                    continue
            daily_study = daily_study / 60  # Dakikadan saate Ã§evir
            
            # O gÃ¼nÃ¼n soru sayÄ±sÄ±
            daily_questions = 0
            for deneme in deneme_data:
                try:
                    if datetime.strptime(deneme.get('tarih', '2025-01-01'), '%Y-%m-%d').date() == day_date.date():
                        daily_questions += deneme.get('toplam_dogru', 0)
                except:
                    continue
            
            progress_data.append({
                'date': day_key,
                'social_media': daily_sm,
                'study_hours': daily_study,
                'questions': daily_questions
            })
        
        # Eski tarihten yeni tarihe sÄ±rala
        return list(reversed(progress_data))
        
    except Exception as e:
        return []

def find_user_rank(weekly_leaders, username):
    """KullanÄ±cÄ±nÄ±n haftalÄ±k sÄ±ralamasÄ±nÄ± bulur"""
    for i, leader in enumerate(weekly_leaders):
        if leader['username'] == username:
            return i + 1
    return None

def clean_old_daily_data():
    """7 gÃ¼nden eski gÃ¼nlÃ¼k sosyal medya verilerini temizler"""
    try:
        today = datetime.now()
        
        # TÃ¼m kullanÄ±cÄ±larÄ± al
        users_data = load_users_from_firebase()
        if not users_data:
            return
            
        for username, user_data in users_data.items():
            try:
                # GÃ¼nlÃ¼k sosyal medya verilerini temizle (7 gÃ¼nden eski)
                social_media_str = user_data.get('social_media_daily', '{}')
                social_media_data = json.loads(social_media_str) if social_media_str else {}
                
                # Son 7 gÃ¼nÃ¼ hesapla
                days_to_keep = []
                for i in range(7):  # Son 7 gÃ¼n
                    day_date = today - timedelta(days=i)
                    day_key = day_date.strftime('%Y-%m-%d')
                    days_to_keep.append(day_key)
                
                # Sadece son 7 gÃ¼nÃ¼ tut
                cleaned_data = {k: v for k, v in social_media_data.items() if k in days_to_keep}
                
                if cleaned_data != social_media_data:
                    update_user_in_firebase(username, {'social_media_daily': json.dumps(cleaned_data)})
                    
            except Exception:
                continue
                
    except Exception as e:
        print(f"GÃ¼nlÃ¼k temizlik hatasÄ±: {e}")

# ğŸ® GAMÄ°FÄ°CATÄ°ON UI BÄ°LEÅENLERÄ°

def show_gamification_dashboard():
    """Gamification dashboard'unu gÃ¶ster"""
    if 'gamification' not in st.session_state:
        init_gamification_system()
    
    st.markdown("### ğŸ® BaÅŸarÄ± ve Ä°lerleme Paneli")
    
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        level = st.session_state.gamification['level']
        level_info = LEVEL_SYSTEM["level_rewards"].get(level, {"name": f"Seviye {level}", "icon": "ğŸ¯"})
        st.metric("ğŸ‘¤ Seviye", f"{level} - {level_info['name']}")
    
    with col2:
        total_points = st.session_state.gamification['total_points']
        next_level_threshold = LEVEL_SYSTEM["level_thresholds"][min(level, len(LEVEL_SYSTEM["level_thresholds"])-1)]
        remaining = max(0, next_level_threshold - total_points)
        st.metric("â­ Toplam Puan", f"{total_points:,}", delta=f"Sonraki seviyeye: {remaining}")
    
    with col3:
        daily_streak = st.session_state.gamification['daily_streak']
        st.metric("ğŸ”¥ GÃ¼nlÃ¼k Seri", f"{daily_streak} gÃ¼n")
    
    with col4:
        badge_count = len(st.session_state.gamification['badges'])
        st.metric("ğŸ† Rozetler", badge_count)
    
    # Ä°lerleme Ã§ubuÄŸu
    if level < len(LEVEL_SYSTEM["level_thresholds"])-1:
        current_threshold = LEVEL_SYSTEM["level_thresholds"][level-1] if level > 0 else 0
        next_threshold = LEVEL_SYSTEM["level_thresholds"][level]
        progress = (total_points - current_threshold) / (next_threshold - current_threshold)
        st.progress(min(1.0, progress))
        st.caption(f"Seviye {level+1} iÃ§in {next_threshold - total_points} puan kaldÄ±")

def show_achievements_section():
    """BaÅŸarÄ± rozetleri bÃ¶lÃ¼mÃ¼nÃ¼ gÃ¶ster"""
    if 'gamification' not in st.session_state:
        init_gamification_system()
    
    st.subheader("ğŸ† BaÅŸarÄ± Rozetlerin")
    
    if st.session_state.gamification['badges']:
        # Rozetleri kategorilere ayÄ±r
        topic_badges = []
        subject_badges = []
        streak_badges = []
        
        for badge_id in st.session_state.gamification['badges']:
            if badge_id in ACHIEVEMENT_BADGES["topic_milestones"]:
                topic_badges.append(ACHIEVEMENT_BADGES["topic_milestones"][badge_id])
            elif badge_id in ACHIEVEMENT_BADGES["subject_expertise"]:
                subject_badges.append(ACHIEVEMENT_BADGES["subject_expertise"][badge_id])
            elif badge_id in ACHIEVEMENT_BADGES["streak_badges"]:
                streak_badges.append(ACHIEVEMENT_BADGES["streak_badges"][badge_id])
        
        # Kategoriler halinde gÃ¶ster
        if topic_badges:
            st.markdown("**ğŸ¯ Konu BaÅŸarÄ±larÄ±**")
            cols = st.columns(min(4, len(topic_badges)))
            for i, badge in enumerate(topic_badges):
                with cols[i % 4]:
                    st.markdown(f"""
                    <div style="text-align: center; padding: 15px; border: 2px solid #gold; 
                               border-radius: 10px; margin: 5px; background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);">
                        <div style="font-size: 2em;">{badge['icon']}</div>
                        <div style="font-weight: bold; color: #8B4513;">{badge['name']}</div>
                        <div style="font-size: 0.8em; color: #8B4513;">{badge['description']}</div>
                        <div style="font-size: 0.7em; color: #8B4513;">+{badge['points']} puan</div>
                    </div>
                    """, unsafe_allow_html=True)
        
        if subject_badges:
            st.markdown("**ğŸ“š UzmanlÄ±k Rozetleri**")
            cols = st.columns(min(4, len(subject_badges)))
            for i, badge in enumerate(subject_badges):
                with cols[i % 4]:
                    st.markdown(f"""
                    <div style="text-align: center; padding: 15px; border: 2px solid #silver; 
                               border-radius: 10px; margin: 5px; background: linear-gradient(135deg, #C0C0C0 0%, #708090 100%);">
                        <div style="font-size: 2em;">{badge['icon']}</div>
                        <div style="font-weight: bold; color: white;">{badge['name']}</div>
                        <div style="font-size: 0.8em; color: white;">{badge['description']}</div>
                        <div style="font-size: 0.7em; color: white;">+{badge['points']} puan</div>
                    </div>
                    """, unsafe_allow_html=True)
        
        if streak_badges:
            st.markdown("**âš¡ SÃ¼reklilik Rozetleri**")
            cols = st.columns(min(4, len(streak_badges)))
            for i, badge in enumerate(streak_badges):
                with cols[i % 4]:
                    st.markdown(f"""
                    <div style="text-align: center; padding: 15px; border: 2px solid #bronze; 
                               border-radius: 10px; margin: 5px; background: linear-gradient(135deg, #CD7F32 0%, #A0522D 100%);">
                        <div style="font-size: 2em;">{badge['icon']}</div>
                        <div style="font-weight: bold; color: white;">{badge['name']}</div>
                        <div style="font-size: 0.8em; color: white;">{badge['description']}</div>
                        <div style="font-size: 0.7em; color: white;">+{badge['points']} puan</div>
                    </div>
                    """, unsafe_allow_html=True)
    else:
        st.info("ğŸš€ HenÃ¼z rozet kazanmadÄ±n! Ä°lk konunu tamamlayarak baÅŸla!")

def show_daily_challenges():
    """GÃ¼nlÃ¼k challenge'larÄ± gÃ¶ster"""
    if 'gamification' not in st.session_state:
        init_gamification_system()
    
    st.subheader("ğŸ¯ GÃ¼nlÃ¼k GÃ¶revler")
    
    today = datetime.now().strftime("%Y-%m-%d")
    
    for challenge in st.session_state.gamification['current_challenges']['daily']:
        progress = get_challenge_progress(challenge, today)
        completion_percentage = min(100, (progress / challenge.get('target', 1)) * 100)
        
        col1, col2 = st.columns([3, 1])
        with col1:
            st.markdown(f"**{challenge['name']}** - {challenge['description']}")
            if 'target' in challenge:
                st.progress(completion_percentage / 100)
                st.caption(f"Ä°lerleme: {progress}/{challenge['target']}")
        with col2:
            if completion_percentage >= 100:
                st.success(f"âœ… +{challenge['points']} puan")
            else:
                st.info(f"ğŸ¯ {challenge['points']} puan")

def get_challenge_progress(challenge, date_key):
    """Challenge ilerlemesini al"""
    if 'gamification' not in st.session_state:
        return 0
    
    challenge_data = st.session_state.gamification['completed_challenges']['daily'].get(challenge['id'], {})
    return challenge_data.get(date_key, 0)

def show_achievement_notification(new_badges):
    """Yeni rozet bildirimi gÃ¶ster"""
    for badge in new_badges:
        st.balloons()
        st.success(f"ğŸ‰ Yeni rozet kazandÄ±n: {badge['icon']} **{badge['name']}** - {badge['description']}")

def show_level_up_notification(new_level):
    """Seviye atlama bildirimi gÃ¶ster"""
    st.balloons()
    st.success(f"ğŸŠ Tebrikler! Seviye {new_level}'e yÃ¼kseldin!")
    
    # Seviye Ã¶dÃ¼lÃ¼ varsa gÃ¶ster
    if new_level in LEVEL_SYSTEM["level_rewards"]:
        reward = LEVEL_SYSTEM["level_rewards"][new_level]
        st.info(f"ğŸ Seviye Ã¶dÃ¼lÃ¼: {reward['reward']}")

def complete_topic_with_gamification(subject, topic_name, difficulty_level):
    """Gamification ile konu tamamlama"""
    # Mevcut konu tamamlama iÅŸlemi...
    
    # Gamification ekle
    points, new_badges = update_topic_completion(subject, topic_name, difficulty_level)
    
    # Bildirimler
    st.success(f"ğŸ‰ Konu tamamlandÄ±! +{points} puan kazandÄ±n!")

# =====================================
# ğŸ¯ HEDEF BÃ–LÃœM ODAKLI ANALÄ°Z SÄ°STEMÄ°
# =====================================

# 2025 YKS Taban PuanlarÄ± Database (GÃ¼ncel veriler)
YKS_2025_TABAN_PUANLARI = {
    "SayÄ±sal": {
        "TÄ±p FakÃ¼ltesi": {
            "Hacettepe Ãœniversitesi": {"taban_puan": 537.19, "kontenjan": 280, "puan_turu": "SAY"},
            "Ä°stanbul Ãœniversitesi-CerrahpaÅŸa": {"taban_puan": 536.62, "kontenjan": 350, "puan_turu": "SAY"},
            "Ankara Ãœniversitesi": {"taban_puan": 527.84, "kontenjan": 320, "puan_turu": "SAY"},
            "Ege Ãœniversitesi": {"taban_puan": 518.45, "kontenjan": 290, "puan_turu": "SAY"},
            "Gazi Ãœniversitesi": {"taban_puan": 515.28, "kontenjan": 300, "puan_turu": "SAY"},
            "Dokuz EylÃ¼l Ãœniversitesi": {"taban_puan": 512.67, "kontenjan": 270, "puan_turu": "SAY"},
            "Erciyes Ãœniversitesi": {"taban_puan": 502.34, "kontenjan": 190, "puan_turu": "SAY"},
            "SÃ¼leyman Demirel Ãœniversitesi": {"taban_puan": 495.78, "kontenjan": 180, "puan_turu": "SAY"},
            "KÄ±rÄ±kkale Ãœniversitesi": {"taban_puan": 488.66, "kontenjan": 164, "puan_turu": "SAY"}
        },
        "DiÅŸ HekimliÄŸi": {
            "Ä°stanbul Ãœniversitesi": {"taban_puan": 550, "kontenjan": 60, "puan_turu": "SAY"},
            "Hacettepe Ãœniversitesi": {"taban_puan": 545, "kontenjan": 80, "puan_turu": "SAY"},
            "Ankara Ãœniversitesi": {"taban_puan": 540, "kontenjan": 70, "puan_turu": "SAY"},
            "Ege Ãœniversitesi": {"taban_puan": 535, "kontenjan": 75, "puan_turu": "SAY"},
            "Gazi Ãœniversitesi": {"taban_puan": 530, "kontenjan": 65, "puan_turu": "SAY"}
        },
        "EczacÄ±lÄ±k": {
            "Hacettepe Ãœniversitesi": {"taban_puan": 525, "kontenjan": 90, "puan_turu": "SAY"},
            "Ankara Ãœniversitesi": {"taban_puan": 520, "kontenjan": 85, "puan_turu": "SAY"},
            "Ege Ãœniversitesi": {"taban_puan": 515, "kontenjan": 100, "puan_turu": "SAY"},
            "Gazi Ãœniversitesi": {"taban_puan": 510, "kontenjan": 95, "puan_turu": "SAY"}
        },
        "Bilgisayar MÃ¼hendisliÄŸi": {
            "BoÄŸaziÃ§i Ãœniversitesi": {"taban_puan": 560, "kontenjan": 85, "puan_turu": "SAY"},
            "ODTÃœ": {"taban_puan": 555, "kontenjan": 120, "puan_turu": "SAY"},
            "Ä°TÃœ": {"taban_puan": 550, "kontenjan": 140, "puan_turu": "SAY"},
            "Bilkent Ãœniversitesi": {"taban_puan": 545, "kontenjan": 110, "puan_turu": "SAY"},
            "Hacettepe Ãœniversitesi": {"taban_puan": 535, "kontenjan": 100, "puan_turu": "SAY"},
            "Ankara Ãœniversitesi": {"taban_puan": 520, "kontenjan": 90, "puan_turu": "SAY"}
        },
        "Makine MÃ¼hendisliÄŸi": {
            "ODTÃœ": {"taban_puan": 530, "kontenjan": 150, "puan_turu": "SAY"},
            "Ä°TÃœ": {"taban_puan": 525, "kontenjan": 160, "puan_turu": "SAY"},
            "BoÄŸaziÃ§i Ãœniversitesi": {"taban_puan": 520, "kontenjan": 120, "puan_turu": "SAY"},
            "Gazi Ãœniversitesi": {"taban_puan": 490, "kontenjan": 140, "puan_turu": "SAY"}
        },
        "Elektrik-Elektronik MÃ¼hendisliÄŸi": {
            "ODTÃœ": {"taban_puan": 535, "kontenjan": 130, "puan_turu": "SAY"},
            "Ä°TÃœ": {"taban_puan": 530, "kontenjan": 135, "puan_turu": "SAY"},
            "BoÄŸaziÃ§i Ãœniversitesi": {"taban_puan": 525, "kontenjan": 110, "puan_turu": "SAY"}
        }
    },
    "SÃ¶zel": {
        "Hukuk": {
            "Ä°stanbul Ãœniversitesi": {"taban_puan": 520, "kontenjan": 180, "puan_turu": "SÃ–Z"},
            "Ankara Ãœniversitesi": {"taban_puan": 515, "kontenjan": 200, "puan_turu": "SÃ–Z"},
            "Hacettepe Ãœniversitesi": {"taban_puan": 510, "kontenjan": 160, "puan_turu": "SÃ–Z"},
            "Gazi Ãœniversitesi": {"taban_puan": 490, "kontenjan": 150, "puan_turu": "SÃ–Z"},
            "Dokuz EylÃ¼l Ãœniversitesi": {"taban_puan": 485, "kontenjan": 140, "puan_turu": "SÃ–Z"}
        },
        "Psikoloji": {
            "BoÄŸaziÃ§i Ãœniversitesi": {"taban_puan": 500, "kontenjan": 80, "puan_turu": "SÃ–Z"},
            "ODTÃœ": {"taban_puan": 495, "kontenjan": 90, "puan_turu": "SÃ–Z"},
            "Hacettepe Ãœniversitesi": {"taban_puan": 490, "kontenjan": 100, "puan_turu": "SÃ–Z"},
            "Ankara Ãœniversitesi": {"taban_puan": 485, "kontenjan": 110, "puan_turu": "SÃ–Z"}
        },
        "Ä°ngiliz Dili ve EdebiyatÄ±": {
            "BoÄŸaziÃ§i Ãœniversitesi": {"taban_puan": 480, "kontenjan": 70, "puan_turu": "SÃ–Z"},
            "ODTÃœ": {"taban_puan": 475, "kontenjan": 85, "puan_turu": "SÃ–Z"},
            "Hacettepe Ãœniversitesi": {"taban_puan": 470, "kontenjan": 95, "puan_turu": "SÃ–Z"}
        }
    },
    "EÅŸit AÄŸÄ±rlÄ±k": {
        "Psikoloji": {
            "BoÄŸaziÃ§i Ãœniversitesi": {"taban_puan": 487.94, "kontenjan": 62, "puan_turu": "EA"},
            "ODTÃœ": {"taban_puan": 467.84, "kontenjan": 50, "puan_turu": "EA"},
            "Ankara Ãœniversitesi": {"taban_puan": 454.87, "kontenjan": 110, "puan_turu": "EA"},
            "Hacettepe Ãœniversitesi": {"taban_puan": 452.36, "kontenjan": 80, "puan_turu": "EA"},
            "Ä°stanbul Ãœniversitesi": {"taban_puan": 447.29, "kontenjan": 95, "puan_turu": "EA"},
            "Ege Ãœniversitesi": {"taban_puan": 437.84, "kontenjan": 75, "puan_turu": "EA"},
            "Bursa UludaÄŸ Ãœniversitesi": {"taban_puan": 425.68, "kontenjan": 65, "puan_turu": "EA"},
            "AÄŸrÄ± Ä°brahim Ã‡eÃ§en Ãœniversitesi": {"taban_puan": 330.40, "kontenjan": 40, "puan_turu": "EA"}
        },
        "Hukuk": {
            "BoÄŸaziÃ§i Ãœniversitesi": {"taban_puan": 483.20, "kontenjan": 62, "puan_turu": "EA"},
            "Ä°stanbul Ãœniversitesi": {"taban_puan": 468.45, "kontenjan": 180, "puan_turu": "EA"},
            "Ankara Ãœniversitesi": {"taban_puan": 465.78, "kontenjan": 200, "puan_turu": "EA"},
            "Hacettepe Ãœniversitesi": {"taban_puan": 454.98, "kontenjan": 160, "puan_turu": "EA"},
            "Gazi Ãœniversitesi": {"taban_puan": 448.92, "kontenjan": 150, "puan_turu": "EA"},
            "Bursa UludaÄŸ Ãœniversitesi": {"taban_puan": 421.17, "kontenjan": 100, "puan_turu": "EA"}
        },
        "Ã–ÄŸretmenlik": {
            "Hacettepe Ãœniversitesi": {"taban_puan": 480, "kontenjan": 120, "puan_turu": "EA"},
            "Ankara Ãœniversitesi": {"taban_puan": 470, "kontenjan": 140, "puan_turu": "EA"},
            "Gazi Ãœniversitesi": {"taban_puan": 455, "kontenjan": 160, "puan_turu": "EA"},
            "Marmara Ãœniversitesi": {"taban_puan": 445, "kontenjan": 150, "puan_turu": "EA"}
        },
        "Ä°ktisat": {
            "BoÄŸaziÃ§i Ãœniversitesi": {"taban_puan": 510, "kontenjan": 110, "puan_turu": "EA"},
            "ODTÃœ": {"taban_puan": 505, "kontenjan": 120, "puan_turu": "EA"},
            "Hacettepe Ãœniversitesi": {"taban_puan": 495, "kontenjan": 130, "puan_turu": "EA"},
            "Ankara Ãœniversitesi": {"taban_puan": 480, "kontenjan": 140, "puan_turu": "EA"}
        },
        "Ä°ÅŸletme": {
            "BoÄŸaziÃ§i Ãœniversitesi": {"taban_puan": 515, "kontenjan": 150, "puan_turu": "EA"},
            "Ä°TÃœ": {"taban_puan": 500, "kontenjan": 120, "puan_turu": "EA"},
            "Hacettepe Ãœniversitesi": {"taban_puan": 490, "kontenjan": 160, "puan_turu": "EA"},
            "Gazi Ãœniversitesi": {"taban_puan": 470, "kontenjan": 180, "puan_turu": "EA"}
        },
        "UluslararasÄ± Ä°liÅŸkiler": {
            "BoÄŸaziÃ§i Ãœniversitesi": {"taban_puan": 505, "kontenjan": 90, "puan_turu": "EA"},
            "ODTÃœ": {"taban_puan": 500, "kontenjan": 100, "puan_turu": "EA"},
            "Ankara Ãœniversitesi": {"taban_puan": 485, "kontenjan": 110, "puan_turu": "EA"}
        },
        "MimarlÄ±k": {
            "Ä°TÃœ": {"taban_puan": 520, "kontenjan": 80, "puan_turu": "EA"},
            "ODTÃœ": {"taban_puan": 515, "kontenjan": 85, "puan_turu": "EA"},
            "Gazi Ãœniversitesi": {"taban_puan": 470, "kontenjan": 100, "puan_turu": "EA"},
            "TOKAT GAZÄ°OSMANPAÅA ÃœNÄ°VERSÄ°TESÄ°": {"taban_puan": 318, "kontenjan": 120, "puan_turu": "EA"},
            "BahÃ§eÅŸehir VakÄ±f Ãœniversitesi": {"taban_puan": 420, "kontenjan": 60, "puan_turu": "EA"},
            "Ä°stanbul VakÄ±f Ãœniversitesi": {"taban_puan": 380, "kontenjan": 40, "puan_turu": "EA"}
        },
        "Ä°Ã§ MimarlÄ±k": {
            "Hacettepe Ãœniversitesi": {"taban_puan": 480, "kontenjan": 70, "puan_turu": "EA"},
            "Gazi Ãœniversitesi": {"taban_puan": 465, "kontenjan": 80, "puan_turu": "EA"},
            "BaÅŸkent VakÄ±f Ãœniversitesi": {"taban_puan": 400, "kontenjan": 50, "puan_turu": "EA"},
            "AtÄ±lÄ±m VakÄ±f Ãœniversitesi": {"taban_puan": 380, "kontenjan": 45, "puan_turu": "EA"}
        },
        "Ä°statistik": {
            "Hacettepe Ãœniversitesi": {"taban_puan": 485, "kontenjan": 60, "puan_turu": "EA"},
            "Ankara Ãœniversitesi": {"taban_puan": 470, "kontenjan": 75, "puan_turu": "EA"},
            "Gazi Ãœniversitesi": {"taban_puan": 455, "kontenjan": 80, "puan_turu": "EA"}
        },
        "Matematik": {
            "BoÄŸaziÃ§i Ãœniversitesi": {"taban_puan": 495, "kontenjan": 60, "puan_turu": "EA"},
            "ODTÃœ": {"taban_puan": 490, "kontenjan": 70, "puan_turu": "EA"},
            "Hacettepe Ãœniversitesi": {"taban_puan": 480, "kontenjan": 80, "puan_turu": "EA"},
            "Ankara Ãœniversitesi": {"taban_puan": 465, "kontenjan": 90, "puan_turu": "EA"}
        }
    }
}

def calculate_current_yks_score(user_data):
    """KullanÄ±cÄ±nÄ±n mevcut net durumuna gÃ¶re YKS puanÄ±nÄ± hesaplar"""
    try:
        # Net bilgilerini al
        tyt_net = float(user_data.get('tyt_avg_net', 0))
        ayt_net = float(user_data.get('ayt_avg_net', 0))
        field = user_data.get('field', 'SayÄ±sal')
        
        # YKS puan hesaplama formÃ¼lleri (2025 gÃ¼ncel)
        if field == "SayÄ±sal":
            # SAY puan hesaplama
            tyt_puan = (tyt_net * 4) + 100  # TYT baÅŸarÄ± puanÄ±
            ayt_puan = (ayt_net * 5) + 100  # AYT baÅŸarÄ± puanÄ±
            
            # SAY puan formÃ¼lÃ¼: %40 TYT + %60 AYT
            skor = (tyt_puan * 0.4) + (ayt_puan * 0.6)
            
        elif field == "SÃ¶zel":
            # SÃ–Z puan hesaplama
            tyt_puan = (tyt_net * 4) + 100
            ayt_puan = (ayt_net * 5) + 100
            
            # SÃ–Z puan formÃ¼lÃ¼: %40 TYT + %60 AYT
            skor = (tyt_puan * 0.4) + (ayt_puan * 0.6)
            
        elif field == "EÅŸit AÄŸÄ±rlÄ±k":
            # EA puan hesaplama
            tyt_puan = (tyt_net * 4) + 100
            ayt_puan = (ayt_net * 5) + 100
            
            # EA puan formÃ¼lÃ¼: %40 TYT + %60 AYT
            skor = (tyt_puan * 0.4) + (ayt_puan * 0.6)
            
        else:
            # TYT & MSÃœ iÃ§in sadece TYT
            skor = (tyt_net * 4) + 100
            
        return max(100, skor)  # Minimum 100 puan
        
    except:
        return 100

def get_departments_by_field(field):
    """Alan bazÄ±nda bÃ¶lÃ¼mleri dÃ¶ndÃ¼rÃ¼r"""
    if field in YKS_2025_TABAN_PUANLARI:
        return list(YKS_2025_TABAN_PUANLARI[field].keys())
    return []

def get_universities_by_department(field, department):
    """BÃ¶lÃ¼m bazÄ±nda Ã¼niversiteleri dÃ¶ndÃ¼rÃ¼r"""
    try:
        return list(YKS_2025_TABAN_PUANLARI[field][department].keys())
    except:
        return []

def calculate_required_nets_for_target(target_score, field):
    """Hedef puan iÃ§in gerekli net sayÄ±larÄ±nÄ± hesaplar"""
    # Hedef puana ulaÅŸmak iÃ§in gereken minimum net kombinasyonlarÄ±
    if field == "SayÄ±sal":
        # SAY puan formÃ¼lÃ¼: (TYT_net * 4 + 100) * 0.4 + (AYT_net * 5 + 100) * 0.6 = target_score
        # Ã‡eÅŸitli senaryolar Ã¶ner
        scenarios = []
        
        for tyt_net in range(80, 121, 10):  # TYT 80-120 net arasÄ±
            # AYT netini hesapla
            # target_score = (tyt_net * 4 + 100) * 0.4 + (ayt_net * 5 + 100) * 0.6
            # ayt_net = ((target_score - (tyt_net * 4 + 100) * 0.4) / 0.6 - 100) / 5
            try:
                ayt_net = ((target_score - (tyt_net * 4 + 100) * 0.4) / 0.6 - 100) / 5
                if 0 <= ayt_net <= 80:  # GeÃ§erli AYT net aralÄ±ÄŸÄ±
                    scenarios.append({
                        "tyt_net": tyt_net,
                        "ayt_net": round(ayt_net, 1),
                        "difficulty": "Kolay" if tyt_net >= 100 and ayt_net >= 65 else 
                                     "Orta" if tyt_net >= 90 and ayt_net >= 55 else "Zor"
                    })
            except:
                continue
                
    elif field == "SÃ¶zel":
        scenarios = []
        for tyt_net in range(80, 121, 10):
            try:
                ayt_net = ((target_score - (tyt_net * 4 + 100) * 0.4) / 0.6 - 100) / 5
                if 0 <= ayt_net <= 80:
                    scenarios.append({
                        "tyt_net": tyt_net,
                        "ayt_net": round(ayt_net, 1),
                        "difficulty": "Kolay" if tyt_net >= 100 and ayt_net >= 65 else 
                                     "Orta" if tyt_net >= 90 and ayt_net >= 55 else "Zor"
                    })
            except:
                continue
                
    elif field == "EÅŸit AÄŸÄ±rlÄ±k":
        scenarios = []
        for tyt_net in range(80, 121, 10):
            try:
                ayt_net = ((target_score - (tyt_net * 4 + 100) * 0.4) / 0.6 - 100) / 5
                if 0 <= ayt_net <= 80:
                    scenarios.append({
                        "tyt_net": tyt_net,
                        "ayt_net": round(ayt_net, 1),
                        "difficulty": "Kolay" if tyt_net >= 100 and ayt_net >= 65 else 
                                     "Orta" if tyt_net >= 90 and ayt_net >= 55 else "Zor"
                    })
            except:
                continue
    else:
        # TYT & MSÃœ iÃ§in sadece TYT
        scenarios = []
        tyt_net_needed = (target_score - 100) / 4
        if 0 <= tyt_net_needed <= 120:
            scenarios.append({
                "tyt_net": round(tyt_net_needed, 1),
                "ayt_net": 0,
                "difficulty": "Kolay" if tyt_net_needed <= 100 else "Zor"
            })
    
    return scenarios[:3]  # En iyi 3 senaryoyu dÃ¶ndÃ¼r

def show_target_department_roadmap(user_data):
    """ğŸ¯ Hedef BÃ¶lÃ¼m Bilgileri"""
    st.subheader("ğŸ¯ Hedef BÃ¶lÃ¼m Bilgileri")
    
    field_raw = user_data.get('field', 'SayÄ±sal')
    target_department = user_data.get('target_department', None)
    
    # Alan formatÄ±nÄ± normalize et
    if 'SayÄ±sal' in field_raw or 'MF' in field_raw:
        field = 'SayÄ±sal'
    elif 'SÃ¶zel' in field_raw or 'TM' in field_raw:
        field = 'SÃ¶zel'
    elif 'EÅŸit' in field_raw or 'EA' in field_raw:
        field = 'EÅŸit AÄŸÄ±rlÄ±k'
    else:
        field = field_raw
    
    if not target_department or target_department == 'Belirlenmedi':
        st.warning("âš ï¸ HenÃ¼z hedef bÃ¶lÃ¼m belirlenmemiÅŸ. LÃ¼tfen profil ayarlarÄ±nÄ±zdan hedef bÃ¶lÃ¼mÃ¼nÃ¼zÃ¼ seÃ§in.")
        return
    
    # Hedef bÃ¶lÃ¼m iÃ§in tÃ¼m Ã¼niversitelerdeki en dÃ¼ÅŸÃ¼k/en yÃ¼ksek puanlarÄ± bul
    try:
        department_data = YKS_2025_TABAN_PUANLARI[field][target_department]
        
        devlet_unis = []
        vakif_unis = []
        
        for uni_name, info in department_data.items():
            puan = info["taban_puan"]
            if 'vakÄ±f' in uni_name.lower() or 'medipol' in uni_name.lower() or 'koÃ§' in uni_name.lower() or 'sabancÄ±' in uni_name.lower() or 'bilkent' in uni_name.lower() or 'atÄ±lÄ±m' in uni_name.lower() or 'bahÃ§eÅŸehir' in uni_name.lower() or 'baÅŸkent' in uni_name.lower() or 'istanbul vakÄ±f' in uni_name.lower():
                vakif_unis.append((puan, uni_name))
            else:
                devlet_unis.append((puan, uni_name))
        
        if devlet_unis:
            devlet_unis.sort()
            min_devlet_puan, min_devlet_uni = devlet_unis[0]
            max_devlet_puan, max_devlet_uni = devlet_unis[-1]
        else:
            min_devlet_puan = min_devlet_uni = max_devlet_puan = max_devlet_uni = None
        
        if vakif_unis:
            vakif_unis.sort()
            min_vakif_puan, min_vakif_uni = vakif_unis[0]
            max_vakif_puan, max_vakif_uni = vakif_unis[-1]
        else:
            min_vakif_puan = min_vakif_uni = max_vakif_puan = max_vakif_uni = None
        
        # Genel puan aralÄ±ÄŸÄ±
        all_puanlar = [info["taban_puan"] for info in department_data.values()]
        min_puan = min(all_puanlar)
        max_puan = max(all_puanlar)
        
        # Zorluk derecesi belirleme (gerÃ§ek verilerden)
        if max_puan >= 500:
            difficulty = "Zor"
            difficulty_color = "ğŸ”´"
        elif max_puan >= 450:
            difficulty = "Orta-Zor"
            difficulty_color = "ğŸŸ "
        elif max_puan >= 400:
            difficulty = "Orta"
            difficulty_color = "ğŸŸ¡"
        elif max_puan >= 350:
            difficulty = "Orta-Kolay"
            difficulty_color = "ğŸŸ¢"
        else:
            difficulty = "Kolay"
            difficulty_color = "ğŸ’š"
        
        # BÃ¶lÃ¼m bilgileri kartÄ±
        st.markdown(f"""
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                    padding: 20px; border-radius: 15px; margin: 10px 0; color: white;">
            <h3>{difficulty_color} {target_department}</h3>
            <p><strong>Zorluk Derecesi:</strong> {difficulty}</p>
            <p><strong>Genel Puan AralÄ±ÄŸÄ±:</strong> {min_puan} - {max_puan} puan</p>
        </div>
        """, unsafe_allow_html=True)
        
        # Detay metrikler
        col1, col2, col3, col4 = st.columns(4)
        
        with col1:
            if min_devlet_puan:
                st.metric("ğŸ« En DÃ¼ÅŸÃ¼k Devlet", f"{min_devlet_puan} puan")
                st.caption(f"{min_devlet_uni}")
            else:
                st.metric("ğŸ« En DÃ¼ÅŸÃ¼k Devlet", "Yok")
        
        with col2:
            if max_devlet_puan:
                st.metric("ğŸ« En YÃ¼ksek Devlet", f"{max_devlet_puan} puan")
                st.caption(f"{max_devlet_uni}")
            else:
                st.metric("ğŸ« En YÃ¼ksek Devlet", "Yok")
        
        with col3:
            if min_vakif_puan:
                st.metric("ğŸ¢ En DÃ¼ÅŸÃ¼k VakÄ±f", f"{min_vakif_puan} puan")
                st.caption(f"{min_vakif_uni}")
            else:
                st.metric("ğŸ¢ En DÃ¼ÅŸÃ¼k VakÄ±f", "Yok")
        
        with col4:
            if max_vakif_puan:
                st.metric("ğŸ¢ En YÃ¼ksek VakÄ±f", f"{max_vakif_puan} puan")
                st.caption(f"{max_vakif_uni}")
            else:
                st.metric("ğŸ¢ En YÃ¼ksek VakÄ±f", "Yok")
        
    except KeyError:
        st.error(f"âŒ {target_department} bÃ¶lÃ¼mÃ¼ iÃ§in {field} alanÄ±nda veri bulunamadÄ±.")

def show_weak_subjects_analysis(user_data, field, score_diff):
    """ZayÄ±f alan analizi ve Ã¶neriler"""
    st.markdown("---")
    st.subheader("ğŸ¯ ZorlandÄ±ÄŸÄ±nÄ±z Dersler - Ã–ncelik Sistemi")
    
    # KullanÄ±cÄ±nÄ±n zayÄ±f alanlarÄ±nÄ± al (YKS anketinden)
    survey_data = user_data.get('yks_survey_data', '')
    difficult_subjects = []
    
    if survey_data:
        try:
            data = json.loads(survey_data)
            difficult_subjects = data.get('difficult_subjects', [])
        except:
            pass
    
    if difficult_subjects:
        st.write("**En zorlandÄ±ÄŸÄ±nÄ±z dersler (Ã¶ncelik sÄ±rasÄ±na gÃ¶re):**")
        
        for i, subject in enumerate(difficult_subjects[:3]):
            priority_level = ["ğŸ”´ YÃœKSEK Ã–NCELÄ°K", "ğŸŸ¡ ORTA Ã–NCELÄ°K", "ğŸŸ¢ DÃœÅÃœK Ã–NCELÄ°K"][i]
            
            with st.expander(f"{priority_level}: {subject}"):
                # Ã‡alÄ±ÅŸma yoÄŸunluÄŸu Ã¶nerisi
                if score_diff > 30:
                    intensity = "GÃ¼nde 2-3 saat yoÄŸun Ã§alÄ±ÅŸma"
                elif score_diff > 15:
                    intensity = "GÃ¼nde 1-2 saat dÃ¼zenli Ã§alÄ±ÅŸma"
                else:
                    intensity = "GÃ¼nde 30-60 dakika odaklanma"
                
                st.write(f"**ğŸ’ª Ã–nerilen YoÄŸunluk:** {intensity}")
                st.write(f"**ğŸ“š Odak AlanlarÄ±:** Temel konular â†’ Orta seviye â†’ Ä°leri seviye")
                st.write(f"**â° HaftalÄ±k Hedef:** Bu derse toplam {(i+1)*3} saat ayÄ±rÄ±n")
    
    else:
        st.info("ğŸ“ ZayÄ±f alanlarÄ±nÄ±zÄ± belirlemek iÃ§in lÃ¼tfen **HaftalÄ±k Planlama** sekmesindeki anketi tamamlayÄ±n.")

def get_user_weekly_progress(user_data):
    """KullanÄ±cÄ±nÄ±n haftalÄ±k ilerlemesini hesaplar"""
    # Konu takip verilerinden ilerleme hesapla
    topic_tracking = json.loads(user_data.get('topic_tracking_data', '{}'))
    if not topic_tracking:
        return 60  # VarsayÄ±lan
    
    # 5+ net olan konularÄ± say
    completed_topics = sum(1 for topic_data in topic_tracking.values() 
                          if topic_data.get('net_score', 0) >= 5)
    
    # Pomodoro verisini de dahil et
    pomodoro_data = json.loads(user_data.get('pomodoro_data', '{}'))
    weekly_sessions = sum(1 for session in pomodoro_data.values() 
                         if session.get('completed', False))
    
    # Basit bir formula ile ilerleme yÃ¼zdesi hesapla
    progress = min(100, (completed_topics * 10 + weekly_sessions * 5))
    return max(30, progress)  # Minimum %30

def generate_adaptive_schedule(user_data):
    """Otomatik saat ayarlama sistemi - Ã¶ÄŸrenci tempositemiine gÃ¶re"""
    # Anket verilerini al
    survey_data = json.loads(user_data.get('yks_survey_data', '{}'))
    sleep_time = survey_data.get('sleep_time', '23:00 - 06:00 (7 saat) - Ã–nerilen')
    
    # KullanÄ±cÄ±nÄ±n tempositemiini hesapla
    user_progress = get_user_weekly_progress(user_data)
    target_progress = 70  # Hedef haftalÄ±k ilerleme %70
    
    # Temel Ã§alÄ±ÅŸma saati (normal)
    base_hours = 6
    
    # Tempo farkÄ± hesapla ve saatleri otomatik ayarla
    if user_progress < 50:  # YavaÅŸ gidiyorsa
        adjusted_hours = base_hours + 1.5  # 1.5 saat artÄ±r
        tempo_message = f"âš ï¸ **Ä°lerlemeniz yavaÅŸ ({user_progress:.1f}%)** - Ã‡alÄ±ÅŸma saatleriniz otomatik olarak 1.5 saat artÄ±rÄ±ldÄ±!"
        tempo_color = "warning"
    elif user_progress < target_progress:  # Biraz yavaÅŸ
        adjusted_hours = base_hours + 1  # 1 saat artÄ±r
        tempo_message = f"ğŸ“ˆ **Ä°lerlemeniz normal altÄ± ({user_progress:.1f}%)** - Ã‡alÄ±ÅŸma saatleriniz 1 saat artÄ±rÄ±ldÄ±."
        tempo_color = "info"
    else:  # Normal veya hÄ±zlÄ±
        adjusted_hours = base_hours  # Normal saatler
        tempo_message = f"ğŸš€ **Harika ilerleme ({user_progress:.1f}%)!** Mevcut temponu koru."
        tempo_color = "success"
    
    # Uyku saatine gÃ¶re program Ã¶nerisi
    if 'Erken' in sleep_time or '22:00' in sleep_time or '23:00' in sleep_time:
        morning_end = 6 + int(adjusted_hours)
        schedule = f"06:00-{morning_end:02d}:00, 17:00-20:00"
    elif 'Normal' in sleep_time or '00:00' in sleep_time:
        morning_end = 7 + int(adjusted_hours)
        schedule = f"07:00-{morning_end:02d}:00, 18:00-21:00"
    elif 'GeÃ§' in sleep_time or '01:00' in sleep_time:
        morning_end = 8 + int(adjusted_hours)
        schedule = f"08:00-{morning_end:02d}:00, 19:00-22:00"
    else:  # Ã‡ok geÃ§
        morning_end = 9 + int(adjusted_hours)
        schedule = f"09:00-{morning_end:02d}:00, 20:00-23:00"
    
    return {
        'schedule': schedule,
        'adjusted_hours': adjusted_hours,
        'tempo_message': tempo_message,
        'tempo_color': tempo_color,
        'user_progress': user_progress
    }

def show_adaptive_yearly_plan(user_data, current_score, months_to_yks):
    """Adaptif yÄ±llÄ±k plan sistemi"""
    st.subheader("ğŸ¯ YKS'ye Kadar Dinamik Yol HaritasÄ±")
    
    # Ã–ÄŸrenci tempositemi hesapla
    user_progress = get_user_weekly_progress(user_data)
    target_weekly_progress = 70  # Hedef haftalÄ±k %70
    
    # Tempo farkÄ± hesapla
    tempo_farki = user_progress - target_weekly_progress
    
    # Tempo durumunu belirle
    if tempo_farki >= 15:  # %85+ ilerleme
        tempo_status = "HÄ±zlÄ±"
        ay_offset = -1  # PlanÄ± 1 ay Ã¶ne al
        tempo_color = "success"
        tempo_emoji = "ğŸš€"
    elif tempo_farki >= -10:  # %60-84 ilerleme  
        tempo_status = "Normal"
        ay_offset = 0  # Plan normal
        tempo_color = "info"
        tempo_emoji = "ğŸ“ˆ"
    else:  # %60 altÄ± ilerleme
        tempo_status = "YavaÅŸ"
        ay_offset = 1  # PlanÄ± 1 ay geriye al
        tempo_color = "warning"
        tempo_emoji = "âš¡"
    
    # Tempo durumu gÃ¶ster
    if tempo_status == "HÄ±zlÄ±":
        st.success(f"{tempo_emoji} **{tempo_status} Ä°lerleme** - PlanÄ±nÄ±z 1 ay Ã¶ne alÄ±ndÄ±! Deneme sÄ±navlarÄ±na daha erken baÅŸlayabilirsiniz.")
    elif tempo_status == "Normal":
        st.info(f"{tempo_emoji} **{tempo_status} Ä°lerleme** - PlanÄ±nÄ±z yolunda gidiyor.")
    else:
        st.warning(f"{tempo_emoji} **{tempo_status} Ä°lerleme** - PlanÄ±nÄ±z 1 ay geriye alÄ±ndÄ±. Daha fazla Ã§alÄ±ÅŸma gerekli.")
    
    # Ã–ÄŸrenci alanÄ±nÄ± al
    student_field = user_data.get('field', 'SayÄ±sal (MF)')
    
    # ADAPTÄ°F AYLIK PLAN OLUÅTUR
    create_adaptive_monthly_plan(student_field, ay_offset, current_score, tempo_status)

def create_adaptive_monthly_plan(student_field, ay_offset, current_score, tempo_status):
    """Adaptif aylÄ±k plan oluÅŸturur"""
    
    # Temel plan tarihleri (Normal tempo iÃ§in)
    base_plan = {
        'Ekim': {'focus': 'Temel Konular', 'milestone': None},
        'KasÄ±m': {'focus': 'TYT Matematik & TÃ¼rkÃ§e', 'milestone': None},
        'AralÄ±k': {'focus': 'Fen Bilimleri Temeli', 'milestone': None},
        'Ocak': {'focus': 'AYT HazÄ±rlÄ±k', 'milestone': None},
        'Åubat': {'focus': 'Eksik Konular', 'milestone': None},
        'Mart': {'focus': 'Genel Tekrar', 'milestone': None},
        'Nisan': {'focus': 'Deneme & Revizyon', 'milestone': 'ğŸ¯ DENEMELER BAÅLIYOR!'},
        'MayÄ±s': {'focus': 'Son Tekrar & Deneme', 'milestone': 'ğŸ“ YKS\'YE HAZIRLIK!'},
        'Haziran': {'focus': 'Final Tekrar', 'milestone': 'ğŸ† YKS ZAMANI!'}
    }
    
    # Alan bazÄ± Ã¶zelleÅŸtirme
    if student_field == 'SayÄ±sal (MF)':
        base_plan['KasÄ±m']['focus'] = 'Matematik Temeli'
        base_plan['AralÄ±k']['focus'] = 'Fizik & Kimya'
        base_plan['Ocak']['focus'] = 'Biyoloji & AYT Mat'
    elif student_field == 'SÃ¶zel (TM)':
        base_plan['KasÄ±m']['focus'] = 'TÃ¼rkÃ§e & Edebiyat'
        base_plan['AralÄ±k']['focus'] = 'Tarih Temeli'
        base_plan['Ocak']['focus'] = 'CoÄŸrafya & Felsefe'
    elif student_field == 'EÅŸit AÄŸÄ±rlÄ±k (EA)':
        base_plan['KasÄ±m']['focus'] = 'Matematik & TÃ¼rkÃ§e'
        base_plan['AralÄ±k']['focus'] = 'Sosyal Bilimler'
        base_plan['Ocak']['focus'] = 'Edebiyat & Ä°ngilizce'
    
    # Offset ile planÄ± ayarla
    months = list(base_plan.keys())
    
    # Grafik verileri hazÄ±rla
    month_names = []
    score_projections = []
    colors = []
    
    projected_score = current_score
    
    for i, month in enumerate(months):
        month_names.append(month)
        score_projections.append(projected_score)
        
        # Renk kodlama
        if tempo_status == "HÄ±zlÄ±":
            colors.append('#00CC66')  # YeÅŸil
        elif tempo_status == "Normal":
            colors.append('#0066CC')  # Mavi
        else:
            colors.append('#FF6B6B')  # KÄ±rmÄ±zÄ±
        
        # Score projeksiyonu (aylÄ±k +15 puan varsayÄ±m)
        projected_score = min(500, projected_score + 15)
    
    # Plotly grafik oluÅŸtur
    if PLOTLY_AVAILABLE:
        fig = go.Figure()
        
        # Mevcut puan
        fig.add_trace(go.Scatter(
            x=['Åu An'], 
            y=[current_score],
            mode='markers',
            marker=dict(size=15, color='red'),
            name='Mevcut PuanÄ±nÄ±z'
        ))
        
        # GeliÅŸim projeksiyonu
        fig.add_trace(go.Scatter(
            x=month_names, 
            y=score_projections,
            mode='lines+markers',
            line=dict(color=colors[0], width=3),
            marker=dict(size=8, color=colors),
            name=f'Tahmini GeliÅŸim ({tempo_status})'
        ))
        
        fig.update_layout(
            title=f"ğŸ“ˆ {tempo_status} Ä°lerleme - YKS Tahmini GeliÅŸim GrafiÄŸi",
            xaxis_title="Aylar",
            yaxis_title="YKS PuanÄ±",
            hovermode='x unified',
            height=400
        )
        
        st.plotly_chart(fig, use_container_width=True)
    
    # AylÄ±k detay planÄ±
    st.subheader("ğŸ“… AylÄ±k Odak AlanlarÄ±")
    
    for i, month in enumerate(months):
        plan_data = base_plan[month]
        
        # Ay offsetine gÃ¶re milestone ayarla
        if plan_data['milestone']:
            if ay_offset == -1:  # HÄ±zlÄ± - milestones Ã¶ne alÄ±nÄ±r
                if month == 'Mart':
                    milestone_text = 'ğŸ¯ DENEMELER BAÅLIYOR! (1 ay erken)'
                else:
                    milestone_text = plan_data['milestone']
            elif ay_offset == 1:  # YavaÅŸ - milestones geriye alÄ±nÄ±r
                if month == 'MayÄ±s':
                    milestone_text = 'ğŸ¯ DENEMELER BAÅLIYOR! (1 ay geÃ§)'
                else:
                    milestone_text = plan_data['milestone']
            else:
                milestone_text = plan_data['milestone']
        else:
            milestone_text = None
        
        with st.expander(f"ğŸ“… {month} 2024/25", expanded=(i < 2)):
            st.write(f"**ğŸ¯ Odak:** {plan_data['focus']}")
            if milestone_text:
                st.markdown(f"**{milestone_text}**")
            
            # Tempo bazÄ± Ã¶neriler
            if tempo_status == "HÄ±zlÄ±":
                st.success("ğŸš€ HÄ±zlÄ± ilerliyorsunuz! Bonus konular ekleyebilirsiniz.")
            elif tempo_status == "YavaÅŸ":
                st.warning("âš¡ Tempo artÄ±rmalÄ±sÄ±nÄ±z. GÃ¼nlÃ¼k Ã§alÄ±ÅŸma saatinizi artÄ±rÄ±n.")
            else:
                st.info("ğŸ“ˆ PlanÄ±nÄ±z yolunda. Bu tempoyu koruyun.")
    
    # Genel Ã¶neri
    st.markdown("---")
    st.markdown("### ğŸ’¡ Dinamik Ã–neriler")
    
    if tempo_status == "HÄ±zlÄ±":
        st.success("""
        ğŸš€ **HÄ±zlÄ± Ä°lerleme Ã–nerileri:**
        - Deneme sÄ±navlarÄ±na Mart ayÄ±nda baÅŸlayabilirsiniz
        - Bonus konular ve zor problemlere odaklanÄ±n
        - Ä°leri seviye kaynaklara geÃ§iÅŸ yapÄ±n
        """)
    elif tempo_status == "YavaÅŸ":
        st.warning("""
        âš¡ **Ä°lerleme HÄ±zlandÄ±rma Ã–nerileri:**
        - GÃ¼nlÃ¼k Ã§alÄ±ÅŸma saatinizi 1-2 saat artÄ±rÄ±n
        - ZayÄ±f konularÄ±nÄ±za odaklanÄ±n
        - Deneme sÄ±navlarÄ±nÄ± MayÄ±s'a ertelemeyi dÃ¼ÅŸÃ¼nÃ¼n
        """)
    else:
        st.info("""
        ğŸ“ˆ **Normal Ä°lerleme:**
        - Mevcut tempoya devam edin
        - Nisan ayÄ±nda deneme sÄ±navlarÄ±na baÅŸlayÄ±n
        - DÃ¼zenli tekrar programÄ±nÄ± sÃ¼rdÃ¼rÃ¼n
        """)

def show_progress_analytics(user_data):
    """ğŸ“Š AkllÄ± GidiÅŸat Analizi - HaftalÄ±k Performansa DayalÄ± Dinamik Sistem"""
    
    # Ã–ÄŸrenci adÄ±nÄ± al
    student_name = user_data.get('name', 'Ã–ÄŸrenci')
    
    # ğŸ”¥ FÄ°X: KullanÄ±cÄ±nÄ±n KENDÄ° dinamik hafta bilgisini kullan
    week_info_dynamic = get_user_dynamic_week_info(user_data)
    current_day_tr = week_info_dynamic['current_day_name']  # GerÃ§ek gÃ¼n adÄ±
    
    # Genel hafta bilgisi (YKS geri sayÄ±mÄ± iÃ§in)
    week_info = get_current_week_info()
    sunday_check = week_info['sunday']
    days_to_yks = week_info['days_to_yks']
    
    # Modern baÅŸlÄ±k
    st.markdown(f"""
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                padding: 25px; border-radius: 15px; margin: 20px 0; color: white; text-align: center;">
        <h2 style="margin: 0; color: white;">ğŸš€ {student_name}, GidiÅŸatÄ±n NasÄ±l?</h2>
        <p style="margin: 10px 0 0 0; opacity: 0.9;">AkllÄ± performans analizi ve gelecek projeksiyonu</p>
    </div>
    """, unsafe_allow_html=True)
    
    # HaftalÄ±k program baÅŸlangÄ±Ã§ kontrolÃ¼
    if 'weekly_program_started' not in user_data or not user_data.get('weekly_program_started', False):
        st.info(f"""
        ğŸ”„ **{student_name}, henÃ¼z haftalÄ±k programa baÅŸlamamlÄ±ÅŸÄ±n!**
        
        GidiÅŸat analizi iÃ§in Ã¶nce "HaftalÄ±k Planlama" sekmesinden programÄ±nÄ± baÅŸlat.
        í€“0lk hafta bittiÄŸinde burada detaylÄ± analiz gÃ¶rÃ¼ntÃ¼lenecek.
        """)
        return 0, []
    
    # Ä°lk hafta kontrolÃ¼ - Pazartesi baÅŸlayÄ±p Pazar bitiyor
    weekly_start_date = user_data.get('weekly_plan_start_date')
    if not weekly_start_date:
        st.warning("ğŸ”„ HaftalÄ±k program baÅŸlangÄ±Ã§ tarihi bulunamadÄ±!")
        return 0, []
    
    try:
        start_date = datetime.strptime(weekly_start_date, "%Y-%m-%d")
        today = datetime.now()
        
        # Ä°lk haftanÄ±n pazartesi ve pazarÄ±nÄ± bul
        days_since_monday = start_date.weekday()
        first_week_monday = start_date - timedelta(days=days_since_monday)
        first_week_sunday = first_week_monday + timedelta(days=6)
        
        # Ä°lk hafta henÃ¼z bitmedi mi?
        if today <= first_week_sunday:
            st.markdown(f"""
            <div style="background: linear-gradient(135deg, #ff9a56 0%, #ff6b6b 100%); 
                        padding: 20px; border-radius: 12px; color: white; text-align: center;">
                <h3 style="margin: 0; color: white;">ğŸ“… {student_name}, Ä°lk Haftan Devam Ediyor!</h3>
                <p style="margin: 10px 0 0 0; opacity: 0.9;">BugÃ¼n: {current_day_tr}</p>
                <p style="margin: 5px 0 0 0; opacity: 0.9;">Ä°lk hafta bittiÄŸinde ({first_week_sunday.strftime('%d.%m.%Y')}) detaylÄ± gidiÅŸat analizi aÃ§Ä±lacak!</p>
            </div>
            """, unsafe_allow_html=True)
            
            # Temel bilgiler gÃ¶ster
            col1, col2, col3 = st.columns(3)
            with col1:
                st.metric("ğŸ“… SÄ±nava Kalan GÃ¼n", days_to_yks)
            with col2:
                st.metric("ğŸ“… SÄ±nava Kalan Ay", days_to_yks // 30)
            with col3:
                st.metric("ğŸ“… SÄ±nava Kalan Hafta", days_to_yks // 7)
            
            st.info("ğŸ“ HaftalÄ±k programÄ±nÄ± tamamlamaya odaklan, gidiÅŸat analizi hazÄ±rlanÄ±yor...")
            return 0, []
            
    except Exception as e:
        st.error(f"Tarih hesaplama hatasÄ±: {e}")
        return 0, []
    
    # Ä°lk hafta bitti - analiz baÅŸlÄ±yor!
    st.balloons()  # Kutlama efekti
    
    # Zaman kartlarÄ± - modern gÃ¶rÃ¼nÃ¼m
    st.markdown("ğŸ—“ï¸ **SÄ±nav Geri SayÄ±mÄ±**")
    col1, col2, col3 = st.columns(3)
    with col1:
        st.metric("ğŸ“… Kalan GÃ¼n", days_to_yks, help="YKS'ye kalan gÃ¼n sayÄ±sÄ±")
    with col2:
        st.metric("ğŸ“… Kalan Ay", days_to_yks // 30, help="YaklaÅŸÄ±k ay sayÄ±sÄ±")
    with col3:
        st.metric("ğŸ“… Kalan Hafta", days_to_yks // 7, help="YaklaÅŸÄ±k hafta sayÄ±sÄ±")
    
    st.markdown("---")
    
    # HaftalÄ±k performans hesaplama
    weekly_plan = user_data.get('weekly_plan', {})
    try:
        weekly_completion_rate = calculate_weekly_completion_percentage(user_data, weekly_plan)
    except:
        weekly_completion_rate = 0.0
    
    # Performans analizi gÃ¶sterimi
    show_smart_performance_analysis(student_name, weekly_completion_rate, user_data)
    
    st.markdown("---")
    
    # Dinamik konu takvimi
    show_intelligent_topic_calendar(student_name, user_data, weekly_completion_rate, weekly_start_date, days_to_yks)
    
    return 0, []

def show_smart_performance_analysis(student_name, weekly_completion_rate, user_data):
    """ğŸ¤– AkÄ±llÄ± Performans Analizi - Ders BazÄ±nda Detay"""
    
    st.markdown(f"""
    <div style="background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%); 
                padding: 25px; border-radius: 20px; margin: 20px 0; color: white; text-align: center;
                box-shadow: 0 10px 30px rgba(162, 155, 254, 0.3);">
        <h3 style="margin: 0; color: white; font-weight: 600;">
            ğŸ“ˆ {student_name}'in HaftalÄ±k Performans Raporu
        </h3>
        <p style="margin: 10px 0 0 0; opacity: 0.9;">Ders bazÄ±nda detaylÄ± analiz</p>
    </div>
    """, unsafe_allow_html=True)
    
    # Genel performans kartÄ± - daha modern
    if weekly_completion_rate >= 85:
        performance_color = "linear-gradient(135deg, #00b894 0%, #00cec9 100%)"
        performance_emoji = "ğŸš€"
        performance_text = "MÃ¼kemmel"
        advice = "Harika gidiyorsun! Bu tempoyu sÃ¼rdÃ¼r."
        border_color = "#00b894"
    elif weekly_completion_rate >= 70:
        performance_color = "linear-gradient(135deg, #74b9ff 0%, #0984e3 100%)"
        performance_emoji = "ğŸ“ˆ"
        performance_text = "Ä°yi"
        advice = "GÃ¼zel ilerleme! %85+'a Ã§Ä±karmaya Ã§alÄ±ÅŸ."
        border_color = "#0984e3"
    elif weekly_completion_rate >= 50:
        performance_color = "linear-gradient(135deg, #fdcb6e 0%, #e17055 100%)"
        performance_emoji = "âš ï¸"
        performance_text = "Orta"
        advice = "Daha hÄ±zlÄ± Ã§alÄ±ÅŸman gerekiyor."
        border_color = "#e17055"
    else:
        performance_color = "linear-gradient(135deg, #fd79a8 0%, #e84393 100%)"
        performance_emoji = "ğŸš¨"
        performance_text = "DÃ¼ÅŸÃ¼k"
        advice = "Acil olarak Ã§alÄ±ÅŸma programÄ±nÄ± gÃ¶zden geÃ§ir!"
        border_color = "#e84393"
    
    # Ana performans kartÄ±
    st.markdown(f"""
    <div style="background: {performance_color}; 
                padding: 25px; border-radius: 15px; color: white; margin: 15px 0;
                box-shadow: 0 8px 25px rgba(0,0,0,0.15);
                border: 3px solid rgba(255,255,255,0.2);
                text-align: center;">
        <h2 style="margin: 0 0 10px 0; color: white; font-weight: 600;">
            {performance_emoji} Genel Performans: {performance_text}
        </h2>
        <div style="font-size: 32px; font-weight: bold; margin: 15px 0;">
            %{weekly_completion_rate:.1f}
        </div>
        <p style="margin: 0; opacity: 0.95; font-size: 16px;">
            {advice}
        </p>
    </div>
    """, unsafe_allow_html=True)
    
    # Ders bazÄ±nda performans (varsayÄ±lan deÄŸerler) - modern kartlarla
    subjects_performance = {
        "TYT TÃ¼rkÃ§e": min(100, weekly_completion_rate + 5),
        "TYT Matematik": min(100, weekly_completion_rate - 5),
        "TYT Geometri": min(100, weekly_completion_rate),
        "TYT CoÄŸrafya": min(100, weekly_completion_rate + 2),
        "TYT Tarih": min(100, weekly_completion_rate - 3),
        "AYT Matematik": min(100, weekly_completion_rate - 10),
        "AYT Edebiyat": min(100, weekly_completion_rate + 3)
    }
    
    st.markdown("### ğŸ“Š Ders BazÄ±nda Performans DetayÄ±")
    
    col1, col2 = st.columns(2)
    
    with col1:
        st.markdown("""
        <div style="background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%); 
                    padding: 15px; border-radius: 12px; color: white; text-align: center; margin-bottom: 15px;">
            <h4 style="margin: 0; color: white;">ğŸ“š TYT Dersleri</h4>
        </div>
        """, unsafe_allow_html=True)
        
        for subject, performance in subjects_performance.items():
            if "TYT" in subject:
                if performance >= 80:
                    bg_color = "#d4edda"
                    text_color = "#155724"
                    icon = "ğŸš€"
                elif performance >= 60:
                    bg_color = "#d1ecf1"
                    text_color = "#0c5460"
                    icon = "ğŸ“ˆ"
                else:
                    bg_color = "#fff3cd"
                    text_color = "#856404"
                    icon = "âš ï¸"
                
                st.markdown(f"""
                <div style="background: {bg_color}; padding: 12px; border-radius: 8px; margin: 8px 0;
                            border-left: 4px solid {text_color};">
                    <span style="color: {text_color}; font-weight: 500;">
                        {icon} {subject}: <strong>%{performance:.0f}</strong>
                    </span>
                </div>
                """, unsafe_allow_html=True)
    
    with col2:
        st.markdown("""
        <div style="background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%); 
                    padding: 15px; border-radius: 12px; color: white; text-align: center; margin-bottom: 15px;">
            <h4 style="margin: 0; color: white;">ğŸ“– AYT Dersleri</h4>
        </div>
        """, unsafe_allow_html=True)
        
        for subject, performance in subjects_performance.items():
            if "AYT" in subject:
                if performance >= 80:
                    bg_color = "#d4edda"
                    text_color = "#155724"
                    icon = "ğŸš€"
                elif performance >= 60:
                    bg_color = "#d1ecf1"
                    text_color = "#0c5460"
                    icon = "ğŸ“ˆ"
                else:
                    bg_color = "#fff3cd"
                    text_color = "#856404"
                    icon = "âš ï¸"
                
                st.markdown(f"""
                <div style="background: {bg_color}; padding: 12px; border-radius: 8px; margin: 8px 0;
                            border-left: 4px solid {text_color};">
                    <span style="color: {text_color}; font-weight: 500;">
                        {icon} {subject}: <strong>%{performance:.0f}</strong>
                    </span>
                </div>
                """, unsafe_allow_html=True)

def show_intelligent_topic_calendar(student_name, user_data, weekly_completion_rate, weekly_start_date, days_to_yks):
    """ğŸ¤– AkÄ±llÄ± Konu Takvimi - GerÃ§ek Performansa DayalÄ±"""
    from datetime import datetime, timedelta
    
    # Modern baÅŸlÄ±k
    st.markdown(f"""
    <div style="background: linear-gradient(145deg, #667eea 0%, #764ba2 100%); 
                padding: 25px; border-radius: 20px; margin: 20px 0; 
                box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
                border: 1px solid rgba(255,255,255,0.1);">
        <div style="text-align: center;">
            <h2 style="margin: 0; color: white; font-weight: 600;">
                ğŸ¯ {student_name} iÃ§in AkÄ±llÄ± Konu Projeksiyonu
            </h2>
            <p style="margin: 10px 0 0 0; opacity: 0.9; color: #f8f9ff;">
                PerformansÄ±na dayalÄ± dinamik mÃ¼fredat haritasÄ±
            </p>
        </div>
    </div>
    """, unsafe_allow_html=True)
    
    # HaftalÄ±k program ÅŸablonu (mevcut sistemden alÄ±nacak)
    weekly_topics = get_student_weekly_curriculum(user_data.get('field', 'EÅŸit AÄŸÄ±rlÄ±k'))
    
    # HÄ±z hesaplama
    if weekly_completion_rate >= 85:
        speed_multiplier = 1.2
        speed_text = "HÄ±zlandÄ±rÄ±lmÄ±ÅŸ Tempo"
        speed_emoji = "ğŸš€"
        speed_color = "#28a745"
    elif weekly_completion_rate >= 70:
        speed_multiplier = 1.0
        speed_text = "Normal Tempo"
        speed_emoji = "ğŸ“ˆ"
        speed_color = "#17a2b8"
    elif weekly_completion_rate >= 50:
        speed_multiplier = 0.8
        speed_text = "YavaÅŸ Tempo"
        speed_emoji = "âš ï¸"
        speed_color = "#ffc107"
    else:
        speed_multiplier = 0.6
        speed_text = "Ã‡ok YavaÅŸ Tempo"
        speed_emoji = "ğŸš¨"
        speed_color = "#dc3545"
    
    # Modern hÄ±z kartÄ±
    col1, col2, col3 = st.columns([1, 2, 1])
    with col2:
        st.markdown(f"""
        <div style="background: {speed_color}; 
                    padding: 20px; border-radius: 15px; color: white; margin: 15px 0;
                    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
                    text-align: center; border: 2px solid rgba(255,255,255,0.2);">
            <h3 style="margin: 0; color: white; font-weight: 600;">
                {speed_emoji} {speed_text}
            </h3>
            <p style="margin: 10px 0 5px 0; opacity: 0.95; font-size: 16px;">
                HÄ±z Ã‡arpanÄ±: <strong>{speed_multiplier}x</strong>
            </p>
            <p style="margin: 0; opacity: 0.85; font-size: 14px;">
                HaftalÄ±k Tamamlama: <strong>%{weekly_completion_rate:.1f}</strong>
            </p>
        </div>
        """, unsafe_allow_html=True)
    
    # Tarih hesaplamalarÄ±
    try:
        start_date = datetime.strptime(weekly_start_date, "%Y-%m-%d")
        current_date = datetime.now()
        
        # KaÃ§ hafta geÃ§tiÄŸini hesapla
        weeks_passed = max(1, (current_date - start_date).days // 7)
        current_week_index = weeks_passed
        
        # AylÄ±k planlama
        monthly_plan = calculate_monthly_topic_distribution(
            weekly_topics, current_week_index, speed_multiplier, start_date, days_to_yks
        )
        
        if not monthly_plan:
            st.info("ğŸ TÃ¼m mÃ¼fredat tamamlanmÄ±ÅŸ veya analiz iÃ§in yeterli veri yok!")
            return
        
        # Modern aylÄ±k plan gÃ¶rÃ¼nÃ¼mÃ¼
        st.markdown("""
        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); 
                    padding: 20px; border-radius: 15px; margin: 20px 0; color: white; text-align: center;">
            <h3 style="margin: 0; color: white; font-weight: 600;">ğŸ—“ï¸ Aylara GÃ¶re Konu DaÄŸÄ±lÄ±mÄ±</h3>
            <p style="margin: 5px 0 0 0; opacity: 0.9;">Dinamik mÃ¼fredat planlamasÄ±</p>
        </div>
        """, unsafe_allow_html=True)
        
        # AylÄ±k kartlarÄ± moderne al
        for i, (month, month_data) in enumerate(monthly_plan.items()):
            if month_data and month_data['topics']:
                total_topics = len(month_data['topics'])
                
                # Her ay iÃ§in farklÄ± renk gradientleri
                colors = [
                    "linear-gradient(135deg, #667eea 0%, #764ba2 100%)",
                    "linear-gradient(135deg, #f093fb 0%, #f5576c 100%)", 
                    "linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)",
                    "linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)",
                    "linear-gradient(135deg, #fa709a 0%, #fee140 100%)",
                    "linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)",
                    "linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)"
                ]
                color = colors[i % len(colors)]
                
                with st.expander(f"ğŸ“… **{month}** ({total_topics} konu) - Hafta {month_data['week_range']}", expanded=i<2):
                    st.markdown(f"""
                    <div style="background: {color}; 
                                padding: 15px; border-radius: 12px; margin: 10px 0; color: white;">
                        <h4 style="margin: 0 0 15px 0; color: white; text-align: center;">
                            ğŸ“š {month} KonularÄ± ({total_topics} adet)
                        </h4>
                    </div>
                    """, unsafe_allow_html=True)
                    
                    # KonularÄ± 2 kolonlu gÃ¶ster
                    col1, col2 = st.columns(2)
                    for j, topic in enumerate(month_data['topics']):
                        # Konu tÃ¼rÃ¼ne gÃ¶re emoji
                        if "TYT" in topic:
                            emoji = "ğŸ“š"
                            badge_color = "#e3f2fd"
                            text_color = "#1976d2"
                        elif "AYT" in topic:
                            emoji = "ğŸ“–"
                            badge_color = "#f3e5f5"
                            text_color = "#7b1fa2"
                        else:
                            emoji = "ğŸ“"
                            badge_color = "#e8f5e8"
                            text_color = "#388e3c"
                        
                        target_col = col1 if j % 2 == 0 else col2
                        with target_col:
                            st.markdown(f"""
                            <div style="background: {badge_color}; 
                                        padding: 8px 12px; border-radius: 8px; margin: 5px 0;
                                        border-left: 4px solid {text_color};">
                                <span style="color: {text_color}; font-weight: 500;">
                                    {emoji} {topic}
                                </span>
                            </div>
                            """, unsafe_allow_html=True)
        
        # Deneme sÄ±navÄ± tahmini
        show_exam_prediction(monthly_plan, speed_multiplier, student_name)
        
    except Exception as e:
        st.error(f"Tarih hesaplama hatasÄ±: {e}")

def get_student_weekly_curriculum(field):
    """Ã–ÄŸrenci alanÄ±na gÃ¶re 16 haftalÄ±k mÃ¼fredat"""
    # EÅŸit aÄŸÄ±rlÄ±k iÃ§in Ã¶rnek 16 haftalÄ±k program
    return [
        # 1. Hafta
        "TYT TÃ¼rkÃ§e - SÃ¶zcÃ¼kte Anlam", "TYT Matematik - Temel Kavramlar", "TYT Tarih - Tarih ve Zaman",
        "TYT Geometri - AÃ§Ä±lar", "TYT CoÄŸrafya - DÃ¼nya HaritalarÄ±",
        
        # 2. Hafta  
        "TYT TÃ¼rkÃ§e - Ses Bilgisi", "TYT Matematik - BÃ¶lme ve BÃ¶lÃ¼nebilme", "TYT Matematik - EBOB-EKOK",
        "TYT Geometri - Ã–zel ÃœÃ§genler", "TYT CoÄŸrafya - DoÄŸa ve Ä°nsan", "TYT Tarih - Ä°nsanlÄ±ÄŸÄ±n Ä°lk DÃ¶nemleri",
        
        # 3. Hafta
        "TYT TÃ¼rkÃ§e - YazÄ±m KurallarÄ±", "TYT Matematik - OndalÄ±klÄ± SayÄ±lar", "TYT Matematik - Oran OrantÄ±",
        "TYT Geometri - AÃ§Ä±ortay", "TYT CoÄŸrafya - CoÄŸrafi Konum", "TYT Tarih - Ä°lk ve Orta Ã‡aÄŸlarda TÃ¼rk DÃ¼nyasÄ±",
        
        # 4. Hafta
        "TYT TÃ¼rkÃ§e - Noktalama Ä°ÅŸaretleri", "TYT Matematik - Basit EÅŸitsizlikler", "TYT Matematik - Mutlak DeÄŸer",
        "TYT Geometri - EÅŸlik ve Benzerlik", "TYT CoÄŸrafya - Ä°klim", "TYT Tarih - Ä°lk TÃ¼rk Ä°slam Devletleri",
        
        # 5. Hafta
        "TYT TÃ¼rkÃ§e - SÃ¶zcÃ¼k TÃ¼rleri", "TYT Matematik - ÃœslÃ¼ SayÄ±lar", "TYT Matematik - KÃ¶klÃ¼ SayÄ±lar",
        "TYT Geometri - Ã‡okgenler", "TYT CoÄŸrafya - NÃ¼fus", "TYT Tarih - DÃ¼nya GÃ¼cÃ¼ OsmanlÄ±",
        
        # 6. Hafta
        "TYT TÃ¼rkÃ§e - Fiilde Anlam", "TYT Matematik - Ã‡arpanlara AyÄ±rma", "TYT Matematik - Hareket Problemleri",
        "TYT Geometri - Paralelkenar", "TYT CoÄŸrafya - GÃ¶Ã§", "TYT Tarih - OsmanlÄ± Avrupa Ä°liÅŸkileri",
        
        # 7. Hafta - AYT baÅŸlÄ±yor
        "TYT TÃ¼rkÃ§e - Fiilimsi", "AYT Matematik - Fonksiyonlar", "TYT Matematik - Grafik Problemleri",
        "TYT Geometri - DiktÃ¶rtgen", "TYT CoÄŸrafya - Ekonomik Faaliyetler", "TYT Tarih - 1.DÃ¼nya SavaÅŸÄ±",
        
        # 8. Hafta
        "TYT TÃ¼rkÃ§e - CÃ¼mlenin Ã–ÄŸeleri", "TYT Matematik - MantÄ±k", "AYT Matematik - Polinom",
        "TYT Geometri - Yamuk", "TYT Tarih - KurtuluÅŸ SavaÅŸÄ±",
        
        # 9. Hafta
        "TYT Matematik - OlasÄ±lÄ±k", "AYT Matematik - 2.Derece Denklemler", "TYT Geometri - Ã‡emberde AÃ§Ä±",
        "TYT Tarih - TÃ¼rk Ä°nkÄ±labÄ±", "AYT Edebiyat - GÃ¼zel Sanatlar", "AYT CoÄŸrafya - Ekosistem",
        
        # 10. Hafta
        "AYT Edebiyat - Edebi Sanatlar", "AYT CoÄŸrafya - BiyoÃ§eÅŸitlilik", "AYT Matematik - KarmaÅŸÄ±k SayÄ±lar",
        "TYT Tarih - AtatÃ¼rk Ä°lkeleri", "TYT Geometri - Noktanan AnalitiÄŸi",
        
        # 11. Hafta
        "AYT Edebiyat - Åiir Bilgisi", "AYT Matematik - Logaritma", "TYT Geometri - Prizmalar",
        "AYT CoÄŸrafya - NÃ¼fus PolitikalarÄ±", "AYT Tarih - OrtaÃ§aÄŸda DÃ¼nya",
        
        # 12. Hafta
        "AYT Edebiyat - TÃ¼rk EdebiyatÄ± DÃ¶nemleri", "AYT Matematik - Diziler", "TYT Geometri - Silindir",
        "AYT CoÄŸrafya - TÃ¼rkiye Ekonomisi", "AYT Tarih - SelÃ§uklu TÃ¼rkiyesi",
        
        # 13. Hafta
        "AYT Edebiyat - Halk EdebiyatÄ±", "AYT Matematik - TÃ¼rev", "TYT Geometri - Koni",
        "AYT CoÄŸrafya - TÃ¼rkiye'de TarÄ±m", "AYT Tarih - OsmanlÄ± Merkez TeÅŸkilatÄ±",
        
        # 14. Hafta
        "AYT Edebiyat - Tanzimat EdebiyatÄ±", "AYT CoÄŸrafya - KÃ¼resel Ticaret",
        "AYT Tarih - OsmanlÄ± Siyaseti",
        
        # 15. Hafta
        "AYT Edebiyat - Milli Edebiyat", "AYT CoÄŸrafya - Ã‡evre SorunlarÄ±",
        "AYT Tarih - Milli MÃ¼cadele",
        
        # 16. Hafta
        "AYT Edebiyat - Cumhuriyet EdebiyatÄ±", "AYT Matematik - Ä°ntegral",
        "AYT Tarih - XXI. YY EÅŸiÄŸinde TÃ¼rkiye"
    ]

def calculate_monthly_topic_distribution(weekly_topics, current_week, speed_multiplier, start_date, days_to_yks):
    """Ä°lerleme hÄ±zÄ±na gÃ¶re konularÄ± aylara daÄŸÄ±tÄ±r"""
    from datetime import datetime, timedelta
    
    # Kalan konularÄ± hesapla (current_week'ten sonraki konular)
    topics_per_week = 6  # HaftalÄ±k ortalama konu sayÄ±sÄ±
    completed_topics = (current_week - 1) * topics_per_week
    remaining_topics = weekly_topics[completed_topics:]
    
    if not remaining_topics:
        return {}
    
    # Ay isimlerini TÃ¼rkÃ§eleÅŸtir
    month_names = {
        1: "Ocak", 2: "Åubat", 3: "Mart", 4: "Nisan", 5: "MayÄ±s", 6: "Haziran",
        7: "Temmuz", 8: "AÄŸustos", 9: "EylÃ¼l", 10: "Ekim", 11: "KasÄ±m", 12: "AralÄ±k"
    }
    
    # Mevcut tarihten baÅŸlayarak ay ay daÄŸÄ±tÄ±m
    current_date = datetime.now()
    monthly_plan = {}
    topic_index = 0
    week_counter = current_week
    
    # SÄ±nava kadar olan sÃ¼reyi aylara bÃ¶l
    end_date = start_date + timedelta(days=days_to_yks)
    
    while current_date < end_date and topic_index < len(remaining_topics):
        month_name = f"{month_names[current_date.month]} {current_date.year}"
        
        # Bu ayda kaÃ§ hafta var
        next_month = current_date.replace(day=1) + timedelta(days=32)
        next_month = next_month.replace(day=1)
        days_in_month = (next_month - current_date).days
        weeks_in_month = max(1, days_in_month // 7)
        
        # HÄ±z Ã§arpanÄ±na gÃ¶re kaÃ§ haftalÄ±k iÃ§erik bitecek
        effective_weeks = int(weeks_in_month * speed_multiplier)
        topics_this_month = effective_weeks * topics_per_week
        
        # Bu aydaki konularÄ± al
        month_topics = remaining_topics[topic_index:topic_index + topics_this_month]
        
        if month_topics:
            monthly_plan[month_name] = {
                'topics': month_topics,
                'week_range': f"{week_counter}-{week_counter + effective_weeks - 1}"
            }
            topic_index += topics_this_month
            week_counter += effective_weeks
        
        current_date = next_month
    
    return monthly_plan

def show_exam_prediction(monthly_plan, speed_multiplier, student_name):
    """AkÄ±llÄ± Deneme SÄ±navÄ± BaÅŸlangÄ±Ã§ Tahmini - TYT ve AYT AyrÄ±"""
    
    if not monthly_plan:
        return
    
    # AylÄ±k planÄ±n ne zaman biteceÄŸini hesapla
    plan_months = list(monthly_plan.keys())
    if plan_months:
        last_month = plan_months[-1]
        # Son ayÄ±n isminden tahmini tarih Ã§Ä±kar
        if "Mart" in last_month:
            curriculum_finish = "Mart sonu"
            tyt_start_month = "Nisan baÅŸÄ±"
            ayt_start_month = "Nisan ortasÄ±"
            revision_period = "Nisan"
        elif "Åubat" in last_month:
            curriculum_finish = "Åubat sonu" 
            tyt_start_month = "Mart baÅŸÄ±"
            ayt_start_month = "Mart ortasÄ±"
            revision_period = "Mart"
        elif "Nisan" in last_month:
            curriculum_finish = "Nisan sonu"
            tyt_start_month = "MayÄ±s baÅŸÄ±"
            ayt_start_month = "MayÄ±s ortasÄ±"
            revision_period = "MayÄ±s"
        elif "MayÄ±s" in last_month:
            curriculum_finish = "MayÄ±s sonu"
            tyt_start_month = "Haziran baÅŸÄ±"
            ayt_start_month = "Haziran ortasÄ±"
            revision_period = "Haziran"
        else:
            curriculum_finish = "Belirsiz"
            tyt_start_month = "Belirsiz"
            ayt_start_month = "Belirsiz"
            revision_period = "Belirsiz"
    else:
        curriculum_finish = "Belirsiz"
        tyt_start_month = "Belirsiz"
        ayt_start_month = "Belirsiz"
        revision_period = "Belirsiz"
    
    # HÄ±za gÃ¶re dÃ¼zeltme yap
    if speed_multiplier >= 1.1:
        message_type = "success"
        main_icon = "ğŸ†"
        speed_advice = f"MÃ¼kemmel tempoda gidiyorsun {student_name}!"
    elif speed_multiplier >= 0.9:
        message_type = "info" 
        main_icon = "ğŸ¯"
        speed_advice = f"GÃ¼zel bir tempoda ilerliyorsun {student_name}."
    else:
        message_type = "warning"
        main_icon = "âš ï¸"
        speed_advice = f"{student_name}, daha hÄ±zlÄ± Ã§alÄ±ÅŸman gerekiyor!"
    
    # Modern deneme tahmini kartÄ±
    st.markdown("""
    <div style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); 
                padding: 25px; border-radius: 20px; margin: 20px 0; color: white; text-align: center;
                box-shadow: 0 10px 30px rgba(255, 107, 107, 0.3);">
        <h3 style="margin: 0 0 15px 0; color: white; font-weight: 600;">
            ğŸ¯ Deneme SÄ±navÄ± BaÅŸlangÄ±Ã§ Tahmini
        </h3>
        <p style="margin: 0; opacity: 0.9;">AkÄ±llÄ± performans analizi sonucu</p>
    </div>
    """, unsafe_allow_html=True)
    
    # Ana tahmin mesajÄ±
    if message_type == "success":
        st.success(f"{main_icon} {speed_advice}")
    elif message_type == "info":
        st.info(f"{main_icon} {speed_advice}")
    else:
        st.warning(f"{main_icon} {speed_advice}")
    
    # DetaylÄ± deneme planÄ±
    col1, col2, col3 = st.columns(3)
    
    with col1:
        st.markdown(f"""
        <div style="background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%); 
                    padding: 20px; border-radius: 15px; color: white; text-align: center; height: 200px;">
            <h4 style="margin: 0 0 10px 0; color: white;">ğŸ“š MÃ¼fredat BitiÅŸ</h4>
            <div style="font-size: 24px; margin: 15px 0; font-weight: 600;">
                {curriculum_finish}
            </div>
            <p style="margin: 0; opacity: 0.9; font-size: 14px;">
                TÃ¼m konular tamamlanacak
            </p>
        </div>
        """, unsafe_allow_html=True)
    
    with col2:
        st.markdown(f"""
        <div style="background: linear-gradient(135deg, #00cec9 0%, #00b894 100%); 
                    padding: 20px; border-radius: 15px; color: white; text-align: center; height: 200px;">
            <h4 style="margin: 0 0 10px 0; color: white;">ğŸ“‹ TYT Denemeleri</h4>
            <div style="font-size: 24px; margin: 15px 0; font-weight: 600;">
                {tyt_start_month}
            </div>
            <p style="margin: 0; opacity: 0.9; font-size: 14px;">
                TYT deneme serisine baÅŸla
            </p>
        </div>
        """, unsafe_allow_html=True)
    
    with col3:
        st.markdown(f"""
        <div style="background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%); 
                    padding: 20px; border-radius: 15px; color: white; text-align: center; height: 200px;">
            <h4 style="margin: 0 0 10px 0; color: white;">ğŸ“– AYT Denemeleri</h4>
            <div style="font-size: 24px; margin: 15px 0; font-weight: 600;">
                {ayt_start_month}
            </div>
            <p style="margin: 0; opacity: 0.9; font-size: 14px;">
                AYT deneme serisine baÅŸla
            </p>
        </div>
        """, unsafe_allow_html=True)
    
    # Ek bilgi
    st.markdown(f"""
    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin: 15px 0; 
                border-left: 4px solid #007bff;">
        <p style="margin: 0; color: #495057;">
            <strong>ğŸ’¡ {revision_period} AyÄ± PlanÄ±:</strong> 
            MÃ¼fredat bittiÄŸinde {revision_period} ayÄ±nÄ± <strong>tekrar + deneme</strong> odaklÄ± kullan. 
            Ã–nce TYT denemeleriyle baÅŸla, sonra AYT ekle. Bu sayede sÄ±nava en iyi ÅŸekilde hazÄ±r olursun!
        </p>
    </div>
    """, unsafe_allow_html=True)

def get_detailed_weekly_curriculum():
    """16 haftalÄ±k detaylÄ± mÃ¼fredat"""
    return {
        1: {
            "TYT TÃ¼rkÃ§e": ["ğŸ“‹ SÃ¶zcÃ¼kte Anlam: GerÃ§ek Anlam, Mecaz Anlam, Terim Anlam", 
                          "ğŸ“‹ CÃ¼mlede Anlam: CÃ¼mle Yorumlama, Kesin YargÄ±, AnlatÄ±m BiÃ§imleri, Neden-SonuÃ§", 
                          "ğŸ“‹ Paragraf: Ana Fikir, YardÄ±mcÄ± Fikir, Paragraf YapÄ±sÄ±, AnlatÄ±m Teknikleri, DÃ¼ÅŸÃ¼nceyi GeliÅŸtirme"],
            "TYT Matematik": ["Temel Kavramlar", "SayÄ± BasamaklarÄ±"],
            "TYT Tarih": ["Tarih ve Zaman"],
            "TYT Geometri": ["ğŸ“‹ AÃ§Ä±lar: DoÄŸruda AÃ§Ä±lar, ÃœÃ§gende AÃ§Ä±lar"],
            "TYT CoÄŸrafya": ["DÃ¼nya HaritalarÄ±"]
        },
        2: {
            "TYT TÃ¼rkÃ§e": ["ğŸ“‹ Ses Bilgisi"],
            "TYT Matematik": ["BÃ¶lme ve BÃ¶lÃ¼nebilme", "EBOB-EKOK", "Rasyonel SayÄ±lar"],
            "TYT Geometri": ["Ã–zel ÃœÃ§genler: Dik ÃœÃ§gen, EÅŸkenar ÃœÃ§gen, Ä°kizkenar ÃœÃ§gen"],
            "TYT CoÄŸrafya": ["DoÄŸa ve Ä°nsan", "DÃ¼nya'nÄ±n Åekli ve Hareketleri (GÃ¼nlÃ¼k ve YÄ±llÄ±k Hareketler, SonuÃ§larÄ±)"],
            "TYT Tarih": ["Ä°nsanlÄ±ÄŸÄ±n Ä°lk DÃ¶nemleri", "OrtaÃ§aÄŸda DÃ¼nya"]
        },
        3: {
            "TYT TÃ¼rkÃ§e": ["YazÄ±m KurallarÄ±"],
            "TYT Matematik": ["OndalÄ±klÄ± SayÄ±lar", "Oran OrantÄ±", "Denklem Ã‡Ã¶zme", "Problemler (SayÄ± Problemleri, Kesir Problemleri)"],
            "TYT Geometri": ["AÃ§Ä±ortay", "Kenarortay"],
            "TYT CoÄŸrafya": ["CoÄŸrafi Konum", "Harita Bilgisi", "Atmosfer ve SÄ±caklÄ±k"],
            "TYT Tarih": ["Ä°lk ve Orta Ã‡aÄŸlarda TÃ¼rk DÃ¼nyasÄ±", "Ä°slam Medeniyetinin DoÄŸuÅŸu"]
        },
        4: {
            "TYT TÃ¼rkÃ§e": ["Noktalama Ä°ÅŸaretleri", "SÃ¶zcÃ¼kte YapÄ±"],
            "TYT Matematik": ["Basit EÅŸitsizlikler", "Mutlak DeÄŸer", "Problemler (YaÅŸ Problemleri, YÃ¼zde Problemleri, Kar-Zarar Problemleri)"],
            "TYT Geometri": ["EÅŸlik ve Benzerlik", "ÃœÃ§gende Alan"],
            "TYT CoÄŸrafya": ["Ä°klim", "BasÄ±nÃ§ ve RÃ¼zgarlar", "Nem YaÄŸÄ±ÅŸ ve BuharlaÅŸma"],
            "TYT Tarih": ["Ä°lk TÃ¼rk Ä°slam Devletleri", "YerleÅŸme ve DevletleÅŸme SÃ¼recinde SelÃ§uklu TÃ¼rkiyesi", "Beylikten Devlete OsmanlÄ± Siyaseti (1300-1453)"]
        },
        5: {
            "TYT TÃ¼rkÃ§e": ["SÃ¶zcÃ¼k TÃ¼rleri (Ä°simler, Zamirler, SÄ±fatlar, Zarf, Edat)"],
            "TYT Matematik": ["ÃœslÃ¼ SayÄ±lar", "KÃ¶klÃ¼ SayÄ±lar", "Problemler (KarÄ±ÅŸÄ±m Problemleri)"],
            "TYT Geometri": ["AÃ§Ä±-Kenar BaÄŸÄ±ntÄ±larÄ±", "Ã‡okgenler"],
            "TYT CoÄŸrafya": ["Ä°Ã§ Kuvvetler/DÄ±ÅŸ Kuvvetler", "Su-Toprak ve Bitkiler", "NÃ¼fus"],
            "TYT Tarih": ["DÃ¼nya GÃ¼cÃ¼ OsmanlÄ± (1453-1600)", "Yeni Ã‡aÄŸ Avrupa Tarihi"]
        },
        6: {
            "TYT TÃ¼rkÃ§e": ["Fiilde Anlam", "Ek Fiil"],
            "TYT Matematik": ["Ã‡arpanlara AyÄ±rma", "Problemler (Hareket Problemleri, Ä°ÅŸÃ§i Problemleri)"],
            "TYT Geometri": ["Ã–zel DÃ¶rtgenler", "Deltoid", "Paralelkenar"],
            "TYT CoÄŸrafya": ["GÃ¶Ã§", "YerleÅŸme", "TÃ¼rkiye'nin Yer Åekilleri"],
            "TYT Tarih": ["OsmanlÄ± Devletinde ArayÄ±ÅŸ YÄ±llarÄ±", "OsmanlÄ± Avrupa Ä°liÅŸkileri", "18.YY DeÄŸiÅŸim ve Diplomasi", "En Uzun YÃ¼zyÄ±l", "OsmanlÄ± KÃ¼ltÃ¼r ve Medeniyeti"]
        },
        7: {
            "TYT TÃ¼rkÃ§e": ["Fiilimsi", "Fiilde Ã‡atÄ±"],
            "AYT Matematik": ["Fonksiyonlar"],
            "TYT Matematik": ["Problemler (Tablo-Grafik Problemleri, Rutin Olmayan Problemler)"],
            "TYT Geometri": ["EÅŸkenar DÃ¶rtgen", "DiktÃ¶rtgen"],
            "TYT CoÄŸrafya": ["Ekonomik Faaliyetler", "BÃ¶lgeler UluslararasÄ± UlaÅŸÄ±m HatlarÄ±, Ã‡evre ve Toplum", "DoÄŸal Afetler"],
            "TYT Tarih": ["20.YY OsmanlÄ± Devleti", "1.DÃ¼nya SavaÅŸÄ±"]
        },
        8: {
            "TYT TÃ¼rkÃ§e": ["CÃ¼mlenin Ã–ÄŸeleri", "CÃ¼mle TÃ¼rleri", "AnlatÄ±m BozukluÄŸu"],
            "TYT Matematik": ["MantÄ±k", "KÃ¼meler"],
            "AYT Matematik": ["Polinom"],
            "TYT Geometri": ["Kare", "Yamuk"],
            "TYT Tarih": ["Mondros AteÅŸkesi, Ä°ÅŸgaller ve Cemiyetler", "KurtuluÅŸ SavaÅŸÄ±na HazÄ±rlÄ±k DÃ¶nemi", "1.TBMM DÃ¶nemi", "KurtuluÅŸ SavaÅŸÄ± ve AnlaÅŸmalar"]
        },
        9: {
            "TYT Matematik": ["OlasÄ±lÄ±k"],
            "AYT Matematik": ["2.Derece Denklemler"],
            "TYT Geometri": ["Ã‡emberde AÃ§Ä±", "Ã‡emberde Uzunluk"],
            "TYT Tarih": ["II.TBMM DÃ¶nemi ve Ã‡ok Partili Hayata GeÃ§iÅŸ", "TÃ¼rk Ä°nkÄ±labÄ±"],
            "AYT Edebiyat": ["GÃ¼zel Sanatlar ve Edebiyat ile Ä°liÅŸkisi", "Metinlerin SÄ±nÄ±flandÄ±rÄ±lmasÄ±"],
            "AYT CoÄŸrafya": ["Ekosistem"]
        },
        10: {
            "AYT Edebiyat": ["Edebi Sanatlar", "Edebiyat AkÄ±mlarÄ±"],
            "AYT CoÄŸrafya": ["BiyoÃ§eÅŸitlilik", "Biyomlar", "Ekosistem UnsurlarÄ±"],
            "AYT Matematik": ["KarmaÅŸÄ±k SayÄ±lar", "2.Derece Denklem ve EÅŸitsizlikler"],
            "TYT Tarih": ["AtatÃ¼rk Ä°lkeleri", "AtatÃ¼rk DÃ¶nemi TÃ¼rk DÄ±ÅŸ PolitikasÄ±"],
            "TYT Geometri": ["Dairede Ã‡evre ve Alan", "NoktanÄ±n AnalitiÄŸi"]
        },
        11: {
            "AYT Edebiyat": ["DÃ¼nya EdebiyatÄ±", "Anlam Bilgisi (Tekrar)", "Dil Bilgisi (Tekrar)", "Åiir Bilgisi"],
            "AYT Matematik": ["Parabol", "Logaritma"],
            "TYT Geometri": ["DoÄŸrunun AnalitiÄŸi", "Prizmalar"],
            "AYT CoÄŸrafya": ["Enerji AkÄ±ÅŸÄ± ve Madde DÃ¶ngÃ¼sÃ¼", "NÃ¼fus PolitikalarÄ±", "TÃ¼rkiye'de NÃ¼fus ve YerleÅŸme", "GÃ¶Ã§ ve ÅehirleÅŸme"],
            "AYT Tarih": ["Tarih ve Zaman (Temel Kavramlar)", "Ä°nsanlÄ±ÄŸÄ±n Ä°lk DÃ¶nemleri", "OrtaÃ§aÄŸda DÃ¼nya"]
        },
        12: {
            "AYT Edebiyat": ["TÃ¼rk EdebiyatÄ± DÃ¶nemleri (Genel Ã–zellikler)", "Ä°slamiyet Ã–ncesi TÃ¼rk EdebiyatÄ± (SÃ¶zlÃ¼ ve YazÄ±lÄ±)", "Ä°slamiyet Etkisindeki GeÃ§iÅŸ DÃ¶nemi EdebiyatÄ±"],
            "AYT Matematik": ["Diziler", "Limit"],
            "TYT Geometri": ["KÃ¼p", "Silindir"],
            "AYT CoÄŸrafya": ["Ekonomik Faaliyetler ve DoÄŸal Kaynaklar", "TÃ¼rkiye Ekonomisi", "TÃ¼rkiye'nin Ekonomi PolitikalarÄ±", "TÃ¼rkiye Ekonomisinin SektÃ¶rel DaÄŸÄ±lÄ±mÄ±"],
            "AYT Tarih": ["Ä°lk ve Orta Ã‡aÄŸlarda TÃ¼rk DÃ¼nyasÄ±", "Ä°slam Medeniyetinin DoÄŸuÅŸu", "TÃ¼rklerin Ä°slamiyeti KabulÃ¼ ve Ä°lk TÃ¼rk Ä°slam Devletleri", "YerleÅŸme ve DevletleÅŸme SÃ¼recindeki SelÃ§uklu TÃ¼rkiyesi"]
        },
        13: {
            "AYT Edebiyat": ["Halk EdebiyatÄ±", "Divan EdebiyatÄ±"],
            "AYT Matematik": ["TÃ¼rev"],
            "AYT CoÄŸrafya": ["TÃ¼rkiye'de TarÄ±m", "TÃ¼rkiye'de UlaÅŸÄ±m", "TÃ¼rkiye'de Ticaret ve Turizm", "GeÃ§miÅŸten GeleceÄŸe Åehir ve Ekonomi", "TÃ¼rkiye'nin Ä°ÅŸlevsel BÃ¶lgeleri ve KalkÄ±nma Projeleri", "Hizmet SektÃ¶rÃ¼nÃ¼n Ekonomideki Yeri"],
            "AYT Tarih": ["Beylikten Devlete OsmanlÄ± Siyaseti", "DevletleÅŸme SÃ¼recindeki SavaÅŸÃ§Ä±lar ve Askerler", "Beylikten Devlete OsmanlÄ± Medeniyeti", "DÃ¼nya GÃ¼cÃ¼ OsmanlÄ±", "Sultan ve OsmanlÄ± ve Merkez TeÅŸkilatÄ±", "Klasik Ã‡aÄŸda OsmanlÄ± Toplum DÃ¼zeni"],
            "TYT Geometri": ["Piramit", "Koni", "KÃ¼re"]
        },
        14: {
            "AYT Edebiyat": ["Tanzimat DÃ¶nemi EdebiyatÄ± (1. ve 2. KuÅŸak)", "Servet-i FÃ¼nun EdebiyatÄ± (Edebiyat-Ä± Cedide)", "Fecr-i Ati EdebiyatÄ±"],
            "AYT CoÄŸrafya": ["KÃ¼resel Ticaret", "BÃ¶lgeler ve Ãœlkeler", "Ä°lk UygarlÄ±klar", "KÃ¼ltÃ¼r BÃ¶lgeleri ve TÃ¼rk KÃ¼ltÃ¼rÃ¼", "SanayileÅŸme SÃ¼reci: Almanya", "Tarih ve Ekonomi Ä°liÅŸkisi Fransa-Somali", "Ãœlkeler ArasÄ± EtkileÅŸim", "Jeopolitik Konum", "Ã‡atÄ±ÅŸma BÃ¶lgeleri", "KÃ¼resel ve BÃ¶lgesel Ã–rgÃ¼tler"],
            "AYT Tarih": ["DeÄŸiÅŸen DÃ¼nya Dengeleri KarÅŸÄ±sÄ±nda OsmanlÄ± Siyaseti", "DeÄŸiÅŸim Ã‡aÄŸÄ±nda Avrupa ve OsmanlÄ±", "UluslararasÄ± Ä°liÅŸkilerde Denge Stratejisi", "Devrimler Ã‡aÄŸÄ±nda ve DeÄŸiÅŸen Devlet Toplum Ä°liÅŸkileri", "Sermaye ve Emek", "XIX. ve XX. YY DeÄŸiÅŸen GÃ¼ndelik Hayat"]
        },
        15: {
            "AYT Edebiyat": ["Milli Edebiyat"],
            "AYT CoÄŸrafya": ["Ekstrem DoÄŸa OlaylarÄ±", "KÃ¼resel Ä°klim DeÄŸiÅŸimi", "Ã‡evre ve Toplum", "Ã‡evre SorunlarÄ± ve TÃ¼rleri", "Madenler ve Enerji KaynaklarÄ±nÄ±n Ã‡evreye Etkisi", "DoÄŸal KaynaklarÄ±n SÃ¼rdÃ¼rÃ¼lebilir KullanÄ±mÄ±", "Ekolojik Ayak Ä°zi", "DoÄŸal Ã‡evrenin SÄ±nÄ±rlÄ±lÄ±ÄŸÄ±", "Ã‡evre PolitikalarÄ±", "Ã‡evresel Ã–rgÃ¼tler", "Ã‡evre AnlaÅŸmalarÄ±", "DoÄŸal Afetler"],
            "AYT Tarih": ["XX.YY BaÅŸlarÄ±nda OsmanlÄ± Devleti ve DÃ¼nya", "Milli MÃ¼cadele", "AtatÃ¼rkÃ§Ã¼lÃ¼k ve TÃ¼rk Ä°nkÄ±labÄ±"]
        },
        16: {
            "AYT Edebiyat": ["Cumhuriyet DÃ¶nemi EdebiyatÄ±", "Edebi AkÄ±mlar"],
            "AYT Tarih": ["Ä°lk SavaÅŸ ArasÄ±ndaki DÃ¶nemde TÃ¼rkiye ve DÃ¼nya", "II.DÃ¼nya SavaÅŸÄ± SÃ¼recinde TÃ¼rkiye ve DÃ¼nya", "II.DÃ¼nya SavaÅŸ SonrasÄ±nda TÃ¼rkiye ve DÃ¼nya", "Toplumsal Devrim Ã‡aÄŸÄ±nda DÃ¼nya ve TÃ¼rkiye", "XXI. YY EÅŸiÄŸinde TÃ¼rkiye ve DÃ¼nya"],
            "AYT Matematik": ["Ä°ntegral", "OlasÄ±lÄ±k, Binom, PermÃ¼tasyon Kombinasyon"]
        }
    }

def show_enhanced_dynamic_calendar(user_data, weekly_completion_rate, weekly_plan_start, days_to_yks, student_field):
    """ğŸ—“ï¸ GeliÅŸtirilmiÅŸ Dinamik Konu BitiÅŸ Takvimi"""
    from datetime import datetime, timedelta
    
    # DetaylÄ± mÃ¼fredatÄ± al
    curriculum = get_detailed_weekly_curriculum()
    
    # BaÅŸlangÄ±Ã§ tarihini parse et
    try:
        start_date = datetime.strptime(weekly_plan_start, "%Y-%m-%d")
    except:
        start_date = datetime.now()
    
    # Mevcut hafta hesaplama
    current_date = datetime.now()
    elapsed_weeks = max(0, (current_date - start_date).days // 7)
    current_week = min(elapsed_weeks + 1, 16)
    
    # HaftalÄ±k tamamlanma oranÄ±na gÃ¶re gerÃ§ek hÄ±z hesaplama
    # %85+ = 1.2 hafta/hafta (hÄ±zlandÄ±rÄ±lmÄ±ÅŸ), %70-84 = 1.0 hafta/hafta (normal), %50-69 = 0.8 hafta/hafta (yavaÅŸ), <%50 = 0.6 hafta/hafta (Ã§ok yavaÅŸ)
    if weekly_completion_rate >= 85:
        speed_multiplier = 1.2
    elif weekly_completion_rate >= 70:
        speed_multiplier = 1.0
    elif weekly_completion_rate >= 50:
        speed_multiplier = 0.8
    else:
        speed_multiplier = 0.6
    
    # Ay isimlerini TÃ¼rkÃ§eleÅŸtir
    month_names_tr = {
        'January': 'Ocak', 'February': 'Åubat', 'March': 'Mart', 'April': 'Nisan',
        'May': 'MayÄ±s', 'June': 'Haziran', 'July': 'Temmuz', 'August': 'AÄŸustos',
        'September': 'EylÃ¼l', 'October': 'Ekim', 'November': 'KasÄ±m', 'December': 'AralÄ±k'
    }
    
    # Ay ay planlama
    monthly_plan = {}
    current_curriculum_week = current_week
    plan_date = start_date + timedelta(weeks=elapsed_weeks)
    
    # Her ayÄ± hesapla
    while current_curriculum_week <= 16 and plan_date < start_date + timedelta(days=days_to_yks):
        month_name = plan_date.strftime("%B %Y")
        for eng, tr in month_names_tr.items():
            month_name = month_name.replace(eng, tr)
        
        if month_name not in monthly_plan:
            monthly_plan[month_name] = []
        
        # Bu ayda kaÃ§ hafta sÄ±ÄŸar hesapla
        month_start = plan_date
        next_month = month_start + timedelta(days=32)
        next_month = next_month.replace(day=1)
        days_in_month = (next_month - month_start).days
        weeks_in_month = days_in_month / 7
        
        # GerÃ§ek hÄ±za gÃ¶re kaÃ§ haftalÄ±k mÃ¼fredat bitecek
        weeks_to_complete = weeks_in_month * speed_multiplier
        
        while weeks_to_complete >= 1.0 and current_curriculum_week <= 16:
            if current_curriculum_week in curriculum:
                month_info = {
                    'week': current_curriculum_week,
                    'topics': curriculum[current_curriculum_week]
                }
                monthly_plan[month_name].append(month_info)
            
            current_curriculum_week += 1
            weeks_to_complete -= 1.0
        
        plan_date = next_month
    
    # Takvimi gÃ¶ster
    st.markdown(f"""
    **ğŸ¯ HaftalÄ±k %{weekly_completion_rate:.1f} tamamlama hÄ±zÄ±nÄ±za gÃ¶re aylÄ±k konu tahmini:**
    *HÄ±z Ã‡arpanÄ±: {speed_multiplier}x ({"HÄ±zlandÄ±rÄ±lmÄ±ÅŸ" if speed_multiplier > 1 else "Normal" if speed_multiplier == 1 else "YavaÅŸlatÄ±lmÄ±ÅŸ"})*
    """)
    
    if not monthly_plan:
        st.info("ğŸ“ MÃ¼fredat tamamlanmÄ±ÅŸ veya veri yetersiz!")
        return
    
    # Her ay iÃ§in gÃ¶sterim
    for month, month_data in monthly_plan.items():
        if month_data:
            total_subjects = sum(len(week_info['topics']) for week_info in month_data)
            
            with st.expander(f"ğŸ“… **{month}** ({len(month_data)} hafta, {total_subjects} ders)"):
                for week_info in month_data:
                    week_num = week_info['week']
                    topics = week_info['topics']
                    
                    st.markdown(f"### ğŸ”¸ {week_num}. Hafta")
                    
                    for subject, subject_topics in topics.items():
                        st.markdown(f"**{subject}:**")
                        for topic in subject_topics:
                            st.write(f"   â€¢ {topic}")
                    st.markdown("---")
    
    # Ä°lerleme durumu ve tahminler
    st.markdown("---")
    
    # Deneme sÄ±navlarÄ± tahmini
    total_months = len(monthly_plan)
    if total_months >= 4:
        exam_start_month = list(monthly_plan.keys())[-2] if len(monthly_plan) >= 2 else list(monthly_plan.keys())[-1]
        st.success(f"ğŸ¯ **Bu hÄ±zda gidersen {exam_start_month}'de denemelere baÅŸlayabilirsin!**")
    elif total_months >= 2:
        exam_start_month = list(monthly_plan.keys())[-1]
        st.info(f"ğŸ“ **Bu tempoda {exam_start_month}'de denemelere baÅŸlayabilirsin.**")
    else:
        st.warning("âš ï¸ **Daha hÄ±zlÄ± Ã§alÄ±ÅŸman gerekiyor - mÃ¼fredat yetiÅŸtirme riski var!**")
    
    # Performans Ã¶nerileri
    if speed_multiplier < 1.0:
        st.error(f"""
        ğŸš¨ **Dikkat:** Mevcut hÄ±zÄ±nÄ±z (%{weekly_completion_rate:.1f}) mÃ¼fredatÄ± yetiÅŸtirmek iÃ§in yetersiz!
        
        **Ã–neriler:**
        - HaftalÄ±k hedeflerin %85+ tamamlamaya odaklan
        - Ã‡alÄ±ÅŸma saatlerini artÄ±r
        - Daha etkili Ã§alÄ±ÅŸma teknikleri kullan
        - Eksik konulara Ã¶ncelik ver
        """)
    elif speed_multiplier > 1.0:
        st.success(f"""
        ğŸš€ **Harika:** Mevcut hÄ±zÄ±nÄ±z (%{weekly_completion_rate:.1f}) ile mÃ¼fredatÄ± rahatlÄ±kla yetiÅŸtiriyorsun!
        
        **ArtÄ±lar:**
        - Deneme sÄ±navlarÄ±na erken baÅŸlayabilirsin
        - ZayÄ±f konular iÃ§in ekstra zaman ayÄ±rabilirsin
        - Tekrar programÄ±nÄ± geniÅŸletebilirsin
        """)
    else:
        st.info(f"""
        ğŸ“ˆ **Ä°yi:** Mevcut hÄ±zÄ±nÄ±z (%{weekly_completion_rate:.1f}) normal tempoda ilerliyor.
        
        **Ã–neriler:**
        - Bu tempoyu koru
        - PerformansÄ±nÄ± %85+'a Ã§Ä±karmaya Ã§alÄ±ÅŸ
        - DÃ¼zenli tekrarlarÄ± ihmal etme
        """)


def show_scientific_life_coaching(user_data):
    """ğŸ§  Bilimsel YaÅŸam KoÃ§luÄŸu - YKS iÃ§in nÃ¶robilim destekli optimizasyon"""
    st.subheader("ğŸ§  YKS NÃ¶robilim Optimizasyonu")
    st.write("*Akademik performansÄ±nÄ±zÄ± maksimize etmek iÃ§in nÃ¶robilim ve psikoloji araÅŸtÄ±rmalarÄ±na dayalÄ± stratejiler*")
    
    # Puan aÃ§Ä±ÄŸÄ± analizi
    current_score = calculate_current_yks_score(user_data)
    estimated_target = current_score + 50
    score_gap = estimated_target - current_score
    
    # Bilimsel mod belirleme
    if score_gap > 100:
        mode = "YoÄŸun Optimizasyon"
        study_intensity = "8-10 saat/gÃ¼n"
        cognitive_load = "Maksimum"
    elif score_gap > 50:
        mode = "Dengeli Optimizasyon"  
        study_intensity = "6-8 saat/gÃ¼n"
        cognitive_load = "YÃ¼ksek"
    else:
        mode = "SÃ¼rdÃ¼rÃ¼lebilir Optimizasyon"
        study_intensity = "4-6 saat/gÃ¼n"
        cognitive_load = "Orta"
    
    # Bilimsel strateji kartÄ±
    st.markdown(f"""
    <div style="background: linear-gradient(135deg, #2E86C1 0%, #8E44AD 100%); 
                padding: 25px; border-radius: 15px; margin: 10px 0; color: white;">
        <h3>ğŸ¯ {mode}</h3>
        <p><strong>Puan Hedefi:</strong> {score_gap:.1f} puan artÄ±ÅŸ gerekli</p>
        <p><strong>Ã–nerilen Ã‡alÄ±ÅŸma YoÄŸunluÄŸu:</strong> {study_intensity}</p>
        <p><strong>BiliÅŸsel YÃ¼k Seviyesi:</strong> {cognitive_load}</p>
        <small>*NÃ¶roplastisite ve performans optimizasyonu araÅŸtÄ±rmalarÄ±na dayalÄ±</small>
    </div>
    """, unsafe_allow_html=True)
    
    # Bilimsel modÃ¼ller
    tabs = st.tabs(["ğŸ§¬ NÃ¶roplastisite", "âš¡ BiliÅŸsel Performans", "ğŸ”¬ Beslenme Bilimi", "ğŸ˜´ Uyku NÃ¶robilimi"])
    
    with tabs[0]:
        show_neuroplasticity_coaching(score_gap)
    
    with tabs[1]:
        show_cognitive_performance_coaching(score_gap)
        
    with tabs[2]:
        show_nutrition_science_coaching(score_gap)
        
    with tabs[3]:
        show_sleep_neuroscience_coaching(score_gap)

def show_neuroplasticity_coaching(score_gap):
    """ğŸ§¬ NÃ¶roplastisite ve Ã–ÄŸrenme Optimizasyonu"""
    st.subheader("ğŸ§¬ NÃ¶roplastisite TabanlÄ± Ã–ÄŸrenme")
    
    st.markdown("""
    **ğŸ“š BÄ°LÄ°MSEL TEMEL:**
    NÃ¶roplastisite araÅŸtÄ±rmalarÄ±, beyninizin yeni baÄŸlantÄ±lar kurarak sÃ¼rekli deÄŸiÅŸtiÄŸini gÃ¶steriyor. 
    YKS baÅŸarÄ±sÄ± iÃ§in bu sÃ¼reÃ§leri optimize edebiliriz.
    """)
    
    # YoÄŸunluk bazÄ±nda strateji
    if score_gap > 100:
        st.markdown("""
        **ğŸ¯ YOÄUN Ã–ÄRENÄ°M STRATEJÄ°SÄ°:**
        
        **â° Pomodoro+ ProtokolÃ¼:**
        - 50 dk yoÄŸun Ã§alÄ±ÅŸma + 10 dk aktif dinlenme
        - Her 4 blokta 30 dk tam dinlenme
        - GÃ¼nde maksimum 8-10 blok (400-500 dk)
        
        **ğŸ§  BiliÅŸsel YÃ¼k YÃ¶netimi:**
        - Sabah: En zor konular (06:00-10:00) - Kortizol peak
        - Ã–ÄŸlen: Orta zorluk (14:00-17:00) - Ä°kinci zirve
        - AkÅŸam: Tekrar/kolay konular (19:00-21:00)
        
        **ğŸ”„ Spaced Repetition Schedule:**
        - 1. gÃ¼n Ã¶ÄŸren â†’ 3. gÃ¼n tekrar â†’ 7. gÃ¼n tekrar â†’ 21. gÃ¼n tekrar
        - Forgetting curve'Ã¼ kÄ±rmak iÃ§in kritik zamanlamalar
        """)
    elif score_gap > 50:
        st.markdown("""
        **ğŸ¯ DENGELÄ° Ã–ÄRENÄ°M STRATEJÄ°SÄ°:**
        
        **â° Klasik Pomodoro:**
        - 45 dk Ã§alÄ±ÅŸma + 15 dk dinlenme
        - GÃ¼nde 6-8 blok (270-360 dk)
        
        **ğŸ§  Optimal Timing:**
        - Sabah: Yeni konular
        - Ã–ÄŸleden sonra: Problem Ã§Ã¶zme
        - AkÅŸam: GÃ¶zden geÃ§irme
        """)
    else:
        st.markdown("""
        **ğŸ¯ SÃœRDÃœRÃœLEBÄ°LÄ°R Ã–ÄRENÄ°M:**
        
        **â° Esnek Bloklar:**
        - 40 dk Ã§alÄ±ÅŸma + 20 dk dinlenme
        - GÃ¼nde 4-6 blok (160-240 dk)
        
        **ğŸ§  Kalite OdaklÄ±:**
        - Konsantrasyonunuz tam olduÄŸunda Ã§alÄ±ÅŸÄ±n
        - Yorgunken molaya Ã§Ä±kÄ±n
        """)

def show_cognitive_performance_coaching(score_gap):
    """âš¡ BiliÅŸsel Performans Optimizasyonu"""
    st.subheader("âš¡ BiliÅŸsel Performans ve Dikkat KontrolÃ¼")
    
    st.markdown("""
    **ğŸ“š BÄ°LÄ°MSEL TEMEL:**
    Ã‡alÄ±ÅŸma verimi = Odaklanma Ã— Ã‡alÄ±ÅŸma SÃ¼resi Ã— Stratejik Tekrar
    NÃ¶ropsikoloji araÅŸtÄ±rmalarÄ± optimal Ã§alÄ±ÅŸma protokollerini tanÄ±mlÄ±yor.
    """)
    
    if score_gap > 100:
        st.markdown("""
        **ğŸ¯ YÃœKSEK PERFORMANS PROTOKOLLERÄ°:**
        
        **ğŸ§  Deep Work Sessions:**
        - Ã‡alÄ±ÅŸma Ã¶ncesi 5 dk meditasyon (PFC aktivasyonu)
        - Tek konu odaÄŸÄ± - multitasking yasak
        - Telefon uÃ§ak modunda, bildirimler kapalÄ±
        - Flow state iÃ§in 90-120 dk sÃ¼rekli bloklar
        """)
    elif score_gap > 50:
        st.markdown("""
        **ğŸ¯ DENGELÄ° PERFORMANS:**
        
        **ğŸ§  Fokus BloklarÄ±:**
        - 45-60 dk dikkat bloklarÄ±
        - Konu deÄŸiÅŸimleri arasÄ± 10 dk break
        - GÃ¼nde 6-8 kaliteli blok hedefi
        """)
    else:
        st.markdown("""
        **ğŸ¯ SÃœRDÃœRÃœLEBÄ°LÄ°R Ã‡ALIÅMA:**
        
        **ğŸ§  Temel Teknikler:**
        - Pomodoro Technique (25+5)
        - Summarization after each session
        - Question generation
        """)

def show_nutrition_science_coaching(score_gap):
    """ğŸ”¬ Beslenme Bilimi ve Beyin Optimizasyonu"""
    st.subheader("ğŸ”¬ NÃ¶ronutrisyon - Beyin KimyasÄ± Optimizasyonu")
    
    st.markdown("""
    **ğŸ“š BÄ°LÄ°MSEL TEMEL:**
    Beyin glukozu enerji olarak kullanÄ±r (%20'si), omega-3 nÃ¶ron membranlarÄ±nÄ± gÃ¼Ã§lendirir,
    antioksidanlar oksidatif stresi azaltÄ±r. YKS performansÄ± iÃ§in bu dengeyi optimize ediyoruz.
    """)
    
    if score_gap > 100:
        st.markdown("""
        **ğŸ§¬ YÃœKSEK PERFORMANS NÃ–RONUTRÄ°SYON:**
        
        **ğŸŒ… Sabah ProtokolÃ¼ (06:00-08:00):**
        ```
        ğŸ¥š 2 adet omega-3 yumurta (protein + kolin)
        ğŸ¥‘ Â½ avokado (monounsaturated fat + K vitamini)  
        ğŸ« 1 kase blueberry (anthocyanin + BDNF boost)
        â˜• Green tea (L-theanine + kafein sinerjisi)
        ```
        **NÃ¶rolojik Etki:** Asetilkolin â†‘, Dopamin â†‘, KortizoÅ‚ regulation
        """)
    elif score_gap > 50:
        st.markdown("""
        **ğŸ§¬ DENGELÄ° NÃ–RONUTRÄ°SYON:**
        
        **ğŸŒ… Sabah:** Protein + omega-3 + karmaÅŸÄ±k karbonhidrat
        **ğŸ“š Ã‡alÄ±ÅŸma:** DoÄŸal ÅŸeker + saÄŸlÄ±klÄ± yaÄŸ kombinasyonu
        **ğŸ½ï¸ Ã–ÄŸle:** BalÄ±k/et + sebze + tam tahÄ±l
        **ğŸŒ™ AkÅŸam:** Hafif protein + magnezyum iÃ§eren gÄ±dalar
        """)
    else:
        st.markdown("""
        **ğŸ§¬ TEMEL NÃ–RONUTRÄ°SYON:**
        
        **ğŸ¯ Temel Kurallar:**
        - Her Ã¶ÄŸÃ¼nde protein bulundurun
        - Omega-3 kaynaklarÄ±nÄ± haftada 2-3 kez tÃ¼ketin
        - Antioksidan zengini meyve-sebze (gÃ¼nde 5 porsiyon)
        - Åeker dalgalanmalarÄ±ndan kaÃ§Ä±nÄ±n
        """)

def show_sleep_neuroscience_coaching(score_gap):
    """ğŸ˜´ Uyku NÃ¶robilimi ve Bellek Konsolidasyonu"""
    st.subheader("ğŸ˜´ Sleep Optimization for Memory Consolidation")
    
    st.markdown("""
    **ğŸ“š BÄ°LÄ°MSEL TEMEL:**
    Uyku sÄ±rasÄ±nda beyniniz Ã¶ÄŸrendiklerinizi hippocampus'tan neocortex'e transfer eder.
    Sleep spindles ve slow-wave sleep memory consolidation iÃ§in kritik.
    """)
    
    if score_gap > 100:
        st.markdown("""
        **ğŸ§  YOÄUN Ã‡ALIÅMA Ä°Ã‡Ä°N UYKU PROTOKOLÃŸ:**
        
        **â° Optimal Sleep Window:**
        ```
        ğŸŒ™ YatÄ±ÅŸ: 22:30 (Melatonin peak iÃ§in)
        ğŸŒ… KalkÄ±ÅŸ: 06:00 (7.5 saat = 5 REM cycle)
        ğŸ’¡ Light exposure: 06:00-06:30 (Circadian reset)
        ```
        """)
    elif score_gap > 50:
        st.markdown("""
        **ğŸ§  DENGELÄ° UYKU OPTÄ°MÄ°ZASYONU:**
        
        **â° Sleep Schedule:**
        - YatÄ±ÅŸ: 23:00-06:30 (7.5 saat)
        - TutarlÄ± uyku saatleri (Â±30 dk tolerance)
        - Hafta sonu da aynÄ± ritim
        """)
    else:
        st.markdown("""
        **ğŸ§  TEMEL UYKU HÄ°JYENÄ°:**
        
        **â° Minimum Requirements:**
        - 7-8 saat uyku
        - DÃ¼zenli yatÄ±ÅŸ/kalkÄ±ÅŸ saatleri
        - Yatmadan 1 saat Ã¶nce ekran yok
        - KaranlÄ±k, serin, sessiz ortam
        """)

def show_real_topic_completion_timeline(user_data, current_progress, days_to_yks, student_field):
    """GERÃ‡EK HAFTALÄ°K GÄ°DÄ°ÅATA GÃ–RE KONU BÄ°TÄ°Å TAKVÄ°MÄ° - Her hafta gÃ¼ncellenir"""
    
    # KullanÄ±cÄ±nÄ±n gerÃ§ek Ã¶ÄŸrenme hÄ±zÄ±nÄ± hesapla
    completed_topics = user_data.get('completed_topics', {})
    study_weeks = max(1, len([week for week in user_data.get('weekly_progress', {}).keys()]))
    actual_completion_rate = len(completed_topics) / max(1, study_weeks)  # Hafta baÅŸÄ±na konu sayÄ±sÄ±
    
    # Alan bazlÄ± toplam konular
    total_topics = {
        'SayÄ±sal': {
            'Matematik': 45, 'Fizik': 35, 'Kimya': 30, 'Biyoloji': 25,
            'TÃ¼rkÃ§e': 20, 'Tarih': 15, 'CoÄŸrafya': 15, 'Felsefe': 10
        },
        'EÅŸit AÄŸÄ±rlÄ±k': {
            'Matematik': 30, 'TÃ¼rkÃ§e': 35, 'Tarih': 40, 'CoÄŸrafya': 35,
            'Edebiyat': 25, 'Felsefe': 15, 'Fizik': 15, 'Kimya': 15
        },
        'SÃ¶zel': {
            'TÃ¼rkÃ§e': 40, 'Tarih': 50, 'CoÄŸrafya': 45, 'Edebiyat': 35,
            'Felsefe': 20, 'Matematik': 15, 'Fizik': 10, 'Kimya': 10
        }
    }
    
    field_topics = total_topics.get(student_field, total_topics['SayÄ±sal'])
    
    # HaftalÄ±k gerÃ§ek hÄ±z analysis
    if current_progress >= 80:
        speed_multiplier = 1.2  # HÄ±zlÄ± Ã¶ÄŸrenen
        emoji = "ğŸš€"
        speed_msg = "Ã‡ok hÄ±zlÄ±!"
    elif current_progress >= 60:
        speed_multiplier = 1.0  # Normal hÄ±z
        emoji = "âš¡"
        speed_msg = "Normal hÄ±z"
    elif current_progress >= 40:
        speed_multiplier = 0.8  # YavaÅŸ
        emoji = "ğŸŒ"
        speed_msg = "YavaÅŸ - hÄ±zlandÄ±rmalÄ±sÄ±n!"
    else:
        speed_multiplier = 0.6  # Ã‡ok yavaÅŸ
        emoji = "ğŸš¨"
        speed_msg = "Kritik! Acil hÄ±zlanma gerekli!"
    
    adjusted_rate = actual_completion_rate * speed_multiplier
    remaining_weeks = days_to_yks // 7
    
    # HÄ±z gÃ¶stergesi
    st.markdown(f"""
    <div style="background: linear-gradient(135deg, #FF6B6B 0%, #4ECDC4 100%); 
                padding: 20px; border-radius: 15px; margin: 10px 0; color: white;">
        <h3>{emoji} Senin GerÃ§ek Ã–ÄŸrenme HÄ±zÄ±n</h3>
        <p><strong>HaftalÄ±k Konu BitiÅŸ HÄ±zÄ±n:</strong> {adjusted_rate:.1f} konu/hafta</p>
        <p><strong>Durum:</strong> {speed_msg}</p>
        <p><strong>Kalan Hafta:</strong> {remaining_weeks} hafta</p>
    </div>
    """, unsafe_allow_html=True)
    
    # AylÄ±k konu bitiÅŸ takvimi
    st.markdown("### ğŸ“Š Bu HÄ±zla Hangi Ay Hangi Konular Bitecek?")
    
    # Åu anki tarih
    current_date = datetime.now()
    
    total_remaining_topics = sum(field_topics.values()) - len(completed_topics)
    topics_completed_monthly = adjusted_rate * 4  # 4 hafta = 1 ay
    
    timeline_data = []
    cumulative_topics = len(completed_topics)
    
    for month in range(1, min(12, remaining_weeks//4 + 2)):
        month_date = current_date + timedelta(weeks=month*4)
        month_name = month_date.strftime("%B %Y")
        
        # Bu aydaki konular
        topics_this_month = min(topics_completed_monthly, total_remaining_topics - (cumulative_topics - len(completed_topics)))
        cumulative_topics += topics_this_month
        
        # TYT/AYT ayrÄ±mÄ±
        tyt_percentage = min(100, (cumulative_topics / 135) * 100)  # TYT yaklaÅŸÄ±k 135 konu
        ayt_percentage = max(0, ((cumulative_topics - 135) / 100) * 100)  # AYT yaklaÅŸÄ±k 100 konu
        
        timeline_data.append({
            'month': month_name,
            'topics_completed': int(topics_this_month),
            'cumulative': int(cumulative_topics),
            'tyt_percentage': tyt_percentage,
            'ayt_percentage': ayt_percentage
        })
        
        if cumulative_topics >= sum(field_topics.values()):
            break
    
    # Timeline gÃ¶ster
    for i, data in enumerate(timeline_data):
        col1, col2, col3 = st.columns([2, 1, 1])
        
        with col1:
            if data['tyt_percentage'] >= 100:
                tyt_status = "âœ… TYT TamamlandÄ±!"
                color = "#28a745"
            elif data['tyt_percentage'] >= 80:
                tyt_status = f"ğŸ”¥ TYT %{data['tyt_percentage']:.0f} - Son sprint!"
                color = "#fd7e14"
            else:
                tyt_status = f"ğŸ“š TYT %{data['tyt_percentage']:.0f}"
                color = "#17a2b8"
            
            ayt_status = ""
            if data['ayt_percentage'] > 0:
                if data['ayt_percentage'] >= 100:
                    ayt_status = " | âœ… AYT TamamlandÄ±!"
                else:
                    ayt_status = f" | ğŸ¯ AYT %{data['ayt_percentage']:.0f}"
            
            st.markdown(f"""
            <div style="background-color: {color}; padding: 15px; border-radius: 10px; margin: 5px 0; color: white;">
                <h4 style="margin: 0; color: white;">{data['month']}</h4>
                <p style="margin: 5px 0;">{data['topics_completed']} yeni konu tamamlanacak</p>
                <p style="margin: 0; font-weight: bold;">{tyt_status}{ayt_status}</p>
            </div>
            """, unsafe_allow_html=True)
        
        with col2:
            st.metric("ğŸ“š Bu Ay", f"{data['topics_completed']} konu")
            
        with col3:
            st.metric("ğŸ“Š Toplam", f"{data['cumulative']} konu")
        
        # Deneme baÅŸlama takvimi
        if data['tyt_percentage'] >= 70 and i == 0:
            st.info("ğŸ¯ **Bu aydan itibaren haftalÄ±k denemelere baÅŸlamalÄ±sÄ±n!**")
        elif data['tyt_percentage'] >= 90 and data['ayt_percentage'] >= 50:
            st.success("ğŸ† **Bu aydan itibaren gÃ¼nlÃ¼k deneme Ã§Ã¶zmeye geÃ§!**")
    
    # HÄ±zlandÄ±rma Ã¶nerileri
    if current_progress < 60:
        st.markdown("---")
        st.error("""
        âš ï¸ **ACÄ°L HIZLANDIRMA GEREKLÄ°!**
        
        Mevcut hÄ±zÄ±nla konularÄ± yetiÅŸtiremeyebilirsiniz. Ã–neriler:
        - GÃ¼nlÃ¼k Ã§alÄ±ÅŸma saatini artÄ±rÄ±n (en az +2 saat)
        - ZayÄ±f konularÄ± tamamen bÄ±rakÄ±p gÃ¼Ã§lÃ¼ konulara odaklanÄ±n
        - Kolay sorulardan baÅŸlayÄ±n, zor konularÄ± sonraya bÄ±rakÄ±n
        - HaftalÄ±k hedefleri %50 artÄ±rÄ±n
        """)
    
    # HaftalÄ±k gÃ¼ncelleme sistemi
    st.markdown("---")
    st.subheader("ğŸ”„ HaftalÄ±k GÃ¼ncelleme Sistemi")
    
    st.markdown(f"""
    **ğŸ“… Bu sistem her hafta otomatik gÃ¼ncellenir:**
    
    - **13-19 Ekim haftasÄ± bitince:** HÄ±zÄ±nÄ±z yeniden hesaplanacak
    - **20-27 Ekim haftasÄ± bitince:** Takvim otomatik gÃ¼ncellenecek  
    - **Her Pazar:** Bir sonraki hafta iÃ§in yeni tahminler
    - **Performans deÄŸiÅŸince:** Konu bitiÅŸ tarihleri otomatik kayacak
    
    **ğŸ“Š GerÃ§ek verilerinize dayalÄ± tahmin - hiÃ§bir sabit deÄŸer yok!**
    """)
    
    # HaftalÄ±k progress kaydetme
    current_week = current_date.strftime("W%U-%Y")
    if st.button("ğŸ“Š Bu HaftanÄ±n PerformansÄ±nÄ± Kaydet ve Takvimi GÃ¼ncelle"):
        # Session'a haftalÄ±k performance kaydet
        if 'weekly_performances' not in st.session_state:
            st.session_state.weekly_performances = {}
        
        st.session_state.weekly_performances[current_week] = current_progress
        st.balloons()
        st.success("âœ… HaftalÄ±k performansÄ±n kaydedildi! Takvim bir sonraki hafta gÃ¼ncellenecek.")
        st.rerun()

def show_adaptive_monthly_plan(user_data, current_progress, days_to_yks, student_field):
    """HaftalÄ±k performansa gÃ¶re gÃ¼ncellenebilen aylÄ±k konu planÄ±"""
    
    # Performans bazlÄ± konu Ã¶nceliklendirme
    if current_progress >= 80:
        priority_level = "Ä°leri Seviye"
        focus_areas = ["Zor sorular", "HÄ±z geliÅŸtirme", "SÄ±nav teknikleri"]
        study_intensity = "7-8 saat/gÃ¼n"
    elif current_progress >= 60:
        priority_level = "Orta Seviye"
        focus_areas = ["Eksik konular", "PekiÅŸtirme", "Orta zorluk sorular"]
        study_intensity = "6-7 saat/gÃ¼n"
    elif current_progress >= 40:
        priority_level = "Temel Seviye"
        focus_areas = ["Temel konular", "Eksikleri kapatma", "Kolay sorular"]
        study_intensity = "8-9 saat/gÃ¼n (yoÄŸunlaÅŸtÄ±rÄ±lmÄ±ÅŸ)"
    else:
        priority_level = "Kritik MÃ¼dahale"
        focus_areas = ["Acil konular", "Temel bilgiler", "HÄ±zlÄ± kapanabilir eksikler"]
        study_intensity = "9-10 saat/gÃ¼n (yoÄŸun)"
    
    # Zaman planlamasÄ±
    remaining_months = days_to_yks // 30
    remaining_weeks = (days_to_yks % 30) // 7
    
    st.markdown(f"""
    <div style="background: linear-gradient(135deg, #FF6B6B 0%, #4ECDC4 100%); 
                padding: 20px; border-radius: 15px; margin: 10px 0; color: white;">
        <h3>ğŸ“Š Senin Ä°Ã§in Ã–zelleÅŸtirilmiÅŸ Plan</h3>
        <p><strong>Performans Seviyesi:</strong> {priority_level}</p>
        <p><strong>Kalan Zaman:</strong> {remaining_months} ay, {remaining_weeks} hafta</p>
        <p><strong>Ã–nerilen GÃ¼nlÃ¼k Ã‡alÄ±ÅŸma:</strong> {study_intensity}</p>
        <p><strong>Alan:</strong> {student_field}</p>
    </div>
    """, unsafe_allow_html=True)
    
    # HaftalÄ±k performansa gÃ¶re dinamik plan
    tabs = st.tabs([f"ğŸ“… {i+1}. Ay PlanÄ±" for i in range(min(remaining_months + 1, 4))])
    
    for i, tab in enumerate(tabs):
        with tab:
            month_num = i + 1
            
            # Performansa gÃ¶re konu daÄŸÄ±lÄ±mÄ± hesaplama
            if current_progress >= 80:
                math_weight, science_weight, lang_weight = 40, 35, 25
            elif current_progress >= 60:
                math_weight, science_weight, lang_weight = 35, 40, 25
            elif current_progress >= 40:
                math_weight, science_weight, lang_weight = 45, 30, 25
            else:
                math_weight, science_weight, lang_weight = 50, 25, 25
            
            st.markdown(f"""
            ### ğŸ“š {month_num}. Ay Konu DaÄŸÄ±lÄ±mÄ±
            
            **ğŸ”¢ Matematik:** %{math_weight} ({math_weight * study_intensity.split('-')[0].strip()[:1]}h/gÃ¼n)
            - Hafta 1: {focus_areas[0] if len(focus_areas) > 0 else 'Temel konular'}
            - Hafta 2: {focus_areas[1] if len(focus_areas) > 1 else 'PekiÅŸtirme'}
            - Hafta 3: {focus_areas[2] if len(focus_areas) > 2 else 'Tekrar'}
            - Hafta 4: DeÄŸerlendirme ve eksik tamamlama
            
            **ğŸ§ª Fen Bilimleri:** %{science_weight} ({science_weight * int(study_intensity.split('-')[0])//100}h/gÃ¼n)
            - Fizik, Kimya, Biyoloji daÄŸÄ±lÄ±mÄ±
            - ZayÄ±f konulara ekstra zaman ayrÄ±lacak
            
            **ğŸ“ TÃ¼rkÃ§e/Sosyal:** %{lang_weight} ({lang_weight * int(study_intensity.split('-')[0])//100}h/gÃ¼n)
            - GÃ¼nlÃ¼k paragraf Ã§Ã¶zÃ¼mÃ¼
            - HaftalÄ±k deneme testleri
            """)
            
            # HaftalÄ±k performans gÃ¼ncellemesi
            if i == 0:  # Sadece ilk ay iÃ§in
                with st.expander("âš™ï¸ Bu AyÄ±n PlanÄ±nÄ± GÃ¼ncelle"):
                    weekly_performance = st.slider(
                        f"Bu haftaki baÅŸarÄ± oranÄ±n (%{current_progress:.1f}): ",
                        0, 100, int(current_progress),
                        help="HaftalÄ±k performansÄ±na gÃ¶re planÄ±nÄ± otomatik gÃ¼ncelleyeceÄŸim!"
                    )
                    
                    if weekly_performance != current_progress:
                        if weekly_performance > current_progress + 10:
                            st.success("ğŸ‰ Harika! PerformansÄ±n arttÄ±! PlanÄ±n daha zorlaÅŸtÄ±rÄ±lÄ±yor...")
                        elif weekly_performance < current_progress - 10:
                            st.warning("âš ï¸ Bu hafta biraz dÃ¼ÅŸtÃ¼n. PlanÄ±n daha destekleyici hale getiriliyor...")
                        else:
                            st.info("ğŸ“Š PerformansÄ±n stabil. Plan aynÄ± ÅŸekilde devam ediyor.")
                        
                        # Otomatik plan gÃ¼ncelleme simulasyonu
                        st.markdown(f"""
                        **ğŸ”„ PLAN OTOMATÄ°K GÃœNCELLENDÄ°:**
                        - HaftalÄ±k hedef: %{weekly_performance} â†’ Sonraki hafta hedefi: %{min(weekly_performance + 5, 100)}
                        - Ã‡alÄ±ÅŸma saati ayarlamasÄ± yapÄ±ldÄ±
                        - Konu aÄŸÄ±rlÄ±klarÄ± yeniden hesaplandÄ±
                        """)

    # Performans takip sistemi
    st.markdown("---")
    st.subheader("ğŸ“ˆ Performans Takip ve GÃ¼ncelleme Sistemi")
    
    col1, col2 = st.columns(2)
    
    with col1:
        st.markdown("""
        **ğŸ¯ HEDEFLERÄ°N:**
        - HaftalÄ±k: %{:.1f} â†’ %{:.1f} baÅŸarÄ± oranÄ±
        - AylÄ±k: Bir Ã¼st seviyeye geÃ§iÅŸ
        - Genel: YKS hedef puanÄ±na ulaÅŸÄ±m
        """.format(current_progress, min(current_progress + 10, 100)))
        
        if st.button("ğŸ“Š Bu HaftanÄ±n PerformansÄ±nÄ± Kaydet"):
            st.balloons()
            st.success("âœ… PerformansÄ±n kaydedildi! Plan otomatik gÃ¼ncellendi.")
    
    with col2:
        st.markdown("""
        **âš¡ GÃœNCEL STRATEJÄ°N:**
        - ğŸ“š Odak: {}
        - â° YoÄŸunluk: {}
        - ğŸ¯ Ã–ncelik: {}
        """.format(
            focus_areas[0] if focus_areas else "Genel Ã§alÄ±ÅŸma",
            study_intensity,
            priority_level
        ))
        
        # Mini geliÅŸim grafiÄŸi
        progress_data = [current_progress - 10, current_progress - 5, current_progress, current_progress + 5]
        st.line_chart(progress_data)

# KarmaÅŸÄ±k fonksiyonlar kaldÄ±rÄ±ldÄ± - Basit sistem artÄ±k tamamen hazÄ±r!

# KarmaÅŸÄ±k fonksiyonlar kaldÄ±rÄ±ldÄ± - Basit sistem artÄ±k tamamen hazÄ±r!

# === ANA UYGULAMA AKIÅI ===

# === KOÃ‡ ONAY SÄ°STEMÄ° FONKSÄ°YONLARI ===

def send_to_coach_approval(user_data, weekly_plan):
    """Ã–ÄŸrencinin haftalÄ±k konularÄ±nÄ± koÃ§a onay iÃ§in gÃ¶nder"""
    current_username = st.session_state.current_user
    
    # HaftalÄ±k konularÄ± topla
    all_topics = weekly_plan.get('new_topics', []) + weekly_plan.get('review_topics', [])
    
    if not all_topics:
        st.warning("âš ï¸ GÃ¶nderilecek konu bulunamadÄ±!")
        return False
    
    # KoÃ§ onay talebi oluÅŸtur
    approval_request = {
        'student_username': current_username,
        'student_name': user_data.get('name', 'Ä°simsiz Ã–ÄŸrenci'),
        'student_field': user_data.get('field', 'BelirtilmemiÅŸ'),
        'submission_date': datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
        'topics': all_topics,
        'status': 'pending',  # pending, approved, rejected
        'coach_notes': '',
        'approved_date': None,
        'week_number': datetime.now().isocalendar()[1],
        'year': datetime.now().year
    }
    
    # Firebase'e kaydet veya session state'e ekle
    try:
        if firebase_connected and db_ref:
            # Firebase'e kaydet
            approval_key = f"{current_username}_{datetime.now().strftime('%Y%m%d_%H%M%S')}"
            db_ref.child('coach_approvals').child(approval_key).set(approval_request)
        else:
            # Session state'e kaydet (fallback)
            if 'coach_approval_requests' not in st.session_state:
                st.session_state.coach_approval_requests = {}
            approval_key = f"{current_username}_{datetime.now().strftime('%Y%m%d_%H%M%S')}"
            st.session_state.coach_approval_requests[approval_key] = approval_request
        
        # Ã–ÄŸrenci verilerine onay durumu ekle
        student_data = get_user_data()
        student_data['coach_approval_status'] = 'pending'
        student_data['last_submission_date'] = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        update_user_in_firebase(current_username, student_data)
        
        st.success("âœ… HaftalÄ±k programÄ±nÄ±z koÃ§unuza gÃ¶nderildi! Onay bekleniyor...")
        return True
        
    except Exception as e:
        st.error(f"âŒ GÃ¶nderim hatasÄ±: {e}")
        return False

def show_coach_approval_status(user_data):
    """Ã–ÄŸrenciye koÃ§ onay durumunu gÃ¶ster"""
    current_username = st.session_state.current_user
    
    # Onay durumunu kontrol et
    approval_status = user_data.get('coach_approval_status', 'none')
    
    if approval_status == 'pending':
        st.markdown("""
        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); 
                    padding: 20px; border-radius: 15px; margin: 20px 0; color: white; text-align: center;">
            <h3 style="margin: 0; color: white;">â³ KoÃ§ OnayÄ± Bekleniyor</h3>
            <p style="margin: 10px 0 0 0; opacity: 0.9;">ProgramÄ±nÄ±z koÃ§unuza gÃ¶nderildi, onay bekleniyor...</p>
        </div>
        """, unsafe_allow_html=True)
        
        last_submission = user_data.get('last_submission_date', 'Bilinmiyor')
        st.info(f"ğŸ“… Son gÃ¶nderim: {last_submission}")
        
    elif approval_status == 'approved':
        st.markdown("""
        <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); 
                    padding: 20px; border-radius: 15px; margin: 20px 0; color: white; text-align: center;">
            <h3 style="margin: 0; color: white;">âœ… KoÃ§unuz TarafÄ±ndan OnaylandÄ±</h3>
            <p style="margin: 10px 0 0 0; opacity: 0.9;">ProgramÄ±nÄ±z koÃ§unuz tarafÄ±ndan onaylandÄ±!</p>
        </div>
        """, unsafe_allow_html=True)
        
        approved_date = user_data.get('approval_date', 'Bilinmiyor')
        st.success(f"ğŸ‰ Onay tarihi: {approved_date}")
        
    elif approval_status == 'rejected':
        st.markdown("""
        <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); 
                    padding: 20px; border-radius: 15px; margin: 20px 0; color: white; text-align: center;">
            <h3 style="margin: 0; color: white;">âš ï¸ ProgramÄ±nÄ±z Revize Edildi</h3>
            <p style="margin: 10px 0 0 0; opacity: 0.9;">KoÃ§unuz programÄ±nÄ±zda deÄŸiÅŸiklik yaptÄ±, lÃ¼tfen gÃ¶zden geÃ§irin.</p>
        </div>
        """, unsafe_allow_html=True)
        
        coach_notes = user_data.get('coach_notes', 'KoÃ§ notu bulunamadÄ±')
        st.warning(f"ğŸ“ KoÃ§ notu: {coach_notes}")

def get_student_approval_requests():
    """TÃ¼m Ã¶ÄŸrenci onay taleplerini getir (Admin iÃ§in)"""
    try:
        if firebase_connected and db_ref:
            # Firebase'den Ã§ek
            approvals_data = db_ref.child('coach_approvals').get()
            if approvals_data:
                processed_requests = []
                for request in approvals_data.values():
                    # Eksik alanlarÄ± tamamla
                    if 'student_name' not in request:
                        # EÄŸer student_name yoksa, student_username'dan al
                        if 'student_username' in request:
                            student_username = request['student_username']
                            try:
                                user_data = db_ref.child('users').child(student_username).get()
                                if user_data:
                                    request['student_name'] = user_data.get('name', student_username)
                                else:
                                    request['student_name'] = student_username
                            except:
                                request['student_name'] = request.get('student_username', 'Ä°simsiz Ã–ÄŸrenci')
                        else:
                            request['student_name'] = 'Ä°simsiz Ã–ÄŸrenci'
                    
                    # EÄŸer student_username yoksa, baÅŸka alanlardan bul
                    if 'student_username' not in request:
                        # Admin panelinde approval_key'den username Ã§Ä±karÄ±labilir
                        # Åimdilik user_data'dan bul
                        if 'student_name' in request:
                            # User data'dan username bul (bu yaklaÅŸÄ±m eksik olabilir)
                            request['student_username'] = request.get('student_name', 'unknown_user')
                        else:
                            request['student_username'] = 'unknown_user'
                    
                    # ğŸ”§ EKSÄ°K ALANLARI OTOMATÄ°K TAMAMLA
                    if 'submission_date' not in request:
                        # Default olarak bugÃ¼nÃ¼n tarihini ver
                        from datetime import datetime
                        request['submission_date'] = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                    
                    if 'topics' not in request:
                        # Topics yoksa boÅŸ liste
                        request['topics'] = []
                    
                    if 'student_field' not in request:
                        # Field yoksa belirtilmemiÅŸ
                        request['student_field'] = 'BelirtilmemiÅŸ'
                    
                    if 'status' not in request:
                        # Status yoksa pending olarak ayarla
                        request['status'] = 'pending'
                    
                    # Debug: Hangi alanlarÄ±n eksik olduÄŸunu gÃ¶ster
                    missing_fields = []
                    if 'student_name' not in request: missing_fields.append('student_name')
                    if 'student_username' not in request: missing_fields.append('student_username')
                    if 'submission_date' not in request: missing_fields.append('submission_date')
                    if 'status' not in request: missing_fields.append('status')
                    if 'topics' not in request: missing_fields.append('topics')
                    
                    if missing_fields:
                        st.warning(f"Talepten eksik alanlar: {missing_fields} - {request.get('student_name', 'Unknown')}")
                    
                    # DiÄŸer gerekli alanlarÄ± kontrol et ve tamamla
                    required_fields = ['submission_date', 'status', 'topics', 'student_field']
                    missing_core_fields = [field for field in required_fields if field not in request]
                    
                    if not missing_core_fields:
                        processed_requests.append(request)
                    else:
                        st.warning(f"Eksik temel alanlar nedeniyle talep atlandÄ±: {missing_core_fields}")
                
                if processed_requests:
                    st.success(f"âœ… {len(processed_requests)} adet onay talebi baÅŸarÄ±yla yÃ¼klendi.")
                else:
                    st.info("ğŸ“ HiÃ§ geÃ§erli onay talebi bulunamadÄ±.")
                
                return processed_requests
        else:
            # Session state'den Ã§ek (fallback)
            requests = st.session_state.get('coach_approval_requests', {})
            if requests:
                st.info("ğŸ“ Session state'den onay talepleri yÃ¼klendi.")
            return list(requests.values()) if requests else []
    except Exception as e:
        st.error(f"Veri Ã§ekme hatasÄ±: {e}")
        return []

def approve_student_topics(approval_key, approved_topics, coach_notes, status):
    """KoÃ§un Ã¶ÄŸrenci programÄ±nÄ± onaylamasÄ±/reddetmesi"""
    try:
        if firebase_connected and db_ref:
            # Firebase'de gÃ¼ncelle
            db_ref.child('coach_approvals').child(approval_key).update({
                'status': status,
                'coach_notes': coach_notes,
                'approved_topics': approved_topics,
                'approved_date': datetime.now().strftime("%Y-%m-%d %H:%M:%S")
            })
            
            # ğŸ”§ FÄ°X: Student_username kontrolÃ¼ ile Ã¶ÄŸrenci verilerini gÃ¼ncelle
            approval_data = db_ref.child('coach_approvals').child(approval_key).get()
            if approval_data:
                # Student_username'i gÃ¼venli bir ÅŸekilde al
                student_username = approval_data.get('student_username', '')
                
                # EÄŸer student_username yoksa approval_key'den Ã§Ä±kar
                if not student_username and approval_key:
                    try:
                        student_username = approval_key.split('_')[0]
                    except:
                        student_username = 'unknown_user'
                
                # Student_username bulunduysa kullanÄ±cÄ± verilerini gÃ¼ncelle
                if student_username and student_username != 'unknown_user':
                    student_data = {
                        'coach_approval_status': status,
                        'coach_notes': coach_notes,
                        'approval_date': datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                        'approved_topics': approved_topics
                    }
                    db_ref.child('users').child(student_username).update(student_data)
                    
                    # ğŸ”¥ GÃœÃ‡LÃœ CACHE TEMÄ°ZLE: Ã–ÄŸrencinin tÃ¼m cache'lerini temizle
                    if 'users_db' in st.session_state and student_username in st.session_state.users_db:
                        # Cache'deki user_data'yÄ± gÃ¼ncelle
                        st.session_state.users_db[student_username].update(student_data)
                    
                    # Firebase cache'i gÃ¼venli temizle
                    if hasattr(st.session_state, 'firebase_cache'):
                        try:
                            # FirebaseCache objesinin clear metodu olup olmadÄ±ÄŸÄ±nÄ± kontrol et
                            if hasattr(st.session_state.firebase_cache, 'clear'):
                                st.session_state.firebase_cache.clear()
                            else:
                                # clear metodu yoksa, cache'i yeniden baÅŸlat
                                st.session_state.firebase_cache = type('obj', (object,), {})()
                        except Exception as cache_error:
                            # Cache temizleme hatasÄ± olsa bile onay iÅŸlemini devam ettir
                            st.warning(f"Cache temizleme hatasÄ±: {cache_error}")
                    
                    # ğŸ”„ SESSION STATE GÃœNCELLEME: TÃ¼m related cache'leri temizle
                    if 'user_data' in st.session_state and st.session_state.user_data.get('username') == student_username:
                        st.session_state.user_data.update(student_data)
                    
                    # Debug: Cache temizlendi mesajÄ±
                    st.success(f"ğŸ”„ {student_username} iÃ§in cache temizlendi, onay durumu gÃ¼ncellenmeli!")
        else:
            # Session state'de gÃ¼ncelle
            if 'coach_approval_requests' in st.session_state and approval_key in st.session_state.coach_approval_requests:
                st.session_state.coach_approval_requests[approval_key].update({
                    'status': status,
                    'coach_notes': coach_notes,
                    'approved_topics': approved_topics,
                    'approved_date': datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                })
        
        return True
    except Exception as e:
        st.error(f"Onay iÅŸlemi hatasÄ±: {e}")
        return False

def admin_coach_approval_panel():
    """Admin panelinde koÃ§ onay sistemi"""
    st.markdown("""
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                padding: 25px; border-radius: 20px; margin: 20px 0; color: white; text-align: center;">
        <h2 style="margin: 0; color: white;">ğŸ‘¨â€ğŸ« KoÃ§ Onay Sistemi</h2>
        <p style="margin: 10px 0 0 0; opacity: 0.9;">Ã–ÄŸrenci HaftalÄ±k Program OnaylarÄ±</p>
    </div>
    """, unsafe_allow_html=True)
    
    # Onay taleplerini getir
    approval_requests = get_student_approval_requests()
    
    if not approval_requests:
        st.info("ğŸ“ HenÃ¼z hiÃ§ onay talebi bulunmuyor.")
        return
    
    # Talepleri filtrele
    pending_requests = [req for req in approval_requests if req['status'] == 'pending']
    processed_requests = [req for req in approval_requests if req['status'] in ['approved', 'rejected']]
    
    st.markdown("## â³ Bekleyen Onaylar")
    
    if not pending_requests:
        st.success("âœ… TÃ¼m onay talepleri iÅŸlendi!")
    else:
        st.warning(f"ğŸ“Š {len(pending_requests)} adet bekleyen onay talebi var.")
    
    # Bekleyen talepleri gÃ¶ster
    for i, request in enumerate(pending_requests):
        with st.expander(f"ğŸ“š {request['student_name']} - {request['submission_date']}", expanded=i<3):
            
            col1, col2, col3 = st.columns([2, 1, 1])
            with col1:
                st.markdown(f"""
                **ğŸ‘¤ Ã–ÄŸrenci:** {request['student_name']}  
                **ğŸ“š Alan:** {request['student_field']}  
                **ğŸ“… GÃ¶nderim:** {request['submission_date']}  
                **ğŸ“… Hafta:** {request['week_number']}
                """)
            
            with col2:
                st.metric("ğŸ“Š Konu SayÄ±sÄ±", len(request['topics']))
            
            with col3:
                status_color = "#f39c12" if request['status'] == 'pending' else "#27ae60"
                st.markdown(f"""
                <div style="background: {status_color}; color: white; padding: 5px 10px; border-radius: 5px; text-align: center;">
                    {request['status'].upper()}
                </div>
                """, unsafe_allow_html=True)
            
            st.markdown("### ğŸ“š GÃ¶nderilen Konular:")
            
            # KonularÄ± tablo olarak gÃ¶ster
            if request['topics']:
                topic_data = []
                for topic in request['topics']:
                    topic_data.append({
                        'Ders': topic.get('subject', 'Bilinmiyor'),
                        'Konu': topic.get('topic', 'Bilinmiyor'),
                        'Detay': topic.get('detail', ''),
                        'Ã–ncelik': topic.get('priority', 'NORMAL')
                    })
                
                if topic_data:
                    st.dataframe(topic_data, use_container_width=True)
            
            # Onay formu
            st.markdown("### âœ… KoÃ§ DeÄŸerlendirmesi:")
            
            # Konu dÃ¼zenleme
            approved_topics = request['topics'].copy()  # Mevcut konularÄ± kopyala
            
            if st.checkbox("ğŸ”§ KonularÄ± dÃ¼zenlemek istiyorum", key=f"edit_{i}"):
                st.markdown("**ğŸ—‘ï¸ Silinecek konularÄ± iÅŸaretleyin:**")
                topics_to_remove = []
                
                for j, topic in enumerate(approved_topics):
                    col1, col2 = st.columns([4, 1])
                    with col1:
                        st.write(f"{j+1}. {topic.get('subject', 'Bilinmiyor')} - {topic.get('topic', 'Bilinmiyor')}")
                    with col2:
                        if st.checkbox("Sil", key=f"remove_{i}_{j}"):
                            topics_to_remove.append(j)
                
                # Silinecek konularÄ± Ã§Ä±kar
                for index in sorted(topics_to_remove, reverse=True):
                    if 0 <= index < len(approved_topics):
                        approved_topics.pop(index)
                
                st.markdown("**â• Konu Takip'ten detaylÄ± seÃ§im ile konu ekleyin:**")
                
                # Cascading dropdown'lar - form dÄ±ÅŸÄ±nda (cascading iÃ§in gerekli)
                available_subjects = list(YKS_TOPICS.keys())
                
                # Session state ile seÃ§imleri takip edelim
                if f'subject_key_{i}' not in st.session_state:
                    st.session_state[f'subject_key_{i}'] = 0
                if f'category_key_{i}' not in st.session_state:
                    st.session_state[f'category_key_{i}'] = 0
                if f'subcategory_key_{i}' not in st.session_state:
                    st.session_state[f'subcategory_key_{i}'] = 0
                if f'topic_key_{i}' not in st.session_state:
                    st.session_state[f'topic_key_{i}'] = 0
                
                # 1. Ders seÃ§imi
                selected_subject_idx = st.selectbox(
                    "ğŸ“š 1. Ders SeÃ§in:",
                    options=range(len(available_subjects)),
                    format_func=lambda x: available_subjects[x],
                    index=st.session_state[f'subject_key_{i}'],
                    key=f"subject_select_{i}"
                )
                
                selected_subject = available_subjects[selected_subject_idx]
                st.session_state[f'subject_key_{i}'] = selected_subject_idx
                
                # 2. Kategori seÃ§imi
                if selected_subject:
                    available_categories = get_categories(selected_subject)
                    selected_category_idx = st.selectbox(
                        "ğŸ“– 2. Kategori SeÃ§in:",
                        options=range(len(available_categories)),
                        format_func=lambda x: available_categories[x],
                        index=st.session_state[f'category_key_{i}'] if st.session_state[f'category_key_{i}'] < len(available_categories) else 0,
                        key=f"category_select_{i}"
                    )
                    
                    selected_category = available_categories[selected_category_idx]
                    st.session_state[f'category_key_{i}'] = selected_category_idx
                    
                    # 3. Alt kategori seÃ§imi
                    available_subcategories = get_subcategories(selected_subject, selected_category)
                    selected_subcategory_idx = st.selectbox(
                        "ğŸ“‚ 3. Alt Kategori SeÃ§in:",
                        options=range(len(available_subcategories)),
                        format_func=lambda x: available_subcategories[x],
                        index=st.session_state[f'subcategory_key_{i}'] if st.session_state[f'subcategory_key_{i}'] < len(available_subcategories) else 0,
                        key=f"subcategory_select_{i}"
                    )
                    
                    selected_sub_category = available_subcategories[selected_subcategory_idx]
                    st.session_state[f'subcategory_key_{i}'] = selected_subcategory_idx
                    
                    # 4. Konu seÃ§imi
                    available_topics = get_topics_detailed(selected_subject, selected_category, selected_sub_category)
                    selected_topic_idx = st.selectbox(
                        "ğŸ¯ 4. Konu SeÃ§in:",
                        options=range(len(available_topics)),
                        format_func=lambda x: available_topics[x],
                        index=st.session_state[f'topic_key_{i}'] if st.session_state[f'topic_key_{i}'] < len(available_topics) else 0,
                        key=f"topic_select_{i}"
                    )
                    
                    selected_topic = available_topics[selected_topic_idx]
                    st.session_state[f'topic_key_{i}'] = selected_topic_idx
                    
                    # SeÃ§ilen konunun detaylÄ± bilgilerini gÃ¶ster
                    st.markdown(f"""
                    **ğŸ“‹ SeÃ§ilen Konu DetaylarÄ±:**
                    - **Ders:** {selected_subject}
                    - **Kategori:** {selected_category}
                    - **Alt Kategori:** {selected_sub_category}
                    - **Konu:** {selected_topic}
                    """)
                    
                    # Form submit
                    with st.form(f"add_topic_form_{i}"):
                        new_detail = st.text_input(
                            "Detay (isteÄŸe baÄŸlÄ±, dÃ¼zenlenebilir):", 
                            value=selected_topic,
                            placeholder="Konu detaylarÄ± veya notlarÄ±nÄ±zÄ± yazÄ±n",
                            key=f"detail_{i}"
                        )
                        
                        new_priority = st.selectbox(
                            "Ã–ncelik:", 
                            ["DÃœÅÃœK", "NORMAL", "YÃœKSEK", "KRÄ°TÄ°K"],
                            key=f"priority_{i}"
                        )
                        
                        if st.form_submit_button("â• SeÃ§ilen Konuyu Ekle", type="primary"):
                            new_topic_obj = {
                                'subject': selected_subject,
                                'category': selected_category,
                                'sub_category': selected_sub_category,
                                'topic': selected_topic,
                                'detail': new_detail,
                                'priority': new_priority,
                                'net': 0
                            }
                            approved_topics.append(new_topic_obj)
                            st.success(f"âœ… {selected_subject} - {selected_topic} konusu eklendi!")
                            st.rerun()
                else:
                    st.info("âš ï¸ Ã–nce bir ders seÃ§in")
                    
            # Manuel konu ekleme iÃ§in ayrÄ± form
            st.markdown("**Veya manuel olarak ekleyin:**")
            with st.form(f"manual_add_topic_form_{i}"):
                manual_subject = st.text_input("Manuel Ders AdÄ±:", placeholder="TYT Matematik", key=f"manual_subject_{i}")
                manual_topic = st.text_input("Manuel Konu AdÄ±:", placeholder="TÃ¼rev", key=f"manual_topic_{i}")
                manual_detail = st.text_input("Manuel Detay:", placeholder="TÃ¼rev kurallarÄ±", key=f"manual_detail_{i}")
                manual_priority = st.selectbox("Manuel Ã–ncelik:", ["DÃœÅÃœK", "NORMAL", "YÃœKSEK", "KRÄ°TÄ°K"], key=f"manual_priority_{i}")
                
                if st.form_submit_button("â• Manuel Konu Ekle", type="secondary"):
                    if manual_subject and manual_topic:
                        manual_topic_obj = {
                            'subject': manual_subject,
                            'topic': manual_topic,
                            'detail': manual_detail,
                            'priority': manual_priority,
                            'net': 0
                        }
                        approved_topics.append(manual_topic_obj)
                        st.success(f"âœ… Manuel: {manual_subject} - {manual_topic} eklendi!")
                        st.rerun()
                    else:
                        st.error("âš ï¸ Manuel ekleme iÃ§in en azÄ±ndan ders ve konu adÄ± gereklidir!")
            
            # KoÃ§ notu ve onay
            coach_notes = st.text_area("ğŸ“ KoÃ§ Notu:", placeholder="Programla ilgili gÃ¶rÃ¼ÅŸleriniz, Ã¶nerileriniz...")
            
            col1, col2 = st.columns(2)
            with col1:
                if st.button("âœ… Onayla", key=f"approve_{i}", type="primary"):
                    # Student_username yoksa alternatif olarak student_name kullan
                    username = request.get('student_username', request.get('student_name', 'unknown'))
                    approval_key = f"{username}_{request['submission_date'].replace(' ', '_').replace('-', '_').replace(':', '_')}"
                    
                    # ğŸ”§ TEST: Onay iÅŸlemi debug iÃ§in
                    st.info(f"ğŸ“‹ Onaylanacak konu sayÄ±sÄ±: {len(approved_topics)}")
                    st.info(f"ğŸ”‘ Approval Key: {approval_key}")
                    st.info(f"ğŸ‘¤ Student Username: {username}")
                    
                    if approve_student_topics(approval_key, approved_topics, coach_notes, "approved"):
                        st.success("âœ… Program onaylandÄ±!")
                        # BaÅŸarÄ± sonrasÄ± kÄ±sa bekleme
                        st.info("ğŸ”„ DeÄŸiÅŸiklikler yansÄ±tÄ±lÄ±yor...")
                        st.rerun()
                    else:
                        st.error("âŒ Onay iÅŸlemi baÅŸarÄ±sÄ±z oldu!")
            
            with col2:
                if st.button("âŒ Reddet", key=f"reject_{i}", type="secondary"):
                    # Student_username yoksa alternatif olarak student_name kullan
                    username = request.get('student_username', request.get('student_name', 'unknown'))
                    approval_key = f"{username}_{request['submission_date'].replace(' ', '_').replace('-', '_').replace(':', '_')}"
                    
                    if approve_student_topics(approval_key, approved_topics, coach_notes, "rejected"):
                        st.success("âŒ Program reddedildi!")
                        st.rerun()
                    else:
                        st.error("âŒ Red iÅŸlemi baÅŸarÄ±sÄ±z oldu!")
            
            st.markdown("---")
    
    # Ä°ÅŸlenmiÅŸ talepler
    if processed_requests:
        st.markdown("## âœ… Ä°ÅŸlenmiÅŸ Onaylar")
        
        for request in processed_requests[-5:]:  # Son 5 iÅŸlem
            status_emoji = "âœ…" if request['status'] == 'approved' else "âŒ"
            status_color = "#27ae60" if request['status'] == 'approved' else "#e74c3c"
            
            st.markdown(f"""
            <div style="background: {status_color}; color: white; padding: 15px; border-radius: 10px; margin: 10px 0;">
                <h4 style="margin: 0; color: white;">{status_emoji} {request['student_name']}</h4>
                <p style="margin: 5px 0 0 0;">ğŸ“… {request['submission_date']} â†’ {request.get('approved_date', 'Ä°ÅŸlenmedi')}</p>
                <p style="margin: 5px 0 0 0;">ğŸ“ {request.get('coach_notes', 'KoÃ§ notu yok')}</p>
            </div>
            """, unsafe_allow_html=True)

# Ana uygulamayÄ± baÅŸlat
if __name__ == "__main__":
    main()
